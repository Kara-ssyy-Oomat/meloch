<!DOCTYPE html>
<html lang="ru">
<head>
  <script>if(window.parent!==window)document.write('<style>.bottom-nav,#bottomNavBar{display:none!important}body{padding-bottom:0!important}</style>')</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞–º–∏ - –ö–µ—Ä–±–µ–Ω</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
      padding-bottom: 70px;
    }
    input, textarea, select {
      font-family: inherit;
      font-size: 16px;
    }

    .swal2-container { z-index: 999999 !important; }

    /* –®–∞–ø–∫–∞ */
    .page-header {
      background: linear-gradient(135deg, #1a237e, #283593);
      color: white;
      padding: 20px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .page-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .page-header h1 {
      font-size: 20px;
      font-weight: 700;
    }
    .page-header p {
      font-size: 13px;
      opacity: 0.8;
      margin-top: 4px;
    }
    .back-btn {
      background: rgba(255,255,255,0.15);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 16px;
    }
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .stat-card .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #1a237e;
    }
    .stat-card .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    /* –¢–∞–±—ã */
    .tabs {
      display: flex;
      padding: 0 16px;
      gap: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      background: white;
      color: #666;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .tab-btn.active {
      background: #1a237e;
      color: white;
    }

    /* –ö–æ–Ω—Ç–µ–Ω—Ç */
    .content {
      padding: 16px;
    }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–∫–ª–∞–¥–æ–≤ */
    .warehouse-card {
      background: white;
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      position: relative;
    }
    .warehouse-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .warehouse-name {
      font-size: 18px;
      font-weight: 700;
      color: #1a237e;
    }
    .warehouse-address {
      font-size: 13px;
      color: #888;
      margin-top: 2px;
    }
    .warehouse-stats {
      display: flex;
      gap: 16px;
      margin-top: 10px;
    }
    .warehouse-stat {
      text-align: center;
    }
    .warehouse-stat .ws-value {
      font-size: 20px;
      font-weight: 700;
      color: #333;
    }
    .warehouse-stat .ws-label {
      font-size: 11px;
      color: #999;
    }
    .warehouse-actions {
      display: flex;
      gap: 8px;
      margin-top: 14px;
    }
    .warehouse-actions button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-view { background: #e3f2fd; color: #1565c0; }
    .btn-edit { background: #fff3e0; color: #e65100; }
    .btn-delete { background: #fce4ec; color: #c62828; }
    .btn-transfer { background: #e8f5e9; color: #2e7d32; }

    /* –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞ */
    .add-warehouse-btn {
      position: fixed;
      bottom: 76px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1a237e, #3949ab);
      color: white;
      border: none;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(26,35,126,0.4);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* –¢–æ–≤–∞—Ä—ã –Ω–∞ —Å–∫–ª–∞–¥–µ */
    .product-stock-card {
      background: white;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .product-stock-card img {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      object-fit: cover;
      background: #f5f5f5;
    }
    .product-stock-info {
      flex: 1;
      min-width: 0;
    }
    .product-stock-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .product-stock-category {
      font-size: 12px;
      color: #999;
      margin-top: 2px;
    }
    .product-warehouse-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .product-warehouse-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 12px;
      background: #e3f2fd;
      color: #1565c0;
      font-weight: 600;
    }
    .product-warehouse-badge.zero {
      background: #fce4ec;
      color: #c62828;
    }
    .product-stock-total {
      text-align: center;
      min-width: 60px;
    }
    .product-stock-total .total-value {
      font-size: 20px;
      font-weight: 700;
      color: #1a237e;
    }
    .product-stock-total .total-label {
      font-size: 10px;
      color: #999;
    }

    /* –ü–æ–∏—Å–∫ */
    .search-bar {
      padding: 12px 16px;
    }
    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 12px;
      font-size: 15px;
      background: white;
      outline: none;
    }
    .search-input:focus {
      border-color: #1a237e;
    }

    /* –§–∏–ª—å—Ç—Ä –ø–æ —Å–∫–ª–∞–¥—É */
    .filter-row {
      display: flex;
      gap: 8px;
      padding: 0 16px 12px;
      overflow-x: auto;
    }
    .filter-chip {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid #ddd;
      background: white;
      font-size: 13px;
      color: #666;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .filter-chip.active {
      border-color: #1a237e;
      background: #1a237e;
      color: white;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9900;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      font-size: 18px;
      color: #333;
    }
    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: #f5f5f5;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-body {
      padding: 20px;
    }
    .modal-body label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
      margin-top: 14px;
    }
    .modal-body label:first-child {
      margin-top: 0;
    }
    .modal-body input,
    .modal-body select,
    .modal-body textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      outline: none;
    }
    .modal-body input:focus,
    .modal-body select:focus { border-color: #1a237e; }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
    }
    .modal-footer button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-cancel { background: #f5f5f5; color: #666; }
    .btn-save { background: linear-gradient(135deg, #1a237e, #3949ab); color: white; }

    /* –î–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥ —Å–∫–ª–∞–¥–∞ */
    .warehouse-detail-header {
      background: linear-gradient(135deg, #1a237e, #283593);
      color: white;
      padding: 20px 16px;
      margin: -16px -16px 16px -16px;
      border-radius: 14px 14px 0 0;
    }
    .warehouse-detail-header h2 {
      font-size: 20px;
      margin-bottom: 4px;
    }
    .warehouse-detail-header p {
      font-size: 13px;
      opacity: 0.8;
    }

    /* –¢—Ä–∞–Ω—Å—Ñ–µ—Ä */
    .transfer-arrow {
      text-align: center;
      font-size: 28px;
      padding: 8px 0;
      color: #1a237e;
    }

    /* –¢–∞–±–ª–∏—Ü–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ */
    .stock-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .stock-table th {
      background: #f5f5f5;
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      color: #555;
      position: sticky;
      top: 0;
    }
    .stock-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #f0f0f0;
    }
    .stock-table tr:hover {
      background: #f8f9ff;
    }
    .stock-input {
      width: 70px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
    }
    .stock-input:focus {
      border-color: #1a237e;
      outline: none;
    }

    /* –õ–æ–∞–¥–µ—Ä */
    .loader {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .loader .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e0e0e0;
      border-top-color: #1a237e;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    .empty-state .emoji {
      font-size: 48px;
      margin-bottom: 12px;
    }



    /* –ú–æ–±–∏–ª—å–Ω—ã–µ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ */
    @media (max-width: 400px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .stat-card { padding: 12px; }
      .stat-card .stat-value { font-size: 20px; }
    }

    /* –¶–≤–µ—Ç–æ–≤–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞ —Å–∫–ª–∞–¥–æ–≤ */
    .wh-color-1 { border-left: 4px solid #1a237e; }
    .wh-color-2 { border-left: 4px solid #e65100; }
    .wh-color-3 { border-left: 4px solid #2e7d32; }
    .wh-color-4 { border-left: 4px solid #c62828; }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Å—Ç–∞—Ç–∫–∞ */
    .stock-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
    }
    .stock-indicator.green { background: #4caf50; }
    .stock-indicator.yellow { background: #ff9800; }
    .stock-indicator.red { background: #f44336; }

    /* –ö–Ω–æ–ø–∫–∞ ¬´–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏¬ª */
    .distribute-btn {
      display: block;
      width: 100%;
      padding: 14px;
      border: 2px dashed #1a237e;
      border-radius: 12px;
      background: #e8eaf6;
      color: #1a237e;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 16px;
      transition: all 0.2s;
    }
    .distribute-btn:hover {
      background: #c5cae9;
    }
  </style>
</head>
<body>

  <!-- –®–∞–ø–∫–∞ -->
  <div class="page-header">
    <div class="page-header-top">
      <div>
        <h1>üè≠ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞–º–∏</h1>
        <p>–û—Å—Ç–∞—Ç–∫–∏ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤</p>
      </div>
      <button class="back-btn" onclick="window.location.href='profile.html'">‚Üê</button>
    </div>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="stats-row" id="statsRow">
    <div class="stat-card">
      <div class="stat-value" id="statWarehouses">0</div>
      <div class="stat-label">–°–∫–ª–∞–¥–æ–≤</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statProducts">0</div>
      <div class="stat-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–π</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statTotalStock">0</div>
      <div class="stat-label">–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="statLowStock">0</div>
      <div class="stat-label">–ú–∞–ª–æ –æ—Å—Ç–∞—Ç–∫–æ–≤</div>
    </div>
  </div>

  <!-- –¢–∞–±—ã -->
  <div class="tabs" id="tabsContainer">
    <button class="tab-btn active" data-tab="warehouses" onclick="switchTab('warehouses')">üì¶ –°–∫–ª–∞–¥—ã</button>
    <button class="tab-btn" data-tab="products" onclick="switchTab('products')">üè∑Ô∏è –¢–æ–≤–∞—Ä—ã</button>
    <button class="tab-btn" data-tab="movements" onclick="switchTab('movements')">üîÑ –î–≤–∏–∂–µ–Ω–∏—è</button>
  </div>

  <!-- –¢–∞–± 1: –°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤ -->
  <div id="tab-warehouses" class="content tab-content">
    <div id="warehousesList" class="loader">
      <div class="spinner"></div>
      –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–æ–≤...
    </div>
  </div>

  <!-- –¢–∞–± 2: –¢–æ–≤–∞—Ä—ã –ø–æ —Å–∫–ª–∞–¥–∞–º -->
  <div id="tab-products" class="content tab-content" style="display:none;">
    <div class="search-bar" style="padding:0 0 12px;">
      <input type="text" class="search-input" id="productSearch" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." oninput="filterProducts()">
    </div>
    <div class="filter-row" id="warehouseFilter"></div>
    <div id="productsStockList" class="loader">
      <div class="spinner"></div>
      –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...
    </div>
  </div>

  <!-- –¢–∞–± 3: –ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏–π -->
  <div id="tab-movements" class="content tab-content" style="display:none;">
    <div id="movementsList" class="empty-state">
      <div class="emoji">üìã</div>
      <p>–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π</p>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞ -->
  <button class="add-warehouse-btn" onclick="showAddWarehouseModal()" title="–î–æ–±–∞–≤–∏—Ç—å —Å–∫–ª–∞–¥">+</button>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –î–æ–±–∞–≤–∏—Ç—å/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∫–ª–∞–¥ -->
  <div class="modal-overlay" id="warehouseModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="warehouseModalTitle">–ù–æ–≤—ã–π —Å–∫–ª–∞–¥</h2>
        <button class="modal-close" onclick="closeWarehouseModal()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="warehouseEditId">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ *</label>
        <input type="text" id="warehouseName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–ª–∞–¥ –ö–∞—Ä–∞-–°—É—É">
        <label>–ê–¥—Ä–µ—Å</label>
        <input type="text" id="warehouseAddress" placeholder="–ê–¥—Ä–µ—Å –∏–ª–∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</label>
        <input type="text" id="warehousePhone" placeholder="+996 ..." inputmode="tel">
        <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
        <textarea id="warehouseNote" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" rows="2"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeWarehouseModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-save" onclick="saveWarehouse()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ü—Ä–∏–≤—è–∑–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∫ —Å–∫–ª–∞–¥—É -->
  <div class="modal-overlay" id="stockModal">
    <div class="modal-content" style="max-height: 95vh;">
      <div class="modal-header">
        <h2 id="stockModalTitle">–û—Å—Ç–∞—Ç–∫–∏ —Å–∫–ª–∞–¥–∞</h2>
        <button class="modal-close" onclick="closeStockModal()">√ó</button>
      </div>
      <div class="modal-body" style="padding: 10px;">
        <div class="search-bar" style="padding:0 0 12px;">
          <input type="text" class="search-input" id="stockProductSearch" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." oninput="filterStockProducts()">
        </div>
        <div id="stockProductsList" style="max-height: 60vh; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeStockModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-save" onclick="saveStockChanges()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–∫–ª–∞–¥–∞–º–∏ -->
  <div class="modal-overlay" id="transferModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîÑ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h2>
        <button class="modal-close" onclick="closeTransferModal()">√ó</button>
      </div>
      <div class="modal-body">
        <label>–¢–æ–≤–∞—Ä</label>
        <select id="transferProduct" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px;" onchange="updateTransferInfo()">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
        </select>
        <div id="transferProductInfo" style="margin-top:8px; font-size:13px; color:#888;"></div>
        
        <label>–°–æ —Å–∫–ª–∞–¥–∞</label>
        <select id="transferFrom" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px;" onchange="updateTransferInfo()">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>
        </select>
        
        <div class="transfer-arrow">‚¨áÔ∏è</div>
        
        <label>–ù–∞ —Å–∫–ª–∞–¥</label>
        <select id="transferTo" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px;">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>
        </select>
        
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
        <input type="number" id="transferQty" placeholder="0" min="1" inputmode="numeric">
        <div id="transferAvailable" style="margin-top:4px; font-size:12px; color:#888;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeTransferModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-save" onclick="executeTransfer()">üîÑ –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
      </div>
    </div>
  </div>

<script src="js/bottom-nav.js?v=20"></script>

<script>
// ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ö–õ–ê–î–ê–ú–ò ====================

// Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const firebaseConfig = {
  apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
  authDomain: "svoysayet.firebaseapp.com",
  projectId: "svoysayet",
  storageBucket: "svoysayet.firebasestorage.app",
  messagingSenderId: "450143000217",
  appId: "1:450143000217:web:7495cefaea0b94966e8a08",
  measurementId: "G-Y8VG9E29FY"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let warehouses = [];
let products = [];
let movements = [];
let currentTab = 'warehouses';
let selectedWarehouseFilter = 'all';
let stockChanges = {}; // {productId: qty} –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–∫–ª–∞–¥–∞

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
document.addEventListener('DOMContentLoaded', async () => {
  await loadData();
});

async function loadData() {
  try {
    await Promise.all([loadWarehouses(), loadProducts(), loadMovements()]);
    updateStats();
    renderWarehouses();
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ' + e.message, 'error');
  }
}

async function loadWarehouses() {
  const snap = await db.collection('warehouses').orderBy('order', 'asc').get();
  warehouses = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}

async function loadProducts() {
  const snap = await db.collection('products').get();
  products = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}

async function loadMovements() {
  try {
    const snap = await db.collection('warehouseMovements')
      .orderBy('createdAt', 'desc')
      .limit(100)
      .get();
    movements = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (e) {
    movements = [];
    console.log('–ö–æ–ª–ª–µ–∫—Ü–∏—è warehouseMovements –ø–æ–∫–∞ –ø—É—Å—Ç–∞');
  }
}

// ==================== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ====================
function updateStats() {
  document.getElementById('statWarehouses').textContent = warehouses.length;
  
  const productsWithStock = products.filter(p => {
    const ws = p.warehouseStock || {};
    return Object.values(ws).some(v => v > 0);
  });
  document.getElementById('statProducts').textContent = productsWithStock.length || products.filter(p => typeof p.stock === 'number' && p.stock > 0).length;
  
  let totalStock = 0;
  let lowStockCount = 0;
  products.forEach(p => {
    const ws = p.warehouseStock || {};
    const total = Object.values(ws).reduce((sum, v) => sum + (v || 0), 0);
    if (total > 0) {
      totalStock += total;
      if (total <= 5) lowStockCount++;
    } else if (typeof p.stock === 'number' && p.stock > 0) {
      totalStock += p.stock;
      if (p.stock <= 5) lowStockCount++;
    }
  });
  
  document.getElementById('statTotalStock').textContent = totalStock.toLocaleString();
  document.getElementById('statLowStock').textContent = lowStockCount;
}

// ==================== –¢–ê–ë–´ ====================
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });
  document.querySelectorAll('.tab-content').forEach(el => {
    el.style.display = 'none';
  });
  document.getElementById('tab-' + tab).style.display = 'block';
  
  if (tab === 'products') {
    renderWarehouseFilter();
    renderProductsStock();
  } else if (tab === 'movements') {
    renderMovements();
  }
}

// ==================== –†–ï–ù–î–ï–† –°–ö–õ–ê–î–û–í ====================
function renderWarehouses() {
  const container = document.getElementById('warehousesList');
  
  if (warehouses.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="emoji">üè≠</div>
        <p>–ù–µ—Ç —Å–∫–ª–∞–¥–æ–≤</p>
        <p style="font-size:13px; margin-top:8px;">–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å–∫–ª–∞–¥</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  warehouses.forEach((wh, index) => {
    // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –æ–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ
    let productCount = 0;
    let totalStock = 0;
    let totalValue = 0;
    
    products.forEach(p => {
      const ws = p.warehouseStock || {};
      const qty = ws[wh.id] || 0;
      if (qty > 0) {
        productCount++;
        totalStock += qty;
        totalValue += qty * (p.price || 0);
      }
    });
    
    const colorClass = `wh-color-${(index % 4) + 1}`;
    
    html += `
      <div class="warehouse-card ${colorClass}">
        <div class="warehouse-card-header">
          <div>
            <div class="warehouse-name">${wh.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
            <div class="warehouse-address">${wh.address || ''}</div>
          </div>
        </div>
        <div class="warehouse-stats">
          <div class="warehouse-stat">
            <div class="ws-value">${productCount}</div>
            <div class="ws-label">–¢–æ–≤–∞—Ä–æ–≤</div>
          </div>
          <div class="warehouse-stat">
            <div class="ws-value">${totalStock.toLocaleString()}</div>
            <div class="ws-label">–ï–¥–∏–Ω–∏—Ü</div>
          </div>
          <div class="warehouse-stat">
            <div class="ws-value">${totalValue.toLocaleString()}</div>
            <div class="ws-label">–°—Ç–æ–∏–º–æ—Å—Ç—å (—Å–æ–º)</div>
          </div>
        </div>
        <div class="warehouse-actions">
          <button class="btn-view" onclick="openStockModal('${wh.id}')">üìã –û—Å—Ç–∞—Ç–∫–∏</button>
          <button class="btn-transfer" onclick="openTransferModal('${wh.id}')">üîÑ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ</button>
          <button class="btn-edit" onclick="editWarehouse('${wh.id}')">‚úèÔ∏è</button>
          <button class="btn-delete" onclick="deleteWarehouse('${wh.id}')">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// ==================== CRUD –°–ö–õ–ê–î–û–í ====================
function showAddWarehouseModal() {
  document.getElementById('warehouseModalTitle').textContent = '–ù–æ–≤—ã–π —Å–∫–ª–∞–¥';
  document.getElementById('warehouseEditId').value = '';
  document.getElementById('warehouseName').value = '';
  document.getElementById('warehouseAddress').value = '';
  document.getElementById('warehousePhone').value = '';
  document.getElementById('warehouseNote').value = '';
  document.getElementById('warehouseModal').classList.add('active');
}

function editWarehouse(id) {
  const wh = warehouses.find(w => w.id === id);
  if (!wh) return;
  
  document.getElementById('warehouseModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∫–ª–∞–¥';
  document.getElementById('warehouseEditId').value = id;
  document.getElementById('warehouseName').value = wh.name || '';
  document.getElementById('warehouseAddress').value = wh.address || '';
  document.getElementById('warehousePhone').value = wh.phone || '';
  document.getElementById('warehouseNote').value = wh.note || '';
  document.getElementById('warehouseModal').classList.add('active');
}

function closeWarehouseModal() {
  document.getElementById('warehouseModal').classList.remove('active');
}

async function saveWarehouse() {
  const name = document.getElementById('warehouseName').value.trim();
  if (!name) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞', 'warning');
    return;
  }
  
  const data = {
    name,
    address: document.getElementById('warehouseAddress').value.trim(),
    phone: document.getElementById('warehousePhone').value.trim(),
    note: document.getElementById('warehouseNote').value.trim(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  const editId = document.getElementById('warehouseEditId').value;
  
  try {
    if (editId) {
      await db.collection('warehouses').doc(editId).update(data);
      Swal.fire({ icon: 'success', title: '–°–∫–ª–∞–¥ –æ–±–Ω–æ–≤–ª—ë–Ω', timer: 1500, showConfirmButton: false });
    } else {
      data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      data.order = warehouses.length + 1;
      await db.collection('warehouses').add(data);
      Swal.fire({ icon: 'success', title: '–°–∫–ª–∞–¥ –¥–æ–±–∞–≤–ª–µ–Ω!', timer: 1500, showConfirmButton: false });
    }
    
    closeWarehouseModal();
    await loadWarehouses();
    updateStats();
    renderWarehouses();
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞:', e);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + e.message, 'error');
  }
}

async function deleteWarehouse(id) {
  const wh = warehouses.find(w => w.id === id);
  if (!wh) return;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–≤–∞—Ä—ã –Ω–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ
  const hasStock = products.some(p => {
    const ws = p.warehouseStock || {};
    return (ws[id] || 0) > 0;
  });
  
  if (hasStock) {
    Swal.fire('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å', '–ù–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã. –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∏—Ö –Ω–∞ –¥—Ä—É–≥–æ–π —Å–∫–ª–∞–¥.', 'warning');
    return;
  }
  
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å —Å–∫–ª–∞–¥?',
    text: `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å "${wh.name}"?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    confirmButtonText: '–£–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    await db.collection('warehouses').doc(id).delete();
    Swal.fire({ icon: 'success', title: '–°–∫–ª–∞–¥ —É–¥–∞–ª—ë–Ω', timer: 1500, showConfirmButton: false });
    await loadWarehouses();
    updateStats();
    renderWarehouses();
  } catch (e) {
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ' + e.message, 'error');
  }
}

// ==================== –û–°–¢–ê–¢–ö–ò –ù–ê –°–ö–õ–ê–î–ï ====================
let currentStockWarehouseId = null;

function openStockModal(warehouseId) {
  currentStockWarehouseId = warehouseId;
  stockChanges = {};
  const wh = warehouses.find(w => w.id === warehouseId);
  document.getElementById('stockModalTitle').textContent = `üì¶ ${wh ? wh.name : '–°–∫–ª–∞–¥'}`;
  document.getElementById('stockProductSearch').value = '';
  renderStockProducts();
  document.getElementById('stockModal').classList.add('active');
}

function closeStockModal() {
  document.getElementById('stockModal').classList.remove('active');
  currentStockWarehouseId = null;
  stockChanges = {};
}

function renderStockProducts(filter = '') {
  const container = document.getElementById('stockProductsList');
  const warehouseId = currentStockWarehouseId;
  
  let filtered = products.filter(p => !p.blocked);
  
  if (filter) {
    const q = filter.toLowerCase();
    filtered = filtered.filter(p => (p.title || '').toLowerCase().includes(q) || (p.category || '').toLowerCase().includes(q));
  }
  
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ —Ç–æ–≤–∞—Ä—ã —Å –æ—Å—Ç–∞—Ç–∫–æ–º –Ω–∞ —ç—Ç–æ–º —Å–∫–ª–∞–¥–µ
  filtered.sort((a, b) => {
    const aStock = (a.warehouseStock || {})[warehouseId] || 0;
    const bStock = (b.warehouseStock || {})[warehouseId] || 0;
    if (bStock > 0 && aStock === 0) return 1;
    if (aStock > 0 && bStock === 0) return -1;
    return (a.title || '').localeCompare(b.title || '');
  });
  
  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
    return;
  }
  
  let html = `<table class="stock-table">
    <thead>
      <tr>
        <th style="width:50%">–¢–æ–≤–∞—Ä</th>
        <th style="width:25%; text-align:center;">–û–±—â–∏–π</th>
        <th style="width:25%; text-align:center;">–ù–∞ —Å–∫–ª–∞–¥–µ</th>
      </tr>
    </thead>
    <tbody>`;
  
  filtered.forEach(p => {
    const ws = p.warehouseStock || {};
    const currentStock = ws[warehouseId] || 0;
    const totalStock = typeof p.stock === 'number' ? p.stock : Object.values(ws).reduce((s, v) => s + (v || 0), 0);
    
    html += `
      <tr>
        <td>
          <div style="font-weight:600; font-size:13px;">${p.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
          <div style="font-size:11px; color:#999;">${p.category || ''}</div>
        </td>
        <td style="text-align:center; font-weight:600; color:#666;">${totalStock}</td>
        <td style="text-align:center;">
          <input type="number" class="stock-input" 
            value="${currentStock}" 
            min="0" 
            inputmode="numeric"
            data-product-id="${p.id}"
            data-original="${currentStock}"
            onchange="onStockChange(this, '${p.id}')">
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function filterStockProducts() {
  const q = document.getElementById('stockProductSearch').value;
  renderStockProducts(q);
}

function onStockChange(input, productId) {
  const newVal = parseInt(input.value) || 0;
  const original = parseInt(input.dataset.original) || 0;
  
  if (newVal !== original) {
    stockChanges[productId] = newVal;
    input.style.background = '#e8f5e9';
    input.style.fontWeight = '700';
  } else {
    delete stockChanges[productId];
    input.style.background = '';
    input.style.fontWeight = '600';
  }
}

async function saveStockChanges() {
  const changedIds = Object.keys(stockChanges);
  if (changedIds.length === 0) {
    Swal.fire('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π', '–í—ã –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏ –æ—Å—Ç–∞—Ç–∫–∏', 'info');
    return;
  }
  
  const warehouseId = currentStockWarehouseId;
  const wh = warehouses.find(w => w.id === warehouseId);
  
  const result = await Swal.fire({
    title: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏?',
    text: `–ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${changedIds.length} —Ç–æ–≤–∞—Ä(–æ–≤) –Ω–∞ —Å–∫–ª–∞–¥–µ "${wh ? wh.name : ''}"`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    Swal.fire({ title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    
    const batch = db.batch();
    const movementBatch = [];
    
    for (const productId of changedIds) {
      const newQty = stockChanges[productId];
      const product = products.find(p => p.id === productId);
      if (!product) continue;
      
      const ws = product.warehouseStock || {};
      const oldQty = ws[warehouseId] || 0;
      const diff = newQty - oldQty;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º warehouseStock
      ws[warehouseId] = newQty;
      
      // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–π stock –∫–∞–∫ —Å—É–º–º—É –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤
      const totalStock = Object.values(ws).reduce((sum, v) => sum + (v || 0), 0);
      
      const productRef = db.collection('products').doc(productId);
      batch.update(productRef, {
        warehouseStock: ws,
        stock: totalStock
      });
      
      // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
      if (diff !== 0) {
        movementBatch.push({
          productId,
          productTitle: product.title || '',
          warehouseId,
          warehouseName: wh ? wh.name : '',
          type: diff > 0 ? 'receipt' : 'adjustment',
          qty: Math.abs(diff),
          direction: diff > 0 ? 'in' : 'out',
          oldQty,
          newQty,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          note: diff > 0 ? '–ü—Ä–∏—Ö–æ–¥ –Ω–∞ —Å–∫–ª–∞–¥' : '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—Å—Ç–∞—Ç–∫–∞'
        });
      }
    }
    
    await batch.commit();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–≤–∏–∂–µ–Ω–∏–π
    for (const mov of movementBatch) {
      await db.collection('warehouseMovements').add(mov);
    }
    
    Swal.fire({ icon: 'success', title: '–û—Å—Ç–∞—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', timer: 1500, showConfirmButton: false });
    
    closeStockModal();
    await loadProducts();
    updateStats();
    renderWarehouses();
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤:', e);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + e.message, 'error');
  }
}

// ==================== –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï –ú–ï–ñ–î–£ –°–ö–õ–ê–î–ê–ú–ò ====================
function openTransferModal(fromWarehouseId) {
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
  const productSelect = document.getElementById('transferProduct');
  productSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>';
  products.filter(p => !p.blocked).sort((a, b) => (a.title || '').localeCompare(b.title || '')).forEach(p => {
    productSelect.innerHTML += `<option value="${p.id}">${p.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</option>`;
  });
  
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–∫–ª–∞–¥—ã
  const fromSelect = document.getElementById('transferFrom');
  const toSelect = document.getElementById('transferTo');
  fromSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>';
  toSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>';
  
  warehouses.forEach(wh => {
    fromSelect.innerHTML += `<option value="${wh.id}" ${wh.id === fromWarehouseId ? 'selected' : ''}>${wh.name}</option>`;
    toSelect.innerHTML += `<option value="${wh.id}">${wh.name}</option>`;
  });
  
  document.getElementById('transferQty').value = '';
  document.getElementById('transferProductInfo').innerHTML = '';
  document.getElementById('transferAvailable').innerHTML = '';
  document.getElementById('transferModal').classList.add('active');
}

function closeTransferModal() {
  document.getElementById('transferModal').classList.remove('active');
}

function updateTransferInfo() {
  const productId = document.getElementById('transferProduct').value;
  const fromId = document.getElementById('transferFrom').value;
  
  if (!productId || !fromId) {
    document.getElementById('transferProductInfo').innerHTML = '';
    document.getElementById('transferAvailable').innerHTML = '';
    return;
  }
  
  const product = products.find(p => p.id === productId);
  if (!product) return;
  
  const ws = product.warehouseStock || {};
  const available = ws[fromId] || 0;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º
  let info = '<div style="margin-top:8px;">';
  warehouses.forEach(wh => {
    const qty = ws[wh.id] || 0;
    const isCurrent = wh.id === fromId;
    info += `<span class="product-warehouse-badge ${qty === 0 ? 'zero' : ''}" style="${isCurrent ? 'border:2px solid #1a237e;' : ''}">${wh.name}: ${qty}</span> `;
  });
  info += '</div>';
  
  document.getElementById('transferProductInfo').innerHTML = info;
  document.getElementById('transferAvailable').innerHTML = `–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è: <b>${available}</b> —à—Ç`;
  document.getElementById('transferQty').max = available;
}

async function executeTransfer() {
  const productId = document.getElementById('transferProduct').value;
  const fromId = document.getElementById('transferFrom').value;
  const toId = document.getElementById('transferTo').value;
  const qty = parseInt(document.getElementById('transferQty').value) || 0;
  
  if (!productId) { Swal.fire('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä', 'warning'); return; }
  if (!fromId) { Swal.fire('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥-–∏—Å—Ç–æ—á–Ω–∏–∫', 'warning'); return; }
  if (!toId) { Swal.fire('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ', 'warning'); return; }
  if (fromId === toId) { Swal.fire('–û—à–∏–±–∫–∞', '–°–∫–ª–∞–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏', 'warning'); return; }
  if (qty <= 0) { Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'warning'); return; }
  
  const product = products.find(p => p.id === productId);
  if (!product) { Swal.fire('–û—à–∏–±–∫–∞', '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error'); return; }
  
  const ws = product.warehouseStock || {};
  const available = ws[fromId] || 0;
  
  if (qty > available) {
    Swal.fire('–û—à–∏–±–∫–∞', `–ù–∞ —Å–∫–ª–∞–¥–µ —Ç–æ–ª—å–∫–æ ${available} —à—Ç`, 'warning');
    return;
  }
  
  const fromWh = warehouses.find(w => w.id === fromId);
  const toWh = warehouses.find(w => w.id === toId);
  
  const result = await Swal.fire({
    title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ',
    html: `
      <b>${product.title}</b><br><br>
      ${fromWh ? fromWh.name : '–°–∫–ª–∞–¥'} ‚Üí ${toWh ? toWh.name : '–°–∫–ª–∞–¥'}<br>
      –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: <b>${qty}</b> —à—Ç
    `,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    Swal.fire({ title: '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏
    ws[fromId] = (ws[fromId] || 0) - qty;
    ws[toId] = (ws[toId] || 0) + qty;
    
    // –£–±–∏—Ä–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    if (ws[fromId] <= 0) ws[fromId] = 0;
    
    // –û–±—â–∏–π stock –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏
    
    await db.collection('products').doc(productId).update({
      warehouseStock: ws
    });
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
    await db.collection('warehouseMovements').add({
      productId,
      productTitle: product.title || '',
      type: 'transfer',
      fromWarehouseId: fromId,
      fromWarehouseName: fromWh ? fromWh.name : '',
      toWarehouseId: toId,
      toWarehouseName: toWh ? toWh.name : '',
      qty,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      note: `–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ: ${fromWh ? fromWh.name : ''} ‚Üí ${toWh ? toWh.name : ''}`
    });
    
    Swal.fire({ icon: 'success', title: '–¢–æ–≤–∞—Ä –ø–µ—Ä–µ–º–µ—â—ë–Ω!', timer: 1500, showConfirmButton: false });
    
    closeTransferModal();
    await loadProducts();
    updateStats();
    renderWarehouses();
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è:', e);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å: ' + e.message, 'error');
  }
}

// ==================== –¢–û–í–ê–†–´ –ü–û –°–ö–õ–ê–î–ê–ú (–¢–ê–ë 2) ====================
function renderWarehouseFilter() {
  const container = document.getElementById('warehouseFilter');
  let html = `<button class="filter-chip ${selectedWarehouseFilter === 'all' ? 'active' : ''}" onclick="setWarehouseFilter('all')">–í—Å–µ —Å–∫–ª–∞–¥—ã</button>`;
  warehouses.forEach(wh => {
    html += `<button class="filter-chip ${selectedWarehouseFilter === wh.id ? 'active' : ''}" onclick="setWarehouseFilter('${wh.id}')">${wh.name}</button>`;
  });
  container.innerHTML = html;
}

function setWarehouseFilter(id) {
  selectedWarehouseFilter = id;
  renderWarehouseFilter();
  renderProductsStock();
}

function filterProducts() {
  renderProductsStock();
}

function renderProductsStock() {
  const container = document.getElementById('productsStockList');
  const searchQuery = (document.getElementById('productSearch').value || '').toLowerCase().trim();
  
  let filtered = products.filter(p => !p.blocked);
  
  // –ü–æ–∏—Å–∫
  if (searchQuery) {
    filtered = filtered.filter(p => 
      (p.title || '').toLowerCase().includes(searchQuery) ||
      (p.category || '').toLowerCase().includes(searchQuery)
    );
  }
  
  // –§–∏–ª—å—Ç—Ä –ø–æ —Å–∫–ª–∞–¥—É
  if (selectedWarehouseFilter !== 'all') {
    filtered = filtered.filter(p => {
      const ws = p.warehouseStock || {};
      return (ws[selectedWarehouseFilter] || 0) > 0;
    });
  }
  
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ –æ–±—â–µ–º—É –æ—Å—Ç–∞—Ç–∫—É (–æ—Ç –º–µ–Ω—å—à–µ–≥–æ –∫ –±–æ–ª—å—à–µ–º—É), –ø–æ—Ç–æ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
  filtered.sort((a, b) => {
    const aTotal = getProductTotalStock(a);
    const bTotal = getProductTotalStock(b);
    if (aTotal === 0 && bTotal > 0) return 1;
    if (aTotal > 0 && bTotal === 0) return -1;
    return (a.title || '').localeCompare(b.title || '');
  });
  
  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="emoji">üì≠</div><p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
    return;
  }
  
  let html = '';
  filtered.forEach(p => {
    const ws = p.warehouseStock || {};
    const totalStock = getProductTotalStock(p);
    
    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Å—Ç–∞—Ç–∫–∞
    let indicatorClass = 'green';
    if (totalStock <= 0) indicatorClass = 'red';
    else if (totalStock <= 5) indicatorClass = 'yellow';
    
    // –ë–µ–π–¥–∂–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º
    let badgesHtml = '';
    warehouses.forEach(wh => {
      const qty = ws[wh.id] || 0;
      badgesHtml += `<span class="product-warehouse-badge ${qty === 0 ? 'zero' : ''}">${wh.name}: ${qty}</span>`;
    });
    
    html += `
      <div class="product-stock-card" onclick="editProductStock('${p.id}')">
        <img src="${p.image || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22%3E%3Ctext y=%2218%22 font-size=%2218%22%3Eüì¶%3C/text%3E%3C/svg%3E'}" alt="${p.title || ''}" loading="lazy">
        <div class="product-stock-info">
          <div class="product-stock-title"><span class="stock-indicator ${indicatorClass}"></span>${p.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
          <div class="product-stock-category">${p.category || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'} ‚Ä¢ ${p.price || 0} —Å–æ–º</div>
          <div class="product-warehouse-grid">${badgesHtml}</div>
        </div>
        <div class="product-stock-total">
          <div class="total-value">${totalStock}</div>
          <div class="total-label">–≤—Å–µ–≥–æ</div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function getProductTotalStock(product) {
  const ws = product.warehouseStock || {};
  const whTotal = Object.values(ws).reduce((sum, v) => sum + (v || 0), 0);
  if (whTotal > 0) return whTotal;
  return typeof product.stock === 'number' ? product.stock : 0;
}

// –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–∞ –ø–æ —Å–∫–ª–∞–¥–∞–º
async function editProductStock(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;
  
  if (warehouses.length === 0) {
    Swal.fire('–ù–µ—Ç —Å–∫–ª–∞–¥–æ–≤', '–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–∫–ª–∞–¥', 'info');
    return;
  }
  
  const ws = product.warehouseStock || {};
  
  let inputsHtml = '';
  warehouses.forEach((wh, i) => {
    const qty = ws[wh.id] || 0;
    inputsHtml += `
      <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #f0f0f0;">
        <span style="font-weight:600;">${wh.name}</span>
        <input type="number" id="swal-wh-${i}" value="${qty}" min="0" 
          style="width:80px; padding:8px; border:1px solid #ddd; border-radius:8px; text-align:center; font-size:16px; font-weight:700;" inputmode="numeric">
      </div>
    `;
  });
  
  const result = await Swal.fire({
    title: product.title || '–¢–æ–≤–∞—Ä',
    html: `
      <div style="text-align:left; margin-top:10px;">
        <p style="font-size:13px; color:#888; margin-bottom:12px;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∫–ª–∞–¥–∞:</p>
        ${inputsHtml}
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞',
    preConfirm: () => {
      const values = {};
      warehouses.forEach((wh, i) => {
        values[wh.id] = parseInt(document.getElementById(`swal-wh-${i}`).value) || 0;
      });
      return values;
    }
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const newWs = result.value;
    const totalStock = Object.values(newWs).reduce((sum, v) => sum + (v || 0), 0);
    
    await db.collection('products').doc(productId).update({
      warehouseStock: newWs,
      stock: totalStock
    });
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
    const oldWs = product.warehouseStock || {};
    for (const whId of Object.keys(newWs)) {
      const oldQty = oldWs[whId] || 0;
      const newQty = newWs[whId] || 0;
      if (oldQty !== newQty) {
        const wh = warehouses.find(w => w.id === whId);
        await db.collection('warehouseMovements').add({
          productId,
          productTitle: product.title || '',
          warehouseId: whId,
          warehouseName: wh ? wh.name : '',
          type: 'adjustment',
          qty: Math.abs(newQty - oldQty),
          direction: newQty > oldQty ? 'in' : 'out',
          oldQty,
          newQty,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          note: '–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞'
        });
      }
    }
    
    Swal.fire({ icon: 'success', title: '–û—Å—Ç–∞—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!', timer: 1500, showConfirmButton: false });
    
    await loadProducts();
    updateStats();
    renderProductsStock();
    renderWarehouses();
  } catch (e) {
    Swal.fire('–û—à–∏–±–∫–∞', e.message, 'error');
  }
}

// ==================== –ò–°–¢–û–†–ò–Ø –î–í–ò–ñ–ï–ù–ò–ô (–¢–ê–ë 3) ====================
function renderMovements() {
  const container = document.getElementById('movementsList');
  
  if (movements.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="emoji">üìã</div>
        <p>–ù–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–π</p>
        <p style="font-size:13px; margin-top:8px;">–ò—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  let currentDate = '';
  
  movements.forEach(m => {
    // –î–∞—Ç–∞-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    const date = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    if (date !== currentDate) {
      currentDate = date;
      html += `<div style="font-weight:700; color:#666; padding:12px 0 6px; font-size:13px; border-bottom:1px solid #eee;">${date}</div>`;
    }
    
    const time = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '';
    
    let icon, description, color;
    switch (m.type) {
      case 'transfer':
        icon = 'üîÑ';
        description = `${m.fromWarehouseName} ‚Üí ${m.toWarehouseName}`;
        color = '#1565c0';
        break;
      case 'receipt':
        icon = 'üì•';
        description = `–ü—Ä–∏—Ö–æ–¥: ${m.warehouseName}`;
        color = '#2e7d32';
        break;
      case 'sale':
        icon = 'üõí';
        description = `–ü—Ä–æ–¥–∞–∂–∞: ${m.warehouseName}`;
        color = '#e65100';
        break;
      case 'adjustment':
        icon = '‚úèÔ∏è';
        description = m.direction === 'in' ? `–ü—Ä–∏—Ö–æ–¥: ${m.warehouseName}` : `–°–ø–∏—Å–∞–Ω–∏–µ: ${m.warehouseName}`;
        color = m.direction === 'in' ? '#2e7d32' : '#c62828';
        break;
      default:
        icon = 'üìã';
        description = m.note || '–î–≤–∏–∂–µ–Ω–∏–µ';
        color = '#666';
    }
    
    html += `
      <div style="display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid #f5f5f5;">
        <div style="font-size:24px;">${icon}</div>
        <div style="flex:1; min-width:0;">
          <div style="font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.productTitle}</div>
          <div style="font-size:12px; color:${color}; font-weight:600;">${description}</div>
          <div style="font-size:11px; color:#999;">${time}</div>
        </div>
        <div style="text-align:center; min-width:50px;">
          <div style="font-size:18px; font-weight:700; color:${m.direction === 'in' ? '#2e7d32' : '#c62828'};">
            ${m.direction === 'in' ? '+' : '-'}${m.qty}
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}
</script>

</body>
</html>
