<!DOCTYPE html>
<html lang="ru">
<head>
  <script>if(window.parent!==window)document.write('<style>.bottom-nav,#bottomNavBar{display:none!important}body{padding-bottom:0!important}</style>')</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="description" content="–ö–æ—Ä–∑–∏–Ω–∞ - –ö–µ—Ä–±–µ–Ω B2B Market">
  <meta name="theme-color" content="#4CAF50">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icon-kerben.jpg">
  <link rel="icon" type="image/jpeg" href="icon-kerben.jpg">
  
  <title>–ö–æ—Ä–∑–∏–Ω–∞ - –ö–µ—Ä–±–µ–Ω</title>

  <!-- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ DNS –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ -->
  <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    .page-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #fff;
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .back-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      color: #333;
      text-decoration: none;
    }
    
    .page-title { flex: 1; font-size: 18px; font-weight: 600; color: #333; }
    
    .clear-btn {
      background: none;
      border: none;
      color: #f44336;
      font-size: 14px;
      cursor: pointer;
    }
    
    .cart-content { padding: 15px; padding-bottom: 180px; }
    
    .cart-empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .cart-empty-icon { font-size: 64px; margin-bottom: 15px; }
    .cart-empty-text { font-size: 18px; margin-bottom: 10px; color: #666; }
    .cart-empty-subtext { font-size: 14px; margin-bottom: 25px; }
    
    .go-shopping-btn {
      display: inline-block;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 14px 30px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
    }
    
    .cart-item {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .cart-item-img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 10px;
      background: #f0f0f0;
    }
    
    .cart-item-info { flex: 1; min-width: 0; }
    
    .cart-item-title {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .cart-item-variant {
      color: #7b1fa2;
      font-size: 11px;
      margin-bottom: 4px;
      background: #f3e5f5;
      padding: 3px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    
    .cart-item-price-unit { color: #666; font-size: 12px; margin-bottom: 8px; }
    
    .cart-item-qty-controls { display: flex; align-items: center; gap: 6px; }
    
    .qty-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: #e0e0e0;
      font-size: 18px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 700;
    }
    
    .qty-value { padding: 0 12px; font-weight: 700; font-size: 16px; min-width: 40px; text-align: center; }
    .qty-unit { color: #888; font-size: 12px; }
    
    .cart-item-right { text-align: right; }
    .cart-item-total { font-size: 17px; font-weight: 700; color: #e53935; margin-bottom: 8px; }
    
    .remove-btn {
      background: #ffebee;
      color: #c62828;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .pack-badge {
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 9px;
      margin-left: 6px;
    }
    
    .cart-footer {
      position: fixed;
      bottom: 56px;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 15px 20px;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.08);
      z-index: 90;
    }
    
    .cart-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .cart-summary-label { font-size: 14px; color: #666; }
    .cart-summary-total { font-size: 22px; font-weight: 700; color: #333; }
    .cart-summary-info { font-size: 12px; color: #888; margin-bottom: 12px; }
    
    .checkout-btn {
      width: 100%;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: block;
      text-align: center;
    }
    
    .checkout-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ */

    
@media (min-width: 769px) {
      .cart-footer { bottom: 0; }
    }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- XLSX –∏ jsPDF –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ª–µ–Ω–∏–≤–æ ‚Äî –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞ -->
  <script>
    let _cartLibsLoaded = false;
    function loadCartExportLibs() {
      if (_cartLibsLoaded) return Promise.resolve();
      return Promise.all([
        new Promise(r => { const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'; s.onload = r; s.onerror = r; document.head.appendChild(s); }),
        new Promise(r => { const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'; s.onload = r; s.onerror = r; document.head.appendChild(s); })
      ]).then(() => { _cartLibsLoaded = true; });
    }
  </script>
</head>

<body>
  <header class="page-header">
    <a href="#" onclick="goBack(); return false;" class="back-btn">‚Üê</a>
    <h1 class="page-title">üõí –ö–æ—Ä–∑–∏–Ω–∞</h1>
    <button class="clear-btn" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  </header>
  
  <main class="cart-content" id="cartContent"></main>
  
  <div class="cart-footer" id="cartFooter" style="display:none;">
    <div class="cart-summary">
      <span class="cart-summary-label">–ò—Ç–æ–≥–æ:</span>
      <span class="cart-summary-total" id="cartTotal">0 —Å–æ–º</span>
    </div>
    <div class="cart-summary-info" id="cartSummary"></div>
    <button class="checkout-btn" id="submitOrderBtn" onclick="submitOrderFromCart()">üì¶ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
  </div>
  
  <script>
    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const initialUrl = window.location.href;
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ iframe –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥
    function goBack() {
      if (window.parent !== window && window.location.href === initialUrl) {
        window.parent.postMessage('closeIframe', '*');
      } else if (window.parent !== window) {
        window.location.href = initialUrl;
      } else {
        window.location.href = 'index.html';
      }
    }
  </script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
      authDomain: "svoysayet.firebaseapp.com",
      projectId: "svoysayet",
      storageBucket: "svoysayet.firebasestorage.app",
      messagingSenderId: "450143000217",
      appId: "1:450143000217:web:7495cefaea0b94966e8a08",
      measurementId: "G-Y8VG9E29FY"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let products = [];
    
    // –§—É–Ω–∫—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è URL (https/ -> https://)
    function fixCartImageUrl(url) {
      if (!url || typeof url !== 'string') return '';
      if (url.startsWith('https/')) {
        url = 'https://' + url.substring(6);
      }
      if (url.startsWith('http/')) {
        url = 'http://' + url.substring(5);
      }
      return url;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
    function handleCartImageError(img, originalUrl) {
      if (!img || img.dataset.failCount >= 2) {
        img.src = 'data:image/svg+xml,' + encodeURIComponent(
          '<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect fill="#f0f0f0" width="80" height="80"/><text fill="#999" x="40" y="45" text-anchor="middle" font-size="12">üì∑</text></svg>'
        );
        return;
      }
      const failCount = parseInt(img.dataset.failCount || '0');
      img.dataset.failCount = failCount + 1;
      
      if (failCount === 0) {
        img.src = 'https://images.weserv.nl/?url=' + encodeURIComponent(fixCartImageUrl(originalUrl)) + '&default=1';
      } else {
        img.src = 'data:image/svg+xml,' + encodeURIComponent(
          '<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect fill="#f0f0f0" width="80" height="80"/><text fill="#999" x="40" y="45" text-anchor="middle" font-size="12">üì∑</text></svg>'
        );
      }
    }
    
    async function loadProducts() {
      try {
        const snapshot = await db.collection('products').get();
        products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (e) { console.error(e); }
      renderCart();
    }
    
    function renderCart() {
      const content = document.getElementById('cartContent');
      const footer = document.getElementById('cartFooter');
      const clearBtn = document.querySelector('.clear-btn');
      
      if (cart.length === 0) {
        content.innerHTML = `
          <div class="cart-empty">
            <div class="cart-empty-icon">üõí</div>
            <div class="cart-empty-text">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
            <div class="cart-empty-subtext">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</div>
            <button onclick="goBack()" class="go-shopping-btn">üõçÔ∏è –ó–∞ –ø–æ–∫—É–ø–∫–∞–º–∏</button>
          </div>`;
        footer.style.display = 'none';
        clearBtn.style.display = 'none';
        updateNavBadge();
        return;
      }
      
      footer.style.display = 'block';
      clearBtn.style.display = 'block';
      
      let html = '';
      let total = 0, totalItems = 0, packCount = 0;
      
      cart.forEach((item, i) => {
        const product = products.find(p => p.id === item.id);
        const isPack = item.isPack || (product && product.isPack);
        const unitLabel = isPack ? '–ø–∞—á.' : '—à—Ç.';
        const itemTotal = item.qty * item.price;
        total += itemTotal;
        totalItems += item.qty;
        if (isPack) packCount++;
        
        html += `
          <div class="cart-item">
            <img referrerpolicy="no-referrer" data-original-url="${item.image}" src="${fixCartImageUrl(item.image)}" onerror="handleCartImageError(this, '${item.image}')" class="cart-item-img">
            <div class="cart-item-info">
              <div class="cart-item-title">${item.title}${isPack ? '<span class="pack-badge">–ü–ê–ß–ö–ê</span>' : ''}</div>
              ${item.variantName ? `<div class="cart-item-variant">üé® ${item.variantName}</div>` : ''}
              <div class="cart-item-price-unit">${item.price} —Å–æ–º / ${unitLabel}</div>
              <div class="cart-item-qty-controls">
                <button class="qty-btn" onclick="changeQty(${i}, -1)">‚àí</button>
                <span class="qty-value">${item.qty}</span>
                <button class="qty-btn" onclick="changeQty(${i}, 1)">+</button>
                <span class="qty-unit">${unitLabel}</span>
              </div>
            </div>
            <div class="cart-item-right">
              <div class="cart-item-total">${itemTotal} —Å–æ–º</div>
              <button class="remove-btn" onclick="removeItem(${i})">üóëÔ∏è</button>
            </div>
          </div>`;
      });
      
      content.innerHTML = html;
      document.getElementById('cartTotal').textContent = total.toLocaleString() + ' —Å–æ–º';
      
      const posWord = cart.length === 1 ? '–ø–æ–∑–∏—Ü–∏—è' : (cart.length < 5 ? '–ø–æ–∑–∏—Ü–∏–∏' : '–ø–æ–∑–∏—Ü–∏–π');
      let summary = `${cart.length} ${posWord}, ${totalItems} —Ç–æ–≤–∞—Ä–æ–≤`;
      if (packCount > 0) summary += ` (${packCount} –ø–∞—á–µ–∫)`;
      document.getElementById('cartSummary').textContent = summary;
      updateNavBadge();
    }
    
    function changeQty(index, delta) {
      const item = cart[index];
      const product = products.find(p => p.id === item.id);
      const step = (item.isPack || (product && product.isPack)) ? 1 : (product?.minQty || 1);
      const newQty = item.qty + (delta * step);
      
      if (newQty <= 0) { removeItem(index); return; }
      
      item.qty = newQty;
      if (product && product.optQty && newQty >= product.optQty && product.optPrice) {
        item.price = product.optPrice;
      } else if (product) {
        item.price = product.price;
      }
      saveCart();
      renderCart();
    }
    
    function removeItem(index) {
      Swal.fire({
        title: '–£–¥–∞–ª–∏—Ç—å?',
        text: cart[index].title,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        confirmButtonText: '–£–¥–∞–ª–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      }).then(r => {
        if (r.isConfirmed) {
          cart.splice(index, 1);
          saveCart();
          renderCart();
        }
      });
    }
    
    function clearCart() {
      if (!cart.length) return;
      Swal.fire({
        title: '–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        confirmButtonText: '–û—á–∏—Å—Ç–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      }).then(r => {
        if (r.isConfirmed) { cart = []; saveCart(); renderCart(); }
      });
    }
    
    function saveCart() {
      localStorage.setItem('cart', JSON.stringify(cart));
    }
    
    function updateNavBadge() {
      const badge = document.getElementById('navCartBadge');
      if (badge) {
        badge.textContent = cart.length;
        badge.style.display = cart.length > 0 ? 'flex' : 'none';
      }
    }
    
    window.addEventListener('storage', e => {
      if (e.key === 'cart') { cart = JSON.parse(e.newValue || '[]'); renderCart(); }
    });
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è / localStorage
    function getCustomerData() {
      // 1. –°–Ω–∞—á–∞–ª–∞ –∏–∑ customerData (–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç)
      try {
        const customer = JSON.parse(localStorage.getItem('customerData') || 'null');
        if (customer && customer.name && customer.phone) {
          return {
            name: customer.name,
            phone: customer.phone,
            address: customer.address || ''
          };
        }
      } catch(e) {}
      
      // 2. –ò–∑ userData (—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞)
      try {
        const saved = JSON.parse(localStorage.getItem('userData') || '{}');
        if (saved.name && saved.phone) {
          return {
            name: saved.name,
            phone: saved.phone,
            address: saved.address || ''
          };
        }
      } catch(e) {}
      
      return null;
    }
    
    function getDriverData() {
      try {
        const saved = JSON.parse(localStorage.getItem('userData') || '{}');
        return {
          driverName: saved.driverName || '',
          driverPhone: saved.driverPhone || ''
        };
      } catch(e) {}
      return { driverName: '', driverPhone: '' };
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
    function getCurrentPartner() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const ref = urlParams.get('ref');
        if (ref) { localStorage.setItem('referralPartner', ref); return ref; }
      } catch(e) {}
      try {
        const savedRef = localStorage.getItem('referralPartner');
        if (savedRef) return savedRef;
      } catch(e) {}
      let savedData = sessionStorage.getItem('partnerData');
      if (!savedData) { try { savedData = localStorage.getItem('partnerData'); } catch(e) {} }
      if (!savedData) return null;
      try {
        const partnerData = JSON.parse(savedData);
        const daysPassed = (Date.now() - partnerData.timestamp) / (1000 * 60 * 60 * 24);
        if (daysPassed <= 30) return partnerData.name;
        sessionStorage.removeItem('partnerData');
        try { localStorage.removeItem('partnerData'); } catch(e) {}
      } catch(e) {}
      return null;
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
    function saveOrderToHistory(order) {
      try {
        const history = JSON.parse(localStorage.getItem('orderHistory') || '[]');
        history.unshift(order);
        if (history.length > 50) history.length = 50;
        localStorage.setItem('orderHistory', JSON.stringify(history));
      } catch(e) {}
    }

    // ============ –û–¢–ü–†–ê–í–ö–ê –ó–ê–ö–ê–ó–ê ============
    async function submitOrderFromCart() {
      const submitBtn = document.getElementById('submitOrderBtn');
      
      if (cart.length === 0) {
        Swal.fire('–û—à–∏–±–∫–∞', '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'warning');
        return;
      }

      // –ê–Ω—Ç–∏—Å–ø–∞–º
      try {
        const cooldownUntil = parseInt(localStorage.getItem('firestoreCooldownUntil') || '0', 10) || 0;
        if (Date.now() < cooldownUntil) {
          const sec = Math.ceil((cooldownUntil - Date.now()) / 1000);
          Swal.fire('–ü–æ–¥–æ–∂–¥–∏—Ç–µ', `–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ ${sec} —Å–µ–∫.`, 'warning');
          return;
        }
      } catch(e) {}

      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
      let customerInfo = getCustomerData();
      const driverInfo = getDriverData();
      const savedRef = localStorage.getItem('savedReferredBy') || '';
      
      // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥
      if (!customerInfo || !customerInfo.name || !customerInfo.phone) {
        const result = await Swal.fire({
          title: 'üìã –î–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–∫–∞–∑–∞',
          html: `
            <div style="text-align:left;">
              <div style="margin-bottom:12px;">
                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:13px;">–í–∞—à–µ –∏–º—è *</label>
                <input type="text" id="swal-name" value="${customerInfo?.name || ''}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" style="width:100%; padding:12px; border:2px solid #4CAF50; border-radius:8px; font-size:16px; box-sizing:border-box;">
              </div>
              <div style="margin-bottom:12px;">
                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:13px;">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                <input type="tel" id="swal-phone" value="${customerInfo?.phone || ''}" placeholder="+996 ..." style="width:100%; padding:12px; border:2px solid #4CAF50; border-radius:8px; font-size:16px; box-sizing:border-box;">
              </div>
              <div style="margin-bottom:12px;">
                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:13px;">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                <input type="text" id="swal-address" value="${customerInfo?.address || ''}" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º" style="width:100%; padding:12px; border:2px solid #4CAF50; border-radius:8px; font-size:16px; box-sizing:border-box;">
              </div>
              <hr style="border:none; border-top:1px solid #eee; margin:14px 0;">
              <div style="margin-bottom:10px;">
                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:13px; color:#888;">–ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è <span style="font-size:11px;">(–Ω–µ–æ–±—è–∑.)</span></label>
                <input type="text" id="swal-driver-name" value="${driverInfo.driverName}" placeholder="–ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:15px; box-sizing:border-box; background:#f9f9f9;">
              </div>
              <div style="margin-bottom:10px;">
                <label style="display:block; margin-bottom:4px; font-weight:600; font-size:13px; color:#888;">–ù–æ–º–µ—Ä –≤–æ–¥–∏—Ç–µ–ª—è <span style="font-size:11px;">(–Ω–µ–æ–±—è–∑.)</span></label>
                <input type="tel" id="swal-driver-phone" value="${driverInfo.driverPhone}" placeholder="–ù–æ–º–µ—Ä –≤–æ–¥–∏—Ç–µ–ª—è" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:15px; box-sizing:border-box; background:#f9f9f9;">
              </div>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'üì¶ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑',
          cancelButtonText: '–û—Ç–º–µ–Ω–∞',
          confirmButtonColor: '#4CAF50',
          preConfirm: () => {
            const n = document.getElementById('swal-name').value.trim();
            const p = document.getElementById('swal-phone').value.trim();
            const a = document.getElementById('swal-address').value.trim();
            if (!n || !p || !a) { Swal.showValidationMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –∞–¥—Ä–µ—Å'); return false; }
            return {
              name: n, phone: p, address: a,
              driverName: document.getElementById('swal-driver-name').value.trim(),
              driverPhone: document.getElementById('swal-driver-phone').value.trim()
            };
          }
        });
        if (!result.isConfirmed) return;
        customerInfo = { name: result.value.name, phone: result.value.phone, address: result.value.address };
        driverInfo.driverName = result.value.driverName;
        driverInfo.driverPhone = result.value.driverPhone;
      } else {
        // –î–∞–Ω–Ω—ã–µ –µ—Å—Ç—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏–∑–º–µ–Ω–∏—Ç—å
        const total = cart.reduce((sum, item) => sum + item.qty * item.price, 0);
        const result = await Swal.fire({
          title: 'üì¶ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑',
          html: `
            <div style="text-align:left; font-size:14px;">
              <div style="background:#f0f7f0; padding:14px; border-radius:10px; margin-bottom:12px;">
                <div style="font-weight:700; margin-bottom:6px;">üë§ ${customerInfo.name}</div>
                <div style="color:#555;">üìû ${customerInfo.phone}</div>
                <div style="color:#555;">üìç ${customerInfo.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                ${driverInfo.driverName ? '<div style="color:#17a2b8; margin-top:6px;">üöó ' + driverInfo.driverName + (driverInfo.driverPhone ? ' ‚Ä¢ ' + driverInfo.driverPhone : '') + '</div>' : ''}
              </div>
              <div style="text-align:center; font-size:20px; font-weight:700; color:#333;">–ò—Ç–æ–≥–æ: ${total.toLocaleString()} —Å–æ–º</div>
              <div style="text-align:center; margin-top:6px;"><a href="#" id="swal-change-data" style="color:#1565c0; font-size:13px;">–ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</a></div>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: '‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å',
          cancelButtonText: '–û—Ç–º–µ–Ω–∞',
          confirmButtonColor: '#4CAF50',
          didOpen: () => {
            document.getElementById('swal-change-data').addEventListener('click', (e) => {
              e.preventDefault();
              Swal.close({ isConfirmed: false, isDismissed: true, dismiss: 'change' });
            });
          }
        });
        
        if (result.dismiss === 'change') {
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          const editResult = await Swal.fire({
            title: '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ',
            html: `
              <div style="text-align:left;">
                <div style="margin-bottom:12px;">
                  <label style="display:block; margin-bottom:4px; font-weight:600; font-size:13px;">–ò–º—è *</label>
                  <input type="text" id="swal-name" value="${customerInfo.name}" style="width:100%; padding:12px; border:2px solid #4CAF50; border-radius:8px; font-size:16px; box-sizing:border-box;">
                </div>
                <div style="margin-bottom:12px;">
                  <label style="display:block; margin-bottom:4px; font-weight:600; font-size:13px;">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                  <input type="tel" id="swal-phone" value="${customerInfo.phone}" style="width:100%; padding:12px; border:2px solid #4CAF50; border-radius:8px; font-size:16px; box-sizing:border-box;">
                </div>
                <div style="margin-bottom:12px;">
                  <label style="display:block; margin-bottom:4px; font-weight:600; font-size:13px;">–ê–¥—Ä–µ—Å *</label>
                  <input type="text" id="swal-address" value="${customerInfo.address}" style="width:100%; padding:12px; border:2px solid #4CAF50; border-radius:8px; font-size:16px; box-sizing:border-box;">
                </div>
                <hr style="border:none; border-top:1px solid #eee; margin:14px 0;">
                <div style="margin-bottom:10px;">
                  <label style="display:block; margin-bottom:4px; font-weight:600; font-size:13px; color:#888;">–í–æ–¥–∏—Ç–µ–ª—å</label>
                  <input type="text" id="swal-driver-name" value="${driverInfo.driverName}" placeholder="–ò–º—è" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:15px; box-sizing:border-box; background:#f9f9f9; margin-bottom:8px;">
                  <input type="tel" id="swal-driver-phone" value="${driverInfo.driverPhone}" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:15px; box-sizing:border-box; background:#f9f9f9;">
                </div>
              </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'üì¶ –û—Ç–ø—Ä–∞–≤–∏—Ç—å',
            cancelButtonText: '–û—Ç–º–µ–Ω–∞',
            confirmButtonColor: '#4CAF50',
            preConfirm: () => {
              const n = document.getElementById('swal-name').value.trim();
              const p = document.getElementById('swal-phone').value.trim();
              const a = document.getElementById('swal-address').value.trim();
              if (!n || !p || !a) { Swal.showValidationMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –∞–¥—Ä–µ—Å'); return false; }
              return { name: n, phone: p, address: a, driverName: document.getElementById('swal-driver-name').value.trim(), driverPhone: document.getElementById('swal-driver-phone').value.trim() };
            }
          });
          if (!editResult.isConfirmed) return;
          customerInfo = { name: editResult.value.name, phone: editResult.value.phone, address: editResult.value.address };
          driverInfo.driverName = editResult.value.driverName;
          driverInfo.driverPhone = editResult.value.driverPhone;
        } else if (!result.isConfirmed) {
          return;
        }
      }

      const name = customerInfo.name;
      const phone = customerInfo.phone;
      const address = customerInfo.address;
      let driverName = driverInfo.driverName;
      let driverPhone = driverInfo.driverPhone;
      const referredBy = savedRef;

      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.5';
      const originalText = submitBtn.textContent;
      submitBtn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...';

      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω–µ
        const validCart = [];
        const problems = { blocked: [], deleted: [], outOfStock: [] };
        
        for (const cartItem of cart) {
          const product = products.find(p => p.id === cartItem.id);
          if (!product) {
            problems.deleted.push(cartItem.title);
          } else if (product.blocked) {
            problems.blocked.push(cartItem.title);
          } else if (typeof product.stock === 'number' && isFinite(product.stock)) {
            const stock = Math.max(0, Math.floor(product.stock));
            if (stock <= 0) {
              problems.outOfStock.push(`${cartItem.title} (–Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏)`);
            } else if ((cartItem.qty || 0) > stock) {
              problems.outOfStock.push(`${cartItem.title} (–¥–æ—Å—Ç—É–ø–Ω–æ ${stock} —à—Ç)`);
            } else {
              validCart.push({ ...cartItem, title: product.title, price: product.price, costPrice: product.costPrice || 0, sellerId: product.sellerId || null, sellerName: product.sellerName || null });
            }
          } else {
            validCart.push({ ...cartItem, title: product.title, price: product.price, costPrice: product.costPrice || 0, sellerId: product.sellerId || null, sellerName: product.sellerName || null });
          }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
        if (problems.blocked.length || problems.deleted.length || problems.outOfStock.length) {
          let warningText = '';
          if (problems.blocked.length) warningText += '<div style="color:#dc3545; margin:10px 0;"><strong>‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã:</strong><br>' + problems.blocked.join('<br>') + '</div>';
          if (problems.deleted.length) warningText += '<div style="color:#dc3545; margin:10px 0;"><strong>üóëÔ∏è –£–¥–∞–ª–µ–Ω—ã:</strong><br>' + problems.deleted.join('<br>') + '</div>';
          if (problems.outOfStock.length) warningText += '<div style="color:#dc3545; margin:10px 0;"><strong>üì¶ –ù–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞:</strong><br>' + problems.outOfStock.join('<br>') + '</div>';
          
          if (validCart.length === 0) {
            Swal.fire({ icon: 'error', title: '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å', html: warningText + '<br><strong>–í—Å–µ —Ç–æ–≤–∞—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</strong>' });
            cart.length = 0; saveCart(); renderCart();
            submitBtn.disabled = false; submitBtn.style.opacity = '1'; submitBtn.textContent = originalText;
            return;
          }
          
          const r = await Swal.fire({
            icon: 'warning', title: '–í–Ω–∏–º–∞–Ω–∏–µ!',
            html: warningText + `<br><strong style="color:#28a745;">‚úì –î–æ—Å—Ç—É–ø–Ω—ã–µ (${validCart.length} —à—Ç) –º–æ–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å.</strong><br><br>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`,
            showCancelButton: true, confirmButtonText: '–î–∞', cancelButtonText: '–û—Ç–º–µ–Ω–∞', confirmButtonColor: '#28a745'
          });
          if (!r.isConfirmed) { submitBtn.disabled = false; submitBtn.style.opacity = '1'; submitBtn.textContent = originalText; return; }
          cart.length = 0; cart.push(...validCart); saveCart();
        }

        submitBtn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

        const items = cart.map(i => {
          const product = products.find(p => p.id === i.id);
          const unitLabel = (product && product.isPack) ? '–ø–∞—á–∫–∞' : '—à—Ç';
          const packInfo = (product && product.isPack && product.packQty) ? ` (~${product.packQty} —à—Ç/–ø–∞—á–∫–∞)` : '';
          const variantInfo = i.variant ? ` [${i.variant}]` : '';
          return `${i.title}${variantInfo}${packInfo} ‚Äî ${i.qty} ${unitLabel} √ó ${i.price} —Å–æ–º = ${i.qty * i.price} —Å–æ–º`;
        }).join('\n');
        const total = cart.reduce((sum, item) => sum + item.qty * item.price, 0);
        const currentTime = new Date().toLocaleString();

        let partner = getCurrentPartner();
        if (!partner && referredBy) partner = referredBy;
        if (!partner && phone) {
          try {
            const cad = await db.collection('clientAgents').doc(phone).get();
            if (cad.exists) partner = cad.data().agentName;
          } catch(e) {}
        }
        if (referredBy) try { localStorage.setItem('savedReferredBy', referredBy); } catch(e) {}

        // Batch: —Å–ø–∏—Å–∞–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        submitBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        const orderRef = db.collection('orders').doc();
        const batch = db.batch();

        for (const item of cart) {
          const localProduct = products.find(p => p.id === item.id);
          const hasLocalStock = localProduct && typeof localProduct.stock === 'number' && isFinite(localProduct.stock);
          if (!hasLocalStock) continue;
          const need = Math.max(0, Math.floor(item.qty || 0));
          if (need <= 0) throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.title}`);
          const localStock = Math.max(0, Math.floor(localProduct.stock));
          if (localStock < need) throw new Error(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Å—Ç–∞—Ç–∫–∞: ${localProduct.title || item.title}. –î–æ—Å—Ç—É–ø–Ω–æ ${localStock} —à—Ç`);
          
          const productRef = db.collection('products').doc(item.id);
          batch.update(productRef, { stock: firebase.firestore.FieldValue.increment(-need) });

          // –°–ø–∏—Å–∞–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–æ–≤
          const ws = localProduct.warehouseStock;
          if (ws && typeof ws === 'object') {
            let remaining = need;
            const sortedWh = Object.entries(ws).filter(([, qty]) => qty > 0).sort((a, b) => b[1] - a[1]);
            const updatedWs = { ...ws };
            for (const [whId, whQty] of sortedWh) {
              if (remaining <= 0) break;
              const deduct = Math.min(remaining, whQty);
              updatedWs[whId] = whQty - deduct;
              remaining -= deduct;
            }
            batch.update(productRef, { warehouseStock: updatedWs });
          }
        }

        batch.set(orderRef, {
          name, phone, address,
          driverName: driverName || null, driverPhone: driverPhone || null,
          items: cart.map(item => ({
            id: item.id, title: item.title, qty: item.qty, price: item.price,
            costPrice: item.costPrice || 0, sellerId: item.sellerId || null,
            sellerName: item.sellerName || null, variant: item.variant || null
          })),
          total, timestamp: Date.now(), time: currentTime, status: '–ù–æ–≤—ã–π',
          partner: partner || null, referredBy: referredBy || null
        });

        await batch.commit();

        Swal.fire('–£—Å–ø–µ—Ö! ‚úÖ', '–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!', 'success');

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        localStorage.setItem('userData', JSON.stringify({ name, phone, address, driverName, driverPhone }));

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        saveOrderToHistory({
          name, phone, address, driverName: driverName || null, driverPhone: driverPhone || null,
          items: [...cart], total, timestamp: Date.now(), time: currentTime, status: '–ù–æ–≤—ã–π'
        });

        // –ê–≤—Ç–æ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
        try {
          const customerDoc = await db.collection('customers').doc(phone).get();
          if (!customerDoc.exists) {
            await db.collection('customers').doc(phone).set({
              name, phone, address, registeredAt: firebase.firestore.FieldValue.serverTimestamp(),
              totalOrders: 1, totalSpent: total
            });
          } else {
            await db.collection('customers').doc(phone).update({
              name, address, totalOrders: firebase.firestore.FieldValue.increment(1),
              totalSpent: firebase.firestore.FieldValue.increment(total)
            });
          }
        } catch(e) { console.log('Customer update error:', e); }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram (—Ñ–æ–Ω–æ–≤–æ ‚Äî —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
        const driverInfoText = (driverName || driverPhone) ? `\n–í–æ–¥–∏—Ç–µ–ª—å: ${driverName || '-'}\n–¢–µ–ª. –≤–æ–¥–∏—Ç–µ–ª—è: ${driverPhone || '-'}` : '';
        const msg = `–ù–æ–≤—ã–π –∑–∞–∫–∞–∑:\n–ò–º—è: ${name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n–ê–¥—Ä–µ—Å: ${address}${driverInfoText}\n–¢–æ–≤–∞—Ä—ã:\n${items}\n\n–ò—Ç–æ–≥–æ: ${total} —Å–æ–º`;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º XLSX/jsPDF –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã (–Ω—É–∂–Ω—ã –¥–ª—è Excel/PDF —Ñ–∞–π–ª–æ–≤)
        await loadCartExportLibs();

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Excel, PDF –¥–ª—è –ø–µ—á–∞—Ç–∏, PDF —Å —Ñ–æ—Ç–æ ‚Äî —Ñ–æ–Ω–æ–≤–æ
        const orderData = { name, phone, address, driverName, driverPhone, cart: [...cart], total, currentTime };

        if (typeof sendOrderAsExcelFile === 'function') {
          sendOrderAsExcelFile(name, phone, address, driverName, driverPhone, orderData.cart, total, currentTime).catch(e => console.error('Excel error:', e));
        }
        if (typeof sendOrderAsPrintPDF === 'function') {
          sendOrderAsPrintPDF(name, phone, address, driverName, driverPhone, orderData.cart, total, currentTime).catch(e => console.error('PDF print error:', e));
        }
        if (typeof sendOrderAsPDF === 'function') {
          sendOrderAsPDF(name, phone, address, driverName, driverPhone, orderData.cart, total, currentTime).catch(e => console.error('PDF photo error:', e));
        }

        // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
        cart.length = 0;
        saveCart();
        renderCart();

      } catch (error) {
        console.error('Order error:', error);
        Swal.fire('–û—à–∏–±–∫–∞', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑', 'error');
        try {
          const msg = String(error.message || '');
          if (msg.includes('quota') || msg.includes('429') || msg.includes('too many')) {
            localStorage.setItem('firestoreCooldownUntil', String(Date.now() + 45000));
          }
        } catch(e) {}
      }
      
      submitBtn.disabled = false;
      submitBtn.style.opacity = '1';
      submitBtn.textContent = originalText;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      loadProducts();
    });

    // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('message', function(e) {
      if (e.data === 'refreshCart') {
        cart = JSON.parse(localStorage.getItem('cart') || '[]');
        renderCart();
      }
    });
  </script>
  <script src="js/image-optimizer.js"></script>
  <script>
    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è fixImageOrientation (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ orders.js –¥–ª—è PDF)
    if (typeof fixImageOrientation === 'undefined') {
      window.fixImageOrientation = async function(file) { return file; };
    }
  </script>
  <script src="js/orders.js"></script>
<script src="js/bottom-nav.js?v=20"></script>
</body>
</html>