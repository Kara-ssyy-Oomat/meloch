<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="description" content="–ö–æ—Ä–∑–∏–Ω–∞ - –ö–µ—Ä–±–µ–Ω B2B Market">
  <meta name="theme-color" content="#4CAF50">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icon-kerben.jpg">
  <link rel="icon" type="image/jpeg" href="icon-kerben.jpg">
  
  <title>–ö–æ—Ä–∑–∏–Ω–∞ - –ö–µ—Ä–±–µ–Ω</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding-bottom: 56px;
    }
    
    .page-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #fff;
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .back-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      color: #333;
      text-decoration: none;
    }
    
    .page-title { flex: 1; font-size: 18px; font-weight: 600; color: #333; }
    
    .clear-btn {
      background: none;
      border: none;
      color: #f44336;
      font-size: 14px;
      cursor: pointer;
    }
    
    .cart-content { padding: 15px; padding-bottom: 180px; }
    
    .cart-empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .cart-empty-icon { font-size: 64px; margin-bottom: 15px; }
    .cart-empty-text { font-size: 18px; margin-bottom: 10px; color: #666; }
    .cart-empty-subtext { font-size: 14px; margin-bottom: 25px; }
    
    .go-shopping-btn {
      display: inline-block;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 14px 30px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
    }
    
    .cart-item {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .cart-item-img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 10px;
      background: #f0f0f0;
    }
    
    .cart-item-info { flex: 1; min-width: 0; }
    
    .cart-item-title {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .cart-item-variant {
      color: #7b1fa2;
      font-size: 11px;
      margin-bottom: 4px;
      background: #f3e5f5;
      padding: 3px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    
    .cart-item-price-unit { color: #666; font-size: 12px; margin-bottom: 8px; }
    
    .cart-item-qty-controls { display: flex; align-items: center; gap: 6px; }
    
    .qty-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: #e0e0e0;
      font-size: 18px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 700;
    }
    
    .qty-value { padding: 0 12px; font-weight: 700; font-size: 16px; min-width: 40px; text-align: center; }
    .qty-unit { color: #888; font-size: 12px; }
    
    .cart-item-right { text-align: right; }
    .cart-item-total { font-size: 17px; font-weight: 700; color: #e53935; margin-bottom: 8px; }
    
    .remove-btn {
      background: #ffebee;
      color: #c62828;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .pack-badge {
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 9px;
      margin-left: 6px;
    }
    
    .cart-footer {
      position: fixed;
      bottom: 56px;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 15px 20px;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.08);
      z-index: 90;
    }
    
    .cart-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .cart-summary-label { font-size: 14px; color: #666; }
    .cart-summary-total { font-size: 22px; font-weight: 700; color: #333; }
    .cart-summary-info { font-size: 12px; color: #888; margin-bottom: 12px; }
    
    .checkout-btn {
      width: 100%;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: block;
      text-align: center;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #fff;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 9999;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
    }
    
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      height: 100%;
      background: none;
      border: none;
      color: #9e9e9e;
      text-decoration: none;
      position: relative;
    }
    
    .nav-item.active { color: #4CAF50; }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
    .nav-item span { font-size: 11px; font-weight: 500; }
    
    .nav-badge {
      position: absolute;
      top: 6px;
      right: calc(50% - 16px);
      background: #e53935;
      color: white;
      font-size: 10px;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    @media (min-width: 769px) {
      .bottom-nav { display: none; }
      body { padding-bottom: 0; }
      .cart-footer { bottom: 0; }
    }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <header class="page-header">
    <a href="index.html" class="back-btn">‚Üê</a>
    <h1 class="page-title">üõí –ö–æ—Ä–∑–∏–Ω–∞</h1>
    <button class="clear-btn" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  </header>
  
  <main class="cart-content" id="cartContent"></main>
  
  <div class="cart-footer" id="cartFooter" style="display:none;">
    <div class="cart-summary">
      <span class="cart-summary-label">–ò—Ç–æ–≥–æ:</span>
      <span class="cart-summary-total" id="cartTotal">0 —Å–æ–º</span>
    </div>
    <div class="cart-summary-info" id="cartSummary"></div>
    <a href="index.html#order-form" class="checkout-btn">üì¶ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
  </div>
  
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="index.html#categories" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M3 5h6v6H3V5zm0 8h6v6H3v-6zm8-8h6v6h-6V5zm0 8h6v6h-6v-6z"/></svg>
      <span>–ú–µ–Ω—é</span>
    </a>
    <a href="cart.html" class="nav-item active">
      <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM7.2 14.6L8.2 12h7.4c.8 0 1.4-.4 1.7-1l3.9-7-1.7-1-3.9 7H8.5L4.3 2H1v2h2l3.6 7.6-1.4 2.5c-.7 1.3.3 2.9 1.8 2.9h12v-2H7.4c-.1 0-.2-.1-.2-.4z"/></svg>
      <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
      <span class="nav-badge" id="navCartBadge">0</span>
    </a>
    <a href="chat.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
      <span>–ß–∞—Ç</span>
    </a>
    <a href="profile.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm0 2c-2.7 0-8 1.3-8 4v2h16v-2c0-2.7-5.3-4-8-4z"/></svg>
      <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </a>
  </nav>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB0vkHoMqC-ec3L8EQubHFEavLYAkqr0MQ",
      authDomain: "kerben-store.firebaseapp.com",
      projectId: "kerben-store",
      storageBucket: "kerben-store.firebasestorage.app",
      messagingSenderId: "799212629498",
      appId: "1:799212629498:web:37c0576a59e38874c8eb50"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let products = [];
    
    // –§—É–Ω–∫—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è URL (https/ -> https://)
    function fixCartImageUrl(url) {
      if (!url || typeof url !== 'string') return '';
      if (url.startsWith('https/')) {
        url = 'https://' + url.substring(6);
      }
      if (url.startsWith('http/')) {
        url = 'http://' + url.substring(5);
      }
      return url;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
    function handleCartImageError(img, originalUrl) {
      if (!img || img.dataset.failCount >= 2) {
        img.src = 'data:image/svg+xml,' + encodeURIComponent(
          '<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect fill="#f0f0f0" width="80" height="80"/><text fill="#999" x="40" y="45" text-anchor="middle" font-size="12">üì∑</text></svg>'
        );
        return;
      }
      const failCount = parseInt(img.dataset.failCount || '0');
      img.dataset.failCount = failCount + 1;
      
      if (failCount === 0) {
        img.src = 'https://images.weserv.nl/?url=' + encodeURIComponent(fixCartImageUrl(originalUrl)) + '&default=1';
      } else {
        img.src = 'data:image/svg+xml,' + encodeURIComponent(
          '<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect fill="#f0f0f0" width="80" height="80"/><text fill="#999" x="40" y="45" text-anchor="middle" font-size="12">üì∑</text></svg>'
        );
      }
    }
    
    async function loadProducts() {
      try {
        const snapshot = await db.collection('products').get();
        products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (e) { console.error(e); }
      renderCart();
    }
    
    function renderCart() {
      const content = document.getElementById('cartContent');
      const footer = document.getElementById('cartFooter');
      const clearBtn = document.querySelector('.clear-btn');
      
      if (cart.length === 0) {
        content.innerHTML = `
          <div class="cart-empty">
            <div class="cart-empty-icon">üõí</div>
            <div class="cart-empty-text">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
            <div class="cart-empty-subtext">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</div>
            <a href="index.html" class="go-shopping-btn">üõçÔ∏è –ó–∞ –ø–æ–∫—É–ø–∫–∞–º–∏</a>
          </div>`;
        footer.style.display = 'none';
        clearBtn.style.display = 'none';
        updateNavBadge();
        return;
      }
      
      footer.style.display = 'block';
      clearBtn.style.display = 'block';
      
      let html = '';
      let total = 0, totalItems = 0, packCount = 0;
      
      cart.forEach((item, i) => {
        const product = products.find(p => p.id === item.id);
        const isPack = item.isPack || (product && product.isPack);
        const unitLabel = isPack ? '–ø–∞—á.' : '—à—Ç.';
        const itemTotal = item.qty * item.price;
        total += itemTotal;
        totalItems += item.qty;
        if (isPack) packCount++;
        
        html += `
          <div class="cart-item">
            <img referrerpolicy="no-referrer" data-original-url="${item.image}" src="${fixCartImageUrl(item.image)}" onerror="handleCartImageError(this, '${item.image}')" class="cart-item-img">
            <div class="cart-item-info">
              <div class="cart-item-title">${item.title}${isPack ? '<span class="pack-badge">–ü–ê–ß–ö–ê</span>' : ''}</div>
              ${item.variantName ? `<div class="cart-item-variant">üé® ${item.variantName}</div>` : ''}
              <div class="cart-item-price-unit">${item.price} —Å–æ–º / ${unitLabel}</div>
              <div class="cart-item-qty-controls">
                <button class="qty-btn" onclick="changeQty(${i}, -1)">‚àí</button>
                <span class="qty-value">${item.qty}</span>
                <button class="qty-btn" onclick="changeQty(${i}, 1)">+</button>
                <span class="qty-unit">${unitLabel}</span>
              </div>
            </div>
            <div class="cart-item-right">
              <div class="cart-item-total">${itemTotal} —Å–æ–º</div>
              <button class="remove-btn" onclick="removeItem(${i})">üóëÔ∏è</button>
            </div>
          </div>`;
      });
      
      content.innerHTML = html;
      document.getElementById('cartTotal').textContent = total.toLocaleString() + ' —Å–æ–º';
      
      const posWord = cart.length === 1 ? '–ø–æ–∑–∏—Ü–∏—è' : (cart.length < 5 ? '–ø–æ–∑–∏—Ü–∏–∏' : '–ø–æ–∑–∏—Ü–∏–π');
      let summary = `${cart.length} ${posWord}, ${totalItems} —Ç–æ–≤–∞—Ä–æ–≤`;
      if (packCount > 0) summary += ` (${packCount} –ø–∞—á–µ–∫)`;
      document.getElementById('cartSummary').textContent = summary;
      updateNavBadge();
    }
    
    function changeQty(index, delta) {
      const item = cart[index];
      const product = products.find(p => p.id === item.id);
      const step = (item.isPack || (product && product.isPack)) ? 1 : (product?.minQty || 1);
      const newQty = item.qty + (delta * step);
      
      if (newQty <= 0) { removeItem(index); return; }
      
      item.qty = newQty;
      if (product && product.optQty && newQty >= product.optQty && product.optPrice) {
        item.price = product.optPrice;
      } else if (product) {
        item.price = product.price;
      }
      saveCart();
      renderCart();
    }
    
    function removeItem(index) {
      Swal.fire({
        title: '–£–¥–∞–ª–∏—Ç—å?',
        text: cart[index].title,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        confirmButtonText: '–£–¥–∞–ª–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      }).then(r => {
        if (r.isConfirmed) {
          cart.splice(index, 1);
          saveCart();
          renderCart();
        }
      });
    }
    
    function clearCart() {
      if (!cart.length) return;
      Swal.fire({
        title: '–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        confirmButtonText: '–û—á–∏—Å—Ç–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      }).then(r => {
        if (r.isConfirmed) { cart = []; saveCart(); renderCart(); }
      });
    }
    
    function saveCart() {
      localStorage.setItem('cart', JSON.stringify(cart));
    }
    
    function updateNavBadge() {
      const badge = document.getElementById('navCartBadge');
      if (badge) {
        badge.textContent = cart.length;
        badge.style.display = cart.length > 0 ? 'flex' : 'none';
      }
    }
    
    window.addEventListener('storage', e => {
      if (e.key === 'cart') { cart = JSON.parse(e.newValue || '[]'); renderCart(); }
    });
    
    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>