<!DOCTYPE html>
<html lang="ru">
<head>
  <script>if(window.parent!==window)document.write('<style>.bottom-nav{display:none!important}body{padding-bottom:0!important}</style>')</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="description" content="–ö–æ—Ä–∑–∏–Ω–∞ - –ö–µ—Ä–±–µ–Ω B2B Market">
  <meta name="theme-color" content="#4CAF50">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="icon-kerben.jpg">
  <link rel="icon" type="image/jpeg" href="icon-kerben.jpg">
  
  <title>–ö–æ—Ä–∑–∏–Ω–∞ - –ö–µ—Ä–±–µ–Ω</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    .page-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #fff;
      padding: 15px 20px;
      padding-top: calc(15px + env(safe-area-inset-top, 0px));
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .back-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      color: #333;
      text-decoration: none;
    }
    
    .page-title { flex: 1; font-size: 18px; font-weight: 600; color: #333; }
    
    .clear-btn {
      background: none;
      border: none;
      color: #f44336;
      font-size: 14px;
      cursor: pointer;
    }
    
    .cart-content { padding: 15px; padding-bottom: 180px; }
    
    .cart-empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .cart-empty-icon { font-size: 64px; margin-bottom: 15px; }
    .cart-empty-text { font-size: 18px; margin-bottom: 10px; color: #666; }
    .cart-empty-subtext { font-size: 14px; margin-bottom: 25px; }
    
    .go-shopping-btn {
      display: inline-block;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 14px 30px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
    }
    
    .cart-item {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .cart-item-img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 10px;
      background: #f0f0f0;
    }
    
    .cart-item-info { flex: 1; min-width: 0; }
    
    .cart-item-title {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .cart-item-variant {
      color: #7b1fa2;
      font-size: 11px;
      margin-bottom: 4px;
      background: #f3e5f5;
      padding: 3px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    
    .cart-item-price-unit { color: #666; font-size: 12px; margin-bottom: 8px; }
    
    .cart-item-qty-controls { display: flex; align-items: center; gap: 6px; }
    
    .qty-input {
      width: 60px;
      height: 36px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      padding: 0 8px;
      box-sizing: border-box;
    }
    
    .qty-input:focus {
      border-color: #4CAF50;
      outline: none;
    }
    
    .qty-unit { color: #888; font-size: 12px; }
    
    .cart-item-right { text-align: right; }
    .cart-item-total { font-size: 17px; font-weight: 700; color: #e53935; margin-bottom: 8px; }
    
    .remove-btn {
      background: #ffebee;
      color: #c62828;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .pack-badge {
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      color: white;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 9px;
      margin-left: 6px;
    }
    
    .cart-footer {
      position: fixed;
      bottom: 56px;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 15px 20px;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.08);
      z-index: 90;
    }
    
    .cart-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .cart-summary-label { font-size: 14px; color: #666; }
    .cart-summary-total { font-size: 22px; font-weight: 700; color: #333; }
    .cart-summary-info { font-size: 12px; color: #888; margin-bottom: 12px; }
    
    .checkout-btn {
      width: 100%;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: block;
      text-align: center;
    }
    
@media (min-width: 769px) {
      .cart-footer { bottom: 0; }
    }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- jsPDF –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS (XLSX) –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <!-- EXIF –¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —Ñ–æ—Ç–æ -->
  <script src="https://cdn.jsdelivr.net/npm/exif-js@2.3.0/exif.min.js"></script>
  <!-- –§—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
  <script src="js/upload.js"></script>
  <!-- –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–æ–≤ -->
  <script src="js/orders.js"></script>
</head>

<body>
  <header class="page-header">
    <a href="#" onclick="goBack(); return false;" class="back-btn">‚Üê</a>
    <h1 class="page-title">üõí –ö–æ—Ä–∑–∏–Ω–∞</h1>
    <button class="clear-btn" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å</button>
  </header>
  
  <main class="cart-content" id="cartContent"></main>
  
  <div class="cart-footer" id="cartFooter" style="display:none;">
    <div class="cart-summary">
      <span class="cart-summary-label">–ò—Ç–æ–≥–æ:</span>
      <span class="cart-summary-total" id="cartTotal">0 —Å–æ–º</span>
    </div>
    <div class="cart-summary-info" id="cartSummary"></div>
    <a href="index.html#order-form" class="checkout-btn" onclick="checkoutFromCart(event)">üì¶ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
  </div>
  
  <script>
    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const initialUrl = window.location.href;
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ iframe –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥
    function goBack() {
      if (window.parent !== window && window.location.href === initialUrl) {
        window.parent.postMessage('closeIframe', '*');
      } else if (window.parent !== window) {
        window.location.href = initialUrl;
      } else {
        window.location.href = 'index.html';
      }
    }
  </script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
      authDomain: "svoysayet.firebaseapp.com",
      projectId: "svoysayet",
      storageBucket: "svoysayet.firebasestorage.app",
      messagingSenderId: "450143000217",
      appId: "1:450143000217:web:7495cefaea0b94966e8a08",
      measurementId: "G-Y8VG9E29FY"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let products = [];
    
    // –§—É–Ω–∫—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è URL (https/ -> https://)
    function fixCartImageUrl(url) {
      if (!url || typeof url !== 'string') return '';
      if (url.startsWith('https/')) {
        url = 'https://' + url.substring(6);
      }
      if (url.startsWith('http/')) {
        url = 'http://' + url.substring(5);
      }
      return url;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
    function handleCartImageError(img, originalUrl) {
      if (!img || img.dataset.failCount >= 2) {
        img.src = 'data:image/svg+xml,' + encodeURIComponent(
          '<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect fill="#f0f0f0" width="80" height="80"/><text fill="#999" x="40" y="45" text-anchor="middle" font-size="12">üì∑</text></svg>'
        );
        return;
      }
      const failCount = parseInt(img.dataset.failCount || '0');
      img.dataset.failCount = failCount + 1;
      
      if (failCount === 0) {
        img.src = 'https://images.weserv.nl/?url=' + encodeURIComponent(fixCartImageUrl(originalUrl)) + '&default=1';
      } else {
        img.src = 'data:image/svg+xml,' + encodeURIComponent(
          '<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><rect fill="#f0f0f0" width="80" height="80"/><text fill="#999" x="40" y="45" text-anchor="middle" font-size="12">üì∑</text></svg>'
        );
      }
    }
    
    async function loadProducts() {
      try {
        const snapshot = await db.collection('products').get();
        products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (e) { console.error(e); }
      renderCart();
    }
    
    function renderCart() {
      const content = document.getElementById('cartContent');
      const footer = document.getElementById('cartFooter');
      const clearBtn = document.querySelector('.clear-btn');
      
      if (cart.length === 0) {
        content.innerHTML = `
          <div class="cart-empty">
            <div class="cart-empty-icon">üõí</div>
            <div class="cart-empty-text">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
            <div class="cart-empty-subtext">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</div>
            <a href="index.html" class="go-shopping-btn">üõçÔ∏è –ó–∞ –ø–æ–∫—É–ø–∫–∞–º–∏</a>
          </div>`;
        footer.style.display = 'none';
        clearBtn.style.display = 'none';
        updateNavBadge();
        return;
      }
      
      footer.style.display = 'block';
      clearBtn.style.display = 'block';
      
      let html = '';
      let total = 0, totalItems = 0, packCount = 0;
      
      cart.forEach((item, i) => {
        const product = products.find(p => p.id === item.id);
        const isPack = item.isPack || (product && product.isPack);
        const unitLabel = isPack ? '–ø–∞—á.' : '—à—Ç.';
        const itemTotal = item.qty * item.price;
        total += itemTotal;
        totalItems += item.qty;
        if (isPack) packCount++;
        
        html += `
          <div class="cart-item">
            <img referrerpolicy="no-referrer" data-original-url="${item.image}" src="${fixCartImageUrl(item.image)}" onerror="handleCartImageError(this, '${item.image}')" class="cart-item-img">
            <div class="cart-item-info">
              <div class="cart-item-title">${item.title}${isPack ? '<span class="pack-badge">–ü–ê–ß–ö–ê</span>' : ''}</div>
              ${item.variantName ? `<div class="cart-item-variant">üé® ${item.variantName}</div>` : ''}
              <div class="cart-item-price-unit">${item.price} —Å–æ–º / ${unitLabel}</div>
              <div class="cart-item-qty-controls">
                <input type="number" class="qty-input" value="${item.qty}" min="1" onchange="updateQtyFromInput(${i}, this.value)" onkeyup="if(event.key==='Enter') this.blur()">
                <span class="qty-unit">${unitLabel}</span>
              </div>
            </div>
            <div class="cart-item-right">
              <div class="cart-item-total">${itemTotal} —Å–æ–º</div>
              <button class="remove-btn" onclick="removeItem(${i})">üóëÔ∏è</button>
            </div>
          </div>`;
      });
      
      content.innerHTML = html;
      document.getElementById('cartTotal').textContent = total.toLocaleString() + ' —Å–æ–º';
      
      const posWord = cart.length === 1 ? '–ø–æ–∑–∏—Ü–∏—è' : (cart.length < 5 ? '–ø–æ–∑–∏—Ü–∏–∏' : '–ø–æ–∑–∏—Ü–∏–π');
      let summary = `${cart.length} ${posWord}, ${totalItems} —Ç–æ–≤–∞—Ä–æ–≤`;
      if (packCount > 0) summary += ` (${packCount} –ø–∞—á–µ–∫)`;
      document.getElementById('cartSummary').textContent = summary;
      updateNavBadge();
    }
    
    function changeQty(index, delta) {
      const item = cart[index];
      const product = products.find(p => p.id === item.id);
      const step = (item.isPack || (product && product.isPack)) ? 1 : (product?.minQty || 1);
      const newQty = item.qty + (delta * step);
      
      if (newQty <= 0) { removeItem(index); return; }
      
      item.qty = newQty;
      if (product && product.optQty && newQty >= product.optQty && product.optPrice) {
        item.price = product.optPrice;
      } else if (product) {
        item.price = product.price;
      }
      saveCart();
      renderCart();
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
    function updateQtyFromInput(index, value) {
      const newQty = parseInt(value) || 1;
      const item = cart[index];
      const product = products.find(p => p.id === item.id);
      
      if (newQty <= 0) {
        removeItem(index);
        return;
      }
      
      item.qty = newQty;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É (–æ–ø—Ç/—Ä–æ–∑–Ω–∏—Ü–∞)
      if (product && product.optQty && newQty >= product.optQty && product.optPrice) {
        item.price = product.optPrice;
      } else if (product) {
        item.price = product.price;
      }
      
      saveCart();
      renderCart();
    }
    
    function removeItem(index) {
      Swal.fire({
        title: '–£–¥–∞–ª–∏—Ç—å?',
        text: cart[index].title,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        confirmButtonText: '–£–¥–∞–ª–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      }).then(r => {
        if (r.isConfirmed) {
          cart.splice(index, 1);
          saveCart();
          renderCart();
        }
      });
    }
    
    function clearCart() {
      if (!cart.length) return;
      Swal.fire({
        title: '–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        confirmButtonText: '–û—á–∏—Å—Ç–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      }).then(r => {
        if (r.isConfirmed) { cart = []; saveCart(); renderCart(); }
      });
    }
    
    function saveCart() {
      localStorage.setItem('cart', JSON.stringify(cart));
    }
    
    function updateNavBadge() {
      const badge = document.getElementById('navCartBadge');
      if (badge) {
        badge.textContent = cart.length;
        badge.style.display = cart.length > 0 ? 'flex' : 'none';
      }
    }
    
    window.addEventListener('storage', e => {
      if (e.key === 'cart') { cart = JSON.parse(e.newValue || '[]'); renderCart(); }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø—Ä—è–º–æ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
    async function checkoutFromCart(event) {
      event.preventDefault();
      
      if (cart.length === 0) {
        Swal.fire('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', '–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞', 'warning');
        return;
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (customerData)
      const customerData = JSON.parse(localStorage.getItem('customerData') || '{}');
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–≤–æ–¥–∏—Ç–µ–ª—å) –∏–∑ userData
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ SweetAlert
      const { value: formData } = await Swal.fire({
        title: 'üì¶ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞',
        html: `
          <div style="text-align:left;">
            <div style="margin-bottom:12px;">
              <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">üë§ –í–∞—à–µ –∏–º—è:</label>
              <input type="text" id="swal-name" value="${customerData.name || ''}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">üì± –¢–µ–ª–µ—Ñ–æ–Ω:</label>
              <input type="tel" id="swal-phone" value="${customerData.phone || ''}" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block; margin-bottom:5px; font-weight:600; color:#333;">üìç –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
              <input type="text" id="swal-address" value="${customerData.address || ''}" placeholder="–ê–¥—Ä–µ—Å" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
            </div>
            <div style="margin-bottom:12px;">
              <label style="display:block; margin-bottom:5px; font-weight:600; color:#666;">üöó –í–æ–¥–∏—Ç–µ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
              <input type="text" id="swal-driver" value="${userData.driverName || ''}" placeholder="–ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è" style="width:100%; padding:10px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px; box-sizing:border-box; background:#f8f9fa;">
            </div>
            <div style="margin-bottom:12px;">
              <input type="tel" id="swal-driver-phone" value="${userData.driverPhone || ''}" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è" style="width:100%; padding:10px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px; box-sizing:border-box; background:#f8f9fa;">
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑',
        cancelButtonText: '‚ùå –û—Ç–º–µ–Ω–∞',
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        preConfirm: () => {
          const name = document.getElementById('swal-name').value.trim();
          const phone = document.getElementById('swal-phone').value.trim();
          const address = document.getElementById('swal-address').value.trim();
          
          if (!name || !phone || !address) {
            Swal.showValidationMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –∞–¥—Ä–µ—Å');
            return false;
          }
          
          return {
            name: name,
            phone: phone,
            address: address,
            driverName: document.getElementById('swal-driver').value.trim(),
            driverPhone: document.getElementById('swal-driver-phone').value.trim()
          };
        }
      });
      
      if (!formData) return; // –û—Ç–º–µ–Ω–∞
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª—è –≤ userData (–¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤)
      localStorage.setItem('userData', JSON.stringify({
        ...userData,
        driverName: formData.driverName,
        driverPhone: formData.driverPhone
      }));
      
      try {
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
        const now = new Date();
        const currentTime = now.toLocaleString('ru-RU');
        let total = 0;
        
        const orderItems = cart.map(item => {
          const product = products.find(p => p.id === item.id);
          total += item.qty * item.price;
          return {
            id: item.id,
            title: item.title,
            price: item.price,
            costPrice: product?.costPrice || item.costPrice || 0,
            qty: item.qty,
            image: item.image,
            variantName: item.variantName || null,
            sellerId: product?.sellerId || item.sellerId || null,
            sellerName: product?.sellerName || item.sellerName || null
          };
        });
        
        // –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑ –≤ Firebase
        const orderData = {
          name: formData.name,
          phone: formData.phone,
          address: formData.address,
          driverName: formData.driverName || '',
          driverPhone: formData.driverPhone || '',
          items: orderItems,
          total: total,
          status: 'pending',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAtMs: Date.now()
        };
        
        const docRef = await db.collection('orders').add(orderData);
        console.log('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω:', docRef.id);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
        for (const item of orderItems) {
          const product = products.find(p => p.id === item.id);
          if (product && typeof product.stock === 'number' && isFinite(product.stock)) {
            const newStock = Math.max(0, product.stock - item.qty);
            await db.collection('products').doc(item.id).update({ stock: newStock });
          }
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –≤ —Ñ–∞–π–ª–∞—Ö (PDF/Excel)
        const orderDataForFiles = {
          name: formData.name,
          phone: formData.phone,
          address: formData.address,
          driverName: formData.driverName || '',
          driverPhone: formData.driverPhone || '',
          cart: orderItems,
          total: total,
          currentTime: currentTime
        };
        
        // 1. Excel —Ñ–∞–π–ª
        if (typeof sendOrderAsExcelFile === 'function') {
          sendOrderAsExcelFile(orderDataForFiles.name, orderDataForFiles.phone, orderDataForFiles.address, orderDataForFiles.driverName, orderDataForFiles.driverPhone, orderDataForFiles.cart, orderDataForFiles.total, orderDataForFiles.currentTime)
            .then(() => console.log('Excel —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ'))
            .catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Excel:', err));
        }
        
        // 2. PDF –¥–ª—è –ø–µ—á–∞—Ç–∏ (–±–µ–∑ —Ñ–æ—Ç–æ)
        if (typeof sendOrderAsExcel === 'function') {
          sendOrderAsExcel(orderDataForFiles.name, orderDataForFiles.phone, orderDataForFiles.address, orderDataForFiles.driverName, orderDataForFiles.driverPhone, orderDataForFiles.cart, orderDataForFiles.total, orderDataForFiles.currentTime)
            .then(() => console.log('PDF –¥–ª—è –ø–µ—á–∞—Ç–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ'))
            .catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF –¥–ª—è –ø–µ—á–∞—Ç–∏:', err));
        }
        
        // 3. PDF —Å —Ñ–æ—Ç–æ
        if (typeof sendOrderAsPDF === 'function') {
          sendOrderAsPDF(orderDataForFiles.name, orderDataForFiles.phone, orderDataForFiles.address, orderDataForFiles.driverName, orderDataForFiles.driverPhone, orderDataForFiles.cart, orderDataForFiles.total, orderDataForFiles.currentTime)
            .then(() => console.log('PDF —Å —Ñ–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ'))
            .catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF —Å —Ñ–æ—Ç–æ:', err));
        }
        
        // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
        cart = [];
        saveCart();
        renderCart();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
        Swal.fire({
          icon: 'success',
          title: '‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!',
          html: `
            <div style="text-align:center;">
              <p style="font-size:18px; margin-bottom:15px;">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: <strong>#${docRef.id.slice(-6).toUpperCase()}</strong></p>
              <p style="color:#666;">–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
            </div>
          `,
          confirmButtonText: '–û—Ç–ª–∏—á–Ω–æ!',
          confirmButtonColor: '#28a745'
        });
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
        Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: ' + error.message, 'error');
      }
    }
    
    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>