<!DOCTYPE html>
<html lang="ru">
<head>
  <script>if(window.parent!==window)document.write('<style>.bottom-nav{display:none!important}body{padding-bottom:0!important}.main-container{height:100vh!important}</style>')</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–û—Ç—á–µ—Ç –ø–æ –ø—Ä–∏–±—ã–ª–∏ - –ö–µ—Ä–±–µ–Ω</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    input, textarea, select {
      font-family: inherit;
      font-size: 16px;
    }
    
    /* SweetAlert –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
    .swal2-container {
      z-index: 999999 !important;
    }
    
    /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #fff;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-around;
      z-index: 99999;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      color: #9e9e9e;
      text-decoration: none;
      position: relative;
    }
    .nav-item.active { color: #4CAF50; }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
    .nav-item span { font-size: 11px; }
    
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .main-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 56px);
      background: #fff;
    }
    
    /* –®–∞–ø–∫–∞ */
    .profit-header {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .profit-header h1 {
      margin: 0;
      font-size: 24px;
    }
    .profit-header p {
      margin: 5px 0 0;
      opacity: 0.9;
    }
    .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* –í–∫–ª–∞–¥–∫–∏ */
    .profit-tabs {
      display: flex;
      gap: 10px;
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    .profit-tabs button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    .profit-tabs button.active {
      background: linear-gradient(90deg, #28a745, #20c997);
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .profit-tabs button:not(.active) {
      background: #e9ecef;
      color: #333;
    }
    
    /* –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
    .filters-panel {
      padding: 15px;
      background: #f8f9fa;
      flex-shrink: 0;
    }
    
    /* –°–≤–æ–¥–∫–∞ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-card .label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
    }
    .stat-card .value.green { color: #28a745; }
    .stat-card .value.blue { color: #007bff; }
    .stat-card .value.gray { color: #6c757d; }
    .stat-card .value.red { color: #dc3545; }
    .stat-card .value.purple { color: #9c27b0; }
    
    /* –ö–æ–Ω—Ç—Ä–æ–ª—ã */
    .controls-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .controls-row select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      flex: 1;
      min-width: 150px;
    }
    .controls-row button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 500;
    }
    .btn-green { background: #28a745; color: white; }
    .btn-blue { background: #17a2b8; color: white; }
    .btn-primary { background: #007bff; color: white; }
    .btn-red { background: #dc3545; color: white; }
    
    /* –¢–∞–±–ª–∏—Ü–∞ */
    .table-container {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    thead tr {
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
    }
    th {
      padding: 12px;
      font-size: 13px;
      color: #666;
      text-align: left;
    }
    th.right { text-align: right; }
    th.center { text-align: center; }
    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    td.right { text-align: right; }
    td.center { text-align: center; }
    tbody tr:hover { background: #f8f9fa; }
    
    /* –°–∫—Ä—ã—Ç—ã–µ –ø–∞–Ω–µ–ª–∏ */
    .panel { display: none; }
    .panel.active { display: block; }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9700;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: white;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 { margin: 0; font-size: 22px; }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 600px) {
      .profit-header { padding: 14px; }
      .profit-header h1 { font-size: 18px; }
      .profit-tabs { gap: 6px; }
      .profit-tabs button { flex: 1 1 30%; padding: 10px 8px; font-size: 12px; }
      .stats-row { 
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 10px;
        padding-bottom: 8px;
      }
      .stat-card {
        flex: 0 0 auto;
        min-width: 120px;
        padding: 10px;
      }
      .stat-card .label { font-size: 10px; }
      .stat-card .value { font-size: 18px; }
      .controls-row {
        flex-direction: column;
        align-items: stretch;
      }
      .controls-row > * { width: 100%; }
      
      /* –ö–∞—Ä—Ç–æ—á–Ω—ã–π –≤–∏–¥ —Ç–∞–±–ª–∏—Ü */
      table, thead, tbody, th, tr, td { display: block; width: 100%; }
      thead { display: none; }
      tbody { display: flex; flex-direction: column; gap: 10px; }
      tr {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      }
      td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        text-align: right;
        font-size: 14px;
      }
      td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #555;
        text-align: left;
        flex-shrink: 0;
        font-size: 13px;
      }
      td.product-name-cell {
        display: block;
        text-align: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 16px;
        font-weight: 700;
        padding: 14px 10px;
      }
      td.product-name-cell::before { display: none; }
      td[data-label="#"] { display: none; }
    }
  </style>
</head>
<body>

<div class="main-container">
  <!-- –®–∞–ø–∫–∞ -->
  <div class="profit-header">
    <div>
      <h1>üí∞ –û—Ç—á–µ—Ç –ø–æ –ø—Ä–∏–±—ã–ª–∏</h1>
      <p>–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–æ–≤</p>
    </div>
    <button class="back-btn" onclick="window.location.href='profile.html'">‚Üê</button>
  </div>
  
  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <div class="profit-tabs">
    <button id="tabDashboard" onclick="switchTab('dashboard')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button id="tabProducts" class="active" onclick="switchTab('products')">üì¶ –ü–æ —Ç–æ–≤–∞—Ä–∞–º</button>
    <button id="tabOrders" onclick="switchTab('orders')">üìã –ü–æ –∑–∞–∫–∞–∑–∞–º</button>
    <button id="tabAgents" onclick="switchTab('agents')">ü§ù –ê–≥–µ–Ω—Ç—ã</button>
    <button id="tabExpenses" onclick="switchTab('expenses')">üí∏ –†–∞—Å—Ö–æ–¥—ã</button>
  </div>
  
  <!-- ============ –ü–ê–ù–ï–õ–¨ –ê–ù–ê–õ–ò–¢–ò–ö–ê (DASHBOARD) ============ -->
  <div id="dashboardPanel" class="panel">
    <div class="filters-panel">
      <div class="controls-row" style="margin-bottom:15px;">
        <select id="dashboardDateFilter" onchange="loadDashboard()">
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="yesterday">–í—á–µ—Ä–∞</option>
          <option value="week" selected>–ó–∞ –Ω–µ–¥–µ–ª—é</option>
          <option value="last30days">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
          <optgroup label="üìÖ –ü–æ –º–µ—Å—è—Ü–∞–º" id="monthOptionsGroup"></optgroup>
          <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
        </select>
        <button class="btn-blue" onclick="loadDashboard()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn-green" onclick="exportDashboardToExcel()">üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç</button>
      </div>
      
      <!-- –ì–ª–∞–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
      <div style="background:linear-gradient(135deg,#28a745,#20c997);color:white;padding:20px;border-radius:12px;margin-bottom:15px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-size:14px;opacity:0.9;">üí∞ –ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨ –ó–ê –ü–ï–†–ò–û–î</div>
          <div style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:20px;" id="dashPeriodDates">üìÖ –ó–∞ –Ω–µ–¥–µ–ª—é</div>
        </div>
        <div style="font-size:36px;font-weight:800;margin:8px 0;" id="dashNetProfit">0 —Å–æ–º</div>
        <div style="font-size:13px;opacity:0.8;" id="dashNetProfitInfo">–í—ã—Ä—É—á–∫–∞ - –†–∞—Å—Ö–æ–¥—ã - –ö–æ–º–∏—Å—Å–∏–∏ –∞–≥–µ–Ω—Ç–∞–º</div>
      </div>
      
      <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞ -->
      <div class="stats-row">
        <div class="stat-card" style="border-left:4px solid #28a745;">
          <div class="label">üíµ –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞</div>
          <div class="value green" id="dashTotalRevenue">0 —Å–æ–º</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #007bff;">
          <div class="label">üí∞ –í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å</div>
          <div class="value blue" id="dashGrossProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #dc3545;">
          <div class="label">üí∏ –†–∞—Å—Ö–æ–¥—ã</div>
          <div class="value red" id="dashTotalExpenses">0 —Å–æ–º</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #9c27b0;">
          <div class="label">ü§ù –ö–æ–º–∏—Å—Å–∏–∏ –∞–≥–µ–Ω—Ç–∞–º</div>
          <div class="value purple" id="dashAgentCommission">0 —Å–æ–º</div>
        </div>
      </div>
      
      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º -->
      <h3 style="margin:20px 0 10px;color:#333;">üìã –ó–∞–∫–∞–∑—ã –∏ –∫–ª–∏–µ–Ω—Ç—ã</h3>
      <div class="stats-row">
        <div class="stat-card">
          <div class="label">üì¶ –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
          <div class="value blue" id="dashOrdersCount">0</div>
        </div>
        <div class="stat-card">
          <div class="label">üë• –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
          <div class="value gray" id="dashClientsCount">0</div>
        </div>
        <div class="stat-card">
          <div class="label">üõí –¢–æ–≤–∞—Ä–æ–≤ –ø—Ä–æ–¥–∞–Ω–æ</div>
          <div class="value" id="dashProductsSold">0</div>
        </div>
        <div class="stat-card">
          <div class="label">üí≥ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
          <div class="value green" id="dashAvgCheck">0 —Å–æ–º</div>
        </div>
      </div>
      
      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–≥–µ–Ω—Ç–∞–º -->
      <h3 style="margin:20px 0 10px;color:#333;">ü§ù –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤</h3>
      <div class="stats-row">
        <div class="stat-card">
          <div class="label">üë§ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤</div>
          <div class="value purple" id="dashActiveAgents">0</div>
        </div>
        <div class="stat-card">
          <div class="label">üì¶ –ó–∞–∫–∞–∑–æ–≤ –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤</div>
          <div class="value blue" id="dashAgentOrders">0</div>
        </div>
        <div class="stat-card">
          <div class="label">üí∞ –ü—Ä–∏–±—ã–ª—å –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤</div>
          <div class="value green" id="dashAgentProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">üìä –î–æ–ª—è –∞–≥–µ–Ω—Ç–æ–≤</div>
          <div class="value" id="dashAgentShare">0%</div>
        </div>
      </div>
      
      <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
      <h3 style="margin:20px 0 10px;color:#333;">üí∏ –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤</h3>
      <div id="dashExpensesList" style="background:white;border-radius:12px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
        –ó–∞–≥—Ä—É–∑–∫–∞...
      </div>
      
      <!-- –¢–û–ü —Ç–æ–≤–∞—Ä—ã -->
      <h3 style="margin:20px 0 10px;color:#333;">üî• –¢–û–ü-5 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏</h3>
      <div id="dashTopProducts" style="background:white;border-radius:12px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
        –ó–∞–≥—Ä—É–∑–∫–∞...
      </div>
      
      <!-- –¢–û–ü –∞–≥–µ–Ω—Ç—ã -->
      <h3 style="margin:20px 0 10px;color:#333;">‚≠ê –¢–û–ü-5 –∞–≥–µ–Ω—Ç–æ–≤</h3>
      <div id="dashTopAgents" style="background:white;border-radius:12px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.1);">
        –ó–∞–≥—Ä—É–∑–∫–∞...
      </div>
    </div>
  </div>
  
  <!-- ============ –ü–ê–ù–ï–õ–¨ –ü–û –¢–û–í–ê–†–ê–ú ============ -->
  <div id="productsPanel" class="panel active">
    <div class="filters-panel">
      <div class="stats-row">
        <div class="stat-card">
          <div class="label">üí∞ –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</div>
          <div class="value green" id="totalProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">üìä –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞</div>
          <div class="value blue" id="avgMarkup">0%</div>
        </div>
        <div class="stat-card">
          <div class="label">üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
          <div class="value gray" id="totalProducts">0</div>
        </div>
      </div>
      <div class="controls-row">
        <select id="profitCategoryFilter" onchange="filterProfitReport()">
          <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        </select>
        <select id="profitSortFilter" onchange="filterProfitReport()">
          <option value="profit-desc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üì)</option>
          <option value="profit-asc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üë)</option>
          <option value="markup-desc">–ü–æ –Ω–∞—Ü–µ–Ω–∫–µ (‚Üì)</option>
          <option value="markup-asc">–ü–æ –Ω–∞—Ü–µ–Ω–∫–µ (‚Üë)</option>
          <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
        </select>
        <button class="btn-green" onclick="exportProfitToExcel()">üì• Excel</button>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>–¢–æ–≤–∞—Ä</th>
            <th class="center">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th class="right">üíµ –ó–∞–∫—É–ø–∫–∞</th>
            <th class="right">üí∞ –ü—Ä–æ–¥–∞–∂–∞</th>
            <th class="right">üìä –ü—Ä–∏–±—ã–ª—å</th>
            <th class="right">% –ù–∞—Ü–µ–Ω–∫–∞</th>
          </tr>
        </thead>
        <tbody id="profitReportBody"></tbody>
      </table>
    </div>
  </div>
  
  <!-- ============ –ü–ê–ù–ï–õ–¨ –ü–û –ó–ê–ö–ê–ó–ê–ú ============ -->
  <div id="ordersPanel" class="panel">
    <div class="filters-panel">
      <div class="stats-row">
        <div class="stat-card">
          <div class="label">üí∞ –ü—Ä–∏–±—ã–ª—å –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
          <div class="value green" id="totalOrderProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">üìã –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
          <div class="value blue" id="totalOrdersCount">0</div>
        </div>
        <div class="stat-card">
          <div class="label">üë• –ö–ª–∏–µ–Ω—Ç–æ–≤</div>
          <div class="value gray" id="totalClientsCount">0</div>
        </div>
      </div>
      <div class="controls-row">
        <select id="orderDateFilter" onchange="loadOrderProfitReport()">
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="yesterday">–í—á–µ—Ä–∞</option>
          <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
          <option value="last30days">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
          <optgroup label="üìÖ –ü–æ –º–µ—Å—è—Ü–∞–º" id="orderMonthOptionsGroup"></optgroup>
          <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
        </select>
        <select id="orderSortFilter" onchange="loadOrderProfitReport()">
          <option value="profit-desc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üì)</option>
          <option value="date-desc">–ü–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ)</option>
          <option value="date-asc">–ü–æ –¥–∞—Ç–µ (—Å—Ç–∞—Ä—ã–µ)</option>
        </select>
        <button class="btn-green" onclick="exportOrderProfitToExcel()">üì• Excel</button>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>–î–∞—Ç–∞</th>
            <th>üë§ –ö–ª–∏–µ–Ω—Ç</th>
            <th class="center">üì¶ –¢–æ–≤–∞—Ä–æ–≤</th>
            <th class="right">üíµ –ó–∞–∫—É–ø–∫–∞</th>
            <th class="right">üí∞ –°—É–º–º–∞</th>
            <th class="right">üìä –ü—Ä–∏–±—ã–ª—å</th>
          </tr>
        </thead>
        <tbody id="orderProfitReportBody"></tbody>
      </table>
    </div>
  </div>
  
  <!-- ============ –ü–ê–ù–ï–õ–¨ –ê–ì–ï–ù–¢–û–í ============ -->
  <div id="agentsPanel" class="panel">
    <div class="filters-panel">
      <!-- –ì–ª–∞–≤–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å -->
      <div style="background:linear-gradient(135deg,#9c27b0,#673ab7);color:white;padding:20px;border-radius:12px;margin-bottom:15px;">
        <div style="font-size:14px;opacity:0.9;">üí∞ –ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨ –û–¢ –ê–ì–ï–ù–¢–û–í</div>
        <div style="font-size:32px;font-weight:800;margin:8px 0;" id="agentsNetProfit">0 —Å–æ–º</div>
        <div style="font-size:13px;opacity:0.8;">–ü—Ä–∏–±—ã–ª—å –æ—Ç –∑–∞–∫–∞–∑–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤ –º–∏–Ω—É—Å –∏—Ö –∫–æ–º–∏—Å—Å–∏—è (2%)</div>
      </div>
      
      <div class="stats-row">
        <div class="stat-card" style="border-left:4px solid #9c27b0;">
          <div class="label">ü§ù –í—Å–µ–≥–æ –∞–≥–µ–Ω—Ç–æ–≤</div>
          <div class="value purple" id="agentsTotalCount">0</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #007bff;">
          <div class="label">üì¶ –ó–∞–∫–∞–∑–æ–≤ –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤</div>
          <div class="value blue" id="agentsOrdersCount">0</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #28a745;">
          <div class="label">üí∞ –í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å</div>
          <div class="value green" id="agentsTotalProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #dc3545;">
          <div class="label">üí∏ –ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç–∞–º (2%)</div>
          <div class="value red" id="agentsTotalCommission">0 —Å–æ–º</div>
        </div>
      </div>
      
      <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="stats-row" style="margin-top:10px;">
        <div class="stat-card">
          <div class="label">üíµ –û–±—â–∏–µ –ø—Ä–æ–¥–∞–∂–∏</div>
          <div class="value" id="agentsTotalSales">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">üìä –°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
          <div class="value blue" id="agentsAvgCheck">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">üí∞ –°—Ä. –ø—Ä–∏–±—ã–ª—å/–∑–∞–∫–∞–∑</div>
          <div class="value green" id="agentsAvgProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">‚≠ê –õ—É—á—à–∏–π –∞–≥–µ–Ω—Ç</div>
          <div class="value purple" id="agentsBestAgent" style="font-size:16px;">-</div>
        </div>
      </div>
      <div class="controls-row">
        <select id="agentsDateFilter" onchange="loadAgentsProfitReport()">
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="yesterday">–í—á–µ—Ä–∞</option>
          <option value="week" selected>–ó–∞ –Ω–µ–¥–µ–ª—é</option>
          <option value="last30days">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
          <optgroup label="üìÖ –ü–æ –º–µ—Å—è—Ü–∞–º" id="agentsMonthOptionsGroup"></optgroup>
          <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
        </select>
        <select id="agentsSortFilter" onchange="loadAgentsProfitReport()">
          <option value="orders-desc">–ü–æ –∑–∞–∫–∞–∑–∞–º (‚Üì)</option>
          <option value="sum-desc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üì)</option>
          <option value="commission-desc">–ü–æ –∫–æ–º–∏—Å—Å–∏–∏ (‚Üì)</option>
          <option value="name">–ü–æ –∏–º–µ–Ω–∏</option>
        </select>
        <button class="btn-blue" onclick="loadAgentsProfitReport()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn-green" onclick="exportAgentsProfitToExcel()">üì• Excel</button>
      </div>
    </div>
    <div class="table-container" id="agentsProfitReportContent">
      <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>
  
  <!-- ============ –ü–ê–ù–ï–õ–¨ –†–ê–°–•–û–î–û–í ============ -->
  <div id="expensesPanel" class="panel">
    <div class="filters-panel">
      <!-- –ì–ª–∞–≤–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å -->
      <div style="background:linear-gradient(135deg,#dc3545,#c82333);color:white;padding:20px;border-radius:12px;margin-bottom:15px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-size:14px;opacity:0.9;">üìä –ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨ –ó–ê –ü–ï–†–ò–û–î</div>
          <div style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 10px;border-radius:20px;" id="expensesPeriodDates">üìÖ –í—Å–µ –≤—Ä–µ–º—è</div>
        </div>
        <div style="font-size:36px;font-weight:800;margin:8px 0;" id="expensesNetProfit">0 —Å–æ–º</div>
        <div style="font-size:13px;opacity:0.8;" id="expensesNetInfo">–ü—Ä–∏–±—ã–ª—å –æ—Ç –ø—Ä–æ–¥–∞–∂ –º–∏–Ω—É—Å –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
      </div>
      
      <div class="stats-row">
        <div class="stat-card" style="border-left:4px solid #dc3545;">
          <div class="label">üí∏ –í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
          <div class="value red" id="totalExpenses">0 —Å–æ–º</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #28a745;">
          <div class="label">üí∞ –í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å</div>
          <div class="value green" id="expensesPeriodProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #9c27b0;">
          <div class="label">ü§ù –ö–æ–º–∏—Å—Å–∏–∏ –∞–≥–µ–Ω—Ç–∞–º</div>
          <div class="value purple" id="expensesAgentCommission">0 —Å–æ–º</div>
        </div>
        <div class="stat-card" style="border-left:4px solid #007bff;">
          <div class="label">üìã –ö–æ–ª-–≤–æ —Ä–∞—Å—Ö–æ–¥–æ–≤</div>
          <div class="value blue" id="expensesCount">0</div>
        </div>
      </div>
      
      <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
      <h3 style="margin:15px 0 10px;color:#333;">üìä –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
      <div id="expensesCategoryChart" style="background:white;border-radius:12px;padding:15px;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-bottom:15px;">
        –ó–∞–≥—Ä—É–∑–∫–∞...
      </div>
      
      <div class="controls-row">
        <select id="expenseDateFilter" onchange="loadExpensesReport()">
          <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="yesterday">–í—á–µ—Ä–∞</option>
          <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
          <option value="last30days">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
          <optgroup label="üìÖ –ü–æ –º–µ—Å—è—Ü–∞–º" id="expenseMonthOptionsGroup"></optgroup>
        </select>
        <select id="expenseCategoryFilter" onchange="loadExpensesReport()">
          <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
          <option value="–∞—Ä–µ–Ω–¥–∞">üè† –ê—Ä–µ–Ω–¥–∞</option>
          <option value="–∑–∞—Ä–ø–ª–∞—Ç–∞">üíµ –ó–∞—Ä–ø–ª–∞—Ç–∞</option>
          <option value="—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç">üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
          <option value="—Ä–µ–∫–ª–∞–º–∞">üì¢ –†–µ–∫–ª–∞–º–∞</option>
          <option value="–∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ">üí° –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ</option>
          <option value="–ø—Ä–æ—á–µ–µ">üì¶ –ü—Ä–æ—á–µ–µ</option>
        </select>
        <button class="btn-blue" onclick="loadExpensesReport()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn-primary" onclick="openAddExpenseModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
        <button class="btn-green" onclick="exportExpensesToExcel()">üì• Excel</button>
        <button class="btn-blue" onclick="showRecurringExpenses()" style="background:#17a2b8;">üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ</button>
        <button class="btn-red" onclick="deleteAllExpensesForPeriod()" style="background:#dc3545;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
        <button class="btn-red" onclick="stopAllRecurringExpenses()" style="background:#e83e8c;">‚èπÔ∏è –°—Ç–æ–ø —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ</button>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>–î–∞—Ç–∞</th>
            <th>üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th>üí∏ –û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th class="right">üí∞ –°—É–º–º–∞</th>
            <th class="center">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="expensesReportBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ -->
<div id="addExpenseModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h2>
      <button class="back-btn" onclick="closeAddExpenseModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select id="expenseCategory">
          <option value="–ø—Ä–æ—á–µ–µ">üì¶ –ü—Ä–æ—á–µ–µ</option>
          <option value="–∞—Ä–µ–Ω–¥–∞">üè† –ê—Ä–µ–Ω–¥–∞</option>
          <option value="–∑–∞—Ä–ø–ª–∞—Ç–∞">üíµ –ó–∞—Ä–ø–ª–∞—Ç–∞</option>
          <option value="—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç">üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç / –ë–µ–Ω–∑–∏–Ω</option>
          <option value="—Ä–µ–∫–ª–∞–º–∞">üì¢ –†–µ–∫–ª–∞–º–∞</option>
          <option value="–∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ">üí° –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</option>
          <option value="–∑–∞–∫—É–ø–∫–∞">üì¶ –ó–∞–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞</option>
          <option value="—Ä–µ–º–æ–Ω—Ç">üîß –†–µ–º–æ–Ω—Ç</option>
          <option value="—Å–≤—è–∑—å">üì± –°–≤—è–∑—å / –ò–Ω—Ç–µ—Ä–Ω–µ—Ç</option>
          <option value="–Ω–∞–ª–æ–≥–∏">üìã –ù–∞–ª–æ–≥–∏</option>
        </select>
      </div>
      <div class="form-group">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞:</label>
        <input type="text" id="expenseDescription" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê—Ä–µ–Ω–¥–∞ —Å–∫–ª–∞–¥–∞ –∑–∞ —Ñ–µ–≤—Ä–∞–ª—å">
      </div>
      <div class="form-group">
        <label>–°—É–º–º–∞ (—Å–æ–º):</label>
        <input type="number" id="expenseAmount" placeholder="0" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
        <input type="date" id="expenseDate">
      </div>
      
      <!-- –†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ -->
      <div class="form-group" style="background:#f8f9fa;padding:15px;border-radius:8px;margin-top:10px;">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;margin-bottom:0;">
          <input type="checkbox" id="expenseIsRecurring" onchange="toggleRecurringOptions()" style="width:20px;height:20px;">
          <span>üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ (–∫–∞–∂–¥—ã–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å)</span>
        </label>
        
        <div id="recurringOptions" style="display:none;margin-top:15px;">
          <p style="font-size:13px;color:#666;margin-bottom:10px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏:</p>
          <div style="display:flex;flex-wrap:wrap;gap:8px;">
            <label style="display:flex;align-items:center;gap:5px;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #ddd;cursor:pointer;">
              <input type="checkbox" class="recurringDay" value="1"> –ü–Ω
            </label>
            <label style="display:flex;align-items:center;gap:5px;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #ddd;cursor:pointer;">
              <input type="checkbox" class="recurringDay" value="2"> –í—Ç
            </label>
            <label style="display:flex;align-items:center;gap:5px;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #ddd;cursor:pointer;">
              <input type="checkbox" class="recurringDay" value="3"> –°—Ä
            </label>
            <label style="display:flex;align-items:center;gap:5px;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #ddd;cursor:pointer;">
              <input type="checkbox" class="recurringDay" value="4"> –ß—Ç
            </label>
            <label style="display:flex;align-items:center;gap:5px;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #ddd;cursor:pointer;">
              <input type="checkbox" class="recurringDay" value="5"> –ü—Ç
            </label>
            <label style="display:flex;align-items:center;gap:5px;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #ddd;cursor:pointer;">
              <input type="checkbox" class="recurringDay" value="6"> –°–±
            </label>
            <label style="display:flex;align-items:center;gap:5px;background:#fff;padding:8px 12px;border-radius:6px;border:1px solid #ddd;cursor:pointer;">
              <input type="checkbox" class="recurringDay" value="0"> –í—Å
            </label>
          </div>
          <button type="button" onclick="selectAllDays()" style="margin-top:10px;padding:8px 16px;background:#17a2b8;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –¥–Ω–∏</button>
          <p style="font-size:12px;color:#28a745;margin-top:10px;background:#e8f5e9;padding:8px;border-radius:4px;">üí° –†–∞—Å—Ö–æ–¥ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏</p>
        </div>
      </div>
      
      <button class="btn-red" onclick="saveExpense()" style="width:100%; padding:14px; font-size:16px; font-weight:600; margin-top:15px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
    </div>
  </div>
</div>

<!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
<nav class="bottom-nav">
  <a href="index.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    <span>–ì–ª–∞–≤–Ω–∞—è</span>
  </a>
  <a href="admin-products.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    <span>–¢–æ–≤–∞—Ä—ã</span>
  </a>
  <a href="admin-orders.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
    <span>–ó–∞–∫–∞–∑—ã</span>
  </a>
  <a href="admin-profit.html" class="nav-item active">
    <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
    <span>–ü—Ä–∏–±—ã–ª—å</span>
  </a>
  <a href="profile.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm0 2c-2.7 0-8 1.3-8 4v2h16v-2c0-2.7-5.3-4-8-4z"/></svg>
    <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
  </a>
</nav>

<script>
// Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (svoysayet - —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–µ–∫—Ç)
const firebaseConfig = {
  apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
  authDomain: "svoysayet.firebaseapp.com",
  projectId: "svoysayet",
  storageBucket: "svoysayet.firebasestorage.app",
  messagingSenderId: "450143000217",
  appId: "1:450143000217:web:7495cefaea0b94966e8a08",
  measurementId: "G-Y8VG9E29FY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è timestamp
function normalizeEpochMs(value, fallbackMs = Date.now()) {
  if (value === undefined || value === null || value === '') return fallbackMs;

  let ms = null;

  if (typeof value === 'number') {
    ms = value;
  } else if (typeof value === 'string') {
    const asNum = Number(value);
    if (Number.isFinite(asNum)) {
      ms = asNum;
    } else {
      const parsed = Date.parse(value);
      if (Number.isFinite(parsed)) ms = parsed;
    }
  } else if (typeof value === 'object') {
    try {
      if (typeof value.toMillis === 'function') {
        ms = value.toMillis();
      } else if (typeof value.toDate === 'function') {
        ms = value.toDate().getTime();
      } else if (typeof value.seconds === 'number') {
        ms = value.seconds * 1000;
      }
    } catch (e) {
      ms = null;
    }
  }

  if (!Number.isFinite(ms)) return fallbackMs;

  // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ —Å–µ–∫—É–Ω–¥—ã, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
  if (ms > 0 && ms < 100_000_000_000) {
    ms = ms * 1000;
  }

  return ms;
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let products = [];
let currentTab = 'products';
let userRole = localStorage.getItem('userRole') || 'admin';

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async function() {
  console.log('üìà –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç—á—ë—Ç–∞ –ø–æ –ø—Ä–∏–±—ã–ª–∏...');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  document.getElementById('profitReportBody').innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#999;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
    await loadProducts();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    loadCategories();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
    loadProfitReport();
    
    console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
    document.getElementById('profitReportBody').innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#dc3545;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</td></tr>';
  }
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
async function loadProducts() {
  try {
    const snapshot = await db.collection('products').get();
    products = [];
    snapshot.forEach(doc => {
      products.push({ id: doc.id, ...doc.data() });
    });
    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', products.length);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Ñ–∏–ª—å—Ç—Ä
function loadCategories() {
  const categories = [...new Set(products.map(p => p.category).filter(c => c))];
  const select = document.getElementById('profitCategoryFilter');
  categories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function switchTab(tab) {
  currentTab = tab;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
  document.querySelectorAll('.profit-tabs button').forEach(btn => btn.classList.remove('active'));
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –ø–∞–Ω–µ–ª—å
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById(tab + 'Panel').classList.add('active');
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
  if (tab === 'dashboard') loadDashboard();
  else if (tab === 'products') loadProfitReport();
  else if (tab === 'orders') loadOrderProfitReport();
  else if (tab === 'agents') loadAgentsProfitReport();
  else if (tab === 'expenses') loadExpensesReport();
}

// ============ –ê–ù–ê–õ–ò–¢–ò–ö–ê (DASHBOARD) ============

// –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
const MONTH_NAMES_RU = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ü–∏–π –º–µ—Å—è—Ü–µ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä–µ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è)
function initMonthOptionsFor(optgroupId) {
  const optgroup = document.getElementById(optgroupId);
  if (!optgroup || optgroup.children.length > 0) return;
  
  const now = new Date();
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 12 –º–µ—Å—è—Ü–µ–≤
  for (let i = 0; i < 12; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const value = `month_${d.getFullYear()}_${String(d.getMonth() + 1).padStart(2, '0')}`;
    const label = `${MONTH_NAMES_RU[d.getMonth()]} ${d.getFullYear()}`;
    const option = document.createElement('option');
    option.value = value;
    option.textContent = label;
    optgroup.appendChild(option);
  }
}

// –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
function initMonthOptions() {
  initMonthOptionsFor('monthOptionsGroup');
}

// –ü–∞—Ä—Å–∏–Ω–≥ –ø–µ—Ä–∏–æ–¥–∞ –º–µ—Å—è—Ü–∞ (month_2026_01 -> {year: 2026, month: 0})
function parseMonthPeriod(period) {
  if (!period.startsWith('month_')) return null;
  const parts = period.split('_');
  if (parts.length !== 3) return null;
  return { year: parseInt(parts[1]), month: parseInt(parts[2]) - 1 };
}

async function loadDashboard() {
  console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞...');
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –º–µ—Å—è—Ü–µ–≤
  initMonthOptions();
  
  const period = document.getElementById('dashboardDateFilter').value;
  
  // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
  const now = Date.now();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayStart = today.getTime();
  const yesterdayStart = todayStart - 86400000;
  const weekStart = todayStart - 7 * 86400000;
  const last30daysStart = todayStart - 30 * 86400000;
  
  // –ì—Ä–∞–Ω–∏—Ü—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω)
  let selectedMonthStart = 0;
  let selectedMonthEnd = 0;
  const monthPeriod = parseMonthPeriod(period);
  if (monthPeriod) {
    const monthDate = new Date(monthPeriod.year, monthPeriod.month, 1);
    monthDate.setHours(0, 0, 0, 0);
    selectedMonthStart = monthDate.getTime();
    const nextMonth = new Date(monthPeriod.year, monthPeriod.month + 1, 1);
    nextMonth.setHours(0, 0, 0, 0);
    selectedMonthEnd = nextMonth.getTime();
  }
  
  // –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É
  function filterByPeriod(timestamp) {
    if (monthPeriod) {
      return timestamp >= selectedMonthStart && timestamp < selectedMonthEnd;
    }
    switch(period) {
      case 'today': return timestamp >= todayStart;
      case 'yesterday': return timestamp >= yesterdayStart && timestamp < todayStart;
      case 'week': return timestamp >= weekStart;
      case 'last30days': return timestamp >= last30daysStart;
      case 'all': return true;
      default: return true;
    }
  }
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
    const ordersSnapshot = await db.collection('orders').get();
    let allOrders = [];
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      allOrders.push({
        id: doc.id,
        ...data,
        timestamp: normalizeEpochMs(data.timestamp, Date.now())
      });
    });
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–µ—Ä–∏–æ–¥—É
    const orders = allOrders.filter(o => filterByPeriod(o.timestamp));
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã (–≤–∫–ª—é—á–∞—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ)
    const expensesSnapshot = await db.collection('expenses').get();
    let expensesForPeriod = [];
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–µ—Ä–∏–æ–¥–∞ –≤ Date
    let periodStartDate;
    if (monthPeriod) {
      periodStartDate = new Date(selectedMonthStart);
    } else {
      periodStartDate = new Date(period === 'today' ? todayStart : 
                                       period === 'yesterday' ? yesterdayStart :
                                       period === 'week' ? weekStart :
                                       period === 'last30days' ? last30daysStart : 0);
    }
    let periodEndDate = new Date(Date.now() + 86400000);
    if (period === 'yesterday') {
      periodEndDate.setTime(todayStart);
    }
    if (monthPeriod) {
      periodEndDate = new Date(selectedMonthEnd);
    }
    
    expensesSnapshot.forEach(doc => {
      const data = doc.data();
      
      if (data.isRecurring === true && data.recurringDays && data.recurringDays.length > 0 && data.isActive !== false) {
        // –†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –≤ –ø–µ—Ä–∏–æ–¥–µ
        const recurringStartDate = data.timestamp ? new Date(data.timestamp) : new Date(data.date || 0);
        recurringStartDate.setHours(0, 0, 0, 0); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        
        // –î–ª—è "–≤—Å–µ –≤—Ä–µ–º—è" –Ω–∞—á–∏–Ω–∞–µ–º —Å –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞, –∞ –Ω–µ —Å 1970
        let loopStart = new Date(Math.max(periodStartDate.getTime(), recurringStartDate.getTime()));
        loopStart.setHours(0, 0, 0, 0);
        
        // –í–ê–ñ–ù–û: –ù–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –±—É–¥—É—â–∏–µ –¥–Ω–∏!
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º –¥–Ω—ë–º
        const todayEndLimit = new Date();
        todayEndLimit.setHours(23, 59, 59, 999);
        const effectiveEndDate = new Date(Math.min(periodEndDate.getTime(), todayEndLimit.getTime()));
        
        while (loopStart <= effectiveEndDate) {
          const dayOfWeek = loopStart.getDay();
          if (data.recurringDays.includes(dayOfWeek)) {
            expensesForPeriod.push({
              id: doc.id + '_' + loopStart.getTime(),
              ...data,
              timestamp: loopStart.getTime()
            });
          }
          loopStart.setDate(loopStart.getDate() + 1);
        }
      } else if (!data.isRecurring) {
        // –û–±—ã—á–Ω—ã–π —Ä–∞—Å—Ö–æ–¥
        const ts = normalizeEpochMs(data.timestamp, normalizeEpochMs(data.createdAt, Date.now()));
        if (filterByPeriod(ts)) {
          expensesForPeriod.push({ id: doc.id, ...data, timestamp: ts });
        }
      }
    });
    const expenses = expensesForPeriod;
    
    // –û—Ç–ª–∞–¥–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤
    console.log('üìä [DASHBOARD] –†–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞–π–¥–µ–Ω–æ:', expenses.length);
    console.log('üìä [DASHBOARD] –ü–µ—Ä–∏–æ–¥:', periodStartDate, '-', periodEndDate);
    const dashTotalExp = expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
    console.log('üìä [DASHBOARD] –°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤:', dashTotalExp);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –≤ –∫–∞—Ä—Ç—É
    const productsMap = new Map();
    products.forEach(p => {
      productsMap.set(p.id, {
        name: p.name || p.title || '–¢–æ–≤–∞—Ä',
        costPrice: parseFloat(p.costPrice) || 0,
        salePrice: parseFloat(p.price) || 0,
        category: p.category || '–≤—Å–µ'
      });
    });
    
    // === –†–ê–°–ß–Å–¢ –ì–õ–ê–í–ù–´–• –ü–û–ö–ê–ó–ê–¢–ï–õ–ï–ô ===
    let totalRevenue = 0;
    let grossProfit = 0;
    let productsSold = 0;
    let productProfits = new Map(); // –î–ª—è –¢–û–ü —Ç–æ–≤–∞—Ä–æ–≤
    let itemsWithCostPrice = 0; // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
    let itemsWithoutCostPrice = 0; // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤
    const agentStats = new Map();
    let agentOrders = 0;
    let agentProfit = 0;
    let agentCommission = 0;
    
    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã
    const uniqueClients = new Set();
    
    orders.forEach(order => {
      const items = order.items || order.cart || order.products || [];
      let orderRevenue = 0;
      let orderProfitFromItems = 0; // –ü—Ä–∏–±—ã–ª—å —Ç–æ–ª—å–∫–æ –æ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –∏–∑–≤–µ—Å—Ç–Ω–æ–π —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å—é
      
      // –û–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –≤ –∑–∞–∫–∞–∑–µ)
      const orderTotal = parseFloat(order.total) || parseFloat(order.totalAmount) || parseFloat(order.amount) || parseFloat(order.sum) || 0;
      
      if (items.length > 0) {
        items.forEach(item => {
          const qty = parseInt(item.qty) || parseInt(item.quantity) || 1;
          const price = parseFloat(item.price) || parseFloat(item.salePrice) || parseFloat(item.cost) || 0;
          const productData = productsMap.get(item.id);
          
          // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º costPrice –≤ —Å–∞–º–æ–º item (–≤ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞), –ø–æ—Ç–æ–º –≤ productsMap
          const itemCostPrice = parseFloat(item.costPrice) || 0;
          const productCostPrice = productData ? productData.costPrice : 0;
          const costPrice = itemCostPrice > 0 ? itemCostPrice : productCostPrice;
          
          const productName = productData ? productData.name : (item.name || item.title || '–¢–æ–≤–∞—Ä');
          
          orderRevenue += price * qty;
          productsSold += qty;
          
          // –ü—Ä–∏–±—ã–ª—å: –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞ - —Å—á–∏—Ç–∞–µ–º, –∏–Ω–∞—á–µ 0
          const hasCostPrice = costPrice > 0;
          const itemProfit = hasCostPrice ? (price - costPrice) * qty : 0;
          
          // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
          if (hasCostPrice) {
            itemsWithCostPrice++;
          } else {
            itemsWithoutCostPrice++;
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–±—ã–ª—å —Ç–æ–ª—å–∫–æ –æ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –∏–∑–≤–µ—Å—Ç–Ω–æ–π —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å—é
          orderProfitFromItems += itemProfit;
          
          // –î–ª—è –¢–û–ü —Ç–æ–≤–∞—Ä–æ–≤ - –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ—Ö, –Ω–æ –ø—Ä–∏–±—ã–ª—å 0 –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–∫—É–ø–æ—á–Ω–æ–π —Ü–µ–Ω—ã
          if (productProfits.has(item.id)) {
            const existing = productProfits.get(item.id);
            productProfits.set(item.id, {
              name: productName,
              profit: existing.profit + itemProfit,
              qty: existing.qty + qty,
              hasCostPrice: existing.hasCostPrice || hasCostPrice
            });
          } else {
            productProfits.set(item.id, { name: productName, profit: itemProfit, qty: qty, hasCostPrice: hasCostPrice });
          }
        });
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å orderTotal –∏ –æ–Ω –±–æ–ª—å—à–µ –ø–æ—Å—á–∏—Ç–∞–Ω–Ω–æ–≥–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º orderTotal –∫–∞–∫ –≤—ã—Ä—É—á–∫—É
        // (–∑–Ω–∞—á–∏—Ç –≤ items —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ —Å —Ü–µ–Ω–∞–º–∏)
        if (orderTotal > 0 && orderTotal > orderRevenue) {
          orderRevenue = orderTotal;
        }
      } else if (orderTotal > 0) {
        // –ï—Å–ª–∏ –Ω–µ—Ç items, –Ω–æ –µ—Å—Ç—å –æ–±—â–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –≤—ã—Ä—É—á–∫–∏
        orderRevenue = orderTotal;
      }
      
      // –í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å = —Å—É–º–º–∞ –ø—Ä–∏–±—ã–ª–∏ –¢–û–õ–¨–ö–û –æ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –∏–∑–≤–µ—Å—Ç–Ω–æ–π —Ü–µ–Ω–æ–π –ø—Ä–∏—Ö–æ–¥–∞
      totalRevenue += orderRevenue;
      grossProfit += orderProfitFromItems;
      
      // –ö–ª–∏–µ–Ω—Ç
      if (order.phone || order.clientId) {
        uniqueClients.add(order.phone || order.clientId);
      }
      
      // –ê–≥–µ–Ω—Ç
      if (order.agentId || order.referrer || order.partner || order.referredBy) {
        agentOrders++;
        const agentId = order.agentId || order.referrer || order.partner || order.referredBy;
        const commission = orderRevenue * 0.02; // 2%
        
        agentProfit += orderProfitFromItems;
        agentCommission += commission;
        
        if (agentStats.has(agentId)) {
          const stat = agentStats.get(agentId);
          stat.orders++;
          stat.revenue += orderRevenue;
          stat.profit += orderProfitFromItems;
          stat.commission += commission;
        } else {
          agentStats.set(agentId, {
            id: agentId,
            name: order.agentName || order.partnerName || agentId,
            orders: 1,
            revenue: orderRevenue,
            profit: orderProfitFromItems,
            commission: commission
          });
        }
      }
    });
    
    // –†–∞—Å—Ö–æ–¥—ã
    let totalExpenses = 0;
    const expenseGroups = new Map();
    expenses.forEach(exp => {
      totalExpenses += parseFloat(exp.amount) || 0;
      
      // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é
      const desc = exp.description || '–ü—Ä–æ—á–µ–µ';
      if (expenseGroups.has(desc)) {
        expenseGroups.set(desc, expenseGroups.get(desc) + (parseFloat(exp.amount) || 0));
      } else {
        expenseGroups.set(desc, parseFloat(exp.amount) || 0);
      }
    });
    
    // –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å
    const netProfit = grossProfit - totalExpenses - agentCommission;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –ø–µ—Ä–∏–æ–¥–∞
    const formatDate = (d) => new Date(d).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
    let periodText = 'üìÖ –í—Å–µ –≤—Ä–µ–º—è';
    if (monthPeriod) {
      periodText = `üìÖ ${MONTH_NAMES_RU[monthPeriod.month]} ${monthPeriod.year}`;
    } else if (period === 'today') {
      periodText = `üìÖ –°–µ–≥–æ–¥–Ω—è: ${formatDate(todayStart)}`;
    } else if (period === 'yesterday') {
      periodText = `üìÖ –í—á–µ—Ä–∞: ${formatDate(yesterdayStart)}`;
    } else if (period === 'week') {
      periodText = `üìÖ ${formatDate(weekStart)} ‚Äî ${formatDate(Date.now())}`;
    } else if (period === 'last30days') {
      periodText = `üìÖ ${formatDate(last30daysStart)} ‚Äî ${formatDate(Date.now())}`;
    } else if (period === 'all' && orders.length > 0) {
      // –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é –¥–∞—Ç—É –∑–∞–∫–∞–∑–∞
      const earliestOrder = orders.reduce((min, o) => o.timestamp < min ? o.timestamp : min, orders[0].timestamp);
      periodText = `üìÖ –° ${formatDate(earliestOrder)} ‚Äî ${formatDate(Date.now())}`;
    }
    
    // === –û–ë–ù–û–í–õ–Ø–ï–ú UI ===
    document.getElementById('dashPeriodDates').textContent = periodText;
    document.getElementById('dashNetProfit').textContent = netProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('dashNetProfitInfo').textContent = 
      `${grossProfit.toFixed(0)} (–ø—Ä–∏–±—ã–ª—å) - ${totalExpenses.toFixed(0)} (—Ä–∞—Å—Ö–æ–¥—ã) - ${agentCommission.toFixed(0)} (–∫–æ–º–∏—Å—Å–∏–∏)`;
    
    document.getElementById('dashTotalRevenue').textContent = totalRevenue.toFixed(2) + ' —Å–æ–º';
    document.getElementById('dashGrossProfit').textContent = grossProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('dashTotalExpenses').textContent = totalExpenses.toFixed(2) + ' —Å–æ–º';
    document.getElementById('dashAgentCommission').textContent = agentCommission.toFixed(2) + ' —Å–æ–º';
    
    document.getElementById('dashOrdersCount').textContent = orders.length;
    document.getElementById('dashClientsCount').textContent = uniqueClients.size;
    document.getElementById('dashProductsSold').textContent = productsSold;
    document.getElementById('dashAvgCheck').textContent = orders.length > 0 ? 
      (totalRevenue / orders.length).toFixed(2) + ' —Å–æ–º' : '0 —Å–æ–º';
    
    document.getElementById('dashActiveAgents').textContent = agentStats.size;
    document.getElementById('dashAgentOrders').textContent = agentOrders;
    document.getElementById('dashAgentProfit').textContent = agentProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('dashAgentShare').textContent = orders.length > 0 ? 
      ((agentOrders / orders.length) * 100).toFixed(1) + '%' : '0%';
    
    // –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤
    let expensesHtml = '';
    if (expenseGroups.size > 0) {
      const sortedExpenses = [...expenseGroups.entries()].sort((a, b) => b[1] - a[1]);
      expensesHtml = sortedExpenses.map(([desc, amount]) => `
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
          <span>${desc}</span>
          <span style="color:#dc3545;font-weight:600;">-${amount.toFixed(2)} —Å–æ–º</span>
        </div>
      `).join('');
    } else {
      expensesHtml = '<div style="color:#999;text-align:center;padding:20px;">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>';
    }
    document.getElementById('dashExpensesList').innerHTML = expensesHtml;
    
    // –¢–û–ü-5 —Ç–æ–≤–∞—Ä–æ–≤ (—Ç–æ–≤–∞—Ä—ã –±–µ–∑ –∑–∞–∫—É–ø–æ—á–Ω–æ–π —Ü–µ–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å –ø—Ä–∏–±—ã–ª—å—é 0)
    const topProducts = [...productProfits.values()]
      .sort((a, b) => b.profit - a.profit)
      .slice(0, 5);
    
    let topProductsHtml = '';
    if (topProducts.length > 0) {
      topProductsHtml = topProducts.map((p, i) => {
        const profitColor = p.hasCostPrice ? '#28a745' : '#999';
        const profitText = p.hasCostPrice ? `+${p.profit.toFixed(2)} —Å–æ–º` : '0 (–Ω–µ—Ç –ø—Ä–∏—Ö–æ–¥–∞)';
        return `
          <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;align-items:center;">
            <div>
              <span style="display:inline-block;width:24px;height:24px;background:#${['28a745','20c997','17a2b8','6c757d','adb5bd'][i]};color:white;border-radius:50%;text-align:center;line-height:24px;font-size:12px;margin-right:10px;">${i + 1}</span>
              <span style="font-weight:600;">${p.name}</span>
              <span style="color:#666;font-size:12px;margin-left:8px;">(${p.qty} —à—Ç)</span>
            </div>
            <span style="color:${profitColor};font-weight:700;">${profitText}</span>
          </div>
        `;
      }).join('');
    } else {
      topProductsHtml = '<div style="color:#999;text-align:center;padding:20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    }
    document.getElementById('dashTopProducts').innerHTML = topProductsHtml;
    
    // –¢–û–ü-5 –∞–≥–µ–Ω—Ç–æ–≤
    const topAgents = [...agentStats.values()]
      .sort((a, b) => b.profit - a.profit)
      .slice(0, 5);
    
    let topAgentsHtml = '';
    if (topAgents.length > 0) {
      topAgentsHtml = topAgents.map((a, i) => `
        <div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;align-items:center;flex-wrap:wrap;gap:8px;">
          <div>
            <span style="display:inline-block;width:24px;height:24px;background:#${['9c27b0','7b1fa2','6a1b9a','4a148c','311b92'][i]};color:white;border-radius:50%;text-align:center;line-height:24px;font-size:12px;margin-right:10px;">${i + 1}</span>
            <span style="font-weight:600;">${a.name}</span>
            <span style="color:#666;font-size:12px;margin-left:8px;">(${a.orders} –∑–∞–∫–∞–∑–æ–≤)</span>
          </div>
          <div style="text-align:right;">
            <div style="color:#28a745;font-weight:700;">+${a.profit.toFixed(2)} —Å–æ–º</div>
            <div style="color:#dc3545;font-size:12px;">–ö–æ–º–∏—Å—Å–∏—è: ${a.commission.toFixed(2)}</div>
          </div>
        </div>
      `).join('');
    } else {
      topAgentsHtml = '<div style="color:#999;text-align:center;padding:20px;">–ù–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>';
    }
    document.getElementById('dashTopAgents').innerHTML = topAgentsHtml;
    
    console.log('üìä –û–¢–õ–ê–î–ö–ê –ê–ù–ê–õ–ò–¢–ò–ö–ò:');
    console.log('  –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤:', orders.length);
    console.log('  –¢–æ–≤–∞—Ä–æ–≤ —Å —Ü–µ–Ω–æ–π –ø—Ä–∏—Ö–æ–¥–∞:', itemsWithCostPrice);
    console.log('  –¢–æ–≤–∞—Ä–æ–≤ –ë–ï–ó —Ü–µ–Ω—ã –ø—Ä–∏—Ö–æ–¥–∞:', itemsWithoutCostPrice);
    console.log('  –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ (–æ–±–æ—Ä–æ—Ç):', totalRevenue);
    console.log('  –í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å:', grossProfit);
    console.log('  –¢–æ–≤–∞—Ä–æ–≤ –≤ productsMap:', productsMap.size);
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–µ 3 –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    orders.slice(0, 3).forEach((order, i) => {
      console.log(`  –ó–∞–∫–∞–∑ ${i+1}: total=${order.total}, amount=${order.amount}, items=${(order.items||order.cart||[]).length}`);
    });
    
    console.log('‚úÖ –î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–µ–Ω');
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'error');
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–∞—à–±–æ—Ä–¥–∞ –≤ Excel
async function exportDashboardToExcel() {
  const period = document.getElementById('dashboardDateFilter').value;
  const periodNames = {
    'today': '–°–µ–≥–æ–¥–Ω—è',
    'yesterday': '–í—á–µ—Ä–∞',
    'week': '–ó–∞_–Ω–µ–¥–µ–ª—é',
    'month': '–ó–∞_–º–µ—Å—è—Ü',
    'all': '–í—Å—ë_–≤—Ä–µ–º—è'
  };
  
  const wb = XLSX.utils.book_new();
  
  // –°–≤–æ–¥–∫–∞
  const summaryData = [
    ['–ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–Å–¢'],
    ['–ü–µ—Ä–∏–æ–¥:', periodNames[period]],
    ['–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è:', new Date().toLocaleString('ru-RU')],
    [''],
    ['–û–°–ù–û–í–ù–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò'],
    ['–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:', document.getElementById('dashNetProfit').textContent],
    ['–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞:', document.getElementById('dashTotalRevenue').textContent],
    ['–í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å:', document.getElementById('dashGrossProfit').textContent],
    ['–†–∞—Å—Ö–æ–¥—ã:', document.getElementById('dashTotalExpenses').textContent],
    ['–ö–æ–º–∏—Å—Å–∏–∏ –∞–≥–µ–Ω—Ç–∞–º:', document.getElementById('dashAgentCommission').textContent],
    [''],
    ['–ó–ê–ö–ê–ó–´ –ò –ö–õ–ò–ï–ù–¢–´'],
    ['–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤:', document.getElementById('dashOrdersCount').textContent],
    ['–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤:', document.getElementById('dashClientsCount').textContent],
    ['–¢–æ–≤–∞—Ä–æ–≤ –ø—Ä–æ–¥–∞–Ω–æ:', document.getElementById('dashProductsSold').textContent],
    ['–°—Ä–µ–¥–Ω–∏–π —á–µ–∫:', document.getElementById('dashAvgCheck').textContent],
    [''],
    ['–ê–ì–ï–ù–¢–´'],
    ['–ê–∫—Ç–∏–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤:', document.getElementById('dashActiveAgents').textContent],
    ['–ó–∞–∫–∞–∑–æ–≤ –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤:', document.getElementById('dashAgentOrders').textContent],
    ['–ü—Ä–∏–±—ã–ª—å –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤:', document.getElementById('dashAgentProfit').textContent],
    ['–î–æ–ª—è –∞–≥–µ–Ω—Ç–æ–≤:', document.getElementById('dashAgentShare').textContent]
  ];
  
  const ws = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, ws, '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞');
  
  const filename = `–ê–Ω–∞–ª–∏—Ç–∏–∫–∞_${periodNames[period]}_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, filename);
  
  Swal.fire('–£—Å–ø–µ—Ö', '–û—Ç—á—ë—Ç —Å–∫–∞—á–∞–Ω!', 'success');
}

// ============ –û–¢–ß–Å–¢ –ü–û –¢–û–í–ê–†–ê–ú ============
function loadProfitReport() {
  let filtered = [...products];
  
  // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é –ø—Ä–∏–±—ã–ª—å –∏ —Å—Ä–µ–¥–Ω—é—é –Ω–∞—Ü–µ–Ω–∫—É
  let totalProfit = 0;
  let totalMarkup = 0;
  let count = 0;
  
  filtered.forEach(p => {
    const salePrice = parseFloat(p.price) || 0;
    const costPrice = parseFloat(p.costPrice) || 0;
    if (costPrice > 0 && salePrice > 0) {
      const profit = salePrice - costPrice;
      const markup = (profit / costPrice) * 100;
      totalProfit += profit;
      totalMarkup += markup;
      count++;
    }
  });
  
  const avgMarkup = count > 0 ? (totalMarkup / count).toFixed(1) : 0;
  
  document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' —Å–æ–º';
  document.getElementById('avgMarkup').textContent = avgMarkup + '%';
  document.getElementById('totalProducts').textContent = filtered.length;
  
  filterProfitReport();
}

function filterProfitReport() {
  const category = document.getElementById('profitCategoryFilter').value;
  const sortBy = document.getElementById('profitSortFilter').value;
  
  let filtered = [...products];
  
  if (category) {
    filtered = filtered.filter(p => p.category === category);
  }
  
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
  filtered.sort((a, b) => {
    const profitA = (parseFloat(a.price) || 0) - (parseFloat(a.costPrice) || 0);
    const profitB = (parseFloat(b.price) || 0) - (parseFloat(b.costPrice) || 0);
    const markupA = a.costPrice > 0 ? (profitA / a.costPrice) * 100 : 0;
    const markupB = b.costPrice > 0 ? (profitB / b.costPrice) * 100 : 0;
    
    switch(sortBy) {
      case 'profit-desc': return profitB - profitA;
      case 'profit-asc': return profitA - profitB;
      case 'markup-desc': return markupB - markupA;
      case 'markup-asc': return markupA - markupB;
      case 'name': return (a.title || '').localeCompare(b.title || '');
      default: return 0;
    }
  });
  
  const tbody = document.getElementById('profitReportBody');
  tbody.innerHTML = filtered.map((p, i) => {
    const salePrice = parseFloat(p.price) || 0;
    const costPrice = parseFloat(p.costPrice) || 0;
    const profit = salePrice - costPrice;
    const markup = costPrice > 0 ? ((profit / costPrice) * 100).toFixed(1) : 0;
    const profitColor = profit > 0 ? '#28a745' : profit < 0 ? '#dc3545' : '#6c757d';
    
    return `
      <tr>
        <td data-label="#">${i + 1}</td>
        <td class="product-name-cell">${p.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</td>
        <td data-label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" class="center">${p.category || '-'}</td>
        <td data-label="–ó–∞–∫—É–ø–∫–∞" class="right">${costPrice.toFixed(2)} —Å–æ–º</td>
        <td data-label="–ü—Ä–æ–¥–∞–∂–∞" class="right">${salePrice.toFixed(2)} —Å–æ–º</td>
        <td data-label="–ü—Ä–∏–±—ã–ª—å" class="right" style="color:${profitColor}; font-weight:600;">${profit.toFixed(2)} —Å–æ–º</td>
        <td data-label="–ù–∞—Ü–µ–Ω–∫–∞" class="right">${markup}%</td>
      </tr>
    `;
  }).join('');
}

// ============ –û–¢–ß–Å–¢ –ü–û –ó–ê–ö–ê–ó–ê–ú ============
async function loadOrderProfitReport() {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –º–µ—Å—è—Ü–µ–≤
  initMonthOptionsFor('orderMonthOptionsGroup');
  
  const dateFilter = document.getElementById('orderDateFilter').value;
  const sortBy = document.getElementById('orderSortFilter').value;
  
  const now = new Date();
  let startDate = new Date(0);
  let endDate = null; // –î–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –º–µ—Å—è—Ü–µ–≤
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü
  const monthPeriod = parseMonthPeriod(dateFilter);
  if (monthPeriod) {
    startDate = new Date(monthPeriod.year, monthPeriod.month, 1);
    endDate = new Date(monthPeriod.year, monthPeriod.month + 1, 1);
  } else {
    switch(dateFilter) {
      case 'today':
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        break;
      case 'yesterday':
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        break;
      case 'week':
        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        break;
      case 'last30days':
        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        break;
    }
  }
  
  try {
    const snapshot = await db.collection('orders').get();
    let orders = [];
    
    snapshot.forEach(doc => {
      const data = doc.data();
      const orderDate = data.timestamp ? new Date(data.timestamp) : new Date(data.date || 0);
      const inRange = orderDate >= startDate && (endDate === null || orderDate < endDate);
      if (inRange) {
        orders.push({ id: doc.id, ...data, orderDate });
      }
    });
    
    // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏–±—ã–ª—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞
    orders = orders.map(order => {
      let totalCost = 0;
      let totalSale = 0;
      let totalProfit = 0;
      let itemsWithoutCost = 0; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ –∑–∞–∫—É–ø–æ—á–Ω–æ–π —Ü–µ–Ω—ã
      const items = order.items || order.cart || [];
      
      items.forEach(item => {
        const qty = item.qty || item.quantity || 1;
        
        // –ò—â–µ–º costPrice: —Å–Ω–∞—á–∞–ª–∞ –≤ –∑–∞–∫–∞–∑–µ, –ø–æ—Ç–æ–º –≤ –±–∞–∑–µ —Ç–æ–≤–∞—Ä–æ–≤
        let costPrice = parseFloat(item.costPrice) || 0;
        if (costPrice === 0 && item.id) {
          const product = products.find(p => p.id === item.id);
          if (product && product.costPrice) {
            costPrice = parseFloat(product.costPrice) || 0;
          }
        }
        
        const salePrice = parseFloat(item.price) || 0;
        
        totalSale += salePrice * qty;
        
        if (costPrice > 0) {
          // –ï—Å—Ç—å –∑–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞ - —Å—á–∏—Ç–∞–µ–º –ø—Ä–∏–±—ã–ª—å
          totalCost += costPrice * qty;
          totalProfit += (salePrice - costPrice) * qty;
        } else {
          // –ù–µ—Ç –∑–∞–∫—É–ø–æ—á–Ω–æ–π —Ü–µ–Ω—ã - –ø—Ä–∏–±—ã–ª—å 0 –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
          itemsWithoutCost++;
        }
      });
      
      return { ...order, totalCost, totalSale, profit: totalProfit, itemCount: items.length, itemsWithoutCost };
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    orders.sort((a, b) => {
      switch(sortBy) {
        case 'profit-desc': return b.profit - a.profit;
        case 'date-desc': return b.orderDate - a.orderDate;
        case 'date-asc': return a.orderDate - b.orderDate;
        default: return 0;
      }
    });
    
    // –°–≤–æ–¥–∫–∞
    const totalProfit = orders.reduce((sum, o) => sum + o.profit, 0);
    const uniqueClients = [...new Set(orders.map(o => o.phone || o.name))].length;
    
    document.getElementById('totalOrderProfit').textContent = totalProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('totalOrdersCount').textContent = orders.length;
    document.getElementById('totalClientsCount').textContent = uniqueClients;
    
    // –¢–∞–±–ª–∏—Ü–∞
    const tbody = document.getElementById('orderProfitReportBody');
    tbody.innerHTML = orders.map((o, i) => {
      const profitColor = o.profit > 0 ? '#28a745' : o.profit < 0 ? '#dc3545' : '#6c757d';
      const dateStr = o.orderDate.toLocaleDateString('ru-RU');
      // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã –±–µ–∑ –∑–∞–∫—É–ø–æ—á–Ω–æ–π —Ü–µ–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
      const profitNote = o.itemsWithoutCost > 0 ? ` <span style="color:#999;font-size:11px;">(${o.itemsWithoutCost} –±–µ–∑ –∑–∞–∫—É–ø.)</span>` : '';
      
      return `
        <tr>
          <td data-label="#">${i + 1}</td>
          <td data-label="–î–∞—Ç–∞">${dateStr}</td>
          <td data-label="–ö–ª–∏–µ–Ω—Ç">${o.name || '–ê–Ω–æ–Ω–∏–º'}</td>
          <td data-label="–¢–æ–≤–∞—Ä–æ–≤" class="center">${o.itemCount}</td>
          <td data-label="–ó–∞–∫—É–ø–∫–∞" class="right">${o.totalCost.toFixed(2)} —Å–æ–º</td>
          <td data-label="–°—É–º–º–∞" class="right">${o.totalSale.toFixed(2)} —Å–æ–º</td>
          <td data-label="–ü—Ä–∏–±—ã–ª—å" class="right" style="color:${profitColor}; font-weight:600;">${o.profit.toFixed(2)} —Å–æ–º${profitNote}</td>
        </tr>
      `;
    }).join('');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
  }
}

// ============ –û–¢–ß–Å–¢ –ü–û –ê–ì–ï–ù–¢–ê–ú ============
async function loadAgentsProfitReport() {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –º–µ—Å—è—Ü–µ–≤
  initMonthOptionsFor('agentsMonthOptionsGroup');
  
  const dateFilter = document.getElementById('agentsDateFilter').value;
  const sortBy = document.getElementById('agentsSortFilter').value;
  
  const now = new Date();
  let startDate = new Date(0);
  let endDate = null; // –î–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –º–µ—Å—è—Ü–µ–≤
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü
  const monthPeriod = parseMonthPeriod(dateFilter);
  if (monthPeriod) {
    startDate = new Date(monthPeriod.year, monthPeriod.month, 1);
    endDate = new Date(monthPeriod.year, monthPeriod.month + 1, 1);
  } else {
    switch(dateFilter) {
      case 'today':
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        break;
      case 'yesterday':
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
        endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        break;
      case 'week':
        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        break;
      case 'last30days':
        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        break;
    }
  }
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≥–µ–Ω—Ç–æ–≤ –∏ –∑–∞–∫–∞–∑—ã
    const [agentsSnap, ordersSnap] = await Promise.all([
      db.collection('agents').get(),
      db.collection('orders').get()
    ]);
    
    // –°–æ–∑–¥–∞—ë–º —Å–ª–æ–≤–∞—Ä—å –∞–≥–µ–Ω—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏ –∏ id
    const agents = {};
    const agentsByName = {};
    
    agentsSnap.forEach(doc => {
      const data = doc.data();
      const agentName = data.name || data.phone || doc.id;
      agents[doc.id] = { id: doc.id, name: agentName, phone: data.phone, orders: 0, profit: 0, totalSale: 0 };
      // –¢–∞–∫–∂–µ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ partner
      agentsByName[agentName] = agents[doc.id];
      if (data.phone) agentsByName[data.phone] = agents[doc.id];
    });
    
    console.log('üë• –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞–≥–µ–Ω—Ç–æ–≤:', Object.keys(agents).length);
    console.log('üìã –°–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤:', Object.values(agents).map(a => a.name));
    console.log('üìã –ö–ª—é—á–∏ agentsByName:', Object.keys(agentsByName));
    
    let ordersWithPartner = 0;
    let ordersWithAgent = 0;
    let ordersSkippedByDate = 0;
    let ordersWithPartnerNotFound = [];
    let totalOrdersChecked = 0;
    
    ordersSnap.forEach(doc => {
      const data = doc.data();
      const orderDate = data.timestamp ? new Date(data.timestamp) : new Date(data.date || 0);
      
      totalOrdersChecked++;
      
      const outOfRange = orderDate < startDate || (endDate !== null && orderDate >= endDate);
      if (outOfRange) {
        ordersSkippedByDate++;
        return;
      }
      
      // –ò—â–µ–º –∞–≥–µ–Ω—Ç–∞ –ø–æ —Ä–∞–∑–Ω—ã–º –ø–æ–ª—è–º: partner, agentId, referredBy
      let agent = null;
      const partnerName = data.partner;
      const agentId = data.agentId || data.referredBy;
      
      // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã —Å partner –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –Ω–∞–π–¥–µ–Ω
      if (partnerName && !agentsByName[partnerName]) {
        if (!ordersWithPartnerNotFound.includes(partnerName)) {
          ordersWithPartnerNotFound.push(partnerName);
        }
      }
      
      // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ partner (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±)
      if (partnerName && agentsByName[partnerName]) {
        agent = agentsByName[partnerName];
        ordersWithPartner++;
      }
      // –ü–æ—Ç–æ–º –ø–æ agentId
      else if (agentId && agents[agentId]) {
        agent = agents[agentId];
        ordersWithAgent++;
      }
      
      if (agent) {
        agent.orders++;
        
        const items = data.items || data.cart || [];
        let orderProfit = 0;
        let orderSale = 0;
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º total –∑–∞–∫–∞–∑–∞ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ —Å—á–∏—Ç–∞–µ–º –ø–æ —Ç–æ–≤–∞—Ä–∞–º
        if (data.total && parseFloat(data.total) > 0) {
          orderSale = parseFloat(data.total);
        }
        
        items.forEach(item => {
          const qty = item.qty || item.quantity || 1;
          const salePrice = parseFloat(item.price) || 0;
          const costPrice = parseFloat(item.costPrice) || 0;
          
          // –ï—Å–ª–∏ total –Ω–µ –±—ã–ª–æ - —Å—á–∏—Ç–∞–µ–º –ø–æ —Ç–æ–≤–∞—Ä–∞–º
          if (!data.total) {
            orderSale += salePrice * qty;
          }
          if (costPrice > 0) {
            orderProfit += (salePrice - costPrice) * qty;
          }
        });
        
        agent.profit += orderProfit;
        agent.totalSale += orderSale;
      }
    });
    
    let agentsList = Object.values(agents).filter(a => a.orders > 0);
    
    console.log('üìä –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –≤ –±–∞–∑–µ:', totalOrdersChecked);
    console.log('üìÖ –ü—Ä–æ–ø—É—â–µ–Ω–æ –ø–æ –¥–∞—Ç–µ:', ordersSkippedByDate);
    console.log('üì¶ –ó–∞–∫–∞–∑–æ–≤ —Å partner (–Ω–∞–π–¥–µ–Ω –∞–≥–µ–Ω—Ç):', ordersWithPartner);
    console.log('üì¶ –ó–∞–∫–∞–∑–æ–≤ —Å agentId:', ordersWithAgent);
    console.log('‚ùå Partner –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–≥–µ–Ω—Ç–∞—Ö:', ordersWithPartnerNotFound);
    console.log('üìä –ê–≥–µ–Ω—Ç–æ–≤ —Å –∑–∞–∫–∞–∑–∞–º–∏:', agentsList.length);
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    agentsList.sort((a, b) => {
      switch(sortBy) {
        case 'orders-desc': return b.orders - a.orders;
        case 'sum-desc': return b.profit - a.profit;
        case 'commission-desc': return (b.profit * 0.02) - (a.profit * 0.02);
        case 'name': return (a.name || '').localeCompare(b.name || '');
        default: return 0;
      }
    });
    
    // –°–≤–æ–¥–∫–∞
    const totalProfit = agentsList.reduce((sum, a) => sum + a.profit, 0);
    const totalOrders = agentsList.reduce((sum, a) => sum + a.orders, 0);
    const totalSales = agentsList.reduce((sum, a) => sum + a.totalSale, 0);
    const totalCommission = totalSales * 0.02; // 2% –æ—Ç —Å—É–º–º—ã –ø—Ä–æ–¥–∞–∂
    const netProfit = totalProfit - totalCommission;
    
    document.getElementById('agentsTotalCount').textContent = agentsList.length;
    document.getElementById('agentsOrdersCount').textContent = totalOrders;
    document.getElementById('agentsTotalProfit').textContent = totalProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('agentsTotalCommission').textContent = totalCommission.toFixed(2) + ' —Å–æ–º';
    document.getElementById('agentsNetProfit').textContent = netProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('agentsTotalSales').textContent = totalSales.toFixed(2) + ' —Å–æ–º';
    document.getElementById('agentsAvgCheck').textContent = totalOrders > 0 ? (totalSales / totalOrders).toFixed(2) + ' —Å–æ–º' : '0 —Å–æ–º';
    document.getElementById('agentsAvgProfit').textContent = totalOrders > 0 ? (totalProfit / totalOrders).toFixed(2) + ' —Å–æ–º' : '0 —Å–æ–º';
    document.getElementById('agentsBestAgent').textContent = agentsList.length > 0 ? agentsList[0].name : '-';
    
    // –¢–∞–±–ª–∏—Ü–∞
    const container = document.getElementById('agentsProfitReportContent');
    
    if (agentsList.length === 0) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#999;">
          <div style="font-size:48px; margin-bottom:15px;">üë•</div>
          <div style="font-size:16px;">–ù–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤ —Å –∑–∞–∫–∞–∑–∞–º–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
        </div>
      `;
      return;
    }
    
    container.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>–ê–≥–µ–Ω—Ç</th>
            <th class="center">üì¶ –ó–∞–∫–∞–∑–æ–≤</th>
            <th class="right">üíµ –ü—Ä–æ–¥–∞–∂–∏</th>
            <th class="right">üí∞ –ü—Ä–∏–±—ã–ª—å</th>
            <th class="right">üí∏ –ö–æ–º–∏—Å—Å–∏—è (2%)</th>
          </tr>
        </thead>
        <tbody>
          ${agentsList.map((a, i) => `
            <tr>
              <td data-label="#">${i + 1}</td>
              <td data-label="–ê–≥–µ–Ω—Ç">${a.name}${a.phone ? '<br><small style="color:#999;">' + a.phone + '</small>' : ''}</td>
              <td data-label="–ó–∞–∫–∞–∑–æ–≤" class="center">${a.orders}</td>
              <td data-label="–ü—Ä–æ–¥–∞–∂–∏" class="right">${a.totalSale.toFixed(2)} —Å–æ–º</td>
              <td data-label="–ü—Ä–∏–±—ã–ª—å" class="right" style="color:#28a745; font-weight:600;">${a.profit.toFixed(2)} —Å–æ–º</td>
              <td data-label="–ö–æ–º–∏—Å—Å–∏—è" class="right" style="color:#dc3545; font-weight:600;">${(a.totalSale * 0.02).toFixed(2)} —Å–æ–º</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤:', error);
  }
}

// ============ –û–¢–ß–Å–¢ –ü–û –†–ê–°–•–û–î–ê–ú ============
async function loadExpensesReport() {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –º–µ—Å—è—Ü–µ–≤
  initMonthOptionsFor('expenseMonthOptionsGroup');
  
  const dateFilter = document.getElementById('expenseDateFilter').value;
  const categoryFilter = document.getElementById('expenseCategoryFilter') ? 
    document.getElementById('expenseCategoryFilter').value : '';
  
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // 00:00:00 —Å–µ–≥–æ–¥–Ω—è
  let startDate = new Date(0);
  let endDate = new Date(now.getTime() + 24 * 60 * 60 * 1000);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–Ω –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–µ—Å—è—Ü
  const monthPeriod = parseMonthPeriod(dateFilter);
  if (monthPeriod) {
    startDate = new Date(monthPeriod.year, monthPeriod.month, 1);
    endDate = new Date(monthPeriod.year, monthPeriod.month + 1, 1);
  } else {
    switch(dateFilter) {
      case 'today':
        startDate = new Date(today);
        break;
      case 'yesterday':
        startDate = new Date(today.getTime() - 86400000);
        endDate = new Date(today);
        break;
      case 'week':
        startDate = new Date(today.getTime() - 7 * 86400000);
        break;
      case 'last30days':
        startDate = new Date(today.getTime() - 30 * 86400000);
        break;
    }
  }
  
  console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤, –ø–µ—Ä–∏–æ–¥:', dateFilter);
  
  try {
    const [expensesSnap, ordersSnap] = await Promise.all([
      db.collection('expenses').get(),
      db.collection('orders').get()
    ]);
    
    console.log('üìä –í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ –±–∞–∑–µ:', expensesSnap.size);
    
    let expenses = [];
    let categoryTotals = {};
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞
    const addExpense = (expense) => {
      const category = expense.category || '–ø—Ä–æ—á–µ–µ';
      const amount = parseFloat(expense.amount) || 0;
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
      categoryTotals[category] = (categoryTotals[category] || 0) + amount;
      
      // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      if (!categoryFilter || category === categoryFilter) {
        expenses.push(expense);
      }
    };
    
    expensesSnap.forEach(doc => {
      const data = doc.data();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π –ª–∏ —ç—Ç–æ —Ä–∞—Å—Ö–æ–¥
      if (data.isRecurring === true && data.recurringDays && data.recurringDays.length > 0 && data.isActive !== false) {
        // –†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –≤ –ø–µ—Ä–∏–æ–¥–µ
        const recurringStartDate = data.timestamp ? new Date(data.timestamp) : new Date(data.date || 0);
        recurringStartDate.setHours(0, 0, 0, 0); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        
        // –í–ê–ñ–ù–û: –ù–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –±—É–¥—É—â–∏–µ –¥–Ω–∏!
        const todayEndLimit = new Date();
        todayEndLimit.setHours(23, 59, 59, 999);
        const effectiveEndDate = new Date(Math.min(endDate.getTime(), todayEndLimit.getTime()));
        
        // –ù–∞—á–∏–Ω–∞–µ–º —Å –º–∞–∫—Å–∏–º—É–º–∞: –ª–∏–±–æ –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞, –ª–∏–±–æ –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ (–∫–∞–∫ –≤ loadDashboard)
        let currentDate = new Date(Math.max(startDate.getTime(), recurringStartDate.getTime()));
        currentDate.setHours(0, 0, 0, 0);
        
        while (currentDate <= effectiveEndDate) {
          const dayOfWeek = currentDate.getDay(); // 0=–í—Å, 1=–ü–Ω, ... 6=–°–±
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥–∏—Ç –ª–∏ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–Ω–∏
          if (data.recurringDays.includes(dayOfWeek)) {
            addExpense({
              id: doc.id + '_' + currentDate.getTime(), // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏
              originalId: doc.id, // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π ID —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞
              ...data,
              expenseDate: new Date(currentDate),
              isVirtual: true, // –ü–æ–º–µ—Ç–∫–∞, —á—Ç–æ —ç—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å
              category: data.category || '–ø—Ä–æ—á–µ–µ'
            });
          }
          
          // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–Ω—é
          currentDate.setDate(currentDate.getDate() + 1);
        }
      } else if (!data.isRecurring) {
        // –û–±—ã—á–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ (–ù–ï —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π) - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ
        let expenseDate;
        if (data.timestamp) {
          expenseDate = new Date(data.timestamp);
        } else if (data.date) {
          expenseDate = new Date(data.date);
        } else if (data.createdAt) {
          expenseDate = new Date(data.createdAt);
        } else {
          expenseDate = new Date(0);
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ < endDate (–∫–∞–∫ –≤ loadDashboard)
        if (expenseDate >= startDate && expenseDate < endDate) {
          addExpense({ id: doc.id, ...data, expenseDate, category: data.category || '–ø—Ä–æ—á–µ–µ' });
        }
      }
      // –ï—Å–ª–∏ isRecurring=true –Ω–æ isActive=false - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥)
    });
    
    // –û—Ç–ª–∞–¥–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤
    const allExpensesSum = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
    console.log('üìä [EXPENSES] –†–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞–π–¥–µ–Ω–æ (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏):', Object.values(categoryTotals).length, '–∫–∞—Ç–µ–≥–æ—Ä–∏–π');
    console.log('üìä [EXPENSES] –ü–µ—Ä–∏–æ–¥:', startDate, '-', endDate);
    console.log('üìä [EXPENSES] –°—É–º–º–∞ –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤:', allExpensesSum);
    
    // –°—á–∏—Ç–∞–µ–º –ø—Ä–∏–±—ã–ª—å –∏ –∫–æ–º–∏—Å—Å–∏—é –∞–≥–µ–Ω—Ç–∞–º
    let periodProfit = 0;
    let agentCommission = 0;
    
    ordersSnap.forEach(doc => {
      const data = doc.data();
      const orderDate = data.timestamp ? new Date(data.timestamp) : new Date(data.date || 0);
      if (orderDate >= startDate && orderDate <= endDate) {
        const items = data.items || data.cart || [];
        let orderTotal = 0;
        
        items.forEach(item => {
          const qty = item.qty || item.quantity || 1;
          const sale = (parseFloat(item.price) || 0) * qty;
          orderTotal += sale;
          
          let costPrice = parseFloat(item.costPrice) || 0;
          if (costPrice === 0 && item.id) {
            const product = products.find(p => p.id === item.id);
            if (product && product.costPrice) {
              costPrice = parseFloat(product.costPrice) || 0;
            }
          }
          
          const cost = costPrice * qty;
          if (costPrice > 0) {
            periodProfit += sale - cost;
          }
        });
        
        // –ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç–∞–º 2%
        if (data.partner || data.agentId || data.referredBy) {
          agentCommission += orderTotal * 0.02;
        }
      }
    });
    
    const totalExpenses = expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
    const allExpenses = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
    const netProfit = periodProfit - allExpenses - agentCommission;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –ø–µ—Ä–∏–æ–¥–∞
    const formatDate = (d) => d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
    let periodText = 'üìÖ –í—Å–µ –≤—Ä–µ–º—è';
    if (dateFilter === 'today') {
      periodText = `üìÖ –°–µ–≥–æ–¥–Ω—è: ${formatDate(startDate)}`;
    } else if (dateFilter === 'yesterday') {
      periodText = `üìÖ –í—á–µ—Ä–∞: ${formatDate(startDate)}`;
    } else if (dateFilter === 'week') {
      periodText = `üìÖ ${formatDate(startDate)} ‚Äî ${formatDate(endDate)}`;
    } else if (dateFilter === 'month') {
      periodText = `üìÖ ${formatDate(startDate)} ‚Äî ${formatDate(endDate)}`;
    } else if (dateFilter === 'all' && expenses.length > 0) {
      // –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é –¥–∞—Ç—É —Ä–∞—Å—Ö–æ–¥–∞
      const earliestDate = expenses.reduce((min, e) => {
        return e.expenseDate < min ? e.expenseDate : min;
      }, expenses[0].expenseDate);
      periodText = `üìÖ –° ${formatDate(earliestDate)} ‚Äî ${formatDate(now)}`;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    document.getElementById('expensesPeriodDates').textContent = periodText;
    document.getElementById('totalExpenses').textContent = allExpenses.toFixed(2) + ' —Å–æ–º';
    document.getElementById('expensesPeriodProfit').textContent = periodProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('expensesAgentCommission').textContent = agentCommission.toFixed(2) + ' —Å–æ–º';
    document.getElementById('expensesCount').textContent = expenses.length;
    document.getElementById('expensesNetProfit').textContent = netProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('expensesNetProfit').parentElement.parentElement.style.background = 
      netProfit >= 0 ? 'linear-gradient(135deg,#28a745,#20c997)' : 'linear-gradient(135deg,#dc3545,#c82333)';
    document.getElementById('expensesNetInfo').textContent = 
      `${periodProfit.toFixed(0)} - ${allExpenses.toFixed(0)} (—Ä–∞—Å—Ö–æ–¥—ã) - ${agentCommission.toFixed(0)} (–∞–≥–µ–Ω—Ç—ã)`;
    
    // –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const categoryIcons = {
      '–∞—Ä–µ–Ω–¥–∞': 'üè†', '–∑–∞—Ä–ø–ª–∞—Ç–∞': 'üíµ', '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç': 'üöó', '—Ä–µ–∫–ª–∞–º–∞': 'üì¢',
      '–∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ': 'üí°', '–∑–∞–∫—É–ø–∫–∞': 'üì¶', '—Ä–µ–º–æ–Ω—Ç': 'üîß', '—Å–≤—è–∑—å': 'üì±',
      '–Ω–∞–ª–æ–≥–∏': 'üìã', '–ø—Ä–æ—á–µ–µ': 'üì¶'
    };
    
    const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
    const maxAmount = sortedCategories.length > 0 ? sortedCategories[0][1] : 1;
    
    let chartHtml = '';
    if (sortedCategories.length > 0) {
      chartHtml = sortedCategories.map(([cat, amount]) => {
        const percent = ((amount / allExpenses) * 100).toFixed(1);
        const barWidth = (amount / maxAmount) * 100;
        const icon = categoryIcons[cat] || 'üì¶';
        return `
          <div style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
              <span>${icon} ${cat.charAt(0).toUpperCase() + cat.slice(1)}</span>
              <span style="font-weight:600;color:#dc3545;">${amount.toFixed(2)} —Å–æ–º (${percent}%)</span>
            </div>
            <div style="background:#eee;border-radius:4px;height:20px;overflow:hidden;">
              <div style="background:linear-gradient(90deg,#dc3545,#ff6b6b);width:${barWidth}%;height:100%;border-radius:4px;"></div>
            </div>
          </div>
        `;
      }).join('');
    } else {
      chartHtml = '<div style="color:#999;text-align:center;padding:20px;">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>';
    }
    document.getElementById('expensesCategoryChart').innerHTML = chartHtml;
    
    // –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤
    expenses.sort((a, b) => b.expenseDate - a.expenseDate);
    
    const tbody = document.getElementById('expensesReportBody');
    tbody.innerHTML = expenses.map((e, i) => {
      const dateStr = e.expenseDate.toLocaleDateString('ru-RU');
      const icon = categoryIcons[e.category] || 'üì¶';
      const recurringBadge = e.isRecurring ? '<span style="background:#17a2b8;color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:5px;">üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–π</span>' : '';
      const deleteBtn = e.isVirtual 
        ? `<button onclick="deleteRecurringExpense('${e.originalId}')" class="btn-red" style="padding:6px 12px; font-size:12px;" title="–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥">üîÑüóëÔ∏è</button>`
        : `<button onclick="deleteExpense('${e.id}')" class="btn-red" style="padding:6px 12px; font-size:12px;">üóëÔ∏è</button>`;
      return `
        <tr${e.isVirtual ? ' style="background:#f0f8ff;"' : ''}>
          <td data-label="#">${i + 1}</td>
          <td data-label="–î–∞—Ç–∞">${dateStr}${recurringBadge}</td>
          <td data-label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è">${icon} ${e.category || '–ø—Ä–æ—á–µ–µ'}</td>
          <td data-label="–û–ø–∏—Å–∞–Ω–∏–µ">${e.description || '-'}</td>
          <td data-label="–°—É–º–º–∞" class="right" style="color:#dc3545; font-weight:600;">${(parseFloat(e.amount) || 0).toFixed(2)} —Å–æ–º</td>
          <td data-label="–î–µ–π—Å—Ç–≤–∏—è" class="center">
            ${deleteBtn}
          </td>
        </tr>
      `;
    }).join('');
    
    if (expenses.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#999;">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥</td></tr>';
    }
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤:', error);
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ Excel
async function exportExpensesToExcel() {
  const dateFilter = document.getElementById('expenseDateFilter').value;
  const periodNames = { 'today': '–°–µ–≥–æ–¥–Ω—è', 'yesterday': '–í—á–µ—Ä–∞', 'week': '–ó–∞_–Ω–µ–¥–µ–ª—é', 'month': '–ó–∞_–º–µ—Å—è—Ü', 'all': '–í—Å—ë_–≤—Ä–µ–º—è' };
  
  const rows = [];
  document.querySelectorAll('#expensesReportBody tr').forEach(tr => {
    const cells = tr.querySelectorAll('td');
    if (cells.length >= 5) {
      rows.push([
        cells[0].textContent,
        cells[1].textContent,
        cells[2].textContent,
        cells[3].textContent,
        cells[4].textContent
      ]);
    }
  });
  
  const wb = XLSX.utils.book_new();
  const wsData = [
    ['–û–¢–ß–Å–¢ –ü–û –†–ê–°–•–û–î–ê–ú'],
    ['–ü–µ—Ä–∏–æ–¥:', periodNames[dateFilter]],
    ['–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤:', document.getElementById('totalExpenses').textContent],
    ['–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å:', document.getElementById('expensesNetProfit').textContent],
    [''],
    ['#', '–î–∞—Ç–∞', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–û–ø–∏—Å–∞–Ω–∏–µ', '–°—É–º–º–∞'],
    ...rows
  ];
  
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, '–†–∞—Å—Ö–æ–¥—ã');
  
  XLSX.writeFile(wb, `–†–∞—Å—Ö–æ–¥—ã_${periodNames[dateFilter]}_${new Date().toISOString().slice(0,10)}.xlsx`);
  Swal.fire('–£—Å–ø–µ—Ö', '–û—Ç—á—ë—Ç —Å–∫–∞—á–∞–Ω!', 'success');
}

// ============ –§–£–ù–ö–¶–ò–ò –†–ê–°–•–û–î–û–í ============
function openAddExpenseModal() {
  document.getElementById('addExpenseModal').classList.add('active');
  document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('expenseDescription').value = '';
  document.getElementById('expenseAmount').value = '';
  document.getElementById('expenseCategory').value = '–ø—Ä–æ—á–µ–µ';
}

function closeAddExpenseModal() {
  document.getElementById('addExpenseModal').classList.remove('active');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–ø—Ü–∏–π –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞
function toggleRecurringOptions() {
  const isRecurring = document.getElementById('expenseIsRecurring').checked;
  document.getElementById('recurringOptions').style.display = isRecurring ? 'block' : 'none';
}

// –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –¥–Ω–∏
function selectAllDays() {
  document.querySelectorAll('.recurringDay').forEach(cb => cb.checked = true);
}

async function saveExpense() {
  const category = document.getElementById('expenseCategory').value;
  const description = document.getElementById('expenseDescription').value.trim();
  const amount = parseFloat(document.getElementById('expenseAmount').value);
  const date = document.getElementById('expenseDate').value;
  const isRecurring = document.getElementById('expenseIsRecurring').checked;
  
  // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–Ω–∏
  const recurringDays = [];
  document.querySelectorAll('.recurringDay:checked').forEach(cb => {
    recurringDays.push(parseInt(cb.value));
  });
  
  if (!description) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞', 'error');
    return;
  }
  
  if (!amount || amount <= 0) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
    return;
  }
  
  if (!date) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É', 'error');
    return;
  }
  
  if (isRecurring && recurringDays.length === 0) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞', 'error');
    return;
  }
  
  try {
    const expenseData = {
      category: category || '–ø—Ä–æ—á–µ–µ',
      description,
      amount,
      date,
      timestamp: new Date(date).getTime(),
      createdAt: Date.now(),
      isRecurring: isRecurring,
      recurringDays: isRecurring ? recurringDays : [],
      isActive: true // –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
    };
    
    await db.collection('expenses').add(expenseData);
    
    closeAddExpenseModal();
    
    if (isRecurring) {
      const daysNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      const selectedDaysText = recurringDays.map(d => daysNames[d]).join(', ');
      Swal.fire('–£—Å–ø–µ—Ö', `–†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!\n–ë—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è: ${selectedDaysText}`, 'success');
    } else {
      Swal.fire('–£—Å–ø–µ—Ö', '–†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
    }
    
    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
    document.getElementById('expenseIsRecurring').checked = false;
    document.querySelectorAll('.recurringDay').forEach(cb => cb.checked = false);
    document.getElementById('recurringOptions').style.display = 'none';
    
    loadExpensesReport();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥', 'error');
  }
}

async function deleteExpense(id) {
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    confirmButtonText: '–£–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (result.isConfirmed) {
    try {
      await db.collection('expenses').doc(id).delete();
      Swal.fire('–£–¥–∞–ª–µ–Ω–æ!', '', 'success');
      loadExpensesReport();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'error');
    }
  }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
async function deleteAllExpensesForPeriod() {
  const dateFilter = document.getElementById('expenseDateFilter').value;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–∏–æ–¥–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  let periodText = '–≤—Å–µ –≤—Ä–µ–º—è';
  const monthPeriod = parseMonthPeriod(dateFilter);
  if (monthPeriod) {
    periodText = `${MONTH_NAMES_RU[monthPeriod.month]} ${monthPeriod.year}`;
  } else {
    switch(dateFilter) {
      case 'today': periodText = '—Å–µ–≥–æ–¥–Ω—è'; break;
      case 'yesterday': periodText = '–≤—á–µ—Ä–∞'; break;
      case 'week': periodText = '–Ω–µ–¥–µ–ª—é'; break;
      case 'last30days': periodText = '–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π'; break;
    }
  }
  
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ä–∞—Å—Ö–æ–¥—ã?',
    html: `<p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å <b>–≤—Å–µ</b> —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ <b>${periodText}</b>?</p><p style="color:#dc3545;Õæ font-weight:bold;">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</p>`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å–µ',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const now = new Date();
    let startDate = new Date(0);
    let endDate = new Date(now.getTime() + 24 * 60 * 60 * 1000);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–µ—Ä–∏–æ–¥–∞
    if (monthPeriod) {
      startDate = new Date(monthPeriod.year, monthPeriod.month, 1);
      endDate = new Date(monthPeriod.year, monthPeriod.month + 1, 1);
    } else {
      switch(dateFilter) {
        case 'today':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          break;
        case 'yesterday':
          startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
          endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          break;
        case 'week':
          startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          break;
        case 'last30days':
          startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          break;
      }
    }
    
    const expensesSnap = await db.collection('expenses').get();
    const batch = db.batch();
    let deleteCount = 0;
    
    expensesSnap.forEach(doc => {
      const data = doc.data();
      
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã - –∏—Ö –Ω—É–∂–Ω–æ —É–¥–∞–ª—è—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
      if (data.isRecurring) return;
      
      const ts = data.timestamp || data.createdAt || 0;
      const expenseDate = new Date(ts);
      
      if (expenseDate >= startDate && expenseDate < endDate) {
        batch.delete(doc.ref);
        deleteCount++;
      }
    });
    
    if (deleteCount === 0) {
      Swal.fire('–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤', '–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'info');
      return;
    }
    
    await batch.commit();
    
    Swal.fire('–£–¥–∞–ª–µ–Ω–æ!', `–£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ —Ä–∞—Å—Ö–æ–¥–æ–≤: ${deleteCount}`, 'success');
    loadExpensesReport();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã: ' + error.message, 'error');
  }
}

// –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –í–°–ï —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
async function stopAllRecurringExpenses() {
  const result = await Swal.fire({
    title: '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –í–°–ï —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã?',
    html: `<p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</p>
           <p><b>–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</b> - —Ä–∞—Å—Ö–æ–¥—ã –ø–µ—Ä–µ—Å—Ç–∞–Ω—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ</p>
           <p><b>–£–¥–∞–ª–∏—Ç—å</b> - –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–∑—ã</p>`,
    icon: 'warning',
    showCancelButton: true,
    showDenyButton: true,
    confirmButtonColor: '#dc3545',
    denyButtonColor: '#ffc107',
    confirmButtonText: 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ',
    denyButtonText: '‚è∏Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (!result.isConfirmed && !result.isDenied) return;
  
  try {
    const expensesSnap = await db.collection('expenses').get();
    const batch = db.batch();
    let count = 0;
    
    expensesSnap.forEach(doc => {
      const data = doc.data();
      if (data.isRecurring) {
        if (result.isConfirmed) {
          // –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é
          batch.delete(doc.ref);
        } else {
          // –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
          batch.update(doc.ref, { isActive: false });
        }
        count++;
      }
    });
    
    if (count === 0) {
      Swal.fire('–ù–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤', '–ù–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏', 'info');
      return;
    }
    
    await batch.commit();
    
    const action = result.isConfirmed ? '—É–¥–∞–ª–µ–Ω–æ' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ';
    Swal.fire('–ì–æ—Ç–æ–≤–æ!', `–†–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ ${action}: ${count}`, 'success');
    loadExpensesReport();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: ' + error.message, 'error');
  }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞
async function deleteRecurringExpense(id) {
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥?',
    text: '–≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ä–∞—Å—Ö–æ–¥ –¥–ª—è –≤—Å–µ—Ö –¥–Ω–µ–π. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –¥–∞—Ç—ã, –≤—ã–±–µ—Ä–∏—Ç–µ "–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å".',
    icon: 'warning',
    showCancelButton: true,
    showDenyButton: true,
    confirmButtonColor: '#dc3545',
    denyButtonColor: '#ffc107',
    confirmButtonText: 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é',
    denyButtonText: '‚è∏Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (result.isConfirmed) {
    try {
      await db.collection('expenses').doc(id).delete();
      Swal.fire('–£–¥–∞–ª–µ–Ω–æ!', '–†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª—ë–Ω', 'success');
      loadExpensesReport();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'error');
    }
  } else if (result.isDenied) {
    try {
      await db.collection('expenses').doc(id).update({ isActive: false });
      Swal.fire('–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!', '–†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è', 'success');
      loadExpensesReport();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏:', error);
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å', 'error');
    }
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
async function showRecurringExpenses() {
  try {
    const snapshot = await db.collection('expenses').where('isRecurring', '==', true).get();
    
    if (snapshot.empty) {
      Swal.fire('–†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã', '–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤', 'info');
      return;
    }
    
    const daysNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
    const categoryIcons = {
      '–∞—Ä–µ–Ω–¥–∞': 'üè†', '–∑–∞—Ä–ø–ª–∞—Ç–∞': 'üíµ', '—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç': 'üöó', '—Ä–µ–∫–ª–∞–º–∞': 'üì¢',
      '–∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ': 'üí°', '–∑–∞–∫—É–ø–∫–∞': 'üì¶', '—Ä–µ–º–æ–Ω—Ç': 'üîß', '—Å–≤—è–∑—å': 'üì±',
      '–Ω–∞–ª–æ–≥–∏': 'üìã', '–ø—Ä–æ—á–µ–µ': 'üì¶'
    };
    
    let html = '<div style="max-height:400px;overflow-y:auto;">';
    
    snapshot.forEach(doc => {
      const data = doc.data();
      const icon = categoryIcons[data.category] || 'üì¶';
      const days = (data.recurringDays || []).map(d => daysNames[d]).join(', ');
      const status = data.isActive !== false ? 
        '<span style="color:#28a745;">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>' : 
        '<span style="color:#dc3545;">‚è∏Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</span>';
      const startDate = data.date || 'N/A';
      
      html += `
        <div style="background:white;border:1px solid #ddd;border-radius:10px;padding:15px;margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <strong>${icon} ${data.description}</strong>
            ${status}
          </div>
          <div style="font-size:13px;color:#666;margin-bottom:5px;">
            <span style="margin-right:15px;">üí∞ ${data.amount} —Å–æ–º</span>
            <span>üìÖ –ù–∞—á–∞–ª–æ: ${startDate}</span>
          </div>
          <div style="font-size:13px;color:#17a2b8;margin-bottom:10px;">
            üîÑ –î–Ω–∏: ${days}
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            ${data.isActive !== false ? 
              `<button onclick="deactivateRecurring('${doc.id}')" style="background:#ffc107;color:#333;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;font-size:12px;">‚è∏Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>` :
              `<button onclick="activateRecurring('${doc.id}')" style="background:#28a745;color:white;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;font-size:12px;">‚ñ∂Ô∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>`
            }
            <button onclick="deleteRecurringFromList('${doc.id}')" style="background:#dc3545;color:white;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;font-size:12px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    
    Swal.fire({
      title: 'üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã',
      html: html,
      width: 500,
      showCloseButton: true,
      showConfirmButton: false
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã', 'error');
  }
}

// –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥
async function activateRecurring(id) {
  try {
    await db.collection('expenses').doc(id).update({ isActive: true });
    Swal.close();
    Swal.fire('–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!', '–†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–µ–Ω', 'success');
    loadExpensesReport();
  } catch (error) {
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å', 'error');
  }
}

// –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥
async function deactivateRecurring(id) {
  try {
    await db.collection('expenses').doc(id).update({ isActive: false });
    Swal.close();
    Swal.fire('–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!', '–†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
    loadExpensesReport();
  } catch (error) {
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å', 'error');
  }
}

// –£–¥–∞–ª–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞
async function deleteRecurringFromList(id) {
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥?',
    text: '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    confirmButtonText: '–£–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (result.isConfirmed) {
    try {
      await db.collection('expenses').doc(id).delete();
      Swal.fire('–£–¥–∞–ª–µ–Ω–æ!', '', 'success').then(() => showRecurringExpenses());
      loadExpensesReport();
    } catch (error) {
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'error');
    }
  }
}

// ============ –≠–ö–°–ü–û–†–¢ –í EXCEL ============
function exportProfitToExcel() {
  const data = products.map(p => ({
    '–¢–æ–≤–∞—Ä': p.title,
    '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': p.category,
    '–ó–∞–∫—É–ø–∫–∞': parseFloat(p.costPrice) || 0,
    '–ü—Ä–æ–¥–∞–∂–∞': parseFloat(p.price) || 0,
    '–ü—Ä–∏–±—ã–ª—å': (parseFloat(p.price) || 0) - (parseFloat(p.costPrice) || 0)
  }));
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–∏–±—ã–ª—å –ø–æ —Ç–æ–≤–∞—Ä–∞–º');
  XLSX.writeFile(wb, 'profit_products.xlsx');
}

function exportOrderProfitToExcel() {
  Swal.fire('–≠–∫—Å–ø–æ—Ä—Ç', '–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∑–∞–∫–∞–∑–æ–≤', 'info');
}

function exportAgentsProfitToExcel() {
  Swal.fire('–≠–∫—Å–ø–æ—Ä—Ç', '–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∞–≥–µ–Ω—Ç–æ–≤', 'info');
}
</script>

</body>
</html>
