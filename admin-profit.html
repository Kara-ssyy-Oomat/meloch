<!DOCTYPE html>
<html lang="ru">
<head>
  <script>if(window.parent!==window)document.write('<style>.bottom-nav{display:none!important}body{padding-bottom:0!important}.main-container{height:100vh!important}</style>')</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–û—Ç—á–µ—Ç –ø–æ –ø—Ä–∏–±—ã–ª–∏ - –ö–µ—Ä–±–µ–Ω</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    input, textarea, select {
      font-family: inherit;
      font-size: 16px;
    }
    
    /* SweetAlert –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
    .swal2-container {
      z-index: 999999 !important;
    }
    
    /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #fff;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-around;
      z-index: 99999;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      color: #9e9e9e;
      text-decoration: none;
      position: relative;
    }
    .nav-item.active { color: #4CAF50; }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
    .nav-item span { font-size: 11px; }
    
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .main-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 56px);
      background: #fff;
    }
    
    /* –®–∞–ø–∫–∞ */
    .profit-header {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .profit-header h1 {
      margin: 0;
      font-size: 24px;
    }
    .profit-header p {
      margin: 5px 0 0;
      opacity: 0.9;
    }
    .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* –í–∫–ª–∞–¥–∫–∏ */
    .profit-tabs {
      display: flex;
      gap: 10px;
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    .profit-tabs button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    .profit-tabs button.active {
      background: linear-gradient(90deg, #28a745, #20c997);
      color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .profit-tabs button:not(.active) {
      background: #e9ecef;
      color: #333;
    }
    
    /* –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
    .filters-panel {
      padding: 15px;
      background: #f8f9fa;
      flex-shrink: 0;
    }
    
    /* –°–≤–æ–¥–∫–∞ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-card .label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
    }
    .stat-card .value.green { color: #28a745; }
    .stat-card .value.blue { color: #007bff; }
    .stat-card .value.gray { color: #6c757d; }
    .stat-card .value.red { color: #dc3545; }
    .stat-card .value.purple { color: #9c27b0; }
    
    /* –ö–æ–Ω—Ç—Ä–æ–ª—ã */
    .controls-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .controls-row select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      flex: 1;
      min-width: 150px;
    }
    .controls-row button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 500;
    }
    .btn-green { background: #28a745; color: white; }
    .btn-blue { background: #17a2b8; color: white; }
    .btn-primary { background: #007bff; color: white; }
    .btn-red { background: #dc3545; color: white; }
    
    /* –¢–∞–±–ª–∏—Ü–∞ */
    .table-container {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    thead tr {
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
    }
    th {
      padding: 12px;
      font-size: 13px;
      color: #666;
      text-align: left;
    }
    th.right { text-align: right; }
    th.center { text-align: center; }
    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    td.right { text-align: right; }
    td.center { text-align: center; }
    tbody tr:hover { background: #f8f9fa; }
    
    /* –°–∫—Ä—ã—Ç—ã–µ –ø–∞–Ω–µ–ª–∏ */
    .panel { display: none; }
    .panel.active { display: block; }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9700;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: white;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 { margin: 0; font-size: 22px; }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 600px) {
      .profit-header { padding: 14px; }
      .profit-header h1 { font-size: 18px; }
      .profit-tabs { gap: 6px; }
      .profit-tabs button { flex: 1 1 30%; padding: 10px 8px; font-size: 12px; }
      .stats-row { 
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 10px;
        padding-bottom: 8px;
      }
      .stat-card {
        flex: 0 0 auto;
        min-width: 120px;
        padding: 10px;
      }
      .stat-card .label { font-size: 10px; }
      .stat-card .value { font-size: 18px; }
      .controls-row {
        flex-direction: column;
        align-items: stretch;
      }
      .controls-row > * { width: 100%; }
      
      /* –ö–∞—Ä—Ç–æ—á–Ω—ã–π –≤–∏–¥ —Ç–∞–±–ª–∏—Ü */
      table, thead, tbody, th, tr, td { display: block; width: 100%; }
      thead { display: none; }
      tbody { display: flex; flex-direction: column; gap: 10px; }
      tr {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      }
      td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        text-align: right;
        font-size: 14px;
      }
      td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #555;
        text-align: left;
        flex-shrink: 0;
        font-size: 13px;
      }
      td.product-name-cell {
        display: block;
        text-align: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 16px;
        font-weight: 700;
        padding: 14px 10px;
      }
      td.product-name-cell::before { display: none; }
      td[data-label="#"] { display: none; }
    }
  </style>
</head>
<body>

<div class="main-container">
  <!-- –®–∞–ø–∫–∞ -->
  <div class="profit-header">
    <div>
      <h1>üí∞ –û—Ç—á–µ—Ç –ø–æ –ø—Ä–∏–±—ã–ª–∏</h1>
      <p>–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–æ–≤</p>
    </div>
    <button class="back-btn" onclick="window.location.href='profile.html'">‚Üê</button>
  </div>
  
  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <div class="profit-tabs">
    <button id="tabProducts" class="active" onclick="switchTab('products')">üì¶ –ü–æ —Ç–æ–≤–∞—Ä–∞–º</button>
    <button id="tabOrders" onclick="switchTab('orders')">üìã –ü–æ –∑–∞–∫–∞–∑–∞–º</button>
    <button id="tabAgents" onclick="switchTab('agents')">ü§ù –ê–≥–µ–Ω—Ç—ã</button>
    <button id="tabExpenses" onclick="switchTab('expenses')">üí∏ –†–∞—Å—Ö–æ–¥—ã</button>
  </div>
  
  <!-- ============ –ü–ê–ù–ï–õ–¨ –ü–û –¢–û–í–ê–†–ê–ú ============ -->
  <div id="productsPanel" class="panel active">
    <div class="filters-panel">
      <div class="stats-row">
        <div class="stat-card">
          <div class="label">üí∞ –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</div>
          <div class="value green" id="totalProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">üìä –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞</div>
          <div class="value blue" id="avgMarkup">0%</div>
        </div>
        <div class="stat-card">
          <div class="label">üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
          <div class="value gray" id="totalProducts">0</div>
        </div>
      </div>
      <div class="controls-row">
        <select id="profitCategoryFilter" onchange="filterProfitReport()">
          <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        </select>
        <select id="profitSortFilter" onchange="filterProfitReport()">
          <option value="profit-desc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üì)</option>
          <option value="profit-asc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üë)</option>
          <option value="markup-desc">–ü–æ –Ω–∞—Ü–µ–Ω–∫–µ (‚Üì)</option>
          <option value="markup-asc">–ü–æ –Ω–∞—Ü–µ–Ω–∫–µ (‚Üë)</option>
          <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
        </select>
        <button class="btn-green" onclick="exportProfitToExcel()">üì• Excel</button>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>–¢–æ–≤–∞—Ä</th>
            <th class="center">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
            <th class="right">üíµ –ó–∞–∫—É–ø–∫–∞</th>
            <th class="right">üí∞ –ü—Ä–æ–¥–∞–∂–∞</th>
            <th class="right">üìä –ü—Ä–∏–±—ã–ª—å</th>
            <th class="right">% –ù–∞—Ü–µ–Ω–∫–∞</th>
          </tr>
        </thead>
        <tbody id="profitReportBody"></tbody>
      </table>
    </div>
  </div>
  
  <!-- ============ –ü–ê–ù–ï–õ–¨ –ü–û –ó–ê–ö–ê–ó–ê–ú ============ -->
  <div id="ordersPanel" class="panel">
    <div class="filters-panel">
      <div class="stats-row">
        <div class="stat-card">
          <div class="label">üí∞ –ü—Ä–∏–±—ã–ª—å –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
          <div class="value green" id="totalOrderProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">üìã –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
          <div class="value blue" id="totalOrdersCount">0</div>
        </div>
        <div class="stat-card">
          <div class="label">üë• –ö–ª–∏–µ–Ω—Ç–æ–≤</div>
          <div class="value gray" id="totalClientsCount">0</div>
        </div>
      </div>
      <div class="controls-row">
        <select id="orderDateFilter" onchange="loadOrderProfitReport()">
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="yesterday">–í—á–µ—Ä–∞</option>
          <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
          <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
          <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
        </select>
        <select id="orderSortFilter" onchange="loadOrderProfitReport()">
          <option value="profit-desc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üì)</option>
          <option value="date-desc">–ü–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ)</option>
          <option value="date-asc">–ü–æ –¥–∞—Ç–µ (—Å—Ç–∞—Ä—ã–µ)</option>
        </select>
        <button class="btn-green" onclick="exportOrderProfitToExcel()">üì• Excel</button>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>–î–∞—Ç–∞</th>
            <th>üë§ –ö–ª–∏–µ–Ω—Ç</th>
            <th class="center">üì¶ –¢–æ–≤–∞—Ä–æ–≤</th>
            <th class="right">üíµ –ó–∞–∫—É–ø–∫–∞</th>
            <th class="right">üí∞ –°—É–º–º–∞</th>
            <th class="right">üìä –ü—Ä–∏–±—ã–ª—å</th>
          </tr>
        </thead>
        <tbody id="orderProfitReportBody"></tbody>
      </table>
    </div>
  </div>
  
  <!-- ============ –ü–ê–ù–ï–õ–¨ –ê–ì–ï–ù–¢–û–í ============ -->
  <div id="agentsPanel" class="panel">
    <div class="filters-panel">
      <div class="stats-row">
        <div class="stat-card">
          <div class="label">ü§ù –í—Å–µ–≥–æ –∞–≥–µ–Ω—Ç–æ–≤</div>
          <div class="value purple" id="agentsTotalCount">0</div>
        </div>
        <div class="stat-card">
          <div class="label">üì¶ –ó–∞–∫–∞–∑–æ–≤ –æ—Ç –∞–≥–µ–Ω—Ç–æ–≤</div>
          <div class="value blue" id="agentsOrdersCount">0</div>
        </div>
        <div class="stat-card">
          <div class="label">üí∞ –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
          <div class="value green" id="agentsTotalProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">üí∏ –ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç–∞–º (2%)</div>
          <div class="value red" id="agentsTotalCommission">0 —Å–æ–º</div>
        </div>
      </div>
      <div class="controls-row">
        <select id="agentsDateFilter" onchange="loadAgentsProfitReport()">
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="yesterday">–í—á–µ—Ä–∞</option>
          <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
          <option value="month" selected>–ó–∞ –º–µ—Å—è—Ü</option>
          <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
        </select>
        <select id="agentsSortFilter" onchange="loadAgentsProfitReport()">
          <option value="orders-desc">–ü–æ –∑–∞–∫–∞–∑–∞–º (‚Üì)</option>
          <option value="sum-desc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üì)</option>
          <option value="commission-desc">–ü–æ –∫–æ–º–∏—Å—Å–∏–∏ (‚Üì)</option>
          <option value="name">–ü–æ –∏–º–µ–Ω–∏</option>
        </select>
        <button class="btn-blue" onclick="loadAgentsProfitReport()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn-green" onclick="exportAgentsProfitToExcel()">üì• Excel</button>
      </div>
    </div>
    <div class="table-container" id="agentsProfitReportContent">
      <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>
  </div>
  
  <!-- ============ –ü–ê–ù–ï–õ–¨ –†–ê–°–•–û–î–û–í ============ -->
  <div id="expensesPanel" class="panel">
    <div class="filters-panel">
      <div class="stats-row">
        <div class="stat-card">
          <div class="label">üí∏ –†–∞—Å—Ö–æ–¥—ã –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
          <div class="value red" id="totalExpenses">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">üí∞ –ü—Ä–∏–±—ã–ª—å –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
          <div class="value green" id="expensesPeriodProfit">0 —Å–æ–º</div>
        </div>
        <div class="stat-card">
          <div class="label">üìä –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
          <div class="value blue" id="netProfit">0 —Å–æ–º</div>
        </div>
      </div>
      <div class="controls-row" style="flex-wrap:wrap;">
        <select id="expenseDateFilter" onchange="onExpenseDateFilterChange()">
          <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="yesterday">–í—á–µ—Ä–∞</option>
          <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
          <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
          <option value="custom">üìÖ –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—ã</option>
        </select>
        <button class="btn-blue" onclick="loadExpensesReport()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn-primary" onclick="openAddExpenseModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
        <button class="btn-red" onclick="deleteAllExpensesForPeriod()" style="font-size:12px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞ –ø–µ—Ä–∏–æ–¥</button>
      </div>
      <div id="customDateRange" style="display:none; padding:8px 0 0; width:100%; display:none; gap:8px; align-items:center; flex-wrap:wrap;">
        <label style="font-size:13px; color:#555;">–°:</label>
        <input type="date" id="expenseDateFrom" onchange="loadExpensesReport()" style="padding:8px 10px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
        <label style="font-size:13px; color:#555;">–ü–æ:</label>
        <input type="date" id="expenseDateTo" onchange="loadExpensesReport()" style="padding:8px 10px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
        <span id="customDateDaysCount" style="font-size:13px; color:#667eea; font-weight:600;"></span>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>–î–∞—Ç–∞</th>
            <th>üí∏ –û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th class="right">üí∞ –°—É–º–º–∞</th>
            <th class="center">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="expensesReportBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ -->
<div id="addExpenseModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h2>
      <button class="back-btn" onclick="closeAddExpenseModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞:</label>
        <input type="text" id="expenseDescription" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê—Ä–µ–Ω–¥–∞, –∑–∞—Ä–ø–ª–∞—Ç–∞, –±–µ–Ω–∑–∏–Ω">
      </div>
      <div class="form-group">
        <label>–°—É–º–º–∞ (—Å–æ–º):</label>
        <input type="number" id="expenseAmount" placeholder="0" min="0" step="0.01">
      </div>
      <div class="form-group">
        <label>–î–∞—Ç–∞:</label>
        <input type="date" id="expenseDate">
      </div>
      <div class="form-group">
        <label style="display:flex !important; align-items:center; gap:8px; cursor:pointer; margin-bottom:0;">
          <input type="checkbox" id="expenseFillRange" onchange="toggleFillRangeOptions()" style="width:auto; padding:0;">
          <span>üìÜ –î–æ–±–∞–≤–∏—Ç—å –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –¥–æ —Å–µ–≥–æ–¥–Ω—è</span>
        </label>
        <div id="fillRangeInfo" style="display:none; margin-top:8px; padding:10px; background:#fff3cd; border-radius:8px; font-size:13px; color:#856404;">
          üí° –†–∞—Å—Ö–æ–¥ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω <b>–Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</b> –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –¥–æ —Å–µ–≥–æ–¥–Ω—è.
          <div id="fillRangeDaysInfo" style="margin-top:6px; font-weight:600; color:#667eea;"></div>
        </div>
      </div>
      <div class="form-group">
        <label style="display:flex !important; align-items:center; gap:8px; cursor:pointer; margin-bottom:0;">
          <input type="checkbox" id="expenseIsRecurring" onchange="toggleRecurringOptions()" style="width:auto; padding:0;">
          <span>üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ (–ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏)</span>
        </label>
      </div>
      <div id="recurringOptions" style="display:none; padding:10px; background:#f0f4ff; border-radius:10px; margin-bottom:12px;">
        <p style="font-size:13px; color:#555; margin-bottom:8px;">–í—ã–±–µ—Ä–∏—Ç–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏:</p>
        <div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;">
          <label style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#fff; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-size:13px;">
            <input type="checkbox" class="recurringDay" value="1" onchange="updateFillRangeDaysInfo()"> –ü–Ω
          </label>
          <label style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#fff; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-size:13px;">
            <input type="checkbox" class="recurringDay" value="2" onchange="updateFillRangeDaysInfo()"> –í—Ç
          </label>
          <label style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#fff; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-size:13px;">
            <input type="checkbox" class="recurringDay" value="3" onchange="updateFillRangeDaysInfo()"> –°—Ä
          </label>
          <label style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#fff; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-size:13px;">
            <input type="checkbox" class="recurringDay" value="4" onchange="updateFillRangeDaysInfo()"> –ß—Ç
          </label>
          <label style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#fff; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-size:13px;">
            <input type="checkbox" class="recurringDay" value="5" onchange="updateFillRangeDaysInfo()"> –ü—Ç
          </label>
          <label style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#fff; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-size:13px;">
            <input type="checkbox" class="recurringDay" value="6" onchange="updateFillRangeDaysInfo()"> –°–±
          </label>
          <label style="display:flex; align-items:center; gap:4px; padding:6px 10px; background:#fff; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-size:13px;">
            <input type="checkbox" class="recurringDay" value="0" onchange="updateFillRangeDaysInfo()"> –í—Å
          </label>
        </div>
        <button type="button" onclick="document.querySelectorAll('.recurringDay').forEach(c=>c.checked=true); updateFillRangeDaysInfo()" style="padding:6px 12px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px;">‚úÖ –í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
      </div>
      <button class="btn-red" onclick="saveExpense()" style="width:100%; padding:14px; font-size:16px; font-weight:600;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
    </div>
  </div>
</div>

<!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
<nav class="bottom-nav">
  <a href="index.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    <span>–ì–ª–∞–≤–Ω–∞—è</span>
  </a>
  <a href="admin-products.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    <span>–¢–æ–≤–∞—Ä—ã</span>
  </a>
  <a href="admin-orders.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
    <span>–ó–∞–∫–∞–∑—ã</span>
  </a>
  <a href="admin-profit.html" class="nav-item active">
    <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
    <span>–ü—Ä–∏–±—ã–ª—å</span>
  </a>
  <a href="profile.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm0 2c-2.7 0-8 1.3-8 4v2h16v-2c0-2.7-5.3-4-8-4z"/></svg>
    <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
  </a>
</nav>

<script>
// Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (svoysayet - —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–µ–∫—Ç)
const firebaseConfig = {
  apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
  authDomain: "svoysayet.firebaseapp.com",
  projectId: "svoysayet",
  storageBucket: "svoysayet.firebasestorage.app",
  messagingSenderId: "450143000217",
  appId: "1:450143000217:web:7495cefaea0b94966e8a08",
  measurementId: "G-Y8VG9E29FY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let products = [];
let currentTab = 'products';
let userRole = localStorage.getItem('userRole') || 'admin';

// –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async function() {
  console.log('üìà –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç—á—ë—Ç–∞ –ø–æ –ø—Ä–∏–±—ã–ª–∏...');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  document.getElementById('profitReportBody').innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#999;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
    await loadProducts();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    loadCategories();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
    loadProfitReport();
    
    console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
    document.getElementById('profitReportBody').innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#dc3545;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message + '</td></tr>';
  }
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
async function loadProducts() {
  try {
    const snapshot = await db.collection('products').get();
    products = [];
    snapshot.forEach(doc => {
      products.push({ id: doc.id, ...doc.data() });
    });
    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:', products.length);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ —Ñ–∏–ª—å—Ç—Ä
function loadCategories() {
  const categories = [...new Set(products.map(p => p.category).filter(c => c))];
  const select = document.getElementById('profitCategoryFilter');
  categories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function switchTab(tab) {
  currentTab = tab;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
  document.querySelectorAll('.profit-tabs button').forEach(btn => btn.classList.remove('active'));
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –ø–∞–Ω–µ–ª—å
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById(tab + 'Panel').classList.add('active');
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
  if (tab === 'products') loadProfitReport();
  else if (tab === 'orders') loadOrderProfitReport();
  else if (tab === 'agents') loadAgentsProfitReport();
  else if (tab === 'expenses') loadExpensesReport();
}

// ============ –û–¢–ß–Å–¢ –ü–û –¢–û–í–ê–†–ê–ú ============
function loadProfitReport() {
  let filtered = [...products];
  
  // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é –ø—Ä–∏–±—ã–ª—å –∏ —Å—Ä–µ–¥–Ω—é—é –Ω–∞—Ü–µ–Ω–∫—É
  let totalProfit = 0;
  let totalMarkup = 0;
  let count = 0;
  
  filtered.forEach(p => {
    const salePrice = parseFloat(p.price) || 0;
    const costPrice = parseFloat(p.costPrice) || 0;
    if (costPrice > 0 && salePrice > 0) {
      const profit = salePrice - costPrice;
      const markup = (profit / costPrice) * 100;
      totalProfit += profit;
      totalMarkup += markup;
      count++;
    }
  });
  
  const avgMarkup = count > 0 ? (totalMarkup / count).toFixed(1) : 0;
  
  document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' —Å–æ–º';
  document.getElementById('avgMarkup').textContent = avgMarkup + '%';
  document.getElementById('totalProducts').textContent = filtered.length;
  
  filterProfitReport();
}

function filterProfitReport() {
  const category = document.getElementById('profitCategoryFilter').value;
  const sortBy = document.getElementById('profitSortFilter').value;
  
  let filtered = [...products];
  
  if (category) {
    filtered = filtered.filter(p => p.category === category);
  }
  
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
  filtered.sort((a, b) => {
    const profitA = (parseFloat(a.price) || 0) - (parseFloat(a.costPrice) || 0);
    const profitB = (parseFloat(b.price) || 0) - (parseFloat(b.costPrice) || 0);
    const markupA = a.costPrice > 0 ? (profitA / a.costPrice) * 100 : 0;
    const markupB = b.costPrice > 0 ? (profitB / b.costPrice) * 100 : 0;
    
    switch(sortBy) {
      case 'profit-desc': return profitB - profitA;
      case 'profit-asc': return profitA - profitB;
      case 'markup-desc': return markupB - markupA;
      case 'markup-asc': return markupA - markupB;
      case 'name': return (a.title || '').localeCompare(b.title || '');
      default: return 0;
    }
  });
  
  const tbody = document.getElementById('profitReportBody');
  tbody.innerHTML = filtered.map((p, i) => {
    const salePrice = parseFloat(p.price) || 0;
    const costPrice = parseFloat(p.costPrice) || 0;
    const profit = salePrice - costPrice;
    const markup = costPrice > 0 ? ((profit / costPrice) * 100).toFixed(1) : 0;
    const profitColor = profit > 0 ? '#28a745' : profit < 0 ? '#dc3545' : '#6c757d';
    
    return `
      <tr>
        <td data-label="#">${i + 1}</td>
        <td class="product-name-cell">${p.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</td>
        <td data-label="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" class="center">${p.category || '-'}</td>
        <td data-label="–ó–∞–∫—É–ø–∫–∞" class="right">${costPrice.toFixed(2)} —Å–æ–º</td>
        <td data-label="–ü—Ä–æ–¥–∞–∂–∞" class="right">${salePrice.toFixed(2)} —Å–æ–º</td>
        <td data-label="–ü—Ä–∏–±—ã–ª—å" class="right" style="color:${profitColor}; font-weight:600;">${profit.toFixed(2)} —Å–æ–º</td>
        <td data-label="–ù–∞—Ü–µ–Ω–∫–∞" class="right">${markup}%</td>
      </tr>
    `;
  }).join('');
}

// ============ –û–¢–ß–Å–¢ –ü–û –ó–ê–ö–ê–ó–ê–ú ============
async function loadOrderProfitReport() {
  const dateFilter = document.getElementById('orderDateFilter').value;
  const sortBy = document.getElementById('orderSortFilter').value;
  
  const now = new Date();
  let startDate = new Date(0);
  
  switch(dateFilter) {
    case 'today':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      break;
    case 'yesterday':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
      break;
    case 'week':
      startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      break;
    case 'month':
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      break;
  }
  
  try {
    const snapshot = await db.collection('orders').get();
    let orders = [];
    
    snapshot.forEach(doc => {
      const data = doc.data();
      const orderDate = data.timestamp ? new Date(data.timestamp) : new Date(data.date || 0);
      if (orderDate >= startDate) {
        orders.push({ id: doc.id, ...data, orderDate });
      }
    });
    
    // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏–±—ã–ª—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞
    orders = orders.map(order => {
      let totalCost = 0;
      let totalSale = 0;
      let totalProfit = 0;
      let itemsWithoutCost = 0; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ –∑–∞–∫—É–ø–æ—á–Ω–æ–π —Ü–µ–Ω—ã
      const items = order.items || order.cart || [];
      
      items.forEach(item => {
        const qty = item.qty || item.quantity || 1;
        
        // –ò—â–µ–º costPrice: —Å–Ω–∞—á–∞–ª–∞ –≤ –∑–∞–∫–∞–∑–µ, –ø–æ—Ç–æ–º –≤ –±–∞–∑–µ —Ç–æ–≤–∞—Ä–æ–≤
        let costPrice = parseFloat(item.costPrice) || 0;
        if (costPrice === 0 && item.id) {
          const product = products.find(p => p.id === item.id);
          if (product && product.costPrice) {
            costPrice = parseFloat(product.costPrice) || 0;
          }
        }
        
        const salePrice = parseFloat(item.price) || 0;
        
        totalSale += salePrice * qty;
        
        if (costPrice > 0) {
          // –ï—Å—Ç—å –∑–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞ - —Å—á–∏—Ç–∞–µ–º –ø—Ä–∏–±—ã–ª—å
          totalCost += costPrice * qty;
          totalProfit += (salePrice - costPrice) * qty;
        } else {
          // –ù–µ—Ç –∑–∞–∫—É–ø–æ—á–Ω–æ–π —Ü–µ–Ω—ã - –ø—Ä–∏–±—ã–ª—å 0 –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
          itemsWithoutCost++;
        }
      });
      
      return { ...order, totalCost, totalSale, profit: totalProfit, itemCount: items.length, itemsWithoutCost };
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    orders.sort((a, b) => {
      switch(sortBy) {
        case 'profit-desc': return b.profit - a.profit;
        case 'date-desc': return b.orderDate - a.orderDate;
        case 'date-asc': return a.orderDate - b.orderDate;
        default: return 0;
      }
    });
    
    // –°–≤–æ–¥–∫–∞
    const totalProfit = orders.reduce((sum, o) => sum + o.profit, 0);
    const uniqueClients = [...new Set(orders.map(o => o.phone || o.name))].length;
    
    document.getElementById('totalOrderProfit').textContent = totalProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('totalOrdersCount').textContent = orders.length;
    document.getElementById('totalClientsCount').textContent = uniqueClients;
    
    // –¢–∞–±–ª–∏—Ü–∞
    const tbody = document.getElementById('orderProfitReportBody');
    tbody.innerHTML = orders.map((o, i) => {
      const profitColor = o.profit > 0 ? '#28a745' : o.profit < 0 ? '#dc3545' : '#6c757d';
      const dateStr = o.orderDate.toLocaleDateString('ru-RU');
      // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–≤–∞—Ä—ã –±–µ–∑ –∑–∞–∫—É–ø–æ—á–Ω–æ–π —Ü–µ–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ
      const profitNote = o.itemsWithoutCost > 0 ? ` <span style="color:#999;font-size:11px;">(${o.itemsWithoutCost} –±–µ–∑ –∑–∞–∫—É–ø.)</span>` : '';
      
      return `
        <tr>
          <td data-label="#">${i + 1}</td>
          <td data-label="–î–∞—Ç–∞">${dateStr}</td>
          <td data-label="–ö–ª–∏–µ–Ω—Ç">${o.name || '–ê–Ω–æ–Ω–∏–º'}</td>
          <td data-label="–¢–æ–≤–∞—Ä–æ–≤" class="center">${o.itemCount}</td>
          <td data-label="–ó–∞–∫—É–ø–∫–∞" class="right">${o.totalCost.toFixed(2)} —Å–æ–º</td>
          <td data-label="–°—É–º–º–∞" class="right">${o.totalSale.toFixed(2)} —Å–æ–º</td>
          <td data-label="–ü—Ä–∏–±—ã–ª—å" class="right" style="color:${profitColor}; font-weight:600;">${o.profit.toFixed(2)} —Å–æ–º${profitNote}</td>
        </tr>
      `;
    }).join('');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
  }
}

// ============ –û–¢–ß–Å–¢ –ü–û –ê–ì–ï–ù–¢–ê–ú ============
async function loadAgentsProfitReport() {
  const dateFilter = document.getElementById('agentsDateFilter').value;
  const sortBy = document.getElementById('agentsSortFilter').value;
  
  const now = new Date();
  let startDate = new Date(0);
  
  switch(dateFilter) {
    case 'today':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      break;
    case 'yesterday':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
      break;
    case 'week':
      startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      break;
    case 'month':
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      break;
  }
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≥–µ–Ω—Ç–æ–≤ –∏ –∑–∞–∫–∞–∑—ã
    const [agentsSnap, ordersSnap] = await Promise.all([
      db.collection('agents').get(),
      db.collection('orders').get()
    ]);
    
    // –°–æ–∑–¥–∞—ë–º —Å–ª–æ–≤–∞—Ä—å –∞–≥–µ–Ω—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏ –∏ id
    const agents = {};
    const agentsByName = {};
    
    agentsSnap.forEach(doc => {
      const data = doc.data();
      const agentName = data.name || data.phone || doc.id;
      agents[doc.id] = { id: doc.id, name: agentName, phone: data.phone, orders: 0, profit: 0, totalSale: 0 };
      // –¢–∞–∫–∂–µ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ partner
      agentsByName[agentName] = agents[doc.id];
      if (data.phone) agentsByName[data.phone] = agents[doc.id];
    });
    
    console.log('üë• –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞–≥–µ–Ω—Ç–æ–≤:', Object.keys(agents).length);
    console.log('üìã –°–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤:', Object.values(agents).map(a => a.name));
    console.log('üìã –ö–ª—é—á–∏ agentsByName:', Object.keys(agentsByName));
    
    let ordersWithPartner = 0;
    let ordersWithAgent = 0;
    let ordersSkippedByDate = 0;
    let ordersWithPartnerNotFound = [];
    let totalOrdersChecked = 0;
    
    ordersSnap.forEach(doc => {
      const data = doc.data();
      const orderDate = data.timestamp ? new Date(data.timestamp) : new Date(data.date || 0);
      
      totalOrdersChecked++;
      
      if (orderDate < startDate) {
        ordersSkippedByDate++;
        return;
      }
      
      // –ò—â–µ–º –∞–≥–µ–Ω—Ç–∞ –ø–æ —Ä–∞–∑–Ω—ã–º –ø–æ–ª—è–º: partner, agentId, referredBy
      let agent = null;
      const partnerName = data.partner;
      const agentId = data.agentId || data.referredBy;
      
      // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã —Å partner –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –Ω–∞–π–¥–µ–Ω
      if (partnerName && !agentsByName[partnerName]) {
        if (!ordersWithPartnerNotFound.includes(partnerName)) {
          ordersWithPartnerNotFound.push(partnerName);
        }
      }
      
      // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ partner (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±)
      if (partnerName && agentsByName[partnerName]) {
        agent = agentsByName[partnerName];
        ordersWithPartner++;
      }
      // –ü–æ—Ç–æ–º –ø–æ agentId
      else if (agentId && agents[agentId]) {
        agent = agents[agentId];
        ordersWithAgent++;
      }
      
      if (agent) {
        agent.orders++;
        
        const items = data.items || data.cart || [];
        let orderProfit = 0;
        let orderSale = 0;
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º total –∑–∞–∫–∞–∑–∞ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ —Å—á–∏—Ç–∞–µ–º –ø–æ —Ç–æ–≤–∞—Ä–∞–º
        if (data.total && parseFloat(data.total) > 0) {
          orderSale = parseFloat(data.total);
        }
        
        items.forEach(item => {
          const qty = item.qty || item.quantity || 1;
          const salePrice = parseFloat(item.price) || 0;
          const costPrice = parseFloat(item.costPrice) || 0;
          
          // –ï—Å–ª–∏ total –Ω–µ –±—ã–ª–æ - —Å—á–∏—Ç–∞–µ–º –ø–æ —Ç–æ–≤–∞—Ä–∞–º
          if (!data.total) {
            orderSale += salePrice * qty;
          }
          if (costPrice > 0) {
            orderProfit += (salePrice - costPrice) * qty;
          }
        });
        
        agent.profit += orderProfit;
        agent.totalSale += orderSale;
      }
    });
    
    let agentsList = Object.values(agents).filter(a => a.orders > 0);
    
    console.log('üìä –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –≤ –±–∞–∑–µ:', totalOrdersChecked);
    console.log('üìÖ –ü—Ä–æ–ø—É—â–µ–Ω–æ –ø–æ –¥–∞—Ç–µ:', ordersSkippedByDate);
    console.log('üì¶ –ó–∞–∫–∞–∑–æ–≤ —Å partner (–Ω–∞–π–¥–µ–Ω –∞–≥–µ–Ω—Ç):', ordersWithPartner);
    console.log('üì¶ –ó–∞–∫–∞–∑–æ–≤ —Å agentId:', ordersWithAgent);
    console.log('‚ùå Partner –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–≥–µ–Ω—Ç–∞—Ö:', ordersWithPartnerNotFound);
    console.log('üìä –ê–≥–µ–Ω—Ç–æ–≤ —Å –∑–∞–∫–∞–∑–∞–º–∏:', agentsList.length);
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    agentsList.sort((a, b) => {
      switch(sortBy) {
        case 'orders-desc': return b.orders - a.orders;
        case 'sum-desc': return b.profit - a.profit;
        case 'commission-desc': return (b.profit * 0.02) - (a.profit * 0.02);
        case 'name': return (a.name || '').localeCompare(b.name || '');
        default: return 0;
      }
    });
    
    // –°–≤–æ–¥–∫–∞
    const totalProfit = agentsList.reduce((sum, a) => sum + a.profit, 0);
    const totalOrders = agentsList.reduce((sum, a) => sum + a.orders, 0);
    const totalSales = agentsList.reduce((sum, a) => sum + a.totalSale, 0);
    const totalCommission = totalSales * 0.02; // 2% –æ—Ç —Å—É–º–º—ã –ø—Ä–æ–¥–∞–∂
    
    document.getElementById('agentsTotalCount').textContent = agentsList.length;
    document.getElementById('agentsOrdersCount').textContent = totalOrders;
    document.getElementById('agentsTotalProfit').textContent = totalProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('agentsTotalCommission').textContent = totalCommission.toFixed(2) + ' —Å–æ–º';
    
    // –¢–∞–±–ª–∏—Ü–∞
    const container = document.getElementById('agentsProfitReportContent');
    
    if (agentsList.length === 0) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#999;">
          <div style="font-size:48px; margin-bottom:15px;">üë•</div>
          <div style="font-size:16px;">–ù–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤ —Å –∑–∞–∫–∞–∑–∞–º–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
        </div>
      `;
      return;
    }
    
    container.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>–ê–≥–µ–Ω—Ç</th>
            <th class="center">üì¶ –ó–∞–∫–∞–∑–æ–≤</th>
            <th class="right">üíµ –ü—Ä–æ–¥–∞–∂–∏</th>
            <th class="right">üí∞ –ü—Ä–∏–±—ã–ª—å</th>
            <th class="right">üí∏ –ö–æ–º–∏—Å—Å–∏—è (2%)</th>
          </tr>
        </thead>
        <tbody>
          ${agentsList.map((a, i) => `
            <tr>
              <td data-label="#">${i + 1}</td>
              <td data-label="–ê–≥–µ–Ω—Ç">${a.name}${a.phone ? '<br><small style="color:#999;">' + a.phone + '</small>' : ''}</td>
              <td data-label="–ó–∞–∫–∞–∑–æ–≤" class="center">${a.orders}</td>
              <td data-label="–ü—Ä–æ–¥–∞–∂–∏" class="right">${a.totalSale.toFixed(2)} —Å–æ–º</td>
              <td data-label="–ü—Ä–∏–±—ã–ª—å" class="right" style="color:#28a745; font-weight:600;">${a.profit.toFixed(2)} —Å–æ–º</td>
              <td data-label="–ö–æ–º–∏—Å—Å–∏—è" class="right" style="color:#dc3545; font-weight:600;">${(a.totalSale * 0.02).toFixed(2)} —Å–æ–º</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤:', error);
  }
}

// ============ –û–¢–ß–Å–¢ –ü–û –†–ê–°–•–û–î–ê–ú ============

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç
function onExpenseDateFilterChange() {
  const dateFilter = document.getElementById('expenseDateFilter').value;
  const customRange = document.getElementById('customDateRange');
  if (dateFilter === 'custom') {
    customRange.style.display = 'flex';
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –Ω–∞—á–∞–ª–æ –º–µ—Å—è—Ü–∞ ‚Äî —Å–µ–≥–æ–¥–Ω—è
    const now = new Date();
    const fromEl = document.getElementById('expenseDateFrom');
    const toEl = document.getElementById('expenseDateTo');
    if (!fromEl.value) {
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      fromEl.value = monthStart.toISOString().split('T')[0];
    }
    if (!toEl.value) {
      toEl.value = now.toISOString().split('T')[0];
    }
    updateCustomDaysCount();
  } else {
    customRange.style.display = 'none';
  }
  loadExpensesReport();
}

// –ü–æ–¥—Å—á—ë—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
function updateCustomDaysCount() {
  const fromEl = document.getElementById('expenseDateFrom');
  const toEl = document.getElementById('expenseDateTo');
  const countEl = document.getElementById('customDateDaysCount');
  if (fromEl.value && toEl.value) {
    const from = new Date(fromEl.value);
    const to = new Date(toEl.value);
    const diffMs = to.getTime() - from.getTime();
    const days = Math.round(diffMs / (24 * 60 * 60 * 1000)) + 1;
    if (days > 0) {
      countEl.textContent = `(${days} ${days === 1 ? '–¥–µ–Ω—å' : days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'})`;
    } else {
      countEl.textContent = '‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω';
    }
  } else {
    countEl.textContent = '';
  }
}

async function loadExpensesReport() {
  const dateFilter = document.getElementById('expenseDateFilter').value;
  
  const now = new Date();
  let startDate = new Date(0);
  let endDate = new Date(now.getTime() + 24 * 60 * 60 * 1000); // –ó–∞–≤—Ç—Ä–∞, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ
  
  switch(dateFilter) {
    case 'today':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      break;
    case 'yesterday':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      break;
    case 'week':
      startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      break;
    case 'month':
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      break;
    case 'custom':
      const fromVal = document.getElementById('expenseDateFrom').value;
      const toVal = document.getElementById('expenseDateTo').value;
      if (fromVal) startDate = new Date(fromVal);
      if (toVal) {
        endDate = new Date(toVal);
        endDate.setHours(23, 59, 59, 999); // –í–∫–ª—é—á–∞–µ–º –≤–µ—Å—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å
      }
      updateCustomDaysCount();
      break;
  }
  
  console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤, –ø–µ—Ä–∏–æ–¥:', dateFilter, '—Å', startDate, '–ø–æ', endDate);
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Ö–æ–¥—ã –∏ –∑–∞–∫–∞–∑—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–∏–±—ã–ª–∏
    const [expensesSnap, ordersSnap, agentExpensesSnap] = await Promise.all([
      db.collection('expenses').get(),
      db.collection('orders').get(),
      db.collection('agentExpenses').get()
    ]);
    
    console.log('üìã –í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ –±–∞–∑–µ:', expensesSnap.size);
    console.log('ü§ù –†–∞—Å—Ö–æ–¥–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ:', agentExpensesSnap.size);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 —Ä–∞—Å—Ö–æ–¥–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    let debugCount = 0;
    expensesSnap.forEach(doc => {
      if (debugCount < 3) {
        const data = doc.data();
        console.log('üîç –†–∞—Å—Ö–æ–¥:', { 
          id: doc.id, 
          timestamp: data.timestamp, 
          date: data.date,
          amount: data.amount,
          description: data.description 
        });
        debugCount++;
      }
    });
    
    let expenses = [];
    expensesSnap.forEach(doc => {
      const data = doc.data();
      // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç—ã
      let expenseDate;
      if (data.timestamp) {
        expenseDate = new Date(data.timestamp);
      } else if (data.date) {
        // –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞ "2026-02-04" –∏–ª–∏ timestamp
        expenseDate = new Date(data.date);
      } else if (data.createdAt) {
        expenseDate = new Date(data.createdAt);
      } else {
        expenseDate = new Date(0);
      }
      
      if (expenseDate >= startDate && expenseDate <= endDate) {
        expenses.push({ id: doc.id, ...data, expenseDate });
      }
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—Ö–æ–¥—ã –∞–≥–µ–Ω—Ç–æ–≤
    agentExpensesSnap.forEach(doc => {
      const data = doc.data();
      let expenseDate;
      if (data.timestamp) {
        expenseDate = new Date(data.timestamp);
      } else if (data.date) {
        expenseDate = new Date(data.date);
      } else if (data.createdAt) {
        expenseDate = new Date(data.createdAt);
      } else {
        expenseDate = new Date(0);
      }
      
      if (expenseDate >= startDate && expenseDate <= endDate) {
        expenses.push({
          id: 'agent_' + doc.id,
          description: data.description || '-',
          amount: data.amount || 0,
          expenseDate,
          isAgentExpense: true,
          agentName: data.agentName || '–ê–≥–µ–Ω—Ç'
        });
      }
    });
    
    console.log('‚úÖ –†–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥ (–≤–∫–ª—é—á–∞—è –∞–≥–µ–Ω—Ç–æ–≤):', expenses.length);
    
    let periodProfit = 0;
    ordersSnap.forEach(doc => {
      const data = doc.data();
      const orderDate = data.timestamp ? new Date(data.timestamp) : new Date(data.date || 0);
      if (orderDate >= startDate && orderDate <= endDate) {
        const items = data.items || data.cart || [];
        items.forEach(item => {
          const qty = item.qty || item.quantity || 1;
          const sale = (parseFloat(item.price) || 0) * qty;
          
          // –ò—â–µ–º costPrice: —Å–Ω–∞—á–∞–ª–∞ –≤ –∑–∞–∫–∞–∑–µ, –ø–æ—Ç–æ–º –≤ –±–∞–∑–µ —Ç–æ–≤–∞—Ä–æ–≤
          let costPrice = parseFloat(item.costPrice) || 0;
          if (costPrice === 0 && item.id) {
            const product = products.find(p => p.id === item.id);
            if (product && product.costPrice) {
              costPrice = parseFloat(product.costPrice) || 0;
            }
          }
          
          const cost = costPrice * qty;
          // –ü—Ä–∏–±—ã–ª—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–∫—É–ø–æ—á–Ω–∞—è —Ü–µ–Ω–∞
          if (costPrice > 0) {
            periodProfit += sale - cost;
          }
        });
      }
    });
    
    const totalExpenses = expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
    const netProfit = periodProfit - totalExpenses;
    
    document.getElementById('totalExpenses').textContent = totalExpenses.toFixed(2) + ' —Å–æ–º';
    document.getElementById('expensesPeriodProfit').textContent = periodProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('netProfit').textContent = netProfit.toFixed(2) + ' —Å–æ–º';
    document.getElementById('netProfit').style.color = netProfit >= 0 ? '#28a745' : '#dc3545';
    
    // –¢–∞–±–ª–∏—Ü–∞
    expenses.sort((a, b) => b.expenseDate - a.expenseDate);
    
    const tbody = document.getElementById('expensesReportBody');
    const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
    tbody.innerHTML = expenses.map((e, i) => {
      const dateStr = e.expenseDate.toLocaleDateString('ru-RU');
      const recurringBadge = e.isRecurring ? '<span style="background:#17a2b8; color:white; padding:2px 6px; border-radius:4px; font-size:11px; margin-left:6px;">üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–π</span>' : '';
      const agentBadge = e.isAgentExpense ? '<span style="background:#ff9800; color:white; padding:2px 6px; border-radius:4px; font-size:11px; margin-left:6px;">ü§ù ' + e.agentName + '</span>' : '';
      const daysInfo = (e.isRecurring && e.recurringDays && e.recurringDays.length > 0) ? 
        '<span style="color:#666; font-size:11px; margin-left:6px;">(' + e.recurringDays.map(d => dayNames[d]).join(', ') + ')</span>' : '';
      
      let deleteBtn = '';
      if (e.isAgentExpense) {
        const realId = e.id.replace('agent_', '');
        deleteBtn = `<button onclick="deleteAgentExpenseAdmin('${realId}')" class="btn-red" style="padding:6px 12px; font-size:12px;">üóëÔ∏è</button>`;
      } else {
        deleteBtn = `<button onclick="deleteExpense('${e.id}')" class="btn-red" style="padding:6px 12px; font-size:12px;">üóëÔ∏è</button>`;
      }
      
      return `
        <tr>
          <td data-label="#">${i + 1}</td>
          <td data-label="–î–∞—Ç–∞">${dateStr}</td>
          <td data-label="–û–ø–∏—Å–∞–Ω–∏–µ">${e.description || '-'}${recurringBadge}${agentBadge}${daysInfo}</td>
          <td data-label="–°—É–º–º–∞" class="right" style="color:#dc3545; font-weight:600;">${(parseFloat(e.amount) || 0).toFixed(2)} —Å–æ–º</td>
          <td data-label="–î–µ–π—Å—Ç–≤–∏—è" class="center">${deleteBtn}</td>
        </tr>
      `;
    }).join('');
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤:', error);
  }
}

// ============ –§–£–ù–ö–¶–ò–ò –†–ê–°–•–û–î–û–í ============
function toggleRecurringOptions() {
  const isChecked = document.getElementById('expenseIsRecurring').checked;
  document.getElementById('recurringOptions').style.display = isChecked ? 'block' : 'none';
  updateFillRangeDaysInfo();
}

function toggleFillRangeOptions() {
  const isChecked = document.getElementById('expenseFillRange').checked;
  document.getElementById('fillRangeInfo').style.display = isChecked ? 'block' : 'none';
  if (isChecked) updateFillRangeDaysInfo();
}

function updateFillRangeDaysInfo() {
  const dateVal = document.getElementById('expenseDate').value;
  const infoEl = document.getElementById('fillRangeDaysInfo');
  if (!dateVal || !infoEl) return;
  const from = new Date(dateVal);
  const today = new Date();
  today.setHours(0,0,0,0);
  from.setHours(0,0,0,0);
  const diffMs = today.getTime() - from.getTime();
  const totalDays = Math.floor(diffMs / (24*60*60*1000)) + 1;
  if (totalDays < 1) {
    infoEl.textContent = '‚ö†Ô∏è –î–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–µ–≥–æ–¥–Ω—è –∏–ª–∏ —Ä–∞–Ω—å—à–µ';
    return;
  }
  const isRecurring = document.getElementById('expenseIsRecurring').checked;
  let activeDays = totalDays;
  if (isRecurring) {
    const selectedDays = Array.from(document.querySelectorAll('.recurringDay:checked')).map(cb => parseInt(cb.value));
    if (selectedDays.length > 0) {
      activeDays = 0;
      for (let i = 0; i < totalDays; i++) {
        const d = new Date(from);
        d.setDate(d.getDate() + i);
        if (selectedDays.includes(d.getDay())) activeDays++;
      }
    }
  }
  const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
  const total = amount * activeDays;
  const daysWord = activeDays === 1 ? '–¥–µ–Ω—å' : activeDays < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π';
  const extra = isRecurring ? ' (–ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–Ω—è–º)' : '';
  infoEl.innerHTML = `üìÖ ${activeDays} ${daysWord}${extra} √ó ${amount.toFixed(2)} = <b>${total.toFixed(2)} —Å–æ–º</b>`;
}

function openAddExpenseModal() {
  document.getElementById('addExpenseModal').classList.add('active');
  document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('expenseDescription').value = '';
  document.getElementById('expenseAmount').value = '';
  document.getElementById('expenseIsRecurring').checked = false;
  document.getElementById('recurringOptions').style.display = 'none';
  document.getElementById('expenseFillRange').checked = false;
  document.getElementById('fillRangeInfo').style.display = 'none';
  document.querySelectorAll('.recurringDay').forEach(cb => cb.checked = false);
  // –û–±–Ω–æ–≤–ª—è—Ç—å –∏–Ω—Ñ–æ –æ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã/—Å—É–º–º—ã
  document.getElementById('expenseDate').addEventListener('change', updateFillRangeDaysInfo);
  document.getElementById('expenseAmount').addEventListener('input', updateFillRangeDaysInfo);
}

function closeAddExpenseModal() {
  document.getElementById('addExpenseModal').classList.remove('active');
}

async function saveExpense() {
  const description = document.getElementById('expenseDescription').value.trim();
  const amount = parseFloat(document.getElementById('expenseAmount').value);
  const date = document.getElementById('expenseDate').value;
  
  if (!description) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞', 'error');
    return;
  }
  
  if (!amount || amount <= 0) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'error');
    return;
  }
  
  if (!date) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É', 'error');
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–Ω–µ–π
  const fillRange = document.getElementById('expenseFillRange').checked;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥
  const isRecurring = document.getElementById('expenseIsRecurring').checked;
  let selectedDays = [];
  if (isRecurring) {
    selectedDays = Array.from(document.querySelectorAll('.recurringDay:checked')).map(cb => parseInt(cb.value));
    if (selectedDays.length === 0) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞', 'error');
      return;
    }
  }

  try {
    if (fillRange) {
      // –°–æ–∑–¥–∞—ë–º —Ä–∞—Å—Ö–æ–¥ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –¥–æ —Å–µ–≥–æ–¥–Ω—è
      const fromDate = new Date(date);
      fromDate.setHours(0,0,0,0);
      const today = new Date();
      today.setHours(0,0,0,0);
      if (fromDate > today) {
        Swal.fire('–û—à–∏–±–∫–∞', '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è', 'error');
        return;
      }
      const totalDays = Math.floor((today - fromDate) / (24*60*60*1000)) + 1;

      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞—Ç—ã —Å —É—á—ë—Ç–æ–º –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω —Ä–µ–≥—É–ª—è—Ä–Ω—ã–π)
      const datesToAdd = [];
      for (let i = 0; i < totalDays; i++) {
        const d = new Date(fromDate);
        d.setDate(d.getDate() + i);
        if (isRecurring && selectedDays.length > 0) {
          if (!selectedDays.includes(d.getDay())) continue;
        }
        datesToAdd.push(d);
      }

      if (datesToAdd.length === 0) {
        Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–Ω–µ–π –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ', 'error');
        return;
      }

      const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      const extraInfo = isRecurring ? `<br>–î–Ω–∏: <b>${selectedDays.map(d => dayNames[d]).join(', ')}</b>` : '';
      const confirmResult = await Swal.fire({
        title: `–î–æ–±–∞–≤–∏—Ç—å ${datesToAdd.length} —Ä–∞—Å—Ö–æ–¥–æ–≤?`,
        html: `<b>${description}</b><br>–ü–æ ${amount.toFixed(2)} —Å–æ–º √ó ${datesToAdd.length} –¥–Ω–µ–π = <b>${(amount * datesToAdd.length).toFixed(2)} —Å–æ–º</b>${extraInfo}`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '–î–∞, –¥–æ–±–∞–≤–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      });
      if (!confirmResult.isConfirmed) return;

      const batch = db.batch();
      datesToAdd.forEach(d => {
        const dateStr = d.toISOString().split('T')[0];
        const ref = db.collection('expenses').doc();
        batch.set(ref, {
          description,
          amount,
          date: dateStr,
          timestamp: d.getTime(),
          createdAt: Date.now(),
          isRecurring: false
        });
      });
      await batch.commit();

      closeAddExpenseModal();
      Swal.fire('–£—Å–ø–µ—Ö', `–î–æ–±–∞–≤–ª–µ–Ω–æ ${datesToAdd.length} —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ —Å—É–º–º—É ${(amount * datesToAdd.length).toFixed(2)} —Å–æ–º`, 'success');
      loadExpensesReport();
      return;
    }

    const expenseData = {
      description,
      amount,
      date,
      timestamp: new Date(date).getTime(),
      createdAt: Date.now(),
      isRecurring: isRecurring || false
    };
    if (isRecurring) {
      expenseData.recurringDays = selectedDays;
    }
    await db.collection('expenses').add(expenseData);
    
    closeAddExpenseModal();
    if (isRecurring) {
      const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      const names = selectedDays.map(d => dayNames[d]).join(', ');
      Swal.fire('–£—Å–ø–µ—Ö', `–†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ "${description}" –¥–æ–±–∞–≤–ª–µ–Ω! –î–Ω–∏: ${names}`, 'success');
    } else {
      Swal.fire('–£—Å–ø–µ—Ö', '–†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
    }
    loadExpensesReport();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥', 'error');
  }
}

async function deleteExpense(id) {
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    confirmButtonText: '–£–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (result.isConfirmed) {
    try {
      await db.collection('expenses').doc(id).delete();
      Swal.fire('–£–¥–∞–ª–µ–Ω–æ!', '', 'success');
      loadExpensesReport();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'error');
    }
  }
}

// –£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ –∞–≥–µ–Ω—Ç–∞ (–∏–∑ –∞–¥–º–∏–Ω–∫–∏)
async function deleteAgentExpenseAdmin(id) {
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥ –∞–≥–µ–Ω—Ç–∞?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ff9800',
    confirmButtonText: '–£–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (result.isConfirmed) {
    try {
      await db.collection('agentExpenses').doc(id).delete();
      Swal.fire('–£–¥–∞–ª–µ–Ω–æ!', '–†–∞—Å—Ö–æ–¥ –∞–≥–µ–Ω—Ç–∞ —É–¥–∞–ª—ë–Ω', 'success');
      loadExpensesReport();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –∞–≥–µ–Ω—Ç–∞:', error);
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'error');
    }
  }
}

// ============ –£–î–ê–õ–ï–ù–ò–ï –í–°–ï–• –†–ê–°–•–û–î–û–í –ó–ê –ü–ï–†–ò–û–î ============
async function deleteAllExpensesForPeriod() {
  const dateFilter = document.getElementById('expenseDateFilter').value;
  if (dateFilter === 'all') {
    const confirmAll = await Swal.fire({
      title: '‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï —Ä–∞—Å—Ö–æ–¥—ã?',
      text: '–í—ã –≤—ã–±—Ä–∞–ª–∏ "–í—Å–µ –≤—Ä–µ–º—è". –≠—Ç–æ —É–¥–∞–ª–∏—Ç –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã! –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å –í–°–ï',
      cancelButtonText: '–û—Ç–º–µ–Ω–∞'
    });
    if (!confirmAll.isConfirmed) return;
  }

  const now = new Date();
  let startDate = new Date(0);
  let endDate = new Date(now.getTime() + 24 * 60 * 60 * 1000);
  let periodName = '–≤–µ—Å—å –ø–µ—Ä–∏–æ–¥';

  switch(dateFilter) {
    case 'today':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      periodName = '—Å–µ–≥–æ–¥–Ω—è';
      break;
    case 'yesterday':
      startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      periodName = '–≤—á–µ—Ä–∞';
      break;
    case 'week':
      startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      periodName = '–Ω–µ–¥–µ–ª—é';
      break;
    case 'month':
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      periodName = '–º–µ—Å—è—Ü';
      break;
    case 'custom':
      const fromVal = document.getElementById('expenseDateFrom').value;
      const toVal = document.getElementById('expenseDateTo').value;
      if (fromVal) startDate = new Date(fromVal);
      if (toVal) { endDate = new Date(toVal); endDate.setHours(23, 59, 59, 999); }
      periodName = `${fromVal || '...'} ‚Äî ${toVal || '...'}`;
      break;
  }

  try {
    // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –ø–µ—Ä–∏–æ–¥
    const snapshot = await db.collection('expenses').get();
    const toDelete = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      let expDate;
      if (data.timestamp) expDate = new Date(data.timestamp);
      else if (data.date) expDate = new Date(data.date);
      else if (data.createdAt) expDate = new Date(data.createdAt);
      else return;
      if (expDate >= startDate && expDate <= endDate) {
        toDelete.push(doc.id);
      }
    });

    if (toDelete.length === 0) {
      Swal.fire('–ü—É—Å—Ç–æ', '–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥', 'info');
      return;
    }

    const confirm = await Swal.fire({
      title: `üóëÔ∏è –£–¥–∞–ª–∏—Ç—å ${toDelete.length} —Ä–∞—Å—Ö–æ–¥(–æ–≤)?`,
      html: `–ü–µ—Ä–∏–æ–¥: <b>${periodName}</b><br>–ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ: <b>${toDelete.length}</b> –∑–∞–ø–∏—Å–µ–π`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      confirmButtonText: `–£–¥–∞–ª–∏—Ç—å ${toDelete.length} —à—Ç.`,
      cancelButtonText: '–û—Ç–º–µ–Ω–∞'
    });

    if (!confirm.isConfirmed) return;

    // –£–¥–∞–ª—è–µ–º –±–∞—Ç—á–∞–º–∏ –ø–æ 500 (–ª–∏–º–∏—Ç Firestore)
    const batch = db.batch();
    toDelete.forEach(id => {
      batch.delete(db.collection('expenses').doc(id));
    });
    await batch.commit();

    Swal.fire('–ì–æ—Ç–æ–≤–æ!', `–£–¥–∞–ª–µ–Ω–æ ${toDelete.length} —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ ${periodName}`, 'success');
    loadExpensesReport();

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã: ' + error.message, 'error');
  }
}

// ============ –≠–ö–°–ü–û–†–¢ –í EXCEL ============
function exportProfitToExcel() {
  const data = products.map(p => ({
    '–¢–æ–≤–∞—Ä': p.title,
    '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': p.category,
    '–ó–∞–∫—É–ø–∫–∞': parseFloat(p.costPrice) || 0,
    '–ü—Ä–æ–¥–∞–∂–∞': parseFloat(p.price) || 0,
    '–ü—Ä–∏–±—ã–ª—å': (parseFloat(p.price) || 0) - (parseFloat(p.costPrice) || 0)
  }));
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–∏–±—ã–ª—å –ø–æ —Ç–æ–≤–∞—Ä–∞–º');
  XLSX.writeFile(wb, 'profit_products.xlsx');
}

function exportOrderProfitToExcel() {
  Swal.fire('–≠–∫—Å–ø–æ—Ä—Ç', '–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∑–∞–∫–∞–∑–æ–≤', 'info');
}

function exportAgentsProfitToExcel() {
  Swal.fire('–≠–∫—Å–ø–æ—Ä—Ç', '–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∞–≥–µ–Ω—Ç–æ–≤', 'info');
}
</script>

</body>
</html>
