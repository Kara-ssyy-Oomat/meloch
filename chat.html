<!DOCTYPE html>
<html lang="ru">
<head>
  <script>
    if (window.parent === window) {
      window.location.replace('index.html?page=chat');
    }
    if (window.parent !== window) {
      document.write('<style>.bottom-nav,#bottomNavBar{display:none!important}body{padding-bottom:0!important}.chat-input-area{bottom:0!important}</style>');
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#667eea">
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-kerben.jpg">
  <link rel="icon" type="image/jpeg" href="icon-kerben.jpg">
  
  <title>–ß–∞—Ç - –ö–µ—Ä–±–µ–Ω</title>

  <!-- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ DNS -->
  <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .chat-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .back-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: white;
      cursor: pointer;
      text-decoration: none;
    }
    
    .chat-header-info { flex: 1; }
    .chat-header-title { font-size: 17px; font-weight: 600; }
    .chat-header-status { font-size: 12px; opacity: 0.9; }
    
    .change-name-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 80px;
    }
    
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .message.sent {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    .message.received {
      background: white;
      color: #333;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    
    .message-text { font-size: 15px; line-height: 1.4; }
    .message-time { font-size: 11px; opacity: 0.7; margin-top: 4px; text-align: right; }
    
    .chat-input-area {
      position: fixed;
      bottom: 56px;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      border-top: 1px solid #e0e0e0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    
    .chat-input {
      flex: 1;
      padding: 12px 18px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 16px;
      outline: none;
    }
    
    .chat-input:focus { border-color: #667eea; }
    
    .send-btn {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    

    
    @keyframes blink {
      0%, 60%, 100% { opacity: 0; }
      30% { opacity: 1; }
    }
    
    .typing-indicator span {
      animation: blink 1.4s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <header class="chat-header">
    <a href="#" onclick="goBack(); return false;" class="back-btn">‚Üê</a>
    <div class="chat-header-info">
      <div class="chat-header-title">üí¨ –ß–∞—Ç —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º</div>
      <div class="chat-header-status" id="clientNameDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <button class="change-name-btn" onclick="changeClientName()">‚úèÔ∏è –ò–º—è</button>
  </header>
  
  <div class="chat-messages" id="chatMessages">
    <div class="message received">
      <div class="message-text">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
      <div class="message-time">–ü—Ä–æ–¥–∞–≤–µ—Ü ‚Ä¢ —Ç–æ–ª—å–∫–æ —á—Ç–æ</div>
    </div>
  </div>
  
  <div class="chat-input-area">
    <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
    <button class="send-btn" onclick="sendMessage()">‚û§</button>
  </div>
  
  <script>
    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω—ã–π URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const initialUrl = window.location.href;
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ iframe –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥
    function goBack() {
      if (window.parent !== window && window.location.href === initialUrl) {
        window.parent.postMessage('closeIframe', '*');
      } else if (window.parent !== window) {
        window.location.href = initialUrl;
      } else {
        window.location.href = 'index.html';
      }
    }
  </script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
      authDomain: "svoysayet.firebaseapp.com",
      projectId: "svoysayet",
      storageBucket: "svoysayet.firebasestorage.app",
      messagingSenderId: "785840370498",
      appId: "1:785840370498:web:e08c7cbef96aborc5e81f1"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    let clientId = localStorage.getItem('chatClientId');
    let clientName = localStorage.getItem('chatClientName');
    
    if (!clientId) {
      clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('chatClientId', clientId);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function init() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
      const customerData = localStorage.getItem('customerData');
      if (customerData) {
        try {
          const customer = JSON.parse(customerData);
          if (customer.name && !clientName) {
            clientName = customer.name;
            localStorage.setItem('chatClientName', clientName);
          }
        } catch(e) {}
      }
      
      if (!clientName) {
        const { value: name } = await Swal.fire({
          title: '–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?',
          input: 'text',
          inputPlaceholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è',
          allowOutsideClick: false,
          confirmButtonText: '–ù–∞—á–∞—Ç—å —á–∞—Ç',
          confirmButtonColor: '#667eea'
        });
        
        if (name) {
          clientName = name;
          localStorage.setItem('chatClientName', name);
        } else {
          clientName = '–ì–æ—Å—Ç—å';
        }
      }
      
      updateClientDisplay();
      loadMessages();
      updateCartBadge();
    }
    
    function updateClientDisplay() {
      const display = document.getElementById('clientNameDisplay');
      if (display && clientName) {
        display.innerHTML = `üë§ ${clientName} ‚Ä¢ ID: ${clientId.substring(7, 15)}`;
      }
    }
    
    async function changeClientName() {
      const { value: newName } = await Swal.fire({
        title: '–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è',
        input: 'text',
        inputValue: clientName || '',
        showCancelButton: true,
        confirmButtonText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      });
      
      if (newName && newName !== clientName) {
        clientName = newName;
        localStorage.setItem('chatClientName', newName);
        updateClientDisplay();
        
        try {
          await db.collection('chatClients').doc(clientId).update({ name: newName });
        } catch(e) {}
        
        Swal.fire({ icon: 'success', title: '–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ!', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
      }
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    const shownMessageIds = new Set();
    
    async function loadMessages() {
      try {
        const messagesDiv = document.getElementById('chatMessages');
        const snapshot = await db.collection('chatMessages')
          .where('clientId', '==', clientId)
          .orderBy('timestamp', 'asc')
          .limit(100)
          .get();
        
        if (snapshot.empty) {
          // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
          subscribeToNewMessages();
          return;
        }
        
        messagesDiv.innerHTML = '';
        
        snapshot.forEach(doc => {
          shownMessageIds.add(doc.id); // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º ID –ø–æ–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
          const msg = doc.data();
          const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '';
          const isSent = msg.sender === 'client';
          
          // –ü–æ–º–µ—á–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
          if (msg.sender === 'admin' && !msg.read) {
            doc.ref.update({ read: true });
          }
          
          const div = document.createElement('div');
          div.className = `message ${isSent ? 'sent' : 'received'}`;
          div.innerHTML = `
            <div class="message-text">${escapeHtml(msg.text)}</div>
            <div class="message-time">${isSent ? '–í—ã' : '–ü—Ä–æ–¥–∞–≤–µ—Ü'} ‚Ä¢ ${time}</div>
          `;
          messagesDiv.appendChild(div);
        });
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        subscribeToNewMessages();
          
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
      }
    }
    
    function subscribeToNewMessages() {
      db.collection('chatMessages')
        .where('clientId', '==', clientId)
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
              const docId = change.doc.id;
              // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
              if (shownMessageIds.has(docId)) return;
              
              shownMessageIds.add(docId);
              const msg = change.doc.data();
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∞
              if (msg.sender === 'admin') {
                addMessageToUI(msg.text, 'received', new Date(msg.timestamp?.seconds * 1000 || Date.now()));
                showNewMessageNotification('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞');
                if (!msg.read) {
                  change.doc.ref.update({ read: true });
                }
              }
            }
          });
        });
    }
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    let originalTitle = document.title;
    let titleBlinkInterval = null;
    let audioCtx = null;
    
    function showNewMessageNotification(text) {
      console.log('üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', text);
      
      // –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è 
      try {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.3);
      } catch(e) { console.log('–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:', e); }
      
      // –ú–∏–≥–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
      let isOriginal = true;
      if (titleBlinkInterval) clearInterval(titleBlinkInterval);
      titleBlinkInterval = setInterval(() => {
        document.title = isOriginal ? 'üí¨ ' + text : originalTitle;
        isOriginal = !isOriginal;
      }, 1000);
        
      // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
      window.addEventListener('focus', function stopBlink() {
        clearInterval(titleBlinkInterval);
        document.title = originalTitle;
        window.removeEventListener('focus', stopBlink);
      }, { once: true });
      
      // –ë—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('–ö–µ—Ä–±–µ–Ω - –ß–∞—Ç', { body: text, icon: 'icon-kerben.jpg' });
      }
    }
    
    // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
    
    function addMessageToUI(text, type, timestamp) {
      const messagesDiv = document.getElementById('chatMessages');
      const time = timestamp.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      
      const div = document.createElement('div');
      div.className = `message ${type === 'sent' ? 'sent' : 'received'}`;
      div.innerHTML = `
        <div class="message-text">${escapeHtml(text)}</div>
        <div class="message-time">${type === 'sent' ? '–í—ã' : '–ü—Ä–æ–¥–∞–≤–µ—Ü'} ‚Ä¢ ${time}</div>
      `;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      
      const now = new Date();
      addMessageToUI(text, 'sent', now);
      input.value = '';
      
      try {
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Firebase...', { clientId, text });
        
        const msgRef = await db.collection('chatMessages').add({
          text: text,
          sender: 'client',
          clientId: clientId,
          clientName: clientName || '–ö–ª–∏–µ–Ω—Ç',
          timestamp: firebase.firestore.Timestamp.fromDate(now),
          read: false
        });
        
        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, ID:', msgRef.id);
        
        await db.collection('chatClients').doc(clientId).set({
          name: clientName || '–ö–ª–∏–µ–Ω—Ç',
          lastActive: firebase.firestore.FieldValue.serverTimestamp(),
          lastMessage: text,
          hasUnread: true
        }, { merge: true });
        
        console.log('–ö–ª–∏–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –≤ chatClients');
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        Swal.fire({ icon: 'error', title: '–û—à–∏–±–∫–∞', text: error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', toast: true, timer: 5000 });
      }
    }
    
    function updateCartBadge() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const badge = document.getElementById('navCartBadge');
      if (badge) {
        badge.textContent = cart.length;
        badge.style.display = cart.length > 0 ? 'flex' : 'none';
      }
    }
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
<script src="js/bottom-nav.js?v=20"></script>
</body>
</html>