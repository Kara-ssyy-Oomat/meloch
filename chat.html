<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#667eea">
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-kerben.jpg">
  <link rel="icon" type="image/jpeg" href="icon-kerben.jpg">
  
  <title>–ß–∞—Ç - –ö–µ—Ä–±–µ–Ω</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .chat-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .back-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: white;
      cursor: pointer;
      text-decoration: none;
    }
    
    .chat-header-info { flex: 1; }
    .chat-header-title { font-size: 17px; font-weight: 600; }
    .chat-header-status { font-size: 12px; opacity: 0.9; }
    
    .change-name-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 80px;
    }
    
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .message.sent {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    .message.received {
      background: white;
      color: #333;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    
    .message-text { font-size: 15px; line-height: 1.4; }
    .message-time { font-size: 11px; opacity: 0.7; margin-top: 4px; text-align: right; }
    
    .chat-input-area {
      position: fixed;
      bottom: 56px;
      left: 0;
      right: 0;
      background: white;
      padding: 12px 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      border-top: 1px solid #e0e0e0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    
    .chat-input {
      flex: 1;
      padding: 12px 18px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 16px;
      outline: none;
    }
    
    .chat-input:focus { border-color: #667eea; }
    
    .send-btn {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #fff;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-around;
      z-index: 9999;
    }
    
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      color: #9e9e9e;
      text-decoration: none;
      position: relative;
    }
    
    .nav-item.active { color: #667eea; }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
    .nav-item span { font-size: 11px; }
    
    .nav-badge {
      position: absolute;
      top: 6px;
      right: calc(50% - 16px);
      background: #e53935;
      color: white;
      font-size: 10px;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    @keyframes blink {
      0%, 60%, 100% { opacity: 0; }
      30% { opacity: 1; }
    }
    
    .typing-indicator span {
      animation: blink 1.4s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  </style>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <header class="chat-header">
    <a href="index.html" class="back-btn">‚Üê</a>
    <div class="chat-header-info">
      <div class="chat-header-title">üí¨ –ß–∞—Ç —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º</div>
      <div class="chat-header-status" id="clientNameDisplay">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <button class="change-name-btn" onclick="changeClientName()">‚úèÔ∏è –ò–º—è</button>
  </header>
  
  <div class="chat-messages" id="chatMessages">
    <div class="message received">
      <div class="message-text">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
      <div class="message-time">–ü—Ä–æ–¥–∞–≤–µ—Ü ‚Ä¢ —Ç–æ–ª—å–∫–æ —á—Ç–æ</div>
    </div>
  </div>
  
  <div class="chat-input-area">
    <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
    <button class="send-btn" onclick="sendMessage()">‚û§</button>
  </div>
  
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="index.html#categories" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M3 5h6v6H3V5zm0 8h6v6H3v-6zm8-8h6v6h-6V5zm0 8h6v6h-6v-6z"/></svg>
      <span>–ú–µ–Ω—é</span>
    </a>
    <a href="cart.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM7.2 14.6L8.2 12h7.4c.8 0 1.4-.4 1.7-1l3.9-7-1.7-1-3.9 7H8.5L4.3 2H1v2h2l3.6 7.6-1.4 2.5c-.7 1.3.3 2.9 1.8 2.9h12v-2H7.4z"/></svg>
      <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
      <span class="nav-badge" id="navCartBadge">0</span>
    </a>
    <a href="chat.html" class="nav-item active">
      <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
      <span>–ß–∞—Ç</span>
    </a>
    <a href="profile.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm0 2c-2.7 0-8 1.3-8 4v2h16v-2c0-2.7-5.3-4-8-4z"/></svg>
      <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </a>
  </nav>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB0vkHoMqC-ec3L8EQubHFEavLYAkqr0MQ",
      authDomain: "kerben-store.firebaseapp.com",
      projectId: "kerben-store",
      storageBucket: "kerben-store.firebasestorage.app",
      messagingSenderId: "799212629498",
      appId: "1:799212629498:web:37c0576a59e38874c8eb50"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    let clientId = localStorage.getItem('chatClientId');
    let clientName = localStorage.getItem('chatClientName');
    
    if (!clientId) {
      clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('chatClientId', clientId);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function init() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
      const customerData = localStorage.getItem('customerData');
      if (customerData) {
        try {
          const customer = JSON.parse(customerData);
          if (customer.name && !clientName) {
            clientName = customer.name;
            localStorage.setItem('chatClientName', clientName);
          }
        } catch(e) {}
      }
      
      if (!clientName) {
        const { value: name } = await Swal.fire({
          title: '–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?',
          input: 'text',
          inputPlaceholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è',
          allowOutsideClick: false,
          confirmButtonText: '–ù–∞—á–∞—Ç—å —á–∞—Ç',
          confirmButtonColor: '#667eea'
        });
        
        if (name) {
          clientName = name;
          localStorage.setItem('chatClientName', name);
        } else {
          clientName = '–ì–æ—Å—Ç—å';
        }
      }
      
      updateClientDisplay();
      loadMessages();
      updateCartBadge();
    }
    
    function updateClientDisplay() {
      const display = document.getElementById('clientNameDisplay');
      if (display && clientName) {
        display.innerHTML = `üë§ ${clientName} ‚Ä¢ ID: ${clientId.substring(7, 15)}`;
      }
    }
    
    async function changeClientName() {
      const { value: newName } = await Swal.fire({
        title: '–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è',
        input: 'text',
        inputValue: clientName || '',
        showCancelButton: true,
        confirmButtonText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      });
      
      if (newName && newName !== clientName) {
        clientName = newName;
        localStorage.setItem('chatClientName', newName);
        updateClientDisplay();
        
        try {
          await db.collection('chatClients').doc(clientId).update({ name: newName });
        } catch(e) {}
        
        Swal.fire({ icon: 'success', title: '–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ!', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
      }
    }
    
    async function loadMessages() {
      try {
        const messagesDiv = document.getElementById('chatMessages');
        const snapshot = await db.collection('chatMessages')
          .where('clientId', '==', clientId)
          .orderBy('timestamp', 'asc')
          .limit(100)
          .get();
        
        if (snapshot.empty) return;
        
        messagesDiv.innerHTML = '';
        
        snapshot.forEach(doc => {
          const msg = doc.data();
          const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '';
          const isSent = msg.sender === 'client';
          
          const div = document.createElement('div');
          div.className = `message ${isSent ? 'sent' : 'received'}`;
          div.innerHTML = `
            <div class="message-text">${escapeHtml(msg.text)}</div>
            <div class="message-time">${isSent ? '–í—ã' : '–ü—Ä–æ–¥–∞–≤–µ—Ü'} ‚Ä¢ ${time}</div>
          `;
          messagesDiv.appendChild(div);
        });
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        db.collection('chatMessages')
          .where('clientId', '==', clientId)
          .where('sender', '==', 'admin')
          .orderBy('timestamp', 'desc')
          .limit(1)
          .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
              if (change.type === 'added') {
                const msg = change.doc.data();
                if (!msg.read) {
                  addMessageToUI(msg.text, 'received', new Date(msg.timestamp?.seconds * 1000 || Date.now()));
                  change.doc.ref.update({ read: true });
                }
              }
            });
          });
          
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
      }
    }
    
    function addMessageToUI(text, type, timestamp) {
      const messagesDiv = document.getElementById('chatMessages');
      const time = timestamp.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      
      const div = document.createElement('div');
      div.className = `message ${type === 'sent' ? 'sent' : 'received'}`;
      div.innerHTML = `
        <div class="message-text">${escapeHtml(text)}</div>
        <div class="message-time">${type === 'sent' ? '–í—ã' : '–ü—Ä–æ–¥–∞–≤–µ—Ü'} ‚Ä¢ ${time}</div>
      `;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      
      const now = new Date();
      addMessageToUI(text, 'sent', now);
      input.value = '';
      
      try {
        await db.collection('chatMessages').add({
          text: text,
          sender: 'client',
          clientId: clientId,
          clientName: clientName || '–ö–ª–∏–µ–Ω—Ç',
          timestamp: firebase.firestore.Timestamp.fromDate(now),
          read: false
        });
        
        await db.collection('chatClients').doc(clientId).set({
          name: clientName || '–ö–ª–∏–µ–Ω—Ç',
          lastActive: firebase.firestore.FieldValue.serverTimestamp(),
          lastMessage: text
        }, { merge: true });
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        Swal.fire({ icon: 'error', title: '–û—à–∏–±–∫–∞', text: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', toast: true, timer: 3000 });
      }
    }
    
    function updateCartBadge() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const badge = document.getElementById('navCartBadge');
      if (badge) {
        badge.textContent = cart.length;
        badge.style.display = cart.length > 0 ? 'flex' : 'none';
      }
    }
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>