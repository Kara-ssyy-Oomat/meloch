<!DOCTYPE html>
<html lang="ru">
<head>
  <script>if(window.parent!==window)document.write('<style>.bottom-nav,#bottomNavBar{display:none!important}body{padding-bottom:0!important}</style>')</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–æ—è –ø—Ä–∏–±—ã–ª—å - –ê–≥–µ–Ω—Ç</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    .header {
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 600;
    }
    
    .header-subtitle {
      font-size: 13px;
      opacity: 0.9;
    }
    
    .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: calc(100vh - 60px);
      padding: 20px;
    }
    
    .auth-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    
    .auth-header {
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
      color: white;
      padding: 25px;
      text-align: center;
    }
    
    .auth-header h2 {
      margin: 0;
      font-size: 22px;
    }
    
    .auth-header p {
      margin: 8px 0 0;
      opacity: 0.9;
      font-size: 14px;
    }
    
    .auth-tabs {
      display: flex;
      gap: 10px;
      padding: 20px 20px 0;
    }
    
    .auth-tab {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .auth-tab.active-login {
      background: #9c27b0;
      color: white;
    }
    
    .auth-tab.active-register {
      background: #4caf50;
      color: white;
    }
    
    .auth-tab.inactive {
      background: #e0e0e0;
      color: #333;
    }
    
    .auth-form {
      padding: 20px;
    }
    
    .auth-input {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      margin-bottom: 12px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .auth-input:focus {
      outline: none;
      border-color: #9c27b0;
    }
    
    .auth-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      color: white;
      transition: all 0.3s;
    }
    
    .auth-btn.login {
      background: linear-gradient(135deg, #9c27b0, #7b1fa2);
    }
    
    .auth-btn.register {
      background: linear-gradient(135deg, #4caf50, #388e3c);
    }
    
    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    .dashboard {
      display: none;
    }
    
    .dashboard.active {
      display: block;
    }
    
    .filters-bar {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    
    .filters-group {
      display: flex;
      align-items: center;
      gap: 5px;
      background: #f5f5f5;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
    }
    
    .filter-select {
      padding: 6px 8px;
      border: none;
      background: transparent;
      font-size: 13px;
      cursor: pointer;
      color: #333;
      outline: none;
    }
    
    .filter-divider {
      color: #ccc;
      font-size: 16px;
    }
    
    .action-btn {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.3s;
    }
    
    .action-btn.orange { background: #ff9800; color: white; }
    .action-btn.blue { background: #2196f3; color: white; }
    
    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .stat-card {
      padding: 12px;
      border-radius: 12px;
      color: white;
      box-shadow: 0 3px 12px rgba(0,0,0,0.2);
    }
    
    .stat-card.purple { background: linear-gradient(135deg, #9c27b0, #7b1fa2); }
    .stat-card.blue { background: linear-gradient(135deg, #2196f3, #1976d2); }
    .stat-card.orange { background: linear-gradient(135deg, #ff9800, #f57c00); cursor: pointer; }
    .stat-card.green { background: linear-gradient(135deg, #4caf50, #388e3c); }
    .stat-card.pink { background: linear-gradient(135deg, #e91e63, #c2185b); }
    .stat-card.cyan { background: linear-gradient(135deg, #00bcd4, #0097a7); }
    
    .stat-card.orange:hover {
      transform: scale(1.02);
    }
    
    .stat-label {
      font-size: 11px;
      opacity: 0.9;
      margin-bottom: 4px;
    }
    
    .stat-value {
      font-size: 22px;
      font-weight: 700;
    }
    
    /* –ì—Ä–∞—Ñ–∏–∫ */
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chart-title {
      margin: 0 0 15px;
      color: #333;
      font-size: 16px;
    }
    
    .chart-wrapper {
      height: 200px;
      position: relative;
    }
    
    /* –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ */
    .orders-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .orders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .orders-title {
      margin: 0;
      color: #333;
      font-size: 18px;
    }
    
    .orders-count {
      font-size: 14px;
      color: #666;
    }
    
    .orders-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .order-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      border-left: 4px solid #17a2b8;
      transition: all 0.3s;
    }
    
    .order-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .order-card.recent {
      background: #fff8e1;
      box-shadow: 0 0 10px rgba(255,87,34,0.3);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    
    .order-client {
      flex: 1;
      min-width: 200px;
    }
    
    .order-client-name {
      font-weight: 600;
      color: #333;
      font-size: 15px;
    }
    
    .order-client-phone {
      font-size: 13px;
      color: #666;
      margin-top: 2px;
    }
    
    .order-client-address {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }
    
    .order-meta {
      text-align: right;
    }
    
    .order-date {
      font-size: 12px;
      color: #999;
      margin-bottom: 4px;
    }
    
    .order-status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      display: inline-block;
      font-weight: 500;
      color: white;
    }
    
    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      margin-top: 12px;
      border-top: 1px solid #e0e0e0;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .order-total {
      color: #666;
    }
    
    .order-total strong {
      color: #333;
      font-size: 15px;
    }
    
    .order-profit {
      background: #e8f5e9;
      padding: 6px 14px;
      border-radius: 8px;
      color: #388e3c;
      font-weight: 700;
      font-size: 14px;
    }
    
    .order-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .order-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .order-btn.purple { background: #9c27b0; color: white; }
    .order-btn.red { background: #dc3545; color: white; }
    
    .order-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .order-items {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #ccc;
    }
    
    .order-items-title {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 3px 0;
      color: #555;
    }
    
    /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .bottom-bar {
      background: white;
      padding: 15px 20px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      bottom: 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    
    .logout-btn {
      padding: 12px 24px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    
    .close-btn {
      padding: 12px 32px;
      background: #9c27b0;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    
    /* –ü—É—Å—Ç—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      width: 95%;
      max-width: 500px;
      max-height: 85vh;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .modal-header {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-close {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      font-size: 24px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
    }
    
    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }
    
    .client-card {
      background: #f9f9f9;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid #ff9800;
    }
    
    .client-name {
      font-weight: 600;
      color: #333;
    }
    
    .client-phone {
      font-size: 13px;
      color: #666;
      margin-top: 3px;
    }
    
    .client-stats {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      padding-top: 8px;
      margin-top: 8px;
      border-top: 1px dashed #ddd;
    }
    
    /* –°–µ–∫—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –∞–≥–µ–Ω—Ç–∞ */
    .expenses-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .expenses-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .expenses-title {
      margin: 0;
      color: #333;
      font-size: 18px;
    }
    
    .expenses-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .add-expense-btn {
      padding: 10px 18px;
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .add-expense-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255,152,0,0.35);
    }
    
    .expense-period-select {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      background: white;
      outline: none;
    }
    
    .expense-period-select:focus {
      border-color: #ff9800;
    }
    
    .expenses-total-row {
      background: #fff3e0;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #ffe0b2;
    }
    
    .expenses-total-label {
      font-size: 14px;
      color: #e65100;
      font-weight: 500;
    }
    
    .expenses-total-value {
      font-size: 18px;
      font-weight: 700;
      color: #e65100;
    }
    
    .expenses-note {
      font-size: 11px;
      color: #999;
      text-align: center;
      margin-bottom: 12px;
      font-style: italic;
    }
    
    .expense-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      border-left: 4px solid #ff9800;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }
    
    .expense-card:hover {
      background: #fff8e1;
      transform: translateX(3px);
    }
    
    .expense-info {
      flex: 1;
    }
    
    .expense-desc {
      font-weight: 600;
      color: #333;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .expense-date-text {
      font-size: 12px;
      color: #999;
    }
    
    .expense-amount {
      font-weight: 700;
      color: #e65100;
      font-size: 16px;
      margin-right: 12px;
      white-space: nowrap;
    }
    
    .expense-delete-btn {
      background: #ff5252;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .expense-delete-btn:hover {
      background: #d32f2f;
      transform: scale(1.1);
    }
    
    .expenses-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    /* –ú–æ–¥–∞–ª–∫–∞ —Ä–∞—Å—Ö–æ–¥–∞ */
    .expense-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .expense-modal {
      background: white;
      width: 95%;
      max-width: 420px;
      border-radius: 16px;
      overflow: hidden;
    }
    
    .expense-modal-header {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      padding: 18px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .expense-modal-header h3 { margin: 0; font-size: 18px; }
    
    .expense-modal-close {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      font-size: 24px;
      width: 36px; height: 36px;
      border-radius: 50%;
      cursor: pointer;
    }
    
    .expense-modal-body { padding: 20px; }
    
    .expense-form-group {
      margin-bottom: 15px;
    }
    
    .expense-form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }
    
    .expense-form-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    
    .expense-form-input:focus {
      outline: none;
      border-color: #ff9800;
    }
    
    .expense-save-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #ff9800, #f57c00);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .expense-save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255,152,0,0.35);
    }

    @media (max-width: 600px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stat-value {
        font-size: 18px;
      }
      
      .header h1 {
        font-size: 16px;
      }
      
      .order-footer {
        flex-direction: column;
        align-items: stretch;
      }
      
      .order-actions {
        justify-content: flex-end;
      }
      
      .expenses-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .expenses-controls {
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <a href="index.html" class="back-btn">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
      <div>
        <h1>üí∞ –ú–æ—è –ø—Ä–∏–±—ã–ª—å</h1>
        <div class="header-subtitle" id="agentName">–ê–≥–µ–Ω—Ç: ---</div>
      </div>
    </div>
    <button class="back-btn" id="headerLogoutBtn" style="display:none;" onclick="logoutAgent()">üö™ –í—ã–π—Ç–∏</button>
  </div>

  <!-- –§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div id="authSection" class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <h2>ü§ù –ê–≥–µ–Ω—Ç—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h2>
        <p>–ü–æ–ª—É—á–∞–π—Ç–µ 2% –æ—Ç –∑–∞–∫–∞–∑–æ–≤ –≤–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
      </div>
      
      <div class="auth-tabs">
        <button class="auth-tab active-login" id="tabLogin" onclick="switchTab('login')">–í—Ö–æ–¥</button>
        <button class="auth-tab inactive" id="tabRegister" onclick="switchTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
      
      <div class="auth-form">
        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
        <div id="loginForm">
          <input type="tel" id="loginPhone" class="auth-input" placeholder="üì± –í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω">
          <input type="password" id="loginPassword" class="auth-input" placeholder="üîí –ü–∞—Ä–æ–ª—å">
          <button class="auth-btn login" onclick="loginAgent()">–í–æ–π—Ç–∏</button>
        </div>
        
        <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div id="registerForm" style="display:none;">
          <input type="text" id="regName" class="auth-input" placeholder="üë§ –í–∞—à–µ –∏–º—è">
          <input type="tel" id="regPhone" class="auth-input" placeholder="üì± –í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω">
          <input type="password" id="regPassword" class="auth-input" placeholder="üîí –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
          <input type="password" id="regPassword2" class="auth-input" placeholder="üîí –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
          <button class="auth-btn register" onclick="registerAgent()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
  <div id="dashboard" class="dashboard">
    <div class="container">
      <!-- –§–∏–ª—å—Ç—Ä—ã -->
      <div class="filters-bar">
        <div class="filters-group">
          <select id="periodFilter" class="filter-select" onchange="filterOrders()">
            <option value="all">üìÖ –í—Å–µ –≤—Ä–µ–º—è</option>
            <option value="today">üìÖ –°–µ–≥–æ–¥–Ω—è</option>
            <option value="week">üìÖ –ù–µ–¥–µ–ª—è</option>
            <option value="month" selected>üìÖ –ú–µ—Å—è—Ü</option>
            <option value="year">üìÖ –ì–æ–¥</option>
          </select>
          <span class="filter-divider">|</span>
          <select id="statusFilter" class="filter-select" onchange="filterOrders()">
            <option value="all">üè∑Ô∏è –í—Å–µ</option>
            <option value="–ù–æ–≤—ã–π">üÜï –ù–æ–≤—ã–π</option>
            <option value="–í –æ–±—Ä–∞–±–æ—Ç–∫–µ">‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
            <option value="–î–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è">üöö –î–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è</option>
            <option value="–î–æ—Å—Ç–∞–≤–ª–µ–Ω">‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
            <option value="–û—Ç–º–µ–Ω—ë–Ω">‚ùå –û—Ç–º–µ–Ω—ë–Ω</option>
          </select>
        </div>
        
        <div style="display:flex; gap:8px;">
          <button class="action-btn orange" onclick="exportReport()">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
          <button class="action-btn blue" onclick="loadOrders()">üîÑ</button>
        </div>
      </div>
      
      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="stats-grid">
        <div class="stat-card purple">
          <div class="stat-label">üì¶ –ó–∞–∫–∞–∑–æ–≤</div>
          <div class="stat-value" id="statOrders">0</div>
        </div>
        <div class="stat-card blue">
          <div class="stat-label">üíµ –°—É–º–º–∞</div>
          <div class="stat-value" id="statSum">0</div>
        </div>
        <div class="stat-card orange" onclick="showClients()">
          <div class="stat-label">üë• –ö–ª–∏–µ–Ω—Ç–æ–≤</div>
          <div class="stat-value" id="statClients">0</div>
        </div>
      </div>
      
      <div class="stats-grid" style="margin-bottom:20px;">
        <div class="stat-card green">
          <div class="stat-label">üí∞ –ü—Ä–∏–±—ã–ª—å (2%)</div>
          <div class="stat-value" id="statProfit">0</div>
        </div>
        <div class="stat-card pink">
          <div class="stat-label">üí∏ –í—ã–ø–ª–∞—á–µ–Ω–æ</div>
          <div class="stat-value" id="statPaid">0</div>
        </div>
        <div class="stat-card cyan">
          <div class="stat-label">üíé –ö –ø–æ–ª—É—á–µ–Ω–∏—é</div>
          <div class="stat-value" id="statBalance">0</div>
        </div>
      </div>
      
      <!-- –ì—Ä–∞—Ñ–∏–∫ -->
      <div class="chart-container">
        <h3 class="chart-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–∏–±—ã–ª–∏</h3>
        <div class="chart-wrapper">
          <canvas id="profitChart"></canvas>
        </div>
      </div>
      
      <!-- –°–µ–∫—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –∞–≥–µ–Ω—Ç–∞ -->
      <div class="expenses-section">
        <div class="expenses-header">
          <h3 class="expenses-title">üìù –ú–æ–∏ —Ä–∞—Å—Ö–æ–¥—ã (–¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏)</h3>
          <div class="expenses-controls">
            <select id="agentExpensePeriod" class="expense-period-select" onchange="loadAgentExpenses()">
              <option value="all">üìÖ –í—Å–µ –≤—Ä–µ–º—è</option>
              <option value="today">üìÖ –°–µ–≥–æ–¥–Ω—è</option>
              <option value="week">üìÖ –ù–µ–¥–µ–ª—è</option>
              <option value="month" selected>üìÖ –ú–µ—Å—è—Ü</option>
            </select>
            <button class="add-expense-btn" onclick="openAgentExpenseModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
          </div>
        </div>
        
        <div class="expenses-note">‚ö†Ô∏è –≠—Ç–∏ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –¥–ª—è –æ—Ç—á—ë—Ç–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –ù–ï –≤—ã—á–∏—Ç–∞—é—Ç—Å—è –∏–∑ –≤–∞—à–µ–π –ø—Ä–∏–±—ã–ª–∏</div>
        
        <div class="expenses-total-row">
          <span class="expenses-total-label">üí∏ –ò—Ç–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤:</span>
          <span class="expenses-total-value" id="agentExpensesTotal">0 —Å–æ–º</span>
        </div>
        
        <div class="expenses-list" id="agentExpensesList">
          <div class="empty-state">
            <div class="empty-icon">üìù</div>
            <div>–†–∞—Å—Ö–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
            <div style="font-size:13px; color:#999; margin-top:8px;">–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Å—é–¥–∞ —Ä–∞—Å—Ö–æ–¥—ã: –±–µ–Ω–∑–∏–Ω, –æ–±–µ–¥, —Å–≤—è–∑—å –∏ —Ç.–¥.</div>
          </div>
        </div>
      </div>
      
      <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
      <div class="orders-container">
        <div class="orders-header">
          <h3 class="orders-title">üìã –ó–∞–∫–∞–∑—ã –º–æ–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
          <span class="orders-count" id="ordersCount">0 –∑–∞–∫–∞–∑–æ–≤</span>
        </div>
        <div class="orders-list" id="ordersList">
          <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
    <div class="bottom-bar">
      <button class="logout-btn" onclick="logoutAgent()">üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
      <a href="index.html" class="close-btn">‚úñ –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –∞–≥–µ–Ω—Ç–∞ -->
  <div class="expense-modal-overlay" id="agentExpenseModal" onclick="if(event.target===this) closeAgentExpenseModal()">
    <div class="expense-modal">
      <div class="expense-modal-header">
        <h3>üìù –ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥</h3>
        <button class="expense-modal-close" onclick="closeAgentExpenseModal()">&times;</button>
      </div>
      <div class="expense-modal-body">
        <div class="expense-form-group">
          <label>üìã –ó–∞ —á—Ç–æ —Ä–∞—Å—Ö–æ–¥?</label>
          <input type="text" id="agentExpenseDesc" class="expense-form-input" placeholder="–ë–µ–Ω–∑–∏–Ω, –æ–±–µ–¥, —Å–≤—è–∑—å, –¥–æ—Å—Ç–∞–≤–∫–∞...">
        </div>
        <div class="expense-form-group">
          <label>üí∞ –°—É–º–º–∞ (—Å–æ–º)</label>
          <input type="number" id="agentExpenseAmount" class="expense-form-input" placeholder="0" min="0" step="1">
        </div>
        <div class="expense-form-group">
          <label>üìÖ –î–∞—Ç–∞</label>
          <input type="date" id="agentExpenseDate" class="expense-form-input">
        </div>
        <button class="expense-save-btn" onclick="saveAgentExpense()">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
  <div class="modal-overlay" id="clientsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin:0; font-size:18px;">üë• –ú–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã</h3>
        <button class="modal-close" onclick="closeClientsModal()">&times;</button>
      </div>
      <div class="modal-body" id="clientsList">
        <div class="empty-state">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <script>
    // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const firebaseConfig = {
      apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
      authDomain: "svoysayet.firebaseapp.com",
      projectId: "svoysayet",
      storageBucket: "svoysayet.appspot.com",
      messagingSenderId: "989465106314",
      appId: "1:989465106314:web:abc123"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // –î–∞–Ω–Ω—ã–µ
    let currentAgent = null;
    let allOrders = [];
    let filteredOrders = [];
    let profitChart = null;
    let ordersListener = null;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      loadAgentFromStorage();
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≥–µ–Ω—Ç–∞ –∏–∑ localStorage
    function loadAgentFromStorage() {
      try {
        const saved = localStorage.getItem('currentAgent');
        if (saved) {
          currentAgent = JSON.parse(saved);
          showDashboard();
          startOrdersListener();
          loadAgentExpenses();
        }
      } catch(e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≥–µ–Ω—Ç–∞:', e);
      }
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    function showDashboard() {
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
      document.getElementById('agentName').textContent = '–ê–≥–µ–Ω—Ç: ' + currentAgent.name;
      document.getElementById('headerLogoutBtn').style.display = 'block';
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    function showAuth() {
      document.getElementById('authSection').style.display = 'flex';
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('headerLogoutBtn').style.display = 'none';
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function switchTab(tab) {
      const tabLogin = document.getElementById('tabLogin');
      const tabRegister = document.getElementById('tabRegister');
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      
      if (tab === 'login') {
        tabLogin.className = 'auth-tab active-login';
        tabRegister.className = 'auth-tab inactive';
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
      } else {
        tabLogin.className = 'auth-tab inactive';
        tabRegister.className = 'auth-tab active-register';
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
      }
    }
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞
    async function registerAgent() {
      const name = document.getElementById('regName').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const password = document.getElementById('regPassword').value;
      const password2 = document.getElementById('regPassword2').value;
      
      if (!name || !phone || !password) {
        Swal.fire('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'warning');
        return;
      }
      
      if (password !== password2) {
        Swal.fire('–û—à–∏–±–∫–∞', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'warning');
        return;
      }
      
      if (password.length < 4) {
        Swal.fire('–û—à–∏–±–∫–∞', '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞', 'warning');
        return;
      }
      
      try {
        Swal.fire({ title: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        const existing = await db.collection('agents').where('phone', '==', phone).get();
        if (!existing.empty) {
          Swal.fire('–û—à–∏–±–∫–∞', '–ê–≥–µ–Ω—Ç —Å —Ç–∞–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'warning');
          return;
        }
        
        // –°–æ–∑–¥–∞—ë–º –∞–≥–µ–Ω—Ç–∞
        const agentRef = await db.collection('agents').add({
          name: name,
          phone: phone,
          password: password,
          createdAt: Date.now(),
          active: true
        });
        
        currentAgent = {
          id: agentRef.id,
          name: name,
          phone: phone
        };
        
        localStorage.setItem('currentAgent', JSON.stringify(currentAgent));
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('regName').value = '';
        document.getElementById('regPhone').value = '';
        document.getElementById('regPassword').value = '';
        document.getElementById('regPassword2').value = '';
        
        Swal.fire({
          icon: 'success',
          title: '–£—Å–ø–µ—Ö!',
          text: '–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –∞–≥–µ–Ω—Ç!',
          timer: 2000,
          showConfirmButton: false
        });
        
        showDashboard();
        startOrdersListener();
        loadAgentExpenses();
        
      } catch(e) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', e);
        Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è', 'error');
      }
    }
    
    // –í—Ö–æ–¥ –∞–≥–µ–Ω—Ç–∞
    async function loginAgent() {
      const phone = document.getElementById('loginPhone').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!phone || !password) {
        Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –ø–∞—Ä–æ–ª—å', 'warning');
        return;
      }
      
      try {
        Swal.fire({ title: '–í—Ö–æ–¥...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        
        const snapshot = await db.collection('agents').where('phone', '==', phone).get();
        
        if (snapshot.empty) {
          Swal.fire('–û—à–∏–±–∫–∞', '–ê–≥–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
          return;
        }
        
        const agentDoc = snapshot.docs[0];
        const agentData = agentDoc.data();
        
        if (agentData.password !== password) {
          Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'warning');
          return;
        }
        
        if (agentData.active === false) {
          Swal.fire('–û—à–∏–±–∫–∞', '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'warning');
          return;
        }
        
        currentAgent = {
          id: agentDoc.id,
          name: agentData.name,
          phone: agentData.phone
        };
        
        localStorage.setItem('currentAgent', JSON.stringify(currentAgent));
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('loginPhone').value = '';
        document.getElementById('loginPassword').value = '';
        
        Swal.fire({
          icon: 'success',
          title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
          text: '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–≥–µ–Ω—Ç: ' + agentData.name,
          timer: 2000,
          showConfirmButton: false
        });
        
        showDashboard();
        startOrdersListener();
        loadAgentExpenses();
        
      } catch(e) {
        console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', e);
        Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏', 'error');
      }
    }
    
    // –í—ã—Ö–æ–¥ –∞–≥–µ–Ω—Ç–∞
    function logoutAgent() {
      if (ordersListener) {
        ordersListener();
        ordersListener = null;
      }
      
      currentAgent = null;
      allOrders = [];
      filteredOrders = [];
      localStorage.removeItem('currentAgent');
      
      showAuth();
      
      Swal.fire({
        icon: 'info',
        title: '–í—ã—Ö–æ–¥',
        text: '–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ –∞–≥–µ–Ω—Ç–∞',
        timer: 1500,
        showConfirmButton: false
      });
    }
    
    // –ó–∞–ø—É—Å–∫ real-time —Å–ª—É—à–∞—Ç–µ–ª—è –∑–∞–∫–∞–∑–æ–≤
    function startOrdersListener() {
      if (!currentAgent) return;
      
      if (ordersListener) {
        ordersListener();
      }
      
      const searchValues = [currentAgent.name];
      if (currentAgent.id && currentAgent.id !== currentAgent.name) {
        searchValues.push(currentAgent.id);
      }
      
      ordersListener = db.collection('orders')
        .where('partner', 'in', searchValues)
        .limit(500)
        .onSnapshot(snapshot => {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã
          const changes = snapshot.docChanges();
          const newOrders = changes.filter(change => change.type === 'added');
          
          if (newOrders.length > 0 && allOrders.length > 0) {
            newOrders.forEach(change => {
              const newOrder = change.doc.data();
              Swal.fire({
                icon: 'success',
                title: 'üéâ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑!',
                html: `
                  <div style="text-align:left;">
                    <div><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${newOrder.name || '–ö–ª–∏–µ–Ω—Ç'}</div>
                    <div><strong>–°—É–º–º–∞:</strong> ${(newOrder.total || 0).toLocaleString()} —Å–æ–º</div>
                    <div style="color:#4caf50; font-weight:bold; margin-top:10px;">
                      üí∞ –í–∞—à–∞ –ø—Ä–∏–±—ã–ª—å: +${Math.round((newOrder.total || 0) * 0.02).toLocaleString()} —Å–æ–º
                    </div>
                  </div>
                `,
                timer: 5000,
                timerProgressBar: true
              });
            });
          }
          
          allOrders = [];
          snapshot.forEach(doc => allOrders.push({ id: doc.id, ...doc.data() }));
          allOrders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
          
          filterOrders();
          
        }, error => {
          console.error('–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è:', error);
        });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ (–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É—à–∞—Ç–µ–ª—è)
    function loadOrders() {
      startOrdersListener();
      Swal.fire({ icon: 'success', title: '–û–±–Ω–æ–≤–ª–µ–Ω–æ', timer: 1000, showConfirmButton: false });
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤
    function filterOrders() {
      const periodFilter = document.getElementById('periodFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      
      const now = Date.now();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      filteredOrders = allOrders.filter(order => {
        const orderTime = order.timestamp || 0;
        let periodMatch = true;
        
        switch(periodFilter) {
          case 'today':
            periodMatch = orderTime >= today.getTime();
            break;
          case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            periodMatch = orderTime >= weekStart.getTime();
            break;
          case 'month':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            periodMatch = orderTime >= monthStart.getTime();
            break;
          case 'year':
            const yearStart = new Date(today.getFullYear(), 0, 1);
            periodMatch = orderTime >= yearStart.getTime();
            break;
        }
        
        const statusMatch = statusFilter === 'all' || order.status === statusFilter;
        
        return periodMatch && statusMatch;
      });
      
      filteredOrders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      
      renderOrders();
      updateStats();
      drawChart();
    }
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–∫–∞–∑–æ–≤
    function renderOrders() {
      const listEl = document.getElementById('ordersList');
      
      if (allOrders.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <div>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –æ—Ç –≤–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
            <div style="font-size:14px; color:#999; margin-top:10px;">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–µ–π —Å—Å—ã–ª–∫–æ–π, —á—Ç–æ–±—ã –ø—Ä–∏–≤–ª–µ—á—å –∫–ª–∏–µ–Ω—Ç–æ–≤!</div>
          </div>
        `;
        document.getElementById('ordersCount').textContent = '0 –∑–∞–∫–∞–∑–æ–≤';
        return;
      }
      
      if (filteredOrders.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîç</div>
            <div>–ó–∞–∫–∞–∑–æ–≤ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
          </div>
        `;
        document.getElementById('ordersCount').textContent = '0 –∑–∞–∫–∞–∑–æ–≤';
        return;
      }
      
      const count = filteredOrders.length;
      document.getElementById('ordersCount').textContent = `${count} ${count === 1 ? '–∑–∞–∫–∞–∑' : count < 5 ? '–∑–∞–∫–∞–∑–∞' : '–∑–∞–∫–∞–∑–æ–≤'}`;
      
      const now = Date.now();
      const oneDayAgo = now - 24 * 60 * 60 * 1000;
      
      const statusColors = {
        '–ù–æ–≤—ã–π': '#17a2b8',
        '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ': '#ffc107',
        '–î–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è': '#007bff',
        '–î–æ—Å—Ç–∞–≤–ª–µ–Ω': '#28a745',
        '–û—Ç–º–µ–Ω—ë–Ω': '#dc3545'
      };
      
      listEl.innerHTML = filteredOrders.map(order => {
        const profit = Math.round((order.total || 0) * 0.02);
        const date = order.time || new Date(order.timestamp).toLocaleString();
        const statusColor = statusColors[order.status] || '#666';
        const isRecent = (order.timestamp || 0) > oneDayAgo;
        
        let itemsHtml = '';
        const itemsCount = order.items ? order.items.length : 0;
        if (order.items && order.items.length > 0) {
          itemsHtml = `<div class="order-items" id="items_${order.id}">
            <div class="order-items-title">üì¶ –¢–æ–≤–∞—Ä—ã:</div>
            ${order.items.map(item => `
              <div class="order-item">
                <span>${item.title || '–¢–æ–≤–∞—Ä'}</span>
                <span>${item.qty} √ó ${item.price} = <strong>${((item.price || 0) * (item.qty || 0)).toLocaleString()}</strong> —Å–æ–º</span>
              </div>
            `).join('')}
          </div>`;
        }
        
        return `
          <div class="order-card ${isRecent ? 'recent' : ''}" style="border-left-color:${statusColor};">
            <div class="order-header">
              <div class="order-client">
                <div class="order-client-name">
                  ${order.name || '–ö–ª–∏–µ–Ω—Ç'}
                  ${isRecent ? '<span style="background:#ff5722; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:8px;">üÜï –ù–û–í–´–ô</span>' : ''}
                </div>
                <div class="order-client-phone">üì± ${order.phone || ''}</div>
                <div class="order-client-address">üìç ${order.address || ''}</div>
              </div>
              <div class="order-meta">
                <div class="order-date">${date}</div>
                <div class="order-status" style="background:${statusColor};">${order.status || '–ù–æ–≤—ã–π'}</div>
              </div>
            </div>
            ${itemsHtml}
            <div class="order-footer">
              <div class="order-total">
                –°—É–º–º–∞: <strong>${(order.total || 0).toLocaleString()} —Å–æ–º</strong>
              </div>
              <div class="order-actions">
                ${itemsCount > 0 ? `<button class="order-btn purple" onclick="toggleItems('${order.id}')">üëÅÔ∏è –¢–æ–≤–∞—Ä—ã (${itemsCount})</button>` : ''}
                <div class="order-profit">+${profit.toLocaleString()} —Å–æ–º</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä—ã
    function toggleItems(orderId) {
      const el = document.getElementById('items_' + orderId);
      if (el) {
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function updateStats() {
      let totalSum = 0;
      let totalOrders = filteredOrders.length;
      const uniqueClients = new Set();
      
      filteredOrders.forEach(order => {
        totalSum += order.total || 0;
        if (order.phone) uniqueClients.add(order.phone);
      });
      
      const totalProfit = Math.round(totalSum * 0.02);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–ø–ª–∞—Ç—ã
      let totalPaid = 0;
      if (currentAgent && currentAgent.id) {
        try {
          const payoutsSnapshot = await db.collection('agentPayouts')
            .where('agentId', '==', currentAgent.id)
            .get();
          
          payoutsSnapshot.forEach(doc => {
            totalPaid += doc.data().amount || 0;
          });
        } catch(e) {
          console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–ø–ª–∞—Ç—ã:', e);
        }
      }
      
      const balance = totalProfit - totalPaid;
      
      document.getElementById('statOrders').textContent = totalOrders;
      document.getElementById('statSum').textContent = totalSum.toLocaleString();
      document.getElementById('statClients').textContent = uniqueClients.size;
      document.getElementById('statProfit').textContent = totalProfit.toLocaleString();
      document.getElementById('statPaid').textContent = totalPaid.toLocaleString();
      document.getElementById('statBalance').textContent = balance.toLocaleString();
    }
    
    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
    function drawChart() {
      const canvas = document.getElementById('profitChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–Ω—è–º
      const dailyData = {};
      filteredOrders.forEach(order => {
        const timestamp = order.timestamp || order.createdAt || order.date;
        if (!timestamp) return;
        
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return;
        
        const dateKey = date.toISOString().split('T')[0];
        if (!dailyData[dateKey]) {
          dailyData[dateKey] = 0;
        }
        dailyData[dateKey] += Math.round((order.total || 0) * 0.02);
      });
      
      const sortedDates = Object.keys(dailyData).sort();
      
      if (sortedDates.length === 0) {
        if (profitChart) {
          profitChart.destroy();
          profitChart = null;
        }
        document.getElementById('profitChart').parentElement.innerHTML = `
          <h3 class="chart-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–∏–±—ã–ª–∏</h3>
          <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:150px; color:#999;">
            <div style="font-size:40px; margin-bottom:10px;">üìä</div>
            <div style="font-size:14px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
          </div>
        `;
        return;
      }
      
      const labels = sortedDates.map(d => {
        const date = new Date(d);
        return date.getDate() + '.' + (date.getMonth() + 1);
      });
      const data = sortedDates.map(d => dailyData[d]);
      
      if (profitChart) {
        profitChart.destroy();
      }
      
      profitChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '–ü—Ä–∏–±—ã–ª—å (—Å–æ–º)',
            data: data,
            borderColor: '#9c27b0',
            backgroundColor: 'rgba(156, 39, 176, 0.1)',
            tension: 0.3,
            fill: true,
            pointRadius: 4,
            pointBackgroundColor: '#9c27b0'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value + ' —Å–æ–º';
                }
              }
            }
          }
        }
      });
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤
    function showClients() {
      const modal = document.getElementById('clientsModal');
      const listEl = document.getElementById('clientsList');
      
      modal.style.display = 'flex';
      
      // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
      const clientsMap = new Map();
      
      filteredOrders.forEach(order => {
        const phone = order.phone;
        if (phone) {
          if (!clientsMap.has(phone)) {
            clientsMap.set(phone, {
              name: order.name || '–ë–µ–∑ –∏–º–µ–Ω–∏',
              phone: phone,
              ordersCount: 1,
              totalSum: order.total || 0
            });
          } else {
            const client = clientsMap.get(phone);
            client.ordersCount++;
            client.totalSum += order.total || 0;
          }
        }
      });
      
      const clients = Array.from(clientsMap.values()).sort((a, b) => b.ordersCount - a.ordersCount);
      
      if (clients.length === 0) {
        listEl.innerHTML = '<div class="empty-state">–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</div>';
        return;
      }
      
      listEl.innerHTML = clients.map(client => {
        const profit = Math.round(client.totalSum * 0.02);
        return `
          <div class="client-card">
            <div class="client-name">üë§ ${client.name}</div>
            <div class="client-phone">üìû <a href="tel:${client.phone}" style="color:#2196f3; text-decoration:none;">${client.phone}</a></div>
            <div class="client-stats">
              <span>üì¶ ${client.ordersCount} ${client.ordersCount === 1 ? '–∑–∞–∫–∞–∑' : client.ordersCount < 5 ? '–∑–∞–∫–∞–∑–∞' : '–∑–∞–∫–∞–∑–æ–≤'}</span>
              <span>üíµ ${client.totalSum.toLocaleString()} —Å–æ–º</span>
              <span style="color:#4caf50; font-weight:600;">üí∞ ${profit.toLocaleString()} —Å–æ–º</span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤
    function closeClientsModal() {
      document.getElementById('clientsModal').style.display = 'none';
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞
    function exportReport() {
      if (!currentAgent || filteredOrders.length === 0) {
        Swal.fire('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', '–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'info');
        return;
      }
      
      let csv = '–î–∞—Ç–∞,–ö–ª–∏–µ–Ω—Ç,–¢–µ–ª–µ—Ñ–æ–Ω,–ê–¥—Ä–µ—Å,–°—Ç–∞—Ç—É—Å,–°—É–º–º–∞,–ü—Ä–∏–±—ã–ª—å\n';
      
      filteredOrders.forEach(order => {
        const date = order.time || new Date(order.timestamp).toLocaleString();
        const name = (order.name || '–ö–ª–∏–µ–Ω—Ç').replace(/,/g, ' ');
        const phone = order.phone || '';
        const address = (order.address || '').replace(/,/g, ' ');
        const status = order.status || '–ù–æ–≤—ã–π';
        const total = order.total || 0;
        const profit = Math.round(total * 0.02);
        
        csv += `"${date}","${name}","${phone}","${address}","${status}",${total},${profit}\n`;
      });
      
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `agent_report_${currentAgent.name}_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      Swal.fire({
        icon: 'success',
        title: '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!',
        text: `–û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ${filteredOrders.length} –∑–∞–∫–∞–∑–æ–≤`,
        timer: 2000,
        showConfirmButton: false
      });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ—ë
    document.getElementById('clientsModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeClientsModal();
      }
    });
    
    // ==================== –†–ê–°–•–û–î–´ –ê–ì–ï–ù–¢–ê (–¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏) ====================
    
    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
    function openAgentExpenseModal() {
      document.getElementById('agentExpenseModal').style.display = 'flex';
      document.getElementById('agentExpenseDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('agentExpenseDesc').value = '';
      document.getElementById('agentExpenseAmount').value = '';
      setTimeout(() => document.getElementById('agentExpenseDesc').focus(), 200);
    }
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
    function closeAgentExpenseModal() {
      document.getElementById('agentExpenseModal').style.display = 'none';
    }
    
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
    async function saveAgentExpense() {
      if (!currentAgent) return;
      
      const description = document.getElementById('agentExpenseDesc').value.trim();
      const amount = parseFloat(document.getElementById('agentExpenseAmount').value);
      const date = document.getElementById('agentExpenseDate').value;
      
      if (!description) {
        Swal.fire('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ –∑–∞ —á—Ç–æ —Ä–∞—Å—Ö–æ–¥', 'warning');
        return;
      }
      if (!amount || amount <= 0) {
        Swal.fire('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', 'warning');
        return;
      }
      if (!date) {
        Swal.fire('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É', 'warning');
        return;
      }
      
      try {
        Swal.fire({ title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        
        await db.collection('agentExpenses').add({
          agentId: currentAgent.id,
          agentName: currentAgent.name,
          description: description,
          amount: amount,
          date: date,
          timestamp: new Date(date).getTime(),
          createdAt: Date.now()
        });
        
        closeAgentExpenseModal();
        Swal.fire({
          icon: 'success',
          title: '–ó–∞–ø–∏—Å–∞–Ω–æ!',
          text: `–†–∞—Å—Ö–æ–¥ "${description}" ‚Äî ${amount.toLocaleString()} —Å–æ–º`,
          timer: 2000,
          showConfirmButton: false
        });
        
        loadAgentExpenses();
      } catch(e) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞:', e);
        Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥', 'error');
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –∞–≥–µ–Ω—Ç–∞
    async function loadAgentExpenses() {
      if (!currentAgent) return;
      
      try {
        const snapshot = await db.collection('agentExpenses')
          .where('agentId', '==', currentAgent.id)
          .get();
        
        let expenses = [];
        snapshot.forEach(doc => expenses.push({ id: doc.id, ...doc.data() }));
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–±–µ–∑ orderBy –≤ –∑–∞–ø—Ä–æ—Å–µ –Ω–µ –Ω—É–∂–µ–Ω —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å)
        expenses.sort((a, b) => (b.timestamp || b.createdAt || 0) - (a.timestamp || a.createdAt || 0));
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É
        const period = document.getElementById('agentExpensePeriod').value;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStart = today.getTime();
        
        expenses = expenses.filter(exp => {
          const t = exp.timestamp || exp.createdAt || 0;
          switch(period) {
            case 'today': return t >= todayStart;
            case 'week':
              const ws = new Date(today); ws.setDate(ws.getDate() - ws.getDay());
              return t >= ws.getTime();
            case 'month':
              return t >= new Date(today.getFullYear(), today.getMonth(), 1).getTime();
            case 'all': return true;
            default: return true;
          }
        });
        
        const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        document.getElementById('agentExpensesTotal').textContent = totalExpenses.toLocaleString() + ' —Å–æ–º';
        
        const listEl = document.getElementById('agentExpensesList');
        
        if (expenses.length === 0) {
          listEl.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üìù</div>
              <div>–†–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç</div>
              <div style="font-size:13px; color:#999; margin-top:8px;">–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Å—é–¥–∞ —Ä–∞—Å—Ö–æ–¥—ã: –±–µ–Ω–∑–∏–Ω, –æ–±–µ–¥, —Å–≤—è–∑—å –∏ —Ç.–¥.</div>
            </div>
          `;
          return;
        }
        
        listEl.innerHTML = expenses.map(exp => {
          const d = new Date(exp.timestamp || exp.createdAt);
          const dateStr = d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' });
          return `
            <div class="expense-card">
              <div class="expense-info">
                <div class="expense-desc">${exp.description}</div>
                <div class="expense-date-text">üìÖ ${dateStr}</div>
              </div>
              <div class="expense-amount">${exp.amount.toLocaleString()} —Å–æ–º</div>
              <button class="expense-delete-btn" onclick="deleteAgentExpense('${exp.id}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            </div>
          `;
        }).join('');
        
      } catch(e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∞–≥–µ–Ω—Ç–∞:', e);
        // –ï—Å–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
        const listEl = document.getElementById('agentExpensesList');
        if (listEl) {
          listEl.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üìù</div>
              <div>–†–∞—Å—Ö–æ–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
            </div>
          `;
        }
      }
    }
    
    // –£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
    async function deleteAgentExpense(id) {
      const result = await Swal.fire({
        title: '–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Ö–æ–¥?',
        text: '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞',
        confirmButtonColor: '#dc3545'
      });
      
      if (result.isConfirmed) {
        try {
          await db.collection('agentExpenses').doc(id).delete();
          Swal.fire({ icon: 'success', title: '–£–¥–∞–ª–µ–Ω–æ!', timer: 1500, showConfirmButton: false });
          loadAgentExpenses();
        } catch(e) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', e);
          Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'error');
        }
      }
    }
    
    // ==================== –ö–û–ù–ï–¶ –†–ê–°–•–û–î–û–í –ê–ì–ï–ù–¢–ê ====================
    
    // –ó–∞–ø—É—Å–∫
    document.addEventListener('DOMContentLoaded', init);
  </script>
<script src="js/bottom-nav.js?v=20"></script>
</body>
</html>
