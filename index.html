<!DOCTYPE html>

<html lang="ru">

<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="–•–æ–∑—Ç–æ–≤–∞—Ä—ã –∏ –º–µ–ª–æ—á–∏ –æ–ø—Ç–æ–º –≤ –ö–∞—Ä–∞-–°—É—É. –î–æ—Å—Ç–∞–≤–∫–∞, –Ω–∏–∑–∫–∏–µ —Ü–µ–Ω—ã.">
  <meta name="google-site-verification" content="KwaNctZFk2BMTScsvlO77JIV6KN4daZPJXP9XRcin9Q" />
  <link rel="icon" type="image/jpeg" href="photo_5294190093549636589_y.jpg">
  <title>B2B Market</title>
  <style>
    /* –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫: –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è, —á—Ç–æ–±—ã –ø–æ–º–µ—â–∞–ª–æ—Å—å –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤ */
    .product-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:8px; padding:6px; }
  .product-card { background:#fff; border-radius:6px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 1px 6px rgba(0,0,0,0.06); transition:transform .14s, box-shadow .14s; }
  .product-card:hover { transform: translateY(-6px); box-shadow:0 8px 24px rgba(0,0,0,0.12); }
  /* –ë–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ñ–æ—Ç–æ: —á—É—Ç—å –º–µ–Ω—å—à–µ –ø–æ –≤—ã—Å–æ—Ç–µ, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
  .product-card .card-image { width:100%; aspect-ratio:4/3; max-height:140px; overflow:hidden; background:#f8f8f8; display:flex; align-items:center; justify-content:center; padding:6px; }
  .product-card .card-image img { width:100%; height:100%; object-fit:contain; display:block; }
  .product-card .card-body { padding:6px; display:flex; flex-direction:column; gap:6px; }
  .card-title { font-size:13px; color:#222; min-height:36px; }
  .card-price { font-size:16px; color:#e53935; font-weight:700; }
  .card-oldprice { font-size:13px; color:#888; text-decoration:line-through; margin-left:8px; }
  /* ratings removed */
  .card-badges { display:flex; gap:6px; flex-wrap:wrap; }
  .card-badge { background:#ffefdb; color:#b05b00; padding:4px 6px; border-radius:4px; font-size:12px; }
  .card-actions { display:flex; gap:8px; align-items:center; }
  .card-actions button { background:linear-gradient(90deg,#ff7a00,#ff3b00); color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
  @media (max-width:700px){
  /* –ù–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö ‚Äî –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ –∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ñ–æ—Ç–æ */
  .product-grid{grid-template-columns: repeat(2,1fr); gap:6px;}
  .product-card .card-image{max-height:90px; aspect-ratio:1/1;}
  .product-card .card-image { width:100%; aspect-ratio:4/3; max-height:110px; overflow:hidden; background:#f8f8f8; display:flex; align-items:center; justify-content:center; padding:6px; }
  .product-card .card-image{max-height:90px; aspect-ratio:1/1;}
    .card-actions .card-qty-input { padding:8px !important; font-size:14px !important; width:70px !important; align-self:center !important; }
    .card-actions .card-qty-input::-webkit-outer-spin-button, .card-actions .card-qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .admin-product-btn { font-size:1.12rem; padding:12px 10px; border-radius:12px; width:auto; }
  }


  @media (max-width:420px){
    /* –û—á–µ–Ω—å —É–∑–∫–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã: –¥–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∏ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ */
    .product-grid{grid-template-columns: repeat(2,1fr); gap:6px;}
    .card-actions { flex-direction: row; gap:8px; align-items:center; justify-content:space-between; }
    .card-actions .card-qty-input { padding:10px !important; font-size:16px !important; width:60px !important; }
    .card-actions button { padding:12px 14px !important; font-size:16px !important; border-radius:10px !important; width:auto !important; display:inline-block !important; }
    .admin-product-btn { width:100% !important; }
  }

  </style>

  <!-- Firebase SDKs: app first, then compat modules -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- jsPDF –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- ExcelJS –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  
  <!-- SheetJS (XLSX) –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
@media (max-width: 600px) {
  .admin-product-input {
    font-size: 1.1rem;
    padding: 12px 10px;
    width: 100% !important;
    min-width: 0;
    margin: 6px 0;
    border-radius: 12px;
  }
  .admin-product-btn {
    font-size: 1.1rem;
    padding: 14px 0;
    width: 100%;
    margin: 6px 0;
    border-radius: 12px;
    min-width: 0;
    display: block;
  }
  .admin-product-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
    border-radius: 14px;
    box-shadow: 0 2px 12px #007bff22;
    padding: 8px 0;
  }
  td, th {
    font-size: 1rem;
    padding: 8px 4px;
  }
}
/* --- –ö—Ä–∞—Å–∏–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞ --- */
.admin-product-input {
  border: 2px solid #90bfff;
  border-radius: 8px;
  background: #fafdff;
  padding: 7px 10px;
  font-size: 1rem;
  margin: 2px 0;
  transition: border 0.2s, box-shadow 0.2s;
  box-shadow: 0 1px 6px #007bff11;
}
.admin-product-input:focus {
  border: 2px solid #007bff;
  box-shadow: 0 2px 12px #007bff33;
  background: #eaf4ff;
}
.admin-product-btn {
  background: linear-gradient(90deg,#007bff 60%,#00c6ff 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 18px;
  font-size: 1rem;
  margin: 2px 2px;
  cursor: pointer;
  box-shadow: 0 2px 8px #007bff22;
  transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
}
.admin-product-btn:hover {
  background: linear-gradient(90deg,#0056b3 60%,#00aaff 100%);
  box-shadow: 0 4px 16px #007bff33;
  transform: scale(1.04);
}
.admin-product-row {
  background: #f0f7ff;
  border-radius: 10px;
  box-shadow: 0 2px 8px #007bff11;
}
.order-form #cartList {
  background: #fafdff;
  border: 2px solid #90bfff;
  border-radius: 12px;
  box-shadow: 0 2px 8px #007bff11;
  padding: 8px 0 8px 0;
  position: relative;
}
.cart-scroll-hint {
  text-align: center;
  color: #007bff;
  font-size: 13px;
  margin-bottom: 4px;
  font-style: italic;
  letter-spacing: 0.5px;
}
/* –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã */
.cart-item-removing {
  opacity: 0;
  max-height: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
  transition: opacity 0.3s, max-height 0.3s, margin 0.3s, padding 0.3s;
  overflow: hidden;
}
.order-form #cartList {
  max-height: 220px;
  overflow-y: auto;
  margin-bottom: 10px;
}
@media (max-width: 600px) {
  .order-form #cartList {
    max-height: 320px;
  }
}
.cart-item .delete-item {
  background: #dc3545 !important;
  color: #fff !important;
  border: none;
  font-size: 20px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin-left: 8px;
  transition: background 0.2s;
}
.cart-item .delete-item:hover {
  background: #b71c1c !important;
}
@media (max-width: 600px) {
  .cart-item .delete-item {
    display: block;
    width: 100% !important;
    height: 44px !important;
    font-size: 2rem;
    margin: 8px 0 0 0;
    border-radius: 12px;
  }
}


.search-sort-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  width: 100%;
  max-width: 600px;
  }

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
.category-tabs {
  display: flex;
  gap: 10px;
  margin: 10px auto 15px;
  max-width: 1200px;
  padding: 0 8px;
  flex-wrap: wrap;
  justify-content: center;
}
.category-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.category-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}
.category-btn.active {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  box-shadow: 0 6px 12px rgba(245,87,108,0.4);
}
@media (max-width: 600px) {
  .category-tabs {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    column-gap: 6px;
    row-gap: 0px;
    padding: 0 8px;
    margin: 8px auto 12px;
  }
  .category-btn {
    padding: 10px 8px;
    font-size: 14px;
    width: 100%;
    min-width: 0;
    margin: 0;
  }
}
/* --- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–∞–∫ –Ω–∞ https://kara-ssyy-oomat.github.io/meloch/ --- */
* { box-sizing: border-box; margin: 0; padding: 0; }
* {
  -webkit-tap-highlight-color: transparent;
}

html {
  overflow-x: hidden;
  overflow-y: scroll !important;
  -webkit-overflow-scrolling: touch;
  height: auto;
  min-height: 100%;
  touch-action: pan-y !important;
}

body {
  font-family: 'Arial', sans-serif;
  background: #FFF9E5;
  color: #333;
  overflow-x: hidden;
  overflow-y: visible !important;
  -webkit-overflow-scrolling: touch;
  min-height: 100vh;
  position: relative;
  margin: 0;
  padding: 0;
  touch-action: pan-y !important;
}

/* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑—É–º–∞ –Ω–∞ iOS –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ input */
input, select, textarea {
  font-size: 16px !important;
}

/* –ö–ª–∞—Å—Å –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∫—Ä–æ–ª–ª–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö */
body.modal-open {
  overflow: hidden !important;
  position: fixed !important;
  width: 100% !important;
  height: 100% !important;
  top: 0 !important;
  left: 0 !important;
}
h1, h2 {
  text-align: center;
  margin-bottom: 20px;
  animation: fadeIn 1s ease forwards;
  color: #fff;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 8px;
}
.search-sort-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  width: 100%;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}
.search-sort-row input,
.search-sort-row select,
.search-sort-row .other-site-btn {
  flex: 1 1 0;
  width: 100%;
  max-width: none;
  box-sizing: border-box;
  margin: 10px auto;
}
.other-site-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #007bff;
  color: #fff !important;
  text-align: center;
  padding: 10px 0;
  border-radius: 5px;
  text-decoration: none;
  transition: background 0.2s;
  font-weight: bold;
  height: 100%;
}
.other-site-btn:hover {
  background: #0056b3;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  background: white;
  box-shadow: 0 0 10px #ccc;
  overflow-x: auto;
  display: block;
  border-radius: 12px;
}
thead th {
  position: sticky;
  top: 0;
  background: #00fff7;
  z-index: 2;
}
th, td {
  padding: 10px;
  border: 1px solid #ddd;
  text-align: center;
  font-size: 15px;
}
th:nth-child(5), td:nth-child(5) {
  min-width: 90px;
  width: 80px;
}
.product-img {
  max-width: 60px;
  height: auto;
  transition: transform 0.2s, box-shadow 0.2s;
  border-radius: 8px;
}
.product-img:hover {
  transform: scale(1.08);
  box-shadow: 0 4px 16px #0002;
}
.cart-item {
  display: flex;
  align-items: center;
  gap: 0;
  margin-bottom: 8px;
  padding: 4px 0;
  border-bottom: 1px solid #f0f0f0;
}
.cart-item-compact {
  gap: 0;
  padding: 2px 0;
  min-height: 40px;
  align-items: center;
}
.cart-mini-img {
  width: 24px;
  height: 24px;
  object-fit: cover;
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #f8f8f8;
  box-shadow: 0 1px 4px #0001;
  display: block;
}
.cart-title {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.cart-qty, .cart-price, .cart-sum {
  margin: 0 8px;
  white-space: nowrap;
}
.cart-sum {
  font-weight: bold;
}
.cart-item-compact {
  gap: 0;
  padding: 2px 0;
  min-height: 36px;
}
.cart-mini-img {
  width: 32px;
  height: 32px;
  object-fit: cover;
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #f8f8f8;
  box-shadow: 0 1px 4px #0001;
}
.cart-title {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.cart-qty, .cart-price, .cart-sum {
  margin: 0 8px;
  white-space: nowrap;
}
.cart-sum {
  font-weight: bold;
}
.order-form, #orderHistory {
  background: #cce4ff;
  padding: 22px 18px 22px 18px;
  border-radius: 16px;
  box-shadow: 0 4px 24px #007bff22, 0 1.5px 0 #007bff inset;
  margin-top: 20px;
}
input, select, button, textarea {
  font-size: 1rem;
  padding: 10px;
  margin: 10px auto;
  width: 100%;
  max-width: 400px;
  display: block;
  border-radius: 5px;
  border: 1px solid #ccc;
}
button, .other-site-btn {
  border-radius: 8px;
  box-shadow: 0 2px 8px #0001;
  transition: background 0.2s, color 0.2s;
}
button:active {
  transform: scale(0.97);
}
button {

  background: #28a745;
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

  button:hover { background: #218838; }
.delete-order {
  background: #dc3545;
  color: white;
  border: none;
  padding: 8px 12px;
  margin-bottom: 6px;
  margin-top: 10px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.3s ease;
}
  /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –≤—Å—ë –Ω–∏–∂–µ –æ–±—ë—Ä–Ω—É—Ç–æ –≤ .cart-mini-img */

.cart-mini-img {
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #fff;
  box-shadow: 0 1px 4px #007bff33;
  display: block;
  border: 2px solid #007bff;
}

button.delete-item:hover {
  color: #c82333;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes addToCart {
  0% { transform: scale(1); background-color: #28a745; }
  50% { transform: scale(1.2); background-color: #218838; }
  100% { transform: scale(1); background-color: #28a745; }
}
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}
@keyframes slideInRight {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOutRight {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(400px); opacity: 0; }
}
.animate-add {
  animation: addToCart 0.5s ease;
}
@media (max-width: 600px) {
  body {
    font-size: 1.05rem;
    padding-bottom: 60px;
  }
  .container {
    max-width: 100vw;
    padding: 0 2vw;
  }
  .order-form, #orderHistory {
    padding: 10px 2vw;
    margin-top: 10px;
    box-shadow: 0 2px 8px #0001;
    border-radius: 10px;
  }
  .order-form input, .order-form button {
    width: 100%;
    min-height: 44px;
    font-size: 1rem;
    margin-bottom: 10px;
  }
  .search-sort-row {
    flex-direction: column;
    gap: 0;
    max-width: 100vw;
    padding: 0 2vw;
  }
  .other-site-btn {
    font-size: 1rem;
    padding: 12px 0;
    margin-top: 8px;
    border-radius: 8px;
  }
  table {
    display: block;
    width: 100vw;
    overflow-x: auto;
    border-radius: 10px;
    box-shadow: 0 2px 8px #0001;
  }
  thead, tbody, tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    font-size: 13px;
    padding: 7px 4px;
    min-width: 70px;
    word-break: break-word;
  }
  th:nth-child(2), td:nth-child(2) {
    min-width: 60px;
    max-width: 70px;
  }
  .product-img {
    max-width: 70px;
    min-width: 44px;
    width: 100%;
    height: auto;
    display: block;
    margin: 0 auto 6px auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px #007bff22;
    background: #fff;
    object-fit: contain;
  }
  .cart-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    font-size: 0.98rem;
  }
  .cart-summary {
    font-size: 1.1rem;
    margin: 8px 0;
  }
  #cartList div {
    font-size: 0.98rem;
    padding: 4px 0;
  }
  button, .order-form button, .other-site-btn {
    min-height: 44px;
    font-size: 1rem;
    padding: 10px 0;
  }
  .scroll-buttons {
    right: 10px;
    bottom: 10px;
    gap: 6px;
  }
  .scroll-buttons button {
    font-size: 18px;
    padding: 10px 14px;
    border-radius: 12px;
  }
  #previewInner {
    width: 96vw !important;
    left: 2vw !important;
    transform: none !important;
    padding: 6vw 2vw !important;
  }
  #previewImg {
    max-width: 92vw !important;
    max-height: 60vh !important;
  }
  #toggleHistory, #logoutUser {
    width: 100%;
    min-height: 44px;
    font-size: 1rem;
    margin: 8px 0;
  }
  #orderHistory h2 {
    font-size: 1.1rem;
    margin-bottom: 10px;
  }
  #historyList li {
  font-size: 0.98rem;
  margin-bottom: 10px;
  padding: 8px 4px;
  border-radius: 8px;
  box-shadow: 0 1px 4px #0001;
}
}

@keyframes addToCart {
  0% { transform: scale(1); background-color: #28a745; }
  50% { transform: scale(1.2); background-color: #218838; }
  100% { transform: scale(1); background-color: #28a745; }
}

    .animate-add {

      animation: addToCart 0.5s ease;

    }



    @media (max-width: 600px) {

      th, td { font-size: 12px; padding: 6px; }

      input, select, button, textarea { font-size: 0.9rem; padding: 8px; }

      .cart-summary { font-size: 1.2rem; }

      #cartList div { font-size: 0.9rem; }

      .order-form input, .order-form button { width: 90%; }

    }
    @media (max-width: 600px) {
  button.delete-item {
    width: 20px; /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É */
    height: 20px; /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É */
    font-size: 12px; /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ */
    padding: 0; /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
  }
}

    @media (max-width: 600px) {
  th, td { font-size: 12px; padding: 6px; }
  input, select, button, textarea { font-size: 0.9rem; padding: 8px; }
  .cart-summary { font-size: 1.2rem; }
  #cartList div { font-size: 0.9rem; }
  .order-form input, .order-form button { width: 90%; }
  button.delete-item {
    width: 20px;
    height: 20px;
    font-size: 12px;
    padding: 0;
  }
}

  </style>
      



  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
// –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
async function updateProductTitle(productId, newTitle) {
  try {
    await db.collection('products').doc(productId).update({ title: newTitle });
    Swal.fire('–£—Å–ø–µ—Ö!', '–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
    loadProducts();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞
async function updateProductCategory(productId, newCategory) {
  try {
    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', productId, '–Ω–∞', newCategory);
    await db.collection('products').doc(productId).update({ category: newCategory });
    console.log('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
    await loadProducts(); // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
    console.log('–¢–æ–≤–∞—Ä—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    Swal.fire('–£—Å–ø–µ—Ö!', `–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ "${newCategory}"`, 'success');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é', 'error');
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞
async function updateProductPrice(productId, newPrice) {
  try {
    const price = parseFloat(newPrice);
    if (isNaN(price) || price < 0) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É', 'error');
      return;
    }
    await db.collection('products').doc(productId).update({ price: price });
    await loadProducts();
    Swal.fire('–£—Å–ø–µ—Ö!', '–¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É', 'error');
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É –∑–∞–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞
async function updateProductCostPrice(productId, newCostPrice) {
  try {
    const costPrice = parseFloat(newCostPrice);
    if (isNaN(costPrice) || costPrice < 0) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É –∑–∞–∫—É–ø–∫–∏', 'error');
      return;
    }
    await db.collection('products').doc(productId).update({ costPrice: costPrice });
    await loadProducts();
    Swal.fire('–£—Å–ø–µ—Ö!', '–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã –∑–∞–∫—É–ø–∫–∏:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É –∑–∞–∫—É–ø–∫–∏', 'error');
  }
}

// –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Ç–æ–≤–∞—Ä–∞
async function changeProductImage(productId) {
  console.log('changeProductImage –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞:', productId);
  
  // –°–æ–∑–¥–∞–µ–º input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª:', file.name);
    
    try {
      Swal.fire({
        title: '–ó–∞–≥—Ä—É–∑–∫–∞...',
        text: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ Cloudinary
      console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ Cloudinary:', file.name);
      const downloadURL = await uploadToCloudinary(file);
      console.log('URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:', downloadURL);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      await db.collection('products').doc(productId).update({ image: downloadURL });
      console.log('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
      
      await loadProducts();
      Swal.fire('–£—Å–ø–µ—Ö!', '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:', error);
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ: ' + error.message, 'error');
    }
  };
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
  input.click();
}

// –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä
async function toggleProductBlock(productId, currentStatus) {
  try {
    await db.collection('products').doc(productId).update({ blocked: !currentStatus });
    Swal.fire('–£—Å–ø–µ—Ö!', !currentStatus ? '–¢–æ–≤–∞—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–¢–æ–≤–∞—Ä —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
    loadProducts();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏', 'error');
  }
}

</script>

</head>

<body>
  <!-- –ö–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã -->
  <button id="cartFloatBtn" style="position:fixed;left:20px;bottom:20px;z-index:9999;background:#007bff;color:#fff;border:none;border-radius:50%;width:56px;height:56px;box-shadow:0 2px 12px #007bff44;display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;transition:background 0.2s;">
    <span id="cartFloatCount" style="position:absolute;top:6px;right:8px;background:#dc3545;color:#fff;border-radius:50%;padding:2px 7px;font-size:14px;font-weight:bold;min-width:22px;text-align:center;">0</span>
    üõí
  </button>

  <!-- –ë–ª–æ–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ -->
  <div id="previewBlock" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:10000; pointer-events:auto; background: rgba(0,0,0,0.85);">
    <div id="previewInner" style="position:relative; background:white; padding:12px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5); max-width:95vw; max-height:95vh; display:flex; flex-direction:column; align-items:center;">
      <span id="closePreview" style="position:absolute; top:8px; right:8px; cursor:pointer; font-size:28px; background:#eee; width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:50%; z-index:10;">&times;</span>
      <div style="text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%;">
        <img id="previewImg" src="" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä" style="max-width:90vw; max-height:80vh; display:block; object-fit:contain;">
        <div id="previewCaption" style="margin-top:12px; font-size:14px; color:#333; font-weight:500;"></div>
      </div>
    </div>
  </div>
<!-- filepath: c:\Users\hp\Desktop\–Ω–æ–∂\index.html -->

  <!-- –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é (–≥–∞–º–±—É—Ä–≥–µ—Ä) –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
  <button id="menuToggleBtn" onclick="toggleSideMenu()" style="position:fixed; top:15px; left:15px; z-index:10001; width:45px; height:45px; background:white; border:none; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15); cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px; padding:10px; transition:all 0.3s;">
    <span style="width:25px; height:3px; background:#333; border-radius:2px; transition:all 0.3s;"></span>
    <span style="width:25px; height:3px; background:#333; border-radius:2px; transition:all 0.3s;"></span>
    <span style="width:25px; height:3px; background:#333; border-radius:2px; transition:all 0.3s;"></span>
  </button>

  <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
  <div id="sideMenu" style="position:fixed; top:0; left:-300px; width:280px; height:100vh; background:white; box-shadow:2px 0 10px rgba(0,0,0,0.1); z-index:10000; transition:left 0.3s ease; overflow-y:auto; padding:20px;">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ–Ω—é -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #f0f0f0;">
      <h2 style="margin:0; font-size:20px; color:#333;">üìã –ú–µ–Ω—é</h2>
      <button onclick="toggleSideMenu()" style="background:none; border:none; font-size:28px; cursor:pointer; color:#666; width:35px; height:35px; display:flex; align-items:center; justify-content:center;">&times;</button>
    </div>
    
    <!-- –ü—É–Ω–∫—Ç—ã –º–µ–Ω—é (–ø–æ–∫–∞ –ø—É—Å—Ç–æ, –≤—ã –¥–æ–±–∞–≤–∏—Ç–µ –ø–æ–∑–∂–µ) -->
    <div id="menuItems" style="display:flex; flex-direction:column; gap:10px;">
      <!-- –ß–∞—Ç —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º -->
      <button onclick="openChatFromMenu()" style="width:100%; padding:15px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600; display:flex; align-items:center; gap:10px; transition:transform 0.2s;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>üí¨ –ß–∞—Ç —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º</span>
      </button>
      
      <!-- –ñ–∞–ª–æ–±–∞ -->
      <button onclick="openComplaintWindow()" style="width:100%; padding:15px; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600; display:flex; align-items:center; gap:10px; transition:transform 0.2s;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <span>‚ö†Ô∏è –ñ–∞–ª–æ–±–∞</span>
      </button>
      
      <!-- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–æ–≤–∞—Ä -->
      <button onclick="openSuggestionWindow()" style="width:100%; padding:15px; background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600; display:flex; align-items:center; gap:10px; transition:transform 0.2s;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"></path>
        </svg>
        <span>üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–æ–≤–∞—Ä</span>
      </button>
      
      <!-- –í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
      <div id="menuAdminSection" style="margin-top:10px;">
        <div id="menuAdminLogin" style="display:flex; flex-direction:column; gap:8px;">
          <div style="font-size:14px; font-weight:600; color:#333; padding:5px 0; border-top:1px solid #e0e0e0; padding-top:15px;">üîê –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
          <input type="password" id="menuAdminPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" onkeypress="if(event.key==='Enter') loginAdminFromMenu()" style="padding:12px; border:1px solid #ddd; border-radius:8px; outline:none; font-size:14px;">
          <button onclick="loginAdminFromMenu()" style="width:100%; padding:12px; background:linear-gradient(90deg, #28a745, #20c997); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600;">–í–æ–π—Ç–∏</button>
        </div>
        
        <div id="menuAdminLoggedIn" style="display:none; flex-direction:column; gap:8px;">
          <div style="font-size:14px; font-weight:600; color:#28a745; padding:5px 0; border-top:1px solid #e0e0e0; padding-top:15px;">‚úÖ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω</div>
          <button onclick="openAddProductWindow()" style="width:100%; padding:12px; background:linear-gradient(90deg, #ff6b6b, #ee5a6f); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; justify-content:center;">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
          </button>
          <button onclick="openOrdersManagementWindow()" style="width:100%; padding:12px; background:linear-gradient(90deg, #f093fb, #f5576c); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; justify-content:center;">
            üì¶ –ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
          </button>
          <button onclick="openAdminChatWindow()" style="width:100%; padding:12px; background:linear-gradient(90deg, #667eea, #764ba2); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; justify-content:center;">
            üí¨ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏
          </button>
          <button onclick="openProfitReport()" style="width:100%; padding:12px; background:linear-gradient(90deg, #28a745, #20c997); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; justify-content:center;">
            üí∞ –û—Ç—á–µ—Ç –ø–æ –ø—Ä–∏–±—ã–ª–∏
          </button>
          <button onclick="logoutAdmin()" style="width:100%; padding:10px; background:#dc3545; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px;">–í—ã–π—Ç–∏</button>
        </div>
      </div>
      
    </div>
  </div>

  <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º –º–µ–Ω—é -->
  <div id="menuOverlay" onclick="toggleSideMenu()" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999;"></div>

  <!-- –û–∫–Ω–æ —á–∞—Ç–∞ (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑ –º–µ–Ω—é) -->
  <div id="chatWindow" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:white; z-index:10002; flex-direction:column; overflow:hidden;">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
      <div style="flex:1;">
        <div style="font-weight:bold; font-size:18px;">–ß–∞—Ç —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º</div>
        <div id="clientNameDisplay" style="font-size:12px; opacity:0.9; display:flex; align-items:center; gap:8px; margin-top:4px;">
          <span>–û–±—ã—á–Ω–æ –æ—Ç–≤–µ—á–∞–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞</span>
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <button onclick="changeClientName()" style="background:rgba(255,255,255,0.25); border:none; color:white; font-size:22px; cursor:pointer; padding:8px; border-radius:8px; width:45px; height:45px; display:flex; align-items:center; justify-content:center; transition:background 0.2s;" title="–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è" onmouseover="this.style.background='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'">
          ‚úèÔ∏è
        </button>
        <button onclick="toggleChat()" style="background:rgba(255,255,255,0.2); border:none; color:white; font-size:28px; cursor:pointer; padding:8px 12px; border-radius:8px; width:45px; height:45px; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>
    </div>
    
    <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="chatMessages" style="flex:1; overflow-y:auto; padding:16px; background:#f5f5f5; display:flex; flex-direction:column; gap:12px;">
      <div style="background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <div style="font-size:14px; color:#333;">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
        <div style="font-size:11px; color:#999; margin-top:4px;">–ü—Ä–æ–¥–∞–≤–µ—Ü ‚Ä¢ —Ç–æ–ª—å–∫–æ —á—Ç–æ</div>
      </div>
    </div>
    
    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
    <div style="padding:16px; background:white; border-top:1px solid #e0e0e0; display:flex; gap:12px; box-shadow:0 -2px 8px rgba(0,0,0,0.05);">
      <input id="chatInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; padding:14px 18px; border:1px solid #ddd; border-radius:24px; outline:none; font-size:16px;" onkeypress="if(event.key==='Enter') sendChatMessage()">
      <button onclick="sendChatMessage()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow:0 2px 8px rgba(102,126,234,0.4);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∂–∞–ª–æ–±—ã -->
  <div id="complaintWindow" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10002;">
    <div style="background:#fff; width:95%; max-width:500px; margin:10vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; max-height:80vh;">
      
      <!-- –®–∞–ø–∫–∞ -->
      <div style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">‚ö†Ô∏è –ñ–∞–ª–æ–±–∞</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É</p>
        </div>
        <button onclick="closeComplaintWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –§–æ—Ä–º–∞ -->
      <div style="flex:1; overflow-y:auto; padding:20px;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–í–∞—à–µ –∏–º—è:</label>
            <input type="text" id="complaintName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
            <input type="tel" id="complaintPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–¢–µ–º–∞ –∂–∞–ª–æ–±—ã:</label>
            <select id="complaintCategory" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
              <option value="quality">–ö–∞—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞</option>
              <option value="delivery">–ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π</option>
              <option value="service">–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</option>
              <option value="price">–ù–µ–≤–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞</option>
              <option value="other">–î—Ä—É–≥–æ–µ</option>
            </select>
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</label>
            <textarea id="complaintText" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É..." style="width:100%; min-height:120px; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px; resize:vertical;"></textarea>
          </div>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
      <div style="padding:20px; background:#f8f9fa; border-top:1px solid #e0e0e0;">
        <button onclick="sendComplaint()" style="width:100%; padding:14px; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
      </div>
    </div>
  </div>

  <!-- –û–∫–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
  <div id="suggestionWindow" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:500px; max-height:90vh; border-radius:16px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div style="background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–∞–º –æ —Ç–æ–≤–∞—Ä–µ, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –≤–∏–¥–µ—Ç—å</p>
        </div>
        <button onclick="closeSuggestionWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –§–æ—Ä–º–∞ -->
      <div style="flex:1; overflow-y:auto; padding:20px;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–í–∞—à–µ –∏–º—è:</label>
            <input type="text" id="suggestionName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
            <input type="tel" id="suggestionPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:</label>
            <input type="text" id="suggestionProductName" placeholder="–ö–∞–∫–æ–π —Ç–æ–≤–∞—Ä –≤—ã —Ö–æ—Ç–∏—Ç–µ –≤–∏–¥–µ—Ç—å?" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–ó–∞ —Å–∫–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å –ø–æ–∫—É–ø–∞–µ—Ç–µ:</label>
            <input type="number" id="suggestionCurrentPrice" placeholder="–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ —É –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ–¥–∞–≤—Ü–∞" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–ñ–µ–ª–∞–µ–º–∞—è —Ü–µ–Ω–∞:</label>
            <input type="number" id="suggestionPrice" placeholder="–ó–∞ —Å–∫–æ–ª—å–∫–æ –≤—ã –≥–æ—Ç–æ–≤—ã –∫—É–ø–∏—Ç—å?" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea id="suggestionDescription" placeholder="–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –¥–ª—è —á–µ–≥–æ –Ω—É–∂–µ–Ω —Ç–æ–≤–∞—Ä..." style="width:100%; min-height:120px; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px; resize:vertical;"></textarea>
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="file" id="suggestionPhoto" accept="image/*" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:white;">
            <p style="margin:5px 0 0; font-size:12px; color:#666;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –µ—Å–ª–∏ –æ–Ω–æ —É –≤–∞—Å –µ—Å—Ç—å</p>
          </div>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
      <div style="padding:20px; background:#f8f9fa; border-top:1px solid #e0e0e0;">
        <button id="suggestionSubmitBtn" onclick="sendSuggestion()" style="width:100%; padding:14px; background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
      </div>
      
      <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
      <div id="suggestionLoader" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:10; justify-content:center; align-items:center; flex-direction:column; border-radius:16px;">
        <div style="width:50px; height:50px; border:5px solid #e0e0e0; border-top:5px solid #43e97b; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:20px; color:#333; font-size:16px; font-weight:600;">–û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è...</p>
      </div>
    </div>
  </div>

  <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–µ –æ–∫–Ω–æ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ —á–∞—Ç–∞ -->
  <div id="adminChatWindow" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:white; z-index:10003; flex-direction:column; overflow:hidden;">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ —á–∞—Ç–∞ -->
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
      <div>
        <div style="font-weight:bold; font-size:18px;">üí¨ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</div>
        <div style="font-size:12px; opacity:0.9;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏</div>
      </div>
      <button onclick="closeAdminChatWindow()" style="background:rgba(255,255,255,0.2); border:none; color:white; font-size:28px; cursor:pointer; padding:8px 12px; border-radius:8px; width:45px; height:45px; display:flex; align-items:center; justify-content:center;">&times;</button>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="adminFullChatMessages" style="flex:1; overflow:hidden; background:#f8f9fa;">
      <div style="text-align:center; color:#999; padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    
    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
    <div style="padding:16px; background:white; border-top:1px solid #e0e0e0; display:flex; gap:12px; box-shadow:0 -2px 8px rgba(0,0,0,0.05);">
      <input id="adminFullChatInput" type="text" placeholder="–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞..." style="flex:1; padding:14px 18px; border:1px solid #ddd; border-radius:24px; outline:none; font-size:16px;" onkeypress="if(event.key==='Enter') sendAdminFullChatMessage()">
      <button onclick="sendAdminFullChatMessage()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow:0 2px 8px rgba(102,126,234,0.4);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ -->
  <div style="text-align:center; margin:20px 0 10px;">
    <h1 style="font-size:2.5rem; color:#007bff; margin:0; font-weight:900; text-shadow:2px 2px 4px rgba(0,0,0,0.1);">B2B Market</h1>
    <p style="font-size:0.9rem; color:#666; margin:5px 0 0;">–û–ø—Ç–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã –ø–æ –≤—ã–≥–æ–¥–Ω—ã–º —Ü–µ–Ω–∞–º</p>
  </div>

  <div id="contacts" style="text-align:center; margin:8px 0 12px;">
    <div style="font-weight:800; color:#003366; font-size:1.05rem; margin-bottom:6px;">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –Ω–æ–º–µ—Ä–∞: </div>
    <div style="display:flex;gap:8px;justify-content:center;">
      <a href="tel:+996555332133" style="display:inline-block; padding:6px 10px; background:rgba(0,123,255,0.12); color:#003366; border-radius:8px; text-decoration:none; font-weight:700;">0555 33 21 33</a>
      <a href="tel:+996559009860" style="display:inline-block; padding:6px 10px; background:rgba(0,123,255,0.12); color:#003366; border-radius:8px; text-decoration:none; font-weight:700;">0559 00 98 60</a>
    </div>
  </div>

  <!-- –í–µ—Ä—Ö–Ω–∏–π –ø—Ä–æ–º–æ-—Å–ª–∞–π–¥–µ—Ä: –¥–≤–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (swipe) -->
  <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ -->
  <div class="category-tabs">
    <button class="category-btn active" onclick="filterByCategory('–≤—Å–µ')">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
    <button class="category-btn" onclick="filterByCategory('–Ω–æ–∂–Ω–∏—Ü—ã')">–ù–æ–∂–Ω–∏—Ü—ã</button>
    <button class="category-btn" onclick="filterByCategory('—Å–∫–æ—Ç—á')">–°–∫–æ—Ç—á</button>
    <button class="category-btn" onclick="filterByCategory('–Ω–æ–∂')">–ù–æ–∂</button>
  </div>

  <div class="search-sort-row">
    <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." />
    <select id="sort">
      <option value="">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ</option>
      <option value="asc">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à—ë–≤—ã–µ</option>
      <option value="desc">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</option>
    </select>
  </div>



  <!-- –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
  <div id="productTable" class="product-grid"></div>



  <div class="order-form">

    <h2>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</h2>

    <div id="cartList"></div>

    <div class="cart-summary">–ò—Ç–æ–≥–æ: <span id="totalSum">0</span> —Å–æ–º</div>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤–Ω–∏–∑ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –∫–æ—Ä–∑–∏–Ω—ã -->
    <div style="display:flex;gap:8px;">
      <button id="openCartBtn" onclick="openCartPage()">–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
      <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã –±—É–¥–µ—Ç –≤ –ø–∞–Ω–µ–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã -->
    </div>

    <input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" required />

    <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required />

    <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" required />

    <button id="submitOrder">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>

  </div>

  <button id="logoutUser" style="margin:10px 0;">–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è</button>

  <div id="adminProductsBlock"></div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
  <div id="addProductWindow" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3000;">
    <div style="background:#fff; width:95%; max-width:600px; max-height:90vh; margin:5vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      
      <!-- –®–∞–ø–∫–∞ -->
      <div style="background:linear-gradient(90deg, #ff6b6b, #ee5a6f); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–µ</p>
        </div>
        <button onclick="closeAddProductWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –§–æ—Ä–º–∞ -->
      <div style="flex:1; overflow-y:auto; padding:20px;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞–º–∏ -->
          <div style="display:flex; gap:10px;">
            <button onclick="expandAllProducts()" style="flex:1; padding:10px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px;">‚ñº –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
            <button onclick="collapseAllProducts()" style="flex:1; padding:10px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px;">‚ñ≤ –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
          </div>

          <input type="text" id="newTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <input type="number" id="newCostPrice" placeholder="üíµ –¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏ (–∑–∞ —Å–∫–æ–ª—å–∫–æ –∫—É–ø–∏–ª–∏)" step="0.01" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <input type="number" id="newPrice" placeholder="üí∞ –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (—Ä–æ–∑–Ω–∏—á–Ω–∞—è)" step="0.01" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <div id="profitDisplay" style="padding: 12px; background: #e8f5e9; border-radius: 8px; display: none; text-align: center;">
            <strong>üìä –ù–∞—Ü–µ–Ω–∫–∞:</strong> <span id="profitAmount">0</span> —Å–æ–º (<span id="profitPercent">0</span>%)
          </div>
          
          <select id="newCategory" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
            <option value="–≤—Å–µ">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
            <option value="–Ω–æ–∂–Ω–∏—Ü—ã">–ù–æ–∂–Ω–∏—Ü—ã</option>
            <option value="—Å–∫–æ—Ç—á">–°–∫–æ—Ç—á</option>
            <option value="–Ω–æ–∂">–ù–æ–∂</option>
          </select>
          
          <input type="number" id="newOptPrice" placeholder="–û–ø—Ç–æ–≤–∞—è —Ü–µ–Ω–∞" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <input type="number" id="newOptQty" placeholder="–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –æ–ø—Ç–∞" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <input type="number" id="newMinQty" placeholder="–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <div style="display: flex; gap: 10px;">
            <input type="file" id="imageFile" accept="image/*" style="flex: 1; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <input type="file" id="galleryFile" accept="image/*" style="display: none;">
            <button id="openGallery" style="padding:10px 15px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;" onclick="document.getElementById('galleryFile').click()">üìÅ –ì–∞–ª–µ—Ä–µ—è</button>
          </div>
          
          <input type="text" id="newImage" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <button id="previewUrlBtn" style="padding:10px; background:#6c757d; color:white; border:none; border-radius:8px; cursor:pointer;">üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
          
          <div id="imagePreview" style="display: none; text-align:center; padding:10px; background:#f8f9fa; border-radius:8px;">
            <img id="previewImg" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" style="max-width: 100%; max-height: 200px; border-radius:8px;">
          </div>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      <div style="padding:20px; background:#f8f9fa; border-top:1px solid #e0e0e0; display:flex; gap:10px;">
        <button id="addProductBtn" style="flex:1; padding:14px; background:linear-gradient(90deg, #28a745, #20c997); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
        <button onclick="massUpdateCategories()" style="flex:1; padding:14px; background:linear-gradient(90deg, #007bff, #0056b3); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">üì¶ –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
      </div>
    </div>
  </div>

  <!-- –û–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏ -->
  <div id="ordersManagementWindow" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3001;">
    <div style="background:#fff; width:95%; max-width:1200px; height:90vh; margin:3vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      
      <!-- –®–∞–ø–∫–∞ -->
      <div style="background:linear-gradient(90deg, #f093fb, #f5576c); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">üì¶ –ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤</p>
        </div>
        <button onclick="closeOrdersManagementWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –§–∏–ª—å—Ç—Ä—ã -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <select id="ordersFilterDate" onchange="loadOrdersManagement()" style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
          <option value="all">–í—Å–µ –∑–∞–∫–∞–∑—ã</option>
          <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
          <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
        </select>
        
        <select id="ordersFilterStatus" onchange="loadOrdersManagement()" style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
          <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
          <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω</option>
          <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>
        </select>
        
        <input type="text" id="ordersSearchClient" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/—Ç–µ–ª–µ—Ñ–æ–Ω—É" onkeyup="loadOrdersManagement()" style="flex:1; min-width:200px; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
        
        <button onclick="loadOrdersManagement()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
      <div id="ordersManagementList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑ -->
  <div id="addItemToOrderModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:3002; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:600px; max-height:80vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div style="background:linear-gradient(135deg, #17a2b8 0%, #138496 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:20px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∑–∞–∫–∞–∑</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:13px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏–∑ —Å–ø–∏—Å–∫–∞</p>
        </div>
        <button onclick="closeAddItemToOrderModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0;">
        <input type="text" id="searchProductToAdd" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." onkeyup="filterProductsToAdd()" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
      </div>

      <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
      <div id="productsToAddList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
      </div>
    </div>
  </div>

  <!-- –û–∫–Ω–æ –æ—Ç—á–µ—Ç–∞ –ø–æ –ø—Ä–∏–±—ã–ª–∏ -->
  <div id="profitReportWindow" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3000;">
    <div style="background:#fff; width:95%; max-width:1000px; height:90vh; margin:3vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      
      <!-- –®–∞–ø–∫–∞ -->
      <div style="background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">üí∞ –û—Ç—á–µ—Ç –ø–æ –ø—Ä–∏–±—ã–ª–∏</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–æ–≤</p>
        </div>
        <button onclick="closeProfitReport()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –§–∏–ª—å—Ç—Ä—ã –∏ —Å–≤–æ–¥–∫–∞ -->
      <div style="padding:15px; background:#f8f9fa;">
        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div style="display:flex; gap:10px; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #e0e0e0;">
          <button id="tabProducts" onclick="switchProfitTab('products')" style="padding:12px 24px; background:linear-gradient(90deg, #28a745, #20c997); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.2);">üì¶ –ü–æ —Ç–æ–≤–∞—Ä–∞–º</button>
          <button id="tabOrders" onclick="switchProfitTab('orders')" style="padding:12px 24px; background:#e9ecef; color:#333; border:none; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.1);">üìã –ü–æ –∑–∞–∫–∞–∑–∞–º</button>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –ø–æ —Ç–æ–≤–∞—Ä–∞–º -->
        <div id="profitProductsPanel">
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">üí∞ –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</div>
              <div style="font-size:24px; font-weight:700; color:#28a745;" id="totalProfit">0 —Å–æ–º</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">üìä –°—Ä–µ–¥–Ω—è—è –Ω–∞—Ü–µ–Ω–∫–∞</div>
              <div style="font-size:24px; font-weight:700; color:#007bff;" id="avgMarkup">0%</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">üì¶ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</div>
              <div style="font-size:24px; font-weight:700; color:#6c757d;" id="totalProducts">0</div>
            </div>
          </div>
          
          <div style="display:flex; gap:10px; align-items:center;">
            <select id="profitCategoryFilter" onchange="filterProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
              <option value="–Ω–æ–∂–Ω–∏—Ü—ã">–ù–æ–∂–Ω–∏—Ü—ã</option>
              <option value="—Å–∫–æ—Ç—á">–°–∫–æ—Ç—á</option>
              <option value="–Ω–æ–∂">–ù–æ–∂</option>
              <option value="–≤—Å–µ">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
            </select>
            <select id="profitSortFilter" onchange="filterProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="profit-desc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üì)</option>
              <option value="profit-asc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üë)</option>
              <option value="markup-desc">–ü–æ –Ω–∞—Ü–µ–Ω–∫–µ (‚Üì)</option>
              <option value="markup-asc">–ü–æ –Ω–∞—Ü–µ–Ω–∫–µ (‚Üë)</option>
              <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
            </select>
            <button onclick="exportProfitToExcel()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">üì• Excel</button>
          </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –ø–æ –∑–∞–∫–∞–∑–∞–º -->
        <div id="profitOrdersPanel" style="display:none;">
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">üí∞ –ü—Ä–∏–±—ã–ª—å –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
              <div style="font-size:24px; font-weight:700; color:#28a745;" id="totalOrderProfit">0 —Å–æ–º</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">üìã –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
              <div style="font-size:24px; font-weight:700; color:#007bff;" id="totalOrdersCount">0</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">üë• –ö–ª–∏–µ–Ω—Ç–æ–≤</div>
              <div style="font-size:24px; font-weight:700; color:#6c757d;" id="totalClientsCount">0</div>
            </div>
          </div>
          
          <div style="display:flex; gap:10px; align-items:center;">
            <select id="orderDateFilter" onchange="loadOrderProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
              <option value="yesterday">–í—á–µ—Ä–∞</option>
              <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
              <option value="month">–ó–∞ –º–µ—Å—è—Ü</option>
              <option value="all">–í—Å–µ –≤—Ä–µ–º—è</option>
            </select>
            <select id="orderSortFilter" onchange="loadOrderProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="profit-desc">–ü–æ –ø—Ä–∏–±—ã–ª–∏ (‚Üì)</option>
              <option value="date-desc">–ü–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ)</option>
              <option value="date-asc">–ü–æ –¥–∞—Ç–µ (—Å—Ç–∞—Ä—ã–µ)</option>
            </select>
            <button onclick="exportOrderProfitToExcel()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">üì• Excel</button>
            <button onclick="deleteSelectedOrders()" style="padding:10px 20px; background:#dc3545; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
      <div id="profitProductsTable" style="flex:1; overflow-y:auto; padding:15px;">
        <table id="profitReportTable" style="width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#f8f9fa; border-bottom:2px solid #e0e0e0;">
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">#</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">–¢–æ–≤–∞—Ä</th>
              <th style="padding:12px; text-align:center; font-size:13px; color:#666;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">üíµ –ó–∞–∫—É–ø–∫–∞</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">üí∞ –ü—Ä–æ–¥–∞–∂–∞</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">üìä –ü—Ä–∏–±—ã–ª—å</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">% –ù–∞—Ü–µ–Ω–∫–∞</th>
            </tr>
          </thead>
          <tbody id="profitReportBody">
            <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </tbody>
        </table>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤ -->
      <div id="profitOrdersTable" style="display:none; flex:1; overflow-y:auto; padding:15px;">
        <table style="width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#f8f9fa; border-bottom:2px solid #e0e0e0;">
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">#</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">–î–∞—Ç–∞</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">üë§ –ö–ª–∏–µ–Ω—Ç</th>
              <th style="padding:12px; text-align:center; font-size:13px; color:#666;">üì¶ –¢–æ–≤–∞—Ä–æ–≤</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">üíµ –ó–∞–∫—É–ø–∫–∞</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">üí∞ –°—É–º–º–∞</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">üìä –ü—Ä–∏–±—ã–ª—å</th>
            </tr>
          </thead>
          <tbody id="orderProfitReportBody">
            <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞ -->
  <div id="clientOrdersDetailModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:3002; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:900px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:22px;" id="clientDetailName">–ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;" id="clientDetailInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–∞—Ö</p>
        </div>
        <button onclick="closeClientOrdersDetailModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –°–≤–æ–¥–∫–∞ -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0;">
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
          <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">üì¶ –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
            <div style="font-size:24px; font-weight:700; color:#007bff;" id="clientDetailTotalOrders">0</div>
          </div>
          <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">üí∞ –û–±—â–∞—è —Å—É–º–º–∞ –ø—Ä–æ–¥–∞–∂</div>
            <div style="font-size:24px; font-weight:700; color:#6c757d;" id="clientDetailTotalSale">0 —Å–æ–º</div>
          </div>
          <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">üìä –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</div>
            <div style="font-size:24px; font-weight:700; color:#28a745;" id="clientDetailTotalProfit">0 —Å–æ–º</div>
          </div>
        </div>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
      <div id="clientOrdersDetailList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–∫–∞–∑–∞ -->
  <div id="orderItemsDetailModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:3002; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:900px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div style="background:linear-gradient(135deg, #007bff 0%, #0056b3 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:22px;" id="orderItemsDetailTitle">–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;" id="orderItemsDetailInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</p>
        </div>
        <button onclick="closeOrderItemsDetailModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
      <div id="orderItemsDetailContent" style="flex:1; overflow-y:auto; padding:20px;">
        <div style="text-align:center; color:#999; padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      <div style="padding:15px; background:#f8f9fa; border-top:1px solid #e0e0e0; display:flex; gap:10px; justify-content:flex-end;">
        <button id="orderItemsAddBtn" style="padding:10px 20px; background:#17a2b8; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </button>
        <button onclick="closeOrderItemsDetailModal()" style="padding:10px 20px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>
  </div>

  <!-- –û—Ç–¥–µ–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –∫–æ—Ä–∑–∏–Ω—ã -->
  <div id="cartPage" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2000;">
    <div style="background:#fff; width:95%; max-width:720px; height:90vh; margin:3vh auto; border-radius:10px; overflow:auto; padding:16px; position:relative;">
      <button onclick="closeCartPage()" style="position:absolute; right:12px; top:12px; font-size:18px;">&times;</button>
      <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
      <div id="cartPageList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:12px;"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
        <div style="font-weight:700;">–ò—Ç–æ–≥–æ: <span id="cartPageTotal">0</span></div>
        <div style="display:flex;gap:8px;">
            <button onclick="closeCartPage()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
            <button onclick="(function(){ closeCartPage(); document.querySelector('.order-form').scrollIntoView({behavior:'smooth'}); })()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button id="cartPageClear" style="background:#dc3545;color:#fff;border:none;padding:8px 12px;border-radius:8px;">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
    </div>
  </div>

  <script>
 let products = [];
 let isAdmin = false;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
  authDomain: "svoysayet.firebaseapp.com",
  projectId: "svoysayet",
  storageBucket: "svoysayet.firebasestorage.app",
  messagingSenderId: "450143000217",
  appId: "1:450143000217:web:7495cefaea0b94966e8a08",
  measurementId: "G-Y8VG9E29FY"
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase ‚Äî –¥–µ–ª–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –∂–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ SDK
let db, storage;
function initFirebase() {
  try {
    if (typeof firebase === 'undefined') throw new Error('Firebase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
    storage = firebase.storage();
    console.log('Firebase initialized successfully');
  } catch (error) {
    console.error('Firebase initialization error:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ' + error.message, 'error');
  }
}

if (typeof firebase !== 'undefined') {
  initFirebase();
} else {
  // –ï—Å–ª–∏ SDK –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('load', initFirebase);
}

// ==================== –°–ò–°–¢–ï–ú–ê –£–ù–ò–ö–ê–õ–¨–ù–´–• ID –ö–õ–ò–ï–ù–¢–û–í ====================

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –∫–ª–∏–µ–Ω—Ç–∞
let clientId = localStorage.getItem('chatClientId');
let clientName = localStorage.getItem('chatClientName');

if (!clientId) {
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
  clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('chatClientId', clientId);
  console.log('–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π clientId:', clientId);
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
async function ensureClientName() {
  if (!clientName) {
    const { value: name } = await Swal.fire({
      title: '–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
      input: 'text',
      inputPlaceholder: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è',
      showCancelButton: false,
      allowOutsideClick: false,
      confirmButtonText: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
      inputValidator: (value) => {
        if (!value) {
          return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è!';
        }
      }
    });
    
    if (name) {
      clientName = name;
      localStorage.setItem('chatClientName', name);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      try {
        if (typeof db !== 'undefined') {
          await db.collection('chatClients').doc(clientId).set({
            name: clientName,
            lastActive: firebase.firestore.FieldValue.serverTimestamp(),
            hasUnread: false
          });
          console.log('–ö–ª–∏–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ:', clientName);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞:', error);
      }
    }
  }
  return clientName;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞
async function updateClientActivity() {
  if (typeof db !== 'undefined' && clientId) {
    try {
      await db.collection('chatClients').doc(clientId).set({
        name: clientName || '–ö–ª–∏–µ–Ω—Ç',
        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
        hasUnread: true
      }, { merge: true });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', error);
    }
  }
}

// –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
const ADMIN_PASSWORD = "009860";

// –¢–µ–∫—É—â–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "–≤—Å–µ" = –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –º–µ–ª–æ—á—å)
let currentCategory = '–≤—Å–µ';

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
async function loadProducts() {
  try {
    console.log('Loading products...');
    let snapshot;
    try {
      snapshot = await db.collection('products').orderBy('order').get();
    } catch (e) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—è order, –∑–∞–≥—Ä—É–∂–∞–µ–º –±–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      snapshot = await db.collection('products').get();
    }
    products = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.image) {
        data.image = fixImageUrl(data.image);
      }
      products.push({ id: doc.id, ...data });
    });
    // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ order, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    if (!products.every(p => typeof p.order === 'number')) {
      products.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
    } else {
      products.sort((a, b) => (a.order || 0) - (b.order || 0));
    }
    console.log('Products loaded:', products.length);
    renderProducts();
  } catch (error) {
    console.error('Error loading products:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã: ' + error.message, 'error');
  }
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function fixImageUrl(url) {
  if (!url) return 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3E–ù–µ—Ç —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E';
  
  // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ –ø—É—Ç–∏)
  if (!url.includes('/') && !url.startsWith('http')) {
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
    return './images/' + url;
  }
  
  return url;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Firebase Storage
async function uploadImageToStorage(file) {
  try {
    console.log('Starting image upload...');
    const storageRef = storage.ref();
    const fileName = `${Date.now()}_${file.name}`;
    const fileRef = storageRef.child(`products/${fileName}`);
    
    console.log('Uploading file:', fileName);
    const snapshot = await fileRef.put(file);
    console.log('Upload completed:', snapshot);
    
    const downloadURL = await fileRef.getDownloadURL();
    console.log('Download URL:', downloadURL);
    
    return downloadURL;
  } catch (error) {
    console.error('Error uploading image:', error);
    throw error;
  }
}


// === Cloudinary upload helper ===
async function uploadToCloudinary(file) {
  const cloudName = 'dya0j6wgv'; // ‚Üê –í–°–¢–ê–í–¨ –°–Æ–î–ê –ò–ó Cloudinary // ‚Üê –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π cloud_name (–ø–æ–∑–∂–µ)
  const uploadPreset = 'mystore_upload';

  const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', uploadPreset);

  const res = await fetch(url, {
    method: 'POST',
    body: formData
  });

  const data = await res.json();
  if (data.secure_url) {
    return data.secure_url;
  } else {
    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Cloudinary');
  }
}


// === Imgur upload helper ===
async function uploadToImgur(file) {
  const clientId = 'YOUR_IMGUR_CLIENT_ID'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π Client-ID —Å https://api.imgur.com/oauth2/addclient
  const formData = new FormData();
  formData.append('image', file);
  const res = await fetch('https://api.imgur.com/3/image', {
    method: 'POST',
    headers: { Authorization: 'Client-ID ' + clientId },
    body: formData
  });
  const data = await res.json();
  if (data.success && data.data && data.data.link) {
    return data.data.link;
  } else {
    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Imgur');
  }
}

// === Postimages upload helper ===
async function uploadToPostimages(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_session', '');
  formData.append('numfiles', 1);
  formData.append('optsize', 0);
  formData.append('expire', 0);
  const res = await fetch('https://api.postimages.org/1/upload', {
    method: 'POST',
    body: formData
  });
  const data = await res.json();
  if (data && data.direct_link) {
    return data.direct_link;
  } else {
    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Postimages');
  }
}



// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞—á
// –¢–µ–ø–µ—Ä—å —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ ImageBB, —Å—Å—ã–ª–∫–∞ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ newImage

document.getElementById('imageFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  const addBtn = document.getElementById('addProductBtn');
  if (file) {
    addBtn.disabled = true;
    document.getElementById('newImage').value = '';
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('imagePreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
    try {
      // const url = await uploadImageToStorage(file); // –û—Ç–∫–ª—é—á–∞–µ–º Firebase Storage
      // const url = await uploadToImgur(file); // –û—Ç–∫–ª—é—á–∞–µ–º Imgur
      // const url = await uploadToPostimages(file); // –û—Ç–∫–ª—é—á–∞–µ–º Postimages
      const url = await uploadToCloudinary(file);
      document.getElementById('newImage').value = url;
      addBtn.disabled = false;
      Swal.fire('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ ImageBB!', '', 'success');
      console.log('Image uploaded to ImageBB and url set to newImage input:', url);
    } catch (err) {
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ ImageBB', 'error');
      addBtn.disabled = false;
    }
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
// –¢–µ–ø–µ—Ä—å —Ñ–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ ImageBB

document.getElementById('galleryFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  const addBtn = document.getElementById('addProductBtn');
  if (file) {
    addBtn.disabled = true;
    document.getElementById('newImage').value = '';
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('imagePreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
    try {
      // const url = await uploadImageToStorage(file); // –û—Ç–∫–ª—é—á–∞–µ–º Firebase Storage
      // const url = await uploadToImgur(file); // –û—Ç–∫–ª—é—á–∞–µ–º Imgur
      // const url = await uploadToPostimages(file); // –û—Ç–∫–ª—é—á–∞–µ–º Postimages
      const url = await uploadToCloudinary(file);
      document.getElementById('newImage').value = url;
      addBtn.disabled = false;
      Swal.fire('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ ImageBB!', '', 'success');
      console.log('Image from gallery uploaded to ImageBB and url set to newImage input:', url);
    } catch (err) {
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ ImageBB', 'error');
      addBtn.disabled = false;
    }
  }
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –Ω–∞—Ü–µ–Ω–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ —Ü–µ–Ω
function setupProfitCalculator() {
  const costPriceInput = document.getElementById('newCostPrice');
  const salePriceInput = document.getElementById('newPrice');
  const profitDisplay = document.getElementById('profitDisplay');
  const profitAmount = document.getElementById('profitAmount');
  const profitPercent = document.getElementById('profitPercent');
  
  function calculateProfit() {
    const costPrice = parseFloat(costPriceInput.value) || 0;
    const salePrice = parseFloat(salePriceInput.value) || 0;
    
    if (costPrice > 0 && salePrice > 0) {
      const profit = salePrice - costPrice;
      const profitPercentage = ((profit / costPrice) * 100).toFixed(2);
      
      profitAmount.textContent = profit.toFixed(2);
      profitPercent.textContent = profitPercentage;
      profitDisplay.style.display = 'block';
      
      // –¶–≤–µ—Ç–æ–≤–æ–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ
      if (profit > 0) {
        profitDisplay.style.background = '#e8f5e9';
        profitDisplay.style.color = '#2e7d32';
      } else if (profit < 0) {
        profitDisplay.style.background = '#ffebee';
        profitDisplay.style.color = '#c62828';
      } else {
        profitDisplay.style.background = '#fff3e0';
        profitDisplay.style.color = '#ef6c00';
      }
    } else {
      profitDisplay.style.display = 'none';
    }
  }
  
  if (costPriceInput && salePriceInput) {
    costPriceInput.addEventListener('input', calculateProfit);
    salePriceInput.addEventListener('input', calculateProfit);
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
// –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL

document.getElementById('addProductBtn').addEventListener('click', async function() {
  try {
    console.log('Add product button clicked');
    const title = document.getElementById('newTitle').value.trim();
    const costPrice = parseFloat(document.getElementById('newCostPrice').value) || 0;
    const price = +document.getElementById('newPrice').value;
    const category = document.getElementById('newCategory').value;
    const optPrice = +document.getElementById('newOptPrice').value;
    const optQty = +document.getElementById('newOptQty').value;
    const minQty = +document.getElementById('newMinQty').value;
    const urlInput = document.getElementById('newImage').value.trim();
    let imageUrl = '';
    if (urlInput) {
      imageUrl = urlInput;
      console.log('Using manual url:', imageUrl);
    } else {
      imageUrl = document.getElementById('newImage').value.trim();
      if (!imageUrl) {
        Swal.fire('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª!', 'warning');
        return;
      }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!title) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', 'warning');
      return;
    }
    if (!costPrice || costPrice <= 0) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –∑–∞–∫—É–ø–∫–∏', 'warning');
      return;
    }
    if (!price || price <= 0) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏', 'warning');
      return;
    }
    if (price <= costPrice) {
      const result = await Swal.fire({
        title: '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ!',
        text: '–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–∞ —Ü–µ–Ω–µ –∑–∞–∫—É–ø–∫–∏. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '–î–∞, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      });
      if (!result.isConfirmed) return;
    }

    // --- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
    const addBtn = document.getElementById('addProductBtn');
    addBtn.disabled = true;
    addBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
    const isValidImage = await checkImage(imageUrl);
    if (!isValidImage) {
      addBtn.disabled = false;
      addBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
      Swal.fire('–û—à–∏–±–∫–∞', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª/URL.', 'error');
      return;
    }
    addBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
    addBtn.disabled = false;
    // --- –∫–æ–Ω–µ—Ü –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ ---

    // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π order —Å—Ä–µ–¥–∏ —Ç–æ–≤–∞—Ä–æ–≤
    let maxOrder = 0;
    products.forEach(p => {
      if (typeof p.order === 'number' && p.order > maxOrder) maxOrder = p.order;
    });

    const productData = { 
      title, 
      costPrice,
      price,
      category: category || '–≤—Å–µ',
      optPrice: optPrice > 0 ? optPrice : null,
      optQty: optQty > 0 ? optQty : null,
      minQty: minQty > 0 ? minQty : 1,
      image: imageUrl,
      order: maxOrder + 1 
    };
    
    console.log('Adding product to Firestore:', productData);
    const docRef = await db.collection('products').add(productData);
    console.log('Product added with ID:', docRef.id);
    await loadProducts();
    renderProducts();
    Swal.fire('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!', '', 'success');
    await loadProducts();
    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('newImage').value = '';
    document.getElementById('newTitle').value = '';
    document.getElementById('newCostPrice').value = '';
    document.getElementById('newPrice').value = '';
    document.getElementById('newCategory').value = '';
    document.getElementById('newOptPrice').value = '';
    document.getElementById('newOptQty').value = '';
    document.getElementById('newMinQty').value = '';
    document.getElementById('imageFile').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('profitDisplay').style.display = 'none';
  } catch (error) {
    console.error('Error details:', error);
    document.getElementById('addProductBtn').disabled = false;
    document.getElementById('addProductBtn').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
    Swal.fire('–û—à–∏–±–∫–∞', `–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä: ${error.message}`, 'error');
  }
});

// –§–æ–Ω —Å–∞–π—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ CSS
// (–∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ–Ω–∞ —É–¥–∞–ª–µ–Ω, —Ç–∞–∫ –∫–∞–∫ —Ñ–∞–π–ª –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã
const cart = JSON.parse(localStorage.getItem('cart')) || [];

const productTable = document.getElementById('productTable');
const search = document.getElementById('search');
const sort = document.getElementById('sort');
const cartList = document.getElementById('cartList');
const totalSum = document.getElementById('totalSum');


// –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
const userData = JSON.parse(localStorage.getItem('userData') || '{}');
if (userData.name) document.getElementById('name').value = userData.name;
if (userData.phone) document.getElementById('phone').value = userData.phone;
if (userData.address) document.getElementById('address').value = userData.address;

// –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
function filterByCategory(category) {
  currentCategory = category;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
  const buttons = document.querySelectorAll('.category-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã
  renderProducts();
}

function addToCart(id, title, price, image, btn) {
  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤–µ—Ä—Å—Ç–∫–∏: –∫–∞—Ä—Ç–æ—á–∫–∏ (.product-card) –∏ —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã
  const card = btn.closest && btn.closest('.product-card');
  const container = card || (btn.parentElement && btn.parentElement.parentElement) || document;

  let qtyInput = null;
  if (container && container.querySelector) {
    qtyInput = container.querySelector('.card-qty-input') || container.querySelector('input');
  }

  let qty = 1;
  if (qtyInput) {
    qty = parseInt(qtyInput.value, 10) || 1;
  }

  const product = products.find(p => p.id === id) || {};

  if (qty < (product.minQty || 1)) {
    Swal.fire('–û—à–∏–±–∫–∞', `–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏: ${product.minQty || 1}`, 'warning');
    if (qtyInput) qtyInput.value = product.minQty || 1;
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∞—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "—Å–∫–æ—Ç—á"
  if (product.category === '—Å–∫–æ—Ç—á' && product.minQty && product.minQty > 1) {
    if (qty % product.minQty !== 0) {
      Swal.fire({
        icon: 'warning',
        title: '–û—à–∏–±–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞',
        html: `–¢–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–°–∫–æ—Ç—á" –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–Ω–æ <b>${product.minQty}</b> —à—Ç.<br><br>–ù–∞–ø—Ä–∏–º–µ—Ä: ${product.minQty}, ${product.minQty * 2}, ${product.minQty * 3} —à—Ç.`,
        confirmButtonText: '–ü–æ–Ω—è—Ç–Ω–æ'
      });
      if (qtyInput) qtyInput.value = product.minQty;
      return;
    }
  }

  // –°—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
  const index = cart.findIndex(item => item.id === id);
  let totalQty = qty;
  if (index !== -1) totalQty += cart[index].qty;

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–Ω—É: –µ—Å–ª–∏ –æ–ø—Ç, —Ç–æ –æ–ø—Ç–æ–≤–∞—è —Ü–µ–Ω–∞
  let finalPrice = price;
  if (product.optQty && totalQty >= product.optQty && product.optPrice) {
    finalPrice = product.optPrice;
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ
  if (index !== -1) {
    cart[index].qty += qty;
    cart[index].price = (product.optQty && cart[index].qty >= product.optQty && product.optPrice)
      ? product.optPrice
      : product.price || price;
  } else {
    cart.push({ id, title, price: finalPrice, qty, image, costPrice: product.costPrice || 0 });
  }

  updateCart();

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  if (qtyInput) {
    qtyInput.value = product.minQty || 1;
  }

  btn.classList.add('animate-add');
  setTimeout(() => btn.classList.remove('animate-add'), 500);

  Swal.fire({
    title: '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!',
    text: `${title} √ó ${qty} –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à—É –∫–æ—Ä–∑–∏–Ω—É.`,
    icon: 'success',
    confirmButtonText: '–û–∫',
    position: 'bottom',
    showConfirmButton: true,
    timer: 1500,
    padding: '10px',
    toast: true
  });

  localStorage.setItem('cart', JSON.stringify(cart));
}

function updateCart() {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±–æ–ª—å—à–µ 4
  let scrollHint = document.getElementById('cartScrollHint');
  if (!scrollHint) {
    scrollHint = document.createElement('div');
    scrollHint.id = 'cartScrollHint';
    scrollHint.className = 'cart-scroll-hint';
    cartList.parentNode.insertBefore(scrollHint, cartList);
  }
  if (cart.length > 4) {
    scrollHint.textContent = '–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ ‚Üì';
    scrollHint.style.display = '';
  } else {
    scrollHint.style.display = 'none';
  }
  cartList.innerHTML = '';

  let total = 0;

  cart.forEach((item, i) => {
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
    const product = products.find(p => p.id === item.id);
    if (product) {
    if (product.optQty && item.qty >= product.optQty && product.optPrice) {
  item.price = product.optPrice;
} else {
  item.price = product.price;
}

    }
    total += item.qty * item.price;

    // –ú–∏–Ω–∏-—Ñ–æ—Ç–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const imgSrc = (product && product.image) ? product.image : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3E–ù–µ—Ç —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E';
    const div = document.createElement('div');
    div.classList.add('cart-item', 'cart-item-compact');
    div.innerHTML = `
      <img src="${imgSrc}" alt="" class="cart-mini-img" style="cursor:pointer;" onclick="showPreview('${imgSrc}')">
      <div class="cart-info-row" style="display:flex;align-items:center;flex:1 1 auto;gap:8px;min-width:0;">
        <span class="cart-title" style="flex:1 1 0;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.title}</span>
  <span class="cart-qty" style="white-space:nowrap;">√ó${item.qty}</span>
  <span class="cart-price" style="white-space:nowrap;">${item.price} —Å–æ–º</span>
  <span class="cart-sum" style="white-space:nowrap;font-weight:bold;">${item.qty * item.price} —Å–æ–º</span>
      </div>
      <button class="delete-item" onclick="removeFromCart(${i})">&times;</button>
    `;
    cartList.appendChild(div);
  });

  totalSum.textContent = total + ' —Å–æ–º';

  // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ—Ä–∑–∏–Ω—ã, –æ–±–Ω–æ–≤–∏–º –µ—ë
  if (document.getElementById('cartPage') && document.getElementById('cartPage').style.display !== 'none') {
    renderCartPage();
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
  const cartPageClearBtn = document.getElementById('cartPageClear');
  if (cartPageClearBtn) {
    cartPageClearBtn.style.display = cart.length === 0 ? 'none' : 'inline-block';
  }

  localStorage.setItem('cart', JSON.stringify(cart));
}

function removeFromCart(i) {
  // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
  const cartList = document.getElementById('cartList');
  const itemDiv = cartList.children[i];
  if (itemDiv) {
    itemDiv.classList.add('cart-item-removing');
    setTimeout(() => {
      cart.splice(i, 1);
      updateCart();
    }, 300);
  } else {
    cart.splice(i, 1);
    updateCart();
  }
}

// –û—Ç–∫—Ä—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É-–ø–∞–Ω–µ–ª—å –∫–æ—Ä–∑–∏–Ω—ã
function openCartPage() {
  renderCartPage();
  document.getElementById('cartPage').style.display = '';
}

function closeCartPage() {
  document.getElementById('cartPage').style.display = 'none';
}

function renderCartPage() {
  const list = document.getElementById('cartPageList');
  const totalEl = document.getElementById('cartPageTotal');
  list.innerHTML = '';
  let total = 0;
  cart.forEach((item, i) => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.gap = '10px';
    div.style.alignItems = 'center';
    div.innerHTML = `
      <img src="${item.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3E–ù–µ—Ç —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E'}" style="width:64px;height:64px;object-fit:cover;border-radius:6px;"> 
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.title}</div>
        <div style="color:#666;">${item.qty} √ó ${item.price} —Å–æ–º</div>
      </div>
      <div style="font-weight:700;">${item.qty * item.price} —Å–æ–º</div>
      <div style="display:flex;flex-direction:column;gap:6px;margin-left:8px;">
        <button onclick="removeFromCart(${i})" style="background:#dc3545;color:#fff;border:none;padding:6px 8px;border-radius:6px;">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    list.appendChild(div);
    total += item.qty * item.price;
  });
  totalEl.textContent = total + ' —Å–æ–º';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã –∏ –ø—Ä–∏–≤—è–∑–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
// –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º –Ω–∏–∫–∞–∫–∏–µ touch —Å–æ–±—ã—Ç–∏—è - —Ä–∞–∑—Ä–µ—à–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing...');
  
  // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
  function forceEnableScroll() {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —á—Ç–æ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('overflow-y');
    document.body.style.removeProperty('position');
    document.body.style.removeProperty('height');
    
    document.documentElement.style.removeProperty('overflow');
    document.documentElement.style.removeProperty('overflow-y');
    document.documentElement.style.removeProperty('height');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    document.body.style.cssText += 'overflow: visible !important; overflow-y: visible !important; position: relative !important; height: auto !important; min-height: 100vh !important;';
    document.documentElement.style.cssText += 'overflow: visible !important; overflow-y: scroll !important; height: auto !important;';
    
    // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å modal-open –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    document.body.classList.remove('modal-open');
  }
  
  // –í—ã–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
  forceEnableScroll();
  
  // –ü–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
  setTimeout(forceEnableScroll, 100);
  setTimeout(forceEnableScroll, 500);
  setTimeout(forceEnableScroll, 1000);
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å
  const observer = new MutationObserver(function() {
    if (document.body.style.overflow === 'hidden' || 
        document.body.style.overflowY === 'hidden' ||
        document.documentElement.style.overflow === 'hidden') {
      console.warn('‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ - –æ—Ç–º–µ–Ω—è–µ–º!');
      forceEnableScroll();
    }
  });
  
  observer.observe(document.body, {
    attributes: true,
    attributeFilter: ['style', 'class']
  });
  
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['style', 'class']
  });
  
  try {
    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    const cartPageClear = document.getElementById('cartPageClear');
    if (cartPageClear) {
      cartPageClear.addEventListener('click', function() {
        cart.length = 0;
        localStorage.removeItem('cart');
        updateCart();
        closeCartPage();
        if (window.Swal) Swal.fire('–ì–æ—Ç–æ–≤–æ', '–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
      });
    }

    loadProducts();
    updateCart(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∏–±—ã–ª–∏
    setupProfitCalculator();
    
    // –ï—Å–ª–∏ —É–∂–µ –±—ã–ª –≤—Ö–æ–¥ –∫–∞–∫ –∞–¥–º–∏–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è), –ø–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å
    if (isAdmin) {
      const adminPanel = document.getElementById('adminPanel');
      if (adminPanel) adminPanel.style.display = '';
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
    const logoutBtn = document.getElementById('logoutUser');
    if (logoutBtn) {
      console.log('–ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫');
      logoutBtn.addEventListener('click', function() {
        console.log('–ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –≤—ã—Ö–æ–¥–∞');
        isAdmin = false;
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
        const adminAddProduct = document.getElementById('adminAddProduct');
        if (adminAddProduct) adminAddProduct.style.display = 'none';
        
        const adminAuth = document.getElementById('adminAuth');
        if (adminAuth) adminAuth.style.display = 'block';
        
        const managementHeader = document.getElementById('managementHeader');
        if (managementHeader) managementHeader.style.display = 'none';
        
        const adminPassword = document.getElementById('adminPassword');
        if (adminPassword) adminPassword.value = '';
        
        localStorage.removeItem('userData');
        
        const nameField = document.getElementById('name');
        if (nameField) nameField.value = '';
        
        const phoneField = document.getElementById('phone');
        if (phoneField) phoneField.value = '';
        
        const addressField = document.getElementById('address');
        if (addressField) addressField.value = '';
        
        Swal.fire('–í—ã –≤—ã—à–ª–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è');
        renderProducts();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        const adminPanel = document.getElementById('adminPanel');
        if (adminPanel) adminPanel.style.display = 'none';
      });
    } else {
      console.log('–ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –ù–ï –Ω–∞–π–¥–µ–Ω–∞');
    }
  } catch (error) {
    console.error('Error during initialization:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ' + error.message, 'error');
  }
});

document.getElementById('submitOrder').onclick = async () => {
  const submitBtn = document.getElementById('submitOrder');
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();

  if (!name || !phone || !address || cart.length === 0) {
    Swal.fire('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã', 'warning');
    return;
  }

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
  submitBtn.disabled = true;
  submitBtn.style.opacity = '0.5';
  submitBtn.style.cursor = 'not-allowed';
  const originalText = submitBtn.textContent;
  submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

  try {
    const items = cart.map(i => `${i.title} ‚Äî ${i.qty}√ó${i.price} —Å–æ–º = ${i.qty * i.price} —Å–æ–º`).join('\n');
    const total = cart.reduce((sum, item) => sum + item.qty * item.price, 0);
    const currentTime = new Date().toLocaleString();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑ –≤ Firebase
    await db.collection('orders').add({
      name,
      phone,
      address,
      items: cart.map(item => ({
        id: item.id,
        title: item.title,
        qty: item.qty,
        price: item.price,
        costPrice: item.costPrice || 0
      })),
      total,
      timestamp: Date.now(),
      time: currentTime,
      status: '–ù–æ–≤—ã–π'
    });

    const msg = `–ù–æ–≤—ã–π –∑–∞–∫–∞–∑:\n–ò–º—è: ${name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n–ê–¥—Ä–µ—Å: ${address}\n–¢–æ–≤–∞—Ä—ã:\n${items}\n\n–ò—Ç–æ–≥–æ: ${total} —Å–æ–º`;

    // –°–†–ê–ó–£ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö –∫–ª–∏–µ–Ω—Ç—É
    Swal.fire('–£—Å–ø–µ—Ö!', '–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è!', 'success');
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—Ö–∞
    submitBtn.disabled = false;
    submitBtn.style.opacity = '1';
    submitBtn.style.cursor = 'pointer';
    submitBtn.textContent = originalText;
    
    // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
    const orderData = {
      name: name,
      phone: phone,
      address: address,
      cart: [...cart],
      total: total,
      currentTime: currentTime
    };
    
    // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É —Å—Ä–∞–∑—É
    cart.length = 0;
    updateCart();
    localStorage.removeItem('cart');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    localStorage.setItem('userData', JSON.stringify({
      name,
      phone,
      address
    }));

    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('name').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('address').value = '';
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–±–µ–∑ await)
    sendOrderAsExcel(orderData.name, orderData.phone, orderData.address, orderData.cart, orderData.total, orderData.currentTime)
      .then(() => console.log('Excel –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ'))
      .catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Excel:', err));
    
    sendOrderAsPDF(orderData.name, orderData.phone, orderData.address, orderData.cart, orderData.total, orderData.currentTime)
      .then(() => console.log('PDF –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ'))
      .catch(err => console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF:', err));

  } catch (error) {
    console.error('Error submitting order:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
    
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
    submitBtn.disabled = false;
    submitBtn.style.opacity = '1';
    submitBtn.style.cursor = 'pointer';
    submitBtn.textContent = originalText;
  }
};

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ –∫–∞–∫ PDF —Ñ–∞–π–ª –≤ Telegram
async function sendOrderAsPDF(name, phone, address, cartItems, total, time) {
  try {
    console.log('=== –ù–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è PDF —Ñ–∞–π–ª–∞ ===');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPosition = 20;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const headerCanvas = document.createElement('canvas');
    const headerCtx = headerCanvas.getContext('2d');
    headerCanvas.width = 600;
    headerCanvas.height = 50;
    
    headerCtx.fillStyle = 'white';
    headerCtx.fillRect(0, 0, headerCanvas.width, headerCanvas.height);
    headerCtx.fillStyle = 'black';
    headerCtx.font = 'bold 24px Arial';
    headerCtx.textAlign = 'center';
    headerCtx.fillText('–ù–û–í–´–ô –ó–ê–ö–ê–ó', 300, 35);
    
    const headerImage = headerCanvas.toDataURL('image/png');
    doc.addImage(headerImage, 'PNG', 20, yPosition, 170, 15);
    
    yPosition += 20;
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ –≤ —Ä–∞–º–∫–µ
    const infoCanvas = document.createElement('canvas');
    const infoCtx = infoCanvas.getContext('2d');
    infoCanvas.width = 700;
    infoCanvas.height = 120;
    
    // –ë–µ–ª—ã–π —Ñ–æ–Ω —Å —á–µ—Ä–Ω–æ–π —Ä–∞–º–∫–æ–π
    infoCtx.fillStyle = 'white';
    infoCtx.fillRect(0, 0, infoCanvas.width, infoCanvas.height);
    infoCtx.strokeStyle = 'black';
    infoCtx.lineWidth = 2;
    infoCtx.strokeRect(0, 0, infoCanvas.width, infoCanvas.height);
    
    // –¢–µ–∫—Å—Ç
    infoCtx.fillStyle = 'black';
    infoCtx.font = '16px Arial';
    infoCtx.fillText(`–î–∞—Ç–∞/–í—Ä–µ–º—è: ${time}`, 15, 30);
    infoCtx.fillText(`–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞: ${name}`, 15, 55);
    infoCtx.fillText(`–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}`, 15, 80);
    infoCtx.fillText(`–ê–¥—Ä–µ—Å: ${address}`, 15, 105);
    
    const infoImage = infoCanvas.toDataURL('image/png');
    doc.addImage(infoImage, 'PNG', 20, yPosition, 170, 30);
    
    yPosition += 35;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã —Å —Å–µ—Ç–∫–æ–π
    const tableHeaderCanvas = document.createElement('canvas');
    const thCtx = tableHeaderCanvas.getContext('2d');
    tableHeaderCanvas.width = 550;
    tableHeaderCanvas.height = 50;
    
    // –°–µ—Ä—ã–π —Ñ–æ–Ω –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
    thCtx.fillStyle = '#e0e0e0';
    thCtx.fillRect(0, 0, tableHeaderCanvas.width, tableHeaderCanvas.height);
    
    // –†–∞–º–∫–∞
    thCtx.strokeStyle = 'black';
    thCtx.lineWidth = 2;
    thCtx.strokeRect(0, 0, tableHeaderCanvas.width, tableHeaderCanvas.height);
    
    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ (–∫–æ–ª–æ–Ω–∫–∏: –§–æ—Ç–æ | –ù–∞–∑–≤–∞–Ω–∏–µ | –ö–æ–ª-–≤–æ | –¶–µ–Ω–∞ | –°—É–º–º–∞)
    thCtx.beginPath();
    thCtx.moveTo(90, 0);
    thCtx.lineTo(90, 50);
    thCtx.moveTo(310, 0);
    thCtx.lineTo(310, 50);
    thCtx.moveTo(390, 0);
    thCtx.lineTo(390, 50);
    thCtx.moveTo(470, 0);
    thCtx.lineTo(470, 50);
    thCtx.stroke();
    
    // –¢–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    thCtx.fillStyle = 'black';
    thCtx.font = 'bold 14px Arial';
    thCtx.textAlign = 'center';
    thCtx.fillText('–§–û–¢–û', 45, 32);
    thCtx.fillText('–ù–ê–ó–í–ê–ù–ò–ï', 200, 32);
    thCtx.fillText('–ö–û–õ-–í–û', 350, 32);
    thCtx.fillText('–¶–ï–ù–ê', 430, 32);
    thCtx.fillText('–°–£–ú–ú–ê', 510, 32);
    
    const tableHeaderImage = tableHeaderCanvas.toDataURL('image/png');
    doc.addImage(tableHeaderImage, 'PNG', 20, yPosition, 170, 12);
    
    yPosition += 12;
    
    // –¢–æ–≤–∞—Ä—ã —Å —Å–µ—Ç–∫–æ–π
    for (let i = 0; i < cartItems.length; i++) {
      const item = cartItems[i];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏–º –ª–∏ –∑–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
      if (yPosition > 240) {
        doc.addPage();
        yPosition = 20;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã
      let photoWidth = 90;  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
      let photoHeight = 90;
      let photoData = null;
      
      if (item.image && item.image.startsWith('http')) {
        try {
          const response = await fetch(item.image);
          const blob = await response.blob();
          
          const reader = new FileReader();
          const base64 = await new Promise((resolve) => {
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
          
          photoData = base64;
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ñ–æ—Ç–æ
          const img = new Image();
          await new Promise((resolve) => {
            img.onload = resolve;
            img.src = base64;
          });
          
          // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ñ–æ—Ç–æ —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–æ –≤ —è—á–µ–π–∫—É, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
          const maxPhotoWidth = 100;
          const maxPhotoHeight = 100;
          
          let finalWidth = img.width;
          let finalHeight = img.height;
          
          // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –µ—Å–ª–∏ —Ñ–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ
          if (finalWidth > maxPhotoWidth || finalHeight > maxPhotoHeight) {
            const scale = Math.min(maxPhotoWidth / finalWidth, maxPhotoHeight / finalHeight);
            finalWidth = finalWidth * scale;
            finalHeight = finalHeight * scale;
          }
          
          photoWidth = finalWidth;
          photoHeight = finalHeight;
          
          console.log('‚úì –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', item.title, `–†–∞–∑–º–µ—Ä: ${photoWidth.toFixed(0)}x${photoHeight.toFixed(0)}`);
        } catch (err) {
          console.error('‚úó –û—à–∏–±–∫–∞ —Ñ–æ—Ç–æ:', item.title, err);
          photoWidth = 90;
          photoHeight = 90;
        }
      }
      
      // –í—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ = –≤—ã—Å–æ—Ç–∞ —Ñ–æ—Ç–æ + –æ—Ç—Å—Ç—É–ø—ã
      const rowHeight = Math.max(photoHeight + 10, 100);
      
      // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —à–∏—Ä–∏–Ω–æ–π
      const rowCanvas = document.createElement('canvas');
      const rowCtx = rowCanvas.getContext('2d');
      const photoColumnWidth = Math.max(photoWidth + 10, 70); // –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ —Ñ–æ—Ç–æ
      const totalWidth = photoColumnWidth + 480; // —Ñ–æ—Ç–æ + –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
      rowCanvas.width = totalWidth;
      rowCanvas.height = rowHeight;
      
      // –ë–µ–ª—ã–π —Ñ–æ–Ω
      rowCtx.fillStyle = 'white';
      rowCtx.fillRect(0, 0, rowCanvas.width, rowCanvas.height);
      
      // –†–∞–º–∫–∞ —Å—Ç—Ä–æ–∫–∏
      rowCtx.strokeStyle = 'black';
      rowCtx.lineWidth = 2;
      rowCtx.strokeRect(0, 0, rowCanvas.width, rowCanvas.height);
      
      // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
      const col2 = photoColumnWidth;
      const col3 = photoColumnWidth + 240;
      const col4 = photoColumnWidth + 320;
      const col5 = photoColumnWidth + 400;
      
      rowCtx.beginPath();
      rowCtx.moveTo(col2, 0);
      rowCtx.lineTo(col2, rowHeight);
      rowCtx.moveTo(col3, 0);
      rowCtx.lineTo(col3, rowHeight);
      rowCtx.moveTo(col4, 0);
      rowCtx.lineTo(col4, rowHeight);
      rowCtx.moveTo(col5, 0);
      rowCtx.lineTo(col5, rowHeight);
      rowCtx.stroke();
      
      // –¢–µ–∫—Å—Ç –≤ —è—á–µ–π–∫–∞—Ö
      rowCtx.fillStyle = 'black';
      rowCtx.font = '13px Arial';
      rowCtx.textAlign = 'center';
      
      const midY = rowHeight / 2;
      
      // –ù–∞–∑–≤–∞–Ω–∏–µ (—Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω–æ–µ)
      rowCtx.textAlign = 'left';
      const title = item.title;
      if (title.length > 28) {
        rowCtx.fillText(title.substring(0, 28), col2 + 5, midY - 5);
        rowCtx.fillText(title.substring(28), col2 + 5, midY + 10);
      } else {
        rowCtx.fillText(title, col2 + 5, midY);
      }
      
      // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
      rowCtx.textAlign = 'center';
      rowCtx.fillText(`${item.qty} —à—Ç`, (col3 + col4) / 2, midY);
      
      // –¶–µ–Ω–∞
      rowCtx.fillText(`${item.price}`, (col4 + col5) / 2, midY - 5);
      rowCtx.font = '11px Arial';
      rowCtx.fillText('—Å–æ–º', (col4 + col5) / 2, midY + 8);
      
      // –°—É–º–º–∞
      rowCtx.font = 'bold 13px Arial';
      rowCtx.fillText(`${item.qty * item.price}`, (col5 + totalWidth) / 2, midY - 5);
      rowCtx.font = '11px Arial';
      rowCtx.fillText('—Å–æ–º', (col5 + totalWidth) / 2, midY + 8);
      
      const rowImage = rowCanvas.toDataURL('image/png');
      const rowPdfHeight = rowHeight * 170 / totalWidth; // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
      doc.addImage(rowImage, 'PNG', 20, yPosition, 170, rowPdfHeight);
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ–≤–µ—Ä—Ö —è—á–µ–π–∫–∏ - –ü–û–õ–ù–û–ï —Ñ–æ—Ç–æ –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏
      if (photoData) {
        const photoWidthPdf = photoWidth * 170 / totalWidth;
        const photoHeightPdf = photoHeight * 170 / totalWidth;
        const xPos = 22 + (photoColumnWidth * 170 / totalWidth - photoWidthPdf) / 2; // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
        const yPos = yPosition + (rowPdfHeight - photoHeightPdf) / 2; // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
        doc.addImage(photoData, 'JPEG', xPos, yPos, photoWidthPdf, photoHeightPdf);
      }
      
      yPosition += rowPdfHeight;
    }
    
    // –°—Ç—Ä–æ–∫–∞ –ò–¢–û–ì–û —Å —Å–µ—Ç–∫–æ–π
    const totalCanvas = document.createElement('canvas');
    const totalCtx = totalCanvas.getContext('2d');
    totalCanvas.width = 550;
    totalCanvas.height = 60;
    
    // –ñ–µ–ª—Ç—ã–π —Ñ–æ–Ω –¥–ª—è –∏—Ç–æ–≥–æ
    totalCtx.fillStyle = '#fff9c4';
    totalCtx.fillRect(0, 0, totalCanvas.width, totalCanvas.height);
    
    // –†–∞–º–∫–∞
    totalCtx.strokeStyle = 'black';
    totalCtx.lineWidth = 3;
    totalCtx.strokeRect(0, 0, totalCanvas.width, totalCanvas.height);
    
    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
    totalCtx.beginPath();
    totalCtx.moveTo(470, 0);
    totalCtx.lineTo(470, 60);
    totalCtx.stroke();
    
    // –¢–µ–∫—Å—Ç
    totalCtx.fillStyle = 'black';
    totalCtx.font = 'bold 18px Arial';
    totalCtx.textAlign = 'right';
    totalCtx.fillText('–ò–¢–û–ì–û:', 450, 38);
    
    totalCtx.textAlign = 'center';
    totalCtx.fillText(`${total}`, 510, 32);
    totalCtx.font = '14px Arial';
    totalCtx.fillText('—Å–æ–º', 510, 48);
    
    const totalImage = totalCanvas.toDataURL('image/png');
    doc.addImage(totalImage, 'PNG', 20, yPosition, 170, 15);
    
    console.log('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF —Ñ–∞–π–ª...');
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF –∫–∞–∫ blob
    const pdfBlob = doc.output('blob');
    
    console.log('PDF —Ñ–∞–π–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω, —Ä–∞–∑–º–µ—Ä:', pdfBlob.size, '–±–∞–π—Ç');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
    const formData = new FormData();
    formData.append('chat_id', '5567924440');
    formData.append('document', pdfBlob, `–ó–∞–∫–∞–∑_${name}_${Date.now()}.pdf`);
    formData.append('caption', `üì∑ –ó–∞–∫–∞–∑ —Å —Ñ–æ—Ç–æ –æ—Ç ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const formData2 = new FormData();
    formData2.append('chat_id', '246421345');
    formData2.append('document', pdfBlob, `–ó–∞–∫–∞–∑_${name}_${Date.now()}.pdf`);
    formData2.append('caption', `üì∑ –ó–∞–∫–∞–∑ —Å —Ñ–æ—Ç–æ –æ—Ç ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData2
    });

    console.log('PDF —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF:', error);
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ –∫–∞–∫ Excel —Ñ–∞–π–ª –≤ Telegram
async function sendOrderAsExcel(name, phone, address, cartItems, total, time) {
  try {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('–ó–∞–∫–∞–∑');

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    worksheet.addRow(['–ù–û–í–´–ô –ó–ê–ö–ê–ó']);
    worksheet.addRow([]);
    worksheet.addRow(['–î–∞—Ç–∞/–í—Ä–µ–º—è:', time]);
    worksheet.addRow(['–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:', name]);
    worksheet.addRow(['–¢–µ–ª–µ—Ñ–æ–Ω:', phone]);
    worksheet.addRow(['–ê–¥—Ä–µ—Å:', address]);
    worksheet.addRow([]);
    
    // –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤
    const headerRow = worksheet.addRow(['–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–¶–µ–Ω–∞ –∑–∞ —à—Ç.', '–°—É–º–º–∞']);
    
    cartItems.forEach(item => {
      const row = worksheet.addRow([
        item.title,
        `${item.qty} —à—Ç`,
        `${item.price} —Å–æ–º`,
        `${item.qty * item.price} —Å–æ–º`
      ]);
      // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É
      row.getCell(2).alignment = { horizontal: 'center', vertical: 'middle' };
    });
    
    worksheet.addRow([]);
    const totalRow = worksheet.addRow(['–ò–¢–û–ì–û:', '', '', `${total} —Å–æ–º`]);

    // –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è
    worksheet.getRow(1).font = { size: 16, bold: true };
    headerRow.font = { bold: true };
    totalRow.font = { bold: true };
    
    // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
    headerRow.eachCell((cell) => {
      cell.alignment = { horizontal: 'center', vertical: 'middle' };
    });
    
    worksheet.columns = [
      { width: 30 },
      { width: 15 },
      { width: 15 },
      { width: 15 }
    ];

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram —á–µ—Ä–µ–∑ FormData
    const formData = new FormData();
    formData.append('chat_id', '5567924440');
    formData.append('document', blob, `–ó–∞–∫–∞–∑_${name}_${Date.now()}.xlsx`);
    formData.append('caption', `üìä Excel –∑–∞–∫–∞–∑ –æ—Ç ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const formData2 = new FormData();
    formData2.append('chat_id', '246421345');
    formData2.append('document', blob, `–ó–∞–∫–∞–∑_${name}_${Date.now()}.xlsx`);
    formData2.append('caption', `üìä Excel –∑–∞–∫–∞–∑ –æ—Ç ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData2
    });

    console.log('Excel —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Excel:', error);
  }
}

// –§—É–Ω–∫—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤ —É–¥–∞–ª–µ–Ω—ã

search.oninput = renderProducts;
sort.onchange = renderProducts;
renderProducts();
updateCart();

function showPreview(src) {
  document.getElementById('previewImg').src = src;
  document.getElementById('previewBlock').style.display = 'block';
  // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É body
}

document.getElementById('closePreview').onclick = function() {
  document.getElementById('previewBlock').style.display = 'none';
  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞
};

document.getElementById('previewBlock').onclick = function(e) {
  if (e.target === this) {
    this.style.display = 'none';
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞
  }
};

function updatePriceInRow(input, price, optPrice, optQty) {
  const qty = +input.value;
  const priceCell = input.parentElement.parentElement.querySelector('.price-cell span');
  if (optQty && qty >= optQty && optPrice) {
    priceCell.textContent = optPrice + ' —Å–æ–º';
  } else {
    priceCell.textContent = price + ' —Å–æ–º';
  }
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
async function checkImage(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = url;
  });
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
function renderProducts() {
  // –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —Å—Ç–∏–ª–µ AliExpress
  const container = document.getElementById('productTable');
  container.innerHTML = '';
  let filtered = isAdmin ? products : products.filter(p => !p.blocked);
  
  console.log('–¢–µ–∫—É—â–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:', currentCategory);
  console.log('–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:', filtered.length);
  
  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è –≤—Å–µ—Ö)
  if (currentCategory === '–≤—Å–µ') {
    // –í —Ä–∞–∑–¥–µ–ª–µ "–í—Å–µ —Ç–æ–≤–∞—Ä—ã" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π "–≤—Å–µ" –∏–ª–∏ –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    filtered = filtered.filter(p => !p.category || p.category.toLowerCase() === '–≤—Å–µ');
  } else {
    // –í –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    filtered = filtered.filter(p => p.category && p.category.toLowerCase() === currentCategory.toLowerCase());
  }
  
  console.log('–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', filtered.length);
  
  const q = (search && search.value) ? search.value.toLowerCase() : '';
  const list = q ? filtered.filter(p => p.title && p.title.toLowerCase().includes(q)) : filtered;

  list.forEach((p, idx) => {
    const card = document.createElement('div');
    card.className = 'product-card';

    // ratings removed per request

    card.innerHTML = `
        <div class="card-image" style="position:relative;">
        ${isAdmin ? `<div style="position:absolute;top:5px;left:5px;background:rgba(0,123,255,0.9);color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;z-index:1;">#${idx + 1}</div>` : ''}
        <img src="${p.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3E–ù–µ—Ç —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E'}" alt="${p.title || ''}" onclick="showImageModal('${p.image}', '${p.title}')" style="cursor:pointer;" />
      </div>
      <div class="card-body">
        ${isAdmin ? `
          <!-- –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞) -->
          <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#f8f9fa; border-radius:6px; margin-bottom:8px;">
            <div style="font-weight:600; font-size:14px; color:#333;">${p.title||'–¢–æ–≤–∞—Ä'}</div>
            <button onclick="toggleProductDetails('product-details-${p.id}')" style="background:#007bff; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px;">‚ñº –î–µ—Ç–∞–ª–∏</button>
          </div>
          
          <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
          <div id="product-details-${p.id}" style="display:none;">
            <button onclick="changeProductImage('${p.id}')" style="width:100%; background:#007bff; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-size:13px; margin-bottom:8px; font-weight:600;">üì∑ –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
            <div class="card-title"><input value="${p.title||''}" onchange="updateProductTitle('${p.id}', this.value)" class="admin-product-input"/></div>
            <select onchange="updateProductCategory('${p.id}', this.value)" class="admin-product-input" style="font-size:12px;padding:6px;margin:4px 0;">
              <option value="–≤—Å–µ" ${(p.category||'–≤—Å–µ')==='–≤—Å–µ'?'selected':''}>–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
              <option value="–Ω–æ–∂–Ω–∏—Ü—ã" ${(p.category||'')==='–Ω–æ–∂–Ω–∏—Ü—ã'?'selected':''}>–ù–æ–∂–Ω–∏—Ü—ã</option>
              <option value="—Å–∫–æ—Ç—á" ${(p.category||'')==='—Å–∫–æ—Ç—á'?'selected':''}>–°–∫–æ—Ç—á</option>
              <option value="–Ω–æ–∂" ${(p.category||'')==='–Ω–æ–∂'?'selected':''}>–ù–æ–∂</option>
            </select>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <input type="number" value="${p.costPrice||0}" onchange="updateProductCostPrice('${p.id}', this.value)" class="admin-product-input" style="width:110px;font-size:13px;color:#666;" placeholder="üíµ –ó–∞–∫—É–ø–∫–∞" step="0.01"/>
              <input type="number" value="${p.price||0}" onchange="updateProductPrice('${p.id}', this.value)" class="admin-product-input" style="width:110px;font-size:16px;font-weight:700;color:#e53935;" placeholder="üí∞ –ü—Ä–æ–¥–∞–∂–∞"/>
              ${p.costPrice && p.price ? `<div style="font-size:11px;font-weight:700;width:100%;color:${(p.price - p.costPrice) > 0 ? '#2e7d32' : '#c62828'};">üìä –ü—Ä–∏–±—ã–ª—å: +${(p.price - p.costPrice).toFixed(2)} —Å–æ–º (${(((p.price - p.costPrice) / p.costPrice) * 100).toFixed(1)}%)</div>` : ''}
            </div>
            <div class="card-opt-info" data-opt-id="${p.id}" style="font-size:12px;color:#007bff;margin-top:4px;">
              ${p.optPrice && p.optQty ? `–û–ø—Ç: ${p.optPrice} —Å–æ–º –ø—Ä–∏ ${p.optQty} —à—Ç` : ''}
            </div>
            <div class="card-actions" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:8px;">
              <button onclick="showMoveProductModal('${p.id}')" style="background:#28a745;flex:1;padding:10px;font-size:13px;" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä">üìç –ú–µ—Å—Ç–æ</button>
              <button onclick="deleteProduct('${p.id}')" style="background:#dc3545;flex:1;padding:10px;font-size:13px;">–£–¥–∞–ª–∏—Ç—å</button>
              <button onclick="toggleProductBlock('${p.id}', ${p.blocked||false})" style="background:${p.blocked?'#ffc107':'#6c757d'};flex:1;padding:10px;font-size:13px;">${p.blocked?'–†–∞–∑–±–ª–æ–∫':'–ó–∞–±–ª–æ–∫'}</button>
              <button onclick="showEditWholesaleModal('${p.id}')" style="background:#17a2b8;flex:1;padding:10px;font-size:13px;">–û–ø—Ç</button>
            </div>
          </div>
        ` : `
          <div class="card-title"><div>${p.title||''}</div></div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <div class="card-price">${p.price || '0'} —Å–æ–º</div>
            ${p.oldPrice ? `<div class="card-oldprice">${p.oldPrice} —Å–æ–º</div>` : ''}
          </div>
          <div class="card-opt-info" data-opt-id="${p.id}" style="font-size:12px;color:#007bff;margin-top:4px;">
            ${p.optPrice && p.optQty ? `–û–ø—Ç: ${p.optPrice} —Å–æ–º –ø—Ä–∏ ${p.optQty} —à—Ç` : ''}
          </div>
          <div class="card-actions">
            <input type="number" min="${p.minQty||1}" value="${p.minQty||1}" class="card-qty-input" style="text-align:center;" oninput="updateCardPrice(this, '${p.id}')" />
            <button onclick="addToCart('${p.id}','${p.title}',${p.price},'${p.image}', this)">–ö—É–ø–∏—Ç—å</button>
          </div>
        `}
      </div>
    `;

    container.appendChild(card);
    // –ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    try {
      const qtyInput = card.querySelector('.card-qty-input');
      if (qtyInput) updateCardPrice(qtyInput, p.id);
    } catch (e) {
      console.error('updateCardPrice init error', e);
    }
  });

}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞
function toggleProductDetails(detailsId) {
  const detailsDiv = document.getElementById(detailsId);
  if (detailsDiv) {
    const isHidden = detailsDiv.style.display === 'none';
    detailsDiv.style.display = isHidden ? 'block' : 'none';
    
    // –ú–µ–Ω—è–µ–º —Å—Ç—Ä–µ–ª–∫—É –Ω–∞ –∫–Ω–æ–ø–∫–µ
    const btn = event.target;
    if (btn && btn.tagName === 'BUTTON') {
      btn.textContent = isHidden ? '‚ñ≤ –°–∫—Ä—ã—Ç—å' : '‚ñº –î–µ—Ç–∞–ª–∏';
    }
  }
}

// –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
function expandAllProducts() {
  const allDetails = document.querySelectorAll('[id^="product-details-"]');
  allDetails.forEach(detail => {
    detail.style.display = 'block';
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
  const allButtons = document.querySelectorAll('.card-body button[onclick^="toggleProductDetails"]');
  allButtons.forEach(btn => {
    btn.textContent = '‚ñ≤ –°–∫—Ä—ã—Ç—å';
  });
  
  Swal.fire({
    icon: 'success',
    title: '–ì–æ—Ç–æ–≤–æ!',
    text: '–í—Å–µ —Ç–æ–≤–∞—Ä—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã',
    timer: 1500,
    showConfirmButton: false
  });
}

// –°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
function collapseAllProducts() {
  const allDetails = document.querySelectorAll('[id^="product-details-"]');
  allDetails.forEach(detail => {
    detail.style.display = 'none';
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
  const allButtons = document.querySelectorAll('.card-body button[onclick^="toggleProductDetails"]');
  allButtons.forEach(btn => {
    btn.textContent = '‚ñº –î–µ—Ç–∞–ª–∏';
  });
  
  Swal.fire({
    icon: 'success',
    title: '–ì–æ—Ç–æ–≤–æ!',
    text: '–í—Å–µ —Ç–æ–≤–∞—Ä—ã —Å–≤–µ—Ä–Ω—É—Ç—ã',
    timer: 1500,
    showConfirmButton: false
  });
}

// –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—É—é —Ü–µ–Ω—É –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
function updateCardPrice(inputEl, productId) {
  try {
    const qty = parseInt(inputEl.value, 10) || 1;
    const product = products.find(p => p.id === productId) || {};
    const card = inputEl.closest && inputEl.closest('.product-card');
    if (!card) return;
    const priceEl = card.querySelector('.card-price');
    let basePrice = product.price || 0;
    const optPrice = product.optPrice || null;
    const optQty = product.optQty || null;
    const optInfoEl = card.querySelector('.card-opt-info');

    if (optQty && optPrice && qty >= optQty) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø—Ç–æ–≤—É—é —Ü–µ–Ω—É –∏ –∑–∞—á–µ—Ä–∫–Ω—É—Ç—É—é —Ä–æ–∑–Ω–∏—á–Ω—É—é
      if (priceEl) priceEl.textContent = optPrice + ' —Å–æ–º';
      // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ä—É—é —Ü–µ–Ω—É —Ä—è–¥–æ–º
      let old = card.querySelector('.card-oldprice');
      if (!old) {
        const span = document.createElement('div');
        span.className = 'card-oldprice';
        span.textContent = basePrice + ' —Å–æ–º';
        span.style.marginLeft = '8px';
        span.style.fontSize = '13px';
        span.style.color = '#888';
        // –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ priceEl
        if (priceEl && priceEl.parentNode) priceEl.parentNode.appendChild(span);
      } else {
        old.textContent = basePrice + ' —Å–æ–º';
      }
      if (optInfoEl) {
        optInfoEl.textContent = `–û–ø—Ç–æ–≤–∞—è —Ü–µ–Ω–∞: ${optPrice} —Å–æ–º (–ø—Ä–∏ ${optQty} —à—Ç)`;
        optInfoEl.style.color = '#d32f2f';
        optInfoEl.style.fontWeight = '700';
      }
    } else {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É –∏ —É–¥–∞–ª—è–µ–º oldprice –µ—Å–ª–∏ –±—ã–ª
      if (priceEl) priceEl.textContent = basePrice + ' —Å–æ–º';
      const old = card.querySelector('.card-oldprice');
      if (old && old.parentNode) old.parentNode.removeChild(old);
      if (optInfoEl) {
        if (optPrice && optQty) {
          optInfoEl.textContent = `–û–ø—Ç: ${optPrice} —Å–æ–º –ø—Ä–∏ ${optQty} —à—Ç`;
          optInfoEl.style.color = '#007bff';
          optInfoEl.style.fontWeight = 'normal';
        } else {
          optInfoEl.textContent = '';
        }
      }
    }
  } catch (err) {
    console.error('updateCardPrice error', err);
  }
}

// –ì–∞–ª–µ—Ä–µ—è-–ø—Ä–µ–≤—å—é –ø–æ —Ç–æ–≤–∞—Ä—É: —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–≤–∞–π–ø–∞—Ç—å
let _gallery = [];
let _galleryIndex = 0;
let _touchStartX = null;

function openPreviewForProduct(productId) {
  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–µ–∞–ª—å–Ω—ã–µ src –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤/–º–∏–Ω–∏-—Ñ–æ—Ç–æ —Å DOM
  const imgs = Array.from(document.querySelectorAll('#productTable img, .cart-mini-img'));
  _gallery = imgs.map(el => ({ src: el.src, title: el.alt || (el.getAttribute('data-title') || ''), el } )).filter(x => x.src);

  console.log('openPreviewForProduct -> collected images for gallery:', _gallery.map(g=>g.src));

  // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏–Ω–¥–µ–∫—Å –ø–æ productId: —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —ç–ª–µ–º–µ–Ω—Ç, —á–µ–π src —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
  const prod = products.find(p => p.id === productId);
  let idx = 0;
  if (prod && prod.image) {
    idx = _gallery.findIndex(g => g.src === prod.image);
    if (idx === -1) idx = 0;
  }
  _galleryIndex = idx;
  showGalleryIndex();

  const block = document.getElementById('previewBlock');
  block.style.display = 'block';
  // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É body

  const prevBtn = document.getElementById('prevPreview');
  const nextBtn = document.getElementById('nextPreview');
  if (_gallery.length <= 1) {
    // –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ç–æ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏
    if (prevBtn) prevBtn.style.display = 'none';
    if (nextBtn) nextBtn.style.display = 'none';
  } else {
    if (prevBtn) { prevBtn.style.display = ''; prevBtn.onclick = prevGallery; }
    if (nextBtn) { nextBtn.style.display = ''; nextBtn.onclick = nextGallery; }
  }

  const img = document.getElementById('previewImg');
  img.ontouchstart = function(e) { _touchStartX = e.touches[0].clientX; };
  img.ontouchend = function(e) {
    if (_touchStartX == null) return;
    const dx = (e.changedTouches[0].clientX - _touchStartX);
    _touchStartX = null;
    if (dx < -40) nextGallery();
    else if (dx > 40) prevGallery();
  };

  document.addEventListener('keydown', _galleryKeyHandler);
}

function _galleryKeyHandler(e) {
  if (e.key === 'ArrowLeft') prevGallery();
  if (e.key === 'ArrowRight') nextGallery();
  if (e.key === 'Escape') closePreview();
}

function showGalleryIndex() {
  const item = _gallery[_galleryIndex] || { src: '', title: '' };
  const img = document.getElementById('previewImg');
  img.src = item.src;
  document.getElementById('previewCaption').textContent = item.title || '';
}

function prevGallery() {
  if (_gallery.length === 0) return;
  _galleryIndex = (_galleryIndex - 1 + _gallery.length) % _gallery.length;
  showGalleryIndex();
}

function nextGallery() {
  if (_gallery.length === 0) return;
  _galleryIndex = (_galleryIndex + 1) % _gallery.length;
  showGalleryIndex();
}

function closePreview() {
  const block = document.getElementById('previewBlock');
  block.style.display = 'none';
  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞
  try {
    document.getElementById('prevPreview').onclick = null;
    document.getElementById('nextPreview').onclick = null;
    document.getElementById('previewImg').ontouchstart = null;
    document.getElementById('previewImg').ontouchend = null;
    document.removeEventListener('keydown', _galleryKeyHandler);
  } catch (e) {}
}

// –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
document.getElementById('closePreview').onclick = function() { closePreview(); };
document.getElementById('previewBlock').onclick = function(e) {
  if (e.target === this) closePreview();
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Å—Ç–∞—Ä—ã–π –∫–æ–¥ —É–¥–∞–ª–µ–Ω, —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Ö–æ–¥ –∏–∑ –º–µ–Ω—é)

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
async function showMoveProductModal(productId) {
  const product = products.find(p => p.id === productId);
  
  if (!product) return;
  
  // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞
  const productCategory = (product.category || '–≤—Å–µ').toLowerCase();
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã —Ç–æ–ª—å–∫–æ –∏–∑ —Ç–æ–π –∂–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  const categoryProducts = products.filter(p => {
    const pCategory = (p.category || '–≤—Å–µ').toLowerCase();
    return pCategory === productCategory;
  });
  
  // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ
  const currentCategoryIndex = categoryProducts.findIndex(p => p.id === productId);
  
  // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ–ø—Ü–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã –∏–∑ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
  const options = {};
  categoryProducts.forEach((p, idx) => {
    options[idx] = `${idx + 1}. ${p.title}`;
  });
  
  const { value: newCategoryPosition } = await Swal.fire({
    title: '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä',
    html: `
      <div style="text-align:left;margin-bottom:15px;">
        <strong>–¢–æ–≤–∞—Ä:</strong> ${product.title}<br>
        <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${product.category || '–í—Å–µ —Ç–æ–≤–∞—Ä—ã'}<br>
        <strong>–¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è:</strong> #${currentCategoryIndex + 1} (–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
      </div>
      <div style="text-align:left;">
        <strong>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</strong>
      </div>
    `,
    input: 'select',
    inputOptions: options,
    inputPlaceholder: '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é',
    showCancelButton: true,
    confirmButtonText: '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞',
    inputValidator: (value) => {
      if (value === undefined || value === null || value === '') {
        return '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é!';
      }
    }
  });
  
  if (newCategoryPosition !== undefined && newCategoryPosition !== null) {
    const targetCategoryIndex = parseInt(newCategoryPosition);
    
    if (targetCategoryIndex === currentCategoryIndex) {
      return Swal.fire('–í–Ω–∏–º–∞–Ω–∏–µ', '–¢–æ–≤–∞—Ä —É–∂–µ –Ω–∞ —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏', 'info');
    }
    
    // –ü–æ–ª—É—á–∞–µ–º ID —Ç–æ–≤–∞—Ä–æ–≤ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    const categoryIds = categoryProducts.map(p => p.id);
    
    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º ID —Ç–æ–≤–∞—Ä–∞
    const [movedId] = categoryIds.splice(currentCategoryIndex, 1);
    categoryIds.splice(targetCategoryIndex, 0, movedId);
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –ø–æ—Ä—è–¥–∫–æ–º
    const updatedCategoryProducts = categoryIds.map(id => 
      categoryProducts.find(p => p.id === id)
    );
    
    // –û–±–Ω–æ–≤–ª—è–µ–º order –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const batch = db.batch();
    
    // –ù–∞—Ö–æ–¥–∏–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const categoryGlobalIndices = categoryProducts.map(cp => 
      products.findIndex(p => p.id === cp.id)
    ).sort((a, b) => a - b);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º order –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤—ã—Ö –ø–æ–∑–∏—Ü–∏–π
    updatedCategoryProducts.forEach((p, localIdx) => {
      const newOrder = categoryGlobalIndices[localIdx];
      batch.update(db.collection('products').doc(p.id), { order: newOrder });
    });
    
    await batch.commit();
    
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
    await loadProducts();
    
    Swal.fire({
      title: '–ì–æ—Ç–æ–≤–æ',
      text: `–¢–æ–≤–∞—Ä –ø–µ—Ä–µ–º–µ—â—ë–Ω —Å –ø–æ–∑–∏—Ü–∏–∏ #${currentCategoryIndex + 1} –Ω–∞ #${targetCategoryIndex + 1}`,
      icon: 'success',
      timer: 1500,
      showConfirmButton: false
    });
  }
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
async function deleteProduct(productId) {
  try {
    const result = await Swal.fire({
      title: '–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?',
      text: "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å!',
      cancelButtonText: '–û—Ç–º–µ–Ω–∞'
    });

    if (result.isConfirmed) {
      await db.collection('products').doc(productId).delete();
      Swal.fire('–£–¥–∞–ª–µ–Ω–æ!', '–¢–æ–≤–∞—Ä –±—ã–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.', 'success');
      loadProducts();
    }
  } catch (error) {
    console.error('Error deleting product:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
const moveModal = document.createElement('div');
moveModal.id = 'moveModal';
moveModal.style.cssText = `
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
`;
moveModal.innerHTML = `
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;">
    <h3>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
    <div style="margin-bottom: 15px;">
      <p>–¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è: <span id="currentPosition">1</span></p>
      <label>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∞ –ø–æ–∑–∏—Ü–∏—é:</label>
      <input type="number" id="moveSteps" value="1" min="1" style="width: 100%; margin-top: 5px;">
    </div>
    <div style="display: flex; justify-content: space-between;">
      <button onclick="closeMoveModal()" style="background: #6c757d;">–û—Ç–º–µ–Ω–∞</button>
      <button onclick="moveProductMultiple()" style="background: #28a745;">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
    </div>
  </div>
`;
document.body.appendChild(moveModal);

let currentMoveProductId = null;
let currentMoveDirection = null;

function showMoveModal(productId, direction) {
  currentMoveProductId = productId;
  currentMoveDirection = direction;
  const product = products.find(p => p.id === productId);
  const currentIndex = products.findIndex(p => p.id === productId);
  document.getElementById('currentPosition').textContent = currentIndex + 1;
  document.getElementById('moveSteps').value = currentIndex + 1;
  moveModal.style.display = 'block';
}

async function moveProductMultiple() {
  if (!currentMoveProductId) return;
  
  try {
    const targetPosition = parseInt(document.getElementById('moveSteps').value) || 1;
    const product = products.find(p => p.id === currentMoveProductId);
    const currentIndex = products.findIndex(p => p.id === currentMoveProductId);
    
    if (!product || currentIndex === -1) return;
    
    const newIndex = Math.max(0, Math.min(products.length - 1, targetPosition - 1));
    
    if (currentIndex === newIndex) {
      closeMoveModal();
      return;
    }
    
    const newProducts = [...products];
    const [movedProduct] = newProducts.splice(currentIndex, 1);
    newProducts.splice(newIndex, 0, movedProduct);
    
    const batch = db.batch();
    newProducts.forEach((p, index) => {
      const productRef = db.collection('products').doc(p.id);
      batch.update(productRef, { order: index });
    });
    
    await batch.commit();
    products = newProducts;
    renderProducts();
    closeMoveModal();
    Swal.fire('–£—Å–ø–µ—Ö!', '–¢–æ–≤–∞—Ä –ø–µ—Ä–µ–º–µ—â–µ–Ω', 'success');
  } catch (error) {
    console.error('Error moving product:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
    closeMoveModal();
  }
}

function closeMoveModal() {
  moveModal.style.display = 'none';
  currentMoveProductId = null;
  currentMoveDirection = null;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø—Ç–æ–≤—ã—Ö —Ü–µ–Ω
const editWholesaleModal = document.createElement('div');
editWholesaleModal.id = 'editWholesaleModal';
editWholesaleModal.style.cssText = `
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
`;
editWholesaleModal.innerHTML = `
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–æ–≤—ã—Ö —Ü–µ–Ω</h3>
    <div style="margin-bottom: 15px;">
      <label>–û–ø—Ç–æ–≤–∞—è —Ü–µ–Ω–∞:</label>
      <input type="number" id="editOptPrice" style="width: 100%; margin-top: 5px;">
    </div>
    <div style="margin-bottom: 15px;">
      <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –æ–ø—Ç–∞:</label>
      <input type="number" id="editOptQty" style="width: 100%; margin-top: 5px;">
    </div>
    <div style="display: flex; justify-content: space-between;">
      <button onclick="closeEditWholesaleModal()" style="background: #6c757d;">–û—Ç–º–µ–Ω–∞</button>
      <button onclick="saveWholesaleChanges()" style="background: #28a745;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
`;
document.body.appendChild(editWholesaleModal);

let currentEditingProductId = null;

function showEditWholesaleModal(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;
  
  currentEditingProductId = productId;
  document.getElementById('editOptPrice').value = product.optPrice || '';
  document.getElementById('editOptQty').value = product.optQty || '';
  editWholesaleModal.style.display = 'block';
}

function closeEditWholesaleModal() {
  editWholesaleModal.style.display = 'none';
  currentEditingProductId = null;
}

async function saveWholesaleChanges() {
  if (!currentEditingProductId) return;
  
  try {
    const optPrice = document.getElementById('editOptPrice').value;
    const optQty = document.getElementById('editOptQty').value;
    
    await db.collection('products').doc(currentEditingProductId).update({
      optPrice: optPrice ? Number(optPrice) : null,
      optQty: optQty ? Number(optQty) : null
    });
    
    Swal.fire('–£—Å–ø–µ—Ö!', '–û–ø—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
    closeEditWholesaleModal();
    loadProducts();
  } catch (error) {
    console.error('Error updating wholesale prices:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã', 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞
// –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤—ã–∑–æ–≤–∞:
// 1) updateProductPrice(productId, newPrice)
// 2) updateProductPrice(productId, field, value)
async function updateProductPrice(productId, field, value) {
  try {
    const updateData = {};

    // –í–∞—Ä–∏–∞–Ω—Ç –≤—ã–∑–æ–≤–∞ (productId, newPrice)
    if (typeof value === 'undefined') {
      const price = Number(field);
      if (isNaN(price) || price < 0) {
        Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É', 'error');
        return;
      }
      updateData['price'] = price;
    } else {
      // –í–∞—Ä–∏–∞–Ω—Ç (productId, field, value)
      const num = Number(value);
      if (isNaN(num)) {
        Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ', 'error');
        return;
      }
      updateData[field] = num;
    }

    await db.collection('products').doc(productId).update(updateData);
    Swal.fire('–£—Å–ø–µ—Ö!', '–¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
    await loadProducts();
  } catch (error) {
    console.error('Error updating product price:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É', 'error');
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
editWholesaleModal.onclick = function(e) {
  if (e.target === this) {
    closeEditWholesaleModal();
  }
};

  

// –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
async function updateProductTitle(productId, newTitle) {
  try {
    await db.collection('products').doc(productId).update({ title: newTitle });
    Swal.fire('–£—Å–ø–µ—Ö!', '–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
    loadProducts();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
  }
}

// –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä
async function toggleProductBlock(productId, currentStatus) {
  try {
    await db.collection('products').doc(productId).update({ blocked: !currentStatus });
    Swal.fire('–£—Å–ø–µ—Ö!', !currentStatus ? '–¢–æ–≤–∞—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–¢–æ–≤–∞—Ä —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
    loadProducts();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏', 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
async function massUpdateCategories() {
  if (!isAdmin) {
    Swal.fire('–û—à–∏–±–∫–∞', '–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'error');
    return;
  }
  
  const { value: action } = await Swal.fire({
    title: '–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π',
    html: `
      <select id="massCategory" class="swal2-input">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</option>
        <option value="scotch_keywords">–°–∫–æ—Ç—á (–ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º)</option>
        <option value="knife_keywords">–ù–æ–∂ (–ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º)</option>
        <option value="all_scotch">–í—Å–µ —Ç–æ–≤–∞—Ä—ã ‚Üí –°–∫–æ—Ç—á</option>
        <option value="all_knife">–í—Å–µ —Ç–æ–≤–∞—Ä—ã ‚Üí –ù–æ–∂</option>
        <option value="all_scissors">–í—Å–µ —Ç–æ–≤–∞—Ä—ã ‚Üí –ù–æ–∂–Ω–∏—Ü—ã</option>
      </select>
    `,
    showCancelButton: true,
    confirmButtonText: '–í—ã–ø–æ–ª–Ω–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞',
    preConfirm: () => {
      return document.getElementById('massCategory').value;
    }
  });
  
  if (!action) return;
  
  try {
    let updated = 0;
    const batch = db.batch();
    
    for (const product of products) {
      const productRef = db.collection('products').doc(product.id);
      let shouldUpdate = false;
      let newCategory = '';
      
      if (action === 'scotch_keywords') {
        const keywords = ['—Å–∫–æ—Ç—á', '–ª–µ–Ω—Ç–∞', 'tape', '–∫–ª–µ–π–∫–∞—è'];
        if (keywords.some(kw => (product.title || '').toLowerCase().includes(kw))) {
          newCategory = '—Å–∫–æ—Ç—á';
          shouldUpdate = true;
        }
      } else if (action === 'knife_keywords') {
        const keywords = ['–Ω–æ–∂', 'knife', '–ª–µ–∑–≤–∏–µ'];
        if (keywords.some(kw => (product.title || '').toLowerCase().includes(kw))) {
          newCategory = '–Ω–æ–∂';
          shouldUpdate = true;
        }
      } else if (action === 'all_scotch') {
        newCategory = '—Å–∫–æ—Ç—á';
        shouldUpdate = true;
      } else if (action === 'all_knife') {
        newCategory = '–Ω–æ–∂';
        shouldUpdate = true;
      } else if (action === 'all_scissors') {
        newCategory = '–Ω–æ–∂–Ω–∏—Ü—ã';
        shouldUpdate = true;
      }
      
      if (shouldUpdate) {
        batch.update(productRef, { category: newCategory });
        updated++;
      }
    }
    
    if (updated > 0) {
      await batch.commit();
      await loadProducts();
      Swal.fire('–£—Å–ø–µ—Ö!', `–û–±–Ω–æ–≤–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${updated}`, 'success');
    } else {
      Swal.fire('–ò–Ω—Ñ–æ', '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'info');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã', 'error');
  }
}

</script>

<!-- –ö–Ω–æ–ø–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ -->
  <div class="scroll-buttons" style="position:fixed;right:20px;bottom:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;">
    <button id="scrollTopBtn" style="background:#007bff;color:#fff;border:none;padding:10px 14px;border-radius:12px;box-shadow:0 2px 8px #0001;cursor:pointer;font-size:18px;">‚ñ≤</button>
    <button id="scrollBottomBtn" style="background:#007bff;color:#fff;border:none;padding:10px 14px;border-radius:12px;box-shadow:0 2px 8px #0001;cursor:pointer;font-size:18px;">‚ñº</button>
  </div>

  <footer id="siteFooter" style="background: #003366; color: #fff; padding:14px 10px; text-align:center; margin-top:18px;">
    <div style="max-width:1200px; margin:0 auto; font-weight:700;">
      –û –Ω–∞—Å: –º—ã –ø–µ—Ä–≤—ã–π —Ä—É–∫ –∏–∑ –∫–∏—Ç–∞—è ‚Äî —É –Ω–∞—Å –Ω–∏–∑–∫–∏–µ —Ü–µ–Ω—ã
    </div>
  </footer>

<script>
// --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ ---
function toggleAdminPanel() {
  const panel = document.getElementById('adminPanel');
  if (panel.classList.contains('admin-panel-hidden')) {
    panel.classList.remove('admin-panel-hidden');
    document.getElementById('hideAdminPanelBtn').textContent = '–°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å';
  } else {
    panel.classList.add('admin-panel-hidden');
    document.getElementById('hideAdminPanelBtn').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å';
  }
}
// –°–º–µ–Ω–∞ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –∞–¥–º–∏–Ω–æ–º
// –ö–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã: –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∫–æ—Ä–∑–∏–Ω–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
const cartFloatBtn = document.getElementById('cartFloatBtn');
const cartFloatCount = document.getElementById('cartFloatCount');
const orderForm = document.querySelector('.order-form');

if (cartFloatBtn) {
  cartFloatBtn.onclick = function() {
    if (orderForm) {
      orderForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };
}

function updateCartFloatCount() {
  if (cartFloatCount) {
    cartFloatCount.textContent = cart.length;
  }
}

// –í—ã–∑–æ–≤–µ–º –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã
const origUpdateCart = updateCart;
updateCart = function() {
  origUpdateCart.apply(this, arguments);
  updateCartFloatCount();
};
document.addEventListener('DOMContentLoaded', updateCartFloatCount);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ç–æ
function showImageModal(imageUrl, title) {
  const previewBlock = document.getElementById('previewBlock');
  const previewImg = document.getElementById('previewImg');
  const previewCaption = document.getElementById('previewCaption');
  const closePreview = document.getElementById('closePreview');
  
  if (previewBlock && previewImg) {
    previewImg.src = imageUrl;
    if (previewCaption) {
      previewCaption.textContent = title || '';
    }
    previewBlock.style.display = 'flex';
    previewBlock.style.alignItems = 'center';
    previewBlock.style.justifyContent = 'center';
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    previewBlock.onclick = function(e) {
      if (e.target === previewBlock) {
        previewBlock.style.display = 'none';
      }
    };
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
    if (closePreview) {
      closePreview.onclick = function() {
        previewBlock.style.display = 'none';
      };
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        previewBlock.style.display = 'none';
      }
    });
  }
}

// ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ß–ê–¢–ê ====================

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –æ–∫–Ω–∞ —á–∞—Ç–∞
async function toggleChat() {
  const chatWindow = document.getElementById('chatWindow');
  
  if (chatWindow.style.display === 'none' || !chatWindow.style.display) {
    // –°–ù–ê–ß–ê–õ–ê –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
    await ensureClientName();
    
    chatWindow.style.display = 'flex';
    document.body.classList.add('modal-open'); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
    resetChatBadge(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
    updateClientNameDisplay();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    await loadChatMessages();
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    setTimeout(() => {
      const messagesDiv = document.getElementById('chatMessages');
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }, 100);
  } else {
    chatWindow.style.display = 'none';
    document.body.classList.remove('modal-open'); // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
function updateClientNameDisplay() {
  const nameDisplay = document.getElementById('clientNameDisplay');
  if (nameDisplay && clientName) {
    nameDisplay.innerHTML = `
      <span>üë§ ${clientName}</span>
      <span style="opacity:0.7; font-size:11px;">‚Ä¢ ID: ${clientId.substring(7, 15)}</span>
    `;
  }
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞
async function changeClientName() {
  const { value: newName } = await Swal.fire({
    title: '–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è',
    input: 'text',
    inputLabel: '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è',
    inputValue: clientName || '',
    showCancelButton: true,
    confirmButtonText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞',
    inputValidator: (value) => {
      if (!value) {
        return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è!';
      }
    }
  });
  
  if (newName && newName !== clientName) {
    clientName = newName;
    localStorage.setItem('chatClientName', newName);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    try {
      if (typeof db !== 'undefined') {
        await db.collection('chatClients').doc(clientId).update({
          name: newName,
          lastActive: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        updateClientNameDisplay();
        
        Swal.fire({
          icon: 'success',
          title: '–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ!',
          text: `–¢–µ–ø–µ—Ä—å –≤—ã: ${newName}`,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 2000
        });
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–º–µ–Ω–∏:', error);
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏–º—è', 'error');
    }
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
async function sendChatMessage() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
  await ensureClientName();
  
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  const messagesDiv = document.getElementById('chatMessages');
  const now = new Date();
  const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = 'background:#667eea; color:white; padding:12px; border-radius:12px 12px 4px 12px; max-width:80%; align-self:flex-end; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
  messageDiv.innerHTML = `
    <div style="font-size:14px;">${escapeHtml(message)}</div>
    <div style="font-size:11px; opacity:0.9; margin-top:4px; text-align:right;">–í—ã ‚Ä¢ ${timeStr}</div>
  `;
  messagesDiv.appendChild(messageDiv);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Firebase —Å clientId
  await saveChatMessage(message, 'client', now);
  
  // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
  input.value = '';
  
  // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ø–µ—á–∞—Ç–∞–µ—Ç..."
  showTypingIndicator();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
function showTypingIndicator() {
  const messagesDiv = document.getElementById('chatMessages');
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typingIndicator';
  typingDiv.style.cssText = 'background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
  typingDiv.innerHTML = `
    <div style="font-size:14px; color:#666;">
      <span style="animation:blink 1.4s infinite;">.</span>
      <span style="animation:blink 1.4s infinite 0.2s;">.</span>
      <span style="animation:blink 1.4s infinite 0.4s;">.</span>
    </div>
  `;
  messagesDiv.appendChild(typingDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç
  if (!document.getElementById('chatAnimationStyle')) {
    const style = document.createElement('style');
    style.id = 'chatAnimationStyle';
    style.textContent = `
      @keyframes blink {
        0%, 60%, 100% { opacity: 0; }
        30% { opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Firebase
async function saveChatMessage(text, sender, timestamp) {
  if (typeof db === 'undefined') return;
  
  try {
    const messageData = {
      text: text,
      sender: sender, // 'client' –∏–ª–∏ 'admin'
      clientId: clientId, // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–ª–∏–µ–Ω—Ç–∞
      clientName: clientName || '–ö–ª–∏–µ–Ω—Ç',
      timestamp: firebase.firestore.Timestamp.fromDate(timestamp),
      read: false
    };
    
    await db.collection('chatMessages').add(messageData);
    console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å clientId:', clientId);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
    if (sender === 'client') {
      await updateClientActivity();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Firebase (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)
async function loadChatMessages() {
  if (typeof db === 'undefined') return;
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
  await ensureClientName();
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    const querySnapshot = await db.collection('chatMessages')
      .where('clientId', '==', clientId)
      .get();
    
    const messagesDiv = document.getElementById('chatMessages');
    messagesDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º
    
    if (querySnapshot.empty) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      messagesDiv.innerHTML = `
        <div style="background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <div style="font-size:14px; color:#333;">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${clientName}! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
          <div style="font-size:11px; color:#999; margin-top:4px;">–ü—Ä–æ–¥–∞–≤–µ—Ü ‚Ä¢ —Ç–æ–ª—å–∫–æ —á—Ç–æ</div>
        </div>
      `;
    } else {
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—Ä—É—á–Ω—É—é
      const messages = [];
      querySnapshot.forEach((doc) => {
        const msg = doc.data();
        messages.push({
          text: msg.text,
          sender: msg.sender,
          timestamp: msg.timestamp.toDate()
        });
      });
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ timestamp
      messages.sort((a, b) => a.timestamp - b.timestamp);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤ UI
      messages.forEach(msg => {
        addChatMessageToUI(msg.text, msg.sender, msg.timestamp);
      });
    }
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    subscribeToChatMessages();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
  }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI
function addChatMessageToUI(text, sender, timestamp) {
  const messagesDiv = document.getElementById('chatMessages');
  const timeStr = timestamp.getHours().toString().padStart(2, '0') + ':' + timestamp.getMinutes().toString().padStart(2, '0');
  
  const messageDiv = document.createElement('div');
  
  if (sender === 'client') {
    messageDiv.style.cssText = 'background:#667eea; color:white; padding:12px; border-radius:12px 12px 4px 12px; max-width:80%; align-self:flex-end; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    messageDiv.innerHTML = `
      <div style="font-size:14px;">${escapeHtml(text)}</div>
      <div style="font-size:11px; opacity:0.9; margin-top:4px; text-align:right;">–í—ã ‚Ä¢ ${timeStr}</div>
    `;
  } else {
    messageDiv.style.cssText = 'background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    messageDiv.innerHTML = `
      <div style="font-size:14px; color:#333;">${escapeHtml(text)}</div>
      <div style="font-size:11px; color:#999; margin-top:4px;">–ü—Ä–æ–¥–∞–≤–µ—Ü ‚Ä¢ ${timeStr}</div>
    `;
  }
  
  messagesDiv.appendChild(messageDiv);
}

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)
function subscribeToChatMessages() {
  if (typeof db === 'undefined') return;
  
  db.collection('chatMessages')
    .where('clientId', '==', clientId) // –¢–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const msg = change.doc.data();
          // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∞ –∏ —á–∞—Ç –∑–∞–∫—Ä—ã—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          if (msg.sender === 'admin' && msg.clientId === clientId) {
            const chatWindow = document.getElementById('chatWindow');
            if (chatWindow.style.display === 'none' || !chatWindow.style.display) {
              showChatNotification();
            }
            // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç..."
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
              typingIndicator.remove();
            }
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            addChatMessageToUI(msg.text, msg.sender, msg.timestamp.toDate());
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
        }
      });
    });
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
function showChatNotification() {
  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
  const chatBtn = document.querySelector('[onclick="toggleChat()"]');
  let badge = document.getElementById('chatBadge');
  if (!badge && chatBtn) {
    badge = document.createElement('span');
    badge.id = 'chatBadge';
    badge.style.cssText = 'position:absolute; top:-5px; right:-5px; background:#ff3b30; color:white; border-radius:50%; width:20px; height:20px; font-size:11px; font-weight:bold; display:flex; align-items:center; justify-content:center; animation:pulse 1s infinite;';
    badge.textContent = '1';
    chatBtn.style.position = 'relative';
    chatBtn.appendChild(badge);
  } else if (badge) {
    badge.textContent = parseInt(badge.textContent || '0') + 1;
  }
  
  // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  playChatNotificationSound();
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  showVisualNotification();
  
  // –ë—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞', {
      body: '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ',
      icon: 'photo_5294190093549636589_y.jpg',
      tag: 'chat-message',
      requireInteraction: false
    });
  }
}

// –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function playChatNotificationSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.3);
  } catch (error) {
    console.log('–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
  }
}

// –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showVisualNotification() {
  const notification = document.createElement('div');
  notification.style.cssText = 'position:fixed; top:20px; right:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px 20px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.3); z-index:10003; animation:slideInRight 0.3s ease-out; cursor:pointer; max-width:300px;';
  notification.innerHTML = `
    <div style="font-weight:bold; margin-bottom:4px;">üí¨ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
    <div style="font-size:13px; opacity:0.9;">–ü—Ä–æ–¥–∞–≤–µ—Ü –æ—Ç–≤–µ—Ç–∏–ª –≤–∞–º</div>
  `;
  
  notification.onclick = () => {
    toggleChat();
    notification.remove();
  };
  
  document.body.appendChild(notification);
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => notification.remove(), 300);
  }, 5000);
}

// –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
function resetChatBadge() {
  const badge = document.getElementById('chatBadge');
  if (badge) {
    badge.remove();
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  document.body.style.overflow = 'auto';
  document.body.style.position = 'relative';
  document.documentElement.style.overflow = 'auto';
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
  
  console.log('–ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:', clientId);
  
  // –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑—è—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ —á–µ—Ä–µ–∑ toggleChat()
});

// –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∂–∞–ª–æ–±—ã
function openComplaintWindow() {
  toggleSideMenu(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
  
  setTimeout(() => {
    document.getElementById('complaintWindow').style.display = 'flex';
    document.body.classList.add('modal-open'); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('complaintName').value = '';
    document.getElementById('complaintPhone').value = '';
    document.getElementById('complaintCategory').value = '';
    document.getElementById('complaintText').value = '';
  }, 300);
}

// –ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∂–∞–ª–æ–±—ã
function closeComplaintWindow() {
  document.getElementById('complaintWindow').style.display = 'none';
  document.body.classList.remove('modal-open'); // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É –≤ Telegram
async function sendComplaint() {
  const name = document.getElementById('complaintName').value.trim();
  const phone = document.getElementById('complaintPhone').value.trim();
  const category = document.getElementById('complaintCategory').value;
  const text = document.getElementById('complaintText').value.trim();
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  if (!name) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è', 'error');
    return;
  }
  
  if (!phone) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
    return;
  }
  
  if (!category) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∂–∞–ª–æ–±—ã', 'error');
    return;
  }
  
  if (!text) {
    Swal.fire('–û—à–∏–±–∫–∞', '–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É', 'error');
    return;
  }
  
  const categoryNames = {
    'quality': 'üî¥ –ö–∞—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞',
    'delivery': 'üöö –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π',
    'service': 'üë§ –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ',
    'price': 'üí∞ –ù–µ–≤–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞',
    'other': 'üìù –î—Ä—É–≥–æ–µ'
  };
  
  const message = `‚ö†Ô∏è *–ñ–ê–õ–û–ë–ê –û–¢ –ö–õ–ò–ï–ù–¢–ê*\n\n` +
    `üë§ *–ò–º—è:* ${name}\n` +
    `üì± *–¢–µ–ª–µ—Ñ–æ–Ω:* ${phone}\n` +
    `üìÇ *–ö–∞—Ç–µ–≥–æ—Ä–∏—è:* ${categoryNames[category]}\n\n` +
    `üìù *–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:*\n${text}\n\n` +
    `üïê *–î–∞—Ç–∞:* ${new Date().toLocaleString('ru-RU')}`;
  
  try {
    Swal.fire({
      title: '–û—Ç–ø—Ä–∞–≤–∫–∞ –∂–∞–ª–æ–±—ã...',
      text: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });
    
    const response = await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendMessage', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        chat_id: '5567924440',
        text: message,
        parse_mode: 'Markdown'
      })
    });
    
    const result = await response.json();
    
    if (result.ok) {
      closeComplaintWindow();
      Swal.fire({
        icon: 'success',
        title: '–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!',
        text: '–ú—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –≤–∞—à—É –∂–∞–ª–æ–±—É –∏ —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è',
        confirmButtonText: '–ü–æ–Ω—è—Ç–Ω–æ'
      });
    } else {
      throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
    }
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∞–ª–æ–±—ã:', error);
    Swal.fire({
      icon: 'error',
      title: '–û—à–∏–±–∫–∞',
      text: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É.'
    });
  }
}

// –§—É–Ω–∫—Ü–∏–∏ –æ–∫–Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
function openSuggestionWindow() {
  toggleSideMenu();
  
  setTimeout(() => {
    document.getElementById('suggestionWindow').style.display = 'flex';
    document.body.classList.add('modal-open'); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
    
    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('suggestionName').value = '';
    document.getElementById('suggestionPhone').value = '';
    document.getElementById('suggestionProductName').value = '';
    document.getElementById('suggestionCurrentPrice').value = '';
    document.getElementById('suggestionPrice').value = '';
    document.getElementById('suggestionDescription').value = '';
    document.getElementById('suggestionPhoto').value = '';
  }, 300);
}

function closeSuggestionWindow() {
  document.getElementById('suggestionWindow').style.display = 'none';
  document.body.classList.remove('modal-open'); // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
}

async function sendSuggestion() {
  const name = document.getElementById('suggestionName').value.trim();
  const phone = document.getElementById('suggestionPhone').value.trim();
  const productName = document.getElementById('suggestionProductName').value.trim();
  const currentPrice = document.getElementById('suggestionCurrentPrice').value.trim();
  const price = document.getElementById('suggestionPrice').value.trim();
  const description = document.getElementById('suggestionDescription').value.trim();
  const photoInput = document.getElementById('suggestionPhoto');
  
  if (!name) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è', 'error');
    return;
  }
  
  if (!phone) {
    Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω', 'error');
    return;
  }
  
  if (!productName) {
    Swal.fire('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', 'error');
    return;
  }
  
  if (!description) {
    Swal.fire('–û—à–∏–±–∫–∞', '–û–ø–∏—à–∏—Ç–µ —Ç–æ–≤–∞—Ä –ø–æ–¥—Ä–æ–±–Ω–µ–µ', 'error');
    return;
  }
  
  try {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –≤ –æ–∫–Ω–µ
    document.getElementById('suggestionLoader').style.display = 'flex';
    document.getElementById('suggestionSubmitBtn').disabled = true;
    
    let message = `üí° *–ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –¢–û–í–ê–†–ê*\n\n` +
      `üë§ *–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:* ${name}\n` +
      `üì± *–¢–µ–ª–µ—Ñ–æ–Ω:* ${phone}\n` +
      `üè∑Ô∏è *–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:* ${productName}\n` +
      `üíµ *–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:* ${currentPrice ? currentPrice + ' —Å–æ–º' : '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n` +
      `üí∞ *–ñ–µ–ª–∞–µ–º–∞—è —Ü–µ–Ω–∞:* ${price ? price + ' —Å–æ–º' : '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n\n` +
      `üìù *–û–ø–∏—Å–∞–Ω–∏–µ:*\n${description}\n\n` +
      `üïê *–î–∞—Ç–∞:* ${new Date().toLocaleString('ru-RU')}`;
    
    let result;
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é –≤ Telegram —á–µ—Ä–µ–∑ sendPhoto —Å —Ñ–∞–π–ª–æ–º
    if (photoInput.files && photoInput.files[0]) {
      console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –≤ Telegram...');
      
      const telegramFormData = new FormData();
      telegramFormData.append('chat_id', '5567924440');
      telegramFormData.append('photo', photoInput.files[0]);
      telegramFormData.append('caption', message);
      
      const response = await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendPhoto', {
        method: 'POST',
        body: telegramFormData
      });
      
      result = await response.json();
      console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å —Ñ–æ—Ç–æ:', result);
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...');
      
      const response = await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendMessage', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          chat_id: '5567924440',
          text: message,
          parse_mode: 'Markdown'
        })
      });
      result = await response.json();
      console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–∞:', result);
    }
    
    if (result.ok) {
      // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
      document.getElementById('suggestionLoader').style.display = 'none';
      document.getElementById('suggestionSubmitBtn').disabled = false;
      
      closeSuggestionWindow();
      Swal.fire({
        icon: 'success',
        title: '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!',
        text: '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ! –ú—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –µ–≥–æ –∏ –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä',
        confirmButtonText: '–û—Ç–ª–∏—á–Ω–æ'
      });
    } else {
      throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
    }
    
  } catch (error) {
    // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ
    document.getElementById('suggestionLoader').style.display = 'none';
    document.getElementById('suggestionSubmitBtn').disabled = false;
    
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:', error);
    Swal.fire({
      icon: 'error',
      title: '–û—à–∏–±–∫–∞',
      text: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É.'
    });
  }
}

// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ==================== –§–£–ù–ö–¶–ò–ò –ë–û–ö–û–í–û–ì–û –ú–ï–ù–Æ ====================

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é
function toggleSideMenu() {
  const sideMenu = document.getElementById('sideMenu');
  const menuOverlay = document.getElementById('menuOverlay');
  const menuBtn = document.getElementById('menuToggleBtn');
  
  if (sideMenu.style.left === '0px') {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
    sideMenu.style.left = '-300px';
    menuOverlay.style.display = 'none';
    document.body.style.overflow = 'auto';
    document.body.style.position = 'relative';
    document.documentElement.style.overflow = 'auto';
  } else {
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
    sideMenu.style.left = '0px';
    menuOverlay.style.display = 'block';
    // –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - –ø—É—Å—Ç—å –º–æ–∂–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å
    // document.body.style.overflow = 'hidden';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∞
    updateAdminMenuState();
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–¥–º–∏–Ω-—Å–µ–∫—Ü–∏–∏ –≤ –º–µ–Ω—é
function updateAdminMenuState() {
  if (isAdmin) {
    document.getElementById('menuAdminLogin').style.display = 'none';
    document.getElementById('menuAdminLoggedIn').style.display = 'flex';
  } else {
    document.getElementById('menuAdminLogin').style.display = 'flex';
    document.getElementById('menuAdminLoggedIn').style.display = 'none';
  }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const sideMenu = document.getElementById('sideMenu');
    if (sideMenu.style.left === '0px') {
      toggleSideMenu();
    }
  }
});

// –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ –∏–∑ –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é
function openChatFromMenu() {
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
  toggleSideMenu();
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
  setTimeout(() => {
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow.style.display !== 'flex') {
      toggleChat();
    }
  }, 300);
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ —á–∞—Ç–∞
async function openAdminChatWindow() {
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
  toggleSideMenu();
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ —á–∞—Ç–∞
  setTimeout(async () => {
    const adminChatWindow = document.getElementById('adminChatWindow');
    adminChatWindow.style.display = 'flex';
    document.body.classList.add('modal-open'); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
    await loadAdminFullChat();
  }, 300);
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
function openAddProductWindow() {
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
  toggleSideMenu();
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
  setTimeout(() => {
    const addProductWindow = document.getElementById('addProductWindow');
    addProductWindow.style.display = 'flex';
    document.body.classList.add('modal-open'); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
    document.getElementById('newTitle').value = '';
    document.getElementById('newCostPrice').value = '';
    document.getElementById('newPrice').value = '';
    document.getElementById('newCategory').value = '';
    document.getElementById('newOptPrice').value = '';
    document.getElementById('newOptQty').value = '';
    document.getElementById('newMinQty').value = '';
    document.getElementById('imageFile').value = '';
    document.getElementById('newImage').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('profitDisplay').style.display = 'none';
  }, 300);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
function closeAddProductWindow() {
  const addProductWindow = document.getElementById('addProductWindow');
  addProductWindow.style.display = 'none';
  document.body.classList.remove('modal-open'); // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏
function openOrdersManagementWindow() {
  toggleSideMenu();
  
  setTimeout(() => {
    const ordersWindow = document.getElementById('ordersManagementWindow');
    ordersWindow.style.display = 'flex';
    document.body.classList.add('modal-open'); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
    loadOrdersManagement();
  }, 300);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏
function closeOrdersManagementWindow() {
  const ordersWindow = document.getElementById('ordersManagementWindow');
  ordersWindow.style.display = 'none';
  document.body.classList.remove('modal-open'); // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
async function loadOrdersManagement() {
  const listDiv = document.getElementById('ordersManagementList');
  listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';
  
  try {
    const ordersSnapshot = await db.collection('orders').get();
    
    if (ordersSnapshot.empty) {
      listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:60px; font-size:16px;">üì≠ –ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
      return;
    }
    
    const dateFilter = document.getElementById('ordersFilterDate').value;
    const statusFilter = document.getElementById('ordersFilterStatus').value;
    const searchQuery = document.getElementById('ordersSearchClient').value.toLowerCase();
    
    const now = Date.now();
    const oneDayMs = 24 * 60 * 60 * 1000;
    
    let orders = [];
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      const timestamp = data.timestamp || Date.now();
      
      // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
      let dateMatch = true;
      if (dateFilter === 'today') {
        dateMatch = (now - timestamp) < oneDayMs;
      } else if (dateFilter === 'week') {
        dateMatch = (now - timestamp) < (7 * oneDayMs);
      } else if (dateFilter === 'month') {
        dateMatch = (now - timestamp) < (30 * oneDayMs);
      }
      
      // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
      const status = data.status || 'pending';
      const statusMatch = statusFilter === 'all' || status === statusFilter;
      
      // –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/—Ç–µ–ª–µ—Ñ–æ–Ω—É
      const name = (data.name || '').toLowerCase();
      const phone = (data.phone || '').toLowerCase();
      const searchMatch = !searchQuery || name.includes(searchQuery) || phone.includes(searchQuery);
      
      if (dateMatch && statusMatch && searchMatch) {
        orders.push({
          id: doc.id,
          ...data,
          timestamp
        });
      }
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞
    orders.sort((a, b) => b.timestamp - a.timestamp);
    
    if (orders.length === 0) {
      listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:60px; font-size:16px;">üîç –ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
      return;
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
    listDiv.innerHTML = '';
    orders.forEach((order, index) => {
      const orderCard = createOrderCard(order, index);
      listDiv.appendChild(orderCard);
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
    listDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
  }
}

// –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–∫–∞–∑–∞
function createOrderCard(order, index) {
  const card = document.createElement('div');
  card.style.cssText = 'background:white; border:2px solid #007bff; border-radius:10px; padding:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,123,255,0.15);';
  
  const date = new Date(order.timestamp);
  const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
  
  const status = order.status || 'pending';
  const statusColors = {
    pending: { bg: '#fff3cd', color: '#856404', text: '‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ' },
    completed: { bg: '#d4edda', color: '#155724', text: '‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω' },
    cancelled: { bg: '#f8d7da', color: '#721c24', text: '‚ùå –û—Ç–º–µ–Ω–µ–Ω' }
  };
  const statusInfo = statusColors[status] || statusColors.pending;
  
  const items = order.items || [];
  const totalItems = items.reduce((sum, item) => sum + item.qty, 0);
  const uniqueItems = items.length; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤
  
  card.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
      <div>
        <div style="font-size:18px; font-weight:700; color:#333; margin-bottom:5px;">
          üì¶ –ó–∞–∫–∞–∑ #${index + 1}
        </div>
        <div style="font-size:14px; color:#666;">
          üë§ <strong>${order.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong> ${order.phone ? '(' + order.phone + ')' : ''}
        </div>
        <div style="font-size:13px; color:#888; margin-top:3px;">
          üìÖ ${dateStr}
        </div>
        <div style="font-size:13px; color:#888; margin-top:3px;">
          üìç ${order.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}
        </div>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
        <span style="background:${statusInfo.bg}; color:${statusInfo.color}; padding:6px 12px; border-radius:6px; font-size:13px; font-weight:600; white-space:nowrap;">
          ${statusInfo.text}
        </span>
        <select onchange="updateOrderStatus('${order.id}', this.value)" style="padding:6px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
          <option value="pending" ${status === 'pending' ? 'selected' : ''}>‚è≥ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
          <option value="completed" ${status === 'completed' ? 'selected' : ''}>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω</option>
          <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>‚ùå –û—Ç–º–µ–Ω–µ–Ω</option>
        </select>
      </div>
    </div>
    
    <div style="background:#f8f9fa; border-radius:8px; padding:12px; margin-bottom:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:600; color:#555;">
          –¢–æ–≤–∞—Ä—ã: <span style="color:#007bff;">${uniqueItems} –≤–∏–¥${uniqueItems === 1 ? '' : uniqueItems < 5 ? '–∞' : '–æ–≤'}</span> ‚Ä¢ <span style="color:#28a745;">${totalItems} —à—Ç</span>
        </div>
        <button onclick="openAddItemToOrderModal('${order.id}')" style="padding:4px 12px; background:#17a2b8; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px; font-weight:600;">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </button>
      </div>
      <div id="orderItems_${order.id}" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>
    
    <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
      <button onclick="openOrderItemsDetailModal('${order.id}', '${(order.name || '–ö–ª–∏–µ–Ω—Ç').replace(/'/g, "\\'")}', '${order.phone || ''}', '${dateStr}')" style="padding:8px 16px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">
        üìã –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–≤–∞—Ä—ã
      </button>
      <button onclick="exportOrderToExcel('${order.id}', '${order.name || '–ö–ª–∏–µ–Ω—Ç'}', '${order.phone || ''}')" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">
        üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
      </button>
      <button onclick="deleteOrder('${order.id}')" style="padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">
        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑
      </button>
    </div>
  `;
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã (—Å–∫—Ä—ã—Ç—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  setTimeout(() => {
    const itemsDiv = document.getElementById(`orderItems_${order.id}`);
    if (itemsDiv) {
      itemsDiv.style.display = 'none';
      items.forEach((item, idx) => {
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'background:white; padding:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center;';
        itemDiv.innerHTML = `
          <div style="flex:1;">
            <div style="font-weight:600; font-size:13px;">${item.title || '–¢–æ–≤–∞—Ä'}</div>
            <div style="font-size:12px; color:#666;">–¶–µ–Ω–∞: ${item.price} —Å–æ–º</div>
          </div>
          <div style="display:flex; align-items:center; gap:10px;">
            <input type="number" 
              value="${item.qty}" 
              min="0" 
              onchange="updateOrderItemQtyManagement('${order.id}', ${idx}, this.value)"
              style="width:70px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:13px;">
            <span style="color:#666; font-size:12px;">—à—Ç</span>
            <button onclick="deleteOrderItem('${order.id}', ${idx})" style="padding:6px 10px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">üóëÔ∏è</button>
          </div>
        `;
        itemsDiv.appendChild(itemDiv);
      });
    }
  }, 10);
  
  return card;
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∑–∞–∫–∞–∑–∞
async function openOrderItemsDetailModal(orderId, clientName, clientPhone, dateStr) {
  const modal = document.getElementById('orderItemsDetailModal');
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  document.getElementById('orderItemsDetailTitle').textContent = `üì¶ –¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ`;
  document.getElementById('orderItemsDetailInfo').textContent = `üë§ ${clientName} ${clientPhone ? '(' + clientPhone + ')' : ''} ‚Ä¢ üìÖ ${dateStr}`;
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
  const contentDiv = document.getElementById('orderItemsDetailContent');
  contentDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>';
  
  try {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    
    if (!orderDoc.exists) {
      contentDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
      return;
    }
    
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    if (items.length === 0) {
      contentDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">üì≠ –í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>';
      return;
    }
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É
    const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
    
    contentDiv.innerHTML = '';
    
    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Ç–æ–≤–∞—Ä–æ–≤
    const tableDiv = document.createElement('div');
    tableDiv.style.cssText = 'background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    
    let tableHTML = `
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#f8f9fa; border-bottom:2px solid #e0e0e0;">
            <th style="padding:12px; text-align:left; font-size:14px; color:#666; font-weight:600;">#</th>
            <th style="padding:12px; text-align:left; font-size:14px; color:#666; font-weight:600;">–¢–æ–≤–∞—Ä</th>
            <th style="padding:12px; text-align:center; font-size:14px; color:#666; font-weight:600;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            <th style="padding:12px; text-align:right; font-size:14px; color:#666; font-weight:600;">–¶–µ–Ω–∞ –∑–∞ —à—Ç</th>
            <th style="padding:12px; text-align:right; font-size:14px; color:#666; font-weight:600;">–°—É–º–º–∞</th>
            <th style="padding:12px; text-align:center; font-size:14px; color:#666; font-weight:600;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    items.forEach((item, idx) => {
      const itemTotal = item.price * item.qty;
      tableHTML += `
        <tr style="border-bottom:1px solid #f0f0f0;">
          <td style="padding:12px; font-size:14px; color:#666;">${idx + 1}</td>
          <td style="padding:12px; font-size:14px; font-weight:600;">${item.title || '–¢–æ–≤–∞—Ä'}</td>
          <td style="padding:12px; text-align:center;">
            <div style="display:flex; align-items:center; gap:8px; justify-content:center;">
              <input type="number" 
                id="itemQty_${orderId}_${idx}" 
                value="${item.qty}" 
                min="0" 
                onchange="updateOrderItemQtyManagement('${orderId}', ${idx}, this.value)"
                style="width:70px; padding:8px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:14px;">
              <span style="color:#666; font-size:13px;">—à—Ç</span>
            </div>
          </td>
          <td style="padding:12px; text-align:right; font-size:14px;">${item.price} —Å–æ–º</td>
          <td style="padding:12px; text-align:right; font-size:15px; font-weight:600; color:#007bff;">${itemTotal.toFixed(2)} —Å–æ–º</td>
          <td style="padding:12px; text-align:center;">
            <button onclick="deleteOrderItemFromModal('${orderId}', ${idx})" style="padding:6px 12px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px; font-weight:600;">
              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
            </button>
          </td>
        </tr>
      `;
    });
    
    tableHTML += `
        </tbody>
        <tfoot>
          <tr style="background:#f8f9fa; border-top:2px solid #e0e0e0;">
            <td colspan="4" style="padding:15px; text-align:right; font-size:16px; font-weight:700; color:#333;">
              –ò—Ç–æ–≥–æ:
            </td>
            <td style="padding:15px; text-align:right; font-size:18px; font-weight:700; color:#28a745;">
              ${total.toFixed(2)} —Å–æ–º
            </td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    `;
    
    tableDiv.innerHTML = tableHTML;
    contentDiv.appendChild(tableDiv);
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
    const addBtn = document.getElementById('orderItemsAddBtn');
    addBtn.onclick = () => {
      closeOrderItemsDetailModal();
      openAddItemToOrderModal(orderId);
    };
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
    contentDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</div>';
  }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–∫–∞–∑–∞
function closeOrderItemsDetailModal() {
  document.getElementById('orderItemsDetailModal').style.display = 'none';
  document.body.classList.remove('modal-open');
}

// –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
async function deleteOrderItemFromModal(orderId, itemIndex) {
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?',
    text: '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –∑–∞–∫–∞–∑–∞?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    if (!orderDoc.exists) {
      throw new Error('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    items.splice(itemIndex, 1);
    
    if (items.length === 0) {
      await Swal.fire({
        title: '–ó–∞–∫–∞–∑ –ø—É—Å—Ç',
        text: '–í –∑–∞–∫–∞–∑–µ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Ç–æ–≤–∞—Ä–æ–≤. –ó–∞–∫–∞–∑ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω.',
        icon: 'warning',
        confirmButtonText: '–ü–æ–Ω—è—Ç–Ω–æ'
      });
      await db.collection('orders').doc(orderId).delete();
      closeOrderItemsDetailModal();
      await loadOrdersManagement();
    } else {
      const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
      await db.collection('orders').doc(orderId).update({ items, total });
      
      Swal.fire({
        icon: 'success',
        title: '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω',
        timer: 1500,
        showConfirmButton: false
      });
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      const clientName = document.getElementById('orderItemsDetailInfo').textContent.split('üë§')[1].split('‚Ä¢')[0].trim();
      const dateStr = document.getElementById('orderItemsDetailInfo').textContent.split('üìÖ')[1].trim();
      await openOrderItemsDetailModal(orderId, clientName, '', dateStr);
    }
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä—ã –∑–∞–∫–∞–∑–∞
function toggleOrderItems(orderId) {
  const itemsDiv = document.getElementById(`orderItems_${orderId}`);
  if (itemsDiv) {
    itemsDiv.style.display = itemsDiv.style.display === 'none' ? 'flex' : 'none';
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
async function updateOrderStatus(orderId, newStatus) {
  try {
    await db.collection('orders').doc(orderId).update({ status: newStatus });
    
    const statusTexts = {
      pending: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
      completed: '–í—ã–ø–æ–ª–Ω–µ–Ω',
      cancelled: '–û—Ç–º–µ–Ω–µ–Ω'
    };
    
    Swal.fire({
      icon: 'success',
      title: '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!',
      text: `–ó–∞–∫–∞–∑ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Å—Ç–∞—Ç—É—Å: ${statusTexts[newStatus]}`,
      timer: 1500,
      showConfirmButton: false
    });
    
    await loadOrdersManagement();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞', 'error');
    await loadOrdersManagement();
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑–µ (–∏–∑ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
async function updateOrderItemQtyManagement(orderId, itemIndex, newQty) {
  await updateOrderItemQty(orderId, itemIndex, newQty);
  await loadOrdersManagement();
}

// –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∑–∞–∫–∞–∑–∞
async function deleteOrderItem(orderId, itemIndex) {
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?',
    text: '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –∑–∞–∫–∞–∑–∞?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    items.splice(itemIndex, 1);
    
    if (items.length === 0) {
      await db.collection('orders').doc(orderId).delete();
      Swal.fire({
        icon: 'info',
        title: '–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω',
        text: '–í—Å–µ —Ç–æ–≤–∞—Ä—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã, –∑–∞–∫–∞–∑ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω',
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      await db.collection('orders').doc(orderId).update({ items });
      Swal.fire({
        icon: 'success',
        title: '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω',
        timer: 1500,
        showConfirmButton: false
      });
    }
    
    await loadOrdersManagement();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
  }
}

// –£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –∑–∞–∫–∞–∑
async function deleteOrder(orderId) {
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?',
    html: '–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –∑–∞–∫–∞–∑?<br><small style="color:#dc3545;">‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</small>',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'üóëÔ∏è –î–∞, —É–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    await db.collection('orders').doc(orderId).delete();
    
    Swal.fire({
      icon: 'success',
      title: '–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω!',
      timer: 1500,
      showConfirmButton: false
    });
    
    await loadOrdersManagement();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑', 'error');
  }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑
let currentOrderIdForAddItem = null;

async function openAddItemToOrderModal(orderId) {
  currentOrderIdForAddItem = orderId;
  document.getElementById('addItemToOrderModal').style.display = 'flex';
  document.body.classList.add('modal-open');
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
  await loadProductsToAdd();
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function closeAddItemToOrderModal() {
  document.getElementById('addItemToOrderModal').style.display = 'none';
  document.body.classList.remove('modal-open');
  currentOrderIdForAddItem = null;
  document.getElementById('searchProductToAdd').value = '';
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
async function loadProductsToAdd() {
  const listDiv = document.getElementById('productsToAddList');
  listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>';
  
  try {
    const productsSnapshot = await db.collection('products').get();
    
    if (productsSnapshot.empty) {
      listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">üì≠ –¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç</div>';
      return;
    }
    
    listDiv.innerHTML = '';
    
    productsSnapshot.forEach(doc => {
      const product = doc.data();
      const productCard = document.createElement('div');
      productCard.className = 'product-to-add-card';
      productCard.dataset.title = (product.title || product.name || '').toLowerCase();
      productCard.style.cssText = 'background:white; border:1px solid #e0e0e0; border-radius:8px; padding:12px; margin-bottom:10px; cursor:pointer; transition:all 0.2s;';
      
      const productName = product.title || product.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const productPrice = product.price || 0;
      const productCostPrice = product.costPrice || 0;
      const productPhoto = product.image || product.photo;
      
      productCard.innerHTML = `
        <div style="display:flex; gap:12px; align-items:center;">
          ${productPhoto ? `<img src="${productPhoto}" style="width:60px; height:60px; object-fit:cover; border-radius:6px;">` : '<div style="width:60px; height:60px; background:#f0f0f0; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:24px;">üì¶</div>'}
          <div style="flex:1;">
            <div style="font-weight:600; font-size:14px; margin-bottom:4px;">${productName}</div>
            <div style="font-size:13px; color:#666;">üí∞ ${productPrice} —Å–æ–º</div>
            ${product.category ? `<div style="font-size:12px; color:#888; margin-top:2px;">üìÅ ${product.category}</div>` : ''}
          </div>
          <button onclick="addProductToOrder('${doc.id}', '${productName.replace(/'/g, "\\'")}', ${productPrice}, ${productCostPrice}); event.stopPropagation();" style="padding:8px 16px; background:#17a2b8; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; white-space:nowrap;">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>
      `;
      
      productCard.onmouseenter = () => productCard.style.background = '#f8f9fa';
      productCard.onmouseleave = () => productCard.style.background = 'white';
      
      listDiv.appendChild(productCard);
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
    listDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</div>';
  }
}

// –§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –ø–æ–∏—Å–∫—É
function filterProductsToAdd() {
  const searchQuery = document.getElementById('searchProductToAdd').value.toLowerCase();
  const cards = document.querySelectorAll('.product-to-add-card');
  
  cards.forEach(card => {
    const title = card.dataset.title || '';
    card.style.display = title.includes(searchQuery) ? 'block' : 'none';
  });
}

// –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –≤ –∑–∞–∫–∞–∑
async function addProductToOrder(productId, productName, productPrice, productCostPrice) {
  if (!currentOrderIdForAddItem) {
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ –≤—ã–±—Ä–∞–Ω –∑–∞–∫–∞–∑', 'error');
    return;
  }
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑
    const orderDoc = await db.collection('orders').doc(currentOrderIdForAddItem).get();
    
    if (!orderDoc.exists) {
      throw new Error('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ç–æ–≤–∞—Ä –≤ –∑–∞–∫–∞–∑–µ
    const existingItemIndex = items.findIndex(item => item.id === productId);
    
    if (existingItemIndex !== -1) {
      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
      items[existingItemIndex].qty += 1;
    } else {
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä
      items.push({
        id: productId,
        title: productName,
        price: productPrice,
        costPrice: productCostPrice,
        qty: 1
      });
    }
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
    const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑
    await db.collection('orders').doc(currentOrderIdForAddItem).update({
      items,
      total
    });
    
    Swal.fire({
      icon: 'success',
      title: '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!',
      text: `${productName} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞–∫–∞–∑`,
      timer: 1500,
      showConfirmButton: false
    });
    
    closeAddItemToOrderModal();
    await loadOrdersManagement();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∑–∞–∫–∞–∑', 'error');
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑ –≤ Excel –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
async function exportOrderToExcel(orderId, clientName, clientPhone) {
  try {
    // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑
    const orderDoc = await db.collection('orders').doc(orderId).get();
    
    if (!orderDoc.exists) {
      throw new Error('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    
    const order = orderDoc.data();
    const items = order.items || [];
    
    if (items.length === 0) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤', 'error');
      return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel
    const date = new Date(order.timestamp || Date.now());
    const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const excelData = [
      ['–ó–ê–ö–ê–ó –ö–õ–ò–ï–ù–¢–ê'],
      [''],
      ['–ö–ª–∏–µ–Ω—Ç:', clientName],
      ['–¢–µ–ª–µ—Ñ–æ–Ω:', clientPhone],
      ['–ê–¥—Ä–µ—Å:', order.address || '–ù–µ —É–∫–∞–∑–∞–Ω'],
      ['–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞:', dateStr],
      [''],
      ['‚Ññ', '–¢–æ–≤–∞—Ä', '–¶–µ–Ω–∞ –∑–∞ —à—Ç', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–°—É–º–º–∞']
    ];
    
    // –¢–æ–≤–∞—Ä—ã
    let totalAmount = 0;
    items.forEach((item, index) => {
      const itemTotal = item.price * item.qty;
      totalAmount += itemTotal;
      excelData.push([
        index + 1,
        item.title || '–¢–æ–≤–∞—Ä',
        item.price + ' —Å–æ–º',
        item.qty + ' —à—Ç',
        itemTotal.toFixed(2) + ' —Å–æ–º'
      ]);
    });
    
    // –ò—Ç–æ–≥–æ
    excelData.push(['']);
    excelData.push(['', '', '', '–ò–¢–û–ì–û:', totalAmount.toFixed(2) + ' —Å–æ–º']);
    excelData.push(['']);
    excelData.push(['‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ó–∞–∫–∞–∑ –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º']);
    
    // –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫
    ws['!cols'] = [
      { wch: 5 },   // ‚Ññ
      { wch: 30 },  // –¢–æ–≤–∞—Ä
      { wch: 15 },  // –¶–µ–Ω–∞
      { wch: 15 },  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
      { wch: 15 }   // –°—É–º–º–∞
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, '–ó–∞–∫–∞–∑');
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    
    // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
    const formData = new FormData();
    const fileName = `–ó–∞–∫–∞–∑_${clientName.replace(/\s+/g, '_')}_${Date.now()}.xlsx`;
    formData.append('document', blob, fileName);
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    const message = `üì¶ *–ó–∞–∫–∞–∑ –∏–∑–º–µ–Ω–µ–Ω*\n\n` +
      `üë§ –ö–ª–∏–µ–Ω—Ç: ${clientName}\n` +
      `üì± –¢–µ–ª–µ—Ñ–æ–Ω: ${clientPhone}\n` +
      `üìÖ –î–∞—Ç–∞: ${dateStr}\n` +
      `üìç –ê–¥—Ä–µ—Å: ${order.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}\n\n` +
      `üîÑ *–ó–∞–∫–∞–∑ –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º*\n` +
      `üìä –¢–æ–≤–∞—Ä–æ–≤: ${items.length}\n` +
      `üí∞ –°—É–º–º–∞: ${totalAmount.toFixed(2)} —Å–æ–º`;
    
    formData.append('chat_id', '5567924440');
    formData.append('caption', message);
    formData.append('parse_mode', 'Markdown');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
    Swal.fire({
      title: '–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram...',
      text: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
    const response = await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.ok) {
      Swal.fire({
        icon: 'success',
        title: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!',
        html: `Excel —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram<br><strong>${clientName}</strong>`,
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      throw new Error(result.description || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
    }
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
    Swal.fire({
      icon: 'error',
      title: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏',
      text: error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª –≤ Telegram'
    });
  }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ —á–∞—Ç–∞
function closeAdminChatWindow() {
  const adminChatWindow = document.getElementById('adminChatWindow');
  adminChatWindow.style.display = 'none';
  document.body.classList.remove('modal-open'); // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–µ –æ–∫–Ω–æ –∞–¥–º–∏–Ω–∞
async function loadAdminFullChat() {
  if (typeof db === 'undefined') {
    document.getElementById('adminFullChatMessages').innerHTML = '<div style="text-align:center; color:#999; padding:40px;">Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>';
    return;
  }
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
    const clientsSnapshot = await db.collection('chatClients').get();
    
    const messagesDiv = document.getElementById('adminFullChatMessages');
    messagesDiv.innerHTML = `
      <div style="display:flex; height:100%; background:#f8f9fa;">
        <div id="fullClientsList" style="width:280px; border-right:2px solid #e0e0e0; overflow-y:auto; padding:16px; background:white;">
          <div style="font-weight:bold; margin-bottom:16px; color:#333; font-size:17px; padding:12px; background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius:10px; text-align:center;">
            üìã –ö–ª–∏–µ–Ω—Ç—ã (${clientsSnapshot.size})
          </div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column;">
          <div id="fullChatHeader" style="padding:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; font-weight:bold; display:none;">
            <div style="font-size:20px;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</div>
          </div>
          <div id="fullChatMessagesArea" style="flex:1; display:flex; flex-direction:column; padding:20px; overflow-y:auto; background:#f5f5f5; gap:12px;">
            <div style="text-align:center; color:#999; padding:60px; font-size:18px;">
              üëà –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞
            </div>
          </div>
        </div>
      </div>
    `;
    
    const clientsList = document.getElementById('fullClientsList');
    
    if (clientsSnapshot.empty) {
      clientsList.innerHTML += '<div style="color:#999; font-size:14px; text-align:center; margin-top:60px; padding:30px; line-height:1.6;">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤.<br>–ö–ª–∏–µ–Ω—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.</div>';
      return;
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
    const clients = [];
    clientsSnapshot.forEach((doc) => {
      clients.push({ id: doc.id, data: doc.data() });
    });
    
    clients.sort((a, b) => {
      const timeA = a.data.lastActive ? a.data.lastActive.toDate().getTime() : 0;
      const timeB = b.data.lastActive ? b.data.lastActive.toDate().getTime() : 0;
      return timeB - timeA;
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–æ–∫
    clients.forEach(({id, data: client}) => {
      const clientDiv = document.createElement('div');
      clientDiv.style.cssText = `
        padding:14px; margin-bottom:12px; background:${client.hasUnread ? '#fff9c4' : '#f8f9fa'}; 
        border-radius:12px; cursor:pointer; transition:all 0.2s; border:2px solid transparent;
      `;
      clientDiv.innerHTML = `
        <div style="font-weight:bold; color:#333; margin-bottom:6px; font-size:16px;">${client.name}</div>
        <div style="font-size:12px; color:#666;">
          ${client.lastActive ? new Date(client.lastActive.toDate()).toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          }) : '–î–∞–≤–Ω–æ'}
        </div>
        ${client.hasUnread ? '<div style="font-size:11px; color:#f57c00; font-weight:bold; margin-top:8px;">üîî –ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï</div>' : ''}
      `;
      
      clientDiv.onmouseover = () => clientDiv.style.borderColor = '#667eea';
      clientDiv.onmouseout = () => {
        if (selectedClientId !== id) clientDiv.style.borderColor = 'transparent';
      };
      
      clientDiv.onclick = () => loadFullClientMessages(id, client.name, clientDiv);
      clientsList.appendChild(clientDiv);
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:', error);
    document.getElementById('adminFullChatMessages').innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>';
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º –æ–∫–Ω–µ
async function loadFullClientMessages(clientId, clientName, clientDiv) {
  selectedClientId = clientId;
  selectedClientName = clientName;
  
  // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
  document.querySelectorAll('#fullClientsList > div').forEach(div => {
    if (div.style && div !== clientDiv) {
      div.style.borderColor = 'transparent';
      div.style.background = '#f8f9fa';
    }
  });
  if (clientDiv) {
    clientDiv.style.borderColor = '#667eea';
    clientDiv.style.background = '#e3f2fd';
  }
  
  // –£–±–∏—Ä–∞–µ–º –º–µ—Ç–∫—É "–Ω–æ–≤–æ–µ"
  try {
    await db.collection('chatClients').doc(clientId).update({ hasUnread: false });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const chatHeader = document.getElementById('fullChatHeader');
  chatHeader.style.display = 'flex';
  chatHeader.style.justifyContent = 'space-between';
  chatHeader.style.alignItems = 'center';
  chatHeader.innerHTML = `
    <div>
      <div style="font-size:20px;">üí¨ –ß–∞—Ç —Å ${clientName}</div>
      <div style="font-size:13px; opacity:0.9; margin-top:6px;">ID: ${clientId}</div>
    </div>
    <button onclick="changeClientNameByAdmin()" style="background:rgba(255,255,255,0.25); border:none; color:white; font-size:20px; cursor:pointer; padding:10px; border-radius:10px; min-width:50px; height:50px; display:flex; align-items:center; justify-content:center; transition:background 0.2s;" title="–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞" onmouseover="this.style.background='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'">
      ‚úèÔ∏è
    </button>
  `;
  
  try {
    const querySnapshot = await db.collection('chatMessages')
      .where('clientId', '==', clientId)
      .get();
    
    const chatArea = document.getElementById('fullChatMessagesArea');
    chatArea.innerHTML = '';
    
    if (querySnapshot.empty) {
      chatArea.innerHTML = `<div style="text-align:center; color:#999; padding:60px; font-size:16px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π —Å ${clientName}</div>`;
      return;
    }
    
    const messages = [];
    querySnapshot.forEach((doc) => {
      const msg = doc.data();
      messages.push({
        text: msg.text,
        sender: msg.sender,
        timestamp: msg.timestamp.toDate()
      });
    });
    
    messages.sort((a, b) => a.timestamp - b.timestamp);
    
    messages.forEach(msg => {
      addAdminFullChatMessageToUI(msg.text, msg.sender, msg.timestamp);
    });
    
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º placeholder
    const inputField = document.getElementById('adminFullChatInput');
    if (inputField) {
      inputField.placeholder = `–û—Ç–≤–µ—Ç–∏—Ç—å ${clientName}...`;
    }
    
    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    subscribeToAdminFullChatMessages(clientId);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
    document.getElementById('fullChatMessagesArea').innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
  }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ —á–∞—Ç–∞
function addAdminFullChatMessageToUI(text, sender, timestamp) {
  const chatArea = document.getElementById('fullChatMessagesArea');
  if (!chatArea) return;
  
  const timeStr = timestamp.getHours().toString().padStart(2, '0') + ':' + timestamp.getMinutes().toString().padStart(2, '0');
  const dateStr = timestamp.toLocaleDateString('ru-RU');
  
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = 'display:flex;';
  
  const msgContent = document.createElement('div');
  
  if (sender === 'client') {
    msgContent.style.cssText = 'background:white; padding:14px; border-radius:14px 14px 14px 4px; max-width:70%; box-shadow:0 2px 6px rgba(0,0,0,0.1);';
    msgContent.innerHTML = `
      <div style="font-size:13px; color:#667eea; font-weight:bold; margin-bottom:6px;">üë§ ${selectedClientName || '–ö–ª–∏–µ–Ω—Ç'}</div>
      <div style="font-size:15px; color:#333;">${escapeHtml(text)}</div>
      <div style="font-size:11px; color:#999; margin-top:6px;">${dateStr} ${timeStr}</div>
    `;
  } else {
    messageDiv.style.justifyContent = 'flex-end';
    msgContent.style.cssText = 'background:#667eea; color:white; padding:14px; border-radius:14px 14px 4px 14px; max-width:70%; box-shadow:0 2px 6px rgba(0,0,0,0.15);';
    msgContent.innerHTML = `
      <div style="font-size:13px; font-weight:bold; margin-bottom:6px; opacity:0.9;">‚úÖ –í—ã</div>
      <div style="font-size:15px;">${escapeHtml(text)}</div>
      <div style="font-size:11px; opacity:0.9; margin-top:6px; text-align:right;">${dateStr} ${timeStr}</div>
    `;
  }
  
  messageDiv.appendChild(msgContent);
  chatArea.appendChild(messageDiv);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º –æ–∫–Ω–µ
async function sendAdminFullChatMessage() {
  if (!selectedClientId) {
    Swal.fire('–û—à–∏–±–∫–∞', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞', 'warning');
    return;
  }
  
  const input = document.getElementById('adminFullChatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  const now = new Date();
  
  try {
    addAdminFullChatMessageToUI(message, 'admin', now);
    
    await db.collection('chatMessages').add({
      text: message,
      sender: 'admin',
      clientId: selectedClientId,
      clientName: selectedClientName,
      timestamp: firebase.firestore.Timestamp.fromDate(now),
      read: false
    });
    
    input.value = '';
    
    const chatArea = document.getElementById('fullChatMessagesArea');
    chatArea.scrollTop = chatArea.scrollHeight;
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
  }
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∞–¥–º–∏–Ω–æ–º
async function changeClientNameByAdmin() {
  if (!selectedClientId) {
    Swal.fire('–û—à–∏–±–∫–∞', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞', 'warning');
    return;
  }
  
  const { value: newName } = await Swal.fire({
    title: '–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞',
    input: 'text',
    inputLabel: '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞',
    inputValue: selectedClientName || '',
    showCancelButton: true,
    confirmButtonText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞',
    inputValidator: (value) => {
      if (!value) {
        return '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è!';
      }
    }
  });
  
  if (newName && newName !== selectedClientName) {
    try {
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      await db.collection('chatClients').doc(selectedClientId).update({
        name: newName,
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
      selectedClientName = newName;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
      const chatHeader = document.getElementById('fullChatHeader');
      if (chatHeader) {
        chatHeader.querySelector('div > div:first-child').textContent = `üí¨ –ß–∞—Ç —Å ${newName}`;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º placeholder –ø–æ–ª—è –≤–≤–æ–¥–∞
      const inputField = document.getElementById('adminFullChatInput');
      if (inputField) {
        inputField.placeholder = `–û—Ç–≤–µ—Ç–∏—Ç—å ${newName}...`;
      }
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–æ–≤–æ–µ –∏–º—è
      await loadAdminFullChat();
      
      Swal.fire({
        icon: 'success',
        title: '–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ!',
        text: `–ö–ª–∏–µ–Ω—Ç —Ç–µ–ø–µ—Ä—å: ${newName}`,
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000
      });
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–º–µ–Ω–∏:', error);
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞', 'error');
    }
  }
}

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º –æ–∫–Ω–µ
function subscribeToAdminFullChatMessages(clientId) {
  if (typeof db === 'undefined') return;
  
  db.collection('chatMessages')
    .where('clientId', '==', clientId)
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const msg = change.doc.data();
          if (msg.sender === 'client' && msg.clientId === selectedClientId) {
            const chatArea = document.getElementById('fullChatMessagesArea');
            const existingMessages = chatArea.querySelectorAll('div');
            let isDuplicate = false;
            existingMessages.forEach(div => {
              if (div.textContent && div.textContent.includes(msg.text)) {
                isDuplicate = true;
              }
            });
            
            if (!isDuplicate) {
              addAdminFullChatMessageToUI(msg.text, msg.sender, msg.timestamp.toDate());
              chatArea.scrollTop = chatArea.scrollHeight;
            }
          }
        }
      });
    });
}

// –í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ –º–µ–Ω—é
function loginAdminFromMenu() {
  const password = document.getElementById('menuAdminPassword').value;
  
  if (password === ADMIN_PASSWORD) {
    isAdmin = true;
    
    const managementHeader = document.getElementById('managementHeader');
    
    if (managementHeader) managementHeader.style.display = 'table-cell';
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–µ–Ω—é
    document.getElementById('menuAdminLogin').style.display = 'none';
    document.getElementById('menuAdminLoggedIn').style.display = 'flex';
    
    Swal.fire('–£—Å–ø–µ—Ö!', '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', 'success');
    renderProducts();
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
    toggleSideMenu();
  } else {
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
  }
}

// –í—ã—Ö–æ–¥ –∏–∑ —Ä–µ–∂–∏–º–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
function logoutAdmin() {
  isAdmin = false;
  
  const managementHeader = document.getElementById('managementHeader');
  
  if (managementHeader) managementHeader.style.display = 'none';
  
  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–µ–Ω—é
  document.getElementById('menuAdminLogin').style.display = 'flex';
  document.getElementById('menuAdminLoggedIn').style.display = 'none';
  document.getElementById('menuAdminPassword').value = '';
  
  renderProducts();
  
  Swal.fire('–í—ã—Ö–æ–¥', '–í—ã –≤—ã—à–ª–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'info');
  toggleSideMenu();
}

// ==================== –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –ë–û–ö–û–í–û–ì–û –ú–ï–ù–Æ ====================

// ==================== –û–¢–ß–ï–¢ –ü–û –ü–†–ò–ë–´–õ–ò ====================

// –û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –æ—Ç—á–µ—Ç–∞ –ø–æ –ø—Ä–∏–±—ã–ª–∏
function openProfitReport() {
  document.getElementById('profitReportWindow').style.display = 'block';
  document.body.classList.add('modal-open'); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
  loadProfitReport();
  toggleSideMenu(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
}

// –ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –æ—Ç—á–µ—Ç–∞
function closeProfitReport() {
  document.getElementById('profitReportWindow').style.display = 'none';
  document.body.classList.remove('modal-open'); // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞
function loadProfitReport() {
  const productsWithCost = products.filter(p => p.costPrice && p.price);
  
  // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é –ø—Ä–∏–±—ã–ª—å –∏ —Å—Ä–µ–¥–Ω—é—é –Ω–∞—Ü–µ–Ω–∫—É
  let totalProfit = 0;
  let totalMarkup = 0;
  let count = 0;
  
  productsWithCost.forEach(p => {
    const profit = p.price - p.costPrice;
    const markup = ((profit / p.costPrice) * 100);
    totalProfit += profit;
    totalMarkup += markup;
    count++;
  });
  
  const avgMarkup = count > 0 ? (totalMarkup / count).toFixed(1) : 0;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
  document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' —Å–æ–º';
  document.getElementById('avgMarkup').textContent = avgMarkup + '%';
  document.getElementById('totalProducts').textContent = productsWithCost.length;
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
  filterProfitReport();
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç—á–µ—Ç–∞
function filterProfitReport() {
  const category = document.getElementById('profitCategoryFilter').value;
  const sortBy = document.getElementById('profitSortFilter').value;
  
  let filtered = products.filter(p => p.costPrice && p.price);
  
  // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  if (category) {
    filtered = filtered.filter(p => (p.category || '–≤—Å–µ').toLowerCase() === category.toLowerCase());
  }
  
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
  filtered.sort((a, b) => {
    const profitA = a.price - a.costPrice;
    const profitB = b.price - b.costPrice;
    const markupA = ((profitA / a.costPrice) * 100);
    const markupB = ((profitB / b.costPrice) * 100);
    
    switch(sortBy) {
      case 'profit-desc': return profitB - profitA;
      case 'profit-asc': return profitA - profitB;
      case 'markup-desc': return markupB - markupA;
      case 'markup-asc': return markupA - markupB;
      case 'name': return (a.title || '').localeCompare(b.title || '');
      default: return profitB - profitA;
    }
  });
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ —Ç–∞–±–ª–∏—Ü–µ
  const tbody = document.getElementById('profitReportBody');
  tbody.innerHTML = '';
  
  filtered.forEach((p, index) => {
    const profit = p.price - p.costPrice;
    const markup = ((profit / p.costPrice) * 100).toFixed(1);
    const profitColor = profit > 0 ? '#28a745' : profit < 0 ? '#dc3545' : '#ffc107';
    
    const row = document.createElement('tr');
    row.style.borderBottom = '1px solid #e0e0e0';
    row.innerHTML = `
      <td style="padding:12px; font-size:14px; color:#666;">${index + 1}</td>
      <td style="padding:12px; font-size:14px; font-weight:600;">${p.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</td>
      <td style="padding:12px; font-size:13px; text-align:center; color:#666;">${p.category || '–≤—Å–µ'}</td>
      <td style="padding:12px; font-size:14px; text-align:right; color:#666;">${p.costPrice.toFixed(2)} —Å–æ–º</td>
      <td style="padding:12px; font-size:14px; text-align:right; font-weight:600;">${p.price.toFixed(2)} —Å–æ–º</td>
      <td style="padding:12px; font-size:14px; text-align:right; font-weight:700; color:${profitColor};">${profit > 0 ? '+' : ''}${profit.toFixed(2)} —Å–æ–º</td>
      <td style="padding:12px; font-size:14px; text-align:right; font-weight:700; color:${profitColor};">${markup}%</td>
    `;
    tbody.appendChild(row);
  });
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="padding:30px; text-align:center; color:#999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
async function exportProfitToExcel() {
  const category = document.getElementById('profitCategoryFilter').value;
  let filtered = products.filter(p => p.costPrice && p.price);
  
  if (category) {
    filtered = filtered.filter(p => (p.category || '–≤—Å–µ').toLowerCase() === category.toLowerCase());
  }
  
  const wb = XLSX.utils.book_new();
  const wsData = [
    ['‚Ññ', '–¢–æ–≤–∞—Ä', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏', '–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏', '–ü—Ä–∏–±—ã–ª—å', '–ù–∞—Ü–µ–Ω–∫–∞ %']
  ];
  
  filtered.forEach((p, index) => {
    const profit = p.price - p.costPrice;
    const markup = ((profit / p.costPrice) * 100).toFixed(1);
    wsData.push([
      index + 1,
      p.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
      p.category || '–≤—Å–µ',
      p.costPrice,
      p.price,
      profit.toFixed(2),
      markup
    ]);
  });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–∏
  const totalProfit = filtered.reduce((sum, p) => sum + (p.price - p.costPrice), 0);
  const avgMarkup = filtered.length > 0 
    ? (filtered.reduce((sum, p) => sum + ((p.price - p.costPrice) / p.costPrice * 100), 0) / filtered.length).toFixed(1)
    : 0;
  
  wsData.push([]);
  wsData.push(['', '', '', '', '–ò–¢–û–ì–û:', totalProfit.toFixed(2), avgMarkup + '%']);
  
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, '–û—Ç—á–µ—Ç –ø–æ –ø—Ä–∏–±—ã–ª–∏');
  XLSX.writeFile(wb, `–û—Ç—á–µ—Ç_–ø–æ_–ø—Ä–∏–±—ã–ª–∏_${new Date().toLocaleDateString()}.xlsx`);
  
  Swal.fire('–ì–æ—Ç–æ–≤–æ!', '–û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ Excel', 'success');
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –≤ –æ—Ç—á–µ—Ç–µ
function switchProfitTab(tab) {
  const tabProducts = document.getElementById('tabProducts');
  const tabOrders = document.getElementById('tabOrders');
  const productsPanel = document.getElementById('profitProductsPanel');
  const ordersPanel = document.getElementById('profitOrdersPanel');
  const productsTable = document.getElementById('profitProductsTable');
  const ordersTable = document.getElementById('profitOrdersTable');
  
  if (tab === 'products') {
    tabProducts.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
    tabProducts.style.color = 'white';
    tabProducts.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
    tabOrders.style.background = '#e9ecef';
    tabOrders.style.color = '#333';
    tabOrders.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
    productsPanel.style.display = 'block';
    ordersPanel.style.display = 'none';
    productsTable.style.display = 'block';
    ordersTable.style.display = 'none';
  } else {
    tabOrders.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
    tabOrders.style.color = 'white';
    tabOrders.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
    tabProducts.style.background = '#e9ecef';
    tabProducts.style.color = '#333';
    tabProducts.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
    productsPanel.style.display = 'none';
    ordersPanel.style.display = 'block';
    productsTable.style.display = 'none';
    ordersTable.style.display = 'block';
    loadOrderProfitReport();
  }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç –ø–æ –∑–∞–∫–∞–∑–∞–º
async function loadOrderProfitReport() {
  console.log('üîµ loadOrderProfitReport –í–´–ó–í–ê–ù–ê');
  try {
    const ordersSnapshot = await db.collection('orders').get();
    const orders = [];
    
    console.log('üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Firebase:', ordersSnapshot.size);
    
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      orders.push({
        id: doc.id,
        ...data,
        timestamp: data.timestamp || Date.now()
      });
    });
    
    console.log('üìã –ó–∞–∫–∞–∑—ã –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', orders.length);
    
    await filterOrderProfitReport(orders);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã', 'error');
  }
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º
async function filterOrderProfitReport(ordersData = null) {
  console.log('üü¢ filterOrderProfitReport –í–´–ó–í–ê–ù–ê, –ø–æ–ª—É—á–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤:', ordersData ? ordersData.length : 'null');
  
  const dateFilter = document.getElementById('orderDateFilter').value;
  const sortBy = document.getElementById('orderSortFilter').value;
  
  console.log('üîç –§–∏–ª—å—Ç—Ä—ã:', { dateFilter, sortBy });
  
  // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω–æ–≤–æ
  if (!ordersData) {
    console.log('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã, –≤—ã–∑—ã–≤–∞—é loadOrderProfitReport');
    loadOrderProfitReport();
    return;
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —Å —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å—é –∏–∑ Firebase
  let productsMap = new Map();
  try {
    const productsSnapshot = await db.collection('products').get();
    console.log('üõçÔ∏è –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Firebase:', productsSnapshot.size);
    
    productsSnapshot.forEach(doc => {
      const data = doc.data();
      productsMap.set(doc.id, {
        name: data.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä',
        costPrice: data.costPrice || 0,
        salePrice: data.price || 0
      });
    });
    
    console.log('üí∞ –¢–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ä—Ç–µ:', productsMap.size);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
  }
  
  // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
  const now = Date.now();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayStart = today.getTime();
  const yesterdayStart = todayStart - 86400000;
  const weekStart = todayStart - 7 * 86400000;
  const monthStart = todayStart - 30 * 86400000;
  
  let filtered = ordersData.filter(order => {
    const orderTime = order.timestamp;
    switch(dateFilter) {
      case 'today': return orderTime >= todayStart;
      case 'yesterday': return orderTime >= yesterdayStart && orderTime < todayStart;
      case 'week': return orderTime >= weekStart;
      case 'month': return orderTime >= monthStart;
      case 'all': return true;
      default: return true;
    }
  });
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏–±—ã–ª—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞
  const ordersWithProfit = filtered.map(order => {
    let totalCost = 0;
    let totalSale = 0;
    let totalProfit = 0; // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Å—É–º–º—ã –ø—Ä–∏–±—ã–ª–∏
    const items = order.items || [];
    
    console.log('=== –ó–ê–ö–ê–ó ===', {
      name: order.name,
      phone: order.phone,
      timestamp: new Date(order.timestamp).toLocaleString()
    });
    
    items.forEach(item => {
      const productData = productsMap.get(item.id);
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ –∑–∞–∫–∞–∑–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏–∑ –±–∞–∑—ã —Ç–æ–≤–∞—Ä–æ–≤
      const costPrice = item.costPrice || (productData ? productData.costPrice : 0);
      const itemCost = costPrice * item.qty;
      const itemSale = item.price * item.qty;
      // –ï—Å–ª–∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å = 0 –∏–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –ø—Ä–∏–±—ã–ª—å = 0
      const itemProfit = costPrice > 0 ? (itemSale - itemCost) : 0;
      
      console.log('üì¶ –¢–æ–≤–∞—Ä:', item.title || (productData ? productData.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä'), {
        'ID —Ç–æ–≤–∞—Ä–∞': item.id,
        '–ù–∞–∑–≤–∞–Ω–∏–µ': item.title,
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': item.qty,
        '–¶–µ–Ω–∞ –≤ –∑–∞–∫–∞–∑–µ (–∑–∞ —à—Ç)': item.price,
        '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ –∑–∞–∫–∞–∑–∞': item.costPrice,
        '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ –±–∞–∑—ã': productData ? productData.costPrice : 0,
        '–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å': costPrice,
        '---': '---',
        '–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏': itemSale,
        '–°—É–º–º–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏': itemCost,
        '–ü–†–ò–ë–´–õ–¨': itemProfit,
        '---2': '---',
        '–†–∞—Å—á–µ—Ç': `(${item.price} √ó ${item.qty}) - (${costPrice} √ó ${item.qty}) = ${itemSale} - ${itemCost} = ${itemProfit}`
      });
      
      // –°—á–∏—Ç–∞–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, –ø—Ä–æ–¥–∞–∂—É –∏ –ø—Ä–∏–±—ã–ª—å (–ø—Ä–∏–±—ã–ª—å = 0 –µ—Å–ª–∏ costPrice = 0)
      totalCost += costPrice * item.qty;
      totalSale += item.price * item.qty;
      totalProfit += itemProfit; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é –ø—Ä–∏–±—ã–ª—å —Ç–æ–≤–∞—Ä–∞
    });
    
    console.log('–ò–¢–û–ì–û –ó–ê–ö–ê–ó:', {
      —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: totalCost,
      –ø—Ä–æ–¥–∞–∂–∞: totalSale,
      –ø—Ä–∏–±—ã–ª—å: totalProfit
    });
    console.log('---');
    
    return {
      ...order,
      totalCost,
      totalSale,
      profit: totalProfit, // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É–º–º—É –ø—Ä–∏–±—ã–ª–µ–π —Ç–æ–≤–∞—Ä–æ–≤
      itemsCount: items.reduce((sum, item) => sum + item.qty, 0)
    };
  });
  
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
  ordersWithProfit.sort((a, b) => {
    switch(sortBy) {
      case 'profit-desc': return b.profit - a.profit;
      case 'date-desc': return b.timestamp - a.timestamp;
      case 'date-asc': return a.timestamp - b.timestamp;
      default: return b.profit - a.profit;
    }
  });
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
  const totalProfit = ordersWithProfit.reduce((sum, o) => sum + o.profit, 0);
  const uniqueClients = new Set(ordersWithProfit.map(o => o.phone || o.name)).size;
  
  document.getElementById('totalOrderProfit').textContent = totalProfit.toFixed(2) + ' —Å–æ–º';
  document.getElementById('totalOrdersCount').textContent = ordersWithProfit.length;
  document.getElementById('totalClientsCount').textContent = uniqueClients;
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤ —Ç–∞–±–ª–∏—Ü–µ
  const tbody = document.getElementById('orderProfitReportBody');
  tbody.innerHTML = '';
  
  // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
  const clientMap = new Map();
  ordersWithProfit.forEach(order => {
    const clientKey = order.phone || order.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
    if (!clientMap.has(clientKey)) {
      clientMap.set(clientKey, {
        name: order.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π',
        phone: order.phone || '',
        orders: [],
        totalProfit: 0,
        totalSale: 0,
        totalCost: 0
      });
    }
    const client = clientMap.get(clientKey);
    client.orders.push(order);
    client.totalProfit += order.profit;
    client.totalSale += order.totalSale;
    client.totalCost += order.totalCost;
  });
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏
  const clients = Array.from(clientMap.values()).sort((a, b) => b.totalProfit - a.totalProfit);
  
  let rowIndex = 0;
  clients.forEach(client => {
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç –Ω–æ–≤–æ–≥–æ –∫ —Å—Ç–∞—Ä–æ–º—É (–ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑ –ø–µ—Ä–≤—ã–º)
    client.orders.sort((a, b) => b.timestamp - a.timestamp);
    
    // –°—Ç—Ä–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–æ—á–Ω–∞—è)
    const clientRow = document.createElement('tr');
    clientRow.style.background = '#f0f8ff';
    clientRow.style.borderBottom = '2px solid #007bff';
    clientRow.style.fontWeight = '600';
    clientRow.innerHTML = `
      <td style="padding:12px; font-size:14px;" colspan="7">
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="cursor:pointer;" onclick="openClientOrdersDetail(${JSON.stringify(client).replace(/"/g, '&quot;')})">‚ñ∂</span>
          üë§ ${client.name} ${client.phone ? '(' + client.phone + ')' : ''} - ${client.orders.length} –∑–∞–∫–∞–∑–æ–≤ - –ü—Ä–∏–±—ã–ª—å: <span style="color:#28a745; font-weight:700;">+${client.totalProfit.toFixed(2)} —Å–æ–º</span>
        </div>
      </td>
    `;
    tbody.appendChild(clientRow);
    
    // –ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞ (—Å–∫—Ä—ã—Ç—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    client.orders.forEach((order, orderIdx) => {
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–∫–∞–∑–∞
      const orderHeaderRow = document.createElement('tr');
      orderHeaderRow.className = 'client-' + rowIndex;
      orderHeaderRow.style.display = 'none';
      orderHeaderRow.style.background = '#e3f2fd';
      orderHeaderRow.style.borderBottom = '2px solid #2196f3';
      
      const date = new Date(order.timestamp);
      const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
      const profitColor = order.profit > 0 ? '#28a745' : order.profit < 0 ? '#dc3545' : '#ffc107';
      
      orderHeaderRow.innerHTML = `
        <td colspan="7" style="padding:10px 12px 10px 50px; font-size:13px; font-weight:600;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>üìÖ –ó–∞–∫–∞–∑ #${orderIdx + 1} –æ—Ç ${dateStr} - ${order.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
            <button onclick="deleteSpecificOrder('${order.id}', '${client.name}')" style="background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑</button>
          </div>
        </td>
      `;
      tbody.appendChild(orderHeaderRow);
      
      // –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ
      const items = order.items || [];
      items.forEach((item, itemIdx) => {
        const productData = productsMap.get(item.id);
        const productName = item.title || (productData ? productData.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä');
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏–∑ –∑–∞–∫–∞–∑–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏–∑ –±–∞–∑—ã —Ç–æ–≤–∞—Ä–æ–≤
        const costPrice = item.costPrice || (productData ? productData.costPrice : 0);
        const itemCost = costPrice * item.qty;
        const itemSale = item.price * item.qty;
        // –ï—Å–ª–∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å = 0 –∏–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –ø—Ä–∏–±—ã–ª—å = 0
        const itemProfit = costPrice > 0 ? (itemSale - itemCost) : 0;
        const itemProfitColor = itemProfit > 0 ? '#28a745' : itemProfit < 0 ? '#dc3545' : '#666';
        
        const itemRow = document.createElement('tr');
        itemRow.className = 'client-' + rowIndex;
        itemRow.style.display = 'none';
        itemRow.style.background = '#fafafa';
        itemRow.style.borderBottom = '1px solid #e0e0e0';
        
        itemRow.innerHTML = `
          <td style="padding:8px 12px 8px 70px; font-size:12px; color:#666;">${itemIdx + 1}</td>
          <td style="padding:8px 12px; font-size:12px;" colspan="2">${productName}</td>
          <td style="padding:8px 12px; font-size:12px; text-align:center;">
            <div style="display:flex; align-items:center; gap:6px; justify-content:center;">
              <input type="number" 
                id="qty_${order.id}_${itemIdx}" 
                value="${item.qty}" 
                min="0" 
                style="width:60px; padding:4px 8px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:12px;"
                onchange="updateOrderItemQty('${order.id}', ${itemIdx}, this.value)">
              <span style="color:#666; font-size:11px;">—à—Ç</span>
            </div>
          </td>
          <td style="padding:8px 12px; font-size:12px; text-align:right;">
            <div style="color:#666;">–ö—É–ø–∏–ª: ${costPrice.toFixed(2)} —Å–æ–º</div>
            <div style="color:#666; font-size:11px;">–í—Å–µ–≥–æ: ${itemCost.toFixed(2)} —Å–æ–º</div>
          </td>
          <td style="padding:8px 12px; font-size:12px; text-align:right;">
            <div style="font-weight:600;">–ü—Ä–æ–¥–∞–ª: ${item.price.toFixed(2)} —Å–æ–º</div>
            <div style="font-size:11px;">–í—Å–µ–≥–æ: ${itemSale.toFixed(2)} —Å–æ–º</div>
          </td>
          <td style="padding:8px 12px; font-size:12px; text-align:right; font-weight:700; color:${itemProfitColor};">
            +${itemProfit.toFixed(2)} —Å–æ–º
          </td>
        `;
        tbody.appendChild(itemRow);
      });
      
      // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –∑–∞–∫–∞–∑–∞
      const orderTotalRow = document.createElement('tr');
      orderTotalRow.className = 'client-' + rowIndex;
      orderTotalRow.style.display = 'none';
      orderTotalRow.style.background = '#fff3cd';
      orderTotalRow.style.borderBottom = '2px solid #ffc107';
      orderTotalRow.style.fontWeight = '700';
      
      orderTotalRow.innerHTML = `
        <td colspan="4" style="padding:10px 12px 10px 70px; font-size:13px; text-align:right;">–ò–¢–û–ì–û –ø–æ –∑–∞–∫–∞–∑—É:</td>
        <td style="padding:10px 12px; font-size:13px; text-align:right; color:#666;">–ó–∞–∫—É–ø–∫–∞: ${order.totalCost.toFixed(2)} —Å–æ–º</td>
        <td style="padding:10px 12px; font-size:13px; text-align:right;">–ü—Ä–æ–¥–∞–∂–∞: ${order.totalSale.toFixed(2)} —Å–æ–º</td>
        <td style="padding:10px 12px; font-size:13px; text-align:right; color:${profitColor};">–ü—Ä–∏–±—ã–ª—å: +${order.profit.toFixed(2)} —Å–æ–º</td>
      `;
      tbody.appendChild(orderTotalRow);
    });
    
    rowIndex++;
  });
  
  if (clients.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="padding:30px; text-align:center; color:#999;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</td></tr>';
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∑–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞
function toggleClientOrders(clientClass) {
  const rows = document.querySelectorAll('.' + clientClass);
  const isHidden = rows[0].style.display === 'none';
  
  rows.forEach(row => {
    row.style.display = isHidden ? 'table-row' : 'none';
  });
  
  // –ï—Å–ª–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–∫–∞–∑—ã, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Ç–æ–≤–∞—Ä—É
  if (isHidden && rows.length > 0) {
    setTimeout(() => {
      const lastRow = rows[rows.length - 1];
      lastRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–∫–∞–∑–∞—Ö –∫–ª–∏–µ–Ω—Ç–∞
function openClientOrdersDetail(clientData) {
  const modal = document.getElementById('clientOrdersDetailModal');
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  document.getElementById('clientDetailName').textContent = `üë§ ${clientData.name}`;
  document.getElementById('clientDetailInfo').textContent = clientData.phone ? `üì± ${clientData.phone}` : '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω';
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤–æ–¥–∫—É
  document.getElementById('clientDetailTotalOrders').textContent = clientData.orders.length;
  document.getElementById('clientDetailTotalSale').textContent = clientData.totalSale.toFixed(2) + ' —Å–æ–º';
  document.getElementById('clientDetailTotalProfit').textContent = '+' + clientData.totalProfit.toFixed(2) + ' —Å–æ–º';
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
  const listDiv = document.getElementById('clientOrdersDetailList');
  listDiv.innerHTML = '';
  
  clientData.orders.forEach((order, orderIdx) => {
    const orderCard = document.createElement('div');
    orderCard.style.cssText = 'background:white; border:1px solid #e0e0e0; border-radius:10px; padding:15px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.05);';
    
    const date = new Date(order.timestamp);
    const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    const profitColor = order.profit > 0 ? '#28a745' : order.profit < 0 ? '#dc3545' : '#ffc107';
    
    let itemsHTML = '';
    const items = order.items || [];
    items.forEach((item, itemIdx) => {
      const itemSale = item.price * item.qty;
      const costPrice = item.costPrice || 0;
      const itemCost = costPrice * item.qty;
      const itemProfit = costPrice > 0 ? (itemSale - itemCost) : 0;
      const itemProfitColor = itemProfit > 0 ? '#28a745' : itemProfit < 0 ? '#dc3545' : '#666';
      
      itemsHTML += `
        <tr style="border-bottom:1px solid #f0f0f0;">
          <td style="padding:8px; font-size:13px;">${itemIdx + 1}</td>
          <td style="padding:8px; font-size:13px; font-weight:600;">${item.title || '–¢–æ–≤–∞—Ä'}</td>
          <td style="padding:8px; font-size:13px; text-align:center;">${item.qty} —à—Ç</td>
          <td style="padding:8px; font-size:13px; text-align:right;">${item.price} —Å–æ–º</td>
          <td style="padding:8px; font-size:13px; text-align:right;">${costPrice} —Å–æ–º</td>
          <td style="padding:8px; font-size:13px; text-align:right;">${itemSale.toFixed(2)} —Å–æ–º</td>
          <td style="padding:8px; font-size:13px; text-align:right;">${itemCost.toFixed(2)} —Å–æ–º</td>
          <td style="padding:8px; font-size:13px; text-align:right; font-weight:700; color:${itemProfitColor};">
            ${itemProfit > 0 ? '+' : ''}${itemProfit.toFixed(2)} —Å–æ–º
          </td>
        </tr>
      `;
    });
    
    orderCard.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:15px;">
        <div>
          <div style="font-size:18px; font-weight:700; color:#333; margin-bottom:5px;">
            üì¶ –ó–∞–∫–∞–∑ #${orderIdx + 1}
          </div>
          <div style="font-size:14px; color:#666;">
            üìÖ ${dateStr}
          </div>
          <div style="font-size:14px; color:#888; margin-top:3px;">
            üìç ${order.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:14px; color:#666; margin-bottom:5px;">–ü—Ä–∏–±—ã–ª—å:</div>
          <div style="font-size:22px; font-weight:700; color:${profitColor};">
            ${order.profit > 0 ? '+' : ''}${order.profit.toFixed(2)} —Å–æ–º
          </div>
        </div>
      </div>
      
      <div style="background:#f8f9fa; border-radius:8px; padding:12px; overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="background:#e9ecef;">
              <th style="padding:8px; text-align:left;">#</th>
              <th style="padding:8px; text-align:left;">–¢–æ–≤–∞—Ä</th>
              <th style="padding:8px; text-align:center;">–ö–æ–ª-–≤–æ</th>
              <th style="padding:8px; text-align:right;">–¶–µ–Ω–∞</th>
              <th style="padding:8px; text-align:right;">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
              <th style="padding:8px; text-align:right;">–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂–∏</th>
              <th style="padding:8px; text-align:right;">–°—É–º–º–∞ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏</th>
              <th style="padding:8px; text-align:right;">–ü—Ä–∏–±—ã–ª—å</th>
            </tr>
          </thead>
          <tbody>
            ${itemsHTML}
          </tbody>
        </table>
      </div>
      
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:12px; border-top:2px solid #e0e0e0;">
        <div style="font-size:16px; font-weight:600; color:#333;">
          üí∞ –ò—Ç–æ–≥–æ: ${order.totalSale.toFixed(2)} —Å–æ–º
        </div>
        <div style="font-size:16px; font-weight:600;">
          –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å: ${order.totalCost.toFixed(2)} —Å–æ–º
        </div>
        <div style="font-size:18px; font-weight:700; color:${profitColor};">
          üìä –ü—Ä–∏–±—ã–ª—å: ${order.profit > 0 ? '+' : ''}${order.profit.toFixed(2)} —Å–æ–º
        </div>
      </div>
    `;
    
    listDiv.appendChild(orderCard);
  });
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
function closeClientOrdersDetailModal() {
  document.getElementById('clientOrdersDetailModal').style.display = 'none';
  document.body.classList.remove('modal-open');
}

// –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞
async function deleteSpecificOrder(orderId, clientName) {
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?',
    html: `–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞ <strong>${clientName}</strong>?<br><br><small style="color:#dc3545;">‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</small>`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'üóëÔ∏è –î–∞, —É–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });

  if (result.isConfirmed) {
    try {
      // –£–¥–∞–ª—è–µ–º –∑–∞–∫–∞–∑ –∏–∑ Firebase
      await db.collection('orders').doc(orderId).delete();
      
      Swal.fire({
        icon: 'success',
        title: '–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω!',
        text: '–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö',
        timer: 2000,
        showConfirmButton: false
      });
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç
      await loadOrderProfitReport();
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
      Swal.fire({
        icon: 'error',
        title: '–û—à–∏–±–∫–∞',
        text: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑: ' + error.message
      });
    }
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑–µ
async function updateOrderItemQty(orderId, itemIndex, newQty) {
  newQty = parseInt(newQty);
  
  if (isNaN(newQty) || newQty < 0) {
    Swal.fire({
      icon: 'error',
      title: '–û—à–∏–±–∫–∞',
      text: '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (0 –∏–ª–∏ –±–æ–ª—å—à–µ)'
    });
    await loadOrderProfitReport(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º –¥–ª—è —Å–±—Ä–æ—Å–∞ –∑–Ω–∞—á–µ–Ω–∏—è
    return;
  }

  try {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑
    const orderDoc = await db.collection('orders').doc(orderId).get();
    
    if (!orderDoc.exists) {
      throw new Error('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    if (itemIndex >= items.length) {
      throw new Error('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞–∫–∞–∑–µ');
    }
    
    // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = 0, —É–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä –∏–∑ –∑–∞–∫–∞–∑–∞
    if (newQty === 0) {
      const result = await Swal.fire({
        title: '–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?',
        html: `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ = 0. –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä <strong>"${items[itemIndex].title || '–¢–æ–≤–∞—Ä'}"</strong> –∏–∑ –∑–∞–∫–∞–∑–∞?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      });
      
      if (result.isConfirmed) {
        items.splice(itemIndex, 1);
        
        // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, —É–¥–∞–ª—è–µ–º –≤–µ—Å—å –∑–∞–∫–∞–∑
        if (items.length === 0) {
          await db.collection('orders').doc(orderId).delete();
          Swal.fire({
            icon: 'info',
            title: '–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω',
            text: '–í—Å–µ —Ç–æ–≤–∞—Ä—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã, –∑–∞–∫–∞–∑ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          await db.collection('orders').doc(orderId).update({ items });
          Swal.fire({
            icon: 'success',
            title: '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω',
            text: '–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –∑–∞–∫–∞–∑–∞',
            timer: 1500,
            showConfirmButton: false
          });
        }
        
        await loadOrderProfitReport();
      } else {
        await loadOrderProfitReport(); // –°–±—Ä–æ—Å–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ
      }
      return;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
    items[itemIndex].qty = newQty;
    
    await db.collection('orders').doc(orderId).update({ items });
    
    Swal.fire({
      icon: 'success',
      title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!',
      html: `–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: <strong>${newQty} —à—Ç</strong>`,
      timer: 1500,
      showConfirmButton: false
    });
    
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É–º–º
    await loadOrderProfitReport();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞:', error);
    Swal.fire({
      icon: 'error',
      title: '–û—à–∏–±–∫–∞',
      text: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ' + error.message
    });
    await loadOrderProfitReport(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º –¥–ª—è —Å–±—Ä–æ—Å–∞ –∑–Ω–∞—á–µ–Ω–∏—è
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ Excel
async function exportOrderProfitToExcel() {
  const dateFilter = document.getElementById('orderDateFilter').value;
  
  try {
    const ordersSnapshot = await db.collection('orders').get();
    const orders = [];
    
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      orders.push({
        id: doc.id,
        ...data,
        timestamp: data.timestamp || Date.now()
      });
    });
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    const now = Date.now();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayStart = today.getTime();
    const yesterdayStart = todayStart - 86400000;
    const weekStart = todayStart - 7 * 86400000;
    const monthStart = todayStart - 30 * 86400000;
    
    let filtered = orders.filter(order => {
      const orderTime = order.timestamp;
      switch(dateFilter) {
        case 'today': return orderTime >= todayStart;
        case 'yesterday': return orderTime >= yesterdayStart && orderTime < todayStart;
        case 'week': return orderTime >= weekStart;
        case 'month': return orderTime >= monthStart;
        case 'all': return true;
        default: return true;
      }
    });
    
    const wb = XLSX.utils.book_new();
    const wsData = [
      ['‚Ññ', '–î–∞—Ç–∞', '–ö–ª–∏–µ–Ω—Ç', '–¢–µ–ª–µ—Ñ–æ–Ω', '–¢–æ–≤–∞—Ä–æ–≤', '–ó–∞–∫—É–ø–∫–∞', '–°—É–º–º–∞', '–ü—Ä–∏–±—ã–ª—å']
    ];
    
    filtered.forEach((order, index) => {
      let totalCost = 0;
      let totalSale = 0;
      const items = order.items || [];
      
      items.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (product && product.costPrice) {
          totalCost += product.costPrice * item.qty;
          totalSale += item.price * item.qty;
        } else {
          totalSale += item.price * item.qty;
        }
      });
      
      const profit = totalSale - totalCost;
      const date = new Date(order.timestamp);
      const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
      const itemsCount = items.reduce((sum, item) => sum + item.qty, 0);
      
      wsData.push([
        index + 1,
        dateStr,
        order.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π',
        order.phone || '-',
        itemsCount,
        totalCost.toFixed(2),
        totalSale.toFixed(2),
        profit.toFixed(2)
      ]);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–∏–±—ã–ª—å –ø–æ –∑–∞–∫–∞–∑–∞–º');
    XLSX.writeFile(wb, `–ü—Ä–∏–±—ã–ª—å_–ø–æ_–∑–∞–∫–∞–∑–∞–º_${new Date().toLocaleDateString()}.xlsx`);
    
    Swal.fire('–ì–æ—Ç–æ–≤–æ!', '–û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ Excel', 'success');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç', 'error');
  }
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
async function deleteSelectedOrders() {
  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
  const result = await Swal.fire({
    title: '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!',
    html: '–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥?<br><br><strong style="color:#dc3545;">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</strong>',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞',
    confirmButtonColor: '#dc3545'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const dateFilter = document.getElementById('orderDateFilter').value;
    const ordersSnapshot = await db.collection('orders').get();
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–∫–∞–∑—ã –ø–æ –¥–∞—Ç–µ
    const now = Date.now();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayStart = today.getTime();
    const yesterdayStart = todayStart - 86400000;
    const weekStart = todayStart - 7 * 86400000;
    const monthStart = todayStart - 30 * 86400000;
    
    let deleteCount = 0;
    const batch = db.batch();
    
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      const orderTime = data.timestamp || Date.now();
      let shouldDelete = false;
      
      switch(dateFilter) {
        case 'today': shouldDelete = orderTime >= todayStart; break;
        case 'yesterday': shouldDelete = orderTime >= yesterdayStart && orderTime < todayStart; break;
        case 'week': shouldDelete = orderTime >= weekStart; break;
        case 'month': shouldDelete = orderTime >= monthStart; break;
        case 'all': shouldDelete = true; break;
      }
      
      if (shouldDelete) {
        batch.delete(doc.ref);
        deleteCount++;
      }
    });
    
    await batch.commit();
    
    Swal.fire('–£—Å–ø–µ—Ö!', `–£–¥–∞–ª–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${deleteCount}`, 'success');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç—á–µ—Ç
    loadOrderProfitReport();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑—ã: ' + error.message, 'error');
  }
}

// ==================== –ö–û–ù–ï–¶ –û–¢–ß–ï–¢–ê –ü–û –ü–†–ò–ë–´–õ–ò ====================

// ==================== –ê–î–ú–ò–ù-–§–£–ù–ö–¶–ò–ò –î–õ–Ø –ß–ê–¢–ê ====================

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∞–¥–º–∏–Ω–æ–º
let selectedClientId = null;
let selectedClientName = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
async function loadAdminChat() {
  if (typeof db === 'undefined') {
    document.getElementById('adminChatMessages').innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>';
    return;
  }
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
    const clientsSnapshot = await db.collection('chatClients')
      .get();
    
    const messagesDiv = document.getElementById('adminChatMessages');
    messagesDiv.innerHTML = `
      <div style="display:flex; height:100%; background:#f8f9fa;">
        <div id="clientsList" style="width:250px; border-right:2px solid #e0e0e0; overflow-y:auto; padding:12px; background:white;">
          <div style="font-weight:bold; margin-bottom:12px; color:#333; font-size:16px; padding:8px; background:#f8f9fa; border-radius:8px;">
            üìã –ö–ª–∏–µ–Ω—Ç—ã (${clientsSnapshot.size})
          </div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column;">
          <div id="chatHeader" style="padding:16px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; font-weight:bold; display:none;">
            <div style="font-size:18px;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</div>
          </div>
          <div id="chatMessagesArea" style="flex:1; display:flex; flex-direction:column; padding:16px; overflow-y:auto; background:#f5f5f5;">
            <div style="text-align:center; color:#999; padding:40px; font-size:16px;">
              üëà –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞
            </div>
          </div>
        </div>
      </div>
    `;
    
    const clientsList = document.getElementById('clientsList');
    
    if (clientsSnapshot.empty) {
      clientsList.innerHTML += '<div style="color:#999; font-size:13px; text-align:center; margin-top:40px; padding:20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>';
      return;
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ lastActive
    const clients = [];
    clientsSnapshot.forEach((doc) => {
      clients.push({
        id: doc.id,
        data: doc.data()
      });
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ lastActive (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
    clients.sort((a, b) => {
      const timeA = a.data.lastActive ? a.data.lastActive.toDate().getTime() : 0;
      const timeB = b.data.lastActive ? b.data.lastActive.toDate().getTime() : 0;
      return timeB - timeA;
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Å–ø–∏—Å–æ–∫
    clients.forEach(({id, data: client}) => {
      const clientDiv = document.createElement('div');
      clientDiv.style.cssText = `
        padding:12px; margin-bottom:10px; background:${client.hasUnread ? '#fff9c4' : '#f8f9fa'}; 
        border-radius:10px; cursor:pointer; transition:all 0.2s; border:2px solid transparent;
      `;
      clientDiv.innerHTML = `
        <div style="font-weight:bold; color:#333; margin-bottom:4px; font-size:15px;">${client.name}</div>
        <div style="font-size:11px; color:#666;">
          ${client.lastActive ? new Date(client.lastActive.toDate()).toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          }) : '–î–∞–≤–Ω–æ'}
        </div>
        ${client.hasUnread ? '<div style="font-size:10px; color:#f57c00; font-weight:bold; margin-top:6px;">üîî –ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï</div>' : ''}
      `;
      
      clientDiv.onmouseover = () => clientDiv.style.borderColor = '#667eea';
      clientDiv.onmouseout = () => {
        if (selectedClientId !== id) clientDiv.style.borderColor = 'transparent';
      };
      
      clientDiv.onclick = () => loadClientMessages(id, client.name, clientDiv);
      clientsList.appendChild(clientDiv);
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:', error);
    document.getElementById('adminChatMessages').innerHTML = '<div style="text-align:center; color:#dc3545; padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>';
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
async function loadClientMessages(clientId, clientName, clientDiv) {
  selectedClientId = clientId;
  selectedClientName = clientName;
  
  console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞:', clientName, clientId);
  
  // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
  document.querySelectorAll('#clientsList > div').forEach(div => {
    if (div.style && div !== clientDiv) {
      div.style.borderColor = 'transparent';
      div.style.background = '#f8f9fa';
    }
  });
  if (clientDiv) {
    clientDiv.style.borderColor = '#667eea';
    clientDiv.style.background = '#e3f2fd';
  }
  
  // –£–±–∏—Ä–∞–µ–º –º–µ—Ç–∫—É "–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
  try {
    await db.collection('chatClients').doc(clientId).update({ hasUnread: false });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const chatHeader = document.getElementById('chatHeader');
  chatHeader.style.display = 'block';
  chatHeader.innerHTML = `
    <div style="font-size:18px;">üí¨ –ß–∞—Ç —Å ${clientName}</div>
    <div style="font-size:12px; opacity:0.9; margin-top:4px;">ID: ${clientId}</div>
  `;
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    const querySnapshot = await db.collection('chatMessages')
      .where('clientId', '==', clientId)
      .get();
    
    const chatArea = document.getElementById('chatMessagesArea');
    chatArea.innerHTML = '';
    
    if (querySnapshot.empty) {
      chatArea.innerHTML = `<div style="text-align:center; color:#999; padding:40px; font-size:15px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π —Å ${clientName}</div>`;
      return;
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—Ä—É—á–Ω—É—é
    const messages = [];
    querySnapshot.forEach((doc) => {
      const msg = doc.data();
      messages.push({
        text: msg.text,
        sender: msg.sender,
        timestamp: msg.timestamp.toDate()
      });
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ timestamp
    messages.sort((a, b) => a.timestamp - b.timestamp);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ UI
    messages.forEach(msg => {
      addAdminChatMessageToUI(msg.text, msg.sender, msg.timestamp);
    });
    
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º placeholder –ø–æ–ª—è –≤–≤–æ–¥–∞
    const inputField = document.getElementById('adminChatInput');
    if (inputField) {
      inputField.placeholder = `–û—Ç–≤–µ—Ç–∏—Ç—å ${clientName}...`;
    }
    
    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    subscribeToAdminChatMessages(clientId);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞:', error);
    document.getElementById('chatMessagesArea').innerHTML = '<div style="text-align:center; color:#dc3545; padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
  }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
function addAdminChatMessageToUI(text, sender, timestamp) {
  const chatArea = document.getElementById('chatMessagesArea');
  if (!chatArea) return;
  
  const timeStr = timestamp.getHours().toString().padStart(2, '0') + ':' + timestamp.getMinutes().toString().padStart(2, '0');
  const dateStr = timestamp.toLocaleDateString('ru-RU');
  
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = 'margin-bottom:12px; display:flex;';
  
  const msgContent = document.createElement('div');
  
  if (sender === 'client') {
    msgContent.style.cssText = 'background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:70%; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    msgContent.innerHTML = `
      <div style="font-size:12px; color:#667eea; font-weight:bold; margin-bottom:4px;">üë§ ${selectedClientName || '–ö–ª–∏–µ–Ω—Ç'}</div>
      <div style="font-size:14px; color:#333;">${escapeHtml(text)}</div>
      <div style="font-size:11px; color:#999; margin-top:4px;">${dateStr} ${timeStr}</div>
    `;
  } else {
    messageDiv.style.justifyContent = 'flex-end';
    msgContent.style.cssText = 'background:#667eea; color:white; padding:12px; border-radius:12px 12px 4px 12px; max-width:70%; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    msgContent.innerHTML = `
      <div style="font-size:12px; font-weight:bold; margin-bottom:4px; opacity:0.9;">‚úÖ –í—ã</div>
      <div style="font-size:14px;">${escapeHtml(text)}</div>
      <div style="font-size:11px; opacity:0.9; margin-top:4px; text-align:right;">${dateStr} ${timeStr}</div>
    `;
  }
  
  messageDiv.appendChild(msgContent);
  chatArea.appendChild(messageDiv);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∞
async function sendAdminMessage() {
  if (!selectedClientId) {
    Swal.fire('–û—à–∏–±–∫–∞', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞', 'warning');
    return;
  }
  
  const input = document.getElementById('adminChatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  const now = new Date();
  
  try {
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ UI
    addAdminChatMessageToUI(message, 'admin', now);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase —Å clientId –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    await db.collection('chatMessages').add({
      text: message,
      sender: 'admin',
      clientId: selectedClientId,
      clientName: selectedClientName,
      timestamp: firebase.firestore.Timestamp.fromDate(now),
      read: false
    });
    
    console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É:', selectedClientName);
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    input.value = '';
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
    const chatArea = document.getElementById('chatMessagesArea');
    chatArea.scrollTop = chatArea.scrollHeight;
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
  }
}

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
function subscribeToAdminChatMessages(clientId) {
  if (typeof db === 'undefined') return;
  
  db.collection('chatMessages')
    .where('clientId', '==', clientId)
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const msg = change.doc.data();
          // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ —ç—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
          if (msg.sender === 'client' && msg.clientId === selectedClientId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const chatArea = document.getElementById('chatMessagesArea');
            const existingMessages = chatArea.querySelectorAll('div');
            let isDuplicate = false;
            existingMessages.forEach(div => {
              if (div.textContent && div.textContent.includes(msg.text)) {
                isDuplicate = true;
              }
            });
            
            if (!isDuplicate) {
              addAdminChatMessageToUI(msg.text, msg.sender, msg.timestamp.toDate());
              chatArea.scrollTop = chatArea.scrollHeight;
              
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ (–¥–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ)
              loadAdminChat();
            }
          }
        }
      });
    });
}

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞
async function clearAllChatMessages() {
  const result = await Swal.fire({
    title: '–í—ã —É–≤–µ—Ä–µ–Ω—ã?',
    text: '–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞',
    confirmButtonColor: '#dc3545'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const querySnapshot = await db.collection('chatMessages').get();
    
    const deletePromises = [];
    querySnapshot.forEach((doc) => {
      deletePromises.push(doc.ref.delete());
    });
    
    await Promise.all(deletePromises);
    
    document.getElementById('adminChatMessages').innerHTML = '<div style="text-align:center; color:#999; padding:20px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
    document.getElementById('chatMessages').innerHTML = `
      <div style="background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <div style="font-size:14px; color:#333;">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
        <div style="font-size:11px; color:#999; margin-top:4px;">–ü—Ä–æ–¥–∞–≤–µ—Ü ‚Ä¢ —Ç–æ–ª—å–∫–æ —á—Ç–æ</div>
      </div>
    `;
    
    Swal.fire('–£—Å–ø–µ—Ö!', '–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã', 'success');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω-—á–∞—Ç–∞
function refreshAdminChat() {
  loadAdminChat();
  Swal.fire({
    icon: 'success',
    title: '–û–±–Ω–æ–≤–ª–µ–Ω–æ',
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 1500
  });
}

// ==================== –ö–û–ù–ï–¶ –ê–î–ú–ò–ù-–§–£–ù–ö–¶–ò–ô –ß–ê–¢–ê ====================

// ==================== –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –ß–ê–¢–ê ====================

// –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑
document.getElementById('scrollTopBtn').onclick = function() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
};
document.getElementById('scrollBottomBtn').onclick = function() {
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
};
</script>

</body>
</html>
