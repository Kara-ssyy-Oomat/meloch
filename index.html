<!DOCTYPE html>

<html lang="ru">

<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="–•–æ–∑—Ç–æ–≤–∞—Ä—ã –∏ –º–µ–ª–æ—á–∏ –æ–ø—Ç–æ–º –≤ –ö–∞—Ä–∞-–°—É—É. –î–æ—Å—Ç–∞–≤–∫–∞, –Ω–∏–∑–∫–∏–µ —Ü–µ–Ω—ã.">
  <meta name="google-site-verification" content="KwaNctZFk2BMTScsvlO77JIV6KN4daZPJXP9XRcin9Q" />
  <style>
    /* –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫: –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è, —á—Ç–æ–±—ã –ø–æ–º–µ—â–∞–ª–æ—Å—å –±–æ–ª—å—à–µ —Ç–æ–≤–∞—Ä–æ–≤ */
    .product-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:8px; padding:6px; }
  .product-card { background:#fff; border-radius:6px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 1px 6px rgba(0,0,0,0.06); transition:transform .14s, box-shadow .14s; }
  .product-card:hover { transform: translateY(-6px); box-shadow:0 8px 24px rgba(0,0,0,0.12); }
  /* –ë–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ñ–æ—Ç–æ: —á—É—Ç—å –º–µ–Ω—å—à–µ –ø–æ –≤—ã—Å–æ—Ç–µ, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
  .product-card .card-image { width:100%; aspect-ratio:4/3; max-height:140px; overflow:hidden; background:#f8f8f8; display:flex; align-items:center; justify-content:center; padding:6px; }
  .product-card .card-image img { width:100%; height:100%; object-fit:contain; display:block; }
  .product-card .card-body { padding:6px; display:flex; flex-direction:column; gap:6px; }
  .card-title { font-size:13px; color:#222; min-height:36px; }
  .card-price { font-size:16px; color:#e53935; font-weight:700; }
  .card-oldprice { font-size:13px; color:#888; text-decoration:line-through; margin-left:8px; }
  /* ratings removed */
  .card-badges { display:flex; gap:6px; flex-wrap:wrap; }
  .card-badge { background:#ffefdb; color:#b05b00; padding:4px 6px; border-radius:4px; font-size:12px; }
  .card-actions { display:flex; gap:8px; align-items:center; }
  .card-actions button { background:linear-gradient(90deg,#ff7a00,#ff3b00); color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
  @media (max-width:700px){
  /* –ù–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö ‚Äî –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ –∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ñ–æ—Ç–æ */
  .product-grid{grid-template-columns: repeat(2,1fr); gap:6px;}
  .product-card .card-image{max-height:90px; aspect-ratio:1/1;}
  .product-card .card-image { width:100%; aspect-ratio:4/3; max-height:110px; overflow:hidden; background:#f8f8f8; display:flex; align-items:center; justify-content:center; padding:6px; }
  .product-card .card-image{max-height:90px; aspect-ratio:1/1;}
    .card-actions .card-qty-input { padding:8px !important; font-size:14px !important; width:70px !important; align-self:center !important; }
    .card-actions .card-qty-input::-webkit-outer-spin-button, .card-actions .card-qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .admin-product-btn { font-size:1.12rem; padding:12px 10px; border-radius:12px; width:auto; }
  }


  @media (max-width:420px){
    /* –û—á–µ–Ω—å —É–∑–∫–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã: –¥–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∏ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ */
    .product-grid{grid-template-columns: repeat(2,1fr); gap:6px;}
    .card-actions { flex-direction: row; gap:8px; align-items:center; justify-content:space-between; }
    .card-actions .card-qty-input { padding:10px !important; font-size:16px !important; width:60px !important; }
    .card-actions button { padding:12px 14px !important; font-size:16px !important; border-radius:10px !important; width:auto !important; display:inline-block !important; }
    .admin-product-btn { width:100% !important; }
  }

  </style>

  <!-- Firebase SDKs: app first, then compat modules -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- jsPDF –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- ExcelJS –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

  <style>
@media (max-width: 600px) {
  .admin-product-input {
    font-size: 1.1rem;
    padding: 12px 10px;
    width: 100% !important;
    min-width: 0;
    margin: 6px 0;
    border-radius: 12px;
  }
  .admin-product-btn {
    font-size: 1.1rem;
    padding: 14px 0;
    width: 100%;
    margin: 6px 0;
    border-radius: 12px;
    min-width: 0;
    display: block;
  }
  .admin-product-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
    border-radius: 14px;
    box-shadow: 0 2px 12px #007bff22;
    padding: 8px 0;
  }
  td, th {
    font-size: 1rem;
    padding: 8px 4px;
  }
}
/* --- –ö—Ä–∞—Å–∏–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞ --- */
.admin-product-input {
  border: 2px solid #90bfff;
  border-radius: 8px;
  background: #fafdff;
  padding: 7px 10px;
  font-size: 1rem;
  margin: 2px 0;
  transition: border 0.2s, box-shadow 0.2s;
  box-shadow: 0 1px 6px #007bff11;
}
.admin-product-input:focus {
  border: 2px solid #007bff;
  box-shadow: 0 2px 12px #007bff33;
  background: #eaf4ff;
}
.admin-product-btn {
  background: linear-gradient(90deg,#007bff 60%,#00c6ff 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 18px;
  font-size: 1rem;
  margin: 2px 2px;
  cursor: pointer;
  box-shadow: 0 2px 8px #007bff22;
  transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
}
.admin-product-btn:hover {
  background: linear-gradient(90deg,#0056b3 60%,#00aaff 100%);
  box-shadow: 0 4px 16px #007bff33;
  transform: scale(1.04);
}
.admin-product-row {
  background: #f0f7ff;
  border-radius: 10px;
  box-shadow: 0 2px 8px #007bff11;
}
.order-form #cartList {
  background: #fafdff;
  border: 2px solid #90bfff;
  border-radius: 12px;
  box-shadow: 0 2px 8px #007bff11;
  padding: 8px 0 8px 0;
  position: relative;
}
.cart-scroll-hint {
  text-align: center;
  color: #007bff;
  font-size: 13px;
  margin-bottom: 4px;
  font-style: italic;
  letter-spacing: 0.5px;
}
/* –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã */
.cart-item-removing {
  opacity: 0;
  max-height: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
  transition: opacity 0.3s, max-height 0.3s, margin 0.3s, padding 0.3s;
  overflow: hidden;
}
.order-form #cartList {
  max-height: 220px;
  overflow-y: auto;
  margin-bottom: 10px;
}
@media (max-width: 600px) {
  .order-form #cartList {
    max-height: 320px;
  }
}
.cart-item .delete-item {
  background: #dc3545 !important;
  color: #fff !important;
  border: none;
  font-size: 20px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin-left: 8px;
  transition: background 0.2s;
}
.cart-item .delete-item:hover {
  background: #b71c1c !important;
}
@media (max-width: 600px) {
  .cart-item .delete-item {
    display: block;
    width: 100% !important;
    height: 44px !important;
    font-size: 2rem;
    margin: 8px 0 0 0;
    border-radius: 12px;
  }
}


.search-sort-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  width: 100%;
  max-width: 600px;
  }

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
.category-tabs {
  display: flex;
  gap: 10px;
  margin: 10px auto 15px;
  max-width: 1200px;
  padding: 0 8px;
  flex-wrap: wrap;
  justify-content: center;
}
.category-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.category-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}
.category-btn.active {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  box-shadow: 0 6px 12px rgba(245,87,108,0.4);
}
@media (max-width: 600px) {
  .category-tabs {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    column-gap: 6px;
    row-gap: 0px;
    padding: 0 8px;
    margin: 8px auto 12px;
  }
  .category-btn {
    padding: 10px 8px;
    font-size: 14px;
    width: 100%;
    min-width: 0;
    margin: 0;
  }
}
/* --- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–∞–∫ –Ω–∞ https://kara-ssyy-oomat.github.io/meloch/ --- */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Arial', sans-serif;
  background: #FFF9E5;
  color: #333;
}
h1, h2 {
  text-align: center;
  margin-bottom: 20px;
  animation: fadeIn 1s ease forwards;
  color: #fff;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 8px;
}
.search-sort-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  width: 100%;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}
.search-sort-row input,
.search-sort-row select,
.search-sort-row .other-site-btn {
  flex: 1 1 0;
  width: 100%;
  max-width: none;
  box-sizing: border-box;
  margin: 10px auto;
}
.other-site-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #007bff;
  color: #fff !important;
  text-align: center;
  padding: 10px 0;
  border-radius: 5px;
  text-decoration: none;
  transition: background 0.2s;
  font-weight: bold;
  height: 100%;
}
.other-site-btn:hover {
  background: #0056b3;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  background: white;
  box-shadow: 0 0 10px #ccc;
  overflow-x: auto;
  display: block;
  border-radius: 12px;
}
thead th {
  position: sticky;
  top: 0;
  background: #00fff7;
  z-index: 2;
}
th, td {
  padding: 10px;
  border: 1px solid #ddd;
  text-align: center;
  font-size: 15px;
}
th:nth-child(5), td:nth-child(5) {
  min-width: 90px;
  width: 80px;
}
.product-img {
  max-width: 60px;
  height: auto;
  transition: transform 0.2s, box-shadow 0.2s;
  border-radius: 8px;
}
.product-img:hover {
  transform: scale(1.08);
  box-shadow: 0 4px 16px #0002;
}
.cart-item {
  display: flex;
  align-items: center;
  gap: 0;
  margin-bottom: 8px;
  padding: 4px 0;
  border-bottom: 1px solid #f0f0f0;
}
.cart-item-compact {
  gap: 0;
  padding: 2px 0;
  min-height: 40px;
  align-items: center;
}
.cart-mini-img {
  width: 24px;
  height: 24px;
  object-fit: cover;
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #f8f8f8;
  box-shadow: 0 1px 4px #0001;
  display: block;
}
.cart-title {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.cart-qty, .cart-price, .cart-sum {
  margin: 0 8px;
  white-space: nowrap;
}
.cart-sum {
  font-weight: bold;
}
.cart-item-compact {
  gap: 0;
  padding: 2px 0;
  min-height: 36px;
}
.cart-mini-img {
  width: 32px;
  height: 32px;
  object-fit: cover;
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #f8f8f8;
  box-shadow: 0 1px 4px #0001;
}
.cart-title {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.cart-qty, .cart-price, .cart-sum {
  margin: 0 8px;
  white-space: nowrap;
}
.cart-sum {
  font-weight: bold;
}
.order-form, #orderHistory {
  background: #cce4ff;
  padding: 22px 18px 22px 18px;
  border-radius: 16px;
  box-shadow: 0 4px 24px #007bff22, 0 1.5px 0 #007bff inset;
  margin-top: 20px;
}
input, select, button, textarea {
  font-size: 1rem;
  padding: 10px;
  margin: 10px auto;
  width: 100%;
  max-width: 400px;
  display: block;
  border-radius: 5px;
  border: 1px solid #ccc;
}
button, .other-site-btn {
  border-radius: 8px;
  box-shadow: 0 2px 8px #0001;
  transition: background 0.2s, color 0.2s;
}
button:active {
  transform: scale(0.97);
}
button {

  background: #28a745;
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

  button:hover { background: #218838; }
.delete-order {
  background: #dc3545;
  color: white;
  border: none;
  padding: 8px 12px;
  margin-bottom: 6px;
  margin-top: 10px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.3s ease;
}
  /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –≤—Å—ë –Ω–∏–∂–µ –æ–±—ë—Ä–Ω—É—Ç–æ –≤ .cart-mini-img */

.cart-mini-img {
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #fff;
  box-shadow: 0 1px 4px #007bff33;
  display: block;
  border: 2px solid #007bff;
}

button.delete-item:hover {
  color: #c82333;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes addToCart {
  0% { transform: scale(1); background-color: #28a745; }
  50% { transform: scale(1.2); background-color: #218838; }
  100% { transform: scale(1); background-color: #28a745; }
}
.animate-add {
  animation: addToCart 0.5s ease;
}
@media (max-width: 600px) {
  body {
    font-size: 1.05rem;
    padding-bottom: 60px;
  }
  .container {
    max-width: 100vw;
    padding: 0 2vw;
  }
  .order-form, #orderHistory {
    padding: 10px 2vw;
    margin-top: 10px;
    box-shadow: 0 2px 8px #0001;
    border-radius: 10px;
  }
  .order-form input, .order-form button {
    width: 100%;
    min-height: 44px;
    font-size: 1rem;
    margin-bottom: 10px;
  }
  .search-sort-row {
    flex-direction: column;
    gap: 0;
    max-width: 100vw;
    padding: 0 2vw;
  }
  .other-site-btn {
    font-size: 1rem;
    padding: 12px 0;
    margin-top: 8px;
    border-radius: 8px;
  }
  table {
    display: block;
    width: 100vw;
    overflow-x: auto;
    border-radius: 10px;
    box-shadow: 0 2px 8px #0001;
  }
  thead, tbody, tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    font-size: 13px;
    padding: 7px 4px;
    min-width: 70px;
    word-break: break-word;
  }
  th:nth-child(2), td:nth-child(2) {
    min-width: 60px;
    max-width: 70px;
  }
  .product-img {
    max-width: 70px;
    min-width: 44px;
    width: 100%;
    height: auto;
    display: block;
    margin: 0 auto 6px auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px #007bff22;
    background: #fff;
    object-fit: contain;
  }
  .cart-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    font-size: 0.98rem;
  }
  .cart-summary {
    font-size: 1.1rem;
    margin: 8px 0;
  }
  #cartList div {
    font-size: 0.98rem;
    padding: 4px 0;
  }
  button, .order-form button, .other-site-btn {
    min-height: 44px;
    font-size: 1rem;
    padding: 10px 0;
  }
  .scroll-buttons {
    right: 10px;
    bottom: 10px;
    gap: 6px;
  }
  .scroll-buttons button {
    font-size: 18px;
    padding: 10px 14px;
    border-radius: 12px;
  }
  #previewInner {
    width: 96vw !important;
    left: 2vw !important;
    transform: none !important;
    padding: 6vw 2vw !important;
  }
  #previewImg {
    max-width: 92vw !important;
    max-height: 60vh !important;
  }
  #toggleHistory, #logoutUser {
    width: 100%;
    min-height: 44px;
    font-size: 1rem;
    margin: 8px 0;
  }
  #orderHistory h2 {
    font-size: 1.1rem;
    margin-bottom: 10px;
  }
  #historyList li {
  font-size: 0.98rem;
  margin-bottom: 10px;
  padding: 8px 4px;
  border-radius: 8px;
  box-shadow: 0 1px 4px #0001;
}
}

@keyframes addToCart {
  0% { transform: scale(1); background-color: #28a745; }
  50% { transform: scale(1.2); background-color: #218838; }
  100% { transform: scale(1); background-color: #28a745; }
}

    .animate-add {

      animation: addToCart 0.5s ease;

    }



    @media (max-width: 600px) {

      th, td { font-size: 12px; padding: 6px; }

      input, select, button, textarea { font-size: 0.9rem; padding: 8px; }

      .cart-summary { font-size: 1.2rem; }

      #cartList div { font-size: 0.9rem; }

      .order-form input, .order-form button { width: 90%; }

    }
    @media (max-width: 600px) {
  button.delete-item {
    width: 20px; /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É */
    height: 20px; /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É */
    font-size: 12px; /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ */
    padding: 0; /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
  }
}

    @media (max-width: 600px) {
  th, td { font-size: 12px; padding: 6px; }
  input, select, button, textarea { font-size: 0.9rem; padding: 8px; }
  .cart-summary { font-size: 1.2rem; }
  #cartList div { font-size: 0.9rem; }
  .order-form input, .order-form button { width: 90%; }
  button.delete-item {
    width: 20px;
    height: 20px;
    font-size: 12px;
    padding: 0;
  }
}

  </style>
      



  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
// –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
async function updateProductTitle(productId, newTitle) {
  try {
    await db.collection('products').doc(productId).update({ title: newTitle });
    Swal.fire('–£—Å–ø–µ—Ö!', '–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
    loadProducts();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞
async function updateProductCategory(productId, newCategory) {
  try {
    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', productId, '–Ω–∞', newCategory);
    await db.collection('products').doc(productId).update({ category: newCategory });
    console.log('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
    await loadProducts(); // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
    console.log('–¢–æ–≤–∞—Ä—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã');
    Swal.fire('–£—Å–ø–µ—Ö!', `–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ "${newCategory}"`, 'success');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é', 'error');
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞
async function updateProductPrice(productId, newPrice) {
  try {
    const price = parseFloat(newPrice);
    if (isNaN(price) || price < 0) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É', 'error');
      return;
    }
    await db.collection('products').doc(productId).update({ price: price });
    await loadProducts();
    Swal.fire('–£—Å–ø–µ—Ö!', '–¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É', 'error');
  }
}

// –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Ç–æ–≤–∞—Ä–∞
async function changeProductImage(productId) {
  console.log('changeProductImage –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞:', productId);
  
  // –°–æ–∑–¥–∞–µ–º input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª:', file.name);
    
    try {
      Swal.fire({
        title: '–ó–∞–≥—Ä—É–∑–∫–∞...',
        text: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ Firebase Storage
      const storageRef = storage.ref();
      const fileName = `products/${Date.now()}_${file.name}`;
      const fileRef = storageRef.child(fileName);
      
      console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –≤ Storage:', fileName);
      await fileRef.put(file);
      const downloadURL = await fileRef.getDownloadURL();
      console.log('URL –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:', downloadURL);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º URL —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
      await db.collection('products').doc(productId).update({ image: downloadURL });
      console.log('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
      
      await loadProducts();
      Swal.fire('–£—Å–ø–µ—Ö!', '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:', error);
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ: ' + error.message, 'error');
    }
  };
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
  input.click();
}

// –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä
async function toggleProductBlock(productId, currentStatus) {
  try {
    await db.collection('products').doc(productId).update({ blocked: !currentStatus });
    Swal.fire('–£—Å–ø–µ—Ö!', !currentStatus ? '–¢–æ–≤–∞—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–¢–æ–≤–∞—Ä —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
    loadProducts();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏', 'error');
  }
}

</script>

</head>

<body>
  <!-- –ö–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã -->
  <button id="cartFloatBtn" style="position:fixed;left:20px;bottom:20px;z-index:9999;background:#007bff;color:#fff;border:none;border-radius:50%;width:56px;height:56px;box-shadow:0 2px 12px #007bff44;display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;transition:background 0.2s;">
    <span id="cartFloatCount" style="position:absolute;top:6px;right:8px;background:#dc3545;color:#fff;border-radius:50%;padding:2px 7px;font-size:14px;font-weight:bold;min-width:22px;text-align:center;">0</span>
    üõí
  </button>

  <!-- –ë–ª–æ–∫ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ -->
  <div id="previewBlock" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:1000; pointer-events:auto; background: rgba(0,0,0,0.6);">
    <div id="previewInner" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:12px; border-radius:10px; box-shadow:0 0 20px #0008; max-width:95vw; width:calc(100vw - 40px);">
      <button id="prevPreview" style="position:absolute; left:6px; top:50%; transform:translateY(-50%); background:transparent; border:none; font-size:32px; cursor:pointer;">‚óÄ</button>
      <button id="nextPreview" style="position:absolute; right:6px; top:50%; transform:translateY(-50%); background:transparent; border:none; font-size:32px; cursor:pointer;">‚ñ∂</button>
      <span id="closePreview" style="cursor:pointer; float:right; font-size:24px; background:#eee; padding:6px; border-radius:6px;">&times;</span>
      <div style="text-align:center;">
        <img id="previewImg" src="" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä" style="max-width:90vw; max-height:70vh; display:block; margin:auto; touch-action:pan-y;">
        <div id="previewCaption" style="margin-top:8px; font-size:14px; color:#333;"></div>
      </div>
    </div>
  </div>
<!-- filepath: c:\Users\hp\Desktop\–Ω–æ–∂\index.html -->

  <h1>–ú–µ–ª–æ—á—å - –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>

  <div id="contacts" style="text-align:center; margin:8px 0 12px;">
    <div style="font-weight:800; color:#003366; font-size:1.05rem; margin-bottom:6px;">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –Ω–æ–º–µ—Ä–∞: </div>
    <div style="display:flex;gap:8px;justify-content:center;">
      <a href="tel:+996555332133" style="display:inline-block; padding:6px 10px; background:rgba(0,123,255,0.12); color:#003366; border-radius:8px; text-decoration:none; font-weight:700;">0555 33 21 33</a>
      <a href="tel:+996559009860" style="display:inline-block; padding:6px 10px; background:rgba(0,123,255,0.12); color:#003366; border-radius:8px; text-decoration:none; font-weight:700;">0559 00 98 60</a>
    </div>
  </div>

  <!-- –í–µ—Ä—Ö–Ω–∏–π –ø—Ä–æ–º–æ-—Å–ª–∞–π–¥–µ—Ä: –¥–≤–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (swipe) -->
  <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ -->
  <div class="category-tabs">
    <button class="category-btn active" onclick="filterByCategory('–≤—Å–µ')">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
    <button class="category-btn" onclick="filterByCategory('–Ω–æ–∂–Ω–∏—Ü—ã')">–ù–æ–∂–Ω–∏—Ü—ã</button>
    <button class="category-btn" onclick="filterByCategory('—Å–∫–æ—Ç—á')">–°–∫–æ—Ç—á</button>
    <button class="category-btn" onclick="filterByCategory('–Ω–æ–∂')">–ù–æ–∂</button>
  </div>

  <div class="search-sort-row">
    <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." />
    <select id="sort">
      <option value="">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ</option>
      <option value="asc">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à—ë–≤—ã–µ</option>
      <option value="desc">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</option>
    </select>
  </div>



  <!-- –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
  <div id="productTable" class="product-grid"></div>



  <div class="order-form">

    <h2>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</h2>

    <div id="cartList"></div>

    <div class="cart-summary">–ò—Ç–æ–≥–æ: <span id="totalSum">0</span> —Å–æ–º</div>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤–Ω–∏–∑ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π –∫–æ—Ä–∑–∏–Ω—ã -->
    <div style="display:flex;gap:8px;">
      <button id="openCartBtn" onclick="openCartPage()">–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
      <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã –±—É–¥–µ—Ç –≤ –ø–∞–Ω–µ–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã -->
    </div>

    <input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" required />

    <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required />

    <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" required />

    <button id="submitOrder">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>

  </div>

  <button id="logoutUser" style="margin:10px 0;">–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è</button>

  <button id="toggleHistory">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</button>

  <div id="orderHistory" style="display:none">

    <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>

    <ul id="historyList"></ul>

  </div>

  <div id="adminAuth" style="margin:20px 0;">
    <h3>–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
    <input type="password" id="adminPassword" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
    <button id="loginAdmin">–í–æ–π—Ç–∏</button>
  </div>

  <div id="adminAddProduct" style="margin:20px 0; display: none;">
    <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)</h3>
    <input type="text" id="newTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
    <input type="number" id="newPrice" placeholder="–¶–µ–Ω–∞">
    <select id="newCategory" style="padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; width: 100%;">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
      <option value="–≤—Å–µ">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
      <option value="–Ω–æ–∂–Ω–∏—Ü—ã">–ù–æ–∂–Ω–∏—Ü—ã</option>
      <option value="—Å–∫–æ—Ç—á">–°–∫–æ—Ç—á</option>
      <option value="–Ω–æ–∂">–ù–æ–∂</option>
    </select>
    <input type="number" id="newOptPrice" placeholder="–û–ø—Ç–æ–≤–∞—è —Ü–µ–Ω–∞">
    <input type="number" id="newOptQty" placeholder="–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –æ–ø—Ç–∞">
    <input type="number" id="newMinQty" placeholder="–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏">
    <div style="display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap;">
      <input type="file" id="imageFile" accept="image/*" style="flex: 1;">
      <input type="file" id="galleryFile" accept="image/*" style="display: none;">
      <button id="openGallery" style="flex: 1;" onclick="document.getElementById('galleryFile').click()">–í—ã–±—Ä–∞—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏</button>
    </div>
    <input type="text" id="newImage" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏" style="display: block; margin-bottom: 5px;">
    <button id="previewUrlBtn" style="margin-bottom: 10px;">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ URL</button>
    <div id="imagePreview" style="margin: 10px 0; display: none;">
      <img id="previewImg" src="" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" style="max-width: 200px; max-height: 200px;">
    </div>
    <button id="addProductBtn">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
    <button onclick="massUpdateCategories()" style="background: linear-gradient(90deg,#28a745 60%,#20c997 100%); margin-top: 10px;">üì¶ –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</button>
  </div>

  <div id="adminProductsBlock"></div>

  <!-- –û—Ç–¥–µ–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –∫–æ—Ä–∑–∏–Ω—ã -->
  <div id="cartPage" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2000;">
    <div style="background:#fff; width:95%; max-width:720px; height:90vh; margin:3vh auto; border-radius:10px; overflow:auto; padding:16px; position:relative;">
      <button onclick="closeCartPage()" style="position:absolute; right:12px; top:12px; font-size:18px;">&times;</button>
      <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
      <div id="cartPageList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:12px;"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
        <div style="font-weight:700;">–ò—Ç–æ–≥–æ: <span id="cartPageTotal">0</span></div>
        <div style="display:flex;gap:8px;">
            <button onclick="closeCartPage()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
            <button onclick="(function(){ closeCartPage(); document.querySelector('.order-form').scrollIntoView({behavior:'smooth'}); })()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
      </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button id="cartPageClear" style="background:#dc3545;color:#fff;border:none;padding:8px 12px;border-radius:8px;">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
    </div>
  </div>



  <script>
 let products = [];
 let isAdmin = false;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
  authDomain: "svoysayet.firebaseapp.com",
  projectId: "svoysayet",
  storageBucket: "svoysayet.firebasestorage.app",
  messagingSenderId: "450143000217",
  appId: "1:450143000217:web:7495cefaea0b94966e8a08",
  measurementId: "G-Y8VG9E29FY"
};

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase ‚Äî –¥–µ–ª–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –∂–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ SDK
let db, storage;
function initFirebase() {
  try {
    if (typeof firebase === 'undefined') throw new Error('Firebase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
    storage = firebase.storage();
    console.log('Firebase initialized successfully');
  } catch (error) {
    console.error('Firebase initialization error:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ' + error.message, 'error');
  }
}

if (typeof firebase !== 'undefined') {
  initFirebase();
} else {
  // –ï—Å–ª–∏ SDK –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('load', initFirebase);
}

// –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
const ADMIN_PASSWORD = "009860";

// –¢–µ–∫—É—â–∞—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "–≤—Å–µ" = –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –º–µ–ª–æ—á—å)
let currentCategory = '–≤—Å–µ';

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
async function loadProducts() {
  try {
    console.log('Loading products...');
    let snapshot;
    try {
      snapshot = await db.collection('products').orderBy('order').get();
    } catch (e) {
      // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—è order, –∑–∞–≥—Ä—É–∂–∞–µ–º –±–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
      snapshot = await db.collection('products').get();
    }
    products = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.image) {
        data.image = fixImageUrl(data.image);
      }
      products.push({ id: doc.id, ...data });
    });
    // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ order, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    if (!products.every(p => typeof p.order === 'number')) {
      products.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
    } else {
      products.sort((a, b) => (a.order || 0) - (b.order || 0));
    }
    console.log('Products loaded:', products.length);
    renderProducts();
  } catch (error) {
    console.error('Error loading products:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã: ' + error.message, 'error');
  }
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function fixImageUrl(url) {
  if (!url) return 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3E–ù–µ—Ç —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E';
  
  // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∏–º—è —Ñ–∞–π–ª–∞ (–±–µ–∑ –ø—É—Ç–∏)
  if (!url.includes('/') && !url.startsWith('http')) {
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
    return './images/' + url;
  }
  
  return url;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Firebase Storage
async function uploadImageToStorage(file) {
  try {
    console.log('Starting image upload...');
    const storageRef = storage.ref();
    const fileName = `${Date.now()}_${file.name}`;
    const fileRef = storageRef.child(`products/${fileName}`);
    
    console.log('Uploading file:', fileName);
    const snapshot = await fileRef.put(file);
    console.log('Upload completed:', snapshot);
    
    const downloadURL = await fileRef.getDownloadURL();
    console.log('Download URL:', downloadURL);
    
    return downloadURL;
  } catch (error) {
    console.error('Error uploading image:', error);
    throw error;
  }
}


// === Cloudinary upload helper ===
async function uploadToCloudinary(file) {
  const cloudName = 'dya0j6wgv'; // ‚Üê –í–°–¢–ê–í–¨ –°–Æ–î–ê –ò–ó Cloudinary // ‚Üê –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π cloud_name (–ø–æ–∑–∂–µ)
  const uploadPreset = 'mystore_upload';

  const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', uploadPreset);

  const res = await fetch(url, {
    method: 'POST',
    body: formData
  });

  const data = await res.json();
  if (data.secure_url) {
    return data.secure_url;
  } else {
    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Cloudinary');
  }
}


// === Imgur upload helper ===
async function uploadToImgur(file) {
  const clientId = 'YOUR_IMGUR_CLIENT_ID'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π Client-ID —Å https://api.imgur.com/oauth2/addclient
  const formData = new FormData();
  formData.append('image', file);
  const res = await fetch('https://api.imgur.com/3/image', {
    method: 'POST',
    headers: { Authorization: 'Client-ID ' + clientId },
    body: formData
  });
  const data = await res.json();
  if (data.success && data.data && data.data.link) {
    return data.data.link;
  } else {
    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Imgur');
  }
}

// === Postimages upload helper ===
async function uploadToPostimages(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_session', '');
  formData.append('numfiles', 1);
  formData.append('optsize', 0);
  formData.append('expire', 0);
  const res = await fetch('https://api.postimages.org/1/upload', {
    method: 'POST',
    body: formData
  });
  const data = await res.json();
  if (data && data.direct_link) {
    return data.direct_link;
  } else {
    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Postimages');
  }
}



// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞—á
// –¢–µ–ø–µ—Ä—å —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ ImageBB, —Å—Å—ã–ª–∫–∞ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ newImage

document.getElementById('imageFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  const addBtn = document.getElementById('addProductBtn');
  if (file) {
    addBtn.disabled = true;
    document.getElementById('newImage').value = '';
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('imagePreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
    try {
      // const url = await uploadImageToStorage(file); // –û—Ç–∫–ª—é—á–∞–µ–º Firebase Storage
      // const url = await uploadToImgur(file); // –û—Ç–∫–ª—é—á–∞–µ–º Imgur
      // const url = await uploadToPostimages(file); // –û—Ç–∫–ª—é—á–∞–µ–º Postimages
      const url = await uploadToCloudinary(file);
      document.getElementById('newImage').value = url;
      addBtn.disabled = false;
      Swal.fire('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ ImageBB!', '', 'success');
      console.log('Image uploaded to ImageBB and url set to newImage input:', url);
    } catch (err) {
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ ImageBB', 'error');
      addBtn.disabled = false;
    }
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
// –¢–µ–ø–µ—Ä—å —Ñ–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ ImageBB

document.getElementById('galleryFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  const addBtn = document.getElementById('addProductBtn');
  if (file) {
    addBtn.disabled = true;
    document.getElementById('newImage').value = '';
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('imagePreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
    try {
      // const url = await uploadImageToStorage(file); // –û—Ç–∫–ª—é—á–∞–µ–º Firebase Storage
      // const url = await uploadToImgur(file); // –û—Ç–∫–ª—é—á–∞–µ–º Imgur
      // const url = await uploadToPostimages(file); // –û—Ç–∫–ª—é—á–∞–µ–º Postimages
      const url = await uploadToCloudinary(file);
      document.getElementById('newImage').value = url;
      addBtn.disabled = false;
      Swal.fire('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ ImageBB!', '', 'success');
      console.log('Image from gallery uploaded to ImageBB and url set to newImage input:', url);
    } catch (err) {
      Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ ImageBB', 'error');
      addBtn.disabled = false;
    }
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
// –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ URL

document.getElementById('addProductBtn').addEventListener('click', async function() {
  try {
    console.log('Add product button clicked');
    const title = document.getElementById('newTitle').value.trim();
    const price = +document.getElementById('newPrice').value;
    const category = document.getElementById('newCategory').value;
    const optPrice = +document.getElementById('newOptPrice').value;
    const optQty = +document.getElementById('newOptQty').value;
    const minQty = +document.getElementById('newMinQty').value;
    const urlInput = document.getElementById('newImage').value.trim();
    let imageUrl = '';
    if (urlInput) {
      imageUrl = urlInput;
      console.log('Using manual url:', imageUrl);
    } else {
      imageUrl = document.getElementById('newImage').value.trim();
      if (!imageUrl) {
        Swal.fire('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª!', 'warning');
        return;
      }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!title) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', 'warning');
      return;
    }
    if (!price || price <= 0) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É', 'warning');
      return;
    }

    // --- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ---
    const addBtn = document.getElementById('addProductBtn');
    addBtn.disabled = true;
    addBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
    const isValidImage = await checkImage(imageUrl);
    if (!isValidImage) {
      addBtn.disabled = false;
      addBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
      Swal.fire('–û—à–∏–±–∫–∞', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª/URL.', 'error');
      return;
    }
    addBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
    addBtn.disabled = false;
    // --- –∫–æ–Ω–µ—Ü –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ ---

    // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π order —Å—Ä–µ–¥–∏ —Ç–æ–≤–∞—Ä–æ–≤
    let maxOrder = 0;
    products.forEach(p => {
      if (typeof p.order === 'number' && p.order > maxOrder) maxOrder = p.order;
    });

    const productData = { 
      title, 
      price,
      category: category || '–≤—Å–µ',
      optPrice: optPrice > 0 ? optPrice : null,
      optQty: optQty > 0 ? optQty : null,
      minQty: minQty > 0 ? minQty : 1,
      image: imageUrl,
      order: maxOrder + 1 
    };
    
    console.log('Adding product to Firestore:', productData);
    const docRef = await db.collection('products').add(productData);
    console.log('Product added with ID:', docRef.id);
    await loadProducts();
    renderProducts();
    Swal.fire('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!', '', 'success');
    await loadProducts();
    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('newImage').value = '';
    document.getElementById('newTitle').value = '';
    document.getElementById('newPrice').value = '';
    document.getElementById('newCategory').value = '';
    document.getElementById('newOptPrice').value = '';
    document.getElementById('newOptQty').value = '';
    document.getElementById('newMinQty').value = '';
    document.getElementById('imageFile').value = '';
    document.getElementById('imagePreview').style.display = 'none';
  } catch (error) {
    console.error('Error details:', error);
    document.getElementById('addProductBtn').disabled = false;
    document.getElementById('addProductBtn').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
    Swal.fire('–û—à–∏–±–∫–∞', `–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä: ${error.message}`, 'error');
  }
});

// –§–æ–Ω —Å–∞–π—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ CSS
// (–∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ–Ω–∞ —É–¥–∞–ª–µ–Ω, —Ç–∞–∫ –∫–∞–∫ —Ñ–∞–π–ª –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã
const cart = JSON.parse(localStorage.getItem('cart')) || [];

const productTable = document.getElementById('productTable');
const search = document.getElementById('search');
const sort = document.getElementById('sort');
const cartList = document.getElementById('cartList');
const totalSum = document.getElementById('totalSum');


// –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
const userData = JSON.parse(localStorage.getItem('userData') || '{}');
if (userData.name) document.getElementById('name').value = userData.name;
if (userData.phone) document.getElementById('phone').value = userData.phone;
if (userData.address) document.getElementById('address').value = userData.address;

// –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
function filterByCategory(category) {
  currentCategory = category;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
  const buttons = document.querySelectorAll('.category-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã
  renderProducts();
}

function addToCart(id, title, price, image, btn) {
  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤–µ—Ä—Å—Ç–∫–∏: –∫–∞—Ä—Ç–æ—á–∫–∏ (.product-card) –∏ —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã
  const card = btn.closest && btn.closest('.product-card');
  const container = card || (btn.parentElement && btn.parentElement.parentElement) || document;

  let qtyInput = null;
  if (container && container.querySelector) {
    qtyInput = container.querySelector('.card-qty-input') || container.querySelector('input');
  }

  let qty = 1;
  if (qtyInput) {
    qty = parseInt(qtyInput.value, 10) || 1;
  }

  const product = products.find(p => p.id === id) || {};

  if (qty < (product.minQty || 1)) {
    Swal.fire('–û—à–∏–±–∫–∞', `–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏: ${product.minQty || 1}`, 'warning');
    if (qtyInput) qtyInput.value = product.minQty || 1;
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∞—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "—Å–∫–æ—Ç—á"
  if (product.category === '—Å–∫–æ—Ç—á' && product.minQty && product.minQty > 1) {
    if (qty % product.minQty !== 0) {
      Swal.fire({
        icon: 'warning',
        title: '–û—à–∏–±–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞',
        html: `–¢–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–°–∫–æ—Ç—á" –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–Ω–æ <b>${product.minQty}</b> —à—Ç.<br><br>–ù–∞–ø—Ä–∏–º–µ—Ä: ${product.minQty}, ${product.minQty * 2}, ${product.minQty * 3} —à—Ç.`,
        confirmButtonText: '–ü–æ–Ω—è—Ç–Ω–æ'
      });
      if (qtyInput) qtyInput.value = product.minQty;
      return;
    }
  }

  // –°—á–∏—Ç–∞–µ–º –∏—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
  const index = cart.findIndex(item => item.id === id);
  let totalQty = qty;
  if (index !== -1) totalQty += cart[index].qty;

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–Ω—É: –µ—Å–ª–∏ –æ–ø—Ç, —Ç–æ –æ–ø—Ç–æ–≤–∞—è —Ü–µ–Ω–∞
  let finalPrice = price;
  if (product.optQty && totalQty >= product.optQty && product.optPrice) {
    finalPrice = product.optPrice;
  }

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ
  if (index !== -1) {
    cart[index].qty += qty;
    cart[index].price = (product.optQty && cart[index].qty >= product.optQty && product.optPrice)
      ? product.optPrice
      : product.price || price;
  } else {
    cart.push({ id, title, price: finalPrice, qty, image });
  }

  updateCart();

  btn.classList.add('animate-add');
  setTimeout(() => btn.classList.remove('animate-add'), 500);

  Swal.fire({
    title: '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!',
    text: `${title} √ó ${qty} –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à—É –∫–æ—Ä–∑–∏–Ω—É.`,
    icon: 'success',
    confirmButtonText: '–û–∫',
    position: 'bottom',
    showConfirmButton: true,
    timer: 1500,
    padding: '10px',
    toast: true
  });

  localStorage.setItem('cart', JSON.stringify(cart));
}

function updateCart() {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –±–æ–ª—å—à–µ 4
  let scrollHint = document.getElementById('cartScrollHint');
  if (!scrollHint) {
    scrollHint = document.createElement('div');
    scrollHint.id = 'cartScrollHint';
    scrollHint.className = 'cart-scroll-hint';
    cartList.parentNode.insertBefore(scrollHint, cartList);
  }
  if (cart.length > 4) {
    scrollHint.textContent = '–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ ‚Üì';
    scrollHint.style.display = '';
  } else {
    scrollHint.style.display = 'none';
  }
  cartList.innerHTML = '';

  let total = 0;

  cart.forEach((item, i) => {
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
    const product = products.find(p => p.id === item.id);
    if (product) {
    if (product.optQty && item.qty >= product.optQty && product.optPrice) {
  item.price = product.optPrice;
} else {
  item.price = product.price;
}

    }
    total += item.qty * item.price;

    // –ú–∏–Ω–∏-—Ñ–æ—Ç–æ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const imgSrc = (product && product.image) ? product.image : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3E–ù–µ—Ç —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E';
    const div = document.createElement('div');
    div.classList.add('cart-item', 'cart-item-compact');
    div.innerHTML = `
      <img src="${imgSrc}" alt="" class="cart-mini-img" style="cursor:pointer;" onclick="showPreview('${imgSrc}')">
      <div class="cart-info-row" style="display:flex;align-items:center;flex:1 1 auto;gap:8px;min-width:0;">
        <span class="cart-title" style="flex:1 1 0;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.title}</span>
  <span class="cart-qty" style="white-space:nowrap;">√ó${item.qty}</span>
  <span class="cart-price" style="white-space:nowrap;">${item.price} —Å–æ–º</span>
  <span class="cart-sum" style="white-space:nowrap;font-weight:bold;">${item.qty * item.price} —Å–æ–º</span>
      </div>
      <button class="delete-item" onclick="removeFromCart(${i})">&times;</button>
    `;
    cartList.appendChild(div);
  });

  totalSum.textContent = total + ' —Å–æ–º';

  // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ—Ä–∑–∏–Ω—ã, –æ–±–Ω–æ–≤–∏–º –µ—ë
  if (document.getElementById('cartPage') && document.getElementById('cartPage').style.display !== 'none') {
    renderCartPage();
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
  const cartPageClearBtn = document.getElementById('cartPageClear');
  if (cartPageClearBtn) {
    cartPageClearBtn.style.display = cart.length === 0 ? 'none' : 'inline-block';
  }

  localStorage.setItem('cart', JSON.stringify(cart));
}

function removeFromCart(i) {
  // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
  const cartList = document.getElementById('cartList');
  const itemDiv = cartList.children[i];
  if (itemDiv) {
    itemDiv.classList.add('cart-item-removing');
    setTimeout(() => {
      cart.splice(i, 1);
      updateCart();
    }, 300);
  } else {
    cart.splice(i, 1);
    updateCart();
  }
}

// –û—Ç–∫—Ä—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É-–ø–∞–Ω–µ–ª—å –∫–æ—Ä–∑–∏–Ω—ã
function openCartPage() {
  renderCartPage();
  document.getElementById('cartPage').style.display = '';
}

function closeCartPage() {
  document.getElementById('cartPage').style.display = 'none';
}

function renderCartPage() {
  const list = document.getElementById('cartPageList');
  const totalEl = document.getElementById('cartPageTotal');
  list.innerHTML = '';
  let total = 0;
  cart.forEach((item, i) => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.gap = '10px';
    div.style.alignItems = 'center';
    div.innerHTML = `
      <img src="${item.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3E–ù–µ—Ç —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E'}" style="width:64px;height:64px;object-fit:cover;border-radius:6px;"> 
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.title}</div>
        <div style="color:#666;">${item.qty} √ó ${item.price} —Å–æ–º</div>
      </div>
      <div style="font-weight:700;">${item.qty * item.price} —Å–æ–º</div>
      <div style="display:flex;flex-direction:column;gap:6px;margin-left:8px;">
        <button onclick="removeFromCart(${i})" style="background:#dc3545;color:#fff;border:none;padding:6px 8px;border-radius:6px;">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    list.appendChild(div);
    total += item.qty * item.price;
  });
  totalEl.textContent = total + ' —Å–æ–º';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–∑–∏–Ω—ã –∏ –ø—Ä–∏–≤—è–∑–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing...');
  try {
    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –≤ –ø–∞–Ω–µ–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    const cartPageClear = document.getElementById('cartPageClear');
    if (cartPageClear) {
      cartPageClear.addEventListener('click', function() {
        cart.length = 0;
        localStorage.removeItem('cart');
        updateCart();
        closeCartPage();
        if (window.Swal) Swal.fire('–ì–æ—Ç–æ–≤–æ', '–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
      });
    }

    loadProducts();
    updateCart(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    // –ï—Å–ª–∏ —É–∂–µ –±—ã–ª –≤—Ö–æ–¥ –∫–∞–∫ –∞–¥–º–∏–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è), –ø–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å
    if (isAdmin) {
      const adminPanel = document.getElementById('adminPanel');
      if (adminPanel) adminPanel.style.display = '';
    }
  } catch (error) {
    console.error('Error during initialization:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ' + error.message, 'error');
  }
});

document.getElementById('submitOrder').onclick = async () => {
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();

  if (!name || !phone || !address || cart.length === 0) {
    Swal.fire('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã', 'warning');
    return;
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
  Swal.fire({
    title: '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞...',
    html: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ',
    allowOutsideClick: false,
    allowEscapeKey: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  try {
  const items = cart.map(i => `${i.title} ‚Äî ${i.qty}√ó${i.price} —Å–æ–º = ${i.qty * i.price} —Å–æ–º`).join('\n');
    const total = cart.reduce((sum, item) => sum + item.qty * item.price, 0);
    const currentTime = new Date().toLocaleString();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑ –≤ Firebase
    await db.collection('orders').add({
      name,
      phone,
      address,
      items: cart.map(item => ({
        title: item.title,
        qty: item.qty,
        price: item.price
      })),
      total,
      time: currentTime,
      status: '–ù–æ–≤—ã–π'
    });

  const msg = `–ù–æ–≤—ã–π –∑–∞–∫–∞–∑:\n–ò–º—è: ${name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n–ê–¥—Ä–µ—Å: ${address}\n–¢–æ–≤–∞—Ä—ã:\n${items}\n\n–ò—Ç–æ–≥–æ: ${total} —Å–æ–º`;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF —Ñ–∞–π–ª —Å —Ñ–æ—Ç–æ –∏ Excel —Ñ–∞–π–ª –±–µ–∑ —Ñ–æ—Ç–æ
    await sendOrderAsPDF(name, phone, address, cart, total, currentTime);
    await sendOrderAsExcel(name, phone, address, cart, total, currentTime);

    Swal.fire('–£—Å–ø–µ—Ö!', '–í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
    
    // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
    cart.length = 0;
    updateCart();
    localStorage.removeItem('cart');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    localStorage.setItem('userData', JSON.stringify({
      name,
      phone,
      address
    }));

    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('name').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('address').value = '';

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤
    loadOrderHistory();

  } catch (error) {
    console.error('Error submitting order:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
  }
};

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ –∫–∞–∫ PDF —Ñ–∞–π–ª –≤ Telegram
async function sendOrderAsPDF(name, phone, address, cartItems, total, time) {
  try {
    console.log('=== –ù–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è PDF —Ñ–∞–π–ª–∞ ===');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPosition = 20;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const headerCanvas = document.createElement('canvas');
    const headerCtx = headerCanvas.getContext('2d');
    headerCanvas.width = 600;
    headerCanvas.height = 50;
    
    headerCtx.fillStyle = 'white';
    headerCtx.fillRect(0, 0, headerCanvas.width, headerCanvas.height);
    headerCtx.fillStyle = 'black';
    headerCtx.font = 'bold 24px Arial';
    headerCtx.textAlign = 'center';
    headerCtx.fillText('–ù–û–í–´–ô –ó–ê–ö–ê–ó', 300, 35);
    
    const headerImage = headerCanvas.toDataURL('image/png');
    doc.addImage(headerImage, 'PNG', 20, yPosition, 170, 15);
    
    yPosition += 20;
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ –≤ —Ä–∞–º–∫–µ
    const infoCanvas = document.createElement('canvas');
    const infoCtx = infoCanvas.getContext('2d');
    infoCanvas.width = 700;
    infoCanvas.height = 120;
    
    // –ë–µ–ª—ã–π —Ñ–æ–Ω —Å —á–µ—Ä–Ω–æ–π —Ä–∞–º–∫–æ–π
    infoCtx.fillStyle = 'white';
    infoCtx.fillRect(0, 0, infoCanvas.width, infoCanvas.height);
    infoCtx.strokeStyle = 'black';
    infoCtx.lineWidth = 2;
    infoCtx.strokeRect(0, 0, infoCanvas.width, infoCanvas.height);
    
    // –¢–µ–∫—Å—Ç
    infoCtx.fillStyle = 'black';
    infoCtx.font = '16px Arial';
    infoCtx.fillText(`–î–∞—Ç–∞/–í—Ä–µ–º—è: ${time}`, 15, 30);
    infoCtx.fillText(`–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞: ${name}`, 15, 55);
    infoCtx.fillText(`–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}`, 15, 80);
    infoCtx.fillText(`–ê–¥—Ä–µ—Å: ${address}`, 15, 105);
    
    const infoImage = infoCanvas.toDataURL('image/png');
    doc.addImage(infoImage, 'PNG', 20, yPosition, 170, 30);
    
    yPosition += 35;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã —Å —Å–µ—Ç–∫–æ–π
    const tableHeaderCanvas = document.createElement('canvas');
    const thCtx = tableHeaderCanvas.getContext('2d');
    tableHeaderCanvas.width = 550;
    tableHeaderCanvas.height = 50;
    
    // –°–µ—Ä—ã–π —Ñ–æ–Ω –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
    thCtx.fillStyle = '#e0e0e0';
    thCtx.fillRect(0, 0, tableHeaderCanvas.width, tableHeaderCanvas.height);
    
    // –†–∞–º–∫–∞
    thCtx.strokeStyle = 'black';
    thCtx.lineWidth = 2;
    thCtx.strokeRect(0, 0, tableHeaderCanvas.width, tableHeaderCanvas.height);
    
    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ (–∫–æ–ª–æ–Ω–∫–∏: –§–æ—Ç–æ | –ù–∞–∑–≤–∞–Ω–∏–µ | –ö–æ–ª-–≤–æ | –¶–µ–Ω–∞ | –°—É–º–º–∞)
    thCtx.beginPath();
    thCtx.moveTo(90, 0);
    thCtx.lineTo(90, 50);
    thCtx.moveTo(310, 0);
    thCtx.lineTo(310, 50);
    thCtx.moveTo(390, 0);
    thCtx.lineTo(390, 50);
    thCtx.moveTo(470, 0);
    thCtx.lineTo(470, 50);
    thCtx.stroke();
    
    // –¢–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    thCtx.fillStyle = 'black';
    thCtx.font = 'bold 14px Arial';
    thCtx.textAlign = 'center';
    thCtx.fillText('–§–û–¢–û', 45, 32);
    thCtx.fillText('–ù–ê–ó–í–ê–ù–ò–ï', 200, 32);
    thCtx.fillText('–ö–û–õ-–í–û', 350, 32);
    thCtx.fillText('–¶–ï–ù–ê', 430, 32);
    thCtx.fillText('–°–£–ú–ú–ê', 510, 32);
    
    const tableHeaderImage = tableHeaderCanvas.toDataURL('image/png');
    doc.addImage(tableHeaderImage, 'PNG', 20, yPosition, 170, 12);
    
    yPosition += 12;
    
    // –¢–æ–≤–∞—Ä—ã —Å —Å–µ—Ç–∫–æ–π
    for (let i = 0; i < cartItems.length; i++) {
      const item = cartItems[i];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏–º –ª–∏ –∑–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
      if (yPosition > 240) {
        doc.addPage();
        yPosition = 20;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã
      let photoWidth = 90;  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
      let photoHeight = 130;
      let photoData = null;
      
      if (item.image && item.image.startsWith('http')) {
        try {
          const response = await fetch(item.image);
          const blob = await response.blob();
          
          const reader = new FileReader();
          const base64 = await new Promise((resolve) => {
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
          
          photoData = base64;
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —Ñ–æ—Ç–æ
          const img = new Image();
          await new Promise((resolve) => {
            img.onload = resolve;
            img.src = base64;
          });
          
          // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
          const aspectRatio = img.width / img.height;
          
          if (aspectRatio > 1.2) {
            // –®–∏—Ä–æ–∫–æ–µ —Ñ–æ—Ç–æ
            photoWidth = 130;
            photoHeight = 130;
          } else if (aspectRatio < 0.8) {
            // –£–∑–∫–æ–µ –¥–ª–∏–Ω–Ω–æ–µ —Ñ–æ—Ç–æ
            photoWidth = 70;
            photoHeight = 130;
          } else {
            // –ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ
            photoWidth = 90;
            photoHeight = 130;
          }
          
          console.log('‚úì –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', item.title, `–ü—Ä–æ–ø–æ—Ä—Ü–∏–∏: ${aspectRatio.toFixed(2)}`);
        } catch (err) {
          console.error('‚úó –û—à–∏–±–∫–∞ —Ñ–æ—Ç–æ:', item.title, err);
        }
      }
      
      // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É —Ç–∞–±–ª–∏—Ü—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —à–∏—Ä–∏–Ω–æ–π
      const rowCanvas = document.createElement('canvas');
      const rowCtx = rowCanvas.getContext('2d');
      const totalWidth = photoWidth + 460; // —Ñ–æ—Ç–æ + –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
      rowCanvas.width = totalWidth;
      rowCanvas.height = photoHeight;
      
      // –ë–µ–ª—ã–π —Ñ–æ–Ω
      rowCtx.fillStyle = 'white';
      rowCtx.fillRect(0, 0, rowCanvas.width, rowCanvas.height);
      
      // –†–∞–º–∫–∞ —Å—Ç—Ä–æ–∫–∏
      rowCtx.strokeStyle = 'black';
      rowCtx.lineWidth = 2;
      rowCtx.strokeRect(0, 0, rowCanvas.width, rowCanvas.height);
      
      // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
      const col2 = photoWidth;
      const col3 = photoWidth + 220;
      const col4 = photoWidth + 300;
      const col5 = photoWidth + 380;
      
      rowCtx.beginPath();
      rowCtx.moveTo(col2, 0);
      rowCtx.lineTo(col2, photoHeight);
      rowCtx.moveTo(col3, 0);
      rowCtx.lineTo(col3, photoHeight);
      rowCtx.moveTo(col4, 0);
      rowCtx.lineTo(col4, photoHeight);
      rowCtx.moveTo(col5, 0);
      rowCtx.lineTo(col5, photoHeight);
      rowCtx.stroke();
      
      // –¢–µ–∫—Å—Ç –≤ —è—á–µ–π–∫–∞—Ö
      rowCtx.fillStyle = 'black';
      rowCtx.font = '13px Arial';
      rowCtx.textAlign = 'center';
      
      const midY = photoHeight / 2;
      
      // –ù–∞–∑–≤–∞–Ω–∏–µ (—Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω–æ–µ)
      rowCtx.textAlign = 'left';
      const title = item.title;
      if (title.length > 25) {
        rowCtx.fillText(title.substring(0, 25), col2 + 5, midY - 5);
        rowCtx.fillText(title.substring(25), col2 + 5, midY + 10);
      } else {
        rowCtx.fillText(title, col2 + 5, midY);
      }
      
      // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
      rowCtx.textAlign = 'center';
      rowCtx.fillText(`${item.qty} —à—Ç`, (col3 + col4) / 2, midY);
      
      // –¶–µ–Ω–∞
      rowCtx.fillText(`${item.price}`, (col4 + col5) / 2, midY - 5);
      rowCtx.font = '11px Arial';
      rowCtx.fillText('—Å–æ–º', (col4 + col5) / 2, midY + 8);
      
      // –°—É–º–º–∞
      rowCtx.font = 'bold 13px Arial';
      rowCtx.fillText(`${item.qty * item.price}`, (col5 + totalWidth) / 2, midY - 5);
      rowCtx.font = '11px Arial';
      rowCtx.fillText('—Å–æ–º', (col5 + totalWidth) / 2, midY + 8);
      
      const rowImage = rowCanvas.toDataURL('image/png');
      const rowPdfHeight = photoHeight * 170 / totalWidth; // –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
      doc.addImage(rowImage, 'PNG', 20, yPosition, 170, rowPdfHeight);
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ–≤–µ—Ä—Ö —è—á–µ–π–∫–∏
      if (photoData) {
        const photoWidthPdf = photoWidth * 170 / totalWidth;
        const photoHeightPdf = rowPdfHeight - 4;
        doc.addImage(photoData, 'JPEG', 22, yPosition + 2, photoWidthPdf - 4, photoHeightPdf);
      }
      
      yPosition += rowPdfHeight;
    }
    
    // –°—Ç—Ä–æ–∫–∞ –ò–¢–û–ì–û —Å —Å–µ—Ç–∫–æ–π
    const totalCanvas = document.createElement('canvas');
    const totalCtx = totalCanvas.getContext('2d');
    totalCanvas.width = 550;
    totalCanvas.height = 60;
    
    // –ñ–µ–ª—Ç—ã–π —Ñ–æ–Ω –¥–ª—è –∏—Ç–æ–≥–æ
    totalCtx.fillStyle = '#fff9c4';
    totalCtx.fillRect(0, 0, totalCanvas.width, totalCanvas.height);
    
    // –†–∞–º–∫–∞
    totalCtx.strokeStyle = 'black';
    totalCtx.lineWidth = 3;
    totalCtx.strokeRect(0, 0, totalCanvas.width, totalCanvas.height);
    
    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è
    totalCtx.beginPath();
    totalCtx.moveTo(470, 0);
    totalCtx.lineTo(470, 60);
    totalCtx.stroke();
    
    // –¢–µ–∫—Å—Ç
    totalCtx.fillStyle = 'black';
    totalCtx.font = 'bold 18px Arial';
    totalCtx.textAlign = 'right';
    totalCtx.fillText('–ò–¢–û–ì–û:', 450, 38);
    
    totalCtx.textAlign = 'center';
    totalCtx.fillText(`${total}`, 510, 32);
    totalCtx.font = '14px Arial';
    totalCtx.fillText('—Å–æ–º', 510, 48);
    
    const totalImage = totalCanvas.toDataURL('image/png');
    doc.addImage(totalImage, 'PNG', 20, yPosition, 170, 15);
    
    console.log('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF —Ñ–∞–π–ª...');
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF –∫–∞–∫ blob
    const pdfBlob = doc.output('blob');
    
    console.log('PDF —Ñ–∞–π–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω, —Ä–∞–∑–º–µ—Ä:', pdfBlob.size, '–±–∞–π—Ç');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
    const formData = new FormData();
    formData.append('chat_id', '5567924440');
    formData.append('document', pdfBlob, `–ó–∞–∫–∞–∑_${name}_${Date.now()}.pdf`);
    formData.append('caption', `üì∑ –ó–∞–∫–∞–∑ —Å —Ñ–æ—Ç–æ –æ—Ç ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const formData2 = new FormData();
    formData2.append('chat_id', '246421345');
    formData2.append('document', pdfBlob, `–ó–∞–∫–∞–∑_${name}_${Date.now()}.pdf`);
    formData2.append('caption', `üì∑ –ó–∞–∫–∞–∑ —Å —Ñ–æ—Ç–æ –æ—Ç ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData2
    });

    console.log('PDF —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF:', error);
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ –∫–∞–∫ Excel —Ñ–∞–π–ª –≤ Telegram
async function sendOrderAsExcel(name, phone, address, cartItems, total, time) {
  try {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('–ó–∞–∫–∞–∑');

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    worksheet.addRow(['–ù–û–í–´–ô –ó–ê–ö–ê–ó']);
    worksheet.addRow([]);
    worksheet.addRow(['–î–∞—Ç–∞/–í—Ä–µ–º—è:', time]);
    worksheet.addRow(['–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:', name]);
    worksheet.addRow(['–¢–µ–ª–µ—Ñ–æ–Ω:', phone]);
    worksheet.addRow(['–ê–¥—Ä–µ—Å:', address]);
    worksheet.addRow([]);
    
    // –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤
    const headerRow = worksheet.addRow(['–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ', '–¶–µ–Ω–∞ –∑–∞ —à—Ç.', '–°—É–º–º–∞']);
    
    cartItems.forEach(item => {
      const row = worksheet.addRow([
        item.title,
        `${item.qty} —à—Ç`,
        `${item.price} —Å–æ–º`,
        `${item.qty * item.price} —Å–æ–º`
      ]);
      // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É
      row.getCell(2).alignment = { horizontal: 'center', vertical: 'middle' };
    });
    
    worksheet.addRow([]);
    const totalRow = worksheet.addRow(['–ò–¢–û–ì–û:', '', '', `${total} —Å–æ–º`]);

    // –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è
    worksheet.getRow(1).font = { size: 16, bold: true };
    headerRow.font = { bold: true };
    totalRow.font = { bold: true };
    
    // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
    headerRow.eachCell((cell) => {
      cell.alignment = { horizontal: 'center', vertical: 'middle' };
    });
    
    worksheet.columns = [
      { width: 30 },
      { width: 15 },
      { width: 15 },
      { width: 15 }
    ];

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram —á–µ—Ä–µ–∑ FormData
    const formData = new FormData();
    formData.append('chat_id', '5567924440');
    formData.append('document', blob, `–ó–∞–∫–∞–∑_${name}_${Date.now()}.xlsx`);
    formData.append('caption', `üìä Excel –∑–∞–∫–∞–∑ –æ—Ç ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    const formData2 = new FormData();
    formData2.append('chat_id', '246421345');
    formData2.append('document', blob, `–ó–∞–∫–∞–∑_${name}_${Date.now()}.xlsx`);
    formData2.append('caption', `üìä Excel –∑–∞–∫–∞–∑ –æ—Ç ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData2
    });

    console.log('Excel —Ñ–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Excel:', error);
  }
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤
async function loadOrderHistory() {
  try {
    const snapshot = await db.collection('orders')
      .orderBy('time', 'desc')
      .get();
    
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';

    if (snapshot.empty) {
      historyList.innerHTML = '<li>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞.</li>';
      return;
    }

    snapshot.forEach(doc => {
      const order = doc.data();
      const li = document.createElement('li');
      li.style.marginBottom = '20px';
      li.style.padding = '10px';
      li.style.border = '1px solid #ddd';
      li.style.borderRadius = '5px';
      
      li.innerHTML = `
        <strong>–ó–∞–∫–∞–∑ –æ—Ç: ${order.time}</strong>
        <p>–ò–º—è: ${order.name}</p>
        <p>–¢–µ–ª–µ—Ñ–æ–Ω: ${order.phone}</p>
        <p>–ê–¥—Ä–µ—Å: ${order.address}</p>
        <p>–¢–æ–≤–∞—Ä—ã: ${order.items.map(i => `${i.title} √ó ${i.qty}`).join(', ')}</p>
  <p><strong>–ò—Ç–æ–≥–æ: ${order.total} —Å–æ–º</strong></p>
        <p>–°—Ç–∞—Ç—É—Å: ${order.status}</p>
        ${isAdmin ? `
          <button class="delete-order" onclick="deleteOrder('${doc.id}')">–£–¥–∞–ª–∏—Ç—å</button>
          <select onchange="updateOrderStatus('${doc.id}', this.value)" style="margin-left: 10px;">
            <option value="–ù–æ–≤—ã–π" ${order.status === '–ù–æ–≤—ã–π' ? 'selected' : ''}>–ù–æ–≤—ã–π</option>
            <option value="–í –æ–±—Ä–∞–±–æ—Ç–∫–µ" ${order.status === '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ' ? 'selected' : ''}>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
            <option value="–í—ã–ø–æ–ª–Ω–µ–Ω" ${order.status === '–í—ã–ø–æ–ª–Ω–µ–Ω' ? 'selected' : ''}>–í—ã–ø–æ–ª–Ω–µ–Ω</option>
            <option value="–û—Ç–º–µ–Ω–µ–Ω" ${order.status === '–û—Ç–º–µ–Ω–µ–Ω' ? 'selected' : ''}>–û—Ç–º–µ–Ω–µ–Ω</option>
          </select>
        ` : ''}
      `;
      historyList.appendChild(li);
    });
  } catch (error) {
    console.error('Error loading order history:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤', 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
async function deleteOrder(orderId) {
  try {
    const result = await Swal.fire({
      title: '–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?',
      text: "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å!',
      cancelButtonText: '–û—Ç–º–µ–Ω–∞'
    });

    if (result.isConfirmed) {
      await db.collection('orders').doc(orderId).delete();
      Swal.fire('–£–¥–∞–ª–µ–Ω–æ!', '–ó–∞–∫–∞–∑ –±—ã–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.', 'success');
      loadOrderHistory();
    }
  } catch (error) {
    console.error('Error deleting order:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑', 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞
async function updateOrderStatus(orderId, newStatus) {
  try {
    await db.collection('orders').doc(orderId).update({
      status: newStatus
    });
    loadOrderHistory();
  } catch (error) {
    console.error('Error updating order status:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞', 'error');
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤
document.getElementById('toggleHistory').onclick = () => {
  const hist = document.getElementById('orderHistory');
  hist.style.display = hist.style.display === 'none' ? 'block' : 'none';
  
  if (hist.style.display === 'block') {
    loadOrderHistory();
  }
};

search.oninput = renderProducts;
sort.onchange = renderProducts;
renderProducts();
updateCart();

function showPreview(src) {
  document.getElementById('previewImg').src = src;
  document.getElementById('previewBlock').style.display = 'block';
  document.body.classList.add('modal-open');
}

document.getElementById('closePreview').onclick = function() {
  document.getElementById('previewBlock').style.display = 'none';
  document.body.classList.remove('modal-open');
};

document.getElementById('previewBlock').onclick = function(e) {
  if (e.target === this) {
    this.style.display = 'none';
    document.body.classList.remove('modal-open');
  }
};

function updatePriceInRow(input, price, optPrice, optQty) {
  const qty = +input.value;
  const priceCell = input.parentElement.parentElement.querySelector('.price-cell span');
  if (optQty && qty >= optQty && optPrice) {
    priceCell.textContent = optPrice + ' —Å–æ–º';
  } else {
    priceCell.textContent = price + ' —Å–æ–º';
  }
}

document.getElementById('logoutUser').onclick = () => {
  isAdmin = false;
  document.getElementById('adminAddProduct').style.display = 'none';
  document.getElementById('adminAuth').style.display = 'block';
  document.getElementById('managementHeader').style.display = 'none';
  document.getElementById('adminPassword').value = '';
  localStorage.removeItem('userData');
  document.getElementById('name').value = '';
  document.getElementById('phone').value = '';
  document.getElementById('address').value = '';
  Swal.fire('–í—ã –≤—ã—à–ª–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è');
  renderProducts();
  // –°–∫—Ä—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
  document.getElementById('adminPanel').style.display = 'none';
};

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
async function checkImage(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = url;
  });
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
function renderProducts() {
  // –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —Å—Ç–∏–ª–µ AliExpress
  const container = document.getElementById('productTable');
  container.innerHTML = '';
  let filtered = isAdmin ? products : products.filter(p => !p.blocked);
  
  console.log('–¢–µ–∫—É—â–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:', currentCategory);
  console.log('–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:', filtered.length);
  
  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è –≤—Å–µ—Ö)
  if (currentCategory === '–≤—Å–µ') {
    // –í —Ä–∞–∑–¥–µ–ª–µ "–í—Å–µ —Ç–æ–≤–∞—Ä—ã" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π "–≤—Å–µ" –∏–ª–∏ –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    filtered = filtered.filter(p => !p.category || p.category.toLowerCase() === '–≤—Å–µ');
  } else {
    // –í –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    filtered = filtered.filter(p => p.category && p.category.toLowerCase() === currentCategory.toLowerCase());
  }
  
  console.log('–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', filtered.length);
  
  const q = (search && search.value) ? search.value.toLowerCase() : '';
  const list = q ? filtered.filter(p => p.title && p.title.toLowerCase().includes(q)) : filtered;

  list.forEach((p) => {
    const card = document.createElement('div');
    card.className = 'product-card';

    // ratings removed per request

    card.innerHTML = `
        <div class="card-image" style="position:relative;">
        <img src="${p.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3E–ù–µ—Ç —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E'}" alt="${p.title || ''}" onclick="openPreviewForProduct('${p.id}')" />
        ${isAdmin ? `<button onclick="changeProductImage('${p.id}')" style="position:absolute;top:4px;right:4px;background:rgba(0,123,255,0.9);color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,0.3);">üì∑ –ò–∑–º–µ–Ω–∏—Ç—å</button>` : ''}
      </div>
      <div class="card-body">
        <div class="card-title">${isAdmin ? `<input value="${p.title||''}" onchange="updateProductTitle('${p.id}', this.value)" class="admin-product-input"/>` : `<div>${p.title||''}</div>`}</div>
        ${isAdmin ? `<select onchange="updateProductCategory('${p.id}', this.value)" class="admin-product-input" style="font-size:12px;padding:6px;margin:4px 0;">
          <option value="–≤—Å–µ" ${(p.category||'–≤—Å–µ')==='–≤—Å–µ'?'selected':''}>–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
          <option value="–Ω–æ–∂–Ω–∏—Ü—ã" ${(p.category||'')==='–Ω–æ–∂–Ω–∏—Ü—ã'?'selected':''}>–ù–æ–∂–Ω–∏—Ü—ã</option>
          <option value="—Å–∫–æ—Ç—á" ${(p.category||'')==='—Å–∫–æ—Ç—á'?'selected':''}>–°–∫–æ—Ç—á</option>
          <option value="–Ω–æ–∂" ${(p.category||'')==='–Ω–æ–∂'?'selected':''}>–ù–æ–∂</option>
        </select>` : ''}
        <div style="display:flex;align-items:center;gap:8px;">
          ${isAdmin ? `<input type="number" value="${p.price||0}" onchange="updateProductPrice('${p.id}', this.value)" class="admin-product-input" style="width:120px;font-size:16px;font-weight:700;color:#e53935;" placeholder="–¶–µ–Ω–∞"/>` : `<div class="card-price">${p.price || '0'} —Å–æ–º</div>`}
          ${!isAdmin && p.oldPrice ? `<div class="card-oldprice">${p.oldPrice} —Å–æ–º</div>` : ''}
        </div>
        <div class="card-opt-info" data-opt-id="${p.id}" style="font-size:12px;color:#007bff;margin-top:4px;">
          ${p.optPrice && p.optQty ? `–û–ø—Ç: ${p.optPrice} —Å–æ–º –ø—Ä–∏ ${p.optQty} —à—Ç` : ''}
        </div>
        <!-- ratings removed -->
        <div class="card-actions" style="${isAdmin ? 'display:flex;gap:4px;flex-wrap:wrap;' : ''}">
          ${isAdmin ? `
            <button onclick="deleteProduct('${p.id}')" style="background:#dc3545;flex:1;padding:10px;font-size:13px;">–£–¥–∞–ª–∏—Ç—å</button>
            <button onclick="toggleProductBlock('${p.id}', ${p.blocked||false})" style="background:${p.blocked?'#ffc107':'#6c757d'};flex:1;padding:10px;font-size:13px;">${p.blocked?'–†–∞–∑–±–ª–æ–∫':'–ó–∞–±–ª–æ–∫'}</button>
          ` : `
          <input type="number" min="${p.minQty||1}" value="${p.minQty||1}" class="card-qty-input" style="text-align:center;" oninput="updateCardPrice(this, '${p.id}')" />
          <button onclick="addToCart('${p.id}','${p.title}',${p.price},'${p.image}', this)">–ö—É–ø–∏—Ç—å</button>`}
        </div>
      </div>
    `;

    container.appendChild(card);
    // –ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    try {
      const qtyInput = card.querySelector('.card-qty-input');
      if (qtyInput) updateCardPrice(qtyInput, p.id);
    } catch (e) {
      console.error('updateCardPrice init error', e);
    }
  });

}

// –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—É—é —Ü–µ–Ω—É –≤ –∫–∞—Ä—Ç–æ—á–∫–µ —Ç–æ–≤–∞—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
function updateCardPrice(inputEl, productId) {
  try {
    const qty = parseInt(inputEl.value, 10) || 1;
    const product = products.find(p => p.id === productId) || {};
    const card = inputEl.closest && inputEl.closest('.product-card');
    if (!card) return;
    const priceEl = card.querySelector('.card-price');
    let basePrice = product.price || 0;
    const optPrice = product.optPrice || null;
    const optQty = product.optQty || null;
    const optInfoEl = card.querySelector('.card-opt-info');

    if (optQty && optPrice && qty >= optQty) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø—Ç–æ–≤—É—é —Ü–µ–Ω—É –∏ –∑–∞—á–µ—Ä–∫–Ω—É—Ç—É—é —Ä–æ–∑–Ω–∏—á–Ω—É—é
      if (priceEl) priceEl.textContent = optPrice + ' —Å–æ–º';
      // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ä—É—é —Ü–µ–Ω—É —Ä—è–¥–æ–º
      let old = card.querySelector('.card-oldprice');
      if (!old) {
        const span = document.createElement('div');
        span.className = 'card-oldprice';
        span.textContent = basePrice + ' —Å–æ–º';
        span.style.marginLeft = '8px';
        span.style.fontSize = '13px';
        span.style.color = '#888';
        // –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ priceEl
        if (priceEl && priceEl.parentNode) priceEl.parentNode.appendChild(span);
      } else {
        old.textContent = basePrice + ' —Å–æ–º';
      }
      if (optInfoEl) {
        optInfoEl.textContent = `–û–ø—Ç–æ–≤–∞—è —Ü–µ–Ω–∞: ${optPrice} —Å–æ–º (–ø—Ä–∏ ${optQty} —à—Ç)`;
        optInfoEl.style.color = '#d32f2f';
        optInfoEl.style.fontWeight = '700';
      }
    } else {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é —Ü–µ–Ω—É –∏ —É–¥–∞–ª—è–µ–º oldprice –µ—Å–ª–∏ –±—ã–ª
      if (priceEl) priceEl.textContent = basePrice + ' —Å–æ–º';
      const old = card.querySelector('.card-oldprice');
      if (old && old.parentNode) old.parentNode.removeChild(old);
      if (optInfoEl) {
        if (optPrice && optQty) {
          optInfoEl.textContent = `–û–ø—Ç: ${optPrice} —Å–æ–º –ø—Ä–∏ ${optQty} —à—Ç`;
          optInfoEl.style.color = '#007bff';
          optInfoEl.style.fontWeight = 'normal';
        } else {
          optInfoEl.textContent = '';
        }
      }
    }
  } catch (err) {
    console.error('updateCardPrice error', err);
  }
}

// –ì–∞–ª–µ—Ä–µ—è-–ø—Ä–µ–≤—å—é –ø–æ —Ç–æ–≤–∞—Ä—É: —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–≤–∞–π–ø–∞—Ç—å
let _gallery = [];
let _galleryIndex = 0;
let _touchStartX = null;

function openPreviewForProduct(productId) {
  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–µ–∞–ª—å–Ω—ã–µ src –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤/–º–∏–Ω–∏-—Ñ–æ—Ç–æ —Å DOM
  const imgs = Array.from(document.querySelectorAll('#productTable img, .cart-mini-img'));
  _gallery = imgs.map(el => ({ src: el.src, title: el.alt || (el.getAttribute('data-title') || ''), el } )).filter(x => x.src);

  console.log('openPreviewForProduct -> collected images for gallery:', _gallery.map(g=>g.src));

  // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏–Ω–¥–µ–∫—Å –ø–æ productId: —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —ç–ª–µ–º–µ–Ω—Ç, —á–µ–π src —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
  const prod = products.find(p => p.id === productId);
  let idx = 0;
  if (prod && prod.image) {
    idx = _gallery.findIndex(g => g.src === prod.image);
    if (idx === -1) idx = 0;
  }
  _galleryIndex = idx;
  showGalleryIndex();

  const block = document.getElementById('previewBlock');
  block.style.display = 'block';
  document.body.classList.add('modal-open');

  const prevBtn = document.getElementById('prevPreview');
  const nextBtn = document.getElementById('nextPreview');
  if (_gallery.length <= 1) {
    // –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ç–æ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏
    if (prevBtn) prevBtn.style.display = 'none';
    if (nextBtn) nextBtn.style.display = 'none';
  } else {
    if (prevBtn) { prevBtn.style.display = ''; prevBtn.onclick = prevGallery; }
    if (nextBtn) { nextBtn.style.display = ''; nextBtn.onclick = nextGallery; }
  }

  const img = document.getElementById('previewImg');
  img.ontouchstart = function(e) { _touchStartX = e.touches[0].clientX; };
  img.ontouchend = function(e) {
    if (_touchStartX == null) return;
    const dx = (e.changedTouches[0].clientX - _touchStartX);
    _touchStartX = null;
    if (dx < -40) nextGallery();
    else if (dx > 40) prevGallery();
  };

  document.addEventListener('keydown', _galleryKeyHandler);
}

function _galleryKeyHandler(e) {
  if (e.key === 'ArrowLeft') prevGallery();
  if (e.key === 'ArrowRight') nextGallery();
  if (e.key === 'Escape') closePreview();
}

function showGalleryIndex() {
  const item = _gallery[_galleryIndex] || { src: '', title: '' };
  const img = document.getElementById('previewImg');
  img.src = item.src;
  document.getElementById('previewCaption').textContent = item.title || '';
}

function prevGallery() {
  if (_gallery.length === 0) return;
  _galleryIndex = (_galleryIndex - 1 + _gallery.length) % _gallery.length;
  showGalleryIndex();
}

function nextGallery() {
  if (_gallery.length === 0) return;
  _galleryIndex = (_galleryIndex + 1) % _gallery.length;
  showGalleryIndex();
}

function closePreview() {
  const block = document.getElementById('previewBlock');
  block.style.display = 'none';
  document.body.classList.remove('modal-open');
  try {
    document.getElementById('prevPreview').onclick = null;
    document.getElementById('nextPreview').onclick = null;
    document.getElementById('previewImg').ontouchstart = null;
    document.getElementById('previewImg').ontouchend = null;
    document.removeEventListener('keydown', _galleryKeyHandler);
  } catch (e) {}
}

// –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
document.getElementById('closePreview').onclick = function() { closePreview(); };
document.getElementById('previewBlock').onclick = function(e) {
  if (e.target === this) closePreview();
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
document.getElementById('loginAdmin').addEventListener('click', function() {
  const password = document.getElementById('adminPassword').value;
  console.log('Login attempt with password:', password);
  
  if (password === ADMIN_PASSWORD) {
    isAdmin = true;
    
    const adminAddProduct = document.getElementById('adminAddProduct');
    const adminAuth = document.getElementById('adminAuth');
    const managementHeader = document.getElementById('managementHeader');
    const adminPanel = document.getElementById('adminPanel');
    
    if (adminAddProduct) adminAddProduct.style.display = 'block';
    if (adminAuth) adminAuth.style.display = 'none';
    if (managementHeader) managementHeader.style.display = 'table-cell';
    if (adminPanel) adminPanel.style.display = '';
    
    Swal.fire('–£—Å–ø–µ—Ö!', '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', 'success');
    renderProducts();
    loadOrderHistory();
  } else {
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
  }
});

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
async function deleteProduct(productId) {
  try {
    const result = await Swal.fire({
      title: '–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?',
      text: "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å!',
      cancelButtonText: '–û—Ç–º–µ–Ω–∞'
    });

    if (result.isConfirmed) {
      await db.collection('products').doc(productId).delete();
      Swal.fire('–£–¥–∞–ª–µ–Ω–æ!', '–¢–æ–≤–∞—Ä –±—ã–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.', 'success');
      loadProducts();
    }
  } catch (error) {
    console.error('Error deleting product:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤
const moveModal = document.createElement('div');
moveModal.id = 'moveModal';
moveModal.style.cssText = `
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
`;
moveModal.innerHTML = `
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;">
    <h3>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
    <div style="margin-bottom: 15px;">
      <p>–¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è: <span id="currentPosition">1</span></p>
      <label>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∞ –ø–æ–∑–∏—Ü–∏—é:</label>
      <input type="number" id="moveSteps" value="1" min="1" style="width: 100%; margin-top: 5px;">
    </div>
    <div style="display: flex; justify-content: space-between;">
      <button onclick="closeMoveModal()" style="background: #6c757d;">–û—Ç–º–µ–Ω–∞</button>
      <button onclick="moveProductMultiple()" style="background: #28a745;">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å</button>
    </div>
  </div>
`;
document.body.appendChild(moveModal);

let currentMoveProductId = null;
let currentMoveDirection = null;

function showMoveModal(productId, direction) {
  currentMoveProductId = productId;
  currentMoveDirection = direction;
  const product = products.find(p => p.id === productId);
  const currentIndex = products.findIndex(p => p.id === productId);
  document.getElementById('currentPosition').textContent = currentIndex + 1;
  document.getElementById('moveSteps').value = currentIndex + 1;
  moveModal.style.display = 'block';
}

async function moveProductMultiple() {
  if (!currentMoveProductId) return;
  
  try {
    const targetPosition = parseInt(document.getElementById('moveSteps').value) || 1;
    const product = products.find(p => p.id === currentMoveProductId);
    const currentIndex = products.findIndex(p => p.id === currentMoveProductId);
    
    if (!product || currentIndex === -1) return;
    
    const newIndex = Math.max(0, Math.min(products.length - 1, targetPosition - 1));
    
    if (currentIndex === newIndex) {
      closeMoveModal();
      return;
    }
    
    const newProducts = [...products];
    const [movedProduct] = newProducts.splice(currentIndex, 1);
    newProducts.splice(newIndex, 0, movedProduct);
    
    const batch = db.batch();
    newProducts.forEach((p, index) => {
      const productRef = db.collection('products').doc(p.id);
      batch.update(productRef, { order: index });
    });
    
    await batch.commit();
    products = newProducts;
    renderProducts();
    closeMoveModal();
    Swal.fire('–£—Å–ø–µ—Ö!', '–¢–æ–≤–∞—Ä –ø–µ—Ä–µ–º–µ—â–µ–Ω', 'success');
  } catch (error) {
    console.error('Error moving product:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
    closeMoveModal();
  }
}

function closeMoveModal() {
  moveModal.style.display = 'none';
  currentMoveProductId = null;
  currentMoveDirection = null;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø—Ç–æ–≤—ã—Ö —Ü–µ–Ω
const editWholesaleModal = document.createElement('div');
editWholesaleModal.id = 'editWholesaleModal';
editWholesaleModal.style.cssText = `
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
`;
editWholesaleModal.innerHTML = `
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–æ–≤—ã—Ö —Ü–µ–Ω</h3>
    <div style="margin-bottom: 15px;">
      <label>–û–ø—Ç–æ–≤–∞—è —Ü–µ–Ω–∞:</label>
      <input type="number" id="editOptPrice" style="width: 100%; margin-top: 5px;">
    </div>
    <div style="margin-bottom: 15px;">
      <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –æ–ø—Ç–∞:</label>
      <input type="number" id="editOptQty" style="width: 100%; margin-top: 5px;">
    </div>
    <div style="display: flex; justify-content: space-between;">
      <button onclick="closeEditWholesaleModal()" style="background: #6c757d;">–û—Ç–º–µ–Ω–∞</button>
      <button onclick="saveWholesaleChanges()" style="background: #28a745;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
`;
document.body.appendChild(editWholesaleModal);

let currentEditingProductId = null;

function showEditWholesaleModal(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;
  
  currentEditingProductId = productId;
  document.getElementById('editOptPrice').value = product.optPrice || '';
  document.getElementById('editOptQty').value = product.optQty || '';
  editWholesaleModal.style.display = 'block';
}

function closeEditWholesaleModal() {
  editWholesaleModal.style.display = 'none';
  currentEditingProductId = null;
}

async function saveWholesaleChanges() {
  if (!currentEditingProductId) return;
  
  try {
    const optPrice = document.getElementById('editOptPrice').value;
    const optQty = document.getElementById('editOptQty').value;
    
    await db.collection('products').doc(currentEditingProductId).update({
      optPrice: optPrice ? Number(optPrice) : null,
      optQty: optQty ? Number(optQty) : null
    });
    
    Swal.fire('–£—Å–ø–µ—Ö!', '–û–ø—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
    closeEditWholesaleModal();
    loadProducts();
  } catch (error) {
    console.error('Error updating wholesale prices:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã', 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞
async function updateProductPrice(productId, field, value) {
  try {
    const updateData = {};
    updateData[field] = Number(value);
    
    await db.collection('products').doc(productId).update(updateData);
    Swal.fire('–£—Å–ø–µ—Ö!', '–¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
    loadProducts();
  } catch (error) {
    console.error('Error updating product price:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É', 'error');
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
editWholesaleModal.onclick = function(e) {
  if (e.target === this) {
    closeEditWholesaleModal();
  }
};

  

// –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
async function updateProductTitle(productId, newTitle) {
  try {
    await db.collection('products').doc(productId).update({ title: newTitle });
    Swal.fire('–£—Å–ø–µ—Ö!', '–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
    loadProducts();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
  }
}

// –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä
async function toggleProductBlock(productId, currentStatus) {
  try {
    await db.collection('products').doc(productId).update({ blocked: !currentStatus });
    Swal.fire('–£—Å–ø–µ—Ö!', !currentStatus ? '–¢–æ–≤–∞—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–¢–æ–≤–∞—Ä —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'success');
    loadProducts();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏', 'error');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
async function massUpdateCategories() {
  if (!isAdmin) {
    Swal.fire('–û—à–∏–±–∫–∞', '–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'error');
    return;
  }
  
  const { value: action } = await Swal.fire({
    title: '–ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π',
    html: `
      <select id="massCategory" class="swal2-input">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</option>
        <option value="scotch_keywords">–°–∫–æ—Ç—á (–ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º)</option>
        <option value="knife_keywords">–ù–æ–∂ (–ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º)</option>
        <option value="all_scotch">–í—Å–µ —Ç–æ–≤–∞—Ä—ã ‚Üí –°–∫–æ—Ç—á</option>
        <option value="all_knife">–í—Å–µ —Ç–æ–≤–∞—Ä—ã ‚Üí –ù–æ–∂</option>
        <option value="all_scissors">–í—Å–µ —Ç–æ–≤–∞—Ä—ã ‚Üí –ù–æ–∂–Ω–∏—Ü—ã</option>
      </select>
    `,
    showCancelButton: true,
    confirmButtonText: '–í—ã–ø–æ–ª–Ω–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞',
    preConfirm: () => {
      return document.getElementById('massCategory').value;
    }
  });
  
  if (!action) return;
  
  try {
    let updated = 0;
    const batch = db.batch();
    
    for (const product of products) {
      const productRef = db.collection('products').doc(product.id);
      let shouldUpdate = false;
      let newCategory = '';
      
      if (action === 'scotch_keywords') {
        const keywords = ['—Å–∫–æ—Ç—á', '–ª–µ–Ω—Ç–∞', 'tape', '–∫–ª–µ–π–∫–∞—è'];
        if (keywords.some(kw => (product.title || '').toLowerCase().includes(kw))) {
          newCategory = '—Å–∫–æ—Ç—á';
          shouldUpdate = true;
        }
      } else if (action === 'knife_keywords') {
        const keywords = ['–Ω–æ–∂', 'knife', '–ª–µ–∑–≤–∏–µ'];
        if (keywords.some(kw => (product.title || '').toLowerCase().includes(kw))) {
          newCategory = '–Ω–æ–∂';
          shouldUpdate = true;
        }
      } else if (action === 'all_scotch') {
        newCategory = '—Å–∫–æ—Ç—á';
        shouldUpdate = true;
      } else if (action === 'all_knife') {
        newCategory = '–Ω–æ–∂';
        shouldUpdate = true;
      } else if (action === 'all_scissors') {
        newCategory = '–Ω–æ–∂–Ω–∏—Ü—ã';
        shouldUpdate = true;
      }
      
      if (shouldUpdate) {
        batch.update(productRef, { category: newCategory });
        updated++;
      }
    }
    
    if (updated > 0) {
      await batch.commit();
      await loadProducts();
      Swal.fire('–£—Å–ø–µ—Ö!', `–û–±–Ω–æ–≤–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${updated}`, 'success');
    } else {
      Swal.fire('–ò–Ω—Ñ–æ', '–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'info');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã', 'error');
  }
}

</script>

<!-- –ö–Ω–æ–ø–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ -->
  <div class="scroll-buttons" style="position:fixed;right:20px;bottom:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;">
    <button id="scrollTopBtn" style="background:#007bff;color:#fff;border:none;padding:10px 14px;border-radius:12px;box-shadow:0 2px 8px #0001;cursor:pointer;font-size:18px;">‚ñ≤</button>
    <button id="scrollBottomBtn" style="background:#007bff;color:#fff;border:none;padding:10px 14px;border-radius:12px;box-shadow:0 2px 8px #0001;cursor:pointer;font-size:18px;">‚ñº</button>
  </div>

  <footer id="siteFooter" style="background: #003366; color: #fff; padding:14px 10px; text-align:center; margin-top:18px;">
    <div style="max-width:1200px; margin:0 auto; font-weight:700;">
      –û –Ω–∞—Å: –º—ã –ø–µ—Ä–≤—ã–π —Ä—É–∫ –∏–∑ –∫–∏—Ç–∞—è ‚Äî —É –Ω–∞—Å –Ω–∏–∑–∫–∏–µ —Ü–µ–Ω—ã
    </div>
  </footer>

</body>
<script>
// --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ ---
function toggleAdminPanel() {
  const panel = document.getElementById('adminPanel');
  if (panel.classList.contains('admin-panel-hidden')) {
    panel.classList.remove('admin-panel-hidden');
    document.getElementById('hideAdminPanelBtn').textContent = '–°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å';
  } else {
    panel.classList.add('admin-panel-hidden');
    document.getElementById('hideAdminPanelBtn').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å';
  }
}
// –°–º–µ–Ω–∞ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –∞–¥–º–∏–Ω–æ–º
// –ö–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã: –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∫–æ—Ä–∑–∏–Ω–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
const cartFloatBtn = document.getElementById('cartFloatBtn');
const cartFloatCount = document.getElementById('cartFloatCount');
const orderForm = document.querySelector('.order-form');

if (cartFloatBtn) {
  cartFloatBtn.onclick = function() {
    if (orderForm) {
      orderForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };
}

function updateCartFloatCount() {
  if (cartFloatCount) {
    cartFloatCount.textContent = cart.length;
  }
}

// –í—ã–∑–æ–≤–µ–º –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã
const origUpdateCart = updateCart;
updateCart = function() {
  origUpdateCart.apply(this, arguments);
  updateCartFloatCount();
};
document.addEventListener('DOMContentLoaded', updateCartFloatCount);
// –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–Ω–æ–ø–æ–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑
document.getElementById('scrollTopBtn').onclick = function() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
};
document.getElementById('scrollBottomBtn').onclick = function() {
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
};
</script>
</html>
</body>
</html>
