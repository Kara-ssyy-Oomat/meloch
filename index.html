<!DOCTYPE html>

<html lang="ru" style="overflow-y: scroll !important; touch-action: pan-y !important;">

<head>
  <script>
    // Если index.html загружен внутри iframe - выйти из iframe
    if (window.parent !== window) {
      window.parent.postMessage('closeIframe', '*');
      window.stop(); // Остановить загрузку
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <meta name="description" content="Хозтовары и мелочи оптом в Кара-Суу. Доставка, низкие цены.">
  <meta name="google-site-verification" content="KwaNctZFk2BMTScsvlO77JIV6KN4daZPJXP9XRcin9Q" />
  
  <!-- PWA и мобильное приложение -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Кербен">
  <meta name="theme-color" content="#4CAF50">
  
  <!-- Иконки для iOS (iPhone/iPad) -->
  <link rel="apple-touch-icon" href="icon-kerben.jpg">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-kerben.jpg">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-kerben.jpg">
  <link rel="apple-touch-icon" sizes="120x120" href="icon-kerben.jpg">
  
  <!-- Favicon с логотипом Кербен -->
  <link rel="icon" type="image/jpeg" href="icon-kerben.jpg">
  <title>Кербен - B2B Market</title>

  <!-- Стили -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/index-page.css">

  <!-- Предзагрузка DNS для быстрого доступа к Firebase и CDN -->
  <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://wsrv.nl">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

  <!-- Firebase SDKs: критичные для отображения товаров -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- SweetAlert2 — нужен сразу для UI -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!--
    ОПТИМИЗАЦИЯ: jsPDF, XLSX, EXIF, Chart.js — загружаются ЛЕНИВО только для админа.
    Это экономит ~800 КБ трафика для обычных покупателей.
    Библиотеки загружаются через loadAdminLibraries() при входе в админ-режим.
  -->
  <script>
    // Ленивая загрузка тяжёлых библиотек (только для админа)
    let _adminLibsLoaded = false;
    let _adminLibsLoading = false;
    function loadAdminLibraries() {
      if (_adminLibsLoaded || _adminLibsLoading) return Promise.resolve();
      _adminLibsLoading = true;
      const libs = [
        'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js',
        'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'
      ];
      return Promise.all(libs.map(src => {
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = src;
          s.onload = resolve;
          s.onerror = () => { console.warn('Failed to load:', src); resolve(); };
          document.head.appendChild(s);
        });
      })).then(() => {
        _adminLibsLoaded = true;
        _adminLibsLoading = false;
        console.log('📚 Админ-библиотеки загружены');
      });
    }
  </script>

  <script>
    // КРИТИЧНО: Принудительно разблокируем прокрутку при загрузке
  // Добавить в конец скрипта (после загрузки страницы)

// Проверяем, есть ли функция для вызова после загрузки (из страницы профиля)
document.addEventListener('DOMContentLoaded', function() {
  const funcToCall = localStorage.getItem('callAfterLoad');
  if (funcToCall) {
    localStorage.removeItem('callAfterLoad');
    // Даём время на инициализацию
    setTimeout(() => {
      if (typeof window[funcToCall] === 'function') {
        window[funcToCall]();
      }
    }, 500);
  }
});
  </script>

</head>

<body style="overflow-y: scroll !important; position: static !important; height: auto !important; touch-action: pan-y !important;">

  <!-- Блок для просмотра фото -->
  <div id="previewBlock" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:9800; pointer-events:auto; background: rgba(0,0,0,0.85);">
    <div id="previewInner" style="position:relative; background:white; padding:12px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5); max-width:95vw; max-height:95vh; display:flex; flex-direction:column; align-items:center;">
      <span id="closePreview" style="position:absolute; top:8px; right:8px; cursor:pointer; font-size:28px; background:#eee; width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:50%; z-index:10;">&times;</span>
      <div style="text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%;">
        <img id="previewImg" src="" alt="Просмотр" referrerpolicy="no-referrer" style="max-width:90vw; max-height:80vh; display:block; object-fit:contain;">
        <div id="previewCaption" style="margin-top:12px;  color:#333; font-weight:500;"></div>
      </div>
    </div>
  </div>

  <!-- Модальное окно редактирования товара -->
  <div id="editProductModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; width:100%; height:100%; z-index:9000; background:rgba(0,0,0,0.7); overflow-y:auto; overscroll-behavior:contain; -webkit-overflow-scrolling:touch;">
    <div style="max-width:500px; margin:20px auto; background:white; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.3); overflow:hidden;">
      <!-- Шапка -->
      <div style="background:linear-gradient(135deg,#007bff,#0056b3); color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:10;">
        <h3 style="margin:0; font-size:18px;">✏️ Редактирование товара</h3>
        <button onclick="closeEditProductModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; width:36px; height:36px; border-radius:50%; cursor:pointer; font-size:20px;">✕</button>
      </div>
      <!-- Содержимое -->
      <div id="editProductContent" style="padding:20px;"></div>
    </div>
  </div>

  <!-- Модальное окно жалобы -->
  <div id="complaintWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:44px; background:#f5f5f5; z-index:9500;">
    <div style="height:100%; display:flex; flex-direction:column;">
      
      <!-- Шапка -->
      <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <div style="font-size:17px; font-weight:600; color:#333;">Жалоба</div>
        <button onclick="closeComplaintWindow()" style="background:none; border:none; color:#666; font-size:24px; cursor:pointer;">✕</button>
      </div>

      <!-- Форма -->
      <div style="flex:1; overflow-y:auto; padding:20px; background:#fff;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Ваше имя:</label>
            <input type="text" id="complaintName" placeholder="Введите ваше имя" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Телефон:</label>
            <input type="tel" id="complaintPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Тема жалобы:</label>
            <select id="complaintCategory" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
              <option value="">Выберите категорию</option>
              <option value="quality">Качество товара</option>
              <option value="delivery">Проблемы с доставкой</option>
              <option value="service">Обслуживание</option>
              <option value="price">Неверная цена</option>
              <option value="other">Другое</option>
            </select>
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Описание проблемы:</label>
            <textarea id="complaintText" placeholder="Подробно опишите вашу проблему..." style="width:100%; min-height:120px; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box; resize:vertical;"></textarea>
          </div>
        </div>
      </div>

      <!-- Кнопка отправки -->
      <div style="padding:15px 20px; background:#fff; border-top:1px solid #e0e0e0; flex-shrink:0;">
        <button onclick="sendComplaint()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:15px;">Отправить жалобу</button>
      </div>
    </div>
  </div>

  <!-- Окно предложения товара -->
  <div id="suggestionWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:44px; background:#f5f5f5; z-index:9500;">
    <div style="height:100%; display:flex; flex-direction:column; position:relative;">
      <!-- Заголовок -->
      <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <div style="font-size:17px; font-weight:600; color:#333;">Предложить товар</div>
        <button onclick="closeSuggestionWindow()" style="background:none; border:none; color:#666; font-size:24px; cursor:pointer;">✕</button>
      </div>

      <!-- Форма -->
      <div style="flex:1; overflow-y:auto; padding:20px; background:#fff;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Ваше имя:</label>
            <input type="text" id="suggestionName" placeholder="Введите ваше имя" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Телефон:</label>
            <input type="tel" id="suggestionPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Название товара:</label>
            <input type="text" id="suggestionProductName" placeholder="Какой товар вы хотите видеть?" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">За сколько сейчас покупаете:</label>
            <input type="number" id="suggestionCurrentPrice" placeholder="Текущая цена у другого продавца" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Желаемая цена:</label>
            <input type="number" id="suggestionPrice" placeholder="За сколько вы готовы купить?" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Описание:</label>
            <textarea id="suggestionDescription" placeholder="Опишите подробности..." style="width:100%; min-height:100px; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box; resize:vertical;"></textarea>
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Фото товара (необязательно):</label>
            <input type="file" id="suggestionPhoto" accept="image/*" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box; background:white;">
          </div>
        </div>
      </div>

      <!-- Кнопка отправки -->
      <div style="padding:15px 20px; background:#fff; border-top:1px solid #e0e0e0; flex-shrink:0;">
        <button id="suggestionSubmitBtn" onclick="sendSuggestion()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:15px;">Отправить предложение</button>
      </div>
      
      <!-- Индикатор загрузки -->
      <div id="suggestionLoader" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:10; justify-content:center; align-items:center; flex-direction:column;">
        <div style="width:50px; height:50px; border:5px solid #e0e0e0; border-top:5px solid #333; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:20px; color:#333; font-size:16px; font-weight:600;">Отправка...</p>
      </div>
    </div>
  </div>

  <!-- Окно "Стать продавцом" -->
  <div id="becomeSellerWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:44px; background:#f5f5f5; z-index:9500;">
    <div style="height:100%; display:flex; flex-direction:column; position:relative;">
      <!-- Заголовок -->
      <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <div style="font-size:17px; font-weight:600; color:#333;">Стать продавцом</div>
        <button onclick="closeBecomeSellerWindow()" style="background:none; border:none; color:#666; font-size:24px; cursor:pointer;">✕</button>
      </div>

      <!-- Переключатель вкладок -->
      <div style="display:flex; border-bottom:1px solid #e0e0e0; background:#fff; flex-shrink:0;">
        <button id="sellerTabRegister" onclick="switchSellerTab('register')" style="flex:1; padding:12px; background:#333; color:white; border:none; cursor:pointer; font-weight:600;">Регистрация</button>
        <button id="sellerTabLogin" onclick="switchSellerTab('login')" style="flex:1; padding:12px; background:#f5f5f5; color:#333; border:none; cursor:pointer; font-weight:600;">Вход</button>
      </div>

      <!-- Форма регистрации -->
      <div id="sellerRegisterForm" style="flex:1; overflow-y:auto; padding:20px; background:#fff;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">ФИО / Название компании:</label>
            <input type="text" id="sellerName" placeholder="Введите ваше имя или название компании" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Телефон (для входа):</label>
            <input type="tel" id="sellerPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Пароль:</label>
            <input type="password" id="sellerPassword" placeholder="Придумайте пароль (мин. 4 символа)" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Город/Регион:</label>
            <input type="text" id="sellerCity" placeholder="Например: Бишкек, Ош" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Какие товары хотите продавать:</label>
            <input type="text" id="sellerProducts" placeholder="Категории товаров" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Telegram ID:</label>
            <input type="text" id="sellerTelegramId" placeholder="Например: 123456789" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
            <p style="margin:5px 0 0; font-size:11px; color:#888;">Узнайте ID у @userinfobot в Telegram</p>
          </div>
        </div>
        
        <!-- Кнопка регистрации -->
        <div style="margin-top:20px;">
          <button id="sellerSubmitBtn" onclick="registerSeller()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:15px;">Зарегистрироваться</button>
        </div>
      </div>

      <!-- Форма входа -->
      <div id="sellerLoginForm" style="display:none; flex:1; overflow-y:auto; padding:20px; background:#fff;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Телефон:</label>
            <input type="tel" id="sellerLoginPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Пароль:</label>
            <input type="password" id="sellerLoginPassword" placeholder="Введите пароль" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px; box-sizing:border-box;" onkeypress="if(event.key==='Enter') loginSeller()">
          </div>
        </div>
        
        <!-- Кнопка входа -->
        <div style="margin-top:20px;">
          <button onclick="loginSeller()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:15px;">Войти</button>
        </div>
      </div>
      
      <!-- Индикатор загрузки -->
      <div id="sellerLoader" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:10; justify-content:center; align-items:center; flex-direction:column;">
        <div style="width:50px; height:50px; border:5px solid #e0e0e0; border-top:5px solid #333; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:20px; color:#333; font-size:16px; font-weight:600;">Загрузка...</p>
      </div>
    </div>
  </div>

  <!-- Название сайта -->
  <div style="text-align:center; margin:20px 0 10px;">
    <h1 style="font-size:2.5rem; color:#007bff; margin:0; font-weight:900; text-shadow:2px 2px 4px rgba(0,0,0,0.1);">B2B Market</h1>
    <p style="font-size:0.9rem; color:#666; margin:5px 0 0;">Оптовые товары по выгодным ценам</p>
  </div>

  <!-- Кнопка установки PWA приложения -->
  <div id="installPwaContainer" style="display:none; padding:10px; background:linear-gradient(135deg, #667eea, #764ba2); margin:0 10px 10px; border-radius:12px; box-shadow:0 4px 15px rgba(102,126,234,0.3);">
    <div style="display:flex; align-items:center; justify-content:space-between; color:white;">
      <div style="flex:1;">
        <div style="font-size:16px; font-weight:700; margin-bottom:4px;">📱 Установить приложение Кербен</div>
        <div style="font-size:13px; opacity:0.9;">Быстрый доступ с главного экрана</div>
      </div>
      <button id="installPwaBtn" style="background:white; color:#667eea; border:none; padding:10px 20px; border-radius:8px; font-weight:700; cursor:pointer; font-size:14px; margin-left:10px;">Установить</button>
      <button onclick="document.getElementById('installPwaContainer').style.display='none'" style="background:rgba(255,255,255,0.2); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer; margin-left:8px; font-size:18px;">×</button>
    </div>
  </div>

  <!-- Верхний промо-слайдер: две рекламные карточки (swipe) -->
  <!-- Категории товаров -->
  <div class="category-tabs">
    <button class="category-btn active" onclick="filterByCategory('все')" data-category="все">Все товары</button>
    <button class="category-btn" onclick="toggleOtherCategories()" id="otherCategoriesBtn" style="background:linear-gradient(90deg, #6c757d, #495057);">📂 Другие категории ▼</button>
    <div id="otherCategoriesContainer">
      <button class="category-btn" onclick="filterByCategory('ножницы')" data-category="ножницы">✂️ Ножницы</button>
      <button class="category-btn" onclick="filterByCategory('скотч')" data-category="скотч">Скотч</button>
      <button class="category-btn" onclick="filterByCategory('нож')" data-category="нож">🔪 Нож</button>
      <button class="category-btn" onclick="filterByCategory('корейские')" data-category="корейские">Корейские товары</button>
      <button class="category-btn" onclick="filterByCategory('часы')" data-category="часы">⌚ Часы</button>
      <button class="category-btn" onclick="filterByCategory('электроника')" data-category="электроника">🔌 Электроника</button>
      <button class="category-btn" onclick="filterByCategory('бытовые')" data-category="бытовые">Бытовые техники</button>
      <!-- Категории продавцов будут добавлены сюда динамически -->
      <div id="sellerCategoriesContainer" style="display:contents;"></div>
    </div>
  </div>

  <!-- Кнопка редактора (скрыта по умолчанию, видна только админу) -->
  <div id="editorBtnContainer" style="display:none; justify-content:center; padding:8px 10px 0;">
    <button id="editorModeBtn" onclick="toggleEditorMode()" style="padding:10px 20px; background:linear-gradient(135deg,#6c757d,#495057); color:white; border:none; border-radius:20px; cursor:pointer; font-size:14px; font-weight:600; display:flex; align-items:center; gap:6px;">
      ✏️ Редактор
    </button>
  </div>

  <!-- Расширенный поиск с фильтрами -->
  <div class="search-container">
    <div class="search-main" style="flex-wrap: wrap;">
      <button class="search-btn" onclick="applyFilters()">🔍 Найти</button>
      <button class="filter-toggle-btn" id="filterToggleBtn" onclick="toggleFilters()">⚙️ Фильтры</button>
      <button id="voiceSearchBtn" class="voice-search-btn" onclick="startVoiceSearch()" title="Голосовой поиск">🎤</button>
      <input type="text" id="search" placeholder="🔍 Поиск товара..." oninput="scheduleRenderProducts()" autocomplete="off" style="width: 100%; order: 10; margin-top: 8px;" />
    </div>
    
    <div class="search-filters" id="searchFilters">
      <div class="filter-row">
        <div class="filter-group">
          <label>💰 Цена</label>
          <div class="price-range">
            <input type="number" id="priceMin" placeholder="От" min="0" />
            <span>—</span>
            <input type="number" id="priceMax" placeholder="До" min="0" />
          </div>
        </div>
        
        <div class="filter-group">
          <label>📦 Наличие</label>
          <select id="stockFilter">
            <option value="all">Все товары</option>
            <option value="instock">В наличии</option>
            <option value="outofstock">Нет в наличии</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>📊 Сортировка</label>
          <select id="sort">
            <option value="">По умолчанию</option>
            <option value="asc">Сначала дешёвые</option>
            <option value="desc">Сначала дорогие</option>
            <option value="name_asc">По названию А-Я</option>
            <option value="name_desc">По названию Я-А</option>
            <option value="new">Сначала новые</option>
          </select>
        </div>
        
        <div class="filter-actions">
          <button class="filter-apply-btn" onclick="applyFilters()">✅ Применить</button>
          <button class="filter-reset-btn" onclick="resetFilters()">🔄 Сбросить</button>
        </div>
      </div>
      
      <div class="search-tags" id="activeTags"></div>
    </div>
    
    <div class="search-results-info" id="searchResultsInfo" style="display:none;">
      <span id="resultsText">Найдено: 0 товаров</span>
      <span class="clear-search" onclick="resetFilters()">✖ Очистить поиск</span>
    </div>
  </div>



  <!-- Сетка карточек товаров -->
  <div id="productTable" class="product-grid"></div>



  <div class="order-form">

    <h2>Оформить заказ</h2>

    <div id="cartList"></div>

    <div class="cart-summary">Итого: <span id="totalSum">0</span> сом</div>

    <!-- Кнопка открытия панели корзины перенесена вниз перед очисткой корзины -->
    <div style="display:flex;gap:8px;">
      <button id="openCartBtn" onclick="openCartPage()">Открыть корзину</button>
      <!-- Кнопка очистки корзины будет в панели корзины -->
    </div>

    <input type="text" id="name" placeholder="Ваше имя" required />

    <input type="tel" id="phone" placeholder="Телефон" required />

    <input type="text" id="address" placeholder="Адрес доставки" required />
    
    <input type="text" id="driverName" placeholder="Имя водителя (необязательно)" style="background:#f8f9fa; border:2px solid #e9ecef;" />
    
    <input type="tel" id="driverPhone" placeholder="Номер водителя (необязательно)" style="background:#f8f9fa; border:2px solid #e9ecef;" />
    
    <input type="text" id="referredBy" placeholder="Кто вам порекомендовал? (необязательно)" style="background:#f8f9fa; border:2px solid #e9ecef;" />

    <button id="submitOrder">Отправить заказ</button>
    
    <button type="button" onclick="openTrackOrderModal()" style="width:100%; padding:14px; margin-top:10px; background:linear-gradient(135deg, #17a2b8 0%, #138496 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600; display:flex; align-items:center; justify-content:center; gap:10px;">
      📦 Отслеживать мой заказ
    </button>

  </div>

  <button id="logoutUser" style="margin:10px 0;">Выйти из профиля</button>

  <div id="adminProductsBlock"></div>

      

  <!-- Окно заказов от партнеров -->
  <div id="partnersOrdersWindow" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:rgba(0,0,0,0.6); z-index:9650;">
    <div style="background:#fff; width:95%; max-width:1200px; height:90vh; margin:3vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      
      <!-- Шапка -->
      <div style="background:linear-gradient(90deg, #4facfe, #00f2fe); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">🤝 Заказы от партнеров</h2>
          <p style="margin:5px 0 0; opacity:0.9; ">Статистика и список заказов по партнерам</p>
        </div>
        <button onclick="closePartnersOrdersWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Фильтры -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <select id="partnersFilterDate" onchange="loadPartnersOrders()" style="padding:10px; border:1px solid #ddd; border-radius:6px; ">
          <option value="all">Все время</option>
          <option value="today">Сегодня</option>
          <option value="week">За неделю</option>
          <option value="month">За месяц</option>
        </select>
        
        <select id="partnersFilterPartner" onchange="loadPartnersOrders()" style="padding:10px; border:1px solid #ddd; border-radius:6px; ">
          <option value="all">Все партнеры</option>
        </select>
        
        <button onclick="loadPartnersOrders()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">🔄 Обновить</button>
        <button onclick="exportPartnersToExcel()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">📊 Экспорт в Excel</button>
      </div>

      <!-- Статистика партнеров -->
      <div id="partnersStats" style="padding:15px; background:#fff; border-bottom:2px solid #e0e0e0;">
        <div style="text-align:center; color:#999;">Загрузка статистики...</div>
      </div>

      <!-- Список заказов -->
      <div id="partnersOrdersList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка заказов...</div>
      </div>
    </div>
  </div>

  <!-- Отдельная панель корзины -->
  <div id="cartPage" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:#f5f5f5; z-index:9500;">
    <div style="height:100%; display:flex; flex-direction:column;">
      <!-- Заголовок корзины -->
      <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <button onclick="closeCartPage()" style="background:none; border:none; font-size:24px; cursor:pointer; padding:0; margin-right:10px;">←</button>
        <div style="font-size:17px; font-weight:600; color:#333; flex:1;">Корзина</div>
        <button onclick="clearCart()" style="background:none; border:none; color:#f44336; font-size:13px; cursor:pointer;">Очистить</button>
      </div>
      
      <!-- Список товаров -->
      <div id="cartPageList" style="flex:1; overflow-y:auto; padding:0; background:#fff;"></div>
      
      <!-- Пустая корзина -->
      <div id="cartEmptyMessage" style="display:none; text-align:center; padding:60px 20px; color:#999; background:#fff; flex:1;">
        <div style="font-size:48px; margin-bottom:15px;">🛒</div>
        <div style="font-size:16px;">Корзина пуста</div>
      </div>
      
      <!-- Нижняя панель с итогом -->
      <div id="cartPageFooter" style="background:#fff; border-top:1px solid #e0e0e0; padding:15px 20px; flex-shrink:0;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <div style="font-size:14px; color:#666;">Итого:</div>
          <div style="font-size:20px; font-weight:600; color:#333;" id="cartPageTotal">0 сом</div>
        </div>
        <div id="cartPageSummary" style="font-size:12px; color:#888; margin-bottom:12px;"></div>
        <button onclick="(function(){ closeCartPage(); document.querySelector('.order-form').scrollIntoView({behavior:'smooth'}); })()" style="width:100%; background:#333; color:white; border:none; padding:15px; border-radius:8px; font-size:15px; font-weight:600; cursor:pointer;">Оформить заказ</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно избранных товаров -->
  <div id="favoritesPage" style="display:none; position:fixed; top:0; left:0; right:0; bottom:56px; background:#f5f5f5; z-index:9500;">
    <div style="height:100%; display:flex; flex-direction:column;">
      <!-- Заголовок избранного -->
      <div style="background:#fff; padding:15px 20px; border-bottom:1px solid #e0e0e0; display:flex; align-items:center; flex-shrink:0;">
        <button onclick="closeFavoritesPage()" style="background:none; border:none; font-size:24px; cursor:pointer; padding:0; margin-right:10px;">←</button>
        <div style="font-size:17px; font-weight:600; color:#333; flex:1;">❤️ Избранное</div>
        <button onclick="clearFavorites()" style="background:none; border:none; color:#f44336; font-size:13px; cursor:pointer;">Очистить</button>
      </div>
      
      <!-- Список избранных товаров -->
      <div id="favoritesPageItems" style="flex:1; overflow-y:auto; padding:0; background:#fff;">
        <!-- Товары будут добавлены через JS -->
      </div>
      
      <!-- Пустое избранное -->
      <div id="favoritesEmptyMessage" style="display:none; text-align:center; padding:60px 20px; color:#999; background:#fff; flex:1;">
        <div style="font-size:48px; margin-bottom:15px;">❤️</div>
        <div style="font-size:16px;">Избранное пусто</div>
      </div>
      
      <!-- Нижняя панель -->
      <div id="favoritesPageFooter" style="background:#fff; border-top:1px solid #e0e0e0; padding:15px 20px; flex-shrink:0;">
        <div id="favoritesPageSummary" style="font-size:12px; color:#888; margin-bottom:12px;"></div>
        <button onclick="addAllFavoritesToCart()" style="width:100%; background:#333; color:white; border:none; padding:15px; border-radius:8px; font-size:15px; font-weight:600; cursor:pointer;">Добавить все в корзину</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно отслеживания заказа для клиента -->
  <div id="trackOrderModal" onclick="if(event.target === this) closeTrackOrderModal();" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:8000; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:600px; max-height:90vh; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <!-- Заголовок -->
      <div style="background:linear-gradient(135deg, #17a2b8 0%, #138496 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:22px;">📦 Отслеживание заказа</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">Введите ваш номер телефона</p>
        </div>
        <button onclick="closeTrackOrderModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:45px; height:45px; border-radius:50%; cursor:pointer;">&times;</button>
      </div>
      
      <!-- Поиск по телефону -->
      <div style="padding:20px; border-bottom:1px solid #e0e0e0;">
        <div style="display:flex; gap:10px;">
          <input type="tel" id="trackPhoneInput" placeholder="Ваш номер телефона" style="flex:3; min-width:0; padding:14px; border:2px solid #17a2b8; border-radius:10px; font-size:16px;">
          <button onclick="searchMyOrders()" style="flex:1; max-width:100px; padding:14px 10px; background:linear-gradient(135deg, #17a2b8, #138496); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px; white-space:nowrap;">🔍 Найти</button>
        </div>
      </div>
      
      <!-- Список заказов клиента -->
      <div id="trackOrdersList" style="flex:1; overflow-y:auto; padding:20px; min-height:200px;">
        <div style="text-align:center; color:#999; padding:40px;">
          <div style="font-size:48px; margin-bottom:15px;">📱</div>
          <div>Введите номер телефона, указанный при заказе</div>
        </div>
      </div>
    </div>
  </div>


  <!-- Глобальные переменные приложения -->
  <script>
    let searchFiltersActive = false;
    let lastSearchResults = 0;
    let _renderProductsTimer = null;
    let _renderProductsPending = false;
    let products = [];
    let isAdmin = false;
    let isEditorMode = false;
    let cachedSellerCategories = [];
    let boxPurchaseMode = false;
    let productsReady = false;
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const productTable = document.getElementById('productTable');
    const search = document.getElementById('search');
    const sort = document.getElementById('sort');
    const cartList = document.getElementById('cartList');
    const totalSum = document.getElementById('totalSum');
  </script>

<!-- Кнопки прокрутки вверх/вниз -->
<button id="scrollTopBtn" class="scroll-nav-btn" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 15l-6-6-6 6"/></svg>
</button>
<button id="scrollBottomBtn" class="scroll-nav-btn" onclick="window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
</button>

  <footer id="siteFooter" style="background: #003366; color: #fff; padding:14px 10px; text-align:center; margin-top:18px;">
    <div style="max-width:1200px; margin:0 auto; font-weight:700;">
      О нас: мы первый рук из китая — у нас низкие цены
    </div>
  </footer>



  <!-- КРИТИЧНЫЕ модули: загружаем сразу (нужны для отображения товаров) -->
  <script src="js/firebase-config.js"></script>
  <script src="js/image-proxy.js"></script>
  <script src="js/client-identity.js"></script>
  <script src="js/helpers.js"></script>
  <script src="js/product-loader.js"></script>
  <script src="js/product-renderer.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/favorites.js"></script>
  <script src="js/quantity.js?v=2"></script>
  <script src="js/app-init.js"></script>
  <script src="js/filters.js"></script>
  <script src="js/bottom-nav.js?v=20"></script>
  <script src="js/scroll-buttons.js"></script>

  <!-- ОТЛОЖЕННЫЕ модули: defer — загружаются параллельно, выполняются после DOM -->
  <script defer src="js/advanced-search.js"></script>
  <script defer src="js/product-editor.js"></script>
  <script defer src="js/order-submit.js"></script>
  <script defer src="js/complaint-suggestion.js"></script>
  <script defer src="js/admin-ui.js"></script>
  <script defer src="js/image-optimizer.js"></script>
  <script defer src="js/upload.js"></script>
  <script defer src="js/gallery.js"></script>
  <script defer src="js/variants.js?v=2"></script>
  <script defer src="js/orders.js?v=2"></script>
  <script defer src="js/persist-profile.js?v=1"></script>
  <script defer src="js/customer-auth.js?v=3"></script>
  <script defer src="js/seller.js?v=2"></script>
  <script defer src="js/order-tracking.js?v=2"></script>
  <script defer src="js/partners.js?v=2"></script>
  <script defer src="js/agents.js?v=2"></script>

  <!-- PWA и Service Worker -->
  <script defer src="js/pwa-install.js"></script>
  <script defer src="js/sw-register.js"></script>

  <!-- ГАРАНТИЯ ПРОКРУТКИ: MutationObserver + SweetAlert2 патч -->
  <script>
  (function() {
    // === 1. Функция принудительного восстановления скролла ===
    function guaranteeScroll() {
      // Проверяем — есть ли открытое модальное окно?
      var hasModal = document.body.classList.contains('modal-open') ||
                     document.body.classList.contains('scroll-locked');
      // Проверяем SweetAlert2 — только если видим реальный popup
      var swalVisible = document.querySelector('.swal2-container.swal2-shown');
      if (hasModal || swalVisible) return; // Не мешаем модальным окнам

      // Убираем все блокирующие классы
      document.body.classList.remove('swal2-shown', 'swal2-height-auto', 'swal2-no-backdrop');
      document.documentElement.classList.remove('swal2-shown', 'swal2-height-auto');
      
      // Принудительно ставим прокрутку через setProperty (inline !important)
      document.body.style.setProperty('overflow-y', 'scroll', 'important');
      document.body.style.setProperty('overflow-x', 'hidden', 'important');
      document.body.style.setProperty('position', 'static', 'important');
      document.body.style.setProperty('height', 'auto', 'important');
      document.body.style.setProperty('touch-action', 'pan-y', 'important');
      document.documentElement.style.setProperty('overflow-y', 'scroll', 'important');
      document.documentElement.style.setProperty('overflow-x', 'hidden', 'important');
      document.documentElement.style.setProperty('position', 'static', 'important');
      document.documentElement.style.setProperty('touch-action', 'pan-y', 'important');
    }

    // === 2. MutationObserver — следим за изменениями body/html ===
    function setupScrollGuard() {
      var observer = new MutationObserver(function(mutations) {
        for (var i = 0; i < mutations.length; i++) {
          var m = mutations[i];
          // Если кто-то добавил блокирующий класс или изменил style
          if (m.type === 'attributes') {
            var target = m.target;
            // Если это не наш собственный вызов и нет модалов — восстанавливаем
            if (target === document.body || target === document.documentElement) {
              // Используем requestAnimationFrame чтобы не зациклиться
              requestAnimationFrame(function() {
                if (!document.body.classList.contains('modal-open') &&
                    !document.body.classList.contains('scroll-locked')) {
                  var cs = getComputedStyle(document.body);
                  if (cs.overflowY === 'hidden' || cs.position === 'fixed') {
                    console.log('⚠️ ScrollGuard: обнаружена блокировка, восстанавливаю...');
                    guaranteeScroll();
                  }
                }
              });
            }
          }
        }
      });
      
      observer.observe(document.body, { attributes: true, attributeFilter: ['class', 'style'] });
      observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class', 'style'] });
    }

    // === 3. Патчим SweetAlert2: запрещаем ему блокировать скролл body ===
    function patchSweetAlert() {
      if (typeof Swal === 'undefined') return;
      var origFire = Swal.fire.bind(Swal);
      Swal.fire = function() {
        var result = origFire.apply(Swal, arguments);
        // После закрытия любого попапа — гарантируем скролл
        if (result && typeof result.then === 'function') {
          result.then(function() {
            setTimeout(guaranteeScroll, 50);
          }).catch(function() {
            setTimeout(guaranteeScroll, 50);
          });
        }
        return result;
      };
    }

    // === Запуск ===
    // На DOMContentLoaded — ставим Observer и патчим Swal
    document.addEventListener('DOMContentLoaded', function() {
      setupScrollGuard();
      patchSweetAlert();
      setTimeout(guaranteeScroll, 100);
      setTimeout(guaranteeScroll, 500);
    });
    // На полную загрузку
    window.addEventListener('load', function() {
      setTimeout(guaranteeScroll, 200);
      setTimeout(guaranteeScroll, 1000);
      setTimeout(guaranteeScroll, 3000);
    });
    // Сразу при парсинге скрипта
    guaranteeScroll();
  })();
  </script>

</body>
</html>
