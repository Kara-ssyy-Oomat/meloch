<!DOCTYPE html>

<html lang="ru">

<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Хозтовары и мелочи оптом в Кара-Суу. Доставка, низкие цены.">
  <meta name="google-site-verification" content="KwaNctZFk2BMTScsvlO77JIV6KN4daZPJXP9XRcin9Q" />
  <link rel="icon" type="image/jpeg" href="photo_5294190093549636589_y.jpg">
  <title>B2B Market</title>
  <style>
    /* Сетка карточек: более компактная, чтобы помещалось больше товаров */
    .product-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:8px; padding:6px; }
  .product-card { background:#fff; border-radius:6px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 1px 6px rgba(0,0,0,0.06); transition:transform .14s, box-shadow .14s; }
  .product-card:hover { transform: translateY(-6px); box-shadow:0 8px 24px rgba(0,0,0,0.12); }
  /* Более компактные фото: чуть меньше по высоте, центрируем содержимое */
  .product-card .card-image { width:100%; aspect-ratio:4/3; max-height:140px; overflow:hidden; background:#f8f8f8; display:flex; align-items:center; justify-content:center; padding:6px; }
  .product-card .card-image img { width:100%; height:100%; object-fit:contain; display:block; }
  .product-card .card-body { padding:6px; display:flex; flex-direction:column; gap:6px; }
  .card-title { font-size:13px; color:#222; min-height:36px; }
  .card-price { font-size:16px; color:#e53935; font-weight:700; }
  .card-oldprice { font-size:13px; color:#888; text-decoration:line-through; margin-left:8px; }
  /* ratings removed */
  .card-badges { display:flex; gap:6px; flex-wrap:wrap; }
  .card-badge { background:#ffefdb; color:#b05b00; padding:4px 6px; border-radius:4px; font-size:12px; }
  .card-actions { display:flex; gap:8px; align-items:center; }
  .card-actions button { background:linear-gradient(90deg,#ff7a00,#ff3b00); color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
  @media (max-width:700px){
  /* На маленьких экранах — две колонки и компактные фото */
  .product-grid{grid-template-columns: repeat(2,1fr); gap:6px;}
  .product-card .card-image{max-height:90px; aspect-ratio:1/1;}
  .product-card .card-image { width:100%; aspect-ratio:4/3; max-height:110px; overflow:hidden; background:#f8f8f8; display:flex; align-items:center; justify-content:center; padding:6px; }
  .product-card .card-image{max-height:90px; aspect-ratio:1/1;}
    .card-actions .card-qty-input { padding:8px !important; font-size:14px !important; width:70px !important; align-self:center !important; }
    .card-actions .card-qty-input::-webkit-outer-spin-button, .card-actions .card-qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .admin-product-btn { font-size:1.12rem; padding:12px 10px; border-radius:12px; width:auto; }
  }


  @media (max-width:420px){
    /* Очень узкие телефоны: делаем так, чтобы поле количества и кнопка были в одной строке */
    .product-grid{grid-template-columns: repeat(2,1fr); gap:6px;}
    .card-actions { flex-direction: row; gap:8px; align-items:center; justify-content:space-between; }
    .card-actions .card-qty-input { padding:10px !important; font-size:16px !important; width:60px !important; }
    .card-actions button { padding:12px 14px !important; font-size:16px !important; border-radius:10px !important; width:auto !important; display:inline-block !important; }
    .admin-product-btn { width:100% !important; }
  }

  </style>

  <!-- Firebase SDKs: app first, then compat modules -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- jsPDF для генерации PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- ExcelJS для генерации Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  
  <!-- SheetJS (XLSX) для экспорта в Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
@media (max-width: 600px) {
  .admin-product-input {
    font-size: 1.1rem;
    padding: 12px 10px;
    width: 100% !important;
    min-width: 0;
    margin: 6px 0;
    border-radius: 12px;
  }
  .admin-product-btn {
    font-size: 1.1rem;
    padding: 14px 0;
    width: 100%;
    margin: 6px 0;
    border-radius: 12px;
    min-width: 0;
    display: block;
  }
  .admin-product-row {
    display: flex;
    flex-direction: column;
    gap: 6px;
    border-radius: 14px;
    box-shadow: 0 2px 12px #007bff22;
    padding: 8px 0;
  }
  td, th {
    font-size: 1rem;
    padding: 8px 4px;
  }
}
/* --- Красивый редактор товаров для админа --- */
.admin-product-input {
  border: 2px solid #90bfff;
  border-radius: 8px;
  background: #fafdff;
  padding: 7px 10px;
  font-size: 1rem;
  margin: 2px 0;
  transition: border 0.2s, box-shadow 0.2s;
  box-shadow: 0 1px 6px #007bff11;
}
.admin-product-input:focus {
  border: 2px solid #007bff;
  box-shadow: 0 2px 12px #007bff33;
  background: #eaf4ff;
}
.admin-product-btn {
  background: linear-gradient(90deg,#007bff 60%,#00c6ff 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 18px;
  font-size: 1rem;
  margin: 2px 2px;
  cursor: pointer;
  box-shadow: 0 2px 8px #007bff22;
  transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
}
.admin-product-btn:hover {
  background: linear-gradient(90deg,#0056b3 60%,#00aaff 100%);
  box-shadow: 0 4px 16px #007bff33;
  transform: scale(1.04);
}
.admin-product-row {
  background: #f0f7ff;
  border-radius: 10px;
  box-shadow: 0 2px 8px #007bff11;
}
.order-form #cartList {
  background: #fafdff;
  border: 2px solid #90bfff;
  border-radius: 12px;
  box-shadow: 0 2px 8px #007bff11;
  padding: 8px 0 8px 0;
  position: relative;
}
.cart-scroll-hint {
  text-align: center;
  color: #007bff;
  font-size: 13px;
  margin-bottom: 4px;
  font-style: italic;
  letter-spacing: 0.5px;
}
/* Анимация удаления товара из корзины */
.cart-item-removing {
  opacity: 0;
  max-height: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
  transition: opacity 0.3s, max-height 0.3s, margin 0.3s, padding 0.3s;
  overflow: hidden;
}
.order-form #cartList {
  max-height: 220px;
  overflow-y: auto;
  margin-bottom: 10px;
}
@media (max-width: 600px) {
  .order-form #cartList {
    max-height: 320px;
  }
}
.cart-item .delete-item {
  background: #dc3545 !important;
  color: #fff !important;
  border: none;
  font-size: 20px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin-left: 8px;
  transition: background 0.2s;
}
.cart-item .delete-item:hover {
  background: #b71c1c !important;
}
@media (max-width: 600px) {
  .cart-item .delete-item {
    display: block;
    width: 100% !important;
    height: 44px !important;
    font-size: 2rem;
    margin: 8px 0 0 0;
    border-radius: 12px;
  }
}


.search-sort-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  width: 100%;
  max-width: 600px;
  }

/* Стили для категорий */
.category-tabs {
  display: flex;
  gap: 10px;
  margin: 10px auto 15px;
  max-width: 1200px;
  padding: 0 8px;
  flex-wrap: wrap;
  justify-content: center;
}
.category-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.category-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}
.category-btn.active {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  box-shadow: 0 6px 12px rgba(245,87,108,0.4);
}
@media (max-width: 600px) {
  .category-tabs {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    column-gap: 6px;
    row-gap: 0px;
    padding: 0 8px;
    margin: 8px auto 12px;
  }
  .category-btn {
    padding: 10px 8px;
    font-size: 14px;
    width: 100%;
    min-width: 0;
    margin: 0;
  }
}
/* --- Адаптивные стили как на https://kara-ssyy-oomat.github.io/meloch/ --- */
* { box-sizing: border-box; margin: 0; padding: 0; }
* {
  -webkit-tap-highlight-color: transparent;
}

html {
  overflow-x: hidden;
  overflow-y: scroll !important;
  -webkit-overflow-scrolling: touch;
  height: auto;
  min-height: 100%;
  touch-action: pan-y !important;
}

body {
  font-family: 'Arial', sans-serif;
  background: #FFF9E5;
  color: #333;
  overflow-x: hidden;
  overflow-y: visible !important;
  -webkit-overflow-scrolling: touch;
  min-height: 100vh;
  position: relative;
  margin: 0;
  padding: 0;
  touch-action: pan-y !important;
}

/* Предотвращение зума на iOS при фокусе на input */
input, select, textarea {
  font-size: 16px !important;
}

/* Класс для блокировки скролла при открытых модальных окнах */
body.modal-open {
  overflow: hidden !important;
  position: fixed !important;
  width: 100% !important;
  height: 100% !important;
  top: 0 !important;
  left: 0 !important;
}
h1, h2 {
  text-align: center;
  margin-bottom: 20px;
  animation: fadeIn 1s ease forwards;
  color: #fff;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 8px;
}
.search-sort-row {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  width: 100%;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
}
.search-sort-row input,
.search-sort-row select,
.search-sort-row .other-site-btn {
  flex: 1 1 0;
  width: 100%;
  max-width: none;
  box-sizing: border-box;
  margin: 10px auto;
}
.other-site-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #007bff;
  color: #fff !important;
  text-align: center;
  padding: 10px 0;
  border-radius: 5px;
  text-decoration: none;
  transition: background 0.2s;
  font-weight: bold;
  height: 100%;
}
.other-site-btn:hover {
  background: #0056b3;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  background: white;
  box-shadow: 0 0 10px #ccc;
  overflow-x: auto;
  display: block;
  border-radius: 12px;
}
thead th {
  position: sticky;
  top: 0;
  background: #00fff7;
  z-index: 2;
}
th, td {
  padding: 10px;
  border: 1px solid #ddd;
  text-align: center;
  font-size: 15px;
}
th:nth-child(5), td:nth-child(5) {
  min-width: 90px;
  width: 80px;
}
.product-img {
  max-width: 60px;
  height: auto;
  transition: transform 0.2s, box-shadow 0.2s;
  border-radius: 8px;
}
.product-img:hover {
  transform: scale(1.08);
  box-shadow: 0 4px 16px #0002;
}
.cart-item {
  display: flex;
  align-items: center;
  gap: 0;
  margin-bottom: 8px;
  padding: 4px 0;
  border-bottom: 1px solid #f0f0f0;
}
.cart-item-compact {
  gap: 0;
  padding: 2px 0;
  min-height: 40px;
  align-items: center;
}
.cart-mini-img {
  width: 24px;
  height: 24px;
  object-fit: cover;
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #f8f8f8;
  box-shadow: 0 1px 4px #0001;
  display: block;
}
.cart-title {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.cart-qty, .cart-price, .cart-sum {
  margin: 0 8px;
  white-space: nowrap;
}
.cart-sum {
  font-weight: bold;
}
.cart-item-compact {
  gap: 0;
  padding: 2px 0;
  min-height: 36px;
}
.cart-mini-img {
  width: 32px;
  height: 32px;
  object-fit: cover;
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #f8f8f8;
  box-shadow: 0 1px 4px #0001;
}
.cart-title {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.cart-qty, .cart-price, .cart-sum {
  margin: 0 8px;
  white-space: nowrap;
}
.cart-sum {
  font-weight: bold;
}
.order-form, #orderHistory {
  background: #cce4ff;
  padding: 22px 18px 22px 18px;
  border-radius: 16px;
  box-shadow: 0 4px 24px #007bff22, 0 1.5px 0 #007bff inset;
  margin-top: 20px;
}
input, select, button, textarea {
  font-size: 1rem;
  padding: 10px;
  margin: 10px auto;
  width: 100%;
  max-width: 400px;
  display: block;
  border-radius: 5px;
  border: 1px solid #ccc;
}
button, .other-site-btn {
  border-radius: 8px;
  box-shadow: 0 2px 8px #0001;
  transition: background 0.2s, color 0.2s;
}
button:active {
  transform: scale(0.97);
}
button {

  background: #28a745;
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

  button:hover { background: #218838; }
.delete-order {
  background: #dc3545;
  color: white;
  border: none;
  padding: 8px 12px;
  margin-bottom: 6px;
  margin-top: 10px;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.3s ease;
}
  /* Исправлено: всё ниже обёрнуто в .cart-mini-img */

.cart-mini-img {
  border-radius: 6px;
  margin-right: 8px;
  flex-shrink: 0;
  background: #fff;
  box-shadow: 0 1px 4px #007bff33;
  display: block;
  border: 2px solid #007bff;
}

button.delete-item:hover {
  color: #c82333;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes addToCart {
  0% { transform: scale(1); background-color: #28a745; }
  50% { transform: scale(1.2); background-color: #218838; }
  100% { transform: scale(1); background-color: #28a745; }
}
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}
@keyframes slideInRight {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOutRight {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(400px); opacity: 0; }
}
.animate-add {
  animation: addToCart 0.5s ease;
}
@media (max-width: 600px) {
  body {
    font-size: 1.05rem;
    padding-bottom: 60px;
  }
  .container {
    max-width: 100vw;
    padding: 0 2vw;
  }
  .order-form, #orderHistory {
    padding: 10px 2vw;
    margin-top: 10px;
    box-shadow: 0 2px 8px #0001;
    border-radius: 10px;
  }
  .order-form input, .order-form button {
    width: 100%;
    min-height: 44px;
    font-size: 1rem;
    margin-bottom: 10px;
  }
  .search-sort-row {
    flex-direction: column;
    gap: 0;
    max-width: 100vw;
    padding: 0 2vw;
  }
  .other-site-btn {
    font-size: 1rem;
    padding: 12px 0;
    margin-top: 8px;
    border-radius: 8px;
  }
  table {
    display: block;
    width: 100vw;
    overflow-x: auto;
    border-radius: 10px;
    box-shadow: 0 2px 8px #0001;
  }
  thead, tbody, tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  th, td {
    font-size: 13px;
    padding: 7px 4px;
    min-width: 70px;
    word-break: break-word;
  }
  th:nth-child(2), td:nth-child(2) {
    min-width: 60px;
    max-width: 70px;
  }
  .product-img {
    max-width: 70px;
    min-width: 44px;
    width: 100%;
    height: auto;
    display: block;
    margin: 0 auto 6px auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px #007bff22;
    background: #fff;
    object-fit: contain;
  }
  .cart-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    font-size: 0.98rem;
  }
  .cart-summary {
    font-size: 1.1rem;
    margin: 8px 0;
  }
  #cartList div {
    font-size: 0.98rem;
    padding: 4px 0;
  }
  button, .order-form button, .other-site-btn {
    min-height: 44px;
    font-size: 1rem;
    padding: 10px 0;
  }
  .scroll-buttons {
    right: 10px;
    bottom: 10px;
    gap: 6px;
  }
  .scroll-buttons button {
    font-size: 18px;
    padding: 10px 14px;
    border-radius: 12px;
  }
  #previewInner {
    width: 96vw !important;
    left: 2vw !important;
    transform: none !important;
    padding: 6vw 2vw !important;
  }
  #previewImg {
    max-width: 92vw !important;
    max-height: 60vh !important;
  }
  #toggleHistory, #logoutUser {
    width: 100%;
    min-height: 44px;
    font-size: 1rem;
    margin: 8px 0;
  }
  #orderHistory h2 {
    font-size: 1.1rem;
    margin-bottom: 10px;
  }
  #historyList li {
  font-size: 0.98rem;
  margin-bottom: 10px;
  padding: 8px 4px;
  border-radius: 8px;
  box-shadow: 0 1px 4px #0001;
}
}

@keyframes addToCart {
  0% { transform: scale(1); background-color: #28a745; }
  50% { transform: scale(1.2); background-color: #218838; }
  100% { transform: scale(1); background-color: #28a745; }
}

    .animate-add {

      animation: addToCart 0.5s ease;

    }



    @media (max-width: 600px) {

      th, td { font-size: 12px; padding: 6px; }

      input, select, button, textarea { font-size: 0.9rem; padding: 8px; }

      .cart-summary { font-size: 1.2rem; }

      #cartList div { font-size: 0.9rem; }

      .order-form input, .order-form button { width: 90%; }

    }
    @media (max-width: 600px) {
  button.delete-item {
    width: 20px; /* Устанавливаем фиксированную ширину */
    height: 20px; /* Устанавливаем фиксированную высоту */
    font-size: 12px; /* Уменьшаем размер текста */
    padding: 0; /* Убираем лишние отступы */
  }
}

    @media (max-width: 600px) {
  th, td { font-size: 12px; padding: 6px; }
  input, select, button, textarea { font-size: 0.9rem; padding: 8px; }
  .cart-summary { font-size: 1.2rem; }
  #cartList div { font-size: 0.9rem; }
  .order-form input, .order-form button { width: 90%; }
  button.delete-item {
    width: 20px;
    height: 20px;
    font-size: 12px;
    padding: 0;
  }
}

  </style>
      



  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
// Обновить название товара
async function updateProductTitle(productId, newTitle) {
  try {
    await db.collection('products').doc(productId).update({ title: newTitle });
    Swal.fire('Успех!', 'Название обновлено', 'success');
    loadProducts();
  } catch (error) {
    console.error('Ошибка при обновлении названия:', error);
    Swal.fire('Ошибка', 'Не удалось обновить название', 'error');
  }
}

// Обновить категорию товара
async function updateProductCategory(productId, newCategory) {
  try {
    console.log('Обновление категории:', productId, 'на', newCategory);
    await db.collection('products').doc(productId).update({ category: newCategory });
    console.log('Категория обновлена в базе данных');
    await loadProducts(); // Ждем загрузки товаров
    console.log('Товары перезагружены');
    Swal.fire('Успех!', `Категория изменена на "${newCategory}"`, 'success');
  } catch (error) {
    console.error('Ошибка при обновлении категории:', error);
    Swal.fire('Ошибка', 'Не удалось обновить категорию', 'error');
  }
}

// Обновить цену товара
async function updateProductPrice(productId, newPrice) {
  try {
    const price = parseFloat(newPrice);
    if (isNaN(price) || price < 0) {
      Swal.fire('Ошибка', 'Введите корректную цену', 'error');
      return;
    }
    await db.collection('products').doc(productId).update({ price: price });
    await loadProducts();
    Swal.fire('Успех!', 'Цена обновлена', 'success');
  } catch (error) {
    console.error('Ошибка при обновлении цены:', error);
    Swal.fire('Ошибка', 'Не удалось обновить цену', 'error');
  }
}

// Обновить цену закупки товара
async function updateProductCostPrice(productId, newCostPrice) {
  try {
    const costPrice = parseFloat(newCostPrice);
    if (isNaN(costPrice) || costPrice < 0) {
      Swal.fire('Ошибка', 'Введите корректную цену закупки', 'error');
      return;
    }
    await db.collection('products').doc(productId).update({ costPrice: costPrice });
    await loadProducts();
    Swal.fire('Успех!', 'Цена закупки обновлена', 'success');
  } catch (error) {
    console.error('Ошибка при обновлении цены закупки:', error);
    Swal.fire('Ошибка', 'Не удалось обновить цену закупки', 'error');
  }
}

// Изменить фотографию товара
async function changeProductImage(productId) {
  console.log('changeProductImage вызвана для товара:', productId);
  
  // Создаем input для выбора файла
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('Выбран файл:', file.name);
    
    try {
      Swal.fire({
        title: 'Загрузка...',
        text: 'Пожалуйста, подождите',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      // Загружаем файл на Cloudinary
      console.log('Загружаем на Cloudinary:', file.name);
      const downloadURL = await uploadToCloudinary(file);
      console.log('URL загруженного файла:', downloadURL);
      
      // Обновляем URL фотографии в базе данных
      await db.collection('products').doc(productId).update({ image: downloadURL });
      console.log('База данных обновлена');
      
      await loadProducts();
      Swal.fire('Успех!', 'Фотография успешно обновлена', 'success');
    } catch (error) {
      console.error('Ошибка при загрузке фото:', error);
      Swal.fire('Ошибка', 'Не удалось загрузить фото: ' + error.message, 'error');
    }
  };
  
  // Открываем диалог выбора файла
  input.click();
}

// Заблокировать/разблокировать товар
async function toggleProductBlock(productId, currentStatus) {
  try {
    await db.collection('products').doc(productId).update({ blocked: !currentStatus });
    Swal.fire('Успех!', !currentStatus ? 'Товар заблокирован' : 'Товар разблокирован', 'success');
    loadProducts();
  } catch (error) {
    console.error('Ошибка при смене статуса блокировки:', error);
    Swal.fire('Ошибка', 'Не удалось изменить статус блокировки', 'error');
  }
}

</script>

</head>

<body>
  <!-- Кнопка корзины -->
  <button id="cartFloatBtn" style="position:fixed;left:20px;bottom:20px;z-index:9999;background:#007bff;color:#fff;border:none;border-radius:50%;width:56px;height:56px;box-shadow:0 2px 12px #007bff44;display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;transition:background 0.2s;">
    <span id="cartFloatCount" style="position:absolute;top:6px;right:8px;background:#dc3545;color:#fff;border-radius:50%;padding:2px 7px;font-size:14px;font-weight:bold;min-width:22px;text-align:center;">0</span>
    🛒
  </button>

  <!-- Блок для просмотра фото -->
  <div id="previewBlock" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:10000; pointer-events:auto; background: rgba(0,0,0,0.85);">
    <div id="previewInner" style="position:relative; background:white; padding:12px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5); max-width:95vw; max-height:95vh; display:flex; flex-direction:column; align-items:center;">
      <span id="closePreview" style="position:absolute; top:8px; right:8px; cursor:pointer; font-size:28px; background:#eee; width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:50%; z-index:10;">&times;</span>
      <div style="text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%;">
        <img id="previewImg" src="" alt="Просмотр" style="max-width:90vw; max-height:80vh; display:block; object-fit:contain;">
        <div id="previewCaption" style="margin-top:12px; font-size:14px; color:#333; font-weight:500;"></div>
      </div>
    </div>
  </div>
<!-- filepath: c:\Users\hp\Desktop\нож\index.html -->

  <!-- Кнопка меню (гамбургер) в левом верхнем углу -->
  <button id="menuToggleBtn" onclick="toggleSideMenu()" style="position:fixed; top:15px; left:15px; z-index:10001; width:45px; height:45px; background:white; border:none; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15); cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:5px; padding:10px; transition:all 0.3s;">
    <span style="width:25px; height:3px; background:#333; border-radius:2px; transition:all 0.3s;"></span>
    <span style="width:25px; height:3px; background:#333; border-radius:2px; transition:all 0.3s;"></span>
    <span style="width:25px; height:3px; background:#333; border-radius:2px; transition:all 0.3s;"></span>
  </button>

  <!-- Боковое меню -->
  <div id="sideMenu" style="position:fixed; top:0; left:-300px; width:280px; height:100vh; background:white; box-shadow:2px 0 10px rgba(0,0,0,0.1); z-index:10000; transition:left 0.3s ease; overflow-y:auto; padding:20px;">
    <!-- Заголовок меню -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #f0f0f0;">
      <h2 style="margin:0; font-size:20px; color:#333;">📋 Меню</h2>
      <button onclick="toggleSideMenu()" style="background:none; border:none; font-size:28px; cursor:pointer; color:#666; width:35px; height:35px; display:flex; align-items:center; justify-content:center;">&times;</button>
    </div>
    
    <!-- Пункты меню (пока пусто, вы добавите позже) -->
    <div id="menuItems" style="display:flex; flex-direction:column; gap:10px;">
      <!-- Чат с продавцом -->
      <button onclick="openChatFromMenu()" style="width:100%; padding:15px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600; display:flex; align-items:center; gap:10px; transition:transform 0.2s;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>💬 Чат с продавцом</span>
      </button>
      
      <!-- Жалоба -->
      <button onclick="openComplaintWindow()" style="width:100%; padding:15px; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600; display:flex; align-items:center; gap:10px; transition:transform 0.2s;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <span>⚠️ Жалоба</span>
      </button>
      
      <!-- Предложить товар -->
      <button onclick="openSuggestionWindow()" style="width:100%; padding:15px; background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color:white; border:none; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600; display:flex; align-items:center; gap:10px; transition:transform 0.2s;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"></path>
        </svg>
        <span>💡 Предложить товар</span>
      </button>
      
      <!-- Вход администратора -->
      <div id="menuAdminSection" style="margin-top:10px;">
        <div id="menuAdminLogin" style="display:flex; flex-direction:column; gap:8px;">
          <div style="font-size:14px; font-weight:600; color:#333; padding:5px 0; border-top:1px solid #e0e0e0; padding-top:15px;">🔐 Администратор</div>
          <input type="password" id="menuAdminPassword" placeholder="Введите пароль" onkeypress="if(event.key==='Enter') loginAdminFromMenu()" style="padding:12px; border:1px solid #ddd; border-radius:8px; outline:none; font-size:14px;">
          <button onclick="loginAdminFromMenu()" style="width:100%; padding:12px; background:linear-gradient(90deg, #28a745, #20c997); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600;">Войти</button>
        </div>
        
        <div id="menuAdminLoggedIn" style="display:none; flex-direction:column; gap:8px;">
          <div style="font-size:14px; font-weight:600; color:#28a745; padding:5px 0; border-top:1px solid #e0e0e0; padding-top:15px;">✅ Вы вошли как админ</div>
          <button onclick="openAddProductWindow()" style="width:100%; padding:12px; background:linear-gradient(90deg, #ff6b6b, #ee5a6f); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; justify-content:center;">
            ➕ Добавить товар
          </button>
          <button onclick="openOrdersManagementWindow()" style="width:100%; padding:12px; background:linear-gradient(90deg, #f093fb, #f5576c); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; justify-content:center;">
            📦 Заказы клиентов
          </button>
          <button onclick="openPartnersOrdersWindow()" style="width:100%; padding:12px; background:linear-gradient(90deg, #4facfe, #00f2fe); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; justify-content:center;">
            🤝 Заказы от партнеров
          </button>
          <button onclick="openAdminChatWindow()" style="width:100%; padding:12px; background:linear-gradient(90deg, #667eea, #764ba2); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; justify-content:center;">
            💬 Чат с клиентами
          </button>
          <button onclick="openProfitReport()" style="width:100%; padding:12px; background:linear-gradient(90deg, #28a745, #20c997); color:white; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:600; display:flex; align-items:center; gap:8px; justify-content:center;">
            💰 Отчет по прибыли
          </button>
          <button onclick="logoutAdmin()" style="width:100%; padding:10px; background:#dc3545; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px;">Выйти</button>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Затемнение фона при открытом меню -->
  <div id="menuOverlay" onclick="toggleSideMenu()" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:9999;"></div>

  <!-- Окно чата (открывается из меню) -->
  <div id="chatWindow" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:white; z-index:10002; flex-direction:column; overflow:hidden;">
    <!-- Заголовок чата -->
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
      <div style="flex:1;">
        <div style="font-weight:bold; font-size:18px;">Чат с продавцом</div>
        <div id="clientNameDisplay" style="font-size:12px; opacity:0.9; display:flex; align-items:center; gap:8px; margin-top:4px;">
          <span>Обычно отвечаем в течение часа</span>
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <button onclick="changeClientName()" style="background:rgba(255,255,255,0.25); border:none; color:white; font-size:22px; cursor:pointer; padding:8px; border-radius:8px; width:45px; height:45px; display:flex; align-items:center; justify-content:center; transition:background 0.2s;" title="Изменить имя" onmouseover="this.style.background='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'">
          ✏️
        </button>
        <button onclick="toggleChat()" style="background:rgba(255,255,255,0.2); border:none; color:white; font-size:28px; cursor:pointer; padding:8px 12px; border-radius:8px; width:45px; height:45px; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>
    </div>
    
    <!-- Сообщения -->
    <div id="chatMessages" style="flex:1; overflow-y:auto; padding:16px; background:#f5f5f5; display:flex; flex-direction:column; gap:12px;">
      <div style="background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <div style="font-size:14px; color:#333;">Здравствуйте! Чем могу помочь?</div>
        <div style="font-size:11px; color:#999; margin-top:4px;">Продавец • только что</div>
      </div>
    </div>
    
    <!-- Поле ввода -->
    <div style="padding:16px; background:white; border-top:1px solid #e0e0e0; display:flex; gap:12px; box-shadow:0 -2px 8px rgba(0,0,0,0.05);">
      <input id="chatInput" type="text" placeholder="Введите сообщение..." style="flex:1; padding:14px 18px; border:1px solid #ddd; border-radius:24px; outline:none; font-size:16px;" onkeypress="if(event.key==='Enter') sendChatMessage()">
      <button onclick="sendChatMessage()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow:0 2px 8px rgba(102,126,234,0.4);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <!-- Модальное окно жалобы -->
  <div id="complaintWindow" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10002;">
    <div style="background:#fff; width:95%; max-width:500px; margin:10vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; max-height:80vh;">
      
      <!-- Шапка -->
      <div style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">⚠️ Жалоба</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">Опишите вашу проблему</p>
        </div>
        <button onclick="closeComplaintWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Форма -->
      <div style="flex:1; overflow-y:auto; padding:20px;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Ваше имя:</label>
            <input type="text" id="complaintName" placeholder="Введите ваше имя" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Телефон:</label>
            <input type="tel" id="complaintPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Тема жалобы:</label>
            <select id="complaintCategory" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
              <option value="">Выберите категорию</option>
              <option value="quality">Качество товара</option>
              <option value="delivery">Проблемы с доставкой</option>
              <option value="service">Обслуживание</option>
              <option value="price">Неверная цена</option>
              <option value="other">Другое</option>
            </select>
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Описание проблемы:</label>
            <textarea id="complaintText" placeholder="Подробно опишите вашу проблему..." style="width:100%; min-height:120px; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px; resize:vertical;"></textarea>
          </div>
        </div>
      </div>

      <!-- Кнопка отправки -->
      <div style="padding:20px; background:#f8f9fa; border-top:1px solid #e0e0e0;">
        <button onclick="sendComplaint()" style="width:100%; padding:14px; background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">📤 Отправить жалобу</button>
      </div>
    </div>
  </div>

  <!-- Окно предложения товара -->
  <div id="suggestionWindow" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:10001; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:500px; max-height:90vh; border-radius:16px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- Заголовок -->
      <div style="background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">💡 Предложить товар</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">Расскажите нам о товаре, который вы хотите видеть</p>
        </div>
        <button onclick="closeSuggestionWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Форма -->
      <div style="flex:1; overflow-y:auto; padding:20px;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Ваше имя:</label>
            <input type="text" id="suggestionName" placeholder="Введите ваше имя" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Телефон:</label>
            <input type="tel" id="suggestionPhone" placeholder="+996 XXX XXX XXX" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Название товара:</label>
            <input type="text" id="suggestionProductName" placeholder="Какой товар вы хотите видеть?" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">За сколько сейчас покупаете:</label>
            <input type="number" id="suggestionCurrentPrice" placeholder="Текущая цена у другого продавца" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Желаемая цена:</label>
            <input type="number" id="suggestionPrice" placeholder="За сколько вы готовы купить?" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Описание:</label>
            <textarea id="suggestionDescription" placeholder="Опишите подробности: характеристики, для чего нужен товар..." style="width:100%; min-height:120px; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px; resize:vertical;"></textarea>
          </div>
          
          <div>
            <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Фото товара (необязательно):</label>
            <input type="file" id="suggestionPhoto" accept="image/*" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px; background:white;">
            <p style="margin:5px 0 0; font-size:12px; color:#666;">Загрузите изображение товара, если оно у вас есть</p>
          </div>
        </div>
      </div>

      <!-- Кнопка отправки -->
      <div style="padding:20px; background:#f8f9fa; border-top:1px solid #e0e0e0;">
        <button id="suggestionSubmitBtn" onclick="sendSuggestion()" style="width:100%; padding:14px; background:linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">✅ Отправить предложение</button>
      </div>
      
      <!-- Индикатор загрузки -->
      <div id="suggestionLoader" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:10; justify-content:center; align-items:center; flex-direction:column; border-radius:16px;">
        <div style="width:50px; height:50px; border:5px solid #e0e0e0; border-top:5px solid #43e97b; border-radius:50%; animation:spin 1s linear infinite;"></div>
        <p style="margin-top:20px; color:#333; font-size:16px; font-weight:600;">Отправка предложения...</p>
      </div>
    </div>
  </div>

  <!-- Полноэкранное окно админского чата -->
  <div id="adminChatWindow" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:white; z-index:10003; flex-direction:column; overflow:hidden;">
    <!-- Заголовок админского чата -->
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.15);">
      <div>
        <div style="font-weight:bold; font-size:18px;">💬 Чат с клиентами</div>
        <div style="font-size:12px; opacity:0.9;">Управление всеми диалогами</div>
      </div>
      <button onclick="closeAdminChatWindow()" style="background:rgba(255,255,255,0.2); border:none; color:white; font-size:28px; cursor:pointer; padding:8px 12px; border-radius:8px; width:45px; height:45px; display:flex; align-items:center; justify-content:center;">&times;</button>
    </div>
    
    <!-- Контейнер для списка клиентов и сообщений -->
    <div id="adminFullChatMessages" style="flex:1; overflow:hidden; background:#f8f9fa;">
      <div style="text-align:center; color:#999; padding:40px;">Загрузка...</div>
    </div>
    
    <!-- Поле ввода для админа -->
    <div style="padding:16px; background:white; border-top:1px solid #e0e0e0; display:flex; gap:12px; box-shadow:0 -2px 8px rgba(0,0,0,0.05);">
      <input id="adminFullChatInput" type="text" placeholder="Сначала выберите клиента..." style="flex:1; padding:14px 18px; border:1px solid #ddd; border-radius:24px; outline:none; font-size:16px;" onkeypress="if(event.key==='Enter') sendAdminFullChatMessage()">
      <button onclick="sendAdminFullChatMessage()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow:0 2px 8px rgba(102,126,234,0.4);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <!-- Название сайта -->
  <div style="text-align:center; margin:20px 0 10px;">
    <h1 style="font-size:2.5rem; color:#007bff; margin:0; font-weight:900; text-shadow:2px 2px 4px rgba(0,0,0,0.1);">B2B Market</h1>
    <p style="font-size:0.9rem; color:#666; margin:5px 0 0;">Оптовые товары по выгодным ценам</p>
  </div>

  <!-- Верхний промо-слайдер: две рекламные карточки (swipe) -->
  <!-- Категории товаров -->
  <div class="category-tabs">
    <button class="category-btn active" onclick="filterByCategory('все')">Все товары</button>
    <button class="category-btn" onclick="filterByCategory('ножницы')">Ножницы</button>
    <button class="category-btn" onclick="filterByCategory('скотч')">Скотч</button>
    <button class="category-btn" onclick="filterByCategory('нож')">Нож</button>
  </div>

  <div class="search-sort-row">
    <input type="text" id="search" placeholder="Поиск товара..." />
    <select id="sort">
      <option value="">Сортировка по цене</option>
      <option value="asc">Сначала дешёвые</option>
      <option value="desc">Сначала дорогие</option>
    </select>
  </div>



  <!-- Сетка карточек товаров -->
  <div id="productTable" class="product-grid"></div>



  <div class="order-form">

    <h2>Оформить заказ</h2>

    <div id="cartList"></div>

    <div class="cart-summary">Итого: <span id="totalSum">0</span> сом</div>

    <!-- Кнопка открытия панели корзины перенесена вниз перед очисткой корзины -->
    <div style="display:flex;gap:8px;">
      <button id="openCartBtn" onclick="openCartPage()">Открыть корзину</button>
      <!-- Кнопка очистки корзины будет в панели корзины -->
    </div>

    <input type="text" id="name" placeholder="Ваше имя" required />

    <input type="tel" id="phone" placeholder="Телефон" required />

    <input type="text" id="address" placeholder="Адрес доставки" required />
    
    <input type="text" id="referredBy" placeholder="Кто вас порекомендовал? (необязательно)" style="background:#f8f9fa; border:2px solid #e9ecef;" />

    <button id="submitOrder">Отправить заказ</button>

  </div>

  <button id="logoutUser" style="margin:10px 0;">Выйти из профиля</button>

  <div id="adminProductsBlock"></div>

  <!-- Модальное окно добавления товара -->
  <div id="addProductWindow" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3000;">
    <div style="background:#fff; width:95%; max-width:600px; max-height:90vh; margin:5vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      
      <!-- Шапка -->
      <div style="background:linear-gradient(90deg, #ff6b6b, #ee5a6f); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">➕ Добавить товар</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">Заполните информацию о товаре</p>
        </div>
        <button onclick="closeAddProductWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Форма -->
      <div style="flex:1; overflow-y:auto; padding:20px;">
        <div style="display:flex; flex-direction:column; gap:15px;">
          
          <!-- Кнопки управления товарами -->
          <div style="display:flex; gap:10px;">
            <button onclick="expandAllProducts()" style="flex:1; padding:10px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px;">▼ Развернуть все</button>
            <button onclick="collapseAllProducts()" style="flex:1; padding:10px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px;">▲ Свернуть все</button>
          </div>

          <input type="text" id="newTitle" placeholder="Название товара" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <input type="number" id="newCostPrice" placeholder="💵 Цена закупки (за сколько купили)" step="0.01" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <input type="number" id="newPrice" placeholder="💰 Цена продажи (розничная)" step="0.01" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <div id="profitDisplay" style="padding: 12px; background: #e8f5e9; border-radius: 8px; display: none; text-align: center;">
            <strong>📊 Наценка:</strong> <span id="profitAmount">0</span> сом (<span id="profitPercent">0</span>%)
          </div>
          
          <select id="newCategory" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
            <option value="">Выберите категорию</option>
            <option value="все">Все товары</option>
            <option value="ножницы">Ножницы</option>
            <option value="скотч">Скотч</option>
            <option value="нож">Нож</option>
          </select>
          
          <input type="number" id="newOptPrice" placeholder="Оптовая цена" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <input type="number" id="newOptQty" placeholder="Минимальное количество для опта" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <input type="number" id="newMinQty" placeholder="Минимальное количество для покупки" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <div style="display: flex; gap: 10px;">
            <input type="file" id="imageFile" accept="image/*" style="flex: 1; padding:10px; border:1px solid #ddd; border-radius:8px;">
            <input type="file" id="galleryFile" accept="image/*" style="display: none;">
            <button id="openGallery" style="padding:10px 15px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;" onclick="document.getElementById('galleryFile').click()">📁 Галерея</button>
          </div>
          
          <input type="text" id="newImage" placeholder="URL изображения (опционально)" style="padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
          
          <button id="previewUrlBtn" style="padding:10px; background:#6c757d; color:white; border:none; border-radius:8px; cursor:pointer;">👁️ Показать предпросмотр</button>
          
          <div id="imagePreview" style="display: none; text-align:center; padding:10px; background:#f8f9fa; border-radius:8px;">
            <img id="previewImg" src="" alt="Предпросмотр" style="max-width: 100%; max-height: 200px; border-radius:8px;">
          </div>
        </div>
      </div>

      <!-- Кнопки действий -->
      <div style="padding:20px; background:#f8f9fa; border-top:1px solid #e0e0e0; display:flex; gap:10px;">
        <button id="addProductBtn" style="flex:1; padding:14px; background:linear-gradient(90deg, #28a745, #20c997); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">✅ Добавить товар</button>
        <button onclick="massUpdateCategories()" style="flex:1; padding:14px; background:linear-gradient(90deg, #007bff, #0056b3); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">📦 Массовое обновление</button>
      </div>
    </div>
  </div>

  <!-- Окно управления заказами -->
  <div id="ordersManagementWindow" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3001;">
    <div style="background:#fff; width:95%; max-width:1200px; height:90vh; margin:3vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      
      <!-- Шапка -->
      <div style="background:linear-gradient(90deg, #f093fb, #f5576c); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">📦 Заказы клиентов</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">Управление и редактирование заказов</p>
        </div>
        <button onclick="closeOrdersManagementWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Фильтры -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <select id="ordersFilterDate" onchange="loadOrdersManagement()" style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
          <option value="all">Все заказы</option>
          <option value="today">Сегодня</option>
          <option value="week">За неделю</option>
          <option value="month">За месяц</option>
        </select>
        
        <select id="ordersFilterStatus" onchange="loadOrdersManagement()" style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
          <option value="all">Все статусы</option>
          <option value="pending">В обработке</option>
          <option value="completed">Выполнен</option>
          <option value="cancelled">Отменен</option>
        </select>
        
        <input type="text" id="ordersSearchClient" placeholder="Поиск по имени/телефону" onkeyup="loadOrdersManagement()" style="flex:1; min-width:200px; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
        
        <button onclick="loadOrdersManagement()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">🔄 Обновить</button>
      </div>

      <!-- Список заказов -->
      <div id="ordersManagementList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка заказов...</div>
      </div>
    </div>
  </div>

  <!-- Окно заказов от партнеров -->
  <div id="partnersOrdersWindow" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3001;">
    <div style="background:#fff; width:95%; max-width:1200px; height:90vh; margin:3vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      
      <!-- Шапка -->
      <div style="background:linear-gradient(90deg, #4facfe, #00f2fe); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">🤝 Заказы от партнеров</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">Статистика и список заказов по партнерам</p>
        </div>
        <button onclick="closePartnersOrdersWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Фильтры -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <select id="partnersFilterDate" onchange="loadPartnersOrders()" style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
          <option value="all">Все время</option>
          <option value="today">Сегодня</option>
          <option value="week">За неделю</option>
          <option value="month">За месяц</option>
        </select>
        
        <select id="partnersFilterPartner" onchange="loadPartnersOrders()" style="padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
          <option value="all">Все партнеры</option>
        </select>
        
        <button onclick="loadPartnersOrders()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">🔄 Обновить</button>
        <button onclick="exportPartnersToExcel()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">📊 Экспорт в Excel</button>
      </div>

      <!-- Статистика партнеров -->
      <div id="partnersStats" style="padding:15px; background:#fff; border-bottom:2px solid #e0e0e0;">
        <div style="text-align:center; color:#999;">Загрузка статистики...</div>
      </div>

      <!-- Список заказов -->
      <div id="partnersOrdersList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка заказов...</div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для добавления товара в заказ -->
  <div id="addItemToOrderModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:3002; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:600px; max-height:80vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- Заголовок -->
      <div style="background:linear-gradient(135deg, #17a2b8 0%, #138496 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:20px;">➕ Добавить товар в заказ</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:13px;">Выберите товар из списка</p>
        </div>
        <button onclick="closeAddItemToOrderModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Поиск товара -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0;">
        <input type="text" id="searchProductToAdd" placeholder="🔍 Поиск товара..." onkeyup="filterProductsToAdd()" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
      </div>

      <!-- Список товаров -->
      <div id="productsToAddList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка товаров...</div>
      </div>
    </div>
  </div>

  <!-- Окно отчета по прибыли -->
  <div id="profitReportWindow" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:3000;">
    <div style="background:#fff; width:95%; max-width:1000px; height:90vh; margin:3vh auto; border-radius:12px; overflow:hidden; display:flex; flex-direction:column;">
      
      <!-- Шапка -->
      <div style="background:linear-gradient(135deg, #28a745 0%, #20c997 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:24px;">💰 Отчет по прибыли</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;">Анализ прибыльности товаров</p>
        </div>
        <button onclick="closeProfitReport()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Фильтры и сводка -->
      <div style="padding:15px; background:#f8f9fa;">
        <!-- Вкладки -->
        <div style="display:flex; gap:10px; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #e0e0e0;">
          <button id="tabProducts" onclick="switchProfitTab('products')" style="padding:12px 24px; background:linear-gradient(90deg, #28a745, #20c997); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.2);">📦 По товарам</button>
          <button id="tabOrders" onclick="switchProfitTab('orders')" style="padding:12px 24px; background:#e9ecef; color:#333; border:none; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.1);">📋 По заказам</button>
          <button id="tabExpenses" onclick="switchProfitTab('expenses')" style="padding:12px 24px; background:#e9ecef; color:#333; border:none; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.1);">💸 Расходы</button>
        </div>

        <!-- Панель по товарам -->
        <div id="profitProductsPanel">
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">💰 Общая прибыль</div>
              <div style="font-size:24px; font-weight:700; color:#28a745;" id="totalProfit">0 сом</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">📊 Средняя наценка</div>
              <div style="font-size:24px; font-weight:700; color:#007bff;" id="avgMarkup">0%</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">📦 Всего товаров</div>
              <div style="font-size:24px; font-weight:700; color:#6c757d;" id="totalProducts">0</div>
            </div>
          </div>
          
          <div style="display:flex; gap:10px; align-items:center;">
            <select id="profitCategoryFilter" onchange="filterProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="">Все категории</option>
              <option value="ножницы">Ножницы</option>
              <option value="скотч">Скотч</option>
              <option value="нож">Нож</option>
              <option value="все">Все товары</option>
            </select>
            <select id="profitSortFilter" onchange="filterProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="profit-desc">По прибыли (↓)</option>
              <option value="profit-asc">По прибыли (↑)</option>
              <option value="markup-desc">По наценке (↓)</option>
              <option value="markup-asc">По наценке (↑)</option>
              <option value="name">По названию</option>
            </select>
            <button onclick="exportProfitToExcel()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">📥 Excel</button>
          </div>
        </div>

        <!-- Панель по заказам -->
        <div id="profitOrdersPanel" style="display:none;">
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">💰 Прибыль за период</div>
              <div style="font-size:24px; font-weight:700; color:#28a745;" id="totalOrderProfit">0 сом</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">📋 Всего заказов</div>
              <div style="font-size:24px; font-weight:700; color:#007bff;" id="totalOrdersCount">0</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">👥 Клиентов</div>
              <div style="font-size:24px; font-weight:700; color:#6c757d;" id="totalClientsCount">0</div>
            </div>
          </div>
          
          <div style="display:flex; gap:10px; align-items:center;">
            <select id="orderDateFilter" onchange="loadOrderProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="today">Сегодня</option>
              <option value="yesterday">Вчера</option>
              <option value="week">За неделю</option>
              <option value="month">За месяц</option>
              <option value="all">Все время</option>
            </select>
            <select id="orderSortFilter" onchange="loadOrderProfitReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="profit-desc">По прибыли (↓)</option>
              <option value="date-desc">По дате (новые)</option>
              <option value="date-asc">По дате (старые)</option>
            </select>
            <button onclick="exportOrderProfitToExcel()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">📥 Excel</button>
            <button onclick="deleteSelectedOrders()" style="padding:10px 20px; background:#dc3545; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">🗑️ Удалить</button>
          </div>
        </div>

        <!-- Панель расходов -->
        <div id="profitExpensesPanel" style="display:none;">
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:15px;">
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">💸 Расходы за период</div>
              <div style="font-size:24px; font-weight:700; color:#dc3545;" id="totalExpenses">0 сом</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">💰 Прибыль за период</div>
              <div style="font-size:24px; font-weight:700; color:#28a745;" id="expensesPeriodProfit">0 сом</div>
            </div>
            <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">📊 Чистая прибыль</div>
              <div style="font-size:24px; font-weight:700; color:#007bff;" id="netProfit">0 сом</div>
            </div>
          </div>
          
          <div style="display:flex; gap:10px; margin-bottom:15px;">
            <select id="expenseDateFilter" onchange="loadExpensesReport()" style="padding:10px; border:1px solid #ddd; border-radius:8px; flex:1;">
              <option value="today">Сегодня</option>
              <option value="yesterday">Вчера</option>
              <option value="week">За неделю</option>
              <option value="month">За месяц</option>
              <option value="all">Все время</option>
            </select>
            <button onclick="loadExpensesReport()" style="padding:10px 20px; background:#17a2b8; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">🔄 Обновить</button>
            <button onclick="openAddExpenseModal()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer; white-space:nowrap;">➕ Добавить расход</button>
          </div>
        </div>
      </div>

      <!-- Таблица товаров -->
      <div id="profitProductsTable" style="flex:1; overflow-y:auto; padding:15px;">
        <table id="profitReportTable" style="width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#f8f9fa; border-bottom:2px solid #e0e0e0;">
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">#</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">Товар</th>
              <th style="padding:12px; text-align:center; font-size:13px; color:#666;">Категория</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">💵 Закупка</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">💰 Продажа</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">📊 Прибыль</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">% Наценка</th>
            </tr>
          </thead>
          <tbody id="profitReportBody">
            <!-- Данные загружаются динамически -->
          </tbody>
        </table>
      </div>

      <!-- Таблица заказов -->
      <div id="profitOrdersTable" style="display:none; flex:1; overflow-y:auto; padding:15px;">
        <table style="width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#f8f9fa; border-bottom:2px solid #e0e0e0;">
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">#</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">Дата</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">👤 Клиент</th>
              <th style="padding:12px; text-align:center; font-size:13px; color:#666;">📦 Товаров</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">💵 Закупка</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">💰 Сумма</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">📊 Прибыль</th>
            </tr>
          </thead>
          <tbody id="orderProfitReportBody">
            <!-- Данные загружаются динамически -->
          </tbody>
        </table>
      </div>

      <!-- Таблица расходов -->
      <div id="profitExpensesTable" style="display:none; flex:1; overflow-y:auto; padding:15px;">
        <table style="width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <thead>
            <tr style="background:#f8f9fa; border-bottom:2px solid #e0e0e0;">
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">#</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">Дата</th>
              <th style="padding:12px; text-align:left; font-size:13px; color:#666;">💸 Описание</th>
              <th style="padding:12px; text-align:right; font-size:13px; color:#666;">💰 Сумма</th>
              <th style="padding:12px; text-align:center; font-size:13px; color:#666;">Действия</th>
            </tr>
          </thead>
          <tbody id="expensesReportBody">
            <!-- Данные загружаются динамически -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Модальное окно добавления расхода -->
  <div id="addExpenseModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:3003; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:500px; border-radius:12px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <div style="background:linear-gradient(135deg, #dc3545 0%, #c82333 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0; font-size:22px;">💸 Добавить расход</h2>
        <button onclick="closeAddExpenseModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>
      
      <div style="padding:20px;">
        <div style="margin-bottom:15px;">
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Описание расхода:</label>
          <input type="text" id="expenseDescription" placeholder="Например: Аренда, зарплата, бензин" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
        </div>
        
        <div style="margin-bottom:15px;">
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Сумма (сом):</label>
          <input type="number" id="expenseAmount" placeholder="0" min="0" step="0.01" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="display:block; margin-bottom:8px; font-weight:600; color:#333;">Дата:</label>
          <input type="date" id="expenseDate" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:16px;">
        </div>
        
        <button onclick="saveExpense()" style="width:100%; padding:14px; background:linear-gradient(135deg, #dc3545 0%, #c82333 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:16px;">💾 Сохранить расход</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно детального просмотра заказов клиента -->
  <div id="clientOrdersDetailModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:3002; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:900px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- Заголовок -->
      <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:22px;" id="clientDetailName">Заказы клиента</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;" id="clientDetailInfo">Информация о заказах</p>
        </div>
        <button onclick="closeClientOrdersDetailModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Сводка -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0;">
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
          <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">📦 Всего заказов</div>
            <div style="font-size:24px; font-weight:700; color:#007bff;" id="clientDetailTotalOrders">0</div>
          </div>
          <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">💰 Общая сумма продаж</div>
            <div style="font-size:24px; font-weight:700; color:#6c757d;" id="clientDetailTotalSale">0 сом</div>
          </div>
          <div style="background:white; padding:15px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
            <div style="font-size:12px; color:#666; margin-bottom:5px;">📊 Общая прибыль</div>
            <div style="font-size:24px; font-weight:700; color:#28a745;" id="clientDetailTotalProfit">0 сом</div>
          </div>
        </div>
      </div>

      <!-- Список заказов -->
      <div id="clientOrdersDetailList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка...</div>
      </div>
    </div>
  </div>

  <!-- Модальное окно для просмотра товаров заказа -->
  <div id="orderItemsDetailModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:3002; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:900px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- Заголовок -->
      <div style="background:linear-gradient(135deg, #007bff 0%, #0056b3 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:22px;" id="orderItemsDetailTitle">Товары в заказе</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:14px;" id="orderItemsDetailInfo">Информация о заказе</p>
        </div>
        <button onclick="closeOrderItemsDetailModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- Список товаров -->
      <div id="orderItemsDetailContent" style="flex:1; overflow-y:auto; padding:20px;">
        <div style="text-align:center; color:#999; padding:40px;">Загрузка...</div>
      </div>

      <!-- Кнопки действий -->
      <div style="padding:15px; background:#f8f9fa; border-top:1px solid #e0e0e0; display:flex; gap:10px; justify-content:flex-end;">
        <button id="orderItemsAddBtn" style="padding:10px 20px; background:#17a2b8; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
          ➕ Добавить товар
        </button>
        <button onclick="closeOrderItemsDetailModal()" style="padding:10px 20px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
          Закрыть
        </button>
      </div>
    </div>
  </div>

  <!-- Отдельная панель корзины -->
  <div id="cartPage" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2000;">
    <div style="background:#fff; width:95%; max-width:720px; height:90vh; margin:3vh auto; border-radius:10px; overflow:auto; padding:16px; position:relative;">
      <button onclick="closeCartPage()" style="position:absolute; right:12px; top:12px; font-size:18px;">&times;</button>
      <h2>Ваша корзина</h2>
      <div id="cartPageList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:12px;"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
        <div style="font-weight:700;">Итого: <span id="cartPageTotal">0</span></div>
        <div style="display:flex;gap:8px;">
            <button onclick="closeCartPage()">Продолжить покупки</button>
            <button onclick="(function(){ closeCartPage(); document.querySelector('.order-form').scrollIntoView({behavior:'smooth'}); })()">Оформить заказ</button>
        </div>
      </div>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button id="cartPageClear" style="background:#dc3545;color:#fff;border:none;padding:8px 12px;border-radius:8px;">Очистить корзину</button>
        </div>
    </div>
  </div>

  <script>
 let products = [];
 let isAdmin = false;

// Инициализация Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
  authDomain: "svoysayet.firebaseapp.com",
  projectId: "svoysayet",
  storageBucket: "svoysayet.firebasestorage.app",
  messagingSenderId: "450143000217",
  appId: "1:450143000217:web:7495cefaea0b94966e8a08",
  measurementId: "G-Y8VG9E29FY"
};

// Проверка инициализации Firebase — делаем безопасно и ждём загрузки SDK
let db, storage;
function initFirebase() {
  try {
    if (typeof firebase === 'undefined') throw new Error('Firebase SDK не загружен');
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
    storage = firebase.storage();
    console.log('Firebase initialized successfully');
  } catch (error) {
    console.error('Firebase initialization error:', error);
    Swal.fire('Ошибка', 'Ошибка инициализации Firebase: ' + error.message, 'error');
  }
}

if (typeof firebase !== 'undefined') {
  initFirebase();
} else {
  // Если SDK ещё не загружен — инициализируем после загрузки страницы
  window.addEventListener('load', initFirebase);
}

// ==================== СИСТЕМА УНИКАЛЬНЫХ ID КЛИЕНТОВ ====================

// Генерация или получение уникального ID клиента
let clientId = localStorage.getItem('chatClientId');
let clientName = localStorage.getItem('chatClientName');

// ==================== СИСТЕМА ПАРТНЕРОВ ====================

// Получаем реферальный код из URL (например: ?ref=partner1)
let partnerRef = null;
const urlParams = new URLSearchParams(window.location.search);

if (urlParams.has('ref')) {
  partnerRef = urlParams.get('ref');
  
  // Сохраняем в sessionStorage + localStorage
  const partnerData = {
    name: partnerRef,
    timestamp: Date.now()
  };
  sessionStorage.setItem('partnerData', JSON.stringify(partnerData));
  try {
    localStorage.setItem('partnerData', JSON.stringify(partnerData));
  } catch(e) {}
  
  // Показываем уведомление о партнере
  setTimeout(() => {
    Swal.fire({
      icon: 'info',
      title: 'Добро пожаловать! 🤝',
      html: `Вы перешли по партнерской ссылке <strong>${partnerRef}</strong>.<br><br>Все ваши заказы будут закреплены за этим партнером!`,
      timer: 5000,
      showConfirmButton: true,
      confirmButtonText: 'Понятно'
    });
  }, 1000);
} else {
  // Проверяем есть ли сохраненный партнер
  let savedData = sessionStorage.getItem('partnerData');
  if (!savedData) {
    try { savedData = localStorage.getItem('partnerData'); } catch(e) {}
  }
  
  if (savedData) {
    try {
      const partnerData = JSON.parse(savedData);
      const daysPassed = (Date.now() - partnerData.timestamp) / (1000 * 60 * 60 * 24);
      
      if (daysPassed <= 30) {
        partnerRef = partnerData.name;
      } else {
        sessionStorage.removeItem('partnerData');
        try { localStorage.removeItem('partnerData'); } catch(e) {}
      }
    } catch (e) {
      sessionStorage.removeItem('partnerData');
      try { localStorage.removeItem('partnerData'); } catch(e) {}
    }
  }
}

// Функция для получения текущего партнера
function getCurrentPartner() {
  let savedData = sessionStorage.getItem('partnerData');
  if (!savedData) {
    try { savedData = localStorage.getItem('partnerData'); } catch(e) {}
  }
  if (!savedData) return null;
  
  try {
    const partnerData = JSON.parse(savedData);
    const daysPassed = (Date.now() - partnerData.timestamp) / (1000 * 60 * 60 * 24);
    
    if (daysPassed <= 30) {
      return partnerData.name;
    } else {
      sessionStorage.removeItem('partnerData');
      try { localStorage.removeItem('partnerData'); } catch(e) {}
      return null;
    }
  } catch (e) {
    sessionStorage.removeItem('partnerData');
    try { localStorage.removeItem('partnerData'); } catch(e) {}
    return null;
  }
}

if (!clientId) {
  // Генерируем уникальный ID для нового клиента
  clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('chatClientId', clientId);
  console.log('Создан новый clientId:', clientId);
}

// Функция запроса имени клиента при первом открытии чата
async function ensureClientName() {
  if (!clientName) {
    const { value: name } = await Swal.fire({
      title: 'Представьтесь, пожалуйста',
      input: 'text',
      inputPlaceholder: 'Введите ваше имя',
      showCancelButton: false,
      allowOutsideClick: false,
      confirmButtonText: 'Продолжить',
      inputValidator: (value) => {
        if (!value) {
          return 'Пожалуйста, введите ваше имя!';
        }
      }
    });
    
    if (name) {
      clientName = name;
      localStorage.setItem('chatClientName', name);
      
      // Сохраняем клиента в базе данных
      try {
        if (typeof db !== 'undefined') {
          await db.collection('chatClients').doc(clientId).set({
            name: clientName,
            lastActive: firebase.firestore.FieldValue.serverTimestamp(),
            hasUnread: false
          });
          console.log('Клиент сохранен в базе:', clientName);
        }
      } catch (error) {
        console.error('Ошибка сохранения клиента:', error);
      }
    }
  }
  return clientName;
}

// Обновление активности клиента
async function updateClientActivity() {
  if (typeof db !== 'undefined' && clientId) {
    try {
      await db.collection('chatClients').doc(clientId).set({
        name: clientName || 'Клиент',
        lastActive: firebase.firestore.FieldValue.serverTimestamp(),
        hasUnread: true
      }, { merge: true });
    } catch (error) {
      console.error('Ошибка обновления активности:', error);
    }
  }
}

// Пароль администратора
const ADMIN_PASSWORD = "009860";

// Текущая выбранная категория (по умолчанию "все" = показываем только мелочь)
let currentCategory = 'все';

// Загрузка товаров
async function loadProducts() {
  try {
    console.log('Loading products...');
    let snapshot;
    try {
      snapshot = await db.collection('products').orderBy('order').get();
    } catch (e) {
      // Если нет поля order, загружаем без сортировки
      snapshot = await db.collection('products').get();
    }
    products = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.image) {
        data.image = fixImageUrl(data.image);
      }
      products.push({ id: doc.id, ...data });
    });
    // Если нет сортировки по order, сортируем по названию
    if (!products.every(p => typeof p.order === 'number')) {
      products.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
    } else {
      products.sort((a, b) => (a.order || 0) - (b.order || 0));
    }
    console.log('Products loaded:', products.length);
    renderProducts();
  } catch (error) {
    console.error('Error loading products:', error);
    Swal.fire('Ошибка', 'Не удалось загрузить товары: ' + error.message, 'error');
  }
}

// Добавляем функцию для проверки и исправления URL изображений
function fixImageUrl(url) {
  if (!url) return 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3EНет фото%3C/text%3E%3C/svg%3E';
  
  // Если это просто имя файла (без пути)
  if (!url.includes('/') && !url.startsWith('http')) {
    // Добавляем путь к локальной директории с изображениями
    return './images/' + url;
  }
  
  return url;
}

// Функция для загрузки изображения в Firebase Storage
async function uploadImageToStorage(file) {
  try {
    console.log('Starting image upload...');
    const storageRef = storage.ref();
    const fileName = `${Date.now()}_${file.name}`;
    const fileRef = storageRef.child(`products/${fileName}`);
    
    console.log('Uploading file:', fileName);
    const snapshot = await fileRef.put(file);
    console.log('Upload completed:', snapshot);
    
    const downloadURL = await fileRef.getDownloadURL();
    console.log('Download URL:', downloadURL);
    
    return downloadURL;
  } catch (error) {
    console.error('Error uploading image:', error);
    throw error;
  }
}


// === Cloudinary upload helper ===
async function uploadToCloudinary(file) {
  const cloudName = 'dya0j6wgv'; // ← ВСТАВЬ СЮДА ИЗ Cloudinary // ← замени на свой cloud_name (позже)
  const uploadPreset = 'mystore_upload';

  const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', uploadPreset);

  const res = await fetch(url, {
    method: 'POST',
    body: formData
  });

  const data = await res.json();
  if (data.secure_url) {
    return data.secure_url;
  } else {
    throw new Error('Ошибка загрузки на Cloudinary');
  }
}


// === Imgur upload helper ===
async function uploadToImgur(file) {
  const clientId = 'YOUR_IMGUR_CLIENT_ID'; // Замените на свой Client-ID с https://api.imgur.com/oauth2/addclient
  const formData = new FormData();
  formData.append('image', file);
  const res = await fetch('https://api.imgur.com/3/image', {
    method: 'POST',
    headers: { Authorization: 'Client-ID ' + clientId },
    body: formData
  });
  const data = await res.json();
  if (data.success && data.data && data.data.link) {
    return data.data.link;
  } else {
    throw new Error('Ошибка загрузки на Imgur');
  }
}

// === Postimages upload helper ===
async function uploadToPostimages(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_session', '');
  formData.append('numfiles', 1);
  formData.append('optsize', 0);
  formData.append('expire', 0);
  const res = await fetch('https://api.postimages.org/1/upload', {
    method: 'POST',
    body: formData
  });
  const data = await res.json();
  if (data && data.direct_link) {
    return data.direct_link;
  } else {
    throw new Error('Ошибка загрузки на Postimages');
  }
}



// Обработчик выбора файлач
// Теперь фото загружается на ImageBB, ссылка подставляется в newImage

document.getElementById('imageFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  const addBtn = document.getElementById('addProductBtn');
  if (file) {
    addBtn.disabled = true;
    document.getElementById('newImage').value = '';
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('imagePreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
    try {
      // const url = await uploadImageToStorage(file); // Отключаем Firebase Storage
      // const url = await uploadToImgur(file); // Отключаем Imgur
      // const url = await uploadToPostimages(file); // Отключаем Postimages
      const url = await uploadToCloudinary(file);
      document.getElementById('newImage').value = url;
      addBtn.disabled = false;
      Swal.fire('Фото загружено на ImageBB!', '', 'success');
      console.log('Image uploaded to ImageBB and url set to newImage input:', url);
    } catch (err) {
      Swal.fire('Ошибка', 'Не удалось загрузить изображение на ImageBB', 'error');
      addBtn.disabled = false;
    }
  }
});

// Обработчик выбора файла из галереи
// Теперь фото из галереи загружается на ImageBB

document.getElementById('galleryFile').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  const addBtn = document.getElementById('addProductBtn');
  if (file) {
    addBtn.disabled = true;
    document.getElementById('newImage').value = '';
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('imagePreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
    try {
      // const url = await uploadImageToStorage(file); // Отключаем Firebase Storage
      // const url = await uploadToImgur(file); // Отключаем Imgur
      // const url = await uploadToPostimages(file); // Отключаем Postimages
      const url = await uploadToCloudinary(file);
      document.getElementById('newImage').value = url;
      addBtn.disabled = false;
      Swal.fire('Фото загружено на ImageBB!', '', 'success');
      console.log('Image from gallery uploaded to ImageBB and url set to newImage input:', url);
    } catch (err) {
      Swal.fire('Ошибка', 'Не удалось загрузить изображение на ImageBB', 'error');
      addBtn.disabled = false;
    }
  }
});

// Автоматический расчет наценки при вводе цен
function setupProfitCalculator() {
  const costPriceInput = document.getElementById('newCostPrice');
  const salePriceInput = document.getElementById('newPrice');
  const profitDisplay = document.getElementById('profitDisplay');
  const profitAmount = document.getElementById('profitAmount');
  const profitPercent = document.getElementById('profitPercent');
  
  function calculateProfit() {
    const costPrice = parseFloat(costPriceInput.value) || 0;
    const salePrice = parseFloat(salePriceInput.value) || 0;
    
    if (costPrice > 0 && salePrice > 0) {
      const profit = salePrice - costPrice;
      const profitPercentage = ((profit / costPrice) * 100).toFixed(2);
      
      profitAmount.textContent = profit.toFixed(2);
      profitPercent.textContent = profitPercentage;
      profitDisplay.style.display = 'block';
      
      // Цветовое обозначение
      if (profit > 0) {
        profitDisplay.style.background = '#e8f5e9';
        profitDisplay.style.color = '#2e7d32';
      } else if (profit < 0) {
        profitDisplay.style.background = '#ffebee';
        profitDisplay.style.color = '#c62828';
      } else {
        profitDisplay.style.background = '#fff3e0';
        profitDisplay.style.color = '#ef6c00';
      }
    } else {
      profitDisplay.style.display = 'none';
    }
  }
  
  if (costPriceInput && salePriceInput) {
    costPriceInput.addEventListener('input', calculateProfit);
    salePriceInput.addEventListener('input', calculateProfit);
  }
}

// Обработчик кнопки добавления товара
// Теперь добавлена автоматическая проверка валидности изображения по URL

document.getElementById('addProductBtn').addEventListener('click', async function() {
  try {
    console.log('Add product button clicked');
    const title = document.getElementById('newTitle').value.trim();
    const costPrice = parseFloat(document.getElementById('newCostPrice').value) || 0;
    const price = +document.getElementById('newPrice').value;
    const category = document.getElementById('newCategory').value;
    const optPrice = +document.getElementById('newOptPrice').value;
    const optQty = +document.getElementById('newOptQty').value;
    const minQty = +document.getElementById('newMinQty').value;
    const urlInput = document.getElementById('newImage').value.trim();
    let imageUrl = '';
    if (urlInput) {
      imageUrl = urlInput;
      console.log('Using manual url:', imageUrl);
    } else {
      imageUrl = document.getElementById('newImage').value.trim();
      if (!imageUrl) {
        Swal.fire('Ошибка', 'Укажите URL изображения или загрузите файл!', 'warning');
        return;
      }
    }

    // Валидация
    if (!title) {
      Swal.fire('Ошибка', 'Введите название товара', 'warning');
      return;
    }
    if (!costPrice || costPrice <= 0) {
      Swal.fire('Ошибка', 'Введите цену закупки', 'warning');
      return;
    }
    if (!price || price <= 0) {
      Swal.fire('Ошибка', 'Введите цену продажи', 'warning');
      return;
    }
    if (price <= costPrice) {
      const result = await Swal.fire({
        title: 'Предупреждение!',
        text: 'Цена продажи меньше или равна цене закупки. Продолжить?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Да, продолжить',
        cancelButtonText: 'Отмена'
      });
      if (!result.isConfirmed) return;
    }

    // --- Индикатор проверки изображения ---
    const addBtn = document.getElementById('addProductBtn');
    addBtn.disabled = true;
    addBtn.textContent = 'Проверка изображения...';
    const isValidImage = await checkImage(imageUrl);
    if (!isValidImage) {
      addBtn.disabled = false;
      addBtn.textContent = 'Добавить товар';
      Swal.fire('Ошибка', 'Изображение не загружается! Проверьте ссылку или попробуйте другой файл/URL.', 'error');
      return;
    }
    addBtn.textContent = 'Добавить товар';
    addBtn.disabled = false;
    // --- конец индикатора ---

    // Находим максимальный order среди товаров
    let maxOrder = 0;
    products.forEach(p => {
      if (typeof p.order === 'number' && p.order > maxOrder) maxOrder = p.order;
    });

    const productData = { 
      title, 
      costPrice,
      price,
      category: category || 'все',
      optPrice: optPrice > 0 ? optPrice : null,
      optQty: optQty > 0 ? optQty : null,
      minQty: minQty > 0 ? minQty : 1,
      image: imageUrl,
      order: maxOrder + 1 
    };
    
    console.log('Adding product to Firestore:', productData);
    const docRef = await db.collection('products').add(productData);
    console.log('Product added with ID:', docRef.id);
    await loadProducts();
    renderProducts();
    Swal.fire('Товар добавлен!', '', 'success');
    await loadProducts();
    // Очистка формы
    document.getElementById('newImage').value = '';
    document.getElementById('newTitle').value = '';
    document.getElementById('newCostPrice').value = '';
    document.getElementById('newPrice').value = '';
    document.getElementById('newCategory').value = '';
    document.getElementById('newOptPrice').value = '';
    document.getElementById('newOptQty').value = '';
    document.getElementById('newMinQty').value = '';
    document.getElementById('imageFile').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('profitDisplay').style.display = 'none';
  } catch (error) {
    console.error('Error details:', error);
    document.getElementById('addProductBtn').disabled = false;
    document.getElementById('addProductBtn').textContent = 'Добавить товар';
    Swal.fire('Ошибка', `Не удалось добавить товар: ${error.message}`, 'error');
  }
});

// Фон сайта установлен в CSS
// (код проверки фона удален, так как файл не используется)

// Инициализация корзины
const cart = JSON.parse(localStorage.getItem('cart')) || [];

const productTable = document.getElementById('productTable');
const search = document.getElementById('search');
const sort = document.getElementById('sort');
const cartList = document.getElementById('cartList');
const totalSum = document.getElementById('totalSum');


// Автозаполнение данных пользователя из localStorage
const userData = JSON.parse(localStorage.getItem('userData') || '{}');
if (userData.name) document.getElementById('name').value = userData.name;
if (userData.phone) document.getElementById('phone').value = userData.phone;
if (userData.address) document.getElementById('address').value = userData.address;

// Функция фильтрации по категориям
function filterByCategory(category) {
  currentCategory = category;
  
  // Обновляем активную кнопку
  const buttons = document.querySelectorAll('.category-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Перерисовываем товары
  renderProducts();
}

function addToCart(id, title, price, image, btn) {
  // Поддержка двух вариантов верстки: карточки (.product-card) и старые таблицы
  const card = btn.closest && btn.closest('.product-card');
  const container = card || (btn.parentElement && btn.parentElement.parentElement) || document;

  let qtyInput = null;
  if (container && container.querySelector) {
    qtyInput = container.querySelector('.card-qty-input') || container.querySelector('input');
  }

  let qty = 1;
  if (qtyInput) {
    qty = parseInt(qtyInput.value, 10) || 1;
  }

  const product = products.find(p => p.id === id) || {};

  if (qty < (product.minQty || 1)) {
    Swal.fire('Ошибка', `Минимальное количество для покупки: ${product.minQty || 1}`, 'warning');
    if (qtyInput) qtyInput.value = product.minQty || 1;
    return;
  }

  // Проверка кратности для категории "скотч"
  if (product.category === 'скотч' && product.minQty && product.minQty > 1) {
    if (qty % product.minQty !== 0) {
      Swal.fire({
        icon: 'warning',
        title: 'Ошибка количества',
        html: `Товары категории "Скотч" можно купить только кратно <b>${product.minQty}</b> шт.<br><br>Например: ${product.minQty}, ${product.minQty * 2}, ${product.minQty * 3} шт.`,
        confirmButtonText: 'Понятно'
      });
      if (qtyInput) qtyInput.value = product.minQty;
      return;
    }
  }

  // Считаем итоговое количество этого товара в корзине
  const index = cart.findIndex(item => item.id === id);
  let totalQty = qty;
  if (index !== -1) totalQty += cart[index].qty;

  // Определяем цену: если опт, то оптовая цена
  let finalPrice = price;
  if (product.optQty && totalQty >= product.optQty && product.optPrice) {
    finalPrice = product.optPrice;
  }

  // Добавление или обновление в корзине
  if (index !== -1) {
    cart[index].qty += qty;
    cart[index].price = (product.optQty && cart[index].qty >= product.optQty && product.optPrice)
      ? product.optPrice
      : product.price || price;
  } else {
    cart.push({ id, title, price: finalPrice, qty, image, costPrice: product.costPrice || 0 });
  }

  updateCart();

  btn.classList.add('animate-add');
  setTimeout(() => btn.classList.remove('animate-add'), 500);

  Swal.fire({
    title: 'Товар добавлен в корзину!',
    text: `${title} × ${qty} был добавлен в вашу корзину.`,
    icon: 'success',
    confirmButtonText: 'Ок',
    position: 'bottom',
    showConfirmButton: true,
    timer: 1500,
    padding: '10px',
    toast: true
  });

  localStorage.setItem('cart', JSON.stringify(cart));
}

function updateCart() {
  // Показываем подсказку о прокрутке, если товаров больше 4
  let scrollHint = document.getElementById('cartScrollHint');
  if (!scrollHint) {
    scrollHint = document.createElement('div');
    scrollHint.id = 'cartScrollHint';
    scrollHint.className = 'cart-scroll-hint';
    cartList.parentNode.insertBefore(scrollHint, cartList);
  }
  if (cart.length > 4) {
    scrollHint.textContent = 'Прокрутите список товаров ↓';
    scrollHint.style.display = '';
  } else {
    scrollHint.style.display = 'none';
  }
  cartList.innerHTML = '';

  let total = 0;

  cart.forEach((item, i) => {
    // Пересчитываем цену для каждого товара в корзине
    const product = products.find(p => p.id === item.id);
    if (product) {
    if (product.optQty && item.qty >= product.optQty && product.optPrice) {
  item.price = product.optPrice;
} else {
  item.price = product.price;
}

    }
    total += item.qty * item.price;

    // Мини-фото (если есть)
    const imgSrc = (product && product.image) ? product.image : 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3EНет фото%3C/text%3E%3C/svg%3E';
    const div = document.createElement('div');
    div.classList.add('cart-item', 'cart-item-compact');
    div.innerHTML = `
      <img src="${imgSrc}" alt="" class="cart-mini-img" style="cursor:pointer;" onclick="showPreview('${imgSrc}')">
      <div class="cart-info-row" style="display:flex;align-items:center;flex:1 1 auto;gap:8px;min-width:0;">
        <span class="cart-title" style="flex:1 1 0;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.title}</span>
  <span class="cart-qty" style="white-space:nowrap;">×${item.qty}</span>
  <span class="cart-price" style="white-space:nowrap;">${item.price} сом</span>
  <span class="cart-sum" style="white-space:nowrap;font-weight:bold;">${item.qty * item.price} сом</span>
      </div>
      <button class="delete-item" onclick="removeFromCart(${i})">&times;</button>
    `;
    cartList.appendChild(div);
  });

  totalSum.textContent = total + ' сом';

  // Если открыта страница корзины, обновим её
  if (document.getElementById('cartPage') && document.getElementById('cartPage').style.display !== 'none') {
    renderCartPage();
  }

  // Показываем/скрываем кнопку очистки в панели корзины, если она есть
  const cartPageClearBtn = document.getElementById('cartPageClear');
  if (cartPageClearBtn) {
    cartPageClearBtn.style.display = cart.length === 0 ? 'none' : 'inline-block';
  }

  localStorage.setItem('cart', JSON.stringify(cart));
}

function removeFromCart(i) {
  // Анимация удаления
  const cartList = document.getElementById('cartList');
  const itemDiv = cartList.children[i];
  if (itemDiv) {
    itemDiv.classList.add('cart-item-removing');
    setTimeout(() => {
      cart.splice(i, 1);
      updateCart();
    }, 300);
  } else {
    cart.splice(i, 1);
    updateCart();
  }
}

// Открыть отдельную страницу-панель корзины
function openCartPage() {
  renderCartPage();
  document.getElementById('cartPage').style.display = '';
}

function closeCartPage() {
  document.getElementById('cartPage').style.display = 'none';
}

function renderCartPage() {
  const list = document.getElementById('cartPageList');
  const totalEl = document.getElementById('cartPageTotal');
  list.innerHTML = '';
  let total = 0;
  cart.forEach((item, i) => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.gap = '10px';
    div.style.alignItems = 'center';
    div.innerHTML = `
      <img src="${item.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3EНет фото%3C/text%3E%3C/svg%3E'}" style="width:64px;height:64px;object-fit:cover;border-radius:6px;"> 
      <div style="flex:1;min-width:0;">
        <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.title}</div>
        <div style="color:#666;">${item.qty} × ${item.price} сом</div>
      </div>
      <div style="font-weight:700;">${item.qty * item.price} сом</div>
      <div style="display:flex;flex-direction:column;gap:6px;margin-left:8px;">
        <button onclick="removeFromCart(${i})" style="background:#dc3545;color:#fff;border:none;padding:6px 8px;border-radius:6px;">Удалить</button>
      </div>
    `;
    list.appendChild(div);
    total += item.qty * item.price;
  });
  totalEl.textContent = total + ' сом';
}

// Инициализация корзины и привязки при загрузке страницы
// НЕ блокируем никакие touch события - разрешаем нормальную прокрутку

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing...');
  
  // Автозаполнение поля "Кто порекомендовал"
  const referredByInput = document.getElementById('referredBy');
  if (referredByInput) {
    try {
      const savedReferredBy = localStorage.getItem('savedReferredBy');
      if (savedReferredBy && !getCurrentPartner()) {
        // Заполняем только если нет партнера из URL
        referredByInput.value = savedReferredBy;
        referredByInput.style.borderColor = '#28a745';
        referredByInput.style.background = '#f0fff4';
      }
    } catch(e) {}
  }
  
  // КРИТИЧЕСКИ ВАЖНО: Принудительно включаем прокрутку
  function forceEnableScroll() {
    // Удаляем все что может блокировать
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('overflow-y');
    document.body.style.removeProperty('position');
    document.body.style.removeProperty('height');
    
    document.documentElement.style.removeProperty('overflow');
    document.documentElement.style.removeProperty('overflow-y');
    document.documentElement.style.removeProperty('height');
    
    // Устанавливаем правильные значения
    document.body.style.cssText += 'overflow: visible !important; overflow-y: visible !important; position: relative !important; height: auto !important; min-height: 100vh !important;';
    document.documentElement.style.cssText += 'overflow: visible !important; overflow-y: scroll !important; height: auto !important;';
    
    // Удаляем класс modal-open если он есть
    document.body.classList.remove('modal-open');
  }
  
  // Вызываем сразу
  forceEnableScroll();
  
  // Повторяем через небольшую задержку
  setTimeout(forceEnableScroll, 100);
  setTimeout(forceEnableScroll, 500);
  setTimeout(forceEnableScroll, 1000);
  
  // Добавляем агрессивный наблюдатель
  const observer = new MutationObserver(function() {
    if (document.body.style.overflow === 'hidden' || 
        document.body.style.overflowY === 'hidden' ||
        document.documentElement.style.overflow === 'hidden') {
      console.warn('⚠️ Обнаружена блокировка прокрутки - отменяем!');
      forceEnableScroll();
    }
  });
  
  observer.observe(document.body, {
    attributes: true,
    attributeFilter: ['style', 'class']
  });
  
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['style', 'class']
  });
  
  try {
    // Привязываем кнопку очистки в панели корзины, если она есть
    const cartPageClear = document.getElementById('cartPageClear');
    if (cartPageClear) {
      cartPageClear.addEventListener('click', function() {
        cart.length = 0;
        localStorage.removeItem('cart');
        updateCart();
        closeCartPage();
        if (window.Swal) Swal.fire('Готово', 'Корзина очищена', 'success');
      });
    }

    loadProducts();
    updateCart(); // Обновляем отображение корзины
    
    // Инициализируем калькулятор прибыли
    setupProfitCalculator();
    
    // Если уже был вход как админ (например, после обновления), показать панель
    if (isAdmin) {
      const adminPanel = document.getElementById('adminPanel');
      if (adminPanel) adminPanel.style.display = '';
    }
    
    // Обработчик кнопки выхода из профиля
    const logoutBtn = document.getElementById('logoutUser');
    if (logoutBtn) {
      console.log('Кнопка выхода найдена, привязываем обработчик');
      logoutBtn.addEventListener('click', function() {
        console.log('Клик по кнопке выхода');
        isAdmin = false;
        
        // Безопасная работа с элементами - проверяем существование
        const adminAddProduct = document.getElementById('adminAddProduct');
        if (adminAddProduct) adminAddProduct.style.display = 'none';
        
        const adminAuth = document.getElementById('adminAuth');
        if (adminAuth) adminAuth.style.display = 'block';
        
        const managementHeader = document.getElementById('managementHeader');
        if (managementHeader) managementHeader.style.display = 'none';
        
        const adminPassword = document.getElementById('adminPassword');
        if (adminPassword) adminPassword.value = '';
        
        localStorage.removeItem('userData');
        
        const nameField = document.getElementById('name');
        if (nameField) nameField.value = '';
        
        const phoneField = document.getElementById('phone');
        if (phoneField) phoneField.value = '';
        
        const addressField = document.getElementById('address');
        if (addressField) addressField.value = '';
        
        Swal.fire('Вы вышли из профиля');
        renderProducts();
        
        // Скрываем админ-панель
        const adminPanel = document.getElementById('adminPanel');
        if (adminPanel) adminPanel.style.display = 'none';
      });
    } else {
      console.log('Кнопка выхода НЕ найдена');
    }
  } catch (error) {
    console.error('Error during initialization:', error);
    Swal.fire('Ошибка', 'Ошибка при загрузке страницы: ' + error.message, 'error');
  }
});

document.getElementById('submitOrder').onclick = async () => {
  const submitBtn = document.getElementById('submitOrder');
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const address = document.getElementById('address').value.trim();
  const referredBy = document.getElementById('referredBy').value.trim();

  if (!name || !phone || !address || cart.length === 0) {
    Swal.fire('Ошибка', 'Заполните все поля и добавьте товары', 'warning');
    return;
  }

  // Блокируем кнопку
  submitBtn.disabled = true;
  submitBtn.style.opacity = '0.5';
  submitBtn.style.cursor = 'not-allowed';
  const originalText = submitBtn.textContent;
  submitBtn.textContent = 'Отправка...';

  try {
    const items = cart.map(i => `${i.title} — ${i.qty}×${i.price} сом = ${i.qty * i.price} сом`).join('\n');
    const total = cart.reduce((sum, item) => sum + item.qty * item.price, 0);
    const currentTime = new Date().toLocaleString();

    // Получаем партнера из URL (если есть) или из поля формы
    let partner = getCurrentPartner();
    if (!partner && referredBy) {
      partner = referredBy; // Если клиент сам указал партнера
    }

    // Сохраняем партнера если клиент указал
    if (referredBy) {
      try {
        localStorage.setItem('savedReferredBy', referredBy);
      } catch(e) {}
    }

    // Сохраняем заказ в Firebase
    await db.collection('orders').add({
      name,
      phone,
      address,
      items: cart.map(item => ({
        id: item.id,
        title: item.title,
        qty: item.qty,
        price: item.price,
        costPrice: item.costPrice || 0
      })),
      total,
      timestamp: Date.now(),
      time: currentTime,
      status: 'Новый',
      partner: partner || null, // Добавляем партнера
      referredBy: referredBy || null // И поле "Кто порекомендовал"
    });

    const msg = `Новый заказ:\nИмя: ${name}\nТелефон: ${phone}\nАдрес: ${address}\nТовары:\n${items}\n\nИтого: ${total} сом`;

    // СРАЗУ показываем успех клиенту
    Swal.fire('Успех!', 'Ваш заказ принят и отправляется!', 'success');
    
    // Разблокируем кнопку после показа успеха
    submitBtn.disabled = false;
    submitBtn.style.opacity = '1';
    submitBtn.style.cursor = 'pointer';
    submitBtn.textContent = originalText;
    
    // Копируем данные для фоновой отправки
    const orderData = {
      name: name,
      phone: phone,
      address: address,
      cart: [...cart],
      total: total,
      currentTime: currentTime
    };
    
    // Очищаем корзину сразу
    cart.length = 0;
    updateCart();
    localStorage.removeItem('cart');
    
    // Сохраняем данные пользователя
    localStorage.setItem('userData', JSON.stringify({
      name,
      phone,
      address
    }));

    // Очищаем форму
    document.getElementById('name').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('address').value = '';
    
    // Отправка файлов в фоновом режиме (без await)
    sendOrderAsExcel(orderData.name, orderData.phone, orderData.address, orderData.cart, orderData.total, orderData.currentTime)
      .then(() => console.log('Excel отправлен успешно'))
      .catch(err => console.error('Ошибка отправки Excel:', err));
    
    sendOrderAsPDF(orderData.name, orderData.phone, orderData.address, orderData.cart, orderData.total, orderData.currentTime)
      .then(() => console.log('PDF отправлен успешно'))
      .catch(err => console.error('Ошибка отправки PDF:', err));

  } catch (error) {
    console.error('Error submitting order:', error);
    Swal.fire('Ошибка', 'Не удалось отправить заказ. Попробуйте позже.', 'error');
    
    // Разблокируем кнопку при ошибке
    submitBtn.disabled = false;
    submitBtn.style.opacity = '1';
    submitBtn.style.cursor = 'pointer';
    submitBtn.textContent = originalText;
  }
};

// Функция отправки заказа как PDF файл в Telegram
async function sendOrderAsPDF(name, phone, address, cartItems, total, time) {
  try {
    console.log('=== Начало создания PDF файла ===');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPosition = 20;
    
    // Заголовок
    const headerCanvas = document.createElement('canvas');
    const headerCtx = headerCanvas.getContext('2d');
    headerCanvas.width = 600;
    headerCanvas.height = 50;
    
    headerCtx.fillStyle = 'white';
    headerCtx.fillRect(0, 0, headerCanvas.width, headerCanvas.height);
    headerCtx.fillStyle = 'black';
    headerCtx.font = 'bold 24px Arial';
    headerCtx.textAlign = 'center';
    headerCtx.fillText('НОВЫЙ ЗАКАЗ', 300, 35);
    
    const headerImage = headerCanvas.toDataURL('image/png');
    doc.addImage(headerImage, 'PNG', 20, yPosition, 170, 15);
    
    yPosition += 20;
    
    // Информация о заказе в рамке
    const infoCanvas = document.createElement('canvas');
    const infoCtx = infoCanvas.getContext('2d');
    infoCanvas.width = 700;
    infoCanvas.height = 120;
    
    // Белый фон с черной рамкой
    infoCtx.fillStyle = 'white';
    infoCtx.fillRect(0, 0, infoCanvas.width, infoCanvas.height);
    infoCtx.strokeStyle = 'black';
    infoCtx.lineWidth = 2;
    infoCtx.strokeRect(0, 0, infoCanvas.width, infoCanvas.height);
    
    // Текст
    infoCtx.fillStyle = 'black';
    infoCtx.font = '16px Arial';
    infoCtx.fillText(`Дата/Время: ${time}`, 15, 30);
    infoCtx.fillText(`Имя клиента: ${name}`, 15, 55);
    infoCtx.fillText(`Телефон: ${phone}`, 15, 80);
    infoCtx.fillText(`Адрес: ${address}`, 15, 105);
    
    const infoImage = infoCanvas.toDataURL('image/png');
    doc.addImage(infoImage, 'PNG', 20, yPosition, 170, 30);
    
    yPosition += 35;
    
    // Заголовок таблицы с сеткой
    const tableHeaderCanvas = document.createElement('canvas');
    const thCtx = tableHeaderCanvas.getContext('2d');
    tableHeaderCanvas.width = 550;
    tableHeaderCanvas.height = 50;
    
    // Серый фон для заголовка
    thCtx.fillStyle = '#e0e0e0';
    thCtx.fillRect(0, 0, tableHeaderCanvas.width, tableHeaderCanvas.height);
    
    // Рамка
    thCtx.strokeStyle = 'black';
    thCtx.lineWidth = 2;
    thCtx.strokeRect(0, 0, tableHeaderCanvas.width, tableHeaderCanvas.height);
    
    // Вертикальные линии (колонки: Фото | Название | Кол-во | Цена | Сумма)
    thCtx.beginPath();
    thCtx.moveTo(90, 0);
    thCtx.lineTo(90, 50);
    thCtx.moveTo(310, 0);
    thCtx.lineTo(310, 50);
    thCtx.moveTo(390, 0);
    thCtx.lineTo(390, 50);
    thCtx.moveTo(470, 0);
    thCtx.lineTo(470, 50);
    thCtx.stroke();
    
    // Текст заголовков
    thCtx.fillStyle = 'black';
    thCtx.font = 'bold 14px Arial';
    thCtx.textAlign = 'center';
    thCtx.fillText('ФОТО', 45, 32);
    thCtx.fillText('НАЗВАНИЕ', 200, 32);
    thCtx.fillText('КОЛ-ВО', 350, 32);
    thCtx.fillText('ЦЕНА', 430, 32);
    thCtx.fillText('СУММА', 510, 32);
    
    const tableHeaderImage = tableHeaderCanvas.toDataURL('image/png');
    doc.addImage(tableHeaderImage, 'PNG', 20, yPosition, 170, 12);
    
    yPosition += 12;
    
    // Товары с сеткой
    for (let i = 0; i < cartItems.length; i++) {
      const item = cartItems[i];
      
      // Проверяем, не выходим ли за страницу
      if (yPosition > 240) {
        doc.addPage();
        yPosition = 20;
      }
      
      // Загружаем фото и определяем его размеры
      let photoWidth = 90;  // По умолчанию
      let photoHeight = 90;
      let photoData = null;
      
      if (item.image && item.image.startsWith('http')) {
        try {
          const response = await fetch(item.image);
          const blob = await response.blob();
          
          const reader = new FileReader();
          const base64 = await new Promise((resolve) => {
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
          
          photoData = base64;
          
          // Определяем размеры фото
          const img = new Image();
          await new Promise((resolve) => {
            img.onload = resolve;
            img.src = base64;
          });
          
          // Рассчитываем размеры фото чтобы влезло в ячейку, сохраняя пропорции
          const maxPhotoWidth = 100;
          const maxPhotoHeight = 100;
          
          let finalWidth = img.width;
          let finalHeight = img.height;
          
          // Масштабируем если фото слишком большое
          if (finalWidth > maxPhotoWidth || finalHeight > maxPhotoHeight) {
            const scale = Math.min(maxPhotoWidth / finalWidth, maxPhotoHeight / finalHeight);
            finalWidth = finalWidth * scale;
            finalHeight = finalHeight * scale;
          }
          
          photoWidth = finalWidth;
          photoHeight = finalHeight;
          
          console.log('✓ Фото загружено:', item.title, `Размер: ${photoWidth.toFixed(0)}x${photoHeight.toFixed(0)}`);
        } catch (err) {
          console.error('✗ Ошибка фото:', item.title, err);
          photoWidth = 90;
          photoHeight = 90;
        }
      }
      
      // Высота строки = высота фото + отступы
      const rowHeight = Math.max(photoHeight + 10, 100);
      
      // Создаем строку таблицы с динамической шириной
      const rowCanvas = document.createElement('canvas');
      const rowCtx = rowCanvas.getContext('2d');
      const photoColumnWidth = Math.max(photoWidth + 10, 70); // Ширина колонки фото
      const totalWidth = photoColumnWidth + 480; // фото + остальные колонки
      rowCanvas.width = totalWidth;
      rowCanvas.height = rowHeight;
      
      // Белый фон
      rowCtx.fillStyle = 'white';
      rowCtx.fillRect(0, 0, rowCanvas.width, rowCanvas.height);
      
      // Рамка строки
      rowCtx.strokeStyle = 'black';
      rowCtx.lineWidth = 2;
      rowCtx.strokeRect(0, 0, rowCanvas.width, rowCanvas.height);
      
      // Вертикальные линии
      const col2 = photoColumnWidth;
      const col3 = photoColumnWidth + 240;
      const col4 = photoColumnWidth + 320;
      const col5 = photoColumnWidth + 400;
      
      rowCtx.beginPath();
      rowCtx.moveTo(col2, 0);
      rowCtx.lineTo(col2, rowHeight);
      rowCtx.moveTo(col3, 0);
      rowCtx.lineTo(col3, rowHeight);
      rowCtx.moveTo(col4, 0);
      rowCtx.lineTo(col4, rowHeight);
      rowCtx.moveTo(col5, 0);
      rowCtx.lineTo(col5, rowHeight);
      rowCtx.stroke();
      
      // Текст в ячейках
      rowCtx.fillStyle = 'black';
      rowCtx.font = '13px Arial';
      rowCtx.textAlign = 'center';
      
      const midY = rowHeight / 2;
      
      // Название (с переносом если длинное)
      rowCtx.textAlign = 'left';
      const title = item.title;
      if (title.length > 28) {
        rowCtx.fillText(title.substring(0, 28), col2 + 5, midY - 5);
        rowCtx.fillText(title.substring(28), col2 + 5, midY + 10);
      } else {
        rowCtx.fillText(title, col2 + 5, midY);
      }
      
      // Количество
      rowCtx.textAlign = 'center';
      rowCtx.fillText(`${item.qty} шт`, (col3 + col4) / 2, midY);
      
      // Цена
      rowCtx.fillText(`${item.price}`, (col4 + col5) / 2, midY - 5);
      rowCtx.font = '11px Arial';
      rowCtx.fillText('сом', (col4 + col5) / 2, midY + 8);
      
      // Сумма
      rowCtx.font = 'bold 13px Arial';
      rowCtx.fillText(`${item.qty * item.price}`, (col5 + totalWidth) / 2, midY - 5);
      rowCtx.font = '11px Arial';
      rowCtx.fillText('сом', (col5 + totalWidth) / 2, midY + 8);
      
      const rowImage = rowCanvas.toDataURL('image/png');
      const rowPdfHeight = rowHeight * 170 / totalWidth; // Пропорционально
      doc.addImage(rowImage, 'PNG', 20, yPosition, 170, rowPdfHeight);
      
      // Добавляем фото товара поверх ячейки - ПОЛНОЕ фото без обрезки
      if (photoData) {
        const photoWidthPdf = photoWidth * 170 / totalWidth;
        const photoHeightPdf = photoHeight * 170 / totalWidth;
        const xPos = 22 + (photoColumnWidth * 170 / totalWidth - photoWidthPdf) / 2; // Центрируем
        const yPos = yPosition + (rowPdfHeight - photoHeightPdf) / 2; // Центрируем
        doc.addImage(photoData, 'JPEG', xPos, yPos, photoWidthPdf, photoHeightPdf);
      }
      
      yPosition += rowPdfHeight;
    }
    
    // Строка ИТОГО с сеткой
    const totalCanvas = document.createElement('canvas');
    const totalCtx = totalCanvas.getContext('2d');
    totalCanvas.width = 550;
    totalCanvas.height = 60;
    
    // Желтый фон для итого
    totalCtx.fillStyle = '#fff9c4';
    totalCtx.fillRect(0, 0, totalCanvas.width, totalCanvas.height);
    
    // Рамка
    totalCtx.strokeStyle = 'black';
    totalCtx.lineWidth = 3;
    totalCtx.strokeRect(0, 0, totalCanvas.width, totalCanvas.height);
    
    // Вертикальная линия
    totalCtx.beginPath();
    totalCtx.moveTo(470, 0);
    totalCtx.lineTo(470, 60);
    totalCtx.stroke();
    
    // Текст
    totalCtx.fillStyle = 'black';
    totalCtx.font = 'bold 18px Arial';
    totalCtx.textAlign = 'right';
    totalCtx.fillText('ИТОГО:', 450, 38);
    
    totalCtx.textAlign = 'center';
    totalCtx.fillText(`${total}`, 510, 32);
    totalCtx.font = '14px Arial';
    totalCtx.fillText('сом', 510, 48);
    
    const totalImage = totalCanvas.toDataURL('image/png');
    doc.addImage(totalImage, 'PNG', 20, yPosition, 170, 15);
    
    console.log('Генерируем PDF файл...');
    
    // Генерируем PDF как blob
    const pdfBlob = doc.output('blob');
    
    console.log('PDF файл сгенерирован, размер:', pdfBlob.size, 'байт');
    
    // Отправляем в Telegram
    const formData = new FormData();
    formData.append('chat_id', '5567924440');
    formData.append('document', pdfBlob, `Заказ_${name}_${Date.now()}.pdf`);
    formData.append('caption', `📷 Заказ с фото от ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData
    });

    // Отправляем второму пользователю
    const formData2 = new FormData();
    formData2.append('chat_id', '246421345');
    formData2.append('document', pdfBlob, `Заказ_${name}_${Date.now()}.pdf`);
    formData2.append('caption', `📷 Заказ с фото от ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData2
    });

    console.log('PDF файл отправлен в Telegram');
  } catch (error) {
    console.error('Ошибка отправки PDF:', error);
  }
}

// Функция отправки заказа как Excel файл в Telegram
async function sendOrderAsExcel(name, phone, address, cartItems, total, time) {
  try {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Заказ');

    // Заголовок
    worksheet.addRow(['НОВЫЙ ЗАКАЗ']);
    worksheet.addRow([]);
    worksheet.addRow(['Дата/Время:', time]);
    worksheet.addRow(['Имя клиента:', name]);
    worksheet.addRow(['Телефон:', phone]);
    worksheet.addRow(['Адрес:', address]);
    worksheet.addRow([]);
    
    // Таблица товаров
    const headerRow = worksheet.addRow(['Название товара', 'Количество', 'Цена за шт.', 'Сумма']);
    
    cartItems.forEach(item => {
      const row = worksheet.addRow([
        item.title,
        `${item.qty} шт`,
        `${item.price} сом`,
        `${item.qty * item.price} сом`
      ]);
      // Выравниваем количество по центру
      row.getCell(2).alignment = { horizontal: 'center', vertical: 'middle' };
    });
    
    worksheet.addRow([]);
    const totalRow = worksheet.addRow(['ИТОГО:', '', '', `${total} сом`]);

    // Стилизация
    worksheet.getRow(1).font = { size: 16, bold: true };
    headerRow.font = { bold: true };
    totalRow.font = { bold: true };
    
    // Выравниваем заголовки по центру
    headerRow.eachCell((cell) => {
      cell.alignment = { horizontal: 'center', vertical: 'middle' };
    });
    
    worksheet.columns = [
      { width: 30 },
      { width: 15 },
      { width: 15 },
      { width: 15 }
    ];

    // Генерируем файл
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    
    // Отправляем в Telegram через FormData
    const formData = new FormData();
    formData.append('chat_id', '5567924440');
    formData.append('document', blob, `Заказ_${name}_${Date.now()}.xlsx`);
    formData.append('caption', `📊 Excel заказ от ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData
    });

    // Отправляем второму пользователю
    const formData2 = new FormData();
    formData2.append('chat_id', '246421345');
    formData2.append('document', blob, `Заказ_${name}_${Date.now()}.xlsx`);
    formData2.append('caption', `📊 Excel заказ от ${name}`);

    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData2
    });

    console.log('Excel файл отправлен в Telegram');
  } catch (error) {
    console.error('Ошибка отправки Excel:', error);
  }
}

// Функции истории заказов удалены

search.oninput = renderProducts;
sort.onchange = renderProducts;
renderProducts();
updateCart();

function showPreview(src) {
  document.getElementById('previewImg').src = src;
  document.getElementById('previewBlock').style.display = 'block';
  // Не блокируем прокрутку body
}

document.getElementById('closePreview').onclick = function() {
  document.getElementById('previewBlock').style.display = 'none';
  // Прокрутка всегда разрешена
};

document.getElementById('previewBlock').onclick = function(e) {
  if (e.target === this) {
    this.style.display = 'none';
    // Прокрутка всегда разрешена
  }
};

function updatePriceInRow(input, price, optPrice, optQty) {
  const qty = +input.value;
  const priceCell = input.parentElement.parentElement.querySelector('.price-cell span');
  if (optQty && qty >= optQty && optPrice) {
    priceCell.textContent = optPrice + ' сом';
  } else {
    priceCell.textContent = price + ' сом';
  }
}

// Добавляем функцию для проверки изображений
async function checkImage(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = url;
  });
}

// Функция отображения товаров
function renderProducts() {
  // Рендер карточек в стиле AliExpress
  const container = document.getElementById('productTable');
  container.innerHTML = '';
  let filtered = isAdmin ? products : products.filter(p => !p.blocked);
  
  console.log('Текущая категория:', currentCategory);
  console.log('Всего товаров:', filtered.length);
  
  // Фильтрация по категории (работает одинаково для всех)
  if (currentCategory === 'все') {
    // В разделе "Все товары" показываем товары с категорией "все" или без категории
    filtered = filtered.filter(p => !p.category || p.category.toLowerCase() === 'все');
  } else {
    // В других разделах показываем товары только выбранной категории
    filtered = filtered.filter(p => p.category && p.category.toLowerCase() === currentCategory.toLowerCase());
  }
  
  console.log('После фильтрации:', filtered.length);
  
  const q = (search && search.value) ? search.value.toLowerCase() : '';
  const list = q ? filtered.filter(p => p.title && p.title.toLowerCase().includes(q)) : filtered;

  list.forEach((p, idx) => {
    const card = document.createElement('div');
    card.className = 'product-card';

    // ratings removed per request

    card.innerHTML = `
        <div class="card-image" style="position:relative;">
        ${isAdmin ? `<div style="position:absolute;top:5px;left:5px;background:rgba(0,123,255,0.9);color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;z-index:1;">#${idx + 1}</div>` : ''}
        <img src="${p.image || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23ddd" width="200" height="200"/%3E%3Ctext fill="%23999" x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="18"%3EНет фото%3C/text%3E%3C/svg%3E'}" alt="${p.title || ''}" onclick="showImageModal('${p.image}', '${p.title}')" style="cursor:pointer;" />
      </div>
      <div class="card-body">
        ${isAdmin ? `
          <!-- Компактная информация (всегда видна) -->
          <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#f8f9fa; border-radius:6px; margin-bottom:8px;">
            <div style="font-weight:600; font-size:14px; color:#333;">${p.title||'Товар'}</div>
            <button onclick="toggleProductDetails('product-details-${p.id}')" style="background:#007bff; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px;">▼ Детали</button>
          </div>
          
          <!-- Детальная информация (скрыта по умолчанию) -->
          <div id="product-details-${p.id}" style="display:none;">
            <button onclick="changeProductImage('${p.id}')" style="width:100%; background:#007bff; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-size:13px; margin-bottom:8px; font-weight:600;">📷 Изменить фото</button>
            <div class="card-title"><input value="${p.title||''}" onchange="updateProductTitle('${p.id}', this.value)" class="admin-product-input"/></div>
            <select onchange="updateProductCategory('${p.id}', this.value)" class="admin-product-input" style="font-size:12px;padding:6px;margin:4px 0;">
              <option value="все" ${(p.category||'все')==='все'?'selected':''}>Все товары</option>
              <option value="ножницы" ${(p.category||'')==='ножницы'?'selected':''}>Ножницы</option>
              <option value="скотч" ${(p.category||'')==='скотч'?'selected':''}>Скотч</option>
              <option value="нож" ${(p.category||'')==='нож'?'selected':''}>Нож</option>
            </select>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <input type="number" value="${p.costPrice||0}" onchange="updateProductCostPrice('${p.id}', this.value)" class="admin-product-input" style="width:110px;font-size:13px;color:#666;" placeholder="💵 Закупка" step="0.01"/>
              <input type="number" value="${p.price||0}" onchange="updateProductPrice('${p.id}', this.value)" class="admin-product-input" style="width:110px;font-size:16px;font-weight:700;color:#e53935;" placeholder="💰 Продажа"/>
              ${p.costPrice && p.price ? `<div style="font-size:11px;font-weight:700;width:100%;color:${(p.price - p.costPrice) > 0 ? '#2e7d32' : '#c62828'};">📊 Прибыль: +${(p.price - p.costPrice).toFixed(2)} сом (${(((p.price - p.costPrice) / p.costPrice) * 100).toFixed(1)}%)</div>` : ''}
            </div>
            <div class="card-opt-info" data-opt-id="${p.id}" style="font-size:12px;color:#007bff;margin-top:4px;">
              ${p.optPrice && p.optQty ? `Опт: ${p.optPrice} сом при ${p.optQty} шт` : ''}
            </div>
            <div class="card-actions" style="display:flex;gap:4px;flex-wrap:wrap;margin-top:8px;">
              <button onclick="showMoveProductModal('${p.id}')" style="background:#28a745;flex:1;padding:10px;font-size:13px;" title="Переместить товар">📍 Место</button>
              <button onclick="deleteProduct('${p.id}')" style="background:#dc3545;flex:1;padding:10px;font-size:13px;">Удалить</button>
              <button onclick="toggleProductBlock('${p.id}', ${p.blocked||false})" style="background:${p.blocked?'#ffc107':'#6c757d'};flex:1;padding:10px;font-size:13px;">${p.blocked?'Разблок':'Заблок'}</button>
              <button onclick="showEditWholesaleModal('${p.id}')" style="background:#17a2b8;flex:1;padding:10px;font-size:13px;">Опт</button>
            </div>
          </div>
        ` : `
          <div class="card-title"><div>${p.title||''}</div></div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <div class="card-price">${p.price || '0'} сом</div>
            ${p.oldPrice ? `<div class="card-oldprice">${p.oldPrice} сом</div>` : ''}
          </div>
          <div class="card-opt-info" data-opt-id="${p.id}" style="font-size:12px;color:#007bff;margin-top:4px;">
            ${p.optPrice && p.optQty ? `Опт: ${p.optPrice} сом при ${p.optQty} шт` : ''}
          </div>
          <div class="card-actions">
            <input type="number" min="${p.minQty||1}" value="${p.minQty||1}" class="card-qty-input" style="text-align:center; font-size:16px;" oninput="updateCardPrice(this, '${p.id}')" />
            <button onclick="addToCart('${p.id}','${p.title}',${p.price},'${p.image}', this)">Купить</button>
          </div>
        `}
      </div>
    `;

    container.appendChild(card);
    // Непосредственно обновляем цену на карточке в зависимости от текущего значения поля количества
    try {
      const qtyInput = card.querySelector('.card-qty-input');
      if (qtyInput) updateCardPrice(qtyInput, p.id);
    } catch (e) {
      console.error('updateCardPrice init error', e);
    }
  });

}

// Переключение видимости деталей товара для админа
function toggleProductDetails(detailsId) {
  const detailsDiv = document.getElementById(detailsId);
  if (detailsDiv) {
    const isHidden = detailsDiv.style.display === 'none';
    detailsDiv.style.display = isHidden ? 'block' : 'none';
    
    // Меняем стрелку на кнопке
    const btn = event.target;
    if (btn && btn.tagName === 'BUTTON') {
      btn.textContent = isHidden ? '▲ Скрыть' : '▼ Детали';
    }
  }
}

// Развернуть все товары
function expandAllProducts() {
  const allDetails = document.querySelectorAll('[id^="product-details-"]');
  allDetails.forEach(detail => {
    detail.style.display = 'block';
  });
  
  // Обновляем все кнопки
  const allButtons = document.querySelectorAll('.card-body button[onclick^="toggleProductDetails"]');
  allButtons.forEach(btn => {
    btn.textContent = '▲ Скрыть';
  });
  
  Swal.fire({
    icon: 'success',
    title: 'Готово!',
    text: 'Все товары развернуты',
    timer: 1500,
    showConfirmButton: false
  });
}

// Свернуть все товары
function collapseAllProducts() {
  const allDetails = document.querySelectorAll('[id^="product-details-"]');
  allDetails.forEach(detail => {
    detail.style.display = 'none';
  });
  
  // Обновляем все кнопки
  const allButtons = document.querySelectorAll('.card-body button[onclick^="toggleProductDetails"]');
  allButtons.forEach(btn => {
    btn.textContent = '▼ Детали';
  });
  
  Swal.fire({
    icon: 'success',
    title: 'Готово!',
    text: 'Все товары свернуты',
    timer: 1500,
    showConfirmButton: false
  });
}

// Обновляет отображаемую цену в карточке товара в реальном времени
function updateCardPrice(inputEl, productId) {
  try {
    const qty = parseInt(inputEl.value, 10) || 1;
    const product = products.find(p => p.id === productId) || {};
    const card = inputEl.closest && inputEl.closest('.product-card');
    if (!card) return;
    const priceEl = card.querySelector('.card-price');
    let basePrice = product.price || 0;
    const optPrice = product.optPrice || null;
    const optQty = product.optQty || null;
    const optInfoEl = card.querySelector('.card-opt-info');

    if (optQty && optPrice && qty >= optQty) {
      // Показываем оптовую цену и зачеркнутую розничную
      if (priceEl) priceEl.textContent = optPrice + ' сом';
      // Показать старую цену рядом
      let old = card.querySelector('.card-oldprice');
      if (!old) {
        const span = document.createElement('div');
        span.className = 'card-oldprice';
        span.textContent = basePrice + ' сом';
        span.style.marginLeft = '8px';
        span.style.fontSize = '13px';
        span.style.color = '#888';
        // вставляем после priceEl
        if (priceEl && priceEl.parentNode) priceEl.parentNode.appendChild(span);
      } else {
        old.textContent = basePrice + ' сом';
      }
      if (optInfoEl) {
        optInfoEl.textContent = `Оптовая цена: ${optPrice} сом (при ${optQty} шт)`;
        optInfoEl.style.color = '#d32f2f';
        optInfoEl.style.fontWeight = '700';
      }
    } else {
      // Показываем обычную цену и удаляем oldprice если был
      if (priceEl) priceEl.textContent = basePrice + ' сом';
      const old = card.querySelector('.card-oldprice');
      if (old && old.parentNode) old.parentNode.removeChild(old);
      if (optInfoEl) {
        if (optPrice && optQty) {
          optInfoEl.textContent = `Опт: ${optPrice} сом при ${optQty} шт`;
          optInfoEl.style.color = '#007bff';
          optInfoEl.style.fontWeight = 'normal';
        } else {
          optInfoEl.textContent = '';
        }
      }
    }
  } catch (err) {
    console.error('updateCardPrice error', err);
  }
}

// Галерея-превью по товару: собирает все изображения со страницы и позволяет свайпать
let _gallery = [];
let _galleryIndex = 0;
let _touchStartX = null;

function openPreviewForProduct(productId) {
  // Собираем все реальные src изображений товаров/мини-фото с DOM
  const imgs = Array.from(document.querySelectorAll('#productTable img, .cart-mini-img'));
  _gallery = imgs.map(el => ({ src: el.src, title: el.alt || (el.getAttribute('data-title') || ''), el } )).filter(x => x.src);

  console.log('openPreviewForProduct -> collected images for gallery:', _gallery.map(g=>g.src));

  // Пытаемся найти индекс по productId: сначала ищем элемент, чей src совпадает с продуктовой картинкой
  const prod = products.find(p => p.id === productId);
  let idx = 0;
  if (prod && prod.image) {
    idx = _gallery.findIndex(g => g.src === prod.image);
    if (idx === -1) idx = 0;
  }
  _galleryIndex = idx;
  showGalleryIndex();

  const block = document.getElementById('previewBlock');
  block.style.display = 'block';
  // Не блокируем прокрутку body

  const prevBtn = document.getElementById('prevPreview');
  const nextBtn = document.getElementById('nextPreview');
  if (_gallery.length <= 1) {
    // нет других фото — скрываем стрелки
    if (prevBtn) prevBtn.style.display = 'none';
    if (nextBtn) nextBtn.style.display = 'none';
  } else {
    if (prevBtn) { prevBtn.style.display = ''; prevBtn.onclick = prevGallery; }
    if (nextBtn) { nextBtn.style.display = ''; nextBtn.onclick = nextGallery; }
  }

  const img = document.getElementById('previewImg');
  img.ontouchstart = function(e) { _touchStartX = e.touches[0].clientX; };
  img.ontouchend = function(e) {
    if (_touchStartX == null) return;
    const dx = (e.changedTouches[0].clientX - _touchStartX);
    _touchStartX = null;
    if (dx < -40) nextGallery();
    else if (dx > 40) prevGallery();
  };

  document.addEventListener('keydown', _galleryKeyHandler);
}

function _galleryKeyHandler(e) {
  if (e.key === 'ArrowLeft') prevGallery();
  if (e.key === 'ArrowRight') nextGallery();
  if (e.key === 'Escape') closePreview();
}

function showGalleryIndex() {
  const item = _gallery[_galleryIndex] || { src: '', title: '' };
  const img = document.getElementById('previewImg');
  img.src = item.src;
  document.getElementById('previewCaption').textContent = item.title || '';
}

function prevGallery() {
  if (_gallery.length === 0) return;
  _galleryIndex = (_galleryIndex - 1 + _gallery.length) % _gallery.length;
  showGalleryIndex();
}

function nextGallery() {
  if (_gallery.length === 0) return;
  _galleryIndex = (_galleryIndex + 1) % _gallery.length;
  showGalleryIndex();
}

function closePreview() {
  const block = document.getElementById('previewBlock');
  block.style.display = 'none';
  // Прокрутка всегда разрешена
  try {
    document.getElementById('prevPreview').onclick = null;
    document.getElementById('nextPreview').onclick = null;
    document.getElementById('previewImg').ontouchstart = null;
    document.getElementById('previewImg').ontouchend = null;
    document.removeEventListener('keydown', _galleryKeyHandler);
  } catch (e) {}
}

// Поддержка кнопки закрытия
document.getElementById('closePreview').onclick = function() { closePreview(); };
document.getElementById('previewBlock').onclick = function(e) {
  if (e.target === this) closePreview();
};

// Обработчик входа администратора (старый код удален, теперь используется вход из меню)

// Функция для перемещения товара на выбранную позицию
async function showMoveProductModal(productId) {
  const product = products.find(p => p.id === productId);
  
  if (!product) return;
  
  // Получаем категорию товара
  const productCategory = (product.category || 'все').toLowerCase();
  
  // Фильтруем товары только из той же категории
  const categoryProducts = products.filter(p => {
    const pCategory = (p.category || 'все').toLowerCase();
    return pCategory === productCategory;
  });
  
  // Находим текущую позицию в отфильтрованном списке
  const currentCategoryIndex = categoryProducts.findIndex(p => p.id === productId);
  
  // Создаем список опций для выбора позиции (только товары из этой категории)
  const options = {};
  categoryProducts.forEach((p, idx) => {
    options[idx] = `${idx + 1}. ${p.title}`;
  });
  
  const { value: newCategoryPosition } = await Swal.fire({
    title: 'Переместить товар',
    html: `
      <div style="text-align:left;margin-bottom:15px;">
        <strong>Товар:</strong> ${product.title}<br>
        <strong>Категория:</strong> ${product.category || 'Все товары'}<br>
        <strong>Текущая позиция:</strong> #${currentCategoryIndex + 1} (в категории)
      </div>
      <div style="text-align:left;">
        <strong>Выберите новую позицию в категории:</strong>
      </div>
    `,
    input: 'select',
    inputOptions: options,
    inputPlaceholder: 'Выберите позицию',
    showCancelButton: true,
    confirmButtonText: 'Переместить',
    cancelButtonText: 'Отмена',
    inputValidator: (value) => {
      if (value === undefined || value === null || value === '') {
        return 'Выберите позицию!';
      }
    }
  });
  
  if (newCategoryPosition !== undefined && newCategoryPosition !== null) {
    const targetCategoryIndex = parseInt(newCategoryPosition);
    
    if (targetCategoryIndex === currentCategoryIndex) {
      return Swal.fire('Внимание', 'Товар уже на этой позиции', 'info');
    }
    
    // Получаем ID товаров в правильном порядке
    const categoryIds = categoryProducts.map(p => p.id);
    
    // Перемещаем ID товара
    const [movedId] = categoryIds.splice(currentCategoryIndex, 1);
    categoryIds.splice(targetCategoryIndex, 0, movedId);
    
    // Создаем новый массив продуктов с обновленным порядком
    const updatedCategoryProducts = categoryIds.map(id => 
      categoryProducts.find(p => p.id === id)
    );
    
    // Обновляем order для товаров этой категории
    const batch = db.batch();
    
    // Находим глобальные индексы для товаров категории
    const categoryGlobalIndices = categoryProducts.map(cp => 
      products.findIndex(p => p.id === cp.id)
    ).sort((a, b) => a - b);
    
    // Обновляем order на основе новых позиций
    updatedCategoryProducts.forEach((p, localIdx) => {
      const newOrder = categoryGlobalIndices[localIdx];
      batch.update(db.collection('products').doc(p.id), { order: newOrder });
    });
    
    await batch.commit();
    
    // Перезагружаем товары
    await loadProducts();
    
    Swal.fire({
      title: 'Готово',
      text: `Товар перемещён с позиции #${currentCategoryIndex + 1} на #${targetCategoryIndex + 1}`,
      icon: 'success',
      timer: 1500,
      showConfirmButton: false
    });
  }
}

// Функция удаления товара
async function deleteProduct(productId) {
  try {
    const result = await Swal.fire({
      title: 'Удалить товар?',
      text: "Это действие нельзя отменить!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Да, удалить!',
      cancelButtonText: 'Отмена'
    });

    if (result.isConfirmed) {
      await db.collection('products').doc(productId).delete();
      Swal.fire('Удалено!', 'Товар был успешно удален.', 'success');
      loadProducts();
    }
  } catch (error) {
    console.error('Error deleting product:', error);
    Swal.fire('Ошибка', 'Не удалось удалить товар', 'error');
  }
}

// Функция для перемещения товаров
const moveModal = document.createElement('div');
moveModal.id = 'moveModal';
moveModal.style.cssText = `
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
`;
moveModal.innerHTML = `
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;">
    <h3>Переместить товар</h3>
    <div style="margin-bottom: 15px;">
      <p>Текущая позиция: <span id="currentPosition">1</span></p>
      <label>Переместить на позицию:</label>
      <input type="number" id="moveSteps" value="1" min="1" style="width: 100%; margin-top: 5px;">
    </div>
    <div style="display: flex; justify-content: space-between;">
      <button onclick="closeMoveModal()" style="background: #6c757d;">Отмена</button>
      <button onclick="moveProductMultiple()" style="background: #28a745;">Переместить</button>
    </div>
  </div>
`;
document.body.appendChild(moveModal);

let currentMoveProductId = null;
let currentMoveDirection = null;

function showMoveModal(productId, direction) {
  currentMoveProductId = productId;
  currentMoveDirection = direction;
  const product = products.find(p => p.id === productId);
  const currentIndex = products.findIndex(p => p.id === productId);
  document.getElementById('currentPosition').textContent = currentIndex + 1;
  document.getElementById('moveSteps').value = currentIndex + 1;
  moveModal.style.display = 'block';
}

async function moveProductMultiple() {
  if (!currentMoveProductId) return;
  
  try {
    const targetPosition = parseInt(document.getElementById('moveSteps').value) || 1;
    const product = products.find(p => p.id === currentMoveProductId);
    const currentIndex = products.findIndex(p => p.id === currentMoveProductId);
    
    if (!product || currentIndex === -1) return;
    
    const newIndex = Math.max(0, Math.min(products.length - 1, targetPosition - 1));
    
    if (currentIndex === newIndex) {
      closeMoveModal();
      return;
    }
    
    const newProducts = [...products];
    const [movedProduct] = newProducts.splice(currentIndex, 1);
    newProducts.splice(newIndex, 0, movedProduct);
    
    const batch = db.batch();
    newProducts.forEach((p, index) => {
      const productRef = db.collection('products').doc(p.id);
      batch.update(productRef, { order: index });
    });
    
    await batch.commit();
    products = newProducts;
    renderProducts();
    closeMoveModal();
    Swal.fire('Успех!', 'Товар перемещен', 'success');
  } catch (error) {
    console.error('Error moving product:', error);
    Swal.fire('Ошибка', 'Не удалось переместить товар', 'error');
    closeMoveModal();
  }
}

function closeMoveModal() {
  moveModal.style.display = 'none';
  currentMoveProductId = null;
  currentMoveDirection = null;
}

// Функции для редактирования оптовых цен
const editWholesaleModal = document.createElement('div');
editWholesaleModal.id = 'editWholesaleModal';
editWholesaleModal.style.cssText = `
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
`;
editWholesaleModal.innerHTML = `
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px;">
    <h3>Редактирование оптовых цен</h3>
    <div style="margin-bottom: 15px;">
      <label>Оптовая цена:</label>
      <input type="number" id="editOptPrice" style="width: 100%; margin-top: 5px;">
    </div>
    <div style="margin-bottom: 15px;">
      <label>Минимальное количество для опта:</label>
      <input type="number" id="editOptQty" style="width: 100%; margin-top: 5px;">
    </div>
    <div style="display: flex; justify-content: space-between;">
      <button onclick="closeEditWholesaleModal()" style="background: #6c757d;">Отмена</button>
      <button onclick="saveWholesaleChanges()" style="background: #28a745;">Сохранить</button>
    </div>
  </div>
`;
document.body.appendChild(editWholesaleModal);

let currentEditingProductId = null;

function showEditWholesaleModal(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;
  
  currentEditingProductId = productId;
  document.getElementById('editOptPrice').value = product.optPrice || '';
  document.getElementById('editOptQty').value = product.optQty || '';
  editWholesaleModal.style.display = 'block';
}

function closeEditWholesaleModal() {
  editWholesaleModal.style.display = 'none';
  currentEditingProductId = null;
}

async function saveWholesaleChanges() {
  if (!currentEditingProductId) return;
  
  try {
    const optPrice = document.getElementById('editOptPrice').value;
    const optQty = document.getElementById('editOptQty').value;
    
    await db.collection('products').doc(currentEditingProductId).update({
      optPrice: optPrice ? Number(optPrice) : null,
      optQty: optQty ? Number(optQty) : null
    });
    
    Swal.fire('Успех!', 'Оптовые цены обновлены', 'success');
    closeEditWholesaleModal();
    loadProducts();
  } catch (error) {
    console.error('Error updating wholesale prices:', error);
    Swal.fire('Ошибка', 'Не удалось обновить оптовые цены', 'error');
  }
}

// Функция обновления цены товара
// Поддерживает два варианта вызова:
// 1) updateProductPrice(productId, newPrice)
// 2) updateProductPrice(productId, field, value)
async function updateProductPrice(productId, field, value) {
  try {
    const updateData = {};

    // Вариант вызова (productId, newPrice)
    if (typeof value === 'undefined') {
      const price = Number(field);
      if (isNaN(price) || price < 0) {
        Swal.fire('Ошибка', 'Введите корректную цену', 'error');
        return;
      }
      updateData['price'] = price;
    } else {
      // Вариант (productId, field, value)
      const num = Number(value);
      if (isNaN(num)) {
        Swal.fire('Ошибка', 'Введите корректное числовое значение', 'error');
        return;
      }
      updateData[field] = num;
    }

    await db.collection('products').doc(productId).update(updateData);
    Swal.fire('Успех!', 'Цена обновлена', 'success');
    await loadProducts();
  } catch (error) {
    console.error('Error updating product price:', error);
    Swal.fire('Ошибка', 'Не удалось обновить цену', 'error');
  }
}

// Обработчик клика вне модального окна
editWholesaleModal.onclick = function(e) {
  if (e.target === this) {
    closeEditWholesaleModal();
  }
};

  

// Обновить название товара
async function updateProductTitle(productId, newTitle) {
  try {
    await db.collection('products').doc(productId).update({ title: newTitle });
    Swal.fire('Успех!', 'Название обновлено', 'success');
    loadProducts();
  } catch (error) {
    console.error('Ошибка при обновлении названия:', error);
    Swal.fire('Ошибка', 'Не удалось обновить название', 'error');
  }
}

// Заблокировать/разблокировать товар
async function toggleProductBlock(productId, currentStatus) {
  try {
    await db.collection('products').doc(productId).update({ blocked: !currentStatus });
    Swal.fire('Успех!', !currentStatus ? 'Товар заблокирован' : 'Товар разблокирован', 'success');
    loadProducts();
  } catch (error) {
    console.error('Ошибка при смене статуса блокировки:', error);
    Swal.fire('Ошибка', 'Не удалось изменить статус блокировки', 'error');
  }
}

// Функция для массового обновления категорий (для администратора)
async function massUpdateCategories() {
  if (!isAdmin) {
    Swal.fire('Ошибка', 'Доступно только для администратора', 'error');
    return;
  }
  
  const { value: action } = await Swal.fire({
    title: 'Массовое обновление категорий',
    html: `
      <select id="massCategory" class="swal2-input">
        <option value="">Выберите действие</option>
        <option value="scotch_keywords">Скотч (по ключевым словам)</option>
        <option value="knife_keywords">Нож (по ключевым словам)</option>
        <option value="all_scotch">Все товары → Скотч</option>
        <option value="all_knife">Все товары → Нож</option>
        <option value="all_scissors">Все товары → Ножницы</option>
      </select>
    `,
    showCancelButton: true,
    confirmButtonText: 'Выполнить',
    cancelButtonText: 'Отмена',
    preConfirm: () => {
      return document.getElementById('massCategory').value;
    }
  });
  
  if (!action) return;
  
  try {
    let updated = 0;
    const batch = db.batch();
    
    for (const product of products) {
      const productRef = db.collection('products').doc(product.id);
      let shouldUpdate = false;
      let newCategory = '';
      
      if (action === 'scotch_keywords') {
        const keywords = ['скотч', 'лента', 'tape', 'клейкая'];
        if (keywords.some(kw => (product.title || '').toLowerCase().includes(kw))) {
          newCategory = 'скотч';
          shouldUpdate = true;
        }
      } else if (action === 'knife_keywords') {
        const keywords = ['нож', 'knife', 'лезвие'];
        if (keywords.some(kw => (product.title || '').toLowerCase().includes(kw))) {
          newCategory = 'нож';
          shouldUpdate = true;
        }
      } else if (action === 'all_scotch') {
        newCategory = 'скотч';
        shouldUpdate = true;
      } else if (action === 'all_knife') {
        newCategory = 'нож';
        shouldUpdate = true;
      } else if (action === 'all_scissors') {
        newCategory = 'ножницы';
        shouldUpdate = true;
      }
      
      if (shouldUpdate) {
        batch.update(productRef, { category: newCategory });
        updated++;
      }
    }
    
    if (updated > 0) {
      await batch.commit();
      await loadProducts();
      Swal.fire('Успех!', `Обновлено товаров: ${updated}`, 'success');
    } else {
      Swal.fire('Инфо', 'Не найдено товаров для обновления', 'info');
    }
  } catch (error) {
    console.error('Ошибка массового обновления:', error);
    Swal.fire('Ошибка', 'Не удалось обновить товары', 'error');
  }
}

</script>

<!-- Кнопки прокрутки вверх/вниз -->
  <div class="scroll-buttons" style="position:fixed;right:20px;bottom:20px;z-index:9999;display:flex;flex-direction:column;gap:10px;">
    <button id="scrollTopBtn" style="background:#007bff;color:#fff;border:none;padding:10px 14px;border-radius:12px;box-shadow:0 2px 8px #0001;cursor:pointer;font-size:18px;">▲</button>
    <button id="scrollBottomBtn" style="background:#007bff;color:#fff;border:none;padding:10px 14px;border-radius:12px;box-shadow:0 2px 8px #0001;cursor:pointer;font-size:18px;">▼</button>
  </div>

  <footer id="siteFooter" style="background: #003366; color: #fff; padding:14px 10px; text-align:center; margin-top:18px;">
    <div style="max-width:1200px; margin:0 auto; font-weight:700;">
      О нас: мы первый рук из китая — у нас низкие цены
    </div>
  </footer>

<script>
// --- Функция для показа/скрытия админ-панели ---
function toggleAdminPanel() {
  const panel = document.getElementById('adminPanel');
  if (panel.classList.contains('admin-panel-hidden')) {
    panel.classList.remove('admin-panel-hidden');
    document.getElementById('hideAdminPanelBtn').textContent = 'Скрыть панель';
  } else {
    panel.classList.add('admin-panel-hidden');
    document.getElementById('hideAdminPanelBtn').textContent = 'Показать панель';
  }
}
// Смена фото товара админом
// Кнопка корзины: прокрутка к корзине и обновление количества
const cartFloatBtn = document.getElementById('cartFloatBtn');
const cartFloatCount = document.getElementById('cartFloatCount');
const orderForm = document.querySelector('.order-form');

if (cartFloatBtn) {
  cartFloatBtn.onclick = function() {
    if (orderForm) {
      orderForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  };
}

function updateCartFloatCount() {
  if (cartFloatCount) {
    cartFloatCount.textContent = cart.length;
  }
}

// Вызовем при инициализации и обновлении корзины
const origUpdateCart = updateCart;
updateCart = function() {
  origUpdateCart.apply(this, arguments);
  updateCartFloatCount();
};
document.addEventListener('DOMContentLoaded', updateCartFloatCount);

// Функция для показа увеличенного фото
function showImageModal(imageUrl, title) {
  const previewBlock = document.getElementById('previewBlock');
  const previewImg = document.getElementById('previewImg');
  const previewCaption = document.getElementById('previewCaption');
  const closePreview = document.getElementById('closePreview');
  
  if (previewBlock && previewImg) {
    previewImg.src = imageUrl;
    if (previewCaption) {
      previewCaption.textContent = title || '';
    }
    previewBlock.style.display = 'flex';
    previewBlock.style.alignItems = 'center';
    previewBlock.style.justifyContent = 'center';
    
    // Закрытие по клику на фон
    previewBlock.onclick = function(e) {
      if (e.target === previewBlock) {
        previewBlock.style.display = 'none';
      }
    };
    
    // Закрытие по кнопке
    if (closePreview) {
      closePreview.onclick = function() {
        previewBlock.style.display = 'none';
      };
    }
    
    // Закрытие по Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        previewBlock.style.display = 'none';
      }
    });
  }
}

// ==================== ФУНКЦИИ ДЛЯ ЧАТА ====================

// Переключение видимости окна чата
async function toggleChat() {
  const chatWindow = document.getElementById('chatWindow');
  
  if (chatWindow.style.display === 'none' || !chatWindow.style.display) {
    // СНАЧАЛА запрашиваем имя клиента
    await ensureClientName();
    
    chatWindow.style.display = 'flex';
    document.body.classList.add('modal-open'); // Блокируем скролл
    resetChatBadge(); // Сбрасываем счетчик при открытии
    
    // Отображаем имя клиента в заголовке
    updateClientNameDisplay();
    
    // Загружаем сообщения для этого клиента
    await loadChatMessages();
    
    // Прокрутка к последнему сообщению
    setTimeout(() => {
      const messagesDiv = document.getElementById('chatMessages');
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }, 100);
  } else {
    chatWindow.style.display = 'none';
    document.body.classList.remove('modal-open'); // Разблокируем скролл
  }
}

// Обновление отображения имени клиента в заголовке
function updateClientNameDisplay() {
  const nameDisplay = document.getElementById('clientNameDisplay');
  if (nameDisplay && clientName) {
    nameDisplay.innerHTML = `
      <span>👤 ${clientName}</span>
      <span style="opacity:0.7; font-size:11px;">• ID: ${clientId.substring(7, 15)}</span>
    `;
  }
}

// Изменение имени клиента
async function changeClientName() {
  const { value: newName } = await Swal.fire({
    title: 'Изменить имя',
    input: 'text',
    inputLabel: 'Введите новое имя',
    inputValue: clientName || '',
    showCancelButton: true,
    confirmButtonText: 'Сохранить',
    cancelButtonText: 'Отмена',
    inputValidator: (value) => {
      if (!value) {
        return 'Пожалуйста, введите имя!';
      }
    }
  });
  
  if (newName && newName !== clientName) {
    clientName = newName;
    localStorage.setItem('chatClientName', newName);
    
    // Обновляем имя в базе данных
    try {
      if (typeof db !== 'undefined') {
        await db.collection('chatClients').doc(clientId).update({
          name: newName,
          lastActive: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Обновляем имя в заголовке
        updateClientNameDisplay();
        
        Swal.fire({
          icon: 'success',
          title: 'Имя изменено!',
          text: `Теперь вы: ${newName}`,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 2000
        });
      }
    } catch (error) {
      console.error('Ошибка обновления имени:', error);
      Swal.fire('Ошибка', 'Не удалось обновить имя', 'error');
    }
  }
}

// Отправка сообщения от клиента
async function sendChatMessage() {
  // Проверяем имя клиента
  await ensureClientName();
  
  const input = document.getElementById('chatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  const messagesDiv = document.getElementById('chatMessages');
  const now = new Date();
  const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
  
  // Добавляем сообщение клиента
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = 'background:#667eea; color:white; padding:12px; border-radius:12px 12px 4px 12px; max-width:80%; align-self:flex-end; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
  messageDiv.innerHTML = `
    <div style="font-size:14px;">${escapeHtml(message)}</div>
    <div style="font-size:11px; opacity:0.9; margin-top:4px; text-align:right;">Вы • ${timeStr}</div>
  `;
  messagesDiv.appendChild(messageDiv);
  
  // Сохраняем сообщение в Firebase с clientId
  await saveChatMessage(message, 'client', now);
  
  // Очищаем поле ввода
  input.value = '';
  
  // Прокручиваем к последнему сообщению
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  // Показываем уведомление "печатает..."
  showTypingIndicator();
}

// Показать индикатор "печатает..."
function showTypingIndicator() {
  const messagesDiv = document.getElementById('chatMessages');
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typingIndicator';
  typingDiv.style.cssText = 'background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
  typingDiv.innerHTML = `
    <div style="font-size:14px; color:#666;">
      <span style="animation:blink 1.4s infinite;">.</span>
      <span style="animation:blink 1.4s infinite 0.2s;">.</span>
      <span style="animation:blink 1.4s infinite 0.4s;">.</span>
    </div>
  `;
  messagesDiv.appendChild(typingDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  // Добавляем стили анимации если их еще нет
  if (!document.getElementById('chatAnimationStyle')) {
    const style = document.createElement('style');
    style.id = 'chatAnimationStyle';
    style.textContent = `
      @keyframes blink {
        0%, 60%, 100% { opacity: 0; }
        30% { opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }
}

// Сохранение сообщения в Firebase
async function saveChatMessage(text, sender, timestamp) {
  if (typeof db === 'undefined') return;
  
  try {
    const messageData = {
      text: text,
      sender: sender, // 'client' или 'admin'
      clientId: clientId, // Уникальный ID клиента
      clientName: clientName || 'Клиент',
      timestamp: firebase.firestore.Timestamp.fromDate(timestamp),
      read: false
    };
    
    await db.collection('chatMessages').add(messageData);
    console.log('Сообщение сохранено с clientId:', clientId);
    
    // Обновляем активность клиента
    if (sender === 'client') {
      await updateClientActivity();
    }
  } catch (error) {
    console.error('Ошибка сохранения сообщения:', error);
  }
}

// Загрузка сообщений из Firebase (только для текущего клиента)
async function loadChatMessages() {
  if (typeof db === 'undefined') return;
  
  // Запрашиваем имя при первом открытии
  await ensureClientName();
  
  try {
    // Загружаем только сообщения текущего клиента
    const querySnapshot = await db.collection('chatMessages')
      .where('clientId', '==', clientId)
      .get();
    
    const messagesDiv = document.getElementById('chatMessages');
    messagesDiv.innerHTML = ''; // Очищаем
    
    if (querySnapshot.empty) {
      // Показываем приветственное сообщение
      messagesDiv.innerHTML = `
        <div style="background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
          <div style="font-size:14px; color:#333;">Здравствуйте, ${clientName}! Чем могу помочь?</div>
          <div style="font-size:11px; color:#999; margin-top:4px;">Продавец • только что</div>
        </div>
      `;
    } else {
      // Сортируем сообщения по времени вручную
      const messages = [];
      querySnapshot.forEach((doc) => {
        const msg = doc.data();
        messages.push({
          text: msg.text,
          sender: msg.sender,
          timestamp: msg.timestamp.toDate()
        });
      });
      
      // Сортируем по timestamp
      messages.sort((a, b) => a.timestamp - b.timestamp);
      
      // Добавляем в UI
      messages.forEach(msg => {
        addChatMessageToUI(msg.text, msg.sender, msg.timestamp);
      });
    }
    
    // Прокрутка к последнему сообщению
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // Подписываемся на новые сообщения
    subscribeToChatMessages();
  } catch (error) {
    console.error('Ошибка загрузки сообщений:', error);
  }
}

// Добавление сообщения в UI
function addChatMessageToUI(text, sender, timestamp) {
  const messagesDiv = document.getElementById('chatMessages');
  const timeStr = timestamp.getHours().toString().padStart(2, '0') + ':' + timestamp.getMinutes().toString().padStart(2, '0');
  
  const messageDiv = document.createElement('div');
  
  if (sender === 'client') {
    messageDiv.style.cssText = 'background:#667eea; color:white; padding:12px; border-radius:12px 12px 4px 12px; max-width:80%; align-self:flex-end; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    messageDiv.innerHTML = `
      <div style="font-size:14px;">${escapeHtml(text)}</div>
      <div style="font-size:11px; opacity:0.9; margin-top:4px; text-align:right;">Вы • ${timeStr}</div>
    `;
  } else {
    messageDiv.style.cssText = 'background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    messageDiv.innerHTML = `
      <div style="font-size:14px; color:#333;">${escapeHtml(text)}</div>
      <div style="font-size:11px; color:#999; margin-top:4px;">Продавец • ${timeStr}</div>
    `;
  }
  
  messagesDiv.appendChild(messageDiv);
}

// Подписка на новые сообщения в реальном времени (только для текущего клиента)
function subscribeToChatMessages() {
  if (typeof db === 'undefined') return;
  
  db.collection('chatMessages')
    .where('clientId', '==', clientId) // Только сообщения текущего клиента
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const msg = change.doc.data();
          // Если сообщение от админа и чат закрыт, показываем уведомление
          if (msg.sender === 'admin' && msg.clientId === clientId) {
            const chatWindow = document.getElementById('chatWindow');
            if (chatWindow.style.display === 'none' || !chatWindow.style.display) {
              showChatNotification();
            }
            // Убираем индикатор "печатает..."
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
              typingIndicator.remove();
            }
            // Добавляем новое сообщение
            addChatMessageToUI(msg.text, msg.sender, msg.timestamp.toDate());
            // Прокрутка
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
        }
      });
    });
}

// Показать уведомление о новом сообщении
function showChatNotification() {
  // Увеличиваем счетчик непрочитанных
  const chatBtn = document.querySelector('[onclick="toggleChat()"]');
  let badge = document.getElementById('chatBadge');
  if (!badge && chatBtn) {
    badge = document.createElement('span');
    badge.id = 'chatBadge';
    badge.style.cssText = 'position:absolute; top:-5px; right:-5px; background:#ff3b30; color:white; border-radius:50%; width:20px; height:20px; font-size:11px; font-weight:bold; display:flex; align-items:center; justify-content:center; animation:pulse 1s infinite;';
    badge.textContent = '1';
    chatBtn.style.position = 'relative';
    chatBtn.appendChild(badge);
  } else if (badge) {
    badge.textContent = parseInt(badge.textContent || '0') + 1;
  }
  
  // Воспроизводим звук уведомления
  playChatNotificationSound();
  
  // Показываем визуальное всплывающее уведомление
  showVisualNotification();
  
  // Браузерное уведомление (если разрешено)
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('Новое сообщение от продавца', {
      body: 'У вас есть новое сообщение в чате',
      icon: 'photo_5294190093549636589_y.jpg',
      tag: 'chat-message',
      requireInteraction: false
    });
  }
}

// Звук уведомления
function playChatNotificationSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.3);
  } catch (error) {
    console.log('Звук уведомления недоступен:', error);
  }
}

// Визуальное всплывающее уведомление
function showVisualNotification() {
  const notification = document.createElement('div');
  notification.style.cssText = 'position:fixed; top:20px; right:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px 20px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.3); z-index:10003; animation:slideInRight 0.3s ease-out; cursor:pointer; max-width:300px;';
  notification.innerHTML = `
    <div style="font-weight:bold; margin-bottom:4px;">💬 Новое сообщение</div>
    <div style="font-size:13px; opacity:0.9;">Продавец ответил вам</div>
  `;
  
  notification.onclick = () => {
    toggleChat();
    notification.remove();
  };
  
  document.body.appendChild(notification);
  
  // Автоматически убираем через 5 секунд
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => notification.remove(), 300);
  }, 5000);
}

// Сброс счетчика при открытии чата
function resetChatBadge() {
  const badge = document.getElementById('chatBadge');
  if (badge) {
    badge.remove();
  }
}

// Инициализация чата при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  // Убеждаемся что прокрутка разрешена при загрузке
  document.body.style.overflow = 'auto';
  document.body.style.position = 'relative';
  document.documentElement.style.overflow = 'auto';
  
  // Запрашиваем разрешение на уведомления
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
  
  console.log('Чат инициализирован для клиента:', clientId);
  
  // Сообщения загрузятся при открытии чата через toggleChat()
});

// Открыть окно жалобы
function openComplaintWindow() {
  toggleSideMenu(); // Закрываем меню
  
  setTimeout(() => {
    document.getElementById('complaintWindow').style.display = 'flex';
    document.body.classList.add('modal-open'); // Блокируем скролл
    
    // Очищаем форму
    document.getElementById('complaintName').value = '';
    document.getElementById('complaintPhone').value = '';
    document.getElementById('complaintCategory').value = '';
    document.getElementById('complaintText').value = '';
  }, 300);
}

// Закрыть окно жалобы
function closeComplaintWindow() {
  document.getElementById('complaintWindow').style.display = 'none';
  document.body.classList.remove('modal-open'); // Разблокируем скролл
}

// Отправить жалобу в Telegram
async function sendComplaint() {
  const name = document.getElementById('complaintName').value.trim();
  const phone = document.getElementById('complaintPhone').value.trim();
  const category = document.getElementById('complaintCategory').value;
  const text = document.getElementById('complaintText').value.trim();
  
  // Валидация
  if (!name) {
    Swal.fire('Ошибка', 'Введите ваше имя', 'error');
    return;
  }
  
  if (!phone) {
    Swal.fire('Ошибка', 'Введите номер телефона', 'error');
    return;
  }
  
  if (!category) {
    Swal.fire('Ошибка', 'Выберите категорию жалобы', 'error');
    return;
  }
  
  if (!text) {
    Swal.fire('Ошибка', 'Опишите проблему', 'error');
    return;
  }
  
  const categoryNames = {
    'quality': '🔴 Качество товара',
    'delivery': '🚚 Проблемы с доставкой',
    'service': '👤 Обслуживание',
    'price': '💰 Неверная цена',
    'other': '📝 Другое'
  };
  
  const message = `⚠️ *ЖАЛОБА ОТ КЛИЕНТА*\n\n` +
    `👤 *Имя:* ${name}\n` +
    `📱 *Телефон:* ${phone}\n` +
    `📂 *Категория:* ${categoryNames[category]}\n\n` +
    `📝 *Описание проблемы:*\n${text}\n\n` +
    `🕐 *Дата:* ${new Date().toLocaleString('ru-RU')}`;
  
  try {
    Swal.fire({
      title: 'Отправка жалобы...',
      text: 'Пожалуйста, подождите',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });
    
    const response = await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendMessage', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        chat_id: '5567924440',
        text: message,
        parse_mode: 'Markdown'
      })
    });
    
    const result = await response.json();
    
    if (result.ok) {
      closeComplaintWindow();
      Swal.fire({
        icon: 'success',
        title: 'Жалоба отправлена!',
        text: 'Мы рассмотрим вашу жалобу и свяжемся с вами в ближайшее время',
        confirmButtonText: 'Понятно'
      });
    } else {
      throw new Error('Ошибка отправки');
    }
    
  } catch (error) {
    console.error('Ошибка отправки жалобы:', error);
    Swal.fire({
      icon: 'error',
      title: 'Ошибка',
      text: 'Не удалось отправить жалобу. Попробуйте позже или свяжитесь с нами по телефону.'
    });
  }
}

// Функции окна предложения товара
function openSuggestionWindow() {
  toggleSideMenu();
  
  setTimeout(() => {
    document.getElementById('suggestionWindow').style.display = 'flex';
    document.body.classList.add('modal-open'); // Блокируем скролл
    
    // Очистка формы
    document.getElementById('suggestionName').value = '';
    document.getElementById('suggestionPhone').value = '';
    document.getElementById('suggestionProductName').value = '';
    document.getElementById('suggestionCurrentPrice').value = '';
    document.getElementById('suggestionPrice').value = '';
    document.getElementById('suggestionDescription').value = '';
    document.getElementById('suggestionPhoto').value = '';
  }, 300);
}

function closeSuggestionWindow() {
  document.getElementById('suggestionWindow').style.display = 'none';
  document.body.classList.remove('modal-open'); // Разблокируем скролл
}

async function sendSuggestion() {
  const name = document.getElementById('suggestionName').value.trim();
  const phone = document.getElementById('suggestionPhone').value.trim();
  const productName = document.getElementById('suggestionProductName').value.trim();
  const currentPrice = document.getElementById('suggestionCurrentPrice').value.trim();
  const price = document.getElementById('suggestionPrice').value.trim();
  const description = document.getElementById('suggestionDescription').value.trim();
  const photoInput = document.getElementById('suggestionPhoto');
  
  if (!name) {
    Swal.fire('Ошибка', 'Введите ваше имя', 'error');
    return;
  }
  
  if (!phone) {
    Swal.fire('Ошибка', 'Введите телефон', 'error');
    return;
  }
  
  if (!productName) {
    Swal.fire('Ошибка', 'Укажите название товара', 'error');
    return;
  }
  
  if (!description) {
    Swal.fire('Ошибка', 'Опишите товар подробнее', 'error');
    return;
  }
  
  try {
    // Показываем спиннер в окне
    document.getElementById('suggestionLoader').style.display = 'flex';
    document.getElementById('suggestionSubmitBtn').disabled = true;
    
    let message = `💡 *ПРЕДЛОЖЕНИЕ ТОВАРА*\n\n` +
      `👤 *Имя клиента:* ${name}\n` +
      `📱 *Телефон:* ${phone}\n` +
      `🏷️ *Название товара:* ${productName}\n` +
      `💵 *Текущая цена:* ${currentPrice ? currentPrice + ' сом' : 'не указана'}\n` +
      `💰 *Желаемая цена:* ${price ? price + ' сом' : 'не указана'}\n\n` +
      `📝 *Описание:*\n${description}\n\n` +
      `🕐 *Дата:* ${new Date().toLocaleString('ru-RU')}`;
    
    let result;
    
    // Если есть фото - отправляем напрямую в Telegram через sendPhoto с файлом
    if (photoInput.files && photoInput.files[0]) {
      console.log('Отправка фото в Telegram...');
      
      const telegramFormData = new FormData();
      telegramFormData.append('chat_id', '5567924440');
      telegramFormData.append('photo', photoInput.files[0]);
      telegramFormData.append('caption', message);
      
      const response = await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendPhoto', {
        method: 'POST',
        body: telegramFormData
      });
      
      result = await response.json();
      console.log('Результат отправки с фото:', result);
    } else {
      // Если нет фото - отправляем обычное текстовое сообщение
      console.log('Отправка текстового сообщения...');
      
      const response = await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendMessage', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          chat_id: '5567924440',
          text: message,
          parse_mode: 'Markdown'
        })
      });
      result = await response.json();
      console.log('Результат отправки текста:', result);
    }
    
    if (result.ok) {
      // Скрываем спиннер
      document.getElementById('suggestionLoader').style.display = 'none';
      document.getElementById('suggestionSubmitBtn').disabled = false;
      
      closeSuggestionWindow();
      Swal.fire({
        icon: 'success',
        title: 'Предложение отправлено!',
        text: 'Спасибо за ваше предложение! Мы рассмотрим его и постараемся добавить этот товар',
        confirmButtonText: 'Отлично'
      });
    } else {
      throw new Error('Ошибка отправки');
    }
    
  } catch (error) {
    // Скрываем спиннер при ошибке
    document.getElementById('suggestionLoader').style.display = 'none';
    document.getElementById('suggestionSubmitBtn').disabled = false;
    
    console.error('Ошибка отправки предложения:', error);
    Swal.fire({
      icon: 'error',
      title: 'Ошибка',
      text: 'Не удалось отправить предложение. Попробуйте позже или свяжитесь с нами по телефону.'
    });
  }
}

// Экранирование HTML для безопасности
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ==================== ФУНКЦИИ БОКОВОГО МЕНЮ ====================

// Переключение бокового меню
function toggleSideMenu() {
  const sideMenu = document.getElementById('sideMenu');
  const menuOverlay = document.getElementById('menuOverlay');
  const menuBtn = document.getElementById('menuToggleBtn');
  
  if (sideMenu.style.left === '0px') {
    // Закрываем меню
    sideMenu.style.left = '-300px';
    menuOverlay.style.display = 'none';
    document.body.style.overflow = 'auto';
    document.body.style.position = 'relative';
    document.documentElement.style.overflow = 'auto';
  } else {
    // Открываем меню
    sideMenu.style.left = '0px';
    menuOverlay.style.display = 'block';
    // НЕ блокируем прокрутку на мобильных - пусть можно прокручивать
    // document.body.style.overflow = 'hidden';
    
    // Проверяем статус входа админа
    updateAdminMenuState();
  }
}

// Обновление состояния админ-секции в меню
function updateAdminMenuState() {
  if (isAdmin) {
    document.getElementById('menuAdminLogin').style.display = 'none';
    document.getElementById('menuAdminLoggedIn').style.display = 'flex';
  } else {
    document.getElementById('menuAdminLogin').style.display = 'flex';
    document.getElementById('menuAdminLoggedIn').style.display = 'none';
  }
}

// Закрытие меню при нажатии Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const sideMenu = document.getElementById('sideMenu');
    if (sideMenu.style.left === '0px') {
      toggleSideMenu();
    }
  }
});

// Открытие чата из бокового меню
function openChatFromMenu() {
  // Закрываем боковое меню
  toggleSideMenu();
  
  // Открываем чат через небольшую задержку для плавности
  setTimeout(() => {
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow.style.display !== 'flex') {
      toggleChat();
    }
  }, 300);
}

// Открытие полноэкранного окна админского чата
async function openAdminChatWindow() {
  // Закрываем боковое меню
  toggleSideMenu();
  
  // Открываем окно админского чата
  setTimeout(async () => {
    const adminChatWindow = document.getElementById('adminChatWindow');
    adminChatWindow.style.display = 'flex';
    document.body.classList.add('modal-open'); // Блокируем скролл
    
    // Загружаем список клиентов
    await loadAdminFullChat();
  }, 300);
}

// Открытие окна добавления товара
function openAddProductWindow() {
  // Закрываем боковое меню
  toggleSideMenu();
  
  // Открываем окно добавления товара
  setTimeout(() => {
    const addProductWindow = document.getElementById('addProductWindow');
    addProductWindow.style.display = 'flex';
    document.body.classList.add('modal-open'); // Блокируем скролл
    
    // Очищаем форму для нового товара
    document.getElementById('newTitle').value = '';
    document.getElementById('newCostPrice').value = '';
    document.getElementById('newPrice').value = '';
    document.getElementById('newCategory').value = '';
    document.getElementById('newOptPrice').value = '';
    document.getElementById('newOptQty').value = '';
    document.getElementById('newMinQty').value = '';
    document.getElementById('imageFile').value = '';
    document.getElementById('newImage').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('profitDisplay').style.display = 'none';
  }, 300);
}

// Закрытие окна добавления товара
function closeAddProductWindow() {
  const addProductWindow = document.getElementById('addProductWindow');
  addProductWindow.style.display = 'none';
  document.body.classList.remove('modal-open'); // Разблокируем скролл
}

// Открытие окна управления заказами
function openOrdersManagementWindow() {
  toggleSideMenu();
  
  setTimeout(() => {
    const ordersWindow = document.getElementById('ordersManagementWindow');
    ordersWindow.style.display = 'flex';
    document.body.classList.add('modal-open'); // Блокируем скролл
    loadOrdersManagement();
  }, 300);
}

// Закрытие окна управления заказами
function closeOrdersManagementWindow() {
  const ordersWindow = document.getElementById('ordersManagementWindow');
  ordersWindow.style.display = 'none';
  document.body.classList.remove('modal-open'); // Разблокируем скролл
}

// ==================== ПАРТНЕРСКИЕ ЗАКАЗЫ ====================

// Открытие окна партнерских заказов
function openPartnersOrdersWindow() {
  toggleSideMenu();
  
  setTimeout(() => {
    const partnersWindow = document.getElementById('partnersOrdersWindow');
    partnersWindow.style.display = 'flex';
    document.body.classList.add('modal-open');
    loadPartnersOrders();
  }, 300);
}

// Закрытие окна партнерских заказов
function closePartnersOrdersWindow() {
  const partnersWindow = document.getElementById('partnersOrdersWindow');
  partnersWindow.style.display = 'none';
  document.body.classList.remove('modal-open');
}

// Загрузить заказы от партнеров
async function loadPartnersOrders() {
  const statsDiv = document.getElementById('partnersStats');
  const listDiv = document.getElementById('partnersOrdersList');
  
  statsDiv.innerHTML = '<div style="text-align:center; color:#999;">⏳ Загрузка...</div>';
  listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">⏳ Загрузка...</div>';
  
  try {
    // Получаем все заказы
    const ordersSnapshot = await db.collection('orders').get();
    let allOrders = [];
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      allOrders.push({ id: doc.id, ...data });
    });
    
    // Фильтруем только заказы с партнерами
    let orders = allOrders.filter(order => order.partner || order.referredBy);
    
    if (orders.length === 0) {
      statsDiv.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">📭 Заказов от партнеров пока нет</div>';
      listDiv.innerHTML = '';
      return;
    }
    
    // Фильтр по дате
    const dateFilter = document.getElementById('partnersFilterDate').value;
    const now = Date.now();
    const today = new Date().setHours(0, 0, 0, 0);
    
    orders = orders.filter(order => {
      const orderTime = order.timestamp || 0;
      switch(dateFilter) {
        case 'today': return orderTime >= today;
        case 'week': return orderTime >= (today - 7 * 86400000);
        case 'month': return orderTime >= (today - 30 * 86400000);
        case 'all': return true;
        default: return true;
      }
    });
    
    // Собираем статистику по партнерам
    const partnersMap = new Map();
    orders.forEach(order => {
      const partnerName = order.partner || order.referredBy || 'Неизвестный';
      
      if (!partnersMap.has(partnerName)) {
        partnersMap.set(partnerName, {
          name: partnerName,
          ordersCount: 0,
          totalAmount: 0,
          clients: new Set()
        });
      }
      
      const partner = partnersMap.get(partnerName);
      partner.ordersCount++;
      partner.totalAmount += order.total || 0;
      partner.clients.add(order.phone || order.name);
    });
    
    // Заполняем фильтр партнеров
    const partnerFilter = document.getElementById('partnersFilterPartner');
    partnerFilter.innerHTML = '<option value="all">Все партнеры</option>';
    Array.from(partnersMap.keys()).sort().forEach(partner => {
      partnerFilter.innerHTML += `<option value="${partner}">${partner}</option>`;
    });
    
    // Отображаем статистику
    let statsHTML = '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px;">';
    
    Array.from(partnersMap.values()).sort((a, b) => b.totalAmount - a.totalAmount).forEach(partner => {
      statsHTML += `
        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);">
          <div style="font-size:18px; font-weight:700; margin-bottom:10px;">🤝 ${partner.name}</div>
          <div style="font-size:14px; opacity:0.9;">
            <div style="margin:5px 0;">📦 Заказов: <strong>${partner.ordersCount}</strong></div>
            <div style="margin:5px 0;">👥 Клиентов: <strong>${partner.clients.size}</strong></div>
            <div style="margin:5px 0;">💰 Сумма: <strong>${partner.totalAmount.toFixed(0)} сом</strong></div>
          </div>
        </div>
      `;
    });
    
    statsHTML += '</div>';
    statsDiv.innerHTML = statsHTML;
    
    // Фильтр по конкретному партнеру
    const selectedPartner = partnerFilter.value;
    if (selectedPartner !== 'all') {
      orders = orders.filter(order => (order.partner || order.referredBy) === selectedPartner);
    }
    
    // Отображаем список заказов
    if (orders.length === 0) {
      listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">📭 Нет заказов по выбранным фильтрам</div>';
      return;
    }
    
    // Сортируем по дате (новые первые)
    orders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    
    let ordersHTML = '';
    orders.forEach((order, index) => {
      const date = new Date(order.timestamp);
      const dateStr = date.toLocaleDateString('ru-RU');
      const partnerName = order.partner || order.referredBy || 'Неизвестный';
      
      ordersHTML += `
        <div style="background:white; border:2px solid #e0e0e0; border-radius:12px; padding:20px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">
          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:15px;">
            <div>
              <div style="font-size:16px; font-weight:700; color:#333; margin-bottom:5px;">
                📦 Заказ #${index + 1}
              </div>
              <div style="font-size:14px; color:#666;">
                👤 <strong>${order.name || 'Без имени'}</strong> ${order.phone ? '(' + order.phone + ')' : ''}
              </div>
              <div style="font-size:13px; color:#888; margin-top:3px;">
                📅 ${dateStr} • 🕐 ${order.time || ''}
              </div>
              <div style="font-size:13px; margin-top:5px;">
                <span style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:white; padding:6px 12px; border-radius:8px; font-weight:600;">🤝 ${partnerName}</span>
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:20px; font-weight:700; color:#28a745;">
                ${order.total || 0} сом
              </div>
            </div>
          </div>
        </div>
      `;
    });
    
    listDiv.innerHTML = ordersHTML;
    
  } catch (error) {
    console.error('Ошибка загрузки партнерских заказов:', error);
    statsDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:20px;">❌ Ошибка загрузки</div>';
    listDiv.innerHTML = '';
  }
}

// Экспорт партнерских заказов в Excel
async function exportPartnersToExcel() {
  Swal.fire({
    title: 'Экспорт',
    text: 'Функция экспорта в Excel будет добавлена позже',
    icon: 'info'
  });
}

// ==================== КОНЕЦ ПАРТНЕРСКИХ ЗАКАЗОВ ====================

// Загрузить список заказов для управления
async function loadOrdersManagement() {
  const listDiv = document.getElementById('ordersManagementList');
  listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">⏳ Загрузка заказов...</div>';
  
  try {
    const ordersSnapshot = await db.collection('orders').get();
    
    if (ordersSnapshot.empty) {
      listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:60px; font-size:16px;">📭 Заказов пока нет</div>';
      return;
    }
    
    const dateFilter = document.getElementById('ordersFilterDate').value;
    const statusFilter = document.getElementById('ordersFilterStatus').value;
    const searchQuery = document.getElementById('ordersSearchClient').value.toLowerCase();
    
    const now = Date.now();
    const oneDayMs = 24 * 60 * 60 * 1000;
    
    let orders = [];
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      const timestamp = data.timestamp || Date.now();
      
      // Фильтр по дате
      let dateMatch = true;
      if (dateFilter === 'today') {
        dateMatch = (now - timestamp) < oneDayMs;
      } else if (dateFilter === 'week') {
        dateMatch = (now - timestamp) < (7 * oneDayMs);
      } else if (dateFilter === 'month') {
        dateMatch = (now - timestamp) < (30 * oneDayMs);
      }
      
      // Фильтр по статусу
      const status = data.status || 'pending';
      const statusMatch = statusFilter === 'all' || status === statusFilter;
      
      // Поиск по имени/телефону
      const name = (data.name || '').toLowerCase();
      const phone = (data.phone || '').toLowerCase();
      const searchMatch = !searchQuery || name.includes(searchQuery) || phone.includes(searchQuery);
      
      if (dateMatch && statusMatch && searchMatch) {
        orders.push({
          id: doc.id,
          ...data,
          timestamp
        });
      }
    });
    
    // Сортировка: новые сначала
    orders.sort((a, b) => b.timestamp - a.timestamp);
    
    if (orders.length === 0) {
      listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:60px; font-size:16px;">🔍 Заказы не найдены</div>';
      return;
    }
    
    // Отображаем заказы
    listDiv.innerHTML = '';
    orders.forEach((order, index) => {
      const orderCard = createOrderCard(order, index);
      listDiv.appendChild(orderCard);
    });
    
  } catch (error) {
    console.error('Ошибка загрузки заказов:', error);
    listDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">❌ Ошибка загрузки заказов</div>';
  }
}

// Создать карточку заказа
function createOrderCard(order, index) {
  const card = document.createElement('div');
  card.style.cssText = 'background:white; border:2px solid #007bff; border-radius:10px; padding:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,123,255,0.15);';
  
  const date = new Date(order.timestamp);
  const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
  
  const status = order.status || 'pending';
  const statusColors = {
    pending: { bg: '#fff3cd', color: '#856404', text: '⏳ В обработке' },
    completed: { bg: '#d4edda', color: '#155724', text: '✅ Выполнен' },
    cancelled: { bg: '#f8d7da', color: '#721c24', text: '❌ Отменен' }
  };
  const statusInfo = statusColors[status] || statusColors.pending;
  
  const items = order.items || [];
  const totalItems = items.reduce((sum, item) => sum + item.qty, 0);
  const uniqueItems = items.length; // Количество видов товаров
  
  card.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
      <div>
        <div style="font-size:18px; font-weight:700; color:#333; margin-bottom:5px;">
          📦 Заказ #${index + 1}
        </div>
        <div style="font-size:14px; color:#666;">
          👤 <strong>${order.name || 'Без имени'}</strong> ${order.phone ? '(' + order.phone + ')' : ''}
        </div>
        <div style="font-size:13px; color:#888; margin-top:3px;">
          📅 ${dateStr}
        </div>
        <div style="font-size:13px; color:#888; margin-top:3px;">
          📍 ${order.address || 'Адрес не указан'}
        </div>
        ${order.partner || order.referredBy ? `<div style="font-size:13px; margin-top:5px;">
          <span style="background:linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color:white; padding:4px 10px; border-radius:6px;">🤝 ${order.partner || order.referredBy}</span>
        </div>` : ''}
      </div>
      <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
        <span style="background:${statusInfo.bg}; color:${statusInfo.color}; padding:6px 12px; border-radius:6px; font-size:13px; font-weight:600; white-space:nowrap;">
          ${statusInfo.text}
        </span>
        <select onchange="updateOrderStatus('${order.id}', this.value)" style="padding:6px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
          <option value="pending" ${status === 'pending' ? 'selected' : ''}>⏳ В обработке</option>
          <option value="completed" ${status === 'completed' ? 'selected' : ''}>✅ Выполнен</option>
          <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>❌ Отменен</option>
        </select>
      </div>
    </div>
    
    <div style="background:#f8f9fa; border-radius:8px; padding:12px; margin-bottom:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:600; color:#555;">
          Товары: <span style="color:#007bff;">${uniqueItems} вид${uniqueItems === 1 ? '' : uniqueItems < 5 ? 'а' : 'ов'}</span> • <span style="color:#28a745;">${totalItems} шт</span>
        </div>
        <button onclick="openAddItemToOrderModal('${order.id}')" style="padding:4px 12px; background:#17a2b8; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px; font-weight:600;">
          ➕ Добавить товар
        </button>
      </div>
      <div id="orderItems_${order.id}" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>
    
    <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
      <button onclick="openOrderItemsDetailModal('${order.id}', '${(order.name || 'Клиент').replace(/'/g, "\\'")}', '${order.phone || ''}', '${dateStr}')" style="padding:8px 16px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">
        📋 Показать товары
      </button>
      <button onclick="exportOrderToExcel('${order.id}', '${order.name || 'Клиент'}', '${order.phone || ''}')" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">
        📤 Отправить в Telegram
      </button>
      <button onclick="deleteOrder('${order.id}')" style="padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600;">
        🗑️ Удалить заказ
      </button>
    </div>
  `;
  
  // Добавляем товары (скрытые по умолчанию)
  setTimeout(() => {
    const itemsDiv = document.getElementById(`orderItems_${order.id}`);
    if (itemsDiv) {
      itemsDiv.style.display = 'none';
      items.forEach((item, idx) => {
        const itemDiv = document.createElement('div');
        itemDiv.style.cssText = 'background:white; padding:10px; border-radius:6px; display:flex; justify-content:space-between; align-items:center;';
        itemDiv.innerHTML = `
          <div style="flex:1;">
            <div style="font-weight:600; font-size:13px;">${item.title || 'Товар'}</div>
            <div style="font-size:12px; color:#666;">Цена: ${item.price} сом</div>
          </div>
          <div style="display:flex; align-items:center; gap:10px;">
            <input type="number" 
              value="${item.qty}" 
              min="0" 
              onchange="updateOrderItemQtyManagement('${order.id}', ${idx}, this.value)"
              style="width:70px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:13px;">
            <span style="color:#666; font-size:12px;">шт</span>
            <button onclick="deleteOrderItem('${order.id}', ${idx})" style="padding:6px 10px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">🗑️</button>
          </div>
        `;
        itemsDiv.appendChild(itemDiv);
      });
    }
  }, 10);
  
  return card;
}

// Открыть модальное окно с товарами заказа
async function openOrderItemsDetailModal(orderId, clientName, clientPhone, dateStr) {
  const modal = document.getElementById('orderItemsDetailModal');
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  // Устанавливаем заголовок
  document.getElementById('orderItemsDetailTitle').textContent = `📦 Товары в заказе`;
  document.getElementById('orderItemsDetailInfo').textContent = `👤 ${clientName} ${clientPhone ? '(' + clientPhone + ')' : ''} • 📅 ${dateStr}`;
  
  // Загружаем товары
  const contentDiv = document.getElementById('orderItemsDetailContent');
  contentDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">⏳ Загрузка товаров...</div>';
  
  try {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    
    if (!orderDoc.exists) {
      contentDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">❌ Заказ не найден</div>';
      return;
    }
    
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    if (items.length === 0) {
      contentDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">📭 В заказе нет товаров</div>';
      return;
    }
    
    // Подсчитываем общую сумму
    const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
    
    contentDiv.innerHTML = '';
    
    // Создаем таблицу товаров
    const tableDiv = document.createElement('div');
    tableDiv.style.cssText = 'background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    
    let tableHTML = `
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#f8f9fa; border-bottom:2px solid #e0e0e0;">
            <th style="padding:12px; text-align:left; font-size:14px; color:#666; font-weight:600;">#</th>
            <th style="padding:12px; text-align:left; font-size:14px; color:#666; font-weight:600;">Товар</th>
            <th style="padding:12px; text-align:center; font-size:14px; color:#666; font-weight:600;">Количество</th>
            <th style="padding:12px; text-align:right; font-size:14px; color:#666; font-weight:600;">Цена за шт</th>
            <th style="padding:12px; text-align:right; font-size:14px; color:#666; font-weight:600;">Сумма</th>
            <th style="padding:12px; text-align:center; font-size:14px; color:#666; font-weight:600;">Действия</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    items.forEach((item, idx) => {
      const itemTotal = item.price * item.qty;
      tableHTML += `
        <tr style="border-bottom:1px solid #f0f0f0;">
          <td style="padding:12px; font-size:14px; color:#666;">${idx + 1}</td>
          <td style="padding:12px; font-size:14px; font-weight:600;">${item.title || 'Товар'}</td>
          <td style="padding:12px; text-align:center;">
            <div style="display:flex; align-items:center; gap:8px; justify-content:center;">
              <input type="number" 
                id="itemQty_${orderId}_${idx}" 
                value="${item.qty}" 
                min="0" 
                onchange="updateOrderItemQtyManagement('${orderId}', ${idx}, this.value)"
                style="width:70px; padding:8px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:14px;">
              <span style="color:#666; font-size:13px;">шт</span>
            </div>
          </td>
          <td style="padding:12px; text-align:right; font-size:14px;">${item.price} сом</td>
          <td style="padding:12px; text-align:right; font-size:15px; font-weight:600; color:#007bff;">${itemTotal.toFixed(2)} сом</td>
          <td style="padding:12px; text-align:center;">
            <button onclick="deleteOrderItemFromModal('${orderId}', ${idx})" style="padding:6px 12px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:13px; font-weight:600;">
              🗑️ Удалить
            </button>
          </td>
        </tr>
      `;
    });
    
    tableHTML += `
        </tbody>
        <tfoot>
          <tr style="background:#f8f9fa; border-top:2px solid #e0e0e0;">
            <td colspan="4" style="padding:15px; text-align:right; font-size:16px; font-weight:700; color:#333;">
              Итого:
            </td>
            <td style="padding:15px; text-align:right; font-size:18px; font-weight:700; color:#28a745;">
              ${total.toFixed(2)} сом
            </td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    `;
    
    tableDiv.innerHTML = tableHTML;
    contentDiv.appendChild(tableDiv);
    
    // Настраиваем кнопку добавления товара
    const addBtn = document.getElementById('orderItemsAddBtn');
    addBtn.onclick = () => {
      closeOrderItemsDetailModal();
      openAddItemToOrderModal(orderId);
    };
    
  } catch (error) {
    console.error('Ошибка загрузки товаров:', error);
    contentDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">❌ Ошибка загрузки товаров</div>';
  }
}

// Закрыть модальное окно товаров заказа
function closeOrderItemsDetailModal() {
  document.getElementById('orderItemsDetailModal').style.display = 'none';
  document.body.classList.remove('modal-open');
}

// Удалить товар из заказа через модальное окно
async function deleteOrderItemFromModal(orderId, itemIndex) {
  const result = await Swal.fire({
    title: 'Удалить товар?',
    text: 'Удалить этот товар из заказа?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Да, удалить',
    cancelButtonText: 'Отмена'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    if (!orderDoc.exists) {
      throw new Error('Заказ не найден');
    }
    
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    items.splice(itemIndex, 1);
    
    if (items.length === 0) {
      await Swal.fire({
        title: 'Заказ пуст',
        text: 'В заказе не осталось товаров. Заказ будет удален.',
        icon: 'warning',
        confirmButtonText: 'Понятно'
      });
      await db.collection('orders').doc(orderId).delete();
      closeOrderItemsDetailModal();
      await loadOrdersManagement();
    } else {
      const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
      await db.collection('orders').doc(orderId).update({ items, total });
      
      Swal.fire({
        icon: 'success',
        title: 'Товар удален',
        timer: 1500,
        showConfirmButton: false
      });
      
      // Перезагружаем модальное окно
      const clientName = document.getElementById('orderItemsDetailInfo').textContent.split('👤')[1].split('•')[0].trim();
      const dateStr = document.getElementById('orderItemsDetailInfo').textContent.split('📅')[1].trim();
      await openOrderItemsDetailModal(orderId, clientName, '', dateStr);
    }
    
  } catch (error) {
    console.error('Ошибка удаления товара:', error);
    Swal.fire('Ошибка', 'Не удалось удалить товар', 'error');
  }
}

// Показать/скрыть товары заказа
function toggleOrderItems(orderId) {
  const itemsDiv = document.getElementById(`orderItems_${orderId}`);
  if (itemsDiv) {
    itemsDiv.style.display = itemsDiv.style.display === 'none' ? 'flex' : 'none';
  }
}

// Обновить статус заказа
async function updateOrderStatus(orderId, newStatus) {
  try {
    await db.collection('orders').doc(orderId).update({ status: newStatus });
    
    const statusTexts = {
      pending: 'В обработке',
      completed: 'Выполнен',
      cancelled: 'Отменен'
    };
    
    Swal.fire({
      icon: 'success',
      title: 'Статус обновлен!',
      text: `Заказ переведен в статус: ${statusTexts[newStatus]}`,
      timer: 1500,
      showConfirmButton: false
    });
    
    await loadOrdersManagement();
    
  } catch (error) {
    console.error('Ошибка обновления статуса:', error);
    Swal.fire('Ошибка', 'Не удалось обновить статус заказа', 'error');
    await loadOrdersManagement();
  }
}

// Обновить количество товара в заказе (из панели управления)
async function updateOrderItemQtyManagement(orderId, itemIndex, newQty) {
  await updateOrderItemQty(orderId, itemIndex, newQty);
  await loadOrdersManagement();
}

// Удалить товар из заказа
async function deleteOrderItem(orderId, itemIndex) {
  const result = await Swal.fire({
    title: 'Удалить товар?',
    text: 'Удалить этот товар из заказа?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'Да, удалить',
    cancelButtonText: 'Отмена'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    items.splice(itemIndex, 1);
    
    if (items.length === 0) {
      await db.collection('orders').doc(orderId).delete();
      Swal.fire({
        icon: 'info',
        title: 'Заказ удален',
        text: 'Все товары были удалены, заказ полностью удален',
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      await db.collection('orders').doc(orderId).update({ items });
      Swal.fire({
        icon: 'success',
        title: 'Товар удален',
        timer: 1500,
        showConfirmButton: false
      });
    }
    
    await loadOrdersManagement();
    
  } catch (error) {
    console.error('Ошибка удаления товара:', error);
    Swal.fire('Ошибка', 'Не удалось удалить товар', 'error');
  }
}

// Удалить весь заказ
async function deleteOrder(orderId) {
  const result = await Swal.fire({
    title: 'Удалить заказ?',
    html: 'Вы действительно хотите удалить весь заказ?<br><small style="color:#dc3545;">⚠️ Это действие нельзя отменить!</small>',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: '🗑️ Да, удалить',
    cancelButtonText: 'Отмена'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    await db.collection('orders').doc(orderId).delete();
    
    Swal.fire({
      icon: 'success',
      title: 'Заказ удален!',
      timer: 1500,
      showConfirmButton: false
    });
    
    await loadOrdersManagement();
    
  } catch (error) {
    console.error('Ошибка удаления заказа:', error);
    Swal.fire('Ошибка', 'Не удалось удалить заказ', 'error');
  }
}

// Открыть модальное окно для добавления товара в заказ
let currentOrderIdForAddItem = null;

async function openAddItemToOrderModal(orderId) {
  currentOrderIdForAddItem = orderId;
  document.getElementById('addItemToOrderModal').style.display = 'flex';
  document.body.classList.add('modal-open');
  
  // Загружаем список товаров
  await loadProductsToAdd();
}

// Закрыть модальное окно
function closeAddItemToOrderModal() {
  document.getElementById('addItemToOrderModal').style.display = 'none';
  document.body.classList.remove('modal-open');
  currentOrderIdForAddItem = null;
  document.getElementById('searchProductToAdd').value = '';
}

// Загрузить список товаров для добавления
async function loadProductsToAdd() {
  const listDiv = document.getElementById('productsToAddList');
  listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">⏳ Загрузка товаров...</div>';
  
  try {
    const productsSnapshot = await db.collection('products').get();
    
    if (productsSnapshot.empty) {
      listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">📭 Товаров нет</div>';
      return;
    }
    
    listDiv.innerHTML = '';
    
    productsSnapshot.forEach(doc => {
      const product = doc.data();
      const productCard = document.createElement('div');
      productCard.className = 'product-to-add-card';
      productCard.dataset.title = (product.title || product.name || '').toLowerCase();
      productCard.style.cssText = 'background:white; border:1px solid #e0e0e0; border-radius:8px; padding:12px; margin-bottom:10px; cursor:pointer; transition:all 0.2s;';
      
      const productName = product.title || product.name || 'Без названия';
      const productPrice = product.price || 0;
      const productCostPrice = product.costPrice || 0;
      const productPhoto = product.image || product.photo;
      
      productCard.innerHTML = `
        <div style="display:flex; gap:12px; align-items:center;">
          ${productPhoto ? `<img src="${productPhoto}" style="width:60px; height:60px; object-fit:cover; border-radius:6px;">` : '<div style="width:60px; height:60px; background:#f0f0f0; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:24px;">📦</div>'}
          <div style="flex:1;">
            <div style="font-weight:600; font-size:14px; margin-bottom:4px;">${productName}</div>
            <div style="font-size:13px; color:#666;">💰 ${productPrice} сом</div>
            ${product.category ? `<div style="font-size:12px; color:#888; margin-top:2px;">📁 ${product.category}</div>` : ''}
          </div>
          <button onclick="addProductToOrder('${doc.id}', '${productName.replace(/'/g, "\\'")}', ${productPrice}, ${productCostPrice}); event.stopPropagation();" style="padding:8px 16px; background:#17a2b8; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; white-space:nowrap;">
            ➕ Добавить
          </button>
        </div>
      `;
      
      productCard.onmouseenter = () => productCard.style.background = '#f8f9fa';
      productCard.onmouseleave = () => productCard.style.background = 'white';
      
      listDiv.appendChild(productCard);
    });
    
  } catch (error) {
    console.error('Ошибка загрузки товаров:', error);
    listDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">❌ Ошибка загрузки товаров</div>';
  }
}

// Фильтр товаров по поиску
function filterProductsToAdd() {
  const searchQuery = document.getElementById('searchProductToAdd').value.toLowerCase();
  const cards = document.querySelectorAll('.product-to-add-card');
  
  cards.forEach(card => {
    const title = card.dataset.title || '';
    card.style.display = title.includes(searchQuery) ? 'block' : 'none';
  });
}

// Добавить выбранный товар в заказ
async function addProductToOrder(productId, productName, productPrice, productCostPrice) {
  if (!currentOrderIdForAddItem) {
    Swal.fire('Ошибка', 'Не выбран заказ', 'error');
    return;
  }
  
  try {
    // Получаем текущий заказ
    const orderDoc = await db.collection('orders').doc(currentOrderIdForAddItem).get();
    
    if (!orderDoc.exists) {
      throw new Error('Заказ не найден');
    }
    
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    // Проверяем, есть ли уже такой товар в заказе
    const existingItemIndex = items.findIndex(item => item.id === productId);
    
    if (existingItemIndex !== -1) {
      // Увеличиваем количество
      items[existingItemIndex].qty += 1;
    } else {
      // Добавляем новый товар
      items.push({
        id: productId,
        title: productName,
        price: productPrice,
        costPrice: productCostPrice,
        qty: 1
      });
    }
    
    // Пересчитываем итоговую сумму
    const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
    
    // Обновляем заказ
    await db.collection('orders').doc(currentOrderIdForAddItem).update({
      items,
      total
    });
    
    Swal.fire({
      icon: 'success',
      title: 'Товар добавлен!',
      text: `${productName} добавлен в заказ`,
      timer: 1500,
      showConfirmButton: false
    });
    
    closeAddItemToOrderModal();
    await loadOrdersManagement();
    
  } catch (error) {
    console.error('Ошибка добавления товара:', error);
    Swal.fire('Ошибка', 'Не удалось добавить товар в заказ', 'error');
  }
}

// Экспортировать заказ в Excel и отправить в Telegram
async function exportOrderToExcel(orderId, clientName, clientPhone) {
  try {
    // Получаем заказ
    const orderDoc = await db.collection('orders').doc(orderId).get();
    
    if (!orderDoc.exists) {
      throw new Error('Заказ не найден');
    }
    
    const order = orderDoc.data();
    const items = order.items || [];
    
    if (items.length === 0) {
      Swal.fire('Ошибка', 'В заказе нет товаров', 'error');
      return;
    }
    
    // Загружаем данные товаров из Firebase чтобы получить фотографии
    const productsSnapshot = await db.collection('products').get();
    const productsMap = {};
    productsSnapshot.forEach(doc => {
      const prod = doc.data();
      productsMap[prod.title || prod.name] = prod;
    });
    
    // Добавляем фото к товарам из заказа
    items.forEach(item => {
      const productData = productsMap[item.title];
      if (productData) {
        item.image = productData.image || productData.photo;
        item.photo = productData.photo || productData.image;
      }
    });
    
    // Создаем данные для Excel
    const date = new Date(order.timestamp || Date.now());
    const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    
    // Заголовок
    const excelData = [
      ['ЗАКАЗ КЛИЕНТА'],
      [''],
      ['Клиент:', clientName],
      ['Телефон:', clientPhone],
      ['Адрес:', order.address || 'Не указан'],
      ['Дата заказа:', dateStr],
      [''],
      ['№', 'Товар', 'Количество', 'Цена за шт', 'Сумма']
    ];
    
    // Товары
    let totalAmount = 0;
    items.forEach((item, index) => {
      const itemTotal = item.price * item.qty;
      totalAmount += itemTotal;
      excelData.push([
        index + 1,
        item.title || 'Товар',
        item.qty + ' шт',
        item.price + ' сом',
        itemTotal.toFixed(2) + ' сом'
      ]);
    });
    
    // Итого
    excelData.push(['']);
    excelData.push(['', '', '', 'ИТОГО:', totalAmount.toFixed(2) + ' сом']);
    excelData.push(['']);
    excelData.push(['⚠️ ВНИМАНИЕ: Заказ был изменен администратором']);
    
    // Создаем Excel файл
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    
    // Настройка ширины колонок
    ws['!cols'] = [
      { wch: 5 },   // №
      { wch: 30 },  // Товар
      { wch: 15 },  // Количество
      { wch: 15 },  // Цена
      { wch: 15 }   // Сумма
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Заказ');
    
    // Генерируем файл
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const excelBlob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    
    // ========== ГЕНЕРАЦИЯ PDF С ФОТО (КАК У ОБЫЧНОГО ЗАКАЗА) ==========
    console.log('=== Начало создания PDF файла ===');
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    
    // Заголовок
    const headerCanvas = document.createElement('canvas');
    const headerCtx = headerCanvas.getContext('2d');
    headerCanvas.width = 600;
    headerCanvas.height = 50;
    
    headerCtx.fillStyle = 'white';
    headerCtx.fillRect(0, 0, headerCanvas.width, headerCanvas.height);
    headerCtx.fillStyle = 'black';
    headerCtx.font = 'bold 24px Arial';
    headerCtx.textAlign = 'center';
    headerCtx.fillText('ЗАКАЗ ИЗМЕНЕН', 300, 35);
    
    const headerImage = headerCanvas.toDataURL('image/png');
    doc.addImage(headerImage, 'PNG', 20, yPos, 170, 15);
    
    yPos += 20;
    
    // Информация о заказе в рамке
    const infoCanvas = document.createElement('canvas');
    const infoCtx = infoCanvas.getContext('2d');
    infoCanvas.width = 700;
    infoCanvas.height = 120;
    
    // Белый фон с черной рамкой
    infoCtx.fillStyle = 'white';
    infoCtx.fillRect(0, 0, infoCanvas.width, infoCanvas.height);
    infoCtx.strokeStyle = 'black';
    infoCtx.lineWidth = 2;
    infoCtx.strokeRect(0, 0, infoCanvas.width, infoCanvas.height);
    
    // Текст
    infoCtx.fillStyle = 'black';
    infoCtx.font = '16px Arial';
    infoCtx.fillText(`Дата/Время: ${dateStr}`, 15, 30);
    infoCtx.fillText(`Имя клиента: ${clientName}`, 15, 55);
    infoCtx.fillText(`Телефон: ${clientPhone}`, 15, 80);
    infoCtx.fillText(`Адрес: ${order.address || 'Не указан'}`, 15, 105);
    
    const infoImage = infoCanvas.toDataURL('image/png');
    doc.addImage(infoImage, 'PNG', 20, yPos, 170, 30);
    
    yPos += 35;
    
    // Заголовок таблицы с сеткой
    const tableHeaderCanvas = document.createElement('canvas');
    const thCtx = tableHeaderCanvas.getContext('2d');
    tableHeaderCanvas.width = 550;
    tableHeaderCanvas.height = 50;
    
    // Серый фон для заголовка
    thCtx.fillStyle = '#e0e0e0';
    thCtx.fillRect(0, 0, tableHeaderCanvas.width, tableHeaderCanvas.height);
    
    // Рамка
    thCtx.strokeStyle = 'black';
    thCtx.lineWidth = 2;
    thCtx.strokeRect(0, 0, tableHeaderCanvas.width, tableHeaderCanvas.height);
    
    // Вертикальные линии (колонки: Фото | Название | Кол-во | Цена | Сумма)
    thCtx.beginPath();
    thCtx.moveTo(90, 0);
    thCtx.lineTo(90, 50);
    thCtx.moveTo(310, 0);
    thCtx.lineTo(310, 50);
    thCtx.moveTo(390, 0);
    thCtx.lineTo(390, 50);
    thCtx.moveTo(470, 0);
    thCtx.lineTo(470, 50);
    thCtx.stroke();
    
    // Текст заголовков
    thCtx.fillStyle = 'black';
    thCtx.font = 'bold 14px Arial';
    thCtx.textAlign = 'center';
    thCtx.fillText('ФОТО', 45, 32);
    thCtx.fillText('НАЗВАНИЕ', 200, 32);
    thCtx.fillText('КОЛ-ВО', 350, 32);
    thCtx.fillText('ЦЕНА', 430, 32);
    thCtx.fillText('СУММА', 510, 32);
    
    const tableHeaderImage = tableHeaderCanvas.toDataURL('image/png');
    doc.addImage(tableHeaderImage, 'PNG', 20, yPos, 170, 12);
    
    yPos += 12;
    
    // Товары с сеткой
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      
      // Проверяем, не выходим ли за страницу
      if (yPos > 240) {
        doc.addPage();
        yPos = 20;
      }
      
      // Загружаем фото и определяем его размеры
      let photoWidth = 90;
      let photoHeight = 90;
      let photoData = null;
      
      if ((item.image || item.photo) && (item.image?.startsWith('http') || item.photo?.startsWith('http'))) {
        try {
          const imgUrl = item.image || item.photo;
          const response = await fetch(imgUrl);
          const blob = await response.blob();
          
          const reader = new FileReader();
          const base64 = await new Promise((resolve) => {
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
          
          photoData = base64;
          
          // Определяем размеры фото
          const img = new Image();
          await new Promise((resolve) => {
            img.onload = resolve;
            img.src = base64;
          });
          
          // Рассчитываем размеры фото чтобы влезло в ячейку, сохраняя пропорции
          const maxPhotoWidth = 100;
          const maxPhotoHeight = 100;
          
          let finalWidth = img.width;
          let finalHeight = img.height;
          
          // Масштабируем если фото слишком большое
          if (finalWidth > maxPhotoWidth || finalHeight > maxPhotoHeight) {
            const scale = Math.min(maxPhotoWidth / finalWidth, maxPhotoHeight / finalHeight);
            finalWidth = finalWidth * scale;
            finalHeight = finalHeight * scale;
          }
          
          photoWidth = finalWidth;
          photoHeight = finalHeight;
          
          console.log('✓ Фото загружено:', item.title, `Размер: ${photoWidth.toFixed(0)}x${photoHeight.toFixed(0)}`);
        } catch (err) {
          console.error('✗ Ошибка фото:', item.title, err);
          photoWidth = 90;
          photoHeight = 90;
        }
      }
      
      // Высота строки = высота фото + отступы
      const rowHeight = Math.max(photoHeight + 10, 100);
      
      // Создаем строку таблицы с динамической шириной
      const rowCanvas = document.createElement('canvas');
      const rowCtx = rowCanvas.getContext('2d');
      const photoColumnWidth = Math.max(photoWidth + 10, 70);
      const totalWidth = photoColumnWidth + 480;
      rowCanvas.width = totalWidth;
      rowCanvas.height = rowHeight;
      
      // Белый фон
      rowCtx.fillStyle = 'white';
      rowCtx.fillRect(0, 0, rowCanvas.width, rowCanvas.height);
      
      // Рамка строки
      rowCtx.strokeStyle = 'black';
      rowCtx.lineWidth = 2;
      rowCtx.strokeRect(0, 0, rowCanvas.width, rowCanvas.height);
      
      // Вертикальные линии
      const col2 = photoColumnWidth;
      const col3 = photoColumnWidth + 240;
      const col4 = photoColumnWidth + 320;
      const col5 = photoColumnWidth + 400;
      
      rowCtx.beginPath();
      rowCtx.moveTo(col2, 0);
      rowCtx.lineTo(col2, rowHeight);
      rowCtx.moveTo(col3, 0);
      rowCtx.lineTo(col3, rowHeight);
      rowCtx.moveTo(col4, 0);
      rowCtx.lineTo(col4, rowHeight);
      rowCtx.moveTo(col5, 0);
      rowCtx.lineTo(col5, rowHeight);
      rowCtx.stroke();
      
      // Текст в ячейках
      rowCtx.fillStyle = 'black';
      rowCtx.font = '13px Arial';
      rowCtx.textAlign = 'center';
      
      const midY = rowHeight / 2;
      
      // Название (с переносом если длинное)
      rowCtx.textAlign = 'left';
      const title = item.title || 'Товар';
      if (title.length > 28) {
        rowCtx.fillText(title.substring(0, 28), col2 + 5, midY - 5);
        rowCtx.fillText(title.substring(28), col2 + 5, midY + 10);
      } else {
        rowCtx.fillText(title, col2 + 5, midY);
      }
      
      // Количество
      rowCtx.textAlign = 'center';
      rowCtx.fillText(`${item.qty} шт`, (col3 + col4) / 2, midY);
      
      // Цена
      rowCtx.fillText(`${item.price}`, (col4 + col5) / 2, midY - 5);
      rowCtx.font = '11px Arial';
      rowCtx.fillText('сом', (col4 + col5) / 2, midY + 8);
      
      // Сумма
      rowCtx.font = 'bold 13px Arial';
      rowCtx.fillText(`${item.qty * item.price}`, (col5 + totalWidth) / 2, midY - 5);
      rowCtx.font = '11px Arial';
      rowCtx.fillText('сом', (col5 + totalWidth) / 2, midY + 8);
      
      const rowImage = rowCanvas.toDataURL('image/png');
      const rowPdfHeight = rowHeight * 170 / totalWidth;
      doc.addImage(rowImage, 'PNG', 20, yPos, 170, rowPdfHeight);
      
      // Добавляем фото товара поверх ячейки - ПОЛНОЕ фото без обрезки
      if (photoData) {
        const photoWidthPdf = photoWidth * 170 / totalWidth;
        const photoHeightPdf = photoHeight * 170 / totalWidth;
        const xPos = 22 + (photoColumnWidth * 170 / totalWidth - photoWidthPdf) / 2;
        const yPosImg = yPos + (rowPdfHeight - photoHeightPdf) / 2;
        doc.addImage(photoData, 'JPEG', xPos, yPosImg, photoWidthPdf, photoHeightPdf);
      }
      
      yPos += rowPdfHeight;
    }
    
    // Строка ИТОГО с сеткой
    const totalCanvas = document.createElement('canvas');
    const totalCtx = totalCanvas.getContext('2d');
    totalCanvas.width = 550;
    totalCanvas.height = 60;
    
    // Желтый фон для итого
    totalCtx.fillStyle = '#fff9c4';
    totalCtx.fillRect(0, 0, totalCanvas.width, totalCanvas.height);
    
    // Рамка
    totalCtx.strokeStyle = 'black';
    totalCtx.lineWidth = 3;
    totalCtx.strokeRect(0, 0, totalCanvas.width, totalCanvas.height);
    
    // Вертикальная линия
    totalCtx.beginPath();
    totalCtx.moveTo(470, 0);
    totalCtx.lineTo(470, 60);
    totalCtx.stroke();
    
    // Текст
    totalCtx.fillStyle = 'black';
    totalCtx.font = 'bold 18px Arial';
    totalCtx.textAlign = 'right';
    totalCtx.fillText('ИТОГО:', 450, 38);
    
    totalCtx.textAlign = 'center';
    totalCtx.fillText(`${totalAmount.toFixed(0)}`, 510, 32);
    totalCtx.font = '14px Arial';
    totalCtx.fillText('сом', 510, 48);
    
    const totalImage = totalCanvas.toDataURL('image/png');
    doc.addImage(totalImage, 'PNG', 20, yPos, 170, 15);
    
    console.log('Генерируем PDF файл...');
    
    // Генерируем PDF как blob
    const pdfBlob = doc.output('blob');
    
    console.log('PDF файл сгенерирован, размер:', pdfBlob.size, 'байт');
    
    // ========== ОТПРАВКА В TELEGRAM ==========
    
    // Формируем сообщение
    const message = `📦 *Заказ изменен*\n\n` +
      `👤 Клиент: ${clientName}\n` +
      `📱 Телефон: ${clientPhone}\n` +
      `📅 Дата: ${dateStr}\n` +
      `📍 Адрес: ${order.address || 'Не указан'}\n\n` +
      `🔄 *Заказ был изменен администратором*\n` +
      `📊 Товаров: ${items.length}\n` +
      `💰 Сумма: ${totalAmount.toFixed(2)} сом`;
    
    // Показываем процесс
    Swal.fire({
      title: 'Отправка в Telegram...',
      text: 'Пожалуйста, подождите',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });
    
    // 1. Отправляем Excel файл
    const formData1 = new FormData();
    const excelFileName = `Заказ_${clientName.replace(/\s+/g, '_')}_${Date.now()}.xlsx`;
    formData1.append('document', excelBlob, excelFileName);
    formData1.append('chat_id', '5567924440');
    formData1.append('caption', message + '\n\n📄 Excel файл');
    formData1.append('parse_mode', 'Markdown');
    
    await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData1
    });
    
    // 2. Отправляем PDF файл с фото
    const formData2 = new FormData();
    const pdfFileName = `Заказ_с_фото_${clientName.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
    formData2.append('document', pdfBlob, pdfFileName);
    formData2.append('chat_id', '5567924440');
    formData2.append('caption', '📸 PDF с фотографиями товаров');
    
    const response = await fetch('https://api.telegram.org/bot7960727448:AAF0B2mizrzj7sjHP68n-1IcjLoNc6kwVkE/sendDocument', {
      method: 'POST',
      body: formData2
    });
    
    const result = await response.json();
    
    if (result.ok) {
      Swal.fire({
        icon: 'success',
        title: 'Отправлено!',
        html: `Excel файл отправлен в Telegram<br><strong>${clientName}</strong>`,
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      throw new Error(result.description || 'Ошибка отправки');
    }
    
  } catch (error) {
    console.error('Ошибка экспорта:', error);
    Swal.fire({
      icon: 'error',
      title: 'Ошибка отправки',
      text: error.message || 'Не удалось отправить файл в Telegram'
    });
  }
}

// Закрытие полноэкранного окна админского чата
function closeAdminChatWindow() {
  const adminChatWindow = document.getElementById('adminChatWindow');
  adminChatWindow.style.display = 'none';
  document.body.classList.remove('modal-open'); // Разблокируем скролл
}

// Загрузка чата в полноэкранное окно админа
async function loadAdminFullChat() {
  if (typeof db === 'undefined') {
    document.getElementById('adminFullChatMessages').innerHTML = '<div style="text-align:center; color:#999; padding:40px;">Firebase не подключен</div>';
    return;
  }
  
  try {
    // Загружаем список клиентов
    const clientsSnapshot = await db.collection('chatClients').get();
    
    const messagesDiv = document.getElementById('adminFullChatMessages');
    messagesDiv.innerHTML = `
      <div style="display:flex; height:100%; background:#f8f9fa;">
        <div id="fullClientsList" style="width:280px; border-right:2px solid #e0e0e0; overflow-y:auto; padding:16px; background:white;">
          <div style="font-weight:bold; margin-bottom:16px; color:#333; font-size:17px; padding:12px; background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius:10px; text-align:center;">
            📋 Клиенты (${clientsSnapshot.size})
          </div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column;">
          <div id="fullChatHeader" style="padding:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; font-weight:bold; display:none;">
            <div style="font-size:20px;">Выберите клиента</div>
          </div>
          <div id="fullChatMessagesArea" style="flex:1; display:flex; flex-direction:column; padding:20px; overflow-y:auto; background:#f5f5f5; gap:12px;">
            <div style="text-align:center; color:#999; padding:60px; font-size:18px;">
              👈 Выберите клиента из списка слева
            </div>
          </div>
        </div>
      </div>
    `;
    
    const clientsList = document.getElementById('fullClientsList');
    
    if (clientsSnapshot.empty) {
      clientsList.innerHTML += '<div style="color:#999; font-size:14px; text-align:center; margin-top:60px; padding:30px; line-height:1.6;">Пока нет активных чатов.<br>Клиенты появятся здесь после первого сообщения.</div>';
      return;
    }
    
    // Собираем клиентов в массив и сортируем
    const clients = [];
    clientsSnapshot.forEach((doc) => {
      clients.push({ id: doc.id, data: doc.data() });
    });
    
    clients.sort((a, b) => {
      const timeA = a.data.lastActive ? a.data.lastActive.toDate().getTime() : 0;
      const timeB = b.data.lastActive ? b.data.lastActive.toDate().getTime() : 0;
      return timeB - timeA;
    });
    
    // Добавляем клиентов в список
    clients.forEach(({id, data: client}) => {
      const clientDiv = document.createElement('div');
      clientDiv.style.cssText = `
        padding:14px; margin-bottom:12px; background:${client.hasUnread ? '#fff9c4' : '#f8f9fa'}; 
        border-radius:12px; cursor:pointer; transition:all 0.2s; border:2px solid transparent;
      `;
      clientDiv.innerHTML = `
        <div style="font-weight:bold; color:#333; margin-bottom:6px; font-size:16px;">${client.name}</div>
        <div style="font-size:12px; color:#666;">
          ${client.lastActive ? new Date(client.lastActive.toDate()).toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          }) : 'Давно'}
        </div>
        ${client.hasUnread ? '<div style="font-size:11px; color:#f57c00; font-weight:bold; margin-top:8px;">🔔 НОВОЕ СООБЩЕНИЕ</div>' : ''}
      `;
      
      clientDiv.onmouseover = () => clientDiv.style.borderColor = '#667eea';
      clientDiv.onmouseout = () => {
        if (selectedClientId !== id) clientDiv.style.borderColor = 'transparent';
      };
      
      clientDiv.onclick = () => loadFullClientMessages(id, client.name, clientDiv);
      clientsList.appendChild(clientDiv);
    });
    
  } catch (error) {
    console.error('Ошибка загрузки клиентов:', error);
    document.getElementById('adminFullChatMessages').innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">Ошибка загрузки клиентов</div>';
  }
}

// Загрузка сообщений клиента в полноэкранном окне
async function loadFullClientMessages(clientId, clientName, clientDiv) {
  selectedClientId = clientId;
  selectedClientName = clientName;
  
  // Подсвечиваем выбранного клиента
  document.querySelectorAll('#fullClientsList > div').forEach(div => {
    if (div.style && div !== clientDiv) {
      div.style.borderColor = 'transparent';
      div.style.background = '#f8f9fa';
    }
  });
  if (clientDiv) {
    clientDiv.style.borderColor = '#667eea';
    clientDiv.style.background = '#e3f2fd';
  }
  
  // Убираем метку "новое"
  try {
    await db.collection('chatClients').doc(clientId).update({ hasUnread: false });
  } catch (error) {
    console.error('Ошибка обновления статуса:', error);
  }
  
  // Обновляем заголовок
  const chatHeader = document.getElementById('fullChatHeader');
  chatHeader.style.display = 'flex';
  chatHeader.style.justifyContent = 'space-between';
  chatHeader.style.alignItems = 'center';
  chatHeader.innerHTML = `
    <div>
      <div style="font-size:20px;">💬 Чат с ${clientName}</div>
      <div style="font-size:13px; opacity:0.9; margin-top:6px;">ID: ${clientId}</div>
    </div>
    <button onclick="changeClientNameByAdmin()" style="background:rgba(255,255,255,0.25); border:none; color:white; font-size:20px; cursor:pointer; padding:10px; border-radius:10px; min-width:50px; height:50px; display:flex; align-items:center; justify-content:center; transition:background 0.2s;" title="Изменить имя клиента" onmouseover="this.style.background='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'">
      ✏️
    </button>
  `;
  
  try {
    const querySnapshot = await db.collection('chatMessages')
      .where('clientId', '==', clientId)
      .get();
    
    const chatArea = document.getElementById('fullChatMessagesArea');
    chatArea.innerHTML = '';
    
    if (querySnapshot.empty) {
      chatArea.innerHTML = `<div style="text-align:center; color:#999; padding:60px; font-size:16px;">Нет сообщений с ${clientName}</div>`;
      return;
    }
    
    const messages = [];
    querySnapshot.forEach((doc) => {
      const msg = doc.data();
      messages.push({
        text: msg.text,
        sender: msg.sender,
        timestamp: msg.timestamp.toDate()
      });
    });
    
    messages.sort((a, b) => a.timestamp - b.timestamp);
    
    messages.forEach(msg => {
      addAdminFullChatMessageToUI(msg.text, msg.sender, msg.timestamp);
    });
    
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // Обновляем placeholder
    const inputField = document.getElementById('adminFullChatInput');
    if (inputField) {
      inputField.placeholder = `Ответить ${clientName}...`;
    }
    
    // Подписываемся на новые сообщения
    subscribeToAdminFullChatMessages(clientId);
    
  } catch (error) {
    console.error('Ошибка загрузки сообщений:', error);
    document.getElementById('fullChatMessagesArea').innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">Ошибка загрузки сообщений</div>';
  }
}

// Добавление сообщения в UI полноэкранного админского чата
function addAdminFullChatMessageToUI(text, sender, timestamp) {
  const chatArea = document.getElementById('fullChatMessagesArea');
  if (!chatArea) return;
  
  const timeStr = timestamp.getHours().toString().padStart(2, '0') + ':' + timestamp.getMinutes().toString().padStart(2, '0');
  const dateStr = timestamp.toLocaleDateString('ru-RU');
  
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = 'display:flex;';
  
  const msgContent = document.createElement('div');
  
  if (sender === 'client') {
    msgContent.style.cssText = 'background:white; padding:14px; border-radius:14px 14px 14px 4px; max-width:70%; box-shadow:0 2px 6px rgba(0,0,0,0.1);';
    msgContent.innerHTML = `
      <div style="font-size:13px; color:#667eea; font-weight:bold; margin-bottom:6px;">👤 ${selectedClientName || 'Клиент'}</div>
      <div style="font-size:15px; color:#333;">${escapeHtml(text)}</div>
      <div style="font-size:11px; color:#999; margin-top:6px;">${dateStr} ${timeStr}</div>
    `;
  } else {
    messageDiv.style.justifyContent = 'flex-end';
    msgContent.style.cssText = 'background:#667eea; color:white; padding:14px; border-radius:14px 14px 4px 14px; max-width:70%; box-shadow:0 2px 6px rgba(0,0,0,0.15);';
    msgContent.innerHTML = `
      <div style="font-size:13px; font-weight:bold; margin-bottom:6px; opacity:0.9;">✅ Вы</div>
      <div style="font-size:15px;">${escapeHtml(text)}</div>
      <div style="font-size:11px; opacity:0.9; margin-top:6px; text-align:right;">${dateStr} ${timeStr}</div>
    `;
  }
  
  messageDiv.appendChild(msgContent);
  chatArea.appendChild(messageDiv);
}

// Отправка сообщения в полноэкранном окне
async function sendAdminFullChatMessage() {
  if (!selectedClientId) {
    Swal.fire('Ошибка', 'Сначала выберите клиента из списка слева', 'warning');
    return;
  }
  
  const input = document.getElementById('adminFullChatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  const now = new Date();
  
  try {
    addAdminFullChatMessageToUI(message, 'admin', now);
    
    await db.collection('chatMessages').add({
      text: message,
      sender: 'admin',
      clientId: selectedClientId,
      clientName: selectedClientName,
      timestamp: firebase.firestore.Timestamp.fromDate(now),
      read: false
    });
    
    input.value = '';
    
    const chatArea = document.getElementById('fullChatMessagesArea');
    chatArea.scrollTop = chatArea.scrollHeight;
    
  } catch (error) {
    console.error('Ошибка отправки:', error);
    Swal.fire('Ошибка', 'Не удалось отправить сообщение', 'error');
  }
}

// Изменение имени клиента админом
async function changeClientNameByAdmin() {
  if (!selectedClientId) {
    Swal.fire('Ошибка', 'Сначала выберите клиента', 'warning');
    return;
  }
  
  const { value: newName } = await Swal.fire({
    title: 'Изменить имя клиента',
    input: 'text',
    inputLabel: 'Введите новое имя для клиента',
    inputValue: selectedClientName || '',
    showCancelButton: true,
    confirmButtonText: 'Сохранить',
    cancelButtonText: 'Отмена',
    inputValidator: (value) => {
      if (!value) {
        return 'Пожалуйста, введите имя!';
      }
    }
  });
  
  if (newName && newName !== selectedClientName) {
    try {
      // Обновляем имя в базе данных
      await db.collection('chatClients').doc(selectedClientId).update({
        name: newName,
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Обновляем локальную переменную
      selectedClientName = newName;
      
      // Обновляем заголовок
      const chatHeader = document.getElementById('fullChatHeader');
      if (chatHeader) {
        chatHeader.querySelector('div > div:first-child').textContent = `💬 Чат с ${newName}`;
      }
      
      // Обновляем placeholder поля ввода
      const inputField = document.getElementById('adminFullChatInput');
      if (inputField) {
        inputField.placeholder = `Ответить ${newName}...`;
      }
      
      // Перезагружаем список клиентов чтобы отобразить новое имя
      await loadAdminFullChat();
      
      Swal.fire({
        icon: 'success',
        title: 'Имя изменено!',
        text: `Клиент теперь: ${newName}`,
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 2000
      });
      
    } catch (error) {
      console.error('Ошибка обновления имени:', error);
      Swal.fire('Ошибка', 'Не удалось обновить имя клиента', 'error');
    }
  }
}

// Подписка на новые сообщения в полноэкранном окне
function subscribeToAdminFullChatMessages(clientId) {
  if (typeof db === 'undefined') return;
  
  db.collection('chatMessages')
    .where('clientId', '==', clientId)
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const msg = change.doc.data();
          if (msg.sender === 'client' && msg.clientId === selectedClientId) {
            const chatArea = document.getElementById('fullChatMessagesArea');
            const existingMessages = chatArea.querySelectorAll('div');
            let isDuplicate = false;
            existingMessages.forEach(div => {
              if (div.textContent && div.textContent.includes(msg.text)) {
                isDuplicate = true;
              }
            });
            
            if (!isDuplicate) {
              addAdminFullChatMessageToUI(msg.text, msg.sender, msg.timestamp.toDate());
              chatArea.scrollTop = chatArea.scrollHeight;
            }
          }
        }
      });
    });
}

// Вход администратора из меню
function loginAdminFromMenu() {
  const password = document.getElementById('menuAdminPassword').value;
  
  if (password === ADMIN_PASSWORD) {
    isAdmin = true;
    
    const managementHeader = document.getElementById('managementHeader');
    
    if (managementHeader) managementHeader.style.display = 'table-cell';
    
    // Переключаем отображение в меню
    document.getElementById('menuAdminLogin').style.display = 'none';
    document.getElementById('menuAdminLoggedIn').style.display = 'flex';
    
    Swal.fire('Успех!', 'Вы вошли как администратор', 'success');
    renderProducts();
    
    // Закрываем меню
    toggleSideMenu();
  } else {
    Swal.fire('Ошибка', 'Неверный пароль', 'error');
  }
}

// Выход из режима администратора
function logoutAdmin() {
  isAdmin = false;
  
  const managementHeader = document.getElementById('managementHeader');
  
  if (managementHeader) managementHeader.style.display = 'none';
  
  // Переключаем отображение в меню
  document.getElementById('menuAdminLogin').style.display = 'flex';
  document.getElementById('menuAdminLoggedIn').style.display = 'none';
  document.getElementById('menuAdminPassword').value = '';
  
  renderProducts();
  
  Swal.fire('Выход', 'Вы вышли из режима администратора', 'info');
  toggleSideMenu();
}

// ==================== КОНЕЦ ФУНКЦИЙ БОКОВОГО МЕНЮ ====================

// ==================== ОТЧЕТ ПО ПРИБЫЛИ ====================

// Открыть окно отчета по прибыли
let profitReportOrdersListener = null;
let profitReportExpensesListener = null;
let profitReportAutoRefresh = null;
let currentProfitTab = 'products'; // Отслеживаем текущую вкладку

function openProfitReport() {
  document.getElementById('profitReportWindow').style.display = 'block';
  document.body.classList.add('modal-open'); // Блокируем скролл
  loadProfitReport();
  toggleSideMenu(); // Закрываем меню
  
  // Отписываемся от предыдущих слушателей
  if (profitReportOrdersListener) profitReportOrdersListener();
  if (profitReportExpensesListener) profitReportExpensesListener();
  if (profitReportAutoRefresh) clearInterval(profitReportAutoRefresh);
  
  // Слушатель заказов
  profitReportOrdersListener = db.collection('orders').onSnapshot(() => {
    console.log('🔔 Заказы изменились');
    if (currentProfitTab === 'expenses') {
      console.log('📊 Обновляем Расходы из-за изменения заказов');
      loadExpensesReport();
    } else if (currentProfitTab === 'orders') {
      console.log('📋 Обновляем Заказы');
      loadOrderProfitReport();
    }
  });
  
  // Слушатель расходов
  profitReportExpensesListener = db.collection('expenses').onSnapshot(() => {
    console.log('💸 Расходы изменились');
    if (currentProfitTab === 'expenses') {
      console.log('📊 Обновляем Расходы из-за изменения расходов');
      loadExpensesReport();
    }
  });
  
  // Автообновление каждые 3 секунды для вкладки расходов (резервный механизм)
  profitReportAutoRefresh = setInterval(() => {
    if (currentProfitTab === 'expenses') {
      console.log('⏰ Автообновление расходов (каждые 3 сек)');
      loadExpensesReport();
    }
  }, 3000);
}

// Закрыть окно отчета
function closeProfitReport() {
  document.getElementById('profitReportWindow').style.display = 'none';
  document.body.classList.remove('modal-open'); // Разблокируем скролл
  
  // Отписываемся от слушателей при закрытии окна
  if (profitReportOrdersListener) {
    profitReportOrdersListener();
    profitReportOrdersListener = null;
  }
  if (profitReportExpensesListener) {
    profitReportExpensesListener();
    profitReportExpensesListener = null;
  }
  if (profitReportAutoRefresh) {
    clearInterval(profitReportAutoRefresh);
    profitReportAutoRefresh = null;
  }
}

// Загрузить данные отчета
function loadProfitReport() {
  const productsWithCost = products.filter(p => p.costPrice && p.price);
  
  // Вычисляем общую прибыль и среднюю наценку
  let totalProfit = 0;
  let totalMarkup = 0;
  let count = 0;
  
  productsWithCost.forEach(p => {
    const profit = p.price - p.costPrice;
    const markup = ((profit / p.costPrice) * 100);
    totalProfit += profit;
    totalMarkup += markup;
    count++;
  });
  
  const avgMarkup = count > 0 ? (totalMarkup / count).toFixed(1) : 0;
  
  // Обновляем сводку
  document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' сом';
  document.getElementById('avgMarkup').textContent = avgMarkup + '%';
  document.getElementById('totalProducts').textContent = productsWithCost.length;
  
  // Отображаем таблицу
  filterProfitReport();
}

// Фильтрация и сортировка отчета
function filterProfitReport() {
  const category = document.getElementById('profitCategoryFilter').value;
  const sortBy = document.getElementById('profitSortFilter').value;
  
  let filtered = products.filter(p => p.costPrice && p.price);
  
  // Фильтр по категории
  if (category) {
    filtered = filtered.filter(p => (p.category || 'все').toLowerCase() === category.toLowerCase());
  }
  
  // Сортировка
  filtered.sort((a, b) => {
    const profitA = a.price - a.costPrice;
    const profitB = b.price - b.costPrice;
    const markupA = ((profitA / a.costPrice) * 100);
    const markupB = ((profitB / b.costPrice) * 100);
    
    switch(sortBy) {
      case 'profit-desc': return profitB - profitA;
      case 'profit-asc': return profitA - profitB;
      case 'markup-desc': return markupB - markupA;
      case 'markup-asc': return markupA - markupB;
      case 'name': return (a.title || '').localeCompare(b.title || '');
      default: return profitB - profitA;
    }
  });
  
  // Отображаем в таблице
  const tbody = document.getElementById('profitReportBody');
  tbody.innerHTML = '';
  
  filtered.forEach((p, index) => {
    const profit = p.price - p.costPrice;
    const markup = ((profit / p.costPrice) * 100).toFixed(1);
    const profitColor = profit > 0 ? '#28a745' : profit < 0 ? '#dc3545' : '#ffc107';
    
    const row = document.createElement('tr');
    row.style.borderBottom = '1px solid #e0e0e0';
    row.innerHTML = `
      <td style="padding:12px; font-size:14px; color:#666;">${index + 1}</td>
      <td style="padding:12px; font-size:14px; font-weight:600;">${p.title || 'Без названия'}</td>
      <td style="padding:12px; font-size:13px; text-align:center; color:#666;">${p.category || 'все'}</td>
      <td style="padding:12px; font-size:14px; text-align:right; color:#666;">${p.costPrice.toFixed(2)} сом</td>
      <td style="padding:12px; font-size:14px; text-align:right; font-weight:600;">${p.price.toFixed(2)} сом</td>
      <td style="padding:12px; font-size:14px; text-align:right; font-weight:700; color:${profitColor};">${profit > 0 ? '+' : ''}${profit.toFixed(2)} сом</td>
      <td style="padding:12px; font-size:14px; text-align:right; font-weight:700; color:${profitColor};">${markup}%</td>
    `;
    tbody.appendChild(row);
  });
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="padding:30px; text-align:center; color:#999;">Нет данных для отображения</td></tr>';
  }
}

// Экспорт в Excel
async function exportProfitToExcel() {
  const category = document.getElementById('profitCategoryFilter').value;
  let filtered = products.filter(p => p.costPrice && p.price);
  
  if (category) {
    filtered = filtered.filter(p => (p.category || 'все').toLowerCase() === category.toLowerCase());
  }
  
  const wb = XLSX.utils.book_new();
  const wsData = [
    ['№', 'Товар', 'Категория', 'Цена закупки', 'Цена продажи', 'Прибыль', 'Наценка %']
  ];
  
  filtered.forEach((p, index) => {
    const profit = p.price - p.costPrice;
    const markup = ((profit / p.costPrice) * 100).toFixed(1);
    wsData.push([
      index + 1,
      p.title || 'Без названия',
      p.category || 'все',
      p.costPrice,
      p.price,
      profit.toFixed(2),
      markup
    ]);
  });
  
  // Добавляем итоги
  const totalProfit = filtered.reduce((sum, p) => sum + (p.price - p.costPrice), 0);
  const avgMarkup = filtered.length > 0 
    ? (filtered.reduce((sum, p) => sum + ((p.price - p.costPrice) / p.costPrice * 100), 0) / filtered.length).toFixed(1)
    : 0;
  
  wsData.push([]);
  wsData.push(['', '', '', '', 'ИТОГО:', totalProfit.toFixed(2), avgMarkup + '%']);
  
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, 'Отчет по прибыли');
  XLSX.writeFile(wb, `Отчет_по_прибыли_${new Date().toLocaleDateString()}.xlsx`);
  
  Swal.fire('Готово!', 'Отчет экспортирован в Excel', 'success');
}

// Переключение вкладок в отчете
function switchProfitTab(tab) {
  currentProfitTab = tab; // Сохраняем текущую вкладку
  console.log('🔄 Переключение на вкладку:', tab);
  
  const tabProducts = document.getElementById('tabProducts');
  const tabOrders = document.getElementById('tabOrders');
  const tabExpenses = document.getElementById('tabExpenses');
  const productsPanel = document.getElementById('profitProductsPanel');
  const ordersPanel = document.getElementById('profitOrdersPanel');
  const expensesPanel = document.getElementById('profitExpensesPanel');
  const productsTable = document.getElementById('profitProductsTable');
  const ordersTable = document.getElementById('profitOrdersTable');
  const expensesTable = document.getElementById('profitExpensesTable');
  
  // Сброс стилей всех кнопок
  [tabProducts, tabOrders, tabExpenses].forEach(btn => {
    btn.style.background = '#e9ecef';
    btn.style.color = '#333';
    btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
  });
  
  // Скрыть все панели и таблицы
  productsPanel.style.display = 'none';
  ordersPanel.style.display = 'none';
  expensesPanel.style.display = 'none';
  productsTable.style.display = 'none';
  ordersTable.style.display = 'none';
  expensesTable.style.display = 'none';
  
  if (tab === 'products') {
    tabProducts.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
    tabProducts.style.color = 'white';
    tabProducts.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
    productsPanel.style.display = 'block';
    productsTable.style.display = 'block';
  } else if (tab === 'orders') {
    tabOrders.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
    tabOrders.style.color = 'white';
    tabOrders.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
    ordersPanel.style.display = 'block';
    ordersTable.style.display = 'block';
    loadOrderProfitReport();
  } else if (tab === 'expenses') {
    tabExpenses.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
    tabExpenses.style.color = 'white';
    tabExpenses.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
    expensesPanel.style.display = 'block';
    expensesTable.style.display = 'block';
    loadExpensesReport();
  }
}

// Загрузить отчет по заказам
async function loadOrderProfitReport() {
  console.log('🔵 loadOrderProfitReport ВЫЗВАНА');
  try {
    const ordersSnapshot = await db.collection('orders').get();
    const orders = [];
    
    console.log('📦 Загружено заказов из Firebase:', ordersSnapshot.size);
    
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      orders.push({
        id: doc.id,
        ...data,
        timestamp: data.timestamp || Date.now()
      });
    });
    
    console.log('📋 Заказы после обработки:', orders.length);
    
    await filterOrderProfitReport(orders);
  } catch (error) {
    console.error('❌ Ошибка загрузки заказов:', error);
    Swal.fire('Ошибка', 'Не удалось загрузить заказы', 'error');
  }
}

// Фильтрация отчета по заказам
async function filterOrderProfitReport(ordersData = null) {
  console.log('🟢 filterOrderProfitReport ВЫЗВАНА, получено заказов:', ordersData ? ordersData.length : 'null');
  
  const dateFilter = document.getElementById('orderDateFilter').value;
  const sortBy = document.getElementById('orderSortFilter').value;
  
  console.log('🔍 Фильтры:', { dateFilter, sortBy });
  
  // Если данные не переданы, загружаем заново
  if (!ordersData) {
    console.log('⚠️ Данные не переданы, вызываю loadOrderProfitReport');
    loadOrderProfitReport();
    return;
  }
  
  // Загружаем все товары с себестоимостью из Firebase
  let productsMap = new Map();
  try {
    const productsSnapshot = await db.collection('products').get();
    console.log('🛍️ Загружено товаров из Firebase:', productsSnapshot.size);
    
    productsSnapshot.forEach(doc => {
      const data = doc.data();
      productsMap.set(doc.id, {
        name: data.name || 'Неизвестный товар',
        costPrice: data.costPrice || 0,
        salePrice: data.price || 0
      });
    });
    
    console.log('💰 Товаров в карте:', productsMap.size);
  } catch (error) {
    console.error('❌ Ошибка загрузки товаров:', error);
  }
  
  // Фильтр по дате
  const now = Date.now();
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayStart = today.getTime();
  const yesterdayStart = todayStart - 86400000;
  const weekStart = todayStart - 7 * 86400000;
  const monthStart = todayStart - 30 * 86400000;
  
  let filtered = ordersData.filter(order => {
    const orderTime = order.timestamp;
    switch(dateFilter) {
      case 'today': return orderTime >= todayStart;
      case 'yesterday': return orderTime >= yesterdayStart && orderTime < todayStart;
      case 'week': return orderTime >= weekStart;
      case 'month': return orderTime >= monthStart;
      case 'all': return true;
      default: return true;
    }
  });
  
  // Рассчитываем прибыль для каждого заказа
  const ordersWithProfit = filtered.map(order => {
    let totalCost = 0;
    let totalSale = 0;
    let totalProfit = 0; // Добавлена переменная для суммы прибыли
    const items = order.items || [];
    
    console.log('=== ЗАКАЗ ===', {
      name: order.name,
      phone: order.phone,
      timestamp: new Date(order.timestamp).toLocaleString()
    });
    
    items.forEach(item => {
      const productData = productsMap.get(item.id);
      // Используем себестоимость из заказа, если она есть, иначе из базы товаров
      const costPrice = item.costPrice || (productData ? productData.costPrice : 0);
      const itemCost = costPrice * item.qty;
      const itemSale = item.price * item.qty;
      // Если себестоимость = 0 или не указана, прибыль = 0
      const itemProfit = costPrice > 0 ? (itemSale - itemCost) : 0;
      
      console.log('📦 Товар:', item.title || (productData ? productData.name : 'Неизвестный товар'), {
        'ID товара': item.id,
        'Название': item.title,
        'Количество': item.qty,
        'Цена в заказе (за шт)': item.price,
        'Себестоимость из заказа': item.costPrice,
        'Себестоимость из базы': productData ? productData.costPrice : 0,
        'Используется себестоимость': costPrice,
        '---': '---',
        'Сумма продажи': itemSale,
        'Сумма себестоимости': itemCost,
        'ПРИБЫЛЬ': itemProfit,
        '---2': '---',
        'Расчет': `(${item.price} × ${item.qty}) - (${costPrice} × ${item.qty}) = ${itemSale} - ${itemCost} = ${itemProfit}`
      });
      
      // Считаем себестоимость, продажу и прибыль (прибыль = 0 если costPrice = 0)
      totalCost += costPrice * item.qty;
      totalSale += item.price * item.qty;
      totalProfit += itemProfit; // Используем рассчитанную прибыль товара
    });
    
    console.log('ИТОГО ЗАКАЗ:', {
      себестоимость: totalCost,
      продажа: totalSale,
      прибыль: totalProfit
    });
    console.log('---');
    
    return {
      ...order,
      totalCost,
      totalSale,
      profit: totalProfit, // Используем сумму прибылей товаров
      itemsCount: items.reduce((sum, item) => sum + item.qty, 0)
    };
  });
  
  // Сортировка
  ordersWithProfit.sort((a, b) => {
    switch(sortBy) {
      case 'profit-desc': return b.profit - a.profit;
      case 'date-desc': return b.timestamp - a.timestamp;
      case 'date-asc': return a.timestamp - b.timestamp;
      default: return b.profit - a.profit;
    }
  });
  
  // Обновляем сводку
  const totalProfit = ordersWithProfit.reduce((sum, o) => sum + o.profit, 0);
  const uniqueClients = new Set(ordersWithProfit.map(o => o.phone || o.name)).size;
  
  document.getElementById('totalOrderProfit').textContent = totalProfit.toFixed(2) + ' сом';
  document.getElementById('totalOrdersCount').textContent = ordersWithProfit.length;
  document.getElementById('totalClientsCount').textContent = uniqueClients;
  
  // Отображаем в таблице
  const tbody = document.getElementById('orderProfitReportBody');
  tbody.innerHTML = '';
  
  // Группировка по клиентам
  const clientMap = new Map();
  ordersWithProfit.forEach(order => {
    const clientKey = order.phone || order.name || 'Неизвестный';
    if (!clientMap.has(clientKey)) {
      clientMap.set(clientKey, {
        name: order.name || 'Неизвестный',
        phone: order.phone || '',
        orders: [],
        totalProfit: 0,
        totalSale: 0,
        totalCost: 0
      });
    }
    const client = clientMap.get(clientKey);
    client.orders.push(order);
    client.totalProfit += order.profit;
    client.totalSale += order.totalSale;
    client.totalCost += order.totalCost;
  });
  
  // Сортируем клиентов по прибыли
  const clients = Array.from(clientMap.values()).sort((a, b) => b.totalProfit - a.totalProfit);
  
  let rowIndex = 0;
  clients.forEach(client => {
    // Сортируем заказы клиента от нового к старому (последний заказ первым)
    client.orders.sort((a, b) => b.timestamp - a.timestamp);
    
    // Строка клиента (группировочная)
    const clientRow = document.createElement('tr');
    clientRow.style.background = '#f0f8ff';
    clientRow.style.borderBottom = '2px solid #007bff';
    clientRow.style.fontWeight = '600';
    clientRow.innerHTML = `
      <td style="padding:12px; font-size:14px;" colspan="7">
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="cursor:pointer;" onclick="openClientOrdersDetail(${JSON.stringify(client).replace(/"/g, '&quot;')})">▶</span>
          👤 ${client.name} ${client.phone ? '(' + client.phone + ')' : ''} - ${client.orders.length} заказов - Прибыль: <span style="color:#28a745; font-weight:700;">+${client.totalProfit.toFixed(2)} сом</span>
        </div>
      </td>
    `;
    tbody.appendChild(clientRow);
    
    // Заказы клиента (скрытые по умолчанию)
    client.orders.forEach((order, orderIdx) => {
      // Заголовок заказа
      const orderHeaderRow = document.createElement('tr');
      orderHeaderRow.className = 'client-' + rowIndex;
      orderHeaderRow.style.display = 'none';
      orderHeaderRow.style.background = '#e3f2fd';
      orderHeaderRow.style.borderBottom = '2px solid #2196f3';
      
      const date = new Date(order.timestamp);
      const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
      const profitColor = order.profit > 0 ? '#28a745' : order.profit < 0 ? '#dc3545' : '#ffc107';
      
      orderHeaderRow.innerHTML = `
        <td colspan="7" style="padding:10px 12px 10px 50px; font-size:13px; font-weight:600;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span>📅 Заказ #${orderIdx + 1} от ${dateStr} - ${order.address || 'Адрес не указан'}</span>
            <button onclick="deleteSpecificOrder('${order.id}', '${client.name}')" style="background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:600;">🗑️ Удалить заказ</button>
          </div>
        </td>
      `;
      tbody.appendChild(orderHeaderRow);
      
      // Таблица товаров в заказе
      const items = order.items || [];
      items.forEach((item, itemIdx) => {
        const productData = productsMap.get(item.id);
        const productName = item.title || (productData ? productData.name : 'Неизвестный товар');
        // Используем себестоимость из заказа, если она есть, иначе из базы товаров
        const costPrice = item.costPrice || (productData ? productData.costPrice : 0);
        const itemCost = costPrice * item.qty;
        const itemSale = item.price * item.qty;
        // Если себестоимость = 0 или не указана, прибыль = 0
        const itemProfit = costPrice > 0 ? (itemSale - itemCost) : 0;
        const itemProfitColor = itemProfit > 0 ? '#28a745' : itemProfit < 0 ? '#dc3545' : '#666';
        
        const itemRow = document.createElement('tr');
        itemRow.className = 'client-' + rowIndex;
        itemRow.style.display = 'none';
        itemRow.style.background = '#fafafa';
        itemRow.style.borderBottom = '1px solid #e0e0e0';
        
        itemRow.innerHTML = `
          <td style="padding:8px 12px 8px 70px; font-size:12px; color:#666;">${itemIdx + 1}</td>
          <td style="padding:8px 12px; font-size:12px;" colspan="2">${productName}</td>
          <td style="padding:8px 12px; font-size:12px; text-align:center;">
            <div style="display:flex; align-items:center; gap:6px; justify-content:center;">
              <input type="number" 
                id="qty_${order.id}_${itemIdx}" 
                value="${item.qty}" 
                min="0" 
                style="width:60px; padding:4px 8px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:12px;"
                onchange="updateOrderItemQty('${order.id}', ${itemIdx}, this.value)">
              <span style="color:#666; font-size:11px;">шт</span>
            </div>
          </td>
          <td style="padding:8px 12px; font-size:12px; text-align:right;">
            <div style="color:#666;">Купил: ${costPrice.toFixed(2)} сом</div>
            <div style="color:#666; font-size:11px;">Всего: ${itemCost.toFixed(2)} сом</div>
          </td>
          <td style="padding:8px 12px; font-size:12px; text-align:right;">
            <div style="font-weight:600;">Продал: ${item.price.toFixed(2)} сом</div>
            <div style="font-size:11px;">Всего: ${itemSale.toFixed(2)} сом</div>
          </td>
          <td style="padding:8px 12px; font-size:12px; text-align:right; font-weight:700; color:${itemProfitColor};">
            +${itemProfit.toFixed(2)} сом
          </td>
        `;
        tbody.appendChild(itemRow);
      });
      
      // Итоговая строка заказа
      const orderTotalRow = document.createElement('tr');
      orderTotalRow.className = 'client-' + rowIndex;
      orderTotalRow.style.display = 'none';
      orderTotalRow.style.background = '#fff3cd';
      orderTotalRow.style.borderBottom = '2px solid #ffc107';
      orderTotalRow.style.fontWeight = '700';
      
      orderTotalRow.innerHTML = `
        <td colspan="4" style="padding:10px 12px 10px 70px; font-size:13px; text-align:right;">ИТОГО по заказу:</td>
        <td style="padding:10px 12px; font-size:13px; text-align:right; color:#666;">Закупка: ${order.totalCost.toFixed(2)} сом</td>
        <td style="padding:10px 12px; font-size:13px; text-align:right;">Продажа: ${order.totalSale.toFixed(2)} сом</td>
        <td style="padding:10px 12px; font-size:13px; text-align:right; color:${profitColor};">Прибыль: +${order.profit.toFixed(2)} сом</td>
      `;
      tbody.appendChild(orderTotalRow);
    });
    
    rowIndex++;
  });
  
  if (clients.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="padding:30px; text-align:center; color:#999;">Нет заказов за выбранный период</td></tr>';
  }
}

// Показать/скрыть заказы клиента
function toggleClientOrders(clientClass) {
  const rows = document.querySelectorAll('.' + clientClass);
  const isHidden = rows[0].style.display === 'none';
  
  rows.forEach(row => {
    row.style.display = isHidden ? 'table-row' : 'none';
  });
  
  // Если раскрываем заказы, прокручиваем к последнему товару
  if (isHidden && rows.length > 0) {
    setTimeout(() => {
      const lastRow = rows[rows.length - 1];
      lastRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  }
}

// Открыть модальное окно с детальной информацией о заказах клиента
function openClientOrdersDetail(clientData) {
  const modal = document.getElementById('clientOrdersDetailModal');
  modal.style.display = 'flex';
  document.body.classList.add('modal-open');
  
  // Устанавливаем заголовок
  document.getElementById('clientDetailName').textContent = `👤 ${clientData.name}`;
  document.getElementById('clientDetailInfo').textContent = clientData.phone ? `📱 ${clientData.phone}` : 'Телефон не указан';
  
  // Устанавливаем сводку
  document.getElementById('clientDetailTotalOrders').textContent = clientData.orders.length;
  document.getElementById('clientDetailTotalSale').textContent = clientData.totalSale.toFixed(2) + ' сом';
  document.getElementById('clientDetailTotalProfit').textContent = '+' + clientData.totalProfit.toFixed(2) + ' сом';
  
  // Загружаем список заказов
  const listDiv = document.getElementById('clientOrdersDetailList');
  listDiv.innerHTML = '';
  
  clientData.orders.forEach((order, orderIdx) => {
    const orderCard = document.createElement('div');
    orderCard.style.cssText = 'background:white; border:1px solid #e0e0e0; border-radius:10px; padding:15px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.05);';
    
    const date = new Date(order.timestamp);
    const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    const profitColor = order.profit > 0 ? '#28a745' : order.profit < 0 ? '#dc3545' : '#ffc107';
    
    let itemsHTML = '';
    const items = order.items || [];
    items.forEach((item, itemIdx) => {
      const itemSale = item.price * item.qty;
      const costPrice = item.costPrice || 0;
      const itemCost = costPrice * item.qty;
      const itemProfit = costPrice > 0 ? (itemSale - itemCost) : 0;
      const itemProfitColor = itemProfit > 0 ? '#28a745' : itemProfit < 0 ? '#dc3545' : '#666';
      
      itemsHTML += `
        <tr style="border-bottom:1px solid #f0f0f0;">
          <td style="padding:8px; font-size:13px;">${itemIdx + 1}</td>
          <td style="padding:8px; font-size:13px; font-weight:600;">${item.title || 'Товар'}</td>
          <td style="padding:8px; font-size:13px; text-align:center;">${item.qty} шт</td>
          <td style="padding:8px; font-size:13px; text-align:right;">${item.price} сом</td>
          <td style="padding:8px; font-size:13px; text-align:right;">${costPrice} сом</td>
          <td style="padding:8px; font-size:13px; text-align:right;">${itemSale.toFixed(2)} сом</td>
          <td style="padding:8px; font-size:13px; text-align:right;">${itemCost.toFixed(2)} сом</td>
          <td style="padding:8px; font-size:13px; text-align:right; font-weight:700; color:${itemProfitColor};">
            ${itemProfit > 0 ? '+' : ''}${itemProfit.toFixed(2)} сом
          </td>
        </tr>
      `;
    });
    
    orderCard.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:15px;">
        <div>
          <div style="font-size:18px; font-weight:700; color:#333; margin-bottom:5px;">
            📦 Заказ #${orderIdx + 1}
          </div>
          <div style="font-size:14px; color:#666;">
            📅 ${dateStr}
          </div>
          <div style="font-size:14px; color:#888; margin-top:3px;">
            📍 ${order.address || 'Адрес не указан'}
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:14px; color:#666; margin-bottom:5px;">Прибыль:</div>
          <div style="font-size:22px; font-weight:700; color:${profitColor};">
            ${order.profit > 0 ? '+' : ''}${order.profit.toFixed(2)} сом
          </div>
        </div>
      </div>
      
      <div style="background:#f8f9fa; border-radius:8px; padding:12px; overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead>
            <tr style="background:#e9ecef;">
              <th style="padding:8px; text-align:left;">#</th>
              <th style="padding:8px; text-align:left;">Товар</th>
              <th style="padding:8px; text-align:center;">Кол-во</th>
              <th style="padding:8px; text-align:right;">Цена</th>
              <th style="padding:8px; text-align:right;">Себестоимость</th>
              <th style="padding:8px; text-align:right;">Сумма продажи</th>
              <th style="padding:8px; text-align:right;">Сумма себестоимости</th>
              <th style="padding:8px; text-align:right;">Прибыль</th>
            </tr>
          </thead>
          <tbody>
            ${itemsHTML}
          </tbody>
        </table>
      </div>
      
      <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:12px; border-top:2px solid #e0e0e0;">
        <div style="font-size:16px; font-weight:600; color:#333;">
          💰 Итого: ${order.totalSale.toFixed(2)} сом
        </div>
        <div style="font-size:16px; font-weight:600;">
          Себестоимость: ${order.totalCost.toFixed(2)} сом
        </div>
        <div style="font-size:18px; font-weight:700; color:${profitColor};">
          📊 Прибыль: ${order.profit > 0 ? '+' : ''}${order.profit.toFixed(2)} сом
        </div>
      </div>
    `;
    
    listDiv.appendChild(orderCard);
  });
}

// Закрыть модальное окно детальной информации
function closeClientOrdersDetailModal() {
  document.getElementById('clientOrdersDetailModal').style.display = 'none';
  document.body.classList.remove('modal-open');
}

// Удалить конкретный заказ клиента
async function deleteSpecificOrder(orderId, clientName) {
  const result = await Swal.fire({
    title: 'Удалить заказ?',
    html: `Вы действительно хотите удалить этот заказ клиента <strong>${clientName}</strong>?<br><br><small style="color:#dc3545;">⚠️ Это действие нельзя отменить!</small>`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: '🗑️ Да, удалить',
    cancelButtonText: 'Отмена'
  });

  if (result.isConfirmed) {
    try {
      // Удаляем заказ из Firebase
      await db.collection('orders').doc(orderId).delete();
      
      Swal.fire({
        icon: 'success',
        title: 'Заказ удален!',
        text: 'Заказ успешно удален из базы данных',
        timer: 2000,
        showConfirmButton: false
      });
      
      // Перезагружаем отчет
      await loadOrderProfitReport();
      
    } catch (error) {
      console.error('Ошибка удаления заказа:', error);
      Swal.fire({
        icon: 'error',
        title: 'Ошибка',
        text: 'Не удалось удалить заказ: ' + error.message
      });
    }
  }
}

// Обновить количество товара в заказе
async function updateOrderItemQty(orderId, itemIndex, newQty) {
  newQty = parseInt(newQty);
  
  if (isNaN(newQty) || newQty < 0) {
    Swal.fire({
      icon: 'error',
      title: 'Ошибка',
      text: 'Введите корректное количество (0 или больше)'
    });
    await loadOrderProfitReport(); // Перезагрузим для сброса значения
    return;
  }

  try {
    // Получаем текущий заказ
    const orderDoc = await db.collection('orders').doc(orderId).get();
    
    if (!orderDoc.exists) {
      throw new Error('Заказ не найден');
    }
    
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    if (itemIndex >= items.length) {
      throw new Error('Товар не найден в заказе');
    }
    
    // Если количество = 0, удаляем товар из заказа
    if (newQty === 0) {
      const result = await Swal.fire({
        title: 'Удалить товар?',
        html: `Количество = 0. Удалить товар <strong>"${items[itemIndex].title || 'Товар'}"</strong> из заказа?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Да, удалить',
        cancelButtonText: 'Отмена'
      });
      
      if (result.isConfirmed) {
        items.splice(itemIndex, 1);
        
        // Если товаров не осталось, удаляем весь заказ
        if (items.length === 0) {
          await db.collection('orders').doc(orderId).delete();
          Swal.fire({
            icon: 'info',
            title: 'Заказ удален',
            text: 'Все товары были удалены, заказ полностью удален',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          await db.collection('orders').doc(orderId).update({ items });
          Swal.fire({
            icon: 'success',
            title: 'Товар удален',
            text: 'Товар успешно удален из заказа',
            timer: 1500,
            showConfirmButton: false
          });
        }
        
        await loadOrderProfitReport();
      } else {
        await loadOrderProfitReport(); // Сбросим значение
      }
      return;
    }
    
    // Обновляем количество товара
    items[itemIndex].qty = newQty;
    
    await db.collection('orders').doc(orderId).update({ items });
    
    Swal.fire({
      icon: 'success',
      title: 'Количество обновлено!',
      html: `Новое количество: <strong>${newQty} шт</strong>`,
      timer: 1500,
      showConfirmButton: false
    });
    
    // Перезагружаем отчет для обновления сумм
    await loadOrderProfitReport();
    
  } catch (error) {
    console.error('Ошибка обновления количества:', error);
    Swal.fire({
      icon: 'error',
      title: 'Ошибка',
      text: 'Не удалось обновить количество: ' + error.message
    });
    await loadOrderProfitReport(); // Перезагрузим для сброса значения
  }
}

// Экспорт заказов в Excel
async function exportOrderProfitToExcel() {
  const dateFilter = document.getElementById('orderDateFilter').value;
  
  try {
    const ordersSnapshot = await db.collection('orders').get();
    const orders = [];
    
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      orders.push({
        id: doc.id,
        ...data,
        timestamp: data.timestamp || Date.now()
      });
    });
    
    // Применяем фильтры
    const now = Date.now();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayStart = today.getTime();
    const yesterdayStart = todayStart - 86400000;
    const weekStart = todayStart - 7 * 86400000;
    const monthStart = todayStart - 30 * 86400000;
    
    let filtered = orders.filter(order => {
      const orderTime = order.timestamp;
      switch(dateFilter) {
        case 'today': return orderTime >= todayStart;
        case 'yesterday': return orderTime >= yesterdayStart && orderTime < todayStart;
        case 'week': return orderTime >= weekStart;
        case 'month': return orderTime >= monthStart;
        case 'all': return true;
        default: return true;
      }
    });
    
    const wb = XLSX.utils.book_new();
    const wsData = [
      ['№', 'Дата', 'Клиент', 'Телефон', 'Товаров', 'Закупка', 'Сумма', 'Прибыль']
    ];
    
    filtered.forEach((order, index) => {
      let totalCost = 0;
      let totalSale = 0;
      const items = order.items || [];
      
      items.forEach(item => {
        const product = products.find(p => p.id === item.id);
        if (product && product.costPrice) {
          totalCost += product.costPrice * item.qty;
          totalSale += item.price * item.qty;
        } else {
          totalSale += item.price * item.qty;
        }
      });
      
      const profit = totalSale - totalCost;
      const date = new Date(order.timestamp);
      const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
      const itemsCount = items.reduce((sum, item) => sum + item.qty, 0);
      
      wsData.push([
        index + 1,
        dateStr,
        order.name || 'Неизвестный',
        order.phone || '-',
        itemsCount,
        totalCost.toFixed(2),
        totalSale.toFixed(2),
        profit.toFixed(2)
      ]);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, 'Прибыль по заказам');
    XLSX.writeFile(wb, `Прибыль_по_заказам_${new Date().toLocaleDateString()}.xlsx`);
    
    Swal.fire('Готово!', 'Отчет экспортирован в Excel', 'success');
  } catch (error) {
    console.error('Ошибка экспорта:', error);
    Swal.fire('Ошибка', 'Не удалось экспортировать отчет', 'error');
  }
}

// Удаление выбранных заказов
async function deleteSelectedOrders() {
  // Подтверждение удаления
  const result = await Swal.fire({
    title: '⚠️ Внимание!',
    html: 'Вы действительно хотите удалить заказы за выбранный период?<br><br><strong style="color:#dc3545;">Это действие нельзя отменить!</strong>',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Да, удалить',
    cancelButtonText: 'Отмена',
    confirmButtonColor: '#dc3545'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const dateFilter = document.getElementById('orderDateFilter').value;
    const ordersSnapshot = await db.collection('orders').get();
    
    // Фильтруем заказы по дате
    const now = Date.now();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayStart = today.getTime();
    const yesterdayStart = todayStart - 86400000;
    const weekStart = todayStart - 7 * 86400000;
    const monthStart = todayStart - 30 * 86400000;
    
    let deleteCount = 0;
    const batch = db.batch();
    
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      const orderTime = data.timestamp || Date.now();
      let shouldDelete = false;
      
      switch(dateFilter) {
        case 'today': shouldDelete = orderTime >= todayStart; break;
        case 'yesterday': shouldDelete = orderTime >= yesterdayStart && orderTime < todayStart; break;
        case 'week': shouldDelete = orderTime >= weekStart; break;
        case 'month': shouldDelete = orderTime >= monthStart; break;
        case 'all': shouldDelete = true; break;
      }
      
      if (shouldDelete) {
        batch.delete(doc.ref);
        deleteCount++;
      }
    });
    
    await batch.commit();
    
    Swal.fire('Успех!', `Удалено заказов: ${deleteCount}`, 'success');
    
    // Обновляем отчет
    loadOrderProfitReport();
    
  } catch (error) {
    console.error('Ошибка удаления заказов:', error);
    Swal.fire('Ошибка', 'Не удалось удалить заказы: ' + error.message, 'error');
  }
}

// ==================== КОНЕЦ ОТЧЕТА ПО ПРИБЫЛИ ====================

// ==================== АДМИН-ФУНКЦИИ ДЛЯ ЧАТА ====================

// Загрузка сообщений в админ-панель
// Переменная для хранения выбранного клиента админом
let selectedClientId = null;
let selectedClientName = null;

// Загрузка списка всех клиентов для админа
async function loadAdminChat() {
  if (typeof db === 'undefined') {
    document.getElementById('adminChatMessages').innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Firebase не подключен</div>';
    return;
  }
  
  try {
    // Загружаем список клиентов
    const clientsSnapshot = await db.collection('chatClients')
      .get();
    
    const messagesDiv = document.getElementById('adminChatMessages');
    messagesDiv.innerHTML = `
      <div style="display:flex; height:100%; background:#f8f9fa;">
        <div id="clientsList" style="width:250px; border-right:2px solid #e0e0e0; overflow-y:auto; padding:12px; background:white;">
          <div style="font-weight:bold; margin-bottom:12px; color:#333; font-size:16px; padding:8px; background:#f8f9fa; border-radius:8px;">
            📋 Клиенты (${clientsSnapshot.size})
          </div>
        </div>
        <div style="flex:1; display:flex; flex-direction:column;">
          <div id="chatHeader" style="padding:16px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; font-weight:bold; display:none;">
            <div style="font-size:18px;">Выберите клиента</div>
          </div>
          <div id="chatMessagesArea" style="flex:1; display:flex; flex-direction:column; padding:16px; overflow-y:auto; background:#f5f5f5;">
            <div style="text-align:center; color:#999; padding:40px; font-size:16px;">
              👈 Выберите клиента из списка слева
            </div>
          </div>
        </div>
      </div>
    `;
    
    const clientsList = document.getElementById('clientsList');
    
    if (clientsSnapshot.empty) {
      clientsList.innerHTML += '<div style="color:#999; font-size:13px; text-align:center; margin-top:40px; padding:20px;">Нет активных чатов</div>';
      return;
    }
    
    // Собираем клиентов в массив и сортируем по lastActive
    const clients = [];
    clientsSnapshot.forEach((doc) => {
      clients.push({
        id: doc.id,
        data: doc.data()
      });
    });
    
    // Сортируем по lastActive (новые первыми)
    clients.sort((a, b) => {
      const timeA = a.data.lastActive ? a.data.lastActive.toDate().getTime() : 0;
      const timeB = b.data.lastActive ? b.data.lastActive.toDate().getTime() : 0;
      return timeB - timeA;
    });
    
    // Добавляем каждого клиента в список
    clients.forEach(({id, data: client}) => {
      const clientDiv = document.createElement('div');
      clientDiv.style.cssText = `
        padding:12px; margin-bottom:10px; background:${client.hasUnread ? '#fff9c4' : '#f8f9fa'}; 
        border-radius:10px; cursor:pointer; transition:all 0.2s; border:2px solid transparent;
      `;
      clientDiv.innerHTML = `
        <div style="font-weight:bold; color:#333; margin-bottom:4px; font-size:15px;">${client.name}</div>
        <div style="font-size:11px; color:#666;">
          ${client.lastActive ? new Date(client.lastActive.toDate()).toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
          }) : 'Давно'}
        </div>
        ${client.hasUnread ? '<div style="font-size:10px; color:#f57c00; font-weight:bold; margin-top:6px;">🔔 НОВОЕ СООБЩЕНИЕ</div>' : ''}
      `;
      
      clientDiv.onmouseover = () => clientDiv.style.borderColor = '#667eea';
      clientDiv.onmouseout = () => {
        if (selectedClientId !== id) clientDiv.style.borderColor = 'transparent';
      };
      
      clientDiv.onclick = () => loadClientMessages(id, client.name, clientDiv);
      clientsList.appendChild(clientDiv);
    });
    
  } catch (error) {
    console.error('Ошибка загрузки клиентов:', error);
    document.getElementById('adminChatMessages').innerHTML = '<div style="text-align:center; color:#dc3545; padding:20px;">Ошибка загрузки клиентов</div>';
  }
}

// Загрузка сообщений конкретного клиента
async function loadClientMessages(clientId, clientName, clientDiv) {
  selectedClientId = clientId;
  selectedClientName = clientName;
  
  console.log('Загрузка сообщений клиента:', clientName, clientId);
  
  // Подсвечиваем выбранного клиента
  document.querySelectorAll('#clientsList > div').forEach(div => {
    if (div.style && div !== clientDiv) {
      div.style.borderColor = 'transparent';
      div.style.background = '#f8f9fa';
    }
  });
  if (clientDiv) {
    clientDiv.style.borderColor = '#667eea';
    clientDiv.style.background = '#e3f2fd';
  }
  
  // Убираем метку "новое сообщение"
  try {
    await db.collection('chatClients').doc(clientId).update({ hasUnread: false });
  } catch (error) {
    console.error('Ошибка обновления статуса:', error);
  }
  
  // Обновляем заголовок
  const chatHeader = document.getElementById('chatHeader');
  chatHeader.style.display = 'block';
  chatHeader.innerHTML = `
    <div style="font-size:18px;">💬 Чат с ${clientName}</div>
    <div style="font-size:12px; opacity:0.9; margin-top:4px;">ID: ${clientId}</div>
  `;
  
  try {
    // Загружаем сообщения этого клиента
    const querySnapshot = await db.collection('chatMessages')
      .where('clientId', '==', clientId)
      .get();
    
    const chatArea = document.getElementById('chatMessagesArea');
    chatArea.innerHTML = '';
    
    if (querySnapshot.empty) {
      chatArea.innerHTML = `<div style="text-align:center; color:#999; padding:40px; font-size:15px;">Нет сообщений с ${clientName}</div>`;
      return;
    }
    
    // Сортируем сообщения по времени вручную
    const messages = [];
    querySnapshot.forEach((doc) => {
      const msg = doc.data();
      messages.push({
        text: msg.text,
        sender: msg.sender,
        timestamp: msg.timestamp.toDate()
      });
    });
    
    // Сортируем по timestamp
    messages.sort((a, b) => a.timestamp - b.timestamp);
    
    // Добавляем в UI
    messages.forEach(msg => {
      addAdminChatMessageToUI(msg.text, msg.sender, msg.timestamp);
    });
    
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // Обновляем placeholder поля ввода
    const inputField = document.getElementById('adminChatInput');
    if (inputField) {
      inputField.placeholder = `Ответить ${clientName}...`;
    }
    
    // Подписываемся на новые сообщения от этого клиента
    subscribeToAdminChatMessages(clientId);
    
  } catch (error) {
    console.error('Ошибка загрузки сообщений клиента:', error);
    document.getElementById('chatMessagesArea').innerHTML = '<div style="text-align:center; color:#dc3545; padding:20px;">Ошибка загрузки сообщений</div>';
  }
}

// Добавление сообщения в админ-панель
function addAdminChatMessageToUI(text, sender, timestamp) {
  const chatArea = document.getElementById('chatMessagesArea');
  if (!chatArea) return;
  
  const timeStr = timestamp.getHours().toString().padStart(2, '0') + ':' + timestamp.getMinutes().toString().padStart(2, '0');
  const dateStr = timestamp.toLocaleDateString('ru-RU');
  
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = 'margin-bottom:12px; display:flex;';
  
  const msgContent = document.createElement('div');
  
  if (sender === 'client') {
    msgContent.style.cssText = 'background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:70%; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    msgContent.innerHTML = `
      <div style="font-size:12px; color:#667eea; font-weight:bold; margin-bottom:4px;">👤 ${selectedClientName || 'Клиент'}</div>
      <div style="font-size:14px; color:#333;">${escapeHtml(text)}</div>
      <div style="font-size:11px; color:#999; margin-top:4px;">${dateStr} ${timeStr}</div>
    `;
  } else {
    messageDiv.style.justifyContent = 'flex-end';
    msgContent.style.cssText = 'background:#667eea; color:white; padding:12px; border-radius:12px 12px 4px 12px; max-width:70%; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    msgContent.innerHTML = `
      <div style="font-size:12px; font-weight:bold; margin-bottom:4px; opacity:0.9;">✅ Вы</div>
      <div style="font-size:14px;">${escapeHtml(text)}</div>
      <div style="font-size:11px; opacity:0.9; margin-top:4px; text-align:right;">${dateStr} ${timeStr}</div>
    `;
  }
  
  messageDiv.appendChild(msgContent);
  chatArea.appendChild(messageDiv);
}

// Отправка сообщения от админа
async function sendAdminMessage() {
  if (!selectedClientId) {
    Swal.fire('Ошибка', 'Сначала выберите клиента из списка слева', 'warning');
    return;
  }
  
  const input = document.getElementById('adminChatInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  const now = new Date();
  
  try {
    // Добавляем сообщение в UI
    addAdminChatMessageToUI(message, 'admin', now);
    
    // Сохраняем в Firebase с clientId выбранного клиента
    await db.collection('chatMessages').add({
      text: message,
      sender: 'admin',
      clientId: selectedClientId,
      clientName: selectedClientName,
      timestamp: firebase.firestore.Timestamp.fromDate(now),
      read: false
    });
    
    console.log('Сообщение отправлено клиенту:', selectedClientName);
    
    // Очищаем поле ввода
    input.value = '';
    
    // Прокручиваем к последнему сообщению
    const chatArea = document.getElementById('chatMessagesArea');
    chatArea.scrollTop = chatArea.scrollHeight;
    
  } catch (error) {
    console.error('Ошибка отправки сообщения:', error);
    Swal.fire('Ошибка', 'Не удалось отправить сообщение', 'error');
  }
}

// Подписка на новые сообщения конкретного клиента в админ-панели
function subscribeToAdminChatMessages(clientId) {
  if (typeof db === 'undefined') return;
  
  db.collection('chatMessages')
    .where('clientId', '==', clientId)
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const msg = change.doc.data();
          // Если сообщение от клиента и это выбранный клиент
          if (msg.sender === 'client' && msg.clientId === selectedClientId) {
            // Проверяем, не дублируется ли сообщение
            const chatArea = document.getElementById('chatMessagesArea');
            const existingMessages = chatArea.querySelectorAll('div');
            let isDuplicate = false;
            existingMessages.forEach(div => {
              if (div.textContent && div.textContent.includes(msg.text)) {
                isDuplicate = true;
              }
            });
            
            if (!isDuplicate) {
              addAdminChatMessageToUI(msg.text, msg.sender, msg.timestamp.toDate());
              chatArea.scrollTop = chatArea.scrollHeight;
              
              // Обновляем список клиентов (добавляем уведомление)
              loadAdminChat();
            }
          }
        }
      });
    });
}

// Очистка всех сообщений чата
async function clearAllChatMessages() {
  const result = await Swal.fire({
    title: 'Вы уверены?',
    text: 'Все сообщения чата будут удалены безвозвратно!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Да, удалить',
    cancelButtonText: 'Отмена',
    confirmButtonColor: '#dc3545'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const querySnapshot = await db.collection('chatMessages').get();
    
    const deletePromises = [];
    querySnapshot.forEach((doc) => {
      deletePromises.push(doc.ref.delete());
    });
    
    await Promise.all(deletePromises);
    
    document.getElementById('adminChatMessages').innerHTML = '<div style="text-align:center; color:#999; padding:20px;">Нет сообщений</div>';
    document.getElementById('chatMessages').innerHTML = `
      <div style="background:white; padding:12px; border-radius:12px 12px 12px 4px; max-width:80%; align-self:flex-start; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <div style="font-size:14px; color:#333;">Здравствуйте! Чем могу помочь?</div>
        <div style="font-size:11px; color:#999; margin-top:4px;">Продавец • только что</div>
      </div>
    `;
    
    Swal.fire('Успех!', 'Все сообщения удалены', 'success');
  } catch (error) {
    console.error('Ошибка очистки сообщений:', error);
    Swal.fire('Ошибка', 'Не удалось очистить сообщения', 'error');
  }
}

// Обновление админ-чата
function refreshAdminChat() {
  loadAdminChat();
  Swal.fire({
    icon: 'success',
    title: 'Обновлено',
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 1500
  });
}

// ==================== КОНЕЦ АДМИН-ФУНКЦИЙ ЧАТА ====================

// ==================== КОНЕЦ ФУНКЦИЙ ЧАТА ====================

// ==================== ФУНКЦИИ РАСХОДОВ ====================

// Открыть окно добавления расхода
function openAddExpenseModal() {
  document.getElementById('addExpenseModal').style.display = 'flex';
  document.body.classList.add('modal-open');
  
  // Установить текущую дату
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('expenseDate').value = today;
  
  // Очистить поля
  document.getElementById('expenseDescription').value = '';
  document.getElementById('expenseAmount').value = '';
}

// Закрыть окно добавления расхода
function closeAddExpenseModal() {
  document.getElementById('addExpenseModal').style.display = 'none';
  document.body.classList.remove('modal-open');
}

// Сохранить расход
async function saveExpense() {
  const description = document.getElementById('expenseDescription').value.trim();
  const amount = parseFloat(document.getElementById('expenseAmount').value);
  const date = document.getElementById('expenseDate').value;
  
  if (!description) {
    Swal.fire('Ошибка', 'Введите описание расхода', 'error');
    return;
  }
  
  if (!amount || amount <= 0) {
    Swal.fire('Ошибка', 'Введите корректную сумму', 'error');
    return;
  }
  
  if (!date) {
    Swal.fire('Ошибка', 'Выберите дату', 'error');
    return;
  }
  
  try {
    // Сохраняем в Firebase
    await db.collection('expenses').add({
      description,
      amount,
      date,
      timestamp: new Date(date).getTime(),
      createdAt: Date.now()
    });
    
    closeAddExpenseModal();
    Swal.fire('Успех', 'Расход добавлен!', 'success');
    loadExpensesReport();
  } catch (error) {
    console.error('Ошибка сохранения расхода:', error);
    Swal.fire('Ошибка', 'Не удалось сохранить расход', 'error');
  }
}

// Загрузить отчет по расходам
async function loadExpensesReport() {
  try {
    console.log('📊 loadExpensesReport вызвана');
    const period = document.getElementById('expenseDateFilter').value;
    console.log('🔍 Период:', period);
    
    // Получаем расходы
    const expensesSnapshot = await db.collection('expenses').orderBy('timestamp', 'desc').get();
    let expenses = [];
    expensesSnapshot.forEach(doc => {
      expenses.push({ id: doc.id, ...doc.data() });
    });
    console.log('💸 Всего расходов:', expenses.length);
    
    // Получаем заказы для расчета прибыли
    const ordersSnapshot = await db.collection('orders').get();
    let orders = [];
    ordersSnapshot.forEach(doc => {
      orders.push({ id: doc.id, ...doc.data() });
    });
    console.log('📦 Всего заказов:', orders.length);
    
    // Загружаем все товары с себестоимостью из Firebase (КАК В ФУНКЦИИ ПО ЗАКАЗАМ)
    let productsMap = new Map();
    try {
      const productsSnapshot = await db.collection('products').get();
      console.log('🛍️ Загружено товаров из Firebase:', productsSnapshot.size);
      
      productsSnapshot.forEach(doc => {
        const data = doc.data();
        productsMap.set(doc.id, {
          name: data.name || 'Неизвестный товар',
          costPrice: data.costPrice || 0,
          salePrice: data.price || 0
        });
      });
      
      console.log('💰 Товаров в карте:', productsMap.size);
    } catch (error) {
      console.error('❌ Ошибка загрузки товаров:', error);
    }
    
    // Фильтруем по периоду
    const now = Date.now();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayStart = today.getTime();
    const yesterdayStart = todayStart - 86400000;
    const weekStart = todayStart - 7 * 86400000;
    const monthStart = todayStart - 30 * 86400000;
    
    expenses = expenses.filter(exp => {
      const expTime = exp.timestamp;
      switch(period) {
        case 'today': return expTime >= todayStart;
        case 'yesterday': return expTime >= yesterdayStart && expTime < todayStart;
        case 'week': return expTime >= weekStart;
        case 'month': return expTime >= monthStart;
        case 'all': return true;
        default: return true;
      }
    });
    
    orders = orders.filter(order => {
      const orderTime = order.timestamp;
      switch(period) {
        case 'today': return orderTime >= todayStart;
        case 'yesterday': return orderTime >= yesterdayStart && orderTime < todayStart;
        case 'week': return orderTime >= weekStart;
        case 'month': return orderTime >= monthStart;
        case 'all': return true;
        default: return true;
      }
    });
    
    console.log('📊 Заказов после фильтра:', orders.length);
    
    // Рассчитываем прибыль от заказов (КАК В ФУНКЦИИ ПО ЗАКАЗАМ)
    let totalOrderProfit = 0;
    orders.forEach(order => {
      const items = order.items || [];
      
      items.forEach(item => {
        const productData = productsMap.get(item.id);
        // Используем себестоимость из заказа, если она есть, иначе из базы товаров
        const costPrice = item.costPrice || (productData ? productData.costPrice : 0);
        const itemCost = costPrice * item.qty;
        const itemSale = item.price * item.qty;
        // Если себестоимость = 0 или не указана, прибыль = 0
        const itemProfit = costPrice > 0 ? (itemSale - itemCost) : 0;
        
        totalOrderProfit += itemProfit;
      });
    });
    
    console.log('💰 Прибыль от заказов:', totalOrderProfit.toFixed(2));
    
    // Рассчитываем общие расходы
    const totalExpensesAmount = expenses.reduce((sum, exp) => sum + exp.amount, 0);
    
    console.log('💸 Сумма расходов:', totalExpensesAmount.toFixed(2));
    
    // Чистая прибыль = прибыль от заказов - расходы
    const netProfitAmount = totalOrderProfit - totalExpensesAmount;
    
    console.log('📊 Чистая прибыль:', netProfitAmount.toFixed(2));
    
    // Обновляем сводку
    document.getElementById('totalExpenses').textContent = totalExpensesAmount.toFixed(2) + ' сом';
    document.getElementById('expensesPeriodProfit').textContent = totalOrderProfit.toFixed(2) + ' сом';
    document.getElementById('netProfit').textContent = netProfitAmount.toFixed(2) + ' сом';
    document.getElementById('netProfit').style.color = netProfitAmount >= 0 ? '#28a745' : '#dc3545';
    
    console.log('✅ Сводка обновлена');
    
    // Отображаем расходы в таблице
    const tbody = document.getElementById('expensesReportBody');
    tbody.innerHTML = '';
    
    if (expenses.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="padding:40px; text-align:center; color:#999;">Расходов за выбранный период нет</td></tr>';
      return;
    }
    
    expenses.forEach((expense, index) => {
      const row = document.createElement('tr');
      row.style.borderBottom = '1px solid #e0e0e0';
      row.style.transition = 'background 0.2s';
      row.onmouseenter = () => row.style.background = '#f8f9fa';
      row.onmouseleave = () => row.style.background = 'white';
      
      const date = new Date(expense.timestamp);
      const dateStr = date.toLocaleDateString('ru-RU');
      
      row.innerHTML = `
        <td style="padding:12px; font-weight:600; color:#666;">${index + 1}</td>
        <td style="padding:12px; color:#666;">${dateStr}</td>
        <td style="padding:12px; color:#333;">${expense.description}</td>
        <td style="padding:12px; text-align:right; font-weight:600; color:#dc3545;">${expense.amount.toFixed(2)} сом</td>
        <td style="padding:12px; text-align:center;">
          <button onclick="deleteExpense('${expense.id}')" style="padding:6px 12px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer; font-size:12px;">🗑️ Удалить</button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
    
  } catch (error) {
    console.error('Ошибка загрузки расходов:', error);
    Swal.fire('Ошибка', 'Не удалось загрузить расходы', 'error');
  }
}

// Удалить расход
async function deleteExpense(expenseId) {
  const result = await Swal.fire({
    title: 'Удалить расход?',
    text: 'Это действие нельзя отменить',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Да, удалить',
    cancelButtonText: 'Отмена',
    confirmButtonColor: '#dc3545'
  });
  
  if (result.isConfirmed) {
    try {
      await db.collection('expenses').doc(expenseId).delete();
      Swal.fire('Удалено', 'Расход удален', 'success');
      loadExpensesReport();
    } catch (error) {
      console.error('Ошибка удаления расхода:', error);
      Swal.fire('Ошибка', 'Не удалось удалить расход', 'error');
    }
  }
}

// ==================== КОНЕЦ ФУНКЦИЙ РАСХОДОВ ====================

// Скрипт для работы кнопок прокрутки вверх/вниз
document.getElementById('scrollTopBtn').onclick = function() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
};
document.getElementById('scrollBottomBtn').onclick = function() {
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
};
</script>

</body>
</html>