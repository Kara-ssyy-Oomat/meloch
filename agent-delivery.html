<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4CAF50">
  <title>–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏ - –ö–µ—Ä–±–µ–Ω</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding-bottom: 70px;
    }
    
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .header h1 {
      flex: 1;
      font-size: 18px;
      font-weight: 600;
    }
    
    .back-btn {
      font-size: 24px;
      text-decoration: none;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .print-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .filters {
      background: white;
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .date-picker {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .date-picker label {
      font-weight: 600;
      color: #333;
    }
    
    .date-picker input {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
    }
    
    .load-btn {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .agent-select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      min-width: 160px;
      background: white;
    }
    
    .stats-bar {
      background: #e8f5e9;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #c8e6c9;
    }
    
    .stats-bar span {
      font-size: 14px;
      color: #2e7d32;
      font-weight: 600;
    }
    
    .client-list {
      padding: 15px;
    }
    
    .client-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border-left: 4px solid #4CAF50;
    }
    
    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    
    .client-number {
      background: #4CAF50;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }
    
    .client-total {
      font-size: 18px;
      font-weight: 700;
      color: #4CAF50;
    }
    
    .client-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .client-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .client-info-icon {
      width: 20px;
      text-align: center;
    }
    
    .order-items {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #e0e0e0;
      font-size: 13px;
      color: #888;
    }
    
    .order-item {
      padding: 3px 0;
    }
    
    .checkbox-collected {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
    }
    
    .checkbox-collected input {
      width: 22px;
      height: 22px;
      cursor: pointer;
    }
    
    .checkbox-collected label {
      font-size: 14px;
      color: #666;
      cursor: pointer;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 15px;
    }
    
    .total-summary {
      position: fixed;
      bottom: 56px;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 90;
    }
    
    .total-summary-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .total-summary-value {
      font-size: 22px;
      font-weight: 700;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ */
    @media print {
      body {
        background: white;
        padding: 0;
        font-size: 12px;
      }
      
      .header, .filters, .total-summary, .bottom-nav, .print-btn, .checkbox-collected {
        display: none !important;
      }
      
      .client-list {
        padding: 0;
      }
      
      .client-card {
        box-shadow: none;
        border: 1px solid #333;
        border-left: 3px solid #333;
        margin-bottom: 8px;
        padding: 10px;
        page-break-inside: avoid;
      }
      
      .stats-bar {
        background: none;
        border: 1px solid #333;
        margin-bottom: 10px;
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }
      
      .client-number {
        background: #333 !important;
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
      }
      
      .client-total {
        color: #333;
      }
      
      .print-header {
        display: block !important;
        text-align: center;
        padding: 15px 0;
        border-bottom: 2px solid #333;
        margin-bottom: 15px;
      }
      
      .print-header h1 {
        font-size: 18px;
        margin-bottom: 5px;
      }
      
      .print-header p {
        font-size: 12px;
        color: #666;
      }
    }
    
    .print-header {
      display: none;
    }
    
    /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      border-top: 1px solid #e0e0e0;
      z-index: 100;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: #888;
      font-size: 10px;
      padding: 5px 15px;
    }
    
    .nav-item.active { color: #4CAF50; }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; margin-bottom: 2px; }
  </style>
</head>

<body>
  <div class="print-header">
    <h1>üìã –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏</h1>
    <p id="printDate"></p>
  </div>
  
  <header class="header">
    <a href="profile.html" class="back-btn">‚Üê</a>
    <h1>üìã –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏</h1>
    <button class="print-btn" onclick="sendPdfToTelegram()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å PDF</button>
  </header>
  
  <div class="filters">
    <div class="date-picker">
      <label>üìÖ –î–∞—Ç–∞:</label>
      <input type="date" id="dateFilter" />
      <select class="agent-select" id="agentFilter">
        <option value="all">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
        <option value="own">–ù–∞—à–∏ –∫–ª–∏–µ–Ω—Ç—ã</option>
      </select>
      <button class="load-btn" onclick="loadDeliveryList()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
  </div>
  
  <div class="stats-bar" id="statsBar" style="display:none;">
    <span id="clientsCount">0 –∫–ª–∏–µ–Ω—Ç–æ–≤</span>
    <span id="ordersCount">0 –∑–∞–∫–∞–∑–æ–≤</span>
    <span id="totalSum">0 —Å–æ–º</span>
  </div>
  
  <div class="client-list" id="clientList">
    <div class="empty-state">
      <div class="empty-state-icon">üì¶</div>
      <div>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å"</div>
    </div>
  </div>
  
  <div class="total-summary" id="totalSummary" style="display:none;">
    <div>
      <div class="total-summary-label">–í—Å–µ–≥–æ –∫ —Å–±–æ—Ä—É:</div>
    </div>
    <div class="total-summary-value" id="grandTotal">0 —Å–æ–º</div>
  </div>
  
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="index.html#categories" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M3 5h6v6H3V5zm0 8h6v6H3v-6zm8-8h6v6h-6V5zm0 8h6v6h-6v-6z"/></svg>
      <span>–ú–µ–Ω—é</span>
    </a>
    <a href="cart.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM7.2 14.6L8.2 12h7.4c.8 0 1.4-.4 1.7-1l3.9-7-1.7-1-3.9 7H8.5L4.3 2H1v2h2l3.6 7.6-1.4 2.5c-.7 1.3.3 2.9 1.8 2.9h12v-2H7.4z"/></svg>
      <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
    </a>
    <a href="chat.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
      <span>–ß–∞—Ç</span>
    </a>
    <a href="profile.html" class="nav-item active">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm0 2c-2.7 0-8 1.3-8 4v2h16v-2c0-2.7-5.3-4-8-4z"/></svg>
      <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </a>
  </nav>
  
  <script>
    // Firebase –∫–æ–Ω—Ñ–∏–≥
    const firebaseConfig = {
      apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
      authDomain: "svoysayet.firebaseapp.com",
      projectId: "svoysayet",
      storageBucket: "svoysayet.firebasestorage.app",
      messagingSenderId: "785840370498",
      appId: "1:785840370498:web:e08c7cbef96aborc5e81f1"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
    let allAgentsList = [];
    let clientAgentsMap = {}; // —Ç–µ–ª–µ—Ñ–æ–Ω -> agentId
    
    // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    let currentUserIsAdmin = false;
    let currentAgentId = null; // ID –∞–≥–µ–Ω—Ç–∞, –µ—Å–ª–∏ —ç—Ç–æ –∞–≥–µ–Ω—Ç
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    async function loadAgentsForFilter() {
      try {
        const [agentsSnap, clientAgentsSnap] = await Promise.all([
          db.collection('agents').get(),
          db.collection('clientAgents').get()
        ]);
        
        allAgentsList = [];
        agentsSnap.forEach(doc => {
          allAgentsList.push({ id: doc.id, ...doc.data() });
        });
        
        clientAgentsMap = {};
        clientAgentsSnap.forEach(doc => {
          const data = doc.data();
          clientAgentsMap[doc.id] = data.agentId || data.agent;
        });
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º select –∞–≥–µ–Ω—Ç–æ–≤
        const select = document.getElementById('agentFilter');
        allAgentsList.forEach(agent => {
          const option = document.createElement('option');
          option.value = agent.id;
          option.textContent = agent.name || agent.phone || agent.id;
          select.appendChild(option);
        });
        
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≥–µ–Ω—Ç–æ–≤:', e);
      }
    }
    
    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    function normalizePhone(phone) {
      if (!phone) return '';
      return phone.replace(/\D/g, '').replace(/^996/, '');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    async function checkAccess() {
      const saved = localStorage.getItem('customerData');
      if (!saved) {
        window.location.href = 'profile.html';
        return false;
      }
      
      try {
        const customer = JSON.parse(saved);
        const customerPhone = normalizePhone(customer.phone);
        
        // –ê–¥–º–∏–Ω –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø
        const ADMIN_PHONE = '707622800';
        if (customerPhone === ADMIN_PHONE || customer.isAdmin) {
          currentUserIsAdmin = true;
          return true;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞–≥–µ–Ω—Ç–æ–º
        const agentsSnap = await db.collection('agents').get();
        let isAgent = false;
        
        agentsSnap.forEach(doc => {
          const agentData = doc.data();
          const agentPhone = normalizePhone(agentData.phone || doc.id);
          if (agentPhone === customerPhone) {
            isAgent = true;
            currentAgentId = doc.id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∞–≥–µ–Ω—Ç–∞
          }
        });
        
        if (!isAgent) {
          Swal.fire({
            icon: 'error',
            title: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω',
            text: '–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞',
            confirmButtonText: '–í–µ—Ä–Ω—É—Ç—å—Å—è'
          }).then(() => {
            window.location.href = 'profile.html';
          });
          return false;
        }
        
        return true;
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞:', e);
        window.location.href = 'profile.html';
        return false;
      }
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.addEventListener('DOMContentLoaded', async function() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø
      const hasAccess = await checkAccess();
      if (!hasAccess) return;
      
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      document.getElementById('dateFilter').value = dateStr;
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≥–µ–Ω—Ç–æ–≤
      await loadAgentsForFilter();
      
      // –ï—Å–ª–∏ —ç—Ç–æ –∞–≥–µ–Ω—Ç (–Ω–µ –∞–¥–º–∏–Ω) - —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –∞–≥–µ–Ω—Ç–∞–º
      if (!currentUserIsAdmin && currentAgentId) {
        const agentSelect = document.getElementById('agentFilter');
        if (agentSelect) {
          agentSelect.style.display = 'none';
        }
      }
      
      // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
      loadDeliveryList();
    });
    
    async function loadDeliveryList() {
      const dateInput = document.getElementById('dateFilter').value;
      let agentFilter = document.getElementById('agentFilter').value;
      
      // –ï—Å–ª–∏ —ç—Ç–æ –∞–≥–µ–Ω—Ç (–Ω–µ –∞–¥–º–∏–Ω) - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤
      if (!currentUserIsAdmin && currentAgentId) {
        agentFilter = currentAgentId;
      }
      
      if (!dateInput) {
        Swal.fire('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É', 'error');
        return;
      }
      
      const selectedDate = new Date(dateInput);
      const startOfDay = new Date(selectedDate);
      startOfDay.setHours(0, 0, 0, 0);
      const endOfDay = new Date(selectedDate);
      endOfDay.setHours(23, 59, 59, 999);
      
      const startTimestamp = startOfDay.getTime();
      const endTimestamp = endOfDay.getTime();
      
      document.getElementById('clientList').innerHTML = `
        <div style="text-align:center; padding:40px;">
          <div style="font-size:32px; margin-bottom:10px;">‚è≥</div>
          <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
      `;
      
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å
        const snapshot = await db.collection('orders')
          .where('timestamp', '>=', startTimestamp)
          .where('timestamp', '<=', endTimestamp)
          .get();
        
        const orders = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          // –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã (–Ω–µ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ)
          if (data.status !== '–û—Ç–º–µ–Ω—ë–Ω') {
            const phone = data.phone || '';
            const normalizedPhone = normalizePhone(phone);
            const clientAgentId = clientAgentsMap[phone] || clientAgentsMap[normalizedPhone] || clientAgentsMap[phone.replace('+996', '')] || null;
            
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∞–≥–µ–Ω—Ç—É
            if (agentFilter === 'all') {
              // –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
              orders.push({ id: doc.id, ...data });
            } else if (agentFilter === 'own') {
              // –¢–æ–ª—å–∫–æ –Ω–∞—à–∏ –∫–ª–∏–µ–Ω—Ç—ã (–±–µ–∑ –∞–≥–µ–Ω—Ç–∞)
              if (!clientAgentId && !data.partner) {
                orders.push({ id: doc.id, ...data });
              }
            } else {
              // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞–≥–µ–Ω—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ clientAgents, –∏ –ø–æ–ª–µ partner
              const selectedAgent = allAgentsList.find(a => a.id === agentFilter);
              const agentName = selectedAgent ? selectedAgent.name : '';
              const matchByClientAgents = clientAgentId === agentFilter;
              const matchByPartner = data.partner && (data.partner === agentFilter || data.partner === agentName);
              
              if (matchByClientAgents || matchByPartner) {
                orders.push({ id: doc.id, ...data });
              }
            }
          }
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        orders.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º (–ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É)
        const clientsMap = {};
        orders.forEach(order => {
          const phone = order.phone || 'unknown';
          if (!clientsMap[phone]) {
            clientsMap[phone] = {
              name: order.clientName || order.name || '–ë–µ–∑ –∏–º–µ–Ω–∏',
              phone: phone,
              address: order.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω',
              orders: [],
              total: 0
            };
          }
          clientsMap[phone].orders.push(order);
          clientsMap[phone].total += order.total || 0;
          // –û–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å –Ω–∞ —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π
          if (order.address) {
            clientsMap[phone].address = order.address;
          }
        });
        
        const clients = Object.values(clientsMap);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const totalClients = clients.length;
        const totalOrders = orders.length;
        const grandTotal = clients.reduce((sum, c) => sum + c.total, 0);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è PDF
        let agentNameForPdf = '';
        if (agentFilter === 'all') {
          agentNameForPdf = '–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã';
        } else if (agentFilter === 'own') {
          agentNameForPdf = '–ù–∞—à–∏ –∫–ª–∏–µ–Ω—Ç—ã';
        } else {
          const selectedAgent = allAgentsList.find(a => a.id === agentFilter);
          agentNameForPdf = selectedAgent ? (selectedAgent.name || selectedAgent.phone) : '';
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è PDF
        _deliveryClients = clients;
        _deliveryGrandTotal = grandTotal;
        _deliveryAgentName = agentNameForPdf;
        
        document.getElementById('clientsCount').textContent = `${totalClients} –∫–ª–∏–µ–Ω—Ç(–æ–≤)`;
        document.getElementById('ordersCount').textContent = `${totalOrders} –∑–∞–∫–∞–∑(–æ–≤)`;
        document.getElementById('totalSum').textContent = `${grandTotal.toLocaleString()} —Å–æ–º`;
        document.getElementById('grandTotal').textContent = `${grandTotal.toLocaleString()} —Å–æ–º`;
        document.getElementById('statsBar').style.display = clients.length > 0 ? 'flex' : 'none';
        document.getElementById('totalSummary').style.display = clients.length > 0 ? 'flex' : 'none';
        
        // –î–∞—Ç–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏
        const dateForPrint = selectedDate.toLocaleDateString('ru-RU', { 
          weekday: 'long', 
          day: 'numeric', 
          month: 'long', 
          year: 'numeric' 
        });
        document.getElementById('printDate').textContent = dateForPrint;
        _deliveryDate = dateForPrint;
        
        // –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫
        if (clients.length === 0) {
          document.getElementById('clientList').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <div>–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –∑–∞ ${dateForPrint}</div>
            </div>
          `;
          return;
        }
        
        let html = '';
        clients.forEach((client, index) => {
          const itemsList = client.orders.flatMap(o => o.items || [])
            .map(item => `${item.title} x${item.qty}`)
            .slice(0, 5)
            .join(', ');
          
          const moreItems = client.orders.flatMap(o => o.items || []).length > 5 ? '...' : '';
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–±—Ä–∞–Ω—ã –ª–∏ –¥–µ–Ω—å–≥–∏ (–µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∑–∞–∫–∞–∑ –æ—Ç–º–µ—á–µ–Ω)
          const isCollected = client.orders.some(o => o.moneyCollected === true);
          const cardStyle = isCollected ? 'opacity:0.5; border-left-color:#28a745;' : '';
          
          html += `
            <div class="client-card" id="client-${index}" style="${cardStyle}">
              <div class="client-header">
                <div class="client-number">${index + 1}</div>
                <div class="client-total">${client.total.toLocaleString()} —Å–æ–º</div>
              </div>
              
              <div class="client-name">${client.name}</div>
              
              <div class="client-info">
                <span class="client-info-icon">üìû</span>
                <a href="tel:${client.phone}" style="color:#4CAF50; text-decoration:none;">${client.phone}</a>
              </div>
              
              <div class="client-info">
                <span class="client-info-icon">üìç</span>
                <span>${client.address}</span>
              </div>
              
              <div class="order-items">
                <strong>–¢–æ–≤–∞—Ä—ã:</strong> ${itemsList}${moreItems}
              </div>
              
              <div class="checkbox-collected">
                <input type="checkbox" id="collected-${index}" ${isCollected ? 'checked' : ''} onchange="markCollected(${index}, this.checked)">
                <label for="collected-${index}">‚úÖ –î–µ–Ω—å–≥–∏ —Å–æ–±—Ä–∞–Ω—ã</label>
              </div>
            </div>
          `;
        });
        
        document.getElementById('clientList').innerHTML = html;
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        document.getElementById('clientList').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
          </div>
        `;
      }
    }
    
    async function markCollected(index, collected) {
      const card = document.getElementById(`client-${index}`);
      const client = _deliveryClients[index];
      
      if (!client) return;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ
      if (card) {
        if (collected) {
          card.style.opacity = '0.5';
          card.style.borderLeftColor = '#28a745';
        } else {
          card.style.opacity = '1';
          card.style.borderLeftColor = '#4CAF50';
        }
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞ —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
      try {
        const batch = db.batch();
        
        for (const order of client.orders) {
          const orderRef = db.collection('orders').doc(order.id);
          batch.update(orderRef, {
            moneyCollected: collected,
            moneyCollectedAt: collected ? Date.now() : null,
            moneyCollectedBy: collected ? (currentAgentId || 'admin') : null
          });
        }
        
        await batch.commit();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        client.orders.forEach(o => o.moneyCollected = collected);
        
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
        Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å', 'error');
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–µ–∫–±–æ–∫—Å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const checkbox = document.getElementById(`collected-${index}`);
        if (checkbox) checkbox.checked = !collected;
        if (card) {
          card.style.opacity = collected ? '1' : '0.5';
          card.style.borderLeftColor = collected ? '#4CAF50' : '#28a745';
        }
      }
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
    let _deliveryClients = [];
    let _deliveryDate = '';
    let _deliveryGrandTotal = 0;
    let _deliveryAgentName = ''; // –ù–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
    
    // ==================== –ì–ï–ù–ï–†–ê–¶–ò–Ø PDF –ò –û–¢–ü–†–ê–í–ö–ê –í TELEGRAM ====================
    async function sendPdfToTelegram() {
      if (_deliveryClients.length === 0) {
        Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏. –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–ø–∏—Å–æ–∫.', 'warning');
        return;
      }
      
      Swal.fire({
        title: '–°–æ–∑–¥–∞–Ω–∏–µ PDF...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
      });
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const scale = 1.5;
        let yPosition = 5;
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        const headerCanvas = document.createElement('canvas');
        const headerCtx = headerCanvas.getContext('2d');
        headerCanvas.width = 600 * scale;
        headerCanvas.height = 80 * scale;
        headerCtx.scale(scale, scale);
        
        headerCtx.fillStyle = '#4CAF50';
        headerCtx.fillRect(0, 0, 600, 80);
        headerCtx.fillStyle = 'white';
        headerCtx.font = 'bold 28px Arial';
        headerCtx.textAlign = 'center';
        headerCtx.fillText('–°–ü–ò–°–û–ö –î–û–°–¢–ê–í–ö–ò', 300, 28);
        headerCtx.font = '14px Arial';
        headerCtx.fillText(_deliveryAgentName ? ('[ ' + _deliveryAgentName + ' ]') : '', 300, 48);
        headerCtx.font = '14px Arial';
        headerCtx.fillText(_deliveryDate, 300, 68);
        
        const headerImage = headerCanvas.toDataURL('image/png');
        doc.addImage(headerImage, 'PNG', 10, yPosition, 190, 22);
        yPosition += 25;
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const statsCanvas = document.createElement('canvas');
        const statsCtx = statsCanvas.getContext('2d');
        statsCanvas.width = 600 * scale;
        statsCanvas.height = 40 * scale;
        statsCtx.scale(scale, scale);
        
        statsCtx.fillStyle = '#e8f5e9';
        statsCtx.fillRect(0, 0, 600, 40);
        statsCtx.strokeStyle = '#4CAF50';
        statsCtx.lineWidth = 2;
        statsCtx.strokeRect(0, 0, 600, 40);
        
        statsCtx.fillStyle = '#2e7d32';
        statsCtx.font = 'bold 14px Arial';
        statsCtx.textAlign = 'center';
        statsCtx.fillText('–ö–ª–∏–µ–Ω—Ç–æ–≤: ' + _deliveryClients.length + '  |  –ò—Ç–æ–≥–æ: ' + _deliveryGrandTotal.toLocaleString() + ' —Å–æ–º', 300, 26);
        
        const statsImage = statsCanvas.toDataURL('image/png');
        doc.addImage(statsImage, 'PNG', 10, yPosition, 190, 11);
        yPosition += 14;
        
        // –ö–ª–∏–µ–Ω—Ç—ã
        for (let i = 0; i < _deliveryClients.length; i++) {
          const client = _deliveryClients[i];
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏–º –ª–∏ –∑–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
          if (yPosition > 260) {
            doc.addPage();
            yPosition = 10;
          }
          
          const cardCanvas = document.createElement('canvas');
          const cardCtx = cardCanvas.getContext('2d');
          cardCanvas.width = 600 * scale;
          cardCanvas.height = 90 * scale;
          cardCtx.scale(scale, scale);
          
          // –§–æ–Ω –∫–∞—Ä—Ç–æ—á–∫–∏
          cardCtx.fillStyle = 'white';
          cardCtx.fillRect(0, 0, 600, 90);
          cardCtx.strokeStyle = '#e0e0e0';
          cardCtx.lineWidth = 1;
          cardCtx.strokeRect(0, 0, 600, 90);
          
          // –ó–µ–ª—ë–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ —Å–ª–µ–≤–∞
          cardCtx.fillStyle = '#4CAF50';
          cardCtx.fillRect(0, 0, 6, 90);
          
          // –ù–æ–º–µ—Ä
          cardCtx.beginPath();
          cardCtx.arc(30, 20, 14, 0, Math.PI * 2);
          cardCtx.fillStyle = '#4CAF50';
          cardCtx.fill();
          cardCtx.fillStyle = 'white';
          cardCtx.font = 'bold 14px Arial';
          cardCtx.textAlign = 'center';
          cardCtx.fillText(String(i + 1), 30, 25);
          
          // –°—É–º–º–∞
          cardCtx.fillStyle = '#4CAF50';
          cardCtx.font = 'bold 18px Arial';
          cardCtx.textAlign = 'right';
          cardCtx.fillText(client.total.toLocaleString() + ' —Å–æ–º', 590, 25);
          
          // –ò–º—è
          cardCtx.fillStyle = '#333';
          cardCtx.font = 'bold 15px Arial';
          cardCtx.textAlign = 'left';
          cardCtx.fillText((client.name || '–ë–µ–∑ –∏–º–µ–Ω–∏').substring(0, 35), 55, 25);
          
          // –¢–µ–ª–µ—Ñ–æ–Ω
          cardCtx.font = '13px Arial';
          cardCtx.fillStyle = '#4CAF50';
          cardCtx.fillText('–¢–µ–ª: ' + (client.phone || '-'), 20, 48);
          
          // –ê–¥—Ä–µ—Å
          cardCtx.fillStyle = '#666';
          cardCtx.fillText('–ê–¥—Ä–µ—Å: ' + (client.address || '-').substring(0, 45), 20, 68);
          
          // –ü—É—Å—Ç–æ–π —á–µ–∫–±–æ–∫—Å
          cardCtx.strokeStyle = '#999';
          cardCtx.lineWidth = 2;
          cardCtx.strokeRect(560, 55, 20, 20);
          cardCtx.font = '10px Arial';
          cardCtx.fillStyle = '#999';
          cardCtx.textAlign = 'right';
          cardCtx.fillText('—Å–æ–±—Ä–∞–Ω–æ', 555, 68);
          
          const cardImage = cardCanvas.toDataURL('image/png');
          doc.addImage(cardImage, 'PNG', 10, yPosition, 190, 25);
          yPosition += 27;
        }
        
        // –ò—Ç–æ–≥–æ –≤–Ω–∏–∑—É
        if (yPosition > 260) {
          doc.addPage();
          yPosition = 10;
        }
        
        const totalCanvas = document.createElement('canvas');
        const totalCtx = totalCanvas.getContext('2d');
        totalCanvas.width = 600 * scale;
        totalCanvas.height = 50 * scale;
        totalCtx.scale(scale, scale);
        
        totalCtx.fillStyle = '#ffeb3b';
        totalCtx.fillRect(0, 0, 600, 50);
        totalCtx.strokeStyle = '#333';
        totalCtx.lineWidth = 3;
        totalCtx.strokeRect(0, 0, 600, 50);
        
        totalCtx.fillStyle = '#333';
        totalCtx.font = 'bold 22px Arial';
        totalCtx.textAlign = 'center';
        totalCtx.fillText('–í–°–ï–ì–û –ö –°–ë–û–†–£: ' + _deliveryGrandTotal.toLocaleString() + ' —Å–æ–º', 300, 33);
        
        const totalImage = totalCanvas.toDataURL('image/png');
        doc.addImage(totalImage, 'PNG', 10, yPosition, 190, 14);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF blob
        const pdfBlob = doc.output('blob');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
        const botToken = '7599592948:AAGtc_dGAcJFVQOSYcKVY0W-7GegszY9n8E';
        const chatId = '5567924440';
        const dateForFile = document.getElementById('dateFilter').value.replace(/-/g, '_');
        const agentSuffix = _deliveryAgentName ? ('_' + _deliveryAgentName.replace(/\s+/g, '_')) : '';
        
        const formData = new FormData();
        formData.append('chat_id', chatId);
        formData.append('document', pdfBlob, 'Dostavka_' + dateForFile + agentSuffix + '.pdf');
        formData.append('caption', '–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏' + (_deliveryAgentName ? ' [' + _deliveryAgentName + ']' : '') + '\n–î–∞—Ç–∞: ' + _deliveryDate + '\n–ö–ª–∏–µ–Ω—Ç–æ–≤: ' + _deliveryClients.length + '\n–ò—Ç–æ–≥–æ: ' + _deliveryGrandTotal.toLocaleString() + ' —Å–æ–º');
        
        const response = await fetch('https://api.telegram.org/bot' + botToken + '/sendDocument', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.ok) {
          Swal.fire({
            icon: 'success',
            title: 'PDF –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!',
            text: '–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          throw new Error(result.description || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å PDF: ' + error.message, 'error');
      }
    }
  </script>
</body>
</html>
