<!DOCTYPE html>
<html lang="ru">
<head>
  <script>if(window.parent!==window)document.write('<style>.bottom-nav,#bottomNavBar{display:none!important}body{padding-bottom:0!important}</style>')</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#667eea">
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-kerben.jpg">
  <link rel="icon" type="image/jpeg" href="icon-kerben.jpg">
  
  <title>–ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ - –ê–¥–º–∏–Ω</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    /* –®–∞–ø–∫–∞ */
    .admin-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .header-top {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .back-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .header-title {
      flex: 1;
    }
    
    .header-title h1 {
      font-size: 20px;
      font-weight: 600;
    }
    
    .header-title p {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 2px;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .action-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .action-btn.danger {
      background: rgba(220,53,69,0.8);
    }
    
    .action-btn.danger:hover {
      background: rgba(220,53,69,1);
    }
    
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–∞—Ç–∞ */
    .chat-container {
      height: calc(100vh - 80px);
      background: white;
      position: relative;
    }
    
    /* –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ */
    .clients-panel {
      width: 100%;
      height: 100%;
      background: white;
      display: flex;
      flex-direction: column;
    }
    
    .clients-panel.hidden {
      display: none;
    }
    
    .clients-header {
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .clients-header h3 {
      font-size: 16px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .clients-count {
      background: #667eea;
      color: white;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .clients-search {
      padding: 10px 15px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .clients-search input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
    }
    
    .clients-search input:focus {
      border-color: #667eea;
    }
    
    .clients-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    
    .client-card {
      padding: 12px 15px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .client-card:hover {
      border-color: #667eea;
      background: #f0f0ff;
    }
    
    .client-card.active {
      border-color: #667eea;
      background: #e3f2fd;
    }
    
    .client-card.has-unread {
      background: #fff9c4;
    }
    
    .client-card.has-unread::before {
      content: 'üîî';
      float: right;
    }
    
    .client-name {
      font-weight: 600;
      color: #333;
      font-size: 15px;
      margin-bottom: 4px;
    }
    
    .client-meta {
      font-size: 12px;
      color: #666;
    }
    
    .client-last-msg {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .no-clients {
      text-align: center;
      color: #999;
      padding: 40px 20px;
      font-size: 14px;
    }
    
    /* –ü–∞–Ω–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π */
    .messages-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      background: white;
      z-index: 10;
    }
    
    .messages-panel.visible {
      display: flex;
    }
    
    .messages-header {
      padding: 15px 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      display: none;
      align-items: center;
    }
    
    .messages-header.visible {
      display: flex;
    }
    
    .messages-header-info {
      flex: 1;
    }
    
    .messages-header h3 {
      font-size: 18px;
      margin-bottom: 3px;
    }
    
    .messages-header p {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .messages-placeholder {
      text-align: center;
      color: #999;
      padding: 60px 20px;
      font-size: 16px;
    }
    
    .messages-placeholder .icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    /* –°–æ–æ–±—â–µ–Ω–∏—è */
    .message {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .message.from-client {
      background: white;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    
    .message.from-admin {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    .message-sender {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      opacity: 0.9;
    }
    
    .message.from-client .message-sender {
      color: #667eea;
    }
    
    .message-text {
      font-size: 15px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    
    .message-time {
      font-size: 11px;
      margin-top: 5px;
      opacity: 0.7;
      text-align: right;
    }
    
    /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
    .input-area {
      padding: 15px 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: none;
    }
    
    .input-area.visible {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .input-area input {
      flex: 1;
      padding: 12px 20px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 15px;
      outline: none;
    }
    
    .input-area input:focus {
      border-color: #667eea;
    }
    
    .send-btn {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }
    
    .send-btn:hover {
      transform: scale(1.05);
    }
    
    .send-btn:active {
      transform: scale(0.95);
    }
    
    /* –ó–∞–≥—Ä—É–∑–∫–∞ */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e0e0e0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 768px) {
      .chat-container {
        height: calc(100vh - 70px);
      }
      
      .clients-panel {
        width: 100%;
        height: 100%;
      }
      
      .header-actions {
        flex-wrap: wrap;
      }
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ */
    .mobile-back-btn {
      display: inline-flex;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 20px;
      padding: 5px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-right: 12px;
    }
    
    .mobile-back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header class="admin-header">
    <div class="header-top">
      <a href="profile.html" class="back-btn" title="–ù–∞–∑–∞–¥">‚Üê</a>
      <div class="header-title">
        <h1>üí¨ –ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ <span id="unreadBadge" style="display:none; background:red; color:white; font-size:14px; padding:2px 8px; border-radius:10px; margin-left:8px;">0</span></h1>
        <p>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
      </div>
      <div class="header-actions">
        <button class="action-btn" onclick="refreshClients()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="action-btn danger" onclick="clearAllMessages()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      </div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
  <div class="chat-container">
    <!-- –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
    <div class="clients-panel" id="clientsPanel">
      <div class="clients-header">
        <h3>üìã –ö–ª–∏–µ–Ω—Ç—ã <span class="clients-count" id="clientsCount">0</span></h3>
      </div>
      <div class="clients-search">
        <input type="text" id="searchClients" placeholder="üîç –ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞..." oninput="filterClients()">
      </div>
      <div class="clients-list" id="clientsList">
        <div class="loading">
          <div class="loading-spinner"></div>
          –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...
        </div>
      </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="messages-panel" id="messagesPanel">
      <div class="messages-header" id="messagesHeader">
        <button class="mobile-back-btn" onclick="showClientsList()">‚Üê</button>
        <div class="messages-header-info">
          <h3 id="chatClientName">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</h3>
          <p id="chatClientId"></p>
        </div>
      </div>
      <div class="messages-area" id="messagesArea">
        <div class="messages-placeholder">
          <div class="icon">üëà</div>
          <div>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞<br>–¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏</div>
        </div>
      </div>
      <div class="input-area" id="inputArea">
        <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <script>
    // ==================== FIREBASE INIT ====================
    const firebaseConfig = {
      apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
      authDomain: "svoysayet.firebaseapp.com",
      projectId: "svoysayet",
      storageBucket: "svoysayet.firebasestorage.app",
      messagingSenderId: "785840370498",
      appId: "1:785840370498:web:e08c7cbef96aborc5e81f1"
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    
    // ==================== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
    let selectedClientId = null;
    let selectedClientName = null;
    let allClients = [];
    let messagesUnsubscribe = null;
    
    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    document.addEventListener('DOMContentLoaded', function() {
      if (checkAdminAccess()) {
        loadClients();
      }
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∞–¥–º–∏–Ω–∞
    function checkAdminAccess() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º customerData (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–± —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
      const customerData = localStorage.getItem('customerData');
      const sellerData = localStorage.getItem('sellerData');
      
      let isAdmin = false;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º customerData
      if (customerData) {
        try {
          const customer = JSON.parse(customerData);
          if (customer.isAdmin === true) {
            isAdmin = true;
          }
        } catch (e) {}
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º sellerData –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
      if (!isAdmin && sellerData) {
        try {
          const seller = JSON.parse(sellerData);
          if (seller.isAdmin === true || seller.role === 'admin') {
            isAdmin = true;
          }
        } catch (e) {}
      }
      
      if (!isAdmin) {
        Swal.fire({
          icon: 'error',
          title: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω',
          text: '–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤',
          confirmButtonText: '–ù–∞ –≥–ª–∞–≤–Ω—É—é'
        }).then(() => {
          window.location.href = 'index.html';
        });
        return false;
      }
      
      return true;
    }
    
    // ==================== –ó–ê–ì–†–£–ó–ö–ê –ö–õ–ò–ï–ù–¢–û–í ====================
    async function loadClients() {
      const clientsList = document.getElementById('clientsList');
      const clientsCount = document.getElementById('clientsCount');
      
      clientsList.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          –ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...
        </div>
      `;
      
      try {
        const snapshot = await db.collection('chatClients').get();
        
        allClients = [];
        snapshot.forEach(doc => {
          allClients.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ lastActive (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
        allClients.sort((a, b) => {
          const timeA = a.lastActive ? a.lastActive.toDate().getTime() : 0;
          const timeB = b.lastActive ? b.lastActive.toDate().getTime() : 0;
          return timeB - timeA;
        });
        
        clientsCount.textContent = allClients.length;
        renderClients(allClients);
        
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
        subscribeToNewClients();
        
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è badge
        subscribeToUnreadMessages();
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤:', error);
        clientsList.innerHTML = `
          <div class="no-clients">
            ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏<br>
            <button onclick="loadClients()" style="margin-top:10px; padding:8px 16px; border:none; background:#667eea; color:white; border-radius:8px; cursor:pointer;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
          </div>
        `;
      }
    }
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
    function renderClients(clients) {
      const clientsList = document.getElementById('clientsList');
      
      if (clients.length === 0) {
        clientsList.innerHTML = '<div class="no-clients">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤<br>–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç—ã –Ω–∞–ø–∏—à—É—Ç, –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>';
        return;
      }
      
      clientsList.innerHTML = '';
      
      clients.forEach(client => {
        const card = document.createElement('div');
        card.className = 'client-card' + (client.hasUnread ? ' has-unread' : '') + (client.id === selectedClientId ? ' active' : '');
        card.onclick = () => selectClient(client);
        
        const lastActive = client.lastActive ? formatDate(client.lastActive.toDate()) : '–î–∞–≤–Ω–æ';
        
        card.innerHTML = `
          <div class="client-name">${escapeHtml(client.name || '–ö–ª–∏–µ–Ω—Ç')}</div>
          <div class="client-meta">${lastActive}</div>
          ${client.lastMessage ? `<div class="client-last-msg">${escapeHtml(client.lastMessage)}</div>` : ''}
        `;
        
        clientsList.appendChild(card);
      });
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
    function filterClients() {
      const query = document.getElementById('searchClients').value.toLowerCase().trim();
      
      if (!query) {
        renderClients(allClients);
        return;
      }
      
      const filtered = allClients.filter(c => 
        (c.name && c.name.toLowerCase().includes(query)) ||
        (c.id && c.id.toLowerCase().includes(query)) ||
        (c.lastMessage && c.lastMessage.toLowerCase().includes(query))
      );
      
      renderClients(filtered);
    }
    
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
    function subscribeToNewClients() {
      db.collection('chatClients').onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added' || change.type === 'modified') {
            const clientData = { id: change.doc.id, ...change.doc.data() };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const existingClient = allClients.find(c => c.id === clientData.id);
            if (clientData.hasUnread && (!existingClient || !existingClient.hasUnread)) {
              // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
              showNewMessageNotification('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç: ' + (clientData.name || '–ö–ª–∏–µ–Ω—Ç'));
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
            const existingIndex = allClients.findIndex(c => c.id === clientData.id);
            if (existingIndex >= 0) {
              allClients[existingIndex] = clientData;
            } else {
              allClients.unshift(clientData);
            }
            
            // –ü–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä—É–µ–º
            allClients.sort((a, b) => {
              const timeA = a.lastActive ? a.lastActive.toDate().getTime() : 0;
              const timeB = b.lastActive ? b.lastActive.toDate().getTime() : 0;
              return timeB - timeA;
            });
            
            document.getElementById('clientsCount').textContent = allClients.length;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ø–µ—á–∞—Ç–∞–µ–º –≤ –ø–æ–∏—Å–∫–µ
            if (!document.getElementById('searchClients').value) {
              renderClients(allClients);
            }
          }
        });
      });
    }
    
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è badge
    function subscribeToUnreadMessages() {
      db.collection('chatClients')
        .where('hasUnread', '==', true)
        .onSnapshot(snapshot => {
          const unreadCount = snapshot.size;
          const badge = document.getElementById('unreadBadge');
          if (badge) {
            badge.textContent = unreadCount;
            badge.style.display = unreadCount > 0 ? 'inline' : 'none';
          }
          console.log('üì¨ –ö–ª–∏–µ–Ω—Ç–æ–≤ —Å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏:', unreadCount);
        }, error => {
          console.log('–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ:', error.message);
        });
    }
    
    // ==================== –í–´–ë–û–† –ö–õ–ò–ï–ù–¢–ê ====================
    async function selectClient(client) {
      selectedClientId = client.id;
      selectedClientName = client.name || '–ö–ª–∏–µ–Ω—Ç';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å–ø–∏—Å–∫–∞
      document.querySelectorAll('.client-card').forEach(card => card.classList.remove('active'));
      event.currentTarget.classList.add('active');
      event.currentTarget.classList.remove('has-unread');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —à–∞–ø–∫—É –∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      document.getElementById('messagesHeader').classList.add('visible');
      document.getElementById('inputArea').classList.add('visible');
      document.getElementById('chatClientName').textContent = 'üí¨ ' + selectedClientName;
      document.getElementById('chatClientId').textContent = 'ID: ' + client.id;
      document.getElementById('messageInput').placeholder = '–û—Ç–≤–µ—Ç–∏—Ç—å ' + selectedClientName + '...';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π, —Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
      document.getElementById('clientsPanel').classList.add('hidden');
      document.getElementById('messagesPanel').classList.add('visible');
      
      // –£–±–∏—Ä–∞–µ–º –º–µ—Ç–∫—É –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
      try {
        await db.collection('chatClients').doc(client.id).update({ hasUnread: false });
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', e);
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
      loadMessages(client.id);
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤
    function showClientsList() {
      document.getElementById('clientsPanel').classList.remove('hidden');
      document.getElementById('messagesPanel').classList.remove('visible');
      selectedClientId = null;
      selectedClientName = null;
    }
    
    // ==================== –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ====================
    async function loadMessages(clientId) {
      const messagesArea = document.getElementById('messagesArea');
      messagesArea.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...
        </div>
      `;
      
      // –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
      if (messagesUnsubscribe) {
        messagesUnsubscribe();
      }
      
      try {
        const snapshot = await db.collection('chatMessages')
          .where('clientId', '==', clientId)
          .get();
        
        messagesArea.innerHTML = '';
        
        if (snapshot.empty) {
          messagesArea.innerHTML = `
            <div class="messages-placeholder">
              <div class="icon">üí¨</div>
              <div>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π —Å ${selectedClientName}<br>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ –ø–µ—Ä–≤—ã–º!</div>
            </div>
          `;
        } else {
          // –°–æ–±–∏—Ä–∞–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
          const messages = [];
          snapshot.forEach(doc => {
            messages.push({ id: doc.id, ...doc.data() });
          });
          
          messages.sort((a, b) => {
            const timeA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
            const timeB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
            return timeA - timeB;
          });
          
          // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
          messages.forEach(msg => {
            addMessageToUI(msg.text, msg.sender, msg.timestamp ? msg.timestamp.toDate() : new Date());
          });
          
          // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
          messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        subscribeToMessages(clientId);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        messagesArea.innerHTML = `
          <div class="messages-placeholder">
            <div class="icon">‚ùå</div>
            <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
          </div>
        `;
      }
    }
    
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    function subscribeToMessages(clientId) {
      messagesUnsubscribe = db.collection('chatMessages')
        .where('clientId', '==', clientId)
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
              const msg = change.doc.data();
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ —Ç–µ–∫—Å—Ç—É –∏ –≤—Ä–µ–º–µ–Ω–∏
              const messagesArea = document.getElementById('messagesArea');
              const existingMsgs = messagesArea.querySelectorAll('.message');
              let isDuplicate = false;
              
              existingMsgs.forEach(el => {
                if (el.dataset.text === msg.text) {
                  isDuplicate = true;
                }
              });
              
              if (!isDuplicate && msg.sender === 'client' && selectedClientId === clientId) {
                addMessageToUI(msg.text, msg.sender, msg.timestamp ? msg.timestamp.toDate() : new Date());
                messagesArea.scrollTop = messagesArea.scrollHeight;
                showNewMessageNotification('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞: ' + (msg.clientName || '–ö–ª–∏–µ–Ω—Ç'));
              }
            }
          });
        });
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI
    function addMessageToUI(text, sender, timestamp) {
      const messagesArea = document.getElementById('messagesArea');
      
      // –£–¥–∞–ª—è–µ–º placeholder –µ—Å–ª–∏ –µ—Å—Ç—å
      const placeholder = messagesArea.querySelector('.messages-placeholder');
      if (placeholder) placeholder.remove();
      
      const isAdmin = sender === 'admin';
      const div = document.createElement('div');
      div.className = 'message ' + (isAdmin ? 'from-admin' : 'from-client');
      div.dataset.text = text;
      
      const time = formatTime(timestamp);
      const date = formatDateShort(timestamp);
      
      div.innerHTML = `
        <div class="message-sender">${isAdmin ? '‚úÖ –í—ã' : 'üë§ ' + selectedClientName}</div>
        <div class="message-text">${escapeHtml(text)}</div>
        <div class="message-time">${date} ${time}</div>
      `;
      
      messagesArea.appendChild(div);
    }
    
    // ==================== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø ====================
    async function sendMessage() {
      if (!selectedClientId) {
        Swal.fire({
          icon: 'warning',
          title: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞',
          text: '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞',
          confirmButtonColor: '#667eea'
        });
        return;
      }
      
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text) return;
      
      const now = new Date();
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤ UI —Å—Ä–∞–∑—É
      addMessageToUI(text, 'admin', now);
      input.value = '';
      
      // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
      const messagesArea = document.getElementById('messagesArea');
      messagesArea.scrollTop = messagesArea.scrollHeight;
      
      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
        await db.collection('chatMessages').add({
          text: text,
          sender: 'admin',
          clientId: selectedClientId,
          clientName: selectedClientName,
          timestamp: firebase.firestore.Timestamp.fromDate(now),
          read: false
        });
        
        console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É:', selectedClientName);
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        Swal.fire({
          icon: 'error',
          title: '–û—à–∏–±–∫–∞',
          text: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ',
          confirmButtonColor: '#667eea'
        });
      }
    }
    
    // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï ====================
    function refreshClients() {
      loadClients();
      
      Swal.fire({
        icon: 'success',
        title: '–û–±–Ω–æ–≤–ª–µ–Ω–æ',
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 1500
      });
    }
    
    // ==================== –û–ß–ò–°–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ====================
    async function clearAllMessages() {
      const result = await Swal.fire({
        title: '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è?',
        text: '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å—ë',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞',
        confirmButtonColor: '#dc3545'
      });
      
      if (!result.isConfirmed) return;
      
      try {
        Swal.fire({
          title: '–£–¥–∞–ª–µ–Ω–∏–µ...',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        const messagesSnapshot = await db.collection('chatMessages').get();
        const batch1 = db.batch();
        messagesSnapshot.forEach(doc => batch1.delete(doc.ref));
        await batch1.commit();
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
        const clientsSnapshot = await db.collection('chatClients').get();
        const batch2 = db.batch();
        clientsSnapshot.forEach(doc => batch2.delete(doc.ref));
        await batch2.commit();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        allClients = [];
        document.getElementById('clientsCount').textContent = '0';
        document.getElementById('clientsList').innerHTML = '<div class="no-clients">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</div>';
        document.getElementById('messagesArea').innerHTML = `
          <div class="messages-placeholder">
            <div class="icon">üëà</div>
            <div>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞</div>
          </div>
        `;
        document.getElementById('messagesHeader').classList.remove('visible');
        document.getElementById('inputArea').classList.remove('visible');
        
        selectedClientId = null;
        selectedClientName = null;
        
        Swal.fire({
          icon: 'success',
          title: '–£–¥–∞–ª–µ–Ω–æ!',
          text: '–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–ª–∏–µ–Ω—Ç—ã —É–¥–∞–ª–µ–Ω—ã',
          confirmButtonColor: '#667eea'
        });
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:', error);
        Swal.fire({
          icon: 'error',
          title: '–û—à–∏–±–∫–∞',
          text: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è',
          confirmButtonColor: '#667eea'
        });
      }
    }
    
    // ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ====================
    let originalTitle = document.title;
    let titleBlinkInterval = null;
    
    let audioCtx = null;
    
    function showNewMessageNotification(text) {
      console.log('üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', text);
      
      // –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      try {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
          audioCtx.resume();
        }
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.frequency.value = 600;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.3);
      } catch(e) { console.log('–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:', e); }
      
      // –ú–∏–≥–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–≤—Å–µ–≥–¥–∞)
      let isOriginal = true;
      if (titleBlinkInterval) clearInterval(titleBlinkInterval);
      titleBlinkInterval = setInterval(() => {
        document.title = isOriginal ? 'üí¨ ' + text : originalTitle;
        isOriginal = !isOriginal;
      }, 1000);
      
      window.addEventListener('focus', function stopBlink() {
        clearInterval(titleBlinkInterval);
        document.title = originalTitle;
        window.removeEventListener('focus', stopBlink);
      }, { once: true });
      
      // –ë—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('–ö–µ—Ä–±–µ–Ω - –ê–¥–º–∏–Ω –ß–∞—Ç', { body: text, icon: 'icon-kerben.jpg' });
      }
    }
    
    // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
    
    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatDate(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
      if (minutes < 60) return minutes + ' –º–∏–Ω. –Ω–∞–∑–∞–¥';
      if (hours < 24) return hours + ' —á. –Ω–∞–∑–∞–¥';
      if (days < 7) return days + ' –¥–Ω. –Ω–∞–∑–∞–¥';
      
      return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: '2-digit' });
    }
    
    function formatDateShort(date) {
      return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
    }
    
    function formatTime(date) {
      return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }
  </script>
<script src="js/bottom-nav.js?v=20"></script>
</body>
</html>
