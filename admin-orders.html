<!DOCTYPE html>
<html lang="ru">
<head>
  <script>if(window.parent!==window)document.write('<style>.bottom-nav{display:none!important}body{padding-bottom:0!important}#ordersManagementWindow{bottom:0!important}</style>')</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ - –ö–µ—Ä–±–µ–Ω</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    input, textarea, select {
      font-family: inherit;
      font-size: 16px;
    }
    
    /* SweetAlert –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
    .swal2-container {
      z-index: 999999 !important;
    }
    
    /* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #fff;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-around;
      z-index: 99999;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      color: #9e9e9e;
      text-decoration: none;
      position: relative;
    }
    .nav-item.active { color: #4CAF50; }
    .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
    .nav-item span { font-size: 11px; }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
    .order-items-cards {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .order-item-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
    }
    .order-item-card-title {
      background: linear-gradient(90deg, #667eea, #764ba2);
      color: white;
      padding: 10px 14px;
      font-weight: 600;
      font-size: 15px;
    }
    .order-item-card-body {
      padding: 12px 14px;
    }
    .order-item-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .order-item-field:last-of-type {
      border-bottom: none;
    }
    .order-item-field .label {
      font-size: 13px;
      color: #666;
    }
    .order-item-field .value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    .order-item-actions {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
      text-align: right;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
    @media (max-width: 600px) {
      #ordersManagementWindow > div,
      #addItemToOrderModal > div {
        width: 100% !important;
        height: 100% !important;
        max-height: 100% !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }
      
      #orderItemsDetailModal > div {
        width: 100% !important;
        height: 100% !important;
        max-height: 100% !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }
      
      .orders-filters {
        gap: 6px !important;
      }
      .orders-filters input,
      .orders-filters select {
        padding: 8px !important;
        font-size: 13px !important;
      }
      #orderItemsDetailContent {
        padding: 12px !important;
      }
      .order-card {
        margin-bottom: 10px !important;
      }
    }
  </style>
</head>
<body>
  <!-- –û–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏ - –ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù -->
  <div id="ordersManagementWindow" style="position:fixed; top:0; left:0; right:0; bottom:56px; background:#f5f5f5; z-index:9650;">
    <div style="background:#f5f5f5; width:100%; height:100%; display:flex; flex-direction:column;">

      <!-- –®–∞–ø–∫–∞ -->
      <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px 20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:20px;">üì¶ –ó–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:13px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</p>
        </div>
        <button onclick="closeOrdersManagementWindow()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:44px; height:44px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –ü–æ–∏—Å–∫ -->
      <div style="padding:12px 16px 8px; background:#fff;">
        <input type="text" id="ordersSearchClient" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..." oninput="scheduleOrdersManagementSearch()" style="width:100%; padding:10px 14px; border:1px solid #e0e0e0; border-radius:10px; font-size:15px; background:#f8f8f8; box-sizing:border-box;">
      </div>

      <!-- –§–∏–ª—å—Ç—Ä—ã -->
      <div class="orders-filters" style="padding:8px 16px 12px; background:#fff; border-bottom:1px solid #e0e0e0; display:flex; gap:8px; align-items:center;">
        <select id="ordersFilterCombined" onchange="applyOrdersCombinedFilter()" style="width:50%; padding:8px 10px; border:1px solid #e0e0e0; border-radius:8px; font-size:13px; background:#fff;">
          <option value="all|all">–í—Å–µ</option>
          <option value="all|today">–°–µ–≥–æ–¥–Ω—è</option>
          <option value="all|yesterday">–í—á–µ—Ä–∞</option>
          <option value="all|week">–ù–µ–¥–µ–ª—è</option>
          <option value="pending|all">üïê –ù–æ–≤—ã–µ</option>
          <option value="preparing|all">üì¶ –ì–æ—Ç–æ–≤—è—Ç—Å—è</option>
          <option value="logistics|all">üöö –õ–æ–≥–∏—Å—Ç–∏–∫–∞</option>
          <option value="driver|all">üöó –î–æ—Å—Ç–∞–≤–∫–∞</option>
          <option value="completed|all">‚úì –ì–æ—Ç–æ–≤—ã</option>
          <option value="cancelled|all">‚úï –û—Ç–º–µ–Ω–µ–Ω—ã</option>
        </select>
        <button onclick="openMergeOrdersModal()" style="padding:8px 12px; background:#667eea; color:white; border:none; border-radius:8px; cursor:pointer; font-size:13px;">üîó</button>
        <button onclick="loadOrdersManagement(true)" style="padding:8px 12px; background:#28a745; color:white; border:none; border-radius:8px; cursor:pointer; font-size:13px;">üîÑ</button>
      </div>

      <!-- –°–∫—Ä—ã—Ç—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ -->
      <select id="ordersFilterStatus" style="display:none;"><option value="all" selected></option></select>
      <select id="ordersFilterDate" style="display:none;"><option value="all" selected></option></select>

      <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
      <div id="ordersManagementList" style="flex:1; overflow-y:auto; padding:12px 16px; background:#f5f5f5;">
        <div style="text-align:center; color:#999; padding:40px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
  <div id="editOrderModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9700; justify-content:center; align-items:center;">
    <div style="background:white; width:95%; max-width:500px; max-height:90vh; border-radius:16px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
      <div style="padding:16px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee;">
        <div>
          <h2 style="margin:0; font-size:17px; font-weight:600; color:#1a1a1a;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑</h2>
          <p style="margin:4px 0 0; font-size:12px; color:#888;" id="editOrderModalInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        <button onclick="closeEditOrderModal()" style="background:#f0f0f0; color:#333; border:none; font-size:18px; width:32px; height:32px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <div style="flex:1; overflow-y:auto; padding:16px 20px;">
        <div style="display:flex; flex-direction:column; gap:14px;">
          <div>
            <label style="font-size:12px; font-weight:500; color:#555; display:block; margin-bottom:6px;">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
            <input id="editOrderName" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" style="width:100%; padding:10px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px; box-sizing:border-box;" />
          </div>
          <div>
            <label style="font-size:12px; font-weight:500; color:#555; display:block; margin-bottom:6px;">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input id="editOrderPhone" type="tel" placeholder="+996" style="width:100%; padding:10px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px; box-sizing:border-box;" />
          </div>
          <div>
            <label style="font-size:12px; font-weight:500; color:#555; display:block; margin-bottom:6px;">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
            <input id="editOrderAddress" type="text" placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞" style="width:100%; padding:10px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px; box-sizing:border-box;" />
          </div>
          
          <div style="padding-top:10px; border-top:1px solid #eee;">
            <div style="font-size:11px; color:#999; margin-bottom:10px;">–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div>
                <label style="font-size:11px; color:#777; display:block; margin-bottom:4px;">–í–æ–¥–∏—Ç–µ–ª—å</label>
                <input id="editOrderDriverName" type="text" placeholder="–ò–º—è" style="width:100%; padding:8px 10px; border:1px solid #e0e0e0; border-radius:6px; font-size:13px; box-sizing:border-box;" />
              </div>
              <div>
                <label style="font-size:11px; color:#777; display:block; margin-bottom:4px;">–¢–µ–ª. –≤–æ–¥–∏—Ç–µ–ª—è</label>
                <input id="editOrderDriverPhone" type="tel" placeholder="–ù–æ–º–µ—Ä" style="width:100%; padding:8px 10px; border:1px solid #e0e0e0; border-radius:6px; font-size:13px; box-sizing:border-box;" />
              </div>
            </div>
          </div>
          
          <div>
            <label style="font-size:11px; color:#777; display:block; margin-bottom:4px;">–ö—Ç–æ –ø—Ä–∏–≤—ë–ª –∫–ª–∏–µ–Ω—Ç–∞?</label>
            <input id="editOrderReferredBy" type="text" placeholder="–ò–º—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞" style="width:100%; padding:8px 10px; border:1px solid #e0e0e0; border-radius:6px; font-size:13px; box-sizing:border-box;" />
          </div>
        </div>
      </div>

      <div style="padding:12px 20px; background:#fafafa; border-top:1px solid #eee; display:flex; gap:10px;">
        <button onclick="closeEditOrderModal()" style="flex:1; padding:12px; background:#f0f0f0; color:#333; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:500;">–û—Ç–º–µ–Ω–∞</button>
        <button onclick="saveEditOrder()" style="flex:1; padding:12px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–∫–∞–∑–∞ -->
  <div id="orderItemsDetailModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:9700;">
    <div style="background:white; width:100%; height:100%; max-width:900px; margin:0 auto; display:flex; flex-direction:column; overflow:hidden;">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div style="background:linear-gradient(135deg, #007bff 0%, #0056b3 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
        <div>
          <h2 style="margin:0; font-size:22px;" id="orderItemsDetailTitle">–¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ</h2>
          <p style="margin:5px 0 0; opacity:0.9;" id="orderItemsDetailInfo">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</p>
        </div>
        <button onclick="closeOrderItemsDetailModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
      <div id="orderItemsDetailContent" style="flex:1; overflow-y:auto; padding:20px;">
        <div style="text-align:center; color:#999; padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      <div style="padding:15px; background:#f8f9fa; border-top:1px solid #e0e0e0; display:flex; gap:10px; justify-content:flex-end; flex-shrink:0;">
        <button id="orderItemsAddBtn" style="padding:10px 20px; background:#17a2b8; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </button>
        <button onclick="closeOrderItemsDetailModal()" style="padding:10px 20px; background:#6c757d; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑ -->
  <div id="addItemToOrderModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:9750; justify-content:center; align-items:center;">
    <div style="background:white; width:90%; max-width:600px; max-height:80vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div style="background:linear-gradient(135deg, #17a2b8 0%, #138496 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h2 style="margin:0; font-size:20px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä –≤ –∑–∞–∫–∞–∑</h2>
          <p style="margin:5px 0 0; opacity:0.9; font-size:13px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏–∑ —Å–ø–∏—Å–∫–∞</p>
        </div>
        <button onclick="closeAddItemToOrderModal()" style="background:rgba(255,255,255,0.2); color:white; border:none; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>

      <!-- –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ -->
      <div style="padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0;">
        <input type="text" id="searchProductToAdd" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞..." oninput="scheduleFilterProductsToAdd()" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
      </div>

      <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
      <div id="productsToAddList" style="flex:1; overflow-y:auto; padding:15px;">
        <div style="text-align:center; color:#999; padding:40px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
      </div>
    </div>
  </div>

<script>
// ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ============
const firebaseConfig = {
  apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
  authDomain: "svoysayet.firebaseapp.com",
  projectId: "svoysayet",
  storageBucket: "svoysayet.firebasestorage.app",
  messagingSenderId: "450143000217",
  appId: "1:450143000217:web:7495cefaea0b94966e8a08",
  measurementId: "G-Y8VG9E29FY"
};

let db;
let products = [];

function initFirebase() {
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
    console.log('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
    return true;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö', 'error');
    return false;
  }
}

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ iOS
const _isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∫—Ä–æ–ª–ª–∞
function lockPageScroll() {
  document.body.style.overflow = 'hidden';
  document.body.style.position = 'fixed';
  document.body.style.width = '100%';
}

function unlockPageScroll() {
  document.body.style.overflow = '';
  document.body.style.position = '';
  document.body.style.width = '';
}

// ============ –ó–ê–ö–†–´–¢–ò–ï –û–ö–ù–ê ============
function closeOrdersManagementWindow() {
  window.location.href = 'profile.html';
}

// ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê–ú–ò ============
let ordersManagementAllOrders = null;
let ordersManagementSearchDebounceTimer = null;
let _ordersSearchComposing = false;

function scheduleOrdersManagementSearch() {
  if (_ordersSearchComposing) return;
  clearTimeout(ordersManagementSearchDebounceTimer);
  ordersManagementSearchDebounceTimer = setTimeout(() => {
    renderOrdersManagementFromCache();
  }, _isIOS ? 350 : 200);
}

function applyOrdersCombinedFilter() {
  const combo = document.getElementById('ordersFilterCombined');
  if (!combo) return;
  const [status, date] = combo.value.split('|');
  
  const statusEl = document.getElementById('ordersFilterStatus');
  const dateEl = document.getElementById('ordersFilterDate');
  if (statusEl) statusEl.value = status;
  if (dateEl) dateEl.value = date;
  
  updateOrdersManagementView();
}

function updateOrdersManagementView() {
  if (Array.isArray(ordersManagementAllOrders)) {
    renderOrdersManagementFromCache();
  } else {
    loadOrdersManagement(true);
  }
}

function renderOrdersManagementFromCache() {
  const listDiv = document.getElementById('ordersManagementList');
  if (!listDiv) return;

  if (!Array.isArray(ordersManagementAllOrders)) {
    listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';
    return;
  }

  const comboEl = document.getElementById('ordersFilterCombined');
  const searchEl = document.getElementById('ordersSearchClient');

  let statusFilter = 'all';
  let dateFilter = 'all';
  if (comboEl && comboEl.value) {
    const parts = comboEl.value.split('|');
    statusFilter = parts[0] || 'all';
    dateFilter = parts[1] || 'all';
  }
  const searchQuery = ((searchEl ? searchEl.value : '') || '').toLowerCase();

  const now = Date.now();
  const oneDayMs = 24 * 60 * 60 * 1000;

  let orders = ordersManagementAllOrders.filter(order => {
    const timestamp = order.timestamp || Date.now();

    let dateMatch = true;
    if (dateFilter === 'today') {
      const todayStart = new Date();
      todayStart.setHours(0, 0, 0, 0);
      dateMatch = timestamp >= todayStart.getTime();
    } else if (dateFilter === 'yesterday') {
      const todayStart = new Date();
      todayStart.setHours(0, 0, 0, 0);
      const yesterdayStart = new Date(todayStart);
      yesterdayStart.setDate(yesterdayStart.getDate() - 1);
      dateMatch = timestamp >= yesterdayStart.getTime() && timestamp < todayStart.getTime();
    } else if (dateFilter === 'week') {
      dateMatch = (now - timestamp) < (7 * oneDayMs);
    } else if (dateFilter === 'month') {
      dateMatch = (now - timestamp) < (30 * oneDayMs);
    }

    const status = order.status || 'pending';
    const statusMatch = statusFilter === 'all' || status === statusFilter;

    const name = (order.name || '').toLowerCase();
    const phone = (order.phone || '').toLowerCase();
    const searchMatch = !searchQuery || name.includes(searchQuery) || phone.includes(searchQuery);

    return dateMatch && statusMatch && searchMatch;
  });

  orders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

  if (orders.length === 0) {
    listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:60px; font-size:16px;">üîç –ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
    return;
  }

  listDiv.innerHTML = '';
  orders.forEach((order, index) => {
    const orderCard = createOrderCard(order, index);
    listDiv.appendChild(orderCard);
  });
}

async function loadOrdersManagement(forceRefresh = false) {
  const listDiv = document.getElementById('ordersManagementList');
  if (!listDiv) return;

  if (!forceRefresh && Array.isArray(ordersManagementAllOrders)) {
    renderOrdersManagementFromCache();
    return;
  }

  listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';

  try {
    const ordersSnapshot = await db.collection('orders').orderBy('timestamp', 'desc').limit(200).get();

    if (ordersSnapshot.empty) {
      ordersManagementAllOrders = [];
      listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:60px; font-size:16px;">üì≠ –ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
      return;
    }

    const all = [];
    ordersSnapshot.forEach(doc => {
      const data = doc.data();
      const timestamp = data.timestamp || Date.now();
      all.push({ id: doc.id, ...data, timestamp });
    });

    ordersManagementAllOrders = all;
    renderOrdersManagementFromCache();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
    listDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
  }
}

// –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–∫–∞–∑–∞
function createOrderCard(order, index) {
  const card = document.createElement('div');
  card.className = 'order-card';
  card.style.cssText = 'background:#fff; border-radius:12px; margin-bottom:12px; box-shadow:0 1px 4px rgba(0,0,0,0.08); overflow:hidden;';
  
  const date = new Date(order.timestamp);
  const dateStr = date.toLocaleDateString('ru-RU', {day:'2-digit', month:'short'}) + ', ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
  
  const status = order.status || 'pending';
  const statusMap = {
    pending: { icon: 'üïê', text: '–ù–æ–≤—ã–π', color: '#ff9800', bg: '#fff3e0' },
    preparing: { icon: 'üì¶', text: '–ì–æ—Ç–æ–≤–∏—Ç—Å—è', color: '#2196f3', bg: '#e3f2fd' },
    logistics: { icon: 'üöö', text: '–õ–æ–≥–∏—Å—Ç–∏–∫–∞', color: '#9c27b0', bg: '#f3e5f5' },
    driver: { icon: 'üöó', text: '–î–æ—Å—Ç–∞–≤–∫–∞', color: '#00bcd4', bg: '#e0f7fa' },
    completed: { icon: '‚úì', text: '–ì–æ—Ç–æ–≤', color: '#4caf50', bg: '#e8f5e9' },
    cancelled: { icon: '‚úï', text: '–û—Ç–º–µ–Ω—ë–Ω', color: '#f44336', bg: '#ffebee' }
  };
  const st = statusMap[status] || statusMap.pending;
  
  const items = order.items || [];
  const total = items.reduce((sum, i) => sum + (i.price * i.qty), 0);
  const itemsCount = items.reduce((sum, i) => sum + i.qty, 0);
  
  card.innerHTML = `
    <div style="display:flex; align-items:stretch;">
      <!-- –õ–µ–≤–∞—è –ø–æ–ª–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ -->
      <div style="width:4px; background:${st.color};"></div>
      
      <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
      <div style="flex:1; padding:14px;">
        <!-- –í–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞: –∫–ª–∏–µ–Ω—Ç –∏ —Å—Ç–∞—Ç—É—Å -->
        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
          <div style="flex:1;">
            <div style="font-size:15px; font-weight:600; color:#1a1a1a; margin-bottom:2px;">
              ${order.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}
            </div>
            <div style="font-size:13px; color:#666;">
              ${order.phone || ''} ${order.address ? '‚Ä¢ ' + order.address.substring(0,30) + (order.address.length > 30 ? '...' : '') : ''}
            </div>
          </div>
          <div style="display:flex; flex-direction:column; align-items:flex-end; gap:4px;">
            <div style="display:flex; gap:4px; align-items:center;">
              ${order.moneyCollected ? '<div style="background:#e8f5e9; color:#28a745; padding:4px 8px; border-radius:12px; font-size:11px; font-weight:600;">üí∞ –û–ø–ª–∞—á–µ–Ω–æ</div>' : ''}
              <div style="background:${st.bg}; color:${st.color}; padding:4px 10px; border-radius:12px; font-size:12px; font-weight:600; display:flex; align-items:center; gap:4px;">
                ${st.icon} ${st.text}
              </div>
            </div>
            <div style="font-size:11px; color:#999;">${dateStr}</div>
          </div>
        </div>
        
        <!-- –¢–æ–≤–∞—Ä—ã –∏ —Å—É–º–º–∞ -->
        <div style="display:flex; align-items:center; gap:10px; padding:10px; background:#f8f9fa; border-radius:8px; margin-bottom:10px;">
          <div style="flex:1;">
            <span style="font-size:13px; color:#555;">
              ${items.length > 0 ? items.slice(0,2).map(i => i.title).join(', ') + (items.length > 2 ? ' +' + (items.length - 2) : '') : '–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤'}
            </span>
          </div>
          <div style="text-align:right;">
            <div style="font-size:15px; font-weight:700; color:#1a1a1a;">${total.toLocaleString()} —Å</div>
            <div style="font-size:11px; color:#888;">${itemsCount} —à—Ç</div>
          </div>
        </div>
        
        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
          <select onchange="updateOrderStatus('${order.id}', this.value); this.blur();" style="padding:8px 10px; border:1px solid #e0e0e0; border-radius:6px; font-size:12px; background:#fff; cursor:pointer; color:#333;">
            <option value="pending" ${status === 'pending' ? 'selected' : ''}>üïê –ù–æ–≤—ã–π</option>
            <option value="preparing" ${status === 'preparing' ? 'selected' : ''}>üì¶ –ì–æ—Ç–æ–≤–∏—Ç—Å—è</option>
            <option value="logistics" ${status === 'logistics' ? 'selected' : ''}>üöö –õ–æ–≥–∏—Å—Ç–∏–∫–∞</option>
            <option value="driver" ${status === 'driver' ? 'selected' : ''}>üöó –î–æ—Å—Ç–∞–≤–∫–∞</option>
            <option value="completed" ${status === 'completed' ? 'selected' : ''}>‚úì –ì–æ—Ç–æ–≤</option>
            <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>‚úï –û—Ç–º–µ–Ω—ë–Ω</option>
          </select>
          <button onclick="openOrderItemsDetailModal('${order.id}', '${(order.name || '').replace(/'/g, "\\'")}', '${order.phone || ''}', '${dateStr}')" style="padding:8px 12px; background:#007bff; color:#fff; border:none; border-radius:6px; font-size:12px; cursor:pointer;">üìã –¢–æ–≤–∞—Ä—ã</button>
          <button onclick="openEditOrderModal('${order.id}')" style="padding:8px 12px; background:#ff9800; color:#fff; border:none; border-radius:6px; font-size:12px; cursor:pointer;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <div style="display:flex; gap:6px;">
            <button onclick="exportOrderToExcel('${order.id}', '${(order.name || '').replace(/'/g, "\\'")}', '${order.phone || ''}')" style="flex:1; padding:8px 12px; background:#25d366; color:#fff; border:none; border-radius:6px; font-size:12px; cursor:pointer;">üì§</button>
            <button onclick="deleteOrder('${order.id}')" style="flex:1; padding:8px 12px; background:#f44336; color:#fff; border:none; border-radius:6px; font-size:12px; cursor:pointer;">üóëÔ∏è</button>
          </div>
        </div>
        
        ${order.partner || order.referredBy ? `<div style="margin-top:8px;"><span style="font-size:11px; background:#e3f2fd; color:#1976d2; padding:3px 8px; border-radius:4px;">ü§ù ${order.partner || order.referredBy}</span></div>` : ''}
      </div>
    </div>
  `;
  
  return card;
}

// ===== –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ =====
let currentEditOrderId = null;

async function openEditOrderModal(orderId) {
  currentEditOrderId = orderId;
  const modal = document.getElementById('editOrderModal');
  modal.style.display = 'flex';
  lockPageScroll();

  document.getElementById('editOrderModalInfo').textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';
  document.getElementById('editOrderName').value = '';
  document.getElementById('editOrderPhone').value = '';
  document.getElementById('editOrderAddress').value = '';
  document.getElementById('editOrderDriverName').value = '';
  document.getElementById('editOrderDriverPhone').value = '';
  document.getElementById('editOrderReferredBy').value = '';

  try {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    if (!orderDoc.exists) {
      throw new Error('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    const order = orderDoc.data() || {};
    const date = new Date(order.timestamp || Date.now());
    const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    document.getElementById('editOrderModalInfo').textContent = `üìÖ ${dateStr}`;

    document.getElementById('editOrderName').value = order.name || '';
    document.getElementById('editOrderPhone').value = order.phone || '';
    document.getElementById('editOrderAddress').value = order.address || '';
    document.getElementById('editOrderDriverName').value = order.driverName || '';
    document.getElementById('editOrderDriverPhone').value = order.driverPhone || '';
    document.getElementById('editOrderReferredBy').value = order.referredBy || order.partner || '';
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
    Swal.fire('–û—à–∏–±–∫–∞', error && error.message ? error.message : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑', 'error');
    closeEditOrderModal();
  }
}

function closeEditOrderModal() {
  const modal = document.getElementById('editOrderModal');
  modal.style.display = 'none';
  unlockPageScroll();
  currentEditOrderId = null;
}

async function saveEditOrder() {
  if (!currentEditOrderId) return;

  const name = (document.getElementById('editOrderName').value || '').trim();
  const phone = (document.getElementById('editOrderPhone').value || '').trim();
  const address = (document.getElementById('editOrderAddress').value || '').trim();
  const driverName = (document.getElementById('editOrderDriverName').value || '').trim();
  const driverPhone = (document.getElementById('editOrderDriverPhone').value || '').trim();
  const referredBy = (document.getElementById('editOrderReferredBy').value || '').trim();

  try {
    await db.collection('orders').doc(currentEditOrderId).update({
      name,
      phone,
      address,
      driverName,
      driverPhone,
      referredBy
    });

    if (Array.isArray(ordersManagementAllOrders)) {
      const order = ordersManagementAllOrders.find(o => o.id === currentEditOrderId);
      if (order) {
        order.name = name;
        order.phone = phone;
        order.address = address;
        order.driverName = driverName;
        order.driverPhone = driverPhone;
        order.referredBy = referredBy;
      }
    }

    Swal.fire({
      icon: 'success',
      title: '–ó–∞–∫–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω',
      timer: 1400,
      showConfirmButton: false
    });

    closeEditOrderModal();
    renderOrdersManagementFromCache();
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è', 'error');
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
async function updateOrderStatus(orderId, newStatus) {
  try {
    await db.collection('orders').doc(orderId).update({ 
      status: newStatus,
      statusUpdatedAt: Date.now()
    });
    
    if (Array.isArray(ordersManagementAllOrders)) {
      const order = ordersManagementAllOrders.find(o => o.id === orderId);
      if (order) {
        order.status = newStatus;
        order.statusUpdatedAt = Date.now();
      }
    }
    
    const statusTexts = {
      pending: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
      preparing: '–ì–æ—Ç–æ–≤–∏—Ç—Å—è',
      logistics: '–ù–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–µ',
      driver: '–£ –≤–æ–¥–∏—Ç–µ–ª—è',
      completed: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
      cancelled: '–û—Ç–º–µ–Ω–µ–Ω'
    };
    
    Swal.fire({
      icon: 'success',
      title: '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!',
      text: `–ó–∞–∫–∞–∑ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Å—Ç–∞—Ç—É—Å: ${statusTexts[newStatus]}`,
      timer: 1500,
      showConfirmButton: false
    });
    
    renderOrdersManagementFromCache();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞', 'error');
    renderOrdersManagementFromCache();
  }
}

// –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑
async function deleteOrder(orderId) {
  console.log('deleteOrder –≤—ã–∑–≤–∞–Ω–∞, orderId:', orderId);
  
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?',
    html: '–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤–µ—Å—å –∑–∞–∫–∞–∑?<br><small style="color:#dc3545;">‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</small>',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'üóëÔ∏è –î–∞, —É–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç Swal:', result);
  
  if (!result.isConfirmed) return;
  
  try {
    await db.collection('orders').doc(orderId).delete();
    
    if (Array.isArray(ordersManagementAllOrders)) {
      const index = ordersManagementAllOrders.findIndex(o => o.id === orderId);
      if (index !== -1) {
        ordersManagementAllOrders.splice(index, 1);
      }
    }
    
    Swal.fire({
      icon: 'success',
      title: '–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω!',
      timer: 1500,
      showConfirmButton: false
    });
    
    renderOrdersManagementFromCache();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑', 'error');
  }
}

// ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –¢–û–í–ê–†–û–í –ó–ê–ö–ê–ó–ê =====

function buildOrderItemsDetailTableHTML(orderId, items) {
  let html = '<div class="order-items-cards">';

  items.forEach((item, idx) => {
    const itemTotal = (item.price || 0) * (item.qty || 0);
    const itemPhoto = item.image || item.photo || '';
    
    html += `
      <div class="order-item-card" style="padding:10px; display:flex; gap:10px; align-items:flex-start;">
        ${itemPhoto ? `<img src="${itemPhoto}" style="width:50px; height:50px; object-fit:cover; border-radius:6px; flex-shrink:0;">` : '<div style="width:50px; height:50px; background:#f0f0f0; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:20px; flex-shrink:0;">üì¶</div>'}
        <div style="flex:1; min-width:0;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; gap:8px;">
            <div style="font-weight:600; font-size:14px; color:#333; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.title || '–¢–æ–≤–∞—Ä'}</div>
            <button onclick="deleteOrderItemFromModal('${orderId}', ${idx})" style="padding:4px 8px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px; flex-shrink:0;">
              üóëÔ∏è
            </button>
          </div>
          ${item.variantName ? `<div style="font-size:11px; color:#7b1fa2; background:#f3e5f5; padding:2px 6px; border-radius:4px; margin-bottom:6px; display:inline-block;">üé® ${item.variantName}</div>` : ''}
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
            <input type="number"
              id="itemQty_${orderId}_${idx}"
              value="${item.qty}"
              min="0"
              oninput="updateOrderItemQtyManagement('${orderId}', ${idx}, this.value)"
              style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:13px;">
            <span style="color:#666; font-size:12px;" data-price="${item.price}">√ó ${item.price}</span>
            <div style="margin-left:auto; font-weight:700; color:#007bff; font-size:15px;" id="itemSum_${orderId}_${idx}">${itemTotal.toFixed(0)} —Å–æ–º</div>
          </div>
        </div>
      </div>
    `;
  });

  html += '</div>';
  return html;
}

async function openOrderItemsDetailModal(orderId, clientName, clientPhone, dateStr) {
  const modal = document.getElementById('orderItemsDetailModal');
  modal.style.display = 'flex';
  lockPageScroll();
  
  document.getElementById('orderItemsDetailTitle').textContent = `üì¶ –¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ`;
  document.getElementById('orderItemsDetailInfo').textContent = `üë§ ${clientName} ${clientPhone ? '(' + clientPhone + ')' : ''} ‚Ä¢ üìÖ ${dateStr}`;
  
  const contentDiv = document.getElementById('orderItemsDetailContent');
  contentDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>';
  
  try {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    
    if (!orderDoc.exists) {
      contentDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
      return;
    }
    
    const orderData = orderDoc.data();
    let items = orderData.items || [];
    
    if (items.length === 0) {
      contentDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">üì≠ –í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>';
      return;
    }
    
    // –ü–æ–¥–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ image
    const itemsWithoutPhoto = items.filter(i => !i.image && !i.photo && i.id);
    if (itemsWithoutPhoto.length > 0) {
      const productIds = [...new Set(itemsWithoutPhoto.map(i => i.id))];
      const photoMap = {};
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
      const productPromises = productIds.map(pid => 
        db.collection('products').doc(pid).get().then(doc => {
          if (doc.exists) {
            const data = doc.data();
            photoMap[pid] = data.image || data.photo || '';
          }
        }).catch(() => {})
      );
      await Promise.all(productPromises);
      
      // –ü—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –≤ items
      items = items.map(item => {
        if (!item.image && !item.photo && item.id && photoMap[item.id]) {
          return { ...item, image: photoMap[item.id] };
        }
        return item;
      });
    }
    
    const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
    
    contentDiv.innerHTML = '';
    
    const tableDiv = document.createElement('div');
    tableDiv.className = 'order-items-detail-box';
    tableDiv.style.cssText = 'background:white; border-radius:8px; overflow:hidden; box-shadow:0 2px 4px rgba(0,0,0,0.1);';
    tableDiv.innerHTML = buildOrderItemsDetailTableHTML(orderId, items);
    contentDiv.appendChild(tableDiv);

    const totalDiv = document.createElement('div');
    totalDiv.id = 'orderItemsDetailTotal';
    totalDiv.style.cssText = 'margin-top:12px; background:#f8f9fa; border:1px solid #e0e0e0; border-radius:10px; padding:12px 14px; display:flex; justify-content:space-between; align-items:center; gap:12px;';
    totalDiv.innerHTML = `
      <div style="font-weight:700; color:#333;">–ò—Ç–æ–≥–æ</div>
      <div style="font-size:18px; font-weight:800; color:#28a745; white-space:nowrap;">${total.toFixed(2)} —Å–æ–º</div>
    `;
    contentDiv.appendChild(totalDiv);
    
    const addBtn = document.getElementById('orderItemsAddBtn');
    addBtn.onclick = () => {
      closeOrderItemsDetailModal();
      openAddItemToOrderModal(orderId);
    };
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
    contentDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</div>';
  }
}

function closeOrderItemsDetailModal() {
  document.getElementById('orderItemsDetailModal').style.display = 'none';
  unlockPageScroll();
}

// –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∑–∞–∫–∞–∑–µ
// –î–µ–±–∞—É–Ω—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
let updateQtyTimeout = null;

async function updateOrderItemQtyManagement(orderId, itemIndex, newQty) {
  const qty = parseInt(newQty) || 0;
  
  // –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI
  const cardEl = document.getElementById(`itemQty_${orderId}_${itemIndex}`)?.closest('.order-item-card');
  if (cardEl) {
    const priceEl = cardEl.querySelector('[data-price]');
    const sumEl = document.getElementById(`itemSum_${orderId}_${itemIndex}`);
    
    if (priceEl && sumEl) {
      const price = parseInt(priceEl.dataset.price) || 0;
      const itemTotal = price * qty;
      sumEl.textContent = itemTotal + ' —Å–æ–º';
    }
    
    // –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–π –∏—Ç–æ–≥
    let grandTotal = 0;
    const allSumEls = document.querySelectorAll('[id^="itemSum_"]');
    allSumEls.forEach(el => {
      const match = el.textContent.match(/(\d+)/);
      if (match) grandTotal += parseInt(match[1]);
    });
    
    const totalDiv = document.getElementById('orderItemsDetailTotal');
    if (totalDiv) {
      totalDiv.innerHTML = `
        <div style="font-weight:700; color:#333;">–ò—Ç–æ–≥–æ</div>
        <div style="font-size:18px; font-weight:800; color:#28a745; white-space:nowrap;">${grandTotal} —Å–æ–º</div>
      `;
    }
  }
  
  // –î–µ–±–∞—É–Ω—Å: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–∞—É–∑—ã –≤ –≤–≤–æ–¥–µ
  clearTimeout(updateQtyTimeout);
  updateQtyTimeout = setTimeout(async () => {
    try {
      const orderDoc = await db.collection('orders').doc(orderId).get();
      if (!orderDoc.exists) return;
      
      const orderData = orderDoc.data();
      const items = orderData.items || [];
      
      if (items[itemIndex]) {
        items[itemIndex].qty = qty;
      }
      
      const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
      
      await db.collection('orders').doc(orderId).update({ items, total });
      
      if (Array.isArray(ordersManagementAllOrders)) {
        const order = ordersManagementAllOrders.find(o => o.id === orderId);
        if (order) {
          order.items = items;
          order.total = total;
        }
      }
      
      renderOrdersManagementFromCache();
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞:', error);
    }
  }, 500);
}

// –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
async function deleteOrderItemFromModal(orderId, itemIndex) {
  const result = await Swal.fire({
    title: '–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?',
    text: '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –∑–∞–∫–∞–∑–∞?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    cancelButtonColor: '#6c757d',
    confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞'
  });
  
  if (!result.isConfirmed) return;
  
  try {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    if (!orderDoc.exists) {
      throw new Error('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    items.splice(itemIndex, 1);
    
    if (items.length === 0) {
      await Swal.fire({
        title: '–ó–∞–∫–∞–∑ –ø—É—Å—Ç',
        text: '–í –∑–∞–∫–∞–∑–µ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Ç–æ–≤–∞—Ä–æ–≤. –ó–∞–∫–∞–∑ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω.',
        icon: 'warning',
        confirmButtonText: '–ü–æ–Ω—è—Ç–Ω–æ'
      });
      await db.collection('orders').doc(orderId).delete();
      
      if (Array.isArray(ordersManagementAllOrders)) {
        const idx = ordersManagementAllOrders.findIndex(o => o.id === orderId);
        if (idx !== -1) ordersManagementAllOrders.splice(idx, 1);
      }
      
      closeOrderItemsDetailModal();
      renderOrdersManagementFromCache();
    } else {
      const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
      await db.collection('orders').doc(orderId).update({ items, total });
      
      if (Array.isArray(ordersManagementAllOrders)) {
        const order = ordersManagementAllOrders.find(o => o.id === orderId);
        if (order) {
          order.items = items;
          order.total = total;
        }
      }
      
      Swal.fire({
        icon: 'success',
        title: '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω',
        timer: 1500,
        showConfirmButton: false
      });
      
      const clientName = document.getElementById('orderItemsDetailInfo').textContent.split('üë§')[1].split('‚Ä¢')[0].trim();
      const dateStr = document.getElementById('orderItemsDetailInfo').textContent.split('üìÖ')[1].trim();
      await openOrderItemsDetailModal(orderId, clientName, '', dateStr);
    }
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', error);
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
  }
}

// ===== –û–ë–™–ï–î–ò–ù–ï–ù–ò–ï –ó–ê–ö–ê–ó–û–í =====

async function openMergeOrdersModal() {
  console.log('openMergeOrdersModal –≤—ã–∑–≤–∞–Ω–∞');
  console.log('ordersManagementAllOrders:', ordersManagementAllOrders);
  
  if (!Array.isArray(ordersManagementAllOrders) || ordersManagementAllOrders.length < 2) {
    Swal.fire({
      icon: 'info',
      title: '–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è',
      text: '–î–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∑–∞–∫–∞–∑–∞',
      confirmButtonText: '–ü–æ–Ω—è—Ç–Ω–æ'
    });
    return;
  }

  const groups = {};
  
  ordersManagementAllOrders.forEach(order => {
    const name = (order.name || '').toLowerCase().trim();
    const phone = (order.phone || '').replace(/\D/g, '').trim();
    const orderDate = new Date(order.timestamp || Date.now());
    const dateKey = orderDate.toLocaleDateString('ru-RU');
    const groupKey = `${name}|${phone}|${dateKey}`;
    
    if (!groups[groupKey]) {
      groups[groupKey] = {
        name: order.name || '–ë–µ–∑ –∏–º–µ–Ω–∏',
        phone: order.phone || '',
        date: dateKey,
        orders: []
      };
    }
    groups[groupKey].orders.push(order);
  });

  console.log('–í—Å–µ –≥—Ä—É–ø–ø—ã:', groups);
  console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–ø–ø:', Object.keys(groups).length);

  const mergeableGroups = Object.values(groups).filter(g => g.orders.length >= 2);
  
  console.log('–ì—Ä—É–ø–ø—ã –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è (>=2 –∑–∞–∫–∞–∑–æ–≤):', mergeableGroups);
  console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–ø–ø –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è:', mergeableGroups.length);

  if (mergeableGroups.length === 0) {
    Swal.fire({
      icon: 'info',
      title: '–ù–µ—á–µ–≥–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å',
      text: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∑–∞–∫–∞–∑–∞–º–∏ –∑–∞ –æ–¥–∏–Ω –¥–µ–Ω—å',
      confirmButtonText: '–ü–æ–Ω—è—Ç–Ω–æ'
    });
    return;
  }

  let html = '<div style="max-height:400px; overflow-y:auto;">';
  
  mergeableGroups.forEach((group, idx) => {
    const totalOrders = group.orders.length;
    const totalItems = group.orders.reduce((sum, o) => sum + (o.items || []).reduce((s, i) => s + i.qty, 0), 0);
    const totalSum = group.orders.reduce((sum, o) => sum + (o.items || []).reduce((s, i) => s + (i.price * i.qty), 0), 0);
    const orderIdsStr = group.orders.map(o => o.id).join(',');
    
    html += `
      <div style="background:#f8f9fa; border:2px solid #9c27b0; border-radius:10px; padding:15px; margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <div>
            <div style="font-weight:700; font-size:16px; color:#333;">üë§ ${group.name}</div>
            <div style="color:#666;">üìû ${group.phone || '–ë–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–∞'}</div>
            <div style="font-size:13px; color:#888;">üìÖ ${group.date}</div>
            <div style="margin-top:8px;">
              <span style="background:#9c27b0; color:white; padding:3px 8px; border-radius:4px;">${totalOrders} –∑–∞–∫–∞–∑–∞</span>
              <span style="background:#007bff; color:white; padding:3px 8px; border-radius:4px; margin-left:5px;">${totalItems} —à—Ç</span>
              <span style="background:#28a745; color:white; padding:3px 8px; border-radius:4px; margin-left:5px;">${totalSum.toFixed(0)} —Å–æ–º</span>
            </div>
          </div>
          <button class="merge-btn" data-ids="${orderIdsStr}" style="padding:10px 20px; background:linear-gradient(90deg, #9c27b0, #673ab7); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:700;">
            üîó –û–±—ä–µ–¥–∏–Ω–∏—Ç—å
          </button>
        </div>
      </div>
    `;
  });
  
  html += '</div>';

  console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –≥—Ä—É–ø–ø–∞–º–∏:', mergeableGroups.length);
  console.log('HTML –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', html);
  
  Swal.fire({
    title: 'üîó –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤',
    html: html,
    width: 600,
    showConfirmButton: false,
    showCloseButton: true,
    backdrop: true,
    customClass: {
      container: 'swal-merge-container'
    },
    didOpen: () => {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º z-index –≤—ã—à–µ ordersManagementWindow (9650)
      const swalContainer = document.querySelector('.swal-merge-container');
      if (swalContainer) {
        swalContainer.style.zIndex = '99999';
      }
      
      console.log('didOpen –≤—ã–∑–≤–∞–Ω');
      const buttons = document.querySelectorAll('.merge-btn');
      console.log('–ù–∞–π–¥–µ–Ω–æ –∫–Ω–æ–ø–æ–∫ .merge-btn:', buttons.length);
      
      buttons.forEach((btn, index) => {
        console.log('–ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –∫–Ω–æ–ø–∫–µ', index, 'ids:', btn.dataset.ids);
        btn.addEventListener('click', function() {
          const ids = this.dataset.ids;
          console.log('–ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è, ids:', ids);
          Swal.close();
          setTimeout(() => mergeClientOrders(ids), 150);
        });
      });
    }
  });
}

async function mergeClientOrders(orderIds) {
  console.log('mergeClientOrders –≤—ã–∑–≤–∞–Ω–∞ —Å ids:', orderIds);
  const ids = orderIds.split(',');
  
  if (ids.length < 2) {
    Swal.fire({
      icon: 'error',
      title: '–û—à–∏–±–∫–∞',
      text: '–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è',
      customClass: { container: 'swal-high-zindex' },
      didOpen: () => { document.querySelector('.swal-high-zindex').style.zIndex = '99999'; }
    });
    return;
  }

  const result = await Swal.fire({
    title: '–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∑–∞–∫–∞–∑—ã?',
    html: `<p>–í—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ ${ids.length} –∑–∞–∫–∞–∑–æ–≤ –±—É–¥—É—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ –æ–¥–∏–Ω.</p>
           <p style="color:#dc3545; font-size:13px;">‚ö†Ô∏è –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫–∞–∑—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.</p>`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#9c27b0',
    cancelButtonColor: '#6c757d',
    confirmButtonText: 'üîó –î–∞, –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞',
    customClass: { container: 'swal-high-zindex' },
    didOpen: () => { document.querySelector('.swal-high-zindex').style.zIndex = '99999'; }
  });

  console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:', result);

  if (!result.isConfirmed) return;

  try {
    Swal.fire({
      title: '–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ...',
      text: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ',
      allowOutsideClick: false,
      customClass: { container: 'swal-high-zindex' },
      didOpen: () => { 
        document.querySelector('.swal-high-zindex').style.zIndex = '99999';
        Swal.showLoading(); 
      }
    });

    const orders = [];
    for (const id of ids) {
      const doc = await db.collection('orders').doc(id).get();
      if (doc.exists) {
        orders.push({ id: doc.id, ...doc.data() });
      }
    }

    if (orders.length < 2) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã');
    }

    orders.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
    const mainOrder = orders[0];
    const otherOrders = orders.slice(1);

    let mergedItems = [...(mainOrder.items || [])];
    
    for (const order of otherOrders) {
      const orderItems = order.items || [];
      
      for (const item of orderItems) {
        const existingIndex = mergedItems.findIndex(mi => 
          mi.title === item.title && mi.price === item.price
        );
        
        if (existingIndex >= 0) {
          mergedItems[existingIndex].qty += item.qty;
        } else {
          mergedItems.push({ ...item });
        }
      }
    }

    const newTotal = mergedItems.reduce((sum, item) => sum + (item.price * item.qty), 0);

    await db.collection('orders').doc(mainOrder.id).update({
      items: mergedItems,
      total: newTotal,
      mergedFrom: otherOrders.map(o => o.id),
      mergedAt: Date.now()
    });

    for (const order of otherOrders) {
      await db.collection('orders').doc(order.id).delete();
    }

    Swal.fire({
      icon: 'success',
      title: '–ó–∞–∫–∞–∑—ã –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã!',
      html: `<p>–û–±—ä–µ–¥–∏–Ω–µ–Ω–æ ${orders.length} –∑–∞–∫–∞–∑–æ–≤ –≤ –æ–¥–∏–Ω.</p>
             <p>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: <strong>${mergedItems.reduce((s, i) => s + i.qty, 0)} —à—Ç</strong></p>
             <p>–û–±—â–∞—è —Å—É–º–º–∞: <strong>${newTotal.toFixed(0)} —Å–æ–º</strong></p>`,
      confirmButtonText: '–û—Ç–ª–∏—á–Ω–æ!',
      customClass: { container: 'swal-high-zindex' },
      didOpen: () => { document.querySelector('.swal-high-zindex').style.zIndex = '99999'; }
    });

    await loadOrdersManagement(true);

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤:', error);
    Swal.fire({
      icon: 'error',
      title: '–û—à–∏–±–∫–∞',
      text: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∑–∞–∫–∞–∑—ã: ' + (error.message || ''),
      customClass: { container: 'swal-high-zindex' },
      didOpen: () => { document.querySelector('.swal-high-zindex').style.zIndex = '99999'; }
    });
  }
}

// ===== –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–û–í–ê–†–ê –í –ó–ê–ö–ê–ó =====

let currentOrderIdForAddItem = null;
let productsToAddCardsCache = null;
let productsToAddLastQuery = '';
let productsToAddFilterDebounceTimer = null;
let _productsToAddComposing = false;

function scheduleFilterProductsToAdd() {
  if (_productsToAddComposing) return;
  clearTimeout(productsToAddFilterDebounceTimer);
  productsToAddFilterDebounceTimer = setTimeout(() => {
    filterProductsToAdd();
  }, _isIOS ? 350 : 120);
}

async function openAddItemToOrderModal(orderId) {
  currentOrderIdForAddItem = orderId;
  document.getElementById('addItemToOrderModal').style.display = 'flex';
  lockPageScroll();
  
  await loadProductsToAdd();
}

function closeAddItemToOrderModal() {
  document.getElementById('addItemToOrderModal').style.display = 'none';
  unlockPageScroll();
  currentOrderIdForAddItem = null;
  document.getElementById('searchProductToAdd').value = '';
  productsToAddLastQuery = '';
}

async function loadProductsToAdd() {
  const listDiv = document.getElementById('productsToAddList');
  listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>';
  
  try {
    const productsSnapshot = await db.collection('products').get();
    
    if (productsSnapshot.empty) {
      listDiv.innerHTML = '<div style="text-align:center; color:#999; padding:40px;">üì≠ –¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç</div>';
      return;
    }
    
    listDiv.innerHTML = '';
    productsToAddCardsCache = null;
    
    productsSnapshot.forEach(doc => {
      const product = doc.data();
      const productCard = document.createElement('div');
      productCard.className = 'product-to-add-card';
      productCard.dataset.title = (product.title || product.name || '').toLowerCase();
      productCard.style.cssText = 'background:white; border:1px solid #e0e0e0; border-radius:8px; padding:12px; margin-bottom:10px; cursor:pointer; transition:all 0.2s;';
      
      const productName = product.title || product.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const productPrice = product.price || 0;
      const productCostPrice = product.costPrice || 0;
      const productPhoto = product.image || product.photo;
      
      productCard.innerHTML = `
        <div style="display:flex; gap:12px; align-items:center;">
          ${productPhoto ? `<img src="${productPhoto}" style="width:60px; height:60px; object-fit:cover; border-radius:6px;">` : '<div style="width:60px; height:60px; background:#f0f0f0; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:24px;">üì¶</div>'}
          <div style="flex:1;">
            <div style="font-weight:600; margin-bottom:4px;">${productName}</div>
            <div style="font-size:13px; color:#666;">üí∞ ${productPrice} —Å–æ–º</div>
            ${product.category ? `<div style="font-size:12px; color:#888; margin-top:2px;">üìÅ ${product.category}</div>` : ''}
          </div>
          <button onclick="askQtyAndAddProduct('${doc.id}', '${productName.replace(/'/g, "\\'")}', ${productPrice}, ${productCostPrice}, '${(productPhoto || '').replace(/'/g, "\\'")}'); event.stopPropagation();" style="padding:8px 16px; background:#17a2b8; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px; font-weight:600; white-space:nowrap;">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>
      `;
      
      productCard.onmouseenter = () => productCard.style.background = '#f8f9fa';
      productCard.onmouseleave = () => productCard.style.background = 'white';
      
      listDiv.appendChild(productCard);
    });

    productsToAddCardsCache = Array.from(listDiv.querySelectorAll('.product-to-add-card'));
    scheduleFilterProductsToAdd();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
    listDiv.innerHTML = '<div style="text-align:center; color:#dc3545; padding:40px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</div>';
  }
}

function filterProductsToAdd() {
  const inputEl = document.getElementById('searchProductToAdd');
  if (!inputEl) return;
  const searchQuery = (inputEl.value || '').toLowerCase();

  if (searchQuery === productsToAddLastQuery) return;
  productsToAddLastQuery = searchQuery;

  const cards = Array.isArray(productsToAddCardsCache)
    ? productsToAddCardsCache
    : Array.from(document.querySelectorAll('.product-to-add-card'));

  cards.forEach(card => {
    const title = card.dataset.title || '';
    const shouldShow = title.includes(searchQuery);
    const isHidden = card.style.display === 'none';
    if (shouldShow && isHidden) card.style.display = 'block';
    if (!shouldShow && !isHidden) card.style.display = 'none';
  });
}

async function addProductToOrder(productId, productName, productPrice, productCostPrice, qty = 1, productPhoto = '') {
  if (!currentOrderIdForAddItem) {
    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ –≤—ã–±—Ä–∞–Ω –∑–∞–∫–∞–∑', 'error');
    return;
  }
  
  const orderId = currentOrderIdForAddItem;
  
  // –°—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–π UI)
  closeAddItemToOrderModal();
  
  Swal.fire({
    icon: 'success',
    title: '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!',
    text: `${productName} x${qty} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞–∫–∞–∑`,
    timer: 1200,
    showConfirmButton: false
  });
  
  // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ —Ñ–æ–Ω–µ
  try {
    const orderDoc = await db.collection('orders').doc(orderId).get();
    
    if (!orderDoc.exists) {
      console.error('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }
    
    const orderData = orderDoc.data();
    const items = orderData.items || [];
    
    const existingItemIndex = items.findIndex(item => item.id === productId);
    
    if (existingItemIndex !== -1) {
      items[existingItemIndex].qty += qty;
    } else {
      const newItem = {
        id: productId,
        title: productName,
        price: productPrice,
        costPrice: productCostPrice,
        qty: qty
      };
      if (productPhoto) {
        newItem.image = productPhoto;
      }
      items.push(newItem);
    }
    
    const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
    
    await db.collection('orders').doc(orderId).update({
      items,
      total
    });
    
    if (Array.isArray(ordersManagementAllOrders)) {
      const order = ordersManagementAllOrders.find(o => o.id === orderId);
      if (order) {
        order.items = items;
        order.total = total;
      }
    }
    
    renderOrdersManagementFromCache();
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', error);
  }
}

// –°–ø—Ä–æ—Å–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
async function askQtyAndAddProduct(productId, productName, productPrice, productCostPrice, productPhoto) {
  const { value: qty } = await Swal.fire({
    title: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
    text: productName,
    input: 'number',
    inputValue: 1,
    inputAttributes: {
      min: 1,
      max: 1000,
      step: 1
    },
    showCancelButton: true,
    confirmButtonText: '–î–æ–±–∞–≤–∏—Ç—å',
    cancelButtonText: '–û—Ç–º–µ–Ω–∞',
    confirmButtonColor: '#17a2b8',
    inputValidator: (value) => {
      if (!value || value < 1) {
        return '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ';
      }
    }
  });
  
  if (qty) {
    addProductToOrder(productId, productName, productPrice, productCostPrice, parseInt(qty), productPhoto);
  }
}

// ===== –≠–ö–°–ü–û–†–¢ –ó–ê–ö–ê–ó–ê –í TELEGRAM (3 —Ñ–∞–π–ª–∞: Excel + 2 PDF —á–µ—Ä–µ–∑ Canvas) =====
// –ö–æ–ø–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –∏–∑ orders.js —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞—á/—à—Ç –∏ –∫–æ—Ä–æ–±–æ–∫

async function exportOrderToExcel(orderId, clientName, clientPhone) {
  console.log('exportOrderToExcel –≤—ã–∑–≤–∞–Ω–∞, orderId:', orderId);
  
  Swal.fire({
    title: '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–∫–∞–∑–∞...',
    html: '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...',
    allowOutsideClick: false,
    allowEscapeKey: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });
  
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑
    const orderDoc = await db.collection('orders').doc(orderId).get();
    
    if (!orderDoc.exists) {
      throw new Error('–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
    
    const order = orderDoc.data();
    const items = order.items || [];
    
    if (items.length === 0) {
      Swal.fire('–û—à–∏–±–∫–∞', '–í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤', 'error');
      return;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ –∏ –¥–∞–Ω–Ω—ã—Ö
    Swal.update({ html: '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤...' });
    const productsSnapshot = await db.collection('products').get();
    const productsMap = {};
    productsSnapshot.forEach(doc => {
      productsMap[doc.id] = { id: doc.id, ...doc.data() };
    });
    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤:', Object.keys(productsMap).length);
    
    const date = new Date(order.timestamp || Date.now());
    const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
    
    let totalAmount = 0;
    items.forEach(item => {
      totalAmount += item.price * item.qty;
    });
    
    const address = order.address || '–ù–µ —É–∫–∞–∑–∞–Ω';
    const driverName = order.driverName || '';
    const driverPhone = order.driverPhone || '';
    const hasDriver = driverName || driverPhone;
    
    // ===== 1. –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª =====
    Swal.update({ html: '–°–æ–∑–¥–∞–Ω–∏–µ Excel —Ñ–∞–π–ª–∞ (1/3)' });
    
    const excelData = [
      ['–ó–ê–ö–ê–ó –ö–õ–ò–ï–ù–¢–ê'],
      [''],
      ['–ö–ª–∏–µ–Ω—Ç:', clientName],
      ['–¢–µ–ª–µ—Ñ–æ–Ω:', clientPhone],
      ['–ê–¥—Ä–µ—Å:', address],
      ['–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞:', dateStr]
    ];
    
    if (hasDriver) {
      excelData.push(['–í–æ–¥–∏—Ç–µ–ª—å:', driverName || '-']);
      excelData.push(['–¢–µ–ª. –≤–æ–¥–∏—Ç–µ–ª—è:', driverPhone || '-']);
    }
    
    excelData.push(['']);
    excelData.push(['–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', '–ö–æ–ª-–≤–æ –∫–æ—Ä–æ–±–æ–∫', '–ï–¥. –≤ –∫–æ—Ä–æ–±–∫–µ', '–í—Å–µ–≥–æ', '–¶–µ–Ω–∞', '–°—É–º–º–∞']);
    
    items.forEach(item => {
      const product = productsMap[item.id] || productsMap[item.productId] || {};
      const isPack = item.isPack || product.isPack || false;
      const unitLabel = isPack ? '–ø–∞—á' : '—à—Ç';
      const unitsPerBox = item.unitsPerBox || product.unitsPerBox || 72;
      
      const boxCount = Math.floor(item.qty / unitsPerBox);
      const remainingUnits = item.qty % unitsPerBox;
      
      let boxText = '';
      if (boxCount > 0 && remainingUnits === 0) {
        boxText = `${boxCount} –∫–æ—Ä`;
      } else if (boxCount > 0 && remainingUnits > 0) {
        boxText = `${boxCount} –∫–æ—Ä + ${remainingUnits} ${unitLabel}`;
      } else {
        boxText = `${item.qty} ${unitLabel}`;
      }
      
      const titleWithVariant = item.variantName ? `${item.title} [${item.variantName}]` : (item.title || '–¢–æ–≤–∞—Ä');
      
      excelData.push([
        titleWithVariant,
        boxText,
        `${unitsPerBox} ${unitLabel}`,
        `${item.qty} ${unitLabel}`,
        `${item.price} —Å–æ–º`,
        `${item.qty * item.price} —Å–æ–º`
      ]);
    });
    
    excelData.push(['']);
    excelData.push(['–ò–¢–û–ì–û:', '', '', '', '', `${totalAmount} —Å–æ–º`]);
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    ws['!cols'] = [{ wch: 30 }, { wch: 18 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }];
    XLSX.utils.book_append_sheet(wb, ws, '–ó–∞–∫–∞–∑');
    
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const excelBlob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    
    // ===== 2. –°–æ–∑–¥–∞–µ–º PDF #1 (–ó–∞–∫–∞–∑ –¥–ª—è –ø–µ—á–∞—Ç–∏ –ë–ï–ó –§–û–¢–û) =====
    Swal.update({ html: '–°–æ–∑–¥–∞–Ω–∏–µ PDF –¥–ª—è –ø–µ—á–∞—Ç–∏ (2/3)' });
    
    const { jsPDF } = window.jspdf;
    const doc1 = new jsPDF();
    const scale = 1.5;
    let yPosition = 2;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const headerCanvas = document.createElement('canvas');
    const headerCtx = headerCanvas.getContext('2d');
    headerCanvas.width = 600 * scale;
    headerCanvas.height = 50 * scale;
    headerCtx.scale(scale, scale);
    
    headerCtx.fillStyle = 'white';
    headerCtx.fillRect(0, 0, 600, 50);
    headerCtx.fillStyle = 'black';
    headerCtx.font = 'bold 24px Arial';
    headerCtx.textAlign = 'center';
    headerCtx.fillText('–ó–ê–ö–ê–ó (–¥–ª—è –ø–µ—á–∞—Ç–∏)', 300, 35);
    
    const headerImage = headerCanvas.toDataURL('image/png');
    doc1.addImage(headerImage, 'PNG', 20, yPosition, 170, 10);
    yPosition += 11;
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ –≤ —Ä–∞–º–∫–µ
    const infoHeight = hasDriver ? 170 : 120;
    const infoCanvas = document.createElement('canvas');
    const infoCtx = infoCanvas.getContext('2d');
    infoCanvas.width = 700 * scale;
    infoCanvas.height = infoHeight * scale;
    infoCtx.scale(scale, scale);
    
    infoCtx.fillStyle = 'white';
    infoCtx.fillRect(0, 0, 700, infoHeight);
    infoCtx.strokeStyle = 'black';
    infoCtx.lineWidth = 2;
    infoCtx.strokeRect(0, 0, 700, infoHeight);
    
    infoCtx.fillStyle = 'black';
    infoCtx.font = '16px Arial';
    infoCtx.fillText(`–î–∞—Ç–∞/–í—Ä–µ–º—è: ${dateStr}`, 15, 30);
    infoCtx.fillText(`–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞: ${clientName}`, 15, 55);
    infoCtx.fillText(`–¢–µ–ª–µ—Ñ–æ–Ω: ${clientPhone}`, 15, 80);
    infoCtx.fillText(`–ê–¥—Ä–µ—Å: ${address}`, 15, 105);
    
    if (hasDriver) {
      infoCtx.fillText(`–í–æ–¥–∏—Ç–µ–ª—å: ${driverName || '-'}`, 15, 130);
      infoCtx.fillText(`–¢–µ–ª. –≤–æ–¥–∏—Ç–µ–ª—è: ${driverPhone || '-'}`, 15, 155);
    }
    
    const infoImage = infoCanvas.toDataURL('image/png');
    const infoImageHeight = hasDriver ? 38 : 28;
    doc1.addImage(infoImage, 'PNG', 20, yPosition, 170, infoImageHeight);
    yPosition += infoImageHeight + 1;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –ë–ï–ó –∫–æ–ª–æ–Ω–∫–∏ —Ñ–æ—Ç–æ
    const tableHeaderCanvas = document.createElement('canvas');
    const thCtx = tableHeaderCanvas.getContext('2d');
    tableHeaderCanvas.width = 600 * scale;
    tableHeaderCanvas.height = 40 * scale;
    thCtx.scale(scale, scale);
    
    thCtx.fillStyle = '#e0e0e0';
    thCtx.fillRect(0, 0, 600, 40);
    thCtx.strokeStyle = 'black';
    thCtx.lineWidth = 2;
    thCtx.strokeRect(0, 0, 600, 40);
    
    thCtx.beginPath();
    thCtx.moveTo(300, 0); thCtx.lineTo(300, 40);
    thCtx.moveTo(400, 0); thCtx.lineTo(400, 40);
    thCtx.moveTo(500, 0); thCtx.lineTo(500, 40);
    thCtx.stroke();
    
    thCtx.fillStyle = 'black';
    thCtx.font = 'bold 12px Arial';
    thCtx.textAlign = 'center';
    thCtx.fillText('–ù–ê–ó–í–ê–ù–ò–ï', 150, 25);
    thCtx.fillText('–ö–û–õ-–í–û', 350, 25);
    thCtx.fillText('–¶–ï–ù–ê', 450, 25);
    thCtx.fillText('–°–£–ú–ú–ê', 550, 25);
    
    const tableHeaderImage = tableHeaderCanvas.toDataURL('image/png');
    doc1.addImage(tableHeaderImage, 'PNG', 20, yPosition, 170, 10);
    yPosition += 10;
    
    // –¢–æ–≤–∞—Ä—ã –ë–ï–ó –§–û–¢–û
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      
      if (yPosition > 265) {
        doc1.addPage();
        yPosition = 15;
      }
      
      const product = productsMap[item.id] || productsMap[item.productId] || {};
      const isPack = item.isPack || product.isPack || false;
      const unitLabel = isPack ? '–ø–∞—á' : '—à—Ç';
      const unitsPerBox = item.unitsPerBox || product.unitsPerBox || 72;
      
      const boxCount = Math.floor(item.qty / unitsPerBox);
      const remainingUnits = item.qty % unitsPerBox;
      
      let boxText = '';
      if (boxCount > 0 && remainingUnits === 0) {
        boxText = `${boxCount} –∫–æ—Ä`;
      } else if (boxCount > 0 && remainingUnits > 0) {
        boxText = `${boxCount} –∫–æ—Ä +${remainingUnits}`;
      } else {
        boxText = `${item.qty} ${unitLabel}`;
      }
      
      const titleWithVariant = item.variantName ? `${item.title} [${item.variantName}]` : (item.title || '–¢–æ–≤–∞—Ä');
      
      const rowCanvas = document.createElement('canvas');
      const rowCtx = rowCanvas.getContext('2d');
      rowCanvas.width = 600 * scale;
      rowCanvas.height = 35 * scale;
      rowCtx.scale(scale, scale);
      
      rowCtx.fillStyle = i % 2 === 0 ? 'white' : '#f9f9f9';
      rowCtx.fillRect(0, 0, 600, 35);
      rowCtx.strokeStyle = 'black';
      rowCtx.lineWidth = 1;
      rowCtx.strokeRect(0, 0, 600, 35);
      
      rowCtx.beginPath();
      rowCtx.moveTo(300, 0); rowCtx.lineTo(300, 35);
      rowCtx.moveTo(400, 0); rowCtx.lineTo(400, 35);
      rowCtx.moveTo(500, 0); rowCtx.lineTo(500, 35);
      rowCtx.stroke();
      
      rowCtx.fillStyle = 'black';
      rowCtx.font = '11px Arial';
      rowCtx.textAlign = 'left';
      
      if (titleWithVariant.length > 40) {
        rowCtx.fillText(titleWithVariant.substring(0, 40), 5, 15);
        rowCtx.fillText(titleWithVariant.substring(40, 80), 5, 28);
      } else {
        rowCtx.fillText(titleWithVariant, 5, 22);
      }
      
      rowCtx.textAlign = 'center';
      rowCtx.fillText(boxText, 350, 22);
      rowCtx.fillText(`${item.price} —Å–æ–º`, 450, 22);
      rowCtx.font = 'bold 11px Arial';
      rowCtx.fillText(`${item.qty * item.price} —Å–æ–º`, 550, 22);
      
      const rowImage = rowCanvas.toDataURL('image/png');
      doc1.addImage(rowImage, 'PNG', 20, yPosition, 170, 9);
      yPosition += 9;
    }
    
    // –°—Ç—Ä–æ–∫–∞ –ò–¢–û–ì–û
    const totalCanvas = document.createElement('canvas');
    const totalCtx = totalCanvas.getContext('2d');
    totalCanvas.width = 800 * scale;
    totalCanvas.height = 60 * scale;
    totalCtx.scale(scale, scale);
    
    totalCtx.fillStyle = '#ffeb3b';
    totalCtx.fillRect(0, 0, 800, 60);
    totalCtx.strokeStyle = 'black';
    totalCtx.lineWidth = 4;
    totalCtx.strokeRect(0, 0, 800, 60);
    
    totalCtx.fillStyle = 'black';
    totalCtx.font = 'bold 24px Arial';
    totalCtx.textAlign = 'right';
    totalCtx.fillText(`–ò–¢–û–ì–û:  ${totalAmount} —Å–æ–º`, 780, 40);
    
    const totalImage = totalCanvas.toDataURL('image/png');
    doc1.addImage(totalImage, 'PNG', 20, yPosition, 170, 14);
    
    const pdf1Blob = doc1.output('blob');
    
    // ===== 3. –°–æ–∑–¥–∞–µ–º PDF #2 (–° –§–û–¢–û–ì–†–ê–§–ò–Ø–ú–ò –¢–û–í–ê–†–û–í) =====
    Swal.update({ html: '–°–æ–∑–¥–∞–Ω–∏–µ PDF —Å —Ñ–æ—Ç–æ (3/3)' });
    
    const doc2 = new jsPDF();
    yPosition = 20;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    const header2Canvas = document.createElement('canvas');
    const header2Ctx = header2Canvas.getContext('2d');
    header2Canvas.width = 600;
    header2Canvas.height = 50;
    
    header2Ctx.fillStyle = 'white';
    header2Ctx.fillRect(0, 0, 600, 50);
    header2Ctx.fillStyle = 'black';
    header2Ctx.font = 'bold 24px Arial';
    header2Ctx.textAlign = 'center';
    header2Ctx.fillText('–ù–û–í–´–ô –ó–ê–ö–ê–ó', 300, 35);
    
    const header2Image = header2Canvas.toDataURL('image/png');
    doc2.addImage(header2Image, 'PNG', 20, yPosition, 170, 15);
    yPosition += 20;
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ –≤ —Ä–∞–º–∫–µ
    const info2Height = hasDriver ? 170 : 120;
    const info2Canvas = document.createElement('canvas');
    const info2Ctx = info2Canvas.getContext('2d');
    info2Canvas.width = 700;
    info2Canvas.height = info2Height;
    
    info2Ctx.fillStyle = 'white';
    info2Ctx.fillRect(0, 0, 700, info2Height);
    info2Ctx.strokeStyle = 'black';
    info2Ctx.lineWidth = 2;
    info2Ctx.strokeRect(0, 0, 700, info2Height);
    
    info2Ctx.fillStyle = 'black';
    info2Ctx.font = '16px Arial';
    info2Ctx.fillText(`–î–∞—Ç–∞/–í—Ä–µ–º—è: ${dateStr}`, 15, 30);
    info2Ctx.fillText(`–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞: ${clientName}`, 15, 55);
    info2Ctx.fillText(`–¢–µ–ª–µ—Ñ–æ–Ω: ${clientPhone}`, 15, 80);
    info2Ctx.fillText(`–ê–¥—Ä–µ—Å: ${address}`, 15, 105);
    
    if (hasDriver) {
      info2Ctx.fillText(`–í–æ–¥–∏—Ç–µ–ª—å: ${driverName || '-'}`, 15, 130);
      info2Ctx.fillText(`–¢–µ–ª. –≤–æ–¥–∏—Ç–µ–ª—è: ${driverPhone || '-'}`, 15, 155);
    }
    
    const info2Image = info2Canvas.toDataURL('image/png');
    const info2ImageHeight = hasDriver ? 42 : 30;
    doc2.addImage(info2Image, 'PNG', 20, yPosition, 170, info2ImageHeight);
    yPosition += info2ImageHeight + 5;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã —Å –∫–æ–ª–æ–Ω–∫–æ–π –§–û–¢–û
    const th2Canvas = document.createElement('canvas');
    const th2Ctx = th2Canvas.getContext('2d');
    th2Canvas.width = 550;
    th2Canvas.height = 50;
    
    th2Ctx.fillStyle = '#e0e0e0';
    th2Ctx.fillRect(0, 0, 550, 50);
    th2Ctx.strokeStyle = 'black';
    th2Ctx.lineWidth = 2;
    th2Ctx.strokeRect(0, 0, 550, 50);
    
    th2Ctx.beginPath();
    th2Ctx.moveTo(70, 0); th2Ctx.lineTo(70, 50);
    th2Ctx.moveTo(270, 0); th2Ctx.lineTo(270, 50);
    th2Ctx.moveTo(410, 0); th2Ctx.lineTo(410, 50);
    th2Ctx.moveTo(480, 0); th2Ctx.lineTo(480, 50);
    th2Ctx.stroke();
    
    th2Ctx.fillStyle = 'black';
    th2Ctx.font = 'bold 14px Arial';
    th2Ctx.textAlign = 'center';
    th2Ctx.fillText('–§–û–¢–û', 35, 32);
    th2Ctx.fillText('–ù–ê–ó–í–ê–ù–ò–ï', 170, 32);
    th2Ctx.fillText('–ö–û–õ-–í–û', 340, 32);
    th2Ctx.fillText('–¶–ï–ù–ê', 445, 32);
    th2Ctx.fillText('–°–£–ú–ú–ê', 515, 32);
    
    const th2Image = th2Canvas.toDataURL('image/png');
    doc2.addImage(th2Image, 'PNG', 20, yPosition, 170, 12);
    yPosition += 12;
    
    // –¢–æ–≤–∞—Ä—ã –° –§–û–¢–û–ì–†–ê–§–ò–Ø–ú–ò
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      
      if (yPosition > 240) {
        doc2.addPage();
        yPosition = 20;
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–∞
      const product = productsMap[item.id] || productsMap[item.productId] || {};
      const isPack = item.isPack || product.isPack || false;
      const unitLabel = isPack ? '–ø–∞—á' : '—à—Ç';
      const unitsPerBox = item.unitsPerBox || product.unitsPerBox || 72;
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ—Ä–æ–±–æ–∫
      const boxCount = Math.floor(item.qty / unitsPerBox);
      const remainingUnits = item.qty % unitsPerBox;
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ—Ä–æ–±–∫–∞—Ö (–∫–æ—Ä–æ—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)
      let qtyLine1 = '';
      let qtyLine2 = '';
      if (boxCount > 0 && remainingUnits === 0) {
        qtyLine1 = `${boxCount} –∫–æ—Ä`;
        qtyLine2 = `(${unitsPerBox} ${unitLabel})`;
      } else if (boxCount > 0 && remainingUnits > 0) {
        qtyLine1 = `${boxCount} –∫–æ—Ä`;
        qtyLine2 = `+${remainingUnits} ${unitLabel}`;
      } else {
        qtyLine1 = `${item.qty} ${unitLabel}`;
        qtyLine2 = '';
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
      let photoWidth = 90;
      let photoHeight = 90;
      let photoData = null;
      
      // –ë–µ—Ä—ë–º —Ñ–æ—Ç–æ –∏–∑ item.image –∏–ª–∏ –∏–∑ productsMap
      let imageUrl = item.image || product.image;
      
      if (imageUrl && imageUrl.startsWith('http')) {
        try {
          const response = await fetch(imageUrl);
          const blob = await response.blob();
          
          const reader = new FileReader();
          const base64 = await new Promise((resolve) => {
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });
          
          photoData = base64;
          
          const img = new Image();
          await new Promise((resolve) => {
            img.onload = resolve;
            img.src = base64;
          });
          
          const maxPhotoWidth = 100;
          const maxPhotoHeight = 100;
          
          let finalWidth = img.width;
          let finalHeight = img.height;
          
          if (finalWidth > maxPhotoWidth || finalHeight > maxPhotoHeight) {
            const imgScale = Math.min(maxPhotoWidth / finalWidth, maxPhotoHeight / finalHeight);
            finalWidth = finalWidth * imgScale;
            finalHeight = finalHeight * imgScale;
          }
          
          photoWidth = finalWidth;
          photoHeight = finalHeight;
          
          console.log('‚úì –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', item.title);
        } catch (err) {
          console.error('‚úó –û—à–∏–±–∫–∞ —Ñ–æ—Ç–æ:', item.title, err);
        }
      }
      
      // –í—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ = –≤—ã—Å–æ—Ç–∞ —Ñ–æ—Ç–æ + –æ—Ç—Å—Ç—É–ø—ã
      const rowHeight = Math.max(photoHeight + 10, 100);
      const photoColumnWidth = Math.max(photoWidth + 10, 70);
      const totalWidth = photoColumnWidth + 480;
      
      const row2Canvas = document.createElement('canvas');
      const row2Ctx = row2Canvas.getContext('2d');
      row2Canvas.width = totalWidth;
      row2Canvas.height = rowHeight;
      
      row2Ctx.fillStyle = 'white';
      row2Ctx.fillRect(0, 0, totalWidth, rowHeight);
      row2Ctx.strokeStyle = 'black';
      row2Ctx.lineWidth = 2;
      row2Ctx.strokeRect(0, 0, totalWidth, rowHeight);
      
      // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
      const col2 = photoColumnWidth;
      const col3 = photoColumnWidth + 200;
      const col4 = photoColumnWidth + 340;
      const col5 = photoColumnWidth + 410;
      
      row2Ctx.beginPath();
      row2Ctx.moveTo(col2, 0); row2Ctx.lineTo(col2, rowHeight);
      row2Ctx.moveTo(col3, 0); row2Ctx.lineTo(col3, rowHeight);
      row2Ctx.moveTo(col4, 0); row2Ctx.lineTo(col4, rowHeight);
      row2Ctx.moveTo(col5, 0); row2Ctx.lineTo(col5, rowHeight);
      row2Ctx.stroke();
      
      row2Ctx.fillStyle = 'black';
      row2Ctx.font = '13px Arial';
      
      const midY = rowHeight / 2;
      
      // –ù–∞–∑–≤–∞–Ω–∏–µ (—Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω–æ–µ) + –≤–∞—Ä–∏–∞–Ω—Ç
      row2Ctx.textAlign = 'left';
      const title = item.title || '–¢–æ–≤–∞—Ä';
      const variantText = item.variantName ? ` [${item.variantName}]` : '';
      const fullTitle = title + variantText;
      
      if (fullTitle.length > 28) {
        row2Ctx.fillText(fullTitle.substring(0, 28), col2 + 5, midY - 5);
        row2Ctx.fillText(fullTitle.substring(28), col2 + 5, midY + 10);
      } else {
        row2Ctx.fillText(fullTitle, col2 + 5, midY);
      }
      
      // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–≤ –∫–æ—Ä–æ–±–∫–∞—Ö, –¥–≤–µ —Å—Ç—Ä–æ–∫–∏)
      row2Ctx.textAlign = 'center';
      row2Ctx.font = 'bold 12px Arial';
      row2Ctx.fillText(qtyLine1, (col3 + col4) / 2, midY - 5);
      if (qtyLine2) {
        row2Ctx.font = '11px Arial';
        row2Ctx.fillText(qtyLine2, (col3 + col4) / 2, midY + 10);
      }
      row2Ctx.font = '13px Arial';
      
      // –¶–µ–Ω–∞
      row2Ctx.fillText(`${item.price}`, (col4 + col5) / 2, midY - 5);
      row2Ctx.font = '11px Arial';
      row2Ctx.fillText('—Å–æ–º', (col4 + col5) / 2, midY + 8);
      
      // –°—É–º–º–∞
      row2Ctx.font = 'bold 13px Arial';
      row2Ctx.fillText(`${item.qty * item.price}`, (col5 + totalWidth) / 2, midY - 5);
      row2Ctx.font = '11px Arial';
      row2Ctx.fillText('—Å–æ–º', (col5 + totalWidth) / 2, midY + 8);
      
      const row2Image = row2Canvas.toDataURL('image/png');
      const rowPdfHeight = rowHeight * 170 / totalWidth;
      doc2.addImage(row2Image, 'PNG', 20, yPosition, 170, rowPdfHeight);
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ–≤–µ—Ä—Ö —è—á–µ–π–∫–∏ - –ü–û–õ–ù–û–ï —Ñ–æ—Ç–æ –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏
      if (photoData) {
        const photoWidthPdf = photoWidth * 170 / totalWidth;
        const photoHeightPdf = photoHeight * 170 / totalWidth;
        const xPos = 22 + (photoColumnWidth * 170 / totalWidth - photoWidthPdf) / 2;
        const yPos = yPosition + (rowPdfHeight - photoHeightPdf) / 2;
        doc2.addImage(photoData, 'JPEG', xPos, yPos, photoWidthPdf, photoHeightPdf);
      }
      
      yPosition += rowPdfHeight;
    }
    
    // –°—Ç—Ä–æ–∫–∞ –ò–¢–û–ì–û —Å —Å–µ—Ç–∫–æ–π
    const total2Canvas = document.createElement('canvas');
    const total2Ctx = total2Canvas.getContext('2d');
    total2Canvas.width = 550;
    total2Canvas.height = 60;
    
    total2Ctx.fillStyle = '#fff9c4';
    total2Ctx.fillRect(0, 0, 550, 60);
    total2Ctx.strokeStyle = 'black';
    total2Ctx.lineWidth = 3;
    total2Ctx.strokeRect(0, 0, 550, 60);
    
    total2Ctx.beginPath();
    total2Ctx.moveTo(470, 0);
    total2Ctx.lineTo(470, 60);
    total2Ctx.stroke();
    
    total2Ctx.fillStyle = 'black';
    total2Ctx.font = 'bold 18px Arial';
    total2Ctx.textAlign = 'right';
    total2Ctx.fillText('–ò–¢–û–ì–û:', 450, 38);
    
    total2Ctx.textAlign = 'center';
    total2Ctx.fillText(`${totalAmount}`, 510, 32);
    total2Ctx.font = '14px Arial';
    total2Ctx.fillText('—Å–æ–º', 510, 48);
    
    const total2Image = total2Canvas.toDataURL('image/png');
    doc2.addImage(total2Image, 'PNG', 20, yPosition, 170, 15);
    
    const pdf2Blob = doc2.output('blob');
    
    // ===== –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram (3 —Ñ–∞–π–ª–∞) =====
    Swal.update({ title: '–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram...', html: '–û—Ç–ø—Ä–∞–≤–∫–∞ Excel...' });
    
    const botToken = '7599592948:AAGtc_dGAcJFVQOSYcKVY0W-7GegszY9n8E';
    const chatId = '5567924440';
    const apiUrl = `https://api.telegram.org/bot${botToken}/sendDocument`;
    const baseFileName = `–ó–∞–∫–∞–∑_${clientName.replace(/\s+/g, '_')}_${Date.now()}`;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Excel
    const form1 = new FormData();
    form1.append('document', excelBlob, `${baseFileName}.xlsx`);
    form1.append('chat_id', chatId);
    form1.append('caption', `üìä Excel: ${clientName}\nüì± ${clientPhone}\nüí∞ ${totalAmount} —Å–æ–º`);
    await fetch(apiUrl, { method: 'POST', body: form1 });
    
    Swal.update({ html: '–û—Ç–ø—Ä–∞–≤–∫–∞ PDF –¥–ª—è –ø–µ—á–∞—Ç–∏...' });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF #1
    const form2 = new FormData();
    form2.append('document', pdf1Blob, `${baseFileName}_–ø–µ—á–∞—Ç—å.pdf`);
    form2.append('chat_id', chatId);
    form2.append('caption', `üìÑ –ó–∞–∫–∞–∑ –¥–ª—è –ø–µ—á–∞—Ç–∏: ${clientName}`);
    await fetch(apiUrl, { method: 'POST', body: form2 });
    
    Swal.update({ html: '–û—Ç–ø—Ä–∞–≤–∫–∞ PDF —Å —Ñ–æ—Ç–æ...' });
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF #2 (—Å —Ñ–æ—Ç–æ)
    const form3 = new FormData();
    form3.append('document', pdf2Blob, `${baseFileName}_—Å_—Ñ–æ—Ç–æ.pdf`);
    form3.append('chat_id', chatId);
    form3.append('caption', `üì∑ –ó–∞–∫–∞–∑ —Å —Ñ–æ—Ç–æ: ${clientName}`);
    const response = await fetch(apiUrl, { method: 'POST', body: form3 });
    
    const result = await response.json();
    
    if (result.ok) {
      Swal.fire({
        icon: 'success',
        title: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!',
        html: `<b>3 —Ñ–∞–π–ª–∞</b> –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram<br>üìä Excel + üìÑ PDF –ø–µ—á–∞—Ç—å + üì∑ PDF —Å —Ñ–æ—Ç–æ<br><strong>${clientName}</strong>`,
        timer: 2500,
        showConfirmButton: false
      });
    } else {
      throw new Error(result.description || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
    }
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
    Swal.fire({
      icon: 'error',
      title: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏',
      text: error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª—ã –≤ Telegram'
    });
  }
}

// ============ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ============
document.addEventListener('DOMContentLoaded', function() {
  if (initFirebase()) {
    loadOrdersManagement(true);
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è iOS
  const searchInput = document.getElementById('ordersSearchClient');
  if (searchInput) {
    searchInput.addEventListener('compositionstart', () => { _ordersSearchComposing = true; });
    searchInput.addEventListener('compositionend', () => { _ordersSearchComposing = false; scheduleOrdersManagementSearch(); });
  }
  
  const productSearchInput = document.getElementById('searchProductToAdd');
  if (productSearchInput) {
    productSearchInput.addEventListener('compositionstart', () => { _productsToAddComposing = true; });
    productSearchInput.addEventListener('compositionend', () => { _productsToAddComposing = false; scheduleFilterProductsToAdd(); });
  }
});
</script>

  <!-- –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é -->
  <nav class="bottom-nav">
    <a href="index.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="index.html#categories" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M3 5h6v6H3V5zm0 8h6v6H3v-6zm8-8h6v6h-6V5zm0 8h6v6h-6v-6z"/></svg>
      <span>–ú–µ–Ω—é</span>
    </a>
    <a href="cart.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM7.2 14.6L8.2 12h7.4c.8 0 1.4-.4 1.7-1l3.9-7-1.7-1-3.9 7H8.5L4.3 2H1v2h2l3.6 7.6-1.4 2.5c-.7 1.3.3 2.9 1.8 2.9h12v-2H7.4z"/></svg>
      <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
    </a>
    <a href="chat.html" class="nav-item">
      <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
      <span>–ß–∞—Ç</span>
    </a>
    <a href="profile.html" class="nav-item active">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.2 0 4-1.8 4-4s-1.8-4-4-4-4 1.8-4 4 1.8 4 4 4zm0 2c-2.7 0-8 1.3-8 4v2h16v-2c0-2.7-5.3-4-8-4z"/></svg>
      <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </a>
  </nav>

</body>
</html>
