<!DOCTYPE html>
<html lang="ru">
<head>
  <script>if(window.parent!==window)document.write('<style>.bottom-nav{display:none!important}body{padding-bottom:0!important}</style>')</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#667eea">
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-kerben.jpg">
  <link rel="icon" type="image/jpeg" href="icon-kerben.jpg">
  
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ - –ê–¥–º–∏–Ω</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    
    /* –®–∞–ø–∫–∞ */
    .admin-header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .header-top {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .back-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .header-title {
      flex: 1;
    }
    
    .header-title h1 {
      font-size: 20px;
      font-weight: 600;
    }
    
    .header-title p {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 2px;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    
    .action-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .action-btn.primary {
      background: white;
      color: #667eea;
    }
    
    .action-btn.primary:hover {
      background: #f0f0f0;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .stat-card .icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }
    
    .stat-card .label {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    
    /* –°–µ–∫—Ü–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
    .section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .section-title .badge {
      background: #667eea;
      color: white;
      font-size: 12px;
      padding: 3px 10px;
      border-radius: 12px;
      font-weight: 500;
    }
    
    /* –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
    .categories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    
    .category-card {
      background: #f8f9fa;
      border: 2px solid transparent;
      border-radius: 10px;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s;
    }
    
    .category-card:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .category-card.standard {
      background: #e8f5e9;
      border-color: #a5d6a7;
    }
    
    .category-card.standard:hover {
      background: #c8e6c9;
    }
    
    .category-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .category-icon {
      font-size: 24px;
    }
    
    .category-name {
      font-weight: 600;
      color: #333;
      font-size: 15px;
    }
    
    .category-count {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    
    .category-actions {
      display: flex;
      gap: 5px;
    }
    
    .category-actions button {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 5px;
      border-radius: 5px;
      transition: background 0.2s;
    }
    
    .category-actions button:hover {
      background: rgba(0,0,0,0.1);
    }
    
    .category-actions button.delete:hover {
      background: #ffebee;
    }
    
    /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */
    .add-form {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .add-form h3 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .form-row input {
      flex: 1;
      min-width: 200px;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .form-row input:focus {
      border-color: #667eea;
    }
    
    .form-row select {
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
      outline: none;
      background: white;
      cursor: pointer;
    }
    
    .form-row select:focus {
      border-color: #667eea;
    }
    
    .form-row button {
      padding: 12px 25px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .form-row button:hover {
      transform: scale(1.02);
    }
    
    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .empty-state p {
      font-size: 15px;
    }
    
    /* –ó–∞–≥—Ä—É–∑–∫–∞ */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e0e0e0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* –ò–∫–æ–Ω–∫–∏ —ç–º–æ–¥–∑–∏ */
    .emoji-picker {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 10px 0;
    }
    
    .emoji-btn {
      font-size: 24px;
      background: #f0f0f0;
      border: 2px solid transparent;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .emoji-btn:hover {
      background: #e0e0e0;
    }
    
    .emoji-btn.selected {
      border-color: #667eea;
      background: #e8f0ff;
    }
    
    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 600px) {
      .header-actions {
        flex-wrap: wrap;
      }
      
      .form-row {
        flex-direction: column;
      }
      
      .form-row input,
      .form-row select,
      .form-row button {
        width: 100%;
      }
      
      .categories-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header class="admin-header">
    <div class="header-top">
      <a href="profile.html" class="back-btn" title="–ù–∞–∑–∞–¥">‚Üê</a>
      <div class="header-title">
        <h1>üìÇ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h1>
        <p>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</p>
      </div>
      <div class="header-actions">
        <button class="action-btn" onclick="loadCategories()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="icon">üì¶</div>
        <div class="value" id="standardCount">8</div>
        <div class="label">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö</div>
      </div>
      <div class="stat-card">
        <div class="icon">üè™</div>
        <div class="value" id="customCount">0</div>
        <div class="label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö</div>
      </div>
      <div class="stat-card">
        <div class="icon">üìä</div>
        <div class="value" id="totalCount">8</div>
        <div class="label">–í—Å–µ–≥–æ</div>
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <div class="add-form">
      <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
      <div class="form-row">
        <input type="text" id="newCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏..." maxlength="30">
        <select id="newCategoryIcon">
          <option value="üè™">üè™ –ú–∞–≥–∞–∑–∏–Ω</option>
          <option value="üì¶">üì¶ –ö–æ—Ä–æ–±–∫–∞</option>
          <option value="üõí">üõí –ö–æ—Ä–∑–∏–Ω–∞</option>
          <option value="üéÅ">üéÅ –ü–æ–¥–∞—Ä–æ–∫</option>
          <option value="üëï">üëï –û–¥–µ–∂–¥–∞</option>
          <option value="üëü">üëü –û–±—É–≤—å</option>
          <option value="üíÑ">üíÑ –ö–æ—Å–º–µ—Ç–∏–∫–∞</option>
          <option value="üß¥">üß¥ –£—Ö–æ–¥</option>
          <option value="üçé">üçé –ï–¥–∞</option>
          <option value="üè†">üè† –î–æ–º</option>
          <option value="üîß">üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</option>
          <option value="üéÆ">üéÆ –ò–≥—Ä—ã</option>
          <option value="üì±">üì± –¢–µ–ª–µ—Ñ–æ–Ω—ã</option>
          <option value="üíª">üíª –ö–æ–º–ø—å—é—Ç–µ—Ä—ã</option>
          <option value="üéß">üéß –ê—É–¥–∏–æ</option>
          <option value="üì∑">üì∑ –§–æ—Ç–æ</option>
          <option value="üöó">üöó –ê–≤—Ç–æ</option>
          <option value="üèÉ">üèÉ –°–ø–æ—Ä—Ç</option>
          <option value="üìö">üìö –ö–Ω–∏–≥–∏</option>
          <option value="‚ú®">‚ú® –î—Ä—É–≥–æ–µ</option>
        </select>
        <button onclick="addCategory()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div class="section">
      <div class="section-title">
        üì¶ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        <span class="badge">–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å</span>
      </div>
      <div class="categories-grid" id="standardCategories">
        <div class="loading">
          <div class="loading-spinner"></div>
          –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
      </div>
    </div>

    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div class="section">
      <div class="section-title">
        üè™ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        <span class="badge" id="customBadge">0</span>
      </div>
      <div class="categories-grid" id="customCategories">
        <div class="loading">
          <div class="loading-spinner"></div>
          –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== FIREBASE INIT ====================
    const firebaseConfig = {
      apiKey: "AIzaSyBRQ6hH7kXq7ApJmqbvTG1EQsXwxWEnaGg",
      authDomain: "svoysayet.firebaseapp.com",
      projectId: "svoysayet",
      storageBucket: "svoysayet.firebasestorage.app",
      messagingSenderId: "785840370498",
      appId: "1:785840370498:web:e08c7cbef96aborc5e81f1"
    };
    
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    
    // ==================== –î–ê–ù–ù–´–ï ====================
    const standardCategories = [
      { name: '–≤—Å–µ', icon: 'üõçÔ∏è', label: '–í—Å–µ —Ç–æ–≤–∞—Ä—ã' },
      { name: '–Ω–æ–∂–Ω–∏—Ü—ã', icon: '‚úÇÔ∏è', label: '–ù–æ–∂–Ω–∏—Ü—ã' },
      { name: '—Å–∫–æ—Ç—á', icon: 'üì¶', label: '–°–∫–æ—Ç—á' },
      { name: '–Ω–æ–∂', icon: 'üî™', label: '–ù–æ–∂' },
      { name: '–∫–æ—Ä–µ–π—Å–∫–∏–µ', icon: 'üá∞üá∑', label: '–ö–æ—Ä–µ–π—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã' },
      { name: '—á–∞—Å—ã', icon: '‚åö', label: '–ß–∞—Å—ã' },
      { name: '—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', icon: 'üîå', label: '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞' },
      { name: '–±—ã—Ç–æ–≤—ã–µ', icon: 'üè†', label: '–ë—ã—Ç–æ–≤—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏' }
    ];
    
    let customCategories = [];
    let productCounts = {};
    let roundedCounts = {}; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    
    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    document.addEventListener('DOMContentLoaded', function() {
      if (checkAdminAccess()) {
        loadCategories();
      }
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∞–¥–º–∏–Ω–∞
    function checkAdminAccess() {
      const customerData = localStorage.getItem('customerData');
      const sellerData = localStorage.getItem('sellerData');
      
      let isAdmin = false;
      
      if (customerData) {
        try {
          const customer = JSON.parse(customerData);
          if (customer.isAdmin === true) {
            isAdmin = true;
          }
        } catch (e) {}
      }
      
      if (!isAdmin && sellerData) {
        try {
          const seller = JSON.parse(sellerData);
          if (seller.isAdmin === true || seller.role === 'admin') {
            isAdmin = true;
          }
        } catch (e) {}
      }
      
      if (!isAdmin) {
        Swal.fire({
          icon: 'error',
          title: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω',
          text: '–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤',
          confirmButtonText: '–ù–∞ –≥–ª–∞–≤–Ω—É—é'
        }).then(() => {
          window.location.href = 'index.html';
        });
        return false;
      }
      
      return true;
    }
    
    // ==================== –ó–ê–ì–†–£–ó–ö–ê –ö–ê–¢–ï–ì–û–†–ò–ô ====================
    async function loadCategories() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        await loadProductCounts();
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        renderStandardCategories();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ Firebase
        const snapshot = await db.collection('seller_categories').get();
        
        customCategories = [];
        snapshot.forEach(doc => {
          customCategories.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏
        customCategories.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        
        renderCustomCategories();
        updateStats();
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
        Swal.fire({
          icon: 'error',
          title: '–û—à–∏–±–∫–∞',
          text: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'
        });
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    async function loadProductCounts() {
      try {
        const snapshot = await db.collection('products').get();
        productCounts = {};
        roundedCounts = {};
        
        snapshot.forEach(doc => {
          const product = doc.data();
          const cat = (product.category || '–≤—Å–µ').toLowerCase();
          productCounts[cat] = (productCounts[cat] || 0) + 1;
          if (product.roundQty) {
            roundedCounts[cat] = (roundedCounts[cat] || 0) + 1;
          }
        });
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
      }
    }
    
    // ==================== –û–¢–†–ò–°–û–í–ö–ê ====================
    function renderStandardCategories() {
      const container = document.getElementById('standardCategories');
      
      container.innerHTML = standardCategories.map(cat => {
        const count = productCounts[cat.name] || 0;
        const rounded = roundedCounts[cat.name] || 0;
        const allRounded = count > 0 && rounded === count;
        
        return `
        <div class="category-card standard">
          <div class="category-info">
            <span class="category-icon">${cat.icon}</span>
            <div>
              <div class="category-name">${cat.label}</div>
              <div class="category-count">${count} —Ç–æ–≤–∞—Ä–æ–≤</div>
            </div>
          </div>
          ${count > 0 ? `
          <div class="category-actions">
            <button onclick="toggleRoundQty('${cat.name}')" title="${allRounded ? '–í—ã–∫–ª—é—á–∏—Ç—å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ' : '–í–∫–ª—é—á–∏—Ç—å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ'}" style="background:${allRounded ? '#4caf50' : '#ff9800'}; color:white; border:none; padding:5px 10px; border-radius:5px; font-size:12px; cursor:pointer;">
              ${allRounded ? '‚úì –û–∫—Ä.' : '‚óã –û–∫—Ä.'}
            </button>
          </div>
          ` : ''}
        </div>
      `}).join('');
    }
    
    function renderCustomCategories() {
      const container = document.getElementById('customCategories');
      
      if (customCategories.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="icon">üìÇ</div>
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç<br>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤—ã—à–µ</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = customCategories.map(cat => {
        const catLower = cat.name.toLowerCase();
        const count = productCounts[catLower] || 0;
        const rounded = roundedCounts[catLower] || 0;
        const allRounded = count > 0 && rounded === count;
        
        return `
        <div class="category-card" data-id="${cat.id}">
          <div class="category-info">
            <span class="category-icon">${cat.icon || 'üè™'}</span>
            <div>
              <div class="category-name">${escapeHtml(cat.name)}</div>
              <div class="category-count">${count} —Ç–æ–≤–∞—Ä–æ–≤</div>
            </div>
          </div>
          <div class="category-actions">
            ${count > 0 ? `
            <button onclick="toggleRoundQty('${escapeHtml(cat.name)}')" title="${allRounded ? '–í—ã–∫–ª—é—á–∏—Ç—å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ' : '–í–∫–ª—é—á–∏—Ç—å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ'}" style="background:${allRounded ? '#4caf50' : '#ff9800'}; color:white; border:none; padding:5px 10px; border-radius:5px; font-size:12px; cursor:pointer;">
              ${allRounded ? '‚úì –û–∫—Ä.' : '‚óã –û–∫—Ä.'}
            </button>
            ` : ''}
            <button onclick="editCategory('${cat.id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            <button class="delete" onclick="deleteCategory('${cat.id}')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
          </div>
        </div>
      `}).join('');
    }
    
    function updateStats() {
      document.getElementById('standardCount').textContent = standardCategories.length;
      document.getElementById('customCount').textContent = customCategories.length;
      document.getElementById('totalCount').textContent = standardCategories.length + customCategories.length;
      document.getElementById('customBadge').textContent = customCategories.length;
    }
    
    // ==================== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò ====================
    async function addCategory() {
      const nameInput = document.getElementById('newCategoryName');
      const iconSelect = document.getElementById('newCategoryIcon');
      
      const name = nameInput.value.trim();
      const icon = iconSelect.value;
      
      if (!name) {
        Swal.fire({
          icon: 'warning',
          title: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ',
          text: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º',
          confirmButtonColor: '#667eea'
        });
        nameInput.focus();
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
      const nameLower = name.toLowerCase();
      const isDuplicate = standardCategories.some(c => c.name === nameLower) ||
                          customCategories.some(c => c.name.toLowerCase() === nameLower);
      
      if (isDuplicate) {
        Swal.fire({
          icon: 'error',
          title: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',
          text: `–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`,
          confirmButtonColor: '#667eea'
        });
        return;
      }
      
      try {
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ Firebase
        await db.collection('seller_categories').add({
          name: name,
          icon: icon,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        nameInput.value = '';
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
        await loadCategories();
        
        Swal.fire({
          icon: 'success',
          title: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!',
          text: `${icon} ${name}`,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 2000
        });
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', error);
        Swal.fire({
          icon: 'error',
          title: '–û—à–∏–±–∫–∞',
          text: '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é',
          confirmButtonColor: '#667eea'
        });
      }
    }
    
    // ==================== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò ====================
    async function editCategory(id) {
      const category = customCategories.find(c => c.id === id);
      if (!category) return;
      
      const { value: formValues } = await Swal.fire({
        title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é',
        html: `
          <input id="swal-name" class="swal2-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${escapeHtml(category.name)}">
          <select id="swal-icon" class="swal2-select" style="margin-top:10px; padding:10px; border:1px solid #ddd; border-radius:5px; width:100%;">
            <option value="üè™" ${category.icon === 'üè™' ? 'selected' : ''}>üè™ –ú–∞–≥–∞–∑–∏–Ω</option>
            <option value="üì¶" ${category.icon === 'üì¶' ? 'selected' : ''}>üì¶ –ö–æ—Ä–æ–±–∫–∞</option>
            <option value="üõí" ${category.icon === 'üõí' ? 'selected' : ''}>üõí –ö–æ—Ä–∑–∏–Ω–∞</option>
            <option value="üéÅ" ${category.icon === 'üéÅ' ? 'selected' : ''}>üéÅ –ü–æ–¥–∞—Ä–æ–∫</option>
            <option value="üëï" ${category.icon === 'üëï' ? 'selected' : ''}>üëï –û–¥–µ–∂–¥–∞</option>
            <option value="üëü" ${category.icon === 'üëü' ? 'selected' : ''}>üëü –û–±—É–≤—å</option>
            <option value="üíÑ" ${category.icon === 'üíÑ' ? 'selected' : ''}>üíÑ –ö–æ—Å–º–µ—Ç–∏–∫–∞</option>
            <option value="üß¥" ${category.icon === 'üß¥' ? 'selected' : ''}>üß¥ –£—Ö–æ–¥</option>
            <option value="üçé" ${category.icon === 'üçé' ? 'selected' : ''}>üçé –ï–¥–∞</option>
            <option value="üè†" ${category.icon === 'üè†' ? 'selected' : ''}>üè† –î–æ–º</option>
            <option value="üîß" ${category.icon === 'üîß' ? 'selected' : ''}>üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</option>
            <option value="üéÆ" ${category.icon === 'üéÆ' ? 'selected' : ''}>üéÆ –ò–≥—Ä—ã</option>
            <option value="üì±" ${category.icon === 'üì±' ? 'selected' : ''}>üì± –¢–µ–ª–µ—Ñ–æ–Ω—ã</option>
            <option value="üíª" ${category.icon === 'üíª' ? 'selected' : ''}>üíª –ö–æ–º–ø—å—é—Ç–µ—Ä—ã</option>
            <option value="üéß" ${category.icon === 'üéß' ? 'selected' : ''}>üéß –ê—É–¥–∏–æ</option>
            <option value="üì∑" ${category.icon === 'üì∑' ? 'selected' : ''}>üì∑ –§–æ—Ç–æ</option>
            <option value="üöó" ${category.icon === 'üöó' ? 'selected' : ''}>üöó –ê–≤—Ç–æ</option>
            <option value="üèÉ" ${category.icon === 'üèÉ' ? 'selected' : ''}>üèÉ –°–ø–æ—Ä—Ç</option>
            <option value="üìö" ${category.icon === 'üìö' ? 'selected' : ''}>üìö –ö–Ω–∏–≥–∏</option>
            <option value="‚ú®" ${category.icon === '‚ú®' ? 'selected' : ''}>‚ú® –î—Ä—É–≥–æ–µ</option>
          </select>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞',
        confirmButtonColor: '#667eea',
        preConfirm: () => {
          return {
            name: document.getElementById('swal-name').value.trim(),
            icon: document.getElementById('swal-icon').value
          };
        }
      });
      
      if (!formValues) return;
      
      if (!formValues.name) {
        Swal.fire({
          icon: 'warning',
          title: '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ',
          confirmButtonColor: '#667eea'
        });
        return;
      }
      
      try {
        await db.collection('seller_categories').doc(id).update({
          name: formValues.name,
          icon: formValues.icon,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        await loadCategories();
        
        Swal.fire({
          icon: 'success',
          title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!',
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 1500
        });
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
        Swal.fire({
          icon: 'error',
          title: '–û—à–∏–±–∫–∞',
          text: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è',
          confirmButtonColor: '#667eea'
        });
      }
    }
    
    // ==================== –£–î–ê–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò ====================
    async function deleteCategory(id) {
      const category = customCategories.find(c => c.id === id);
      if (!category) return;
      
      const productsInCategory = productCounts[category.name.toLowerCase()] || 0;
      
      let warningText = `–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${category.name}" –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞.`;
      if (productsInCategory > 0) {
        warningText += `\n\n‚ö†Ô∏è –í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${productsInCategory} —Ç–æ–≤–∞—Ä(–æ–≤). –û–Ω–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è, –Ω–æ –±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.`;
      }
      
      const result = await Swal.fire({
        title: '–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?',
        text: warningText,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞',
        confirmButtonColor: '#dc3545'
      });
      
      if (!result.isConfirmed) return;
      
      try {
        await db.collection('seller_categories').doc(id).delete();
        
        await loadCategories();
        
        Swal.fire({
          icon: 'success',
          title: '–£–¥–∞–ª–µ–Ω–æ!',
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 1500
        });
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
        Swal.fire({
          icon: 'error',
          title: '–û—à–∏–±–∫–∞',
          text: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é',
          confirmButtonColor: '#667eea'
        });
      }
    }
    
    // ==================== –û–ö–†–£–ì–õ–ï–ù–ò–ï –ü–û –ö–ê–¢–ï–ì–û–†–ò–ò ====================
    async function toggleRoundQty(categoryName) {
      const catLower = categoryName.toLowerCase();
      const count = productCounts[catLower] || 0;
      const rounded = roundedCounts[catLower] || 0;
      
      if (count === 0) {
        Swal.fire('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤', '–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤', 'info');
        return;
      }
      
      const allRounded = rounded === count;
      const newValue = !allRounded;
      const actionText = newValue ? '–≤–∫–ª—é—á–∏—Ç—å' : '–≤—ã–∫–ª—é—á–∏—Ç—å';
      
      const result = await Swal.fire({
        title: `${newValue ? '‚úì' : '‚óã'} –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ`,
        html: `${actionText.charAt(0).toUpperCase() + actionText.slice(1)} –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–ª—è <b>${count}</b> —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "<b>${categoryName}</b>"?<br><br>
        <small style="color:#666;">–ü—Ä–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–∫—Ä—É–≥–ª—è—Ç—å—Å—è –¥–æ –∫—Ä–∞—Ç–Ω–æ–≥–æ minQty.</small>`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: newValue ? '‚úì –í–∫–ª—é—á–∏—Ç—å' : '‚óã –í—ã–∫–ª—é—á–∏—Ç—å',
        confirmButtonColor: newValue ? '#4caf50' : '#ff9800',
        cancelButtonText: '–û—Ç–º–µ–Ω–∞'
      });
      
      if (!result.isConfirmed) return;
      
      try {
        Swal.fire({
          title: '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...',
          text: `–û–±–Ω–æ–≤–ª—è–µ–º ${count} —Ç–æ–≤–∞—Ä–æ–≤...`,
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const snapshot = await db.collection('products')
          .where('category', '==', categoryName)
          .get();
        
        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
        const snapshot2 = await db.collection('products')
          .where('category', '==', catLower)
          .get();
        
        const allDocs = new Map();
        snapshot.forEach(doc => allDocs.set(doc.id, doc.ref));
        snapshot2.forEach(doc => allDocs.set(doc.id, doc.ref));
        
        const batch = db.batch();
        allDocs.forEach((ref, id) => {
          batch.update(ref, { roundQty: newValue });
        });
        
        await batch.commit();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏
        roundedCounts[catLower] = newValue ? count : 0;
        
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
        renderStandardCategories();
        renderCustomCategories();
        
        Swal.fire({
          icon: 'success',
          title: '–ì–æ—Ç–æ–≤–æ!',
          text: `–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ ${newValue ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ'} –¥–ª—è ${allDocs.size} —Ç–æ–≤–∞—Ä–æ–≤`,
          timer: 2000,
          showConfirmButton: false
        });
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è:', error);
        Swal.fire({
          icon: 'error',
          title: '–û—à–∏–±–∫–∞',
          text: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã',
          confirmButtonColor: '#667eea'
        });
      }
    }
    
    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï ====================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    document.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && document.activeElement.id === 'newCategoryName') {
        addCategory();
      }
    });
  </script>
</body>
</html>
